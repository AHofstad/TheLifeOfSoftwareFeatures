commit 854f3315af645775e7b0aa39bd05db66187bcc38
Author: plampix <plampix@users.noreply.github.com>
Date:   Wed Jan 10 07:33:54 2024 +0100

    ‚ú® EDITABLE_STEPS_PER_UNIT (#26618)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index e6adfe2b6b..76200cbbd5 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -97,7 +97,6 @@ default_src_filter = +<src/*> -<src/config> -<src/tests>
   ; Minimal Requirements
   ;
   +<src/gcode/calibrate/G28.cpp>
-  +<src/gcode/config/M92.cpp>
   +<src/gcode/config/M200-M205.cpp>
   +<src/gcode/config/M220.cpp>
   +<src/gcode/control/M17_M18_M84.cpp>

commit 994aa9f6923e2307d13badd26a15e6d57525955f
Author: plampix <plampix@users.noreply.github.com>
Date:   Fri Jan 5 00:09:53 2024 +0100

    ‚ö°Ô∏è Slimmer null T command (#26615)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 5249b790f2..e6adfe2b6b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -107,7 +107,6 @@ default_src_filter = +<src/*> -<src/config> -<src/tests>
   +<src/gcode/control/M111.cpp>
   +<src/gcode/control/M120_M121.cpp>
   +<src/gcode/control/M999.cpp>
-  +<src/gcode/control/T.cpp>
   +<src/gcode/geometry/G92.cpp>
   +<src/gcode/host/M110.cpp>
   +<src/gcode/host/M114.cpp>

commit 1ac6428c82aa72cc41c0c9f758659b71e7fce1cf
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Wed Jan 3 13:52:12 2024 +1300

    üî™ Options to slim M111, remove M115 (#26603)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 81f97e73b8..5249b790f2 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -111,7 +111,6 @@ default_src_filter = +<src/*> -<src/config> -<src/tests>
   +<src/gcode/geometry/G92.cpp>
   +<src/gcode/host/M110.cpp>
   +<src/gcode/host/M114.cpp>
-  +<src/gcode/host/M115.cpp>
   +<src/gcode/host/M118.cpp>
   +<src/gcode/host/M119.cpp>
   +<src/gcode/motion/G0_G1.cpp>

commit 86338ca835540d522145a3f05e498518ecf90756
Author: Chris <52449218+shadow578@users.noreply.github.com>
Date:   Mon Nov 27 00:58:56 2023 +0100

    ‚ú® HAL for HC32F460 (#26414)

diff --git a/platformio.ini b/platformio.ini
index e3bdb6f586..81f97e73b8 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -21,6 +21,7 @@ extra_configs =
     ini/due.ini
     ini/esp32.ini
     ini/features.ini
+    ini/hc32.ini
     ini/lpc176x.ini
     ini/native.ini
     ini/samd21.ini

commit 9a7d9e6995f4f66c4b48147ec7876d49d4b3ae77
Author: Martin Turski <turningtides@outlook.de>
Date:   Thu Apr 27 14:05:24 2023 +0200

    üßë‚Äçüíª Optimize PlatformIO source filtering (#25332)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 885fdd87d6..e3bdb6f586 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -52,218 +52,79 @@ extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/preflight-checks.py
   post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
 lib_deps           =
-default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/tests>
-  -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
-  -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
-  -<src/lcd/e3v2/common> -<src/lcd/e3v2/creality> -<src/lcd/e3v2/proui> -<src/lcd/e3v2/jyersui> -<src/lcd/e3v2/marlinui>
-  -<src/lcd/menu>
-  -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>
-  -<src/lcd/menu/game/maze.cpp> -<src/lcd/menu/game/snake.cpp>
-  -<src/lcd/menu/menu_backlash.cpp>
-  -<src/lcd/menu/menu_bed_leveling.cpp>
-  -<src/lcd/menu/menu_bed_tramming.cpp>
-  -<src/lcd/menu/menu_cancelobject.cpp>
-  -<src/lcd/menu/menu_delta_calibrate.cpp>
-  -<src/lcd/menu/menu_filament.cpp>
-  -<src/lcd/menu/menu_info.cpp>
-  -<src/lcd/menu/menu_job_recovery.cpp>
-  -<src/lcd/menu/menu_language.cpp>
-  -<src/lcd/menu/menu_led.cpp>
-  -<src/lcd/menu/menu_media.cpp>
-  -<src/lcd/menu/menu_mmu2.cpp>
-  -<src/lcd/menu/menu_password.cpp>
-  -<src/lcd/menu/menu_power_monitor.cpp>
-  -<src/lcd/menu/menu_spindle_laser.cpp>
-  -<src/lcd/menu/menu_temperature.cpp>
-  -<src/lcd/menu/menu_tmc.cpp>
-  -<src/lcd/menu/menu_touch_screen.cpp>
-  -<src/lcd/menu/menu_tramming_wizard.cpp>
-  -<src/lcd/menu/menu_ubl.cpp>
-  -<src/lcd/menu/menu_x_twist.cpp>
-  -<src/lcd/extui/anycubic> -<src/lcd/extui/anycubic_chiron> -<src/lcd/extui/anycubic_vyper> -<src/lcd/extui/anycubic_i3mega>
-  -<src/lcd/extui/dgus> -<src/lcd/extui/dgus/fysetc> -<src/lcd/extui/dgus/hiprecy> -<src/lcd/extui/dgus/mks> -<src/lcd/extui/dgus/origin>
-  -<src/lcd/extui/dgus_reloaded>
-  -<src/lcd/extui/example>
-  -<src/lcd/extui/ftdi_eve_touch_ui>
-  -<src/lcd/extui/malyan>
-  -<src/lcd/extui/mks_ui>
-  -<src/lcd/extui/nextion>
-  -<src/lcd/extui/ia_creality>
+default_src_filter = +<src/*> -<src/config> -<src/tests>
+  ; LCDs and Controllers
+  -<src/lcd/HD44780> -<src/lcd/dogm> -<src/lcd/TFTGLCD> -<src/lcd/tft> -<src/lcd/tft_io>
+  -<src/lcd/e3v2> -<src/lcd/menu> -<src/lcd/extui> -<src/lcd/touch>
   -<src/lcd/lcdprint.cpp>
-  -<src/lcd/touch/touch_buttons.cpp>
-  -<src/sd/usb_flashdrive/lib-uhs2> -<src/sd/usb_flashdrive/lib-uhs3>
-  -<src/sd/usb_flashdrive/Sd2Card_FlashDrive.cpp>
-  -<src/sd/cardreader.cpp> -<src/sd/Sd2Card.cpp> -<src/sd/SdBaseFile.cpp> -<src/sd/SdFatUtil.cpp> -<src/sd/SdFile.cpp> -<src/sd/SdVolume.cpp>
+  ; Marlin HAL
+  -<src/HAL>
+  +<src/HAL/shared>
   -<src/HAL/shared/backtrace>
   -<src/HAL/shared/cpu_exception>
   -<src/HAL/shared/eeprom_if_i2c.cpp>
   -<src/HAL/shared/eeprom_if_spi.cpp>
-  -<src/feature/adc> -<src/gcode/feature/adc>
-  -<src/feature/ammeter.cpp>
-  -<src/feature/babystep.cpp>
-  -<src/feature/backlash.cpp>
-  -<src/feature/baricuda.cpp> -<src/gcode/feature/baricuda>
-  -<src/feature/bedlevel/abl> -<src/gcode/bedlevel/abl>
-  -<src/feature/bedlevel/bdl> -<src/gcode/probe/M102.cpp>
-  -<src/feature/bedlevel/mbl> -<src/gcode/bedlevel/mbl>
-  -<src/feature/bedlevel/ubl> -<src/gcode/bedlevel/ubl>
-  -<src/feature/bedlevel/hilbert_curve.cpp>
-  -<src/feature/binary_stream.cpp> -<src/libs/heatshrink>
-  -<src/feature/bltouch.cpp>
-  -<src/feature/cancel_object.cpp> -<src/gcode/feature/cancel>
-  -<src/feature/caselight.cpp> -<src/gcode/feature/caselight>
-  -<src/feature/closedloop.cpp>
-  -<src/feature/controllerfan.cpp> -<src/gcode/feature/controllerfan>
-  -<src/feature/cooler.cpp>  -<src/gcode/temp/M143_M193.cpp>
-  -<src/feature/dac> -<src/feature/digipot>
-  -<src/feature/direct_stepping.cpp> -<src/gcode/motion/G6.cpp>
-  -<src/feature/e_parser.cpp>
-  -<src/feature/easythreed_ui.cpp>
-  -<src/feature/encoder_i2c.cpp>
-  -<src/feature/ethernet.cpp> -<src/gcode/feature/network/M552-M554.cpp>
-  -<src/feature/fancheck.cpp>
-  -<src/feature/fanmux.cpp>
-  -<src/feature/filwidth.cpp> -<src/gcode/feature/filwidth>
-  -<src/feature/fwretract.cpp> -<src/gcode/feature/fwretract>
-  -<src/feature/host_actions.cpp>
-  -<src/feature/hotend_idle.cpp>
-  -<src/feature/joystick.cpp>
-  -<src/feature/leds/blinkm.cpp>
-  -<src/feature/leds/leds.cpp>
-  -<src/feature/leds/neopixel.cpp>
-  -<src/feature/leds/pca9533.cpp>
-  -<src/feature/leds/pca9632.cpp>
-  -<src/feature/leds/printer_event_leds.cpp>
-  -<src/feature/leds/tempstat.cpp>
-  -<src/feature/max7219.cpp>
-  -<src/feature/meatpack.cpp>
-  -<src/feature/mixing.cpp>
-  -<src/feature/mmu/mmu.cpp>
-  -<src/feature/mmu/mmu2.cpp> -<src/gcode/feature/prusa_MMU2>
-  -<src/feature/password> -<src/gcode/feature/password>
-  -<src/feature/pause.cpp>
-  -<src/feature/power.cpp>
-  -<src/feature/power_monitor.cpp> -<src/gcode/feature/power_monitor>
-  -<src/feature/powerloss.cpp> -<src/gcode/feature/powerloss>
-  -<src/feature/probe_temp_comp.cpp>
-  -<src/feature/repeat.cpp>
-  -<src/feature/runout.cpp> -<src/gcode/feature/runout>
-  -<src/feature/snmm.cpp>
-  -<src/feature/solenoid.cpp> -<src/gcode/control/M380_M381.cpp>
-  -<src/feature/spindle_laser.cpp> -<src/gcode/control/M3-M5.cpp>
-  -<src/feature/stepper_driver_safety.cpp>
-  -<src/feature/tmc_util.cpp> -<src/module/stepper/trinamic.cpp>
-  -<src/feature/tramming.cpp>
-  -<src/feature/twibus.cpp>
-  -<src/feature/x_twist.cpp> -<src/gcode/probe/M423.cpp>
-  -<src/feature/z_stepper_align.cpp>
-  -<src/gcode/bedlevel/G26.cpp>
-  -<src/gcode/bedlevel/G35.cpp>
-  -<src/gcode/bedlevel/G42.cpp>
-  -<src/gcode/bedlevel/M420.cpp> -<src/feature/bedlevel/bedlevel.cpp>
-  -<src/gcode/calibrate/G33.cpp>
-  -<src/gcode/calibrate/G34.cpp>
-  -<src/gcode/calibrate/G34_M422.cpp>
-  -<src/gcode/calibrate/G76_M871.cpp>
-  -<src/gcode/calibrate/G425.cpp>
-  -<src/gcode/calibrate/M12.cpp>
-  -<src/gcode/calibrate/M48.cpp>
-  -<src/gcode/calibrate/M100.cpp>
-  -<src/gcode/calibrate/M425.cpp>
-  -<src/gcode/calibrate/M665.cpp>
-  -<src/gcode/calibrate/M666.cpp>
-  -<src/gcode/calibrate/M852.cpp>
-  -<src/gcode/control/M10-M11.cpp>
-  -<src/gcode/control/M42.cpp> -<src/gcode/control/M226.cpp>
-  -<src/gcode/config/M43.cpp>
-  -<src/gcode/config/M217.cpp>
-  -<src/gcode/config/M218.cpp>
-  -<src/gcode/config/M221.cpp>
-  -<src/gcode/config/M301.cpp>
-  -<src/gcode/config/M302.cpp>
-  -<src/gcode/config/M304.cpp>
-  -<src/gcode/config/M305.cpp>
-  -<src/gcode/config/M540.cpp>
-  -<src/gcode/config/M575.cpp>
-  -<src/gcode/config/M672.cpp>
-  -<src/gcode/control/M7-M9.cpp>
-  -<src/gcode/control/M211.cpp>
-  -<src/gcode/control/M350_M351.cpp>
-  -<src/gcode/control/M605.cpp>
-  -<src/module/ft_motion.cpp> -<src/gcode/feature/ft_motion/M493.cpp>
-  -<src/gcode/feature/advance>
-  -<src/gcode/feature/camera>
-  -<src/gcode/feature/i2c>
-  -<src/gcode/feature/input_shaping>
-  -<src/gcode/feature/L6470>
-  -<src/gcode/feature/leds/M150.cpp>
-  -<src/gcode/feature/leds/M7219.cpp>
-  -<src/gcode/feature/macro>
-  -<src/gcode/feature/mixing/M163-M165.cpp>
-  -<src/gcode/feature/mixing/M166.cpp>
-  -<src/gcode/feature/pause/G27.cpp>
-  -<src/gcode/feature/pause/G60.cpp>
-  -<src/gcode/feature/pause/G61.cpp>
-  -<src/gcode/feature/pause/M125.cpp>
-  -<src/gcode/feature/pause/M600.cpp>
-  -<src/gcode/feature/pause/M603.cpp>
-  -<src/gcode/feature/pause/M701_M702.cpp>
-  -<src/gcode/feature/trinamic/M122.cpp>
-  -<src/gcode/feature/trinamic/M569.cpp>
-  -<src/gcode/feature/trinamic/M906.cpp>
-  -<src/gcode/feature/trinamic/M911-M914.cpp>
-  -<src/gcode/feature/trinamic/M919.cpp>
-  -<src/gcode/geometry/G17-G19.cpp>
-  -<src/gcode/geometry/G53-G59.cpp>
-  -<src/gcode/geometry/M206_M428.cpp>
-  -<src/gcode/host/M16.cpp>
-  -<src/gcode/host/M113.cpp>
-  -<src/gcode/host/M154.cpp>
-  -<src/gcode/host/M360.cpp>
-  -<src/gcode/host/M876.cpp>
-  -<src/gcode/lcd/M0_M1.cpp>
-  -<src/gcode/lcd/M73.cpp>
-  -<src/gcode/lcd/M117.cpp>
-  -<src/gcode/lcd/M145.cpp>
-  -<src/gcode/lcd/M250.cpp> -<src/gcode/lcd/M255.cpp> -<src/gcode/lcd/M256.cpp>
-  -<src/gcode/lcd/M300.cpp>
-  -<src/gcode/lcd/M414.cpp>
-  -<src/gcode/lcd/M995.cpp>
-  -<src/gcode/motion/G2_G3.cpp>
-  -<src/gcode/motion/G5.cpp>
-  -<src/gcode/motion/G80.cpp>
-  -<src/gcode/motion/M290.cpp>
-  -<src/gcode/probe/G30.cpp>
-  -<src/gcode/probe/G31_G32.cpp>
-  -<src/gcode/probe/G38.cpp>
-  -<src/gcode/probe/M401_M402.cpp>
-  -<src/gcode/probe/M851.cpp>
-  -<src/gcode/probe/M951.cpp>
+  ; Features and G-Codes
+  -<src/feature>
+  -<src/gcode/bedlevel>
+  -<src/gcode/calibrate>
+  -<src/gcode/config>
+  -<src/gcode/control>
+  -<src/gcode/feature>
+  -<src/gcode/geometry>
+  -<src/gcode/host>
+  -<src/gcode/lcd>
+  -<src/gcode/motion>
+  -<src/gcode/probe>
   -<src/gcode/scara>
   -<src/gcode/sd>
-  -<src/gcode/sd/M32.cpp>
-  -<src/gcode/sd/M808.cpp>
-  -<src/gcode/temp/M104_M109.cpp>
-  -<src/gcode/temp/M123.cpp>
-  -<src/gcode/temp/M155.cpp>
-  -<src/gcode/temp/M192.cpp>
-  -<src/gcode/temp/M306.cpp>
-  -<src/gcode/units/G20_G21.cpp>
-  -<src/gcode/units/M82_M83.cpp>
-  -<src/gcode/units/M149.cpp>
+  -<src/gcode/temp>
+  -<src/gcode/units>
+  ; Library Code
+  -<src/libs/heatshrink>
   -<src/libs/BL24CXX.cpp> -<src/libs/W25Qxx.cpp>
   -<src/libs/MAX31865.cpp>
   -<src/libs/hex_print.cpp>
   -<src/libs/least_squares_fit.cpp>
-  -<src/libs/nozzle.cpp> -<src/gcode/feature/clean>
-  -<src/module/delta.cpp>
-  -<src/module/planner_bezier.cpp>
-  -<src/module/polargraph.cpp>
-  -<src/module/printcounter.cpp>
-  -<src/module/probe.cpp>
-  -<src/module/scara.cpp>
-  -<src/module/servo.cpp> -<src/gcode/control/M280.cpp> -<src/gcode/config/M281.cpp> -<src/gcode/control/M282.cpp>
-  -<src/module/stepper/TMC26X.cpp>
+  -<src/libs/nozzle.cpp>
+  ; Modules
+  -<src/module>
+  -<src/module/stepper>
+  ; Media Support
+  -<src/sd>
+  ;
+  ; Minimal Requirements
+  ;
+  +<src/gcode/calibrate/G28.cpp>
+  +<src/gcode/config/M92.cpp>
+  +<src/gcode/config/M200-M205.cpp>
+  +<src/gcode/config/M220.cpp>
+  +<src/gcode/control/M17_M18_M84.cpp>
+  +<src/gcode/control/M80_M81.cpp>
+  +<src/gcode/control/M85.cpp>
+  +<src/gcode/control/M108_*.cpp>
+  +<src/gcode/control/M111.cpp>
+  +<src/gcode/control/M120_M121.cpp>
+  +<src/gcode/control/M999.cpp>
+  +<src/gcode/control/T.cpp>
+  +<src/gcode/geometry/G92.cpp>
+  +<src/gcode/host/M110.cpp>
+  +<src/gcode/host/M114.cpp>
+  +<src/gcode/host/M115.cpp>
+  +<src/gcode/host/M118.cpp>
+  +<src/gcode/host/M119.cpp>
+  +<src/gcode/motion/G0_G1.cpp>
+  +<src/gcode/motion/G4.cpp>
+  +<src/gcode/motion/M400.cpp>
+  +<src/gcode/temp/M105.cpp>
+  +<src/module/endstops.cpp>
+  +<src/module/motion.cpp>
+  +<src/module/planner.cpp>
+  +<src/module/settings.cpp>
+  +<src/module/stepper.cpp>
+  +<src/module/temperature.cpp>
+  +<src/module/tool_change.cpp>
+  +<src/module/stepper/indirection.cpp>
 
 #
 # Default values apply to all 'env:' prefixed environments

commit 6e3b58d76a00e861a9945f3073719f82473a0faf
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sat Apr 15 22:24:14 2023 -0500

    üßë‚Äçüíª Anycubic shared code (#25690)

diff --git a/platformio.ini b/platformio.ini
index 3478dcc1fb..885fdd87d6 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -80,9 +80,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/t
   -<src/lcd/menu/menu_tramming_wizard.cpp>
   -<src/lcd/menu/menu_ubl.cpp>
   -<src/lcd/menu/menu_x_twist.cpp>
-  -<src/lcd/extui/anycubic_chiron>
-  -<src/lcd/extui/anycubic_vyper>
-  -<src/lcd/extui/anycubic_i3mega>
+  -<src/lcd/extui/anycubic> -<src/lcd/extui/anycubic_chiron> -<src/lcd/extui/anycubic_vyper> -<src/lcd/extui/anycubic_i3mega>
   -<src/lcd/extui/dgus> -<src/lcd/extui/dgus/fysetc> -<src/lcd/extui/dgus/hiprecy> -<src/lcd/extui/dgus/mks> -<src/lcd/extui/dgus/origin>
   -<src/lcd/extui/dgus_reloaded>
   -<src/lcd/extui/example>

commit c37fa3cc9097a9aa7fad5f168e335caabf23278e
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Mar 31 21:18:37 2023 -0500

    ‚ú® Fixed-Time Motion with Input Shaping by Ulendo (#25394)
    
    Co-authored-by: Ulendo Alex <alex@ulendo.io>

diff --git a/platformio.ini b/platformio.ini
index 9fbc589d2e..3478dcc1fb 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -192,6 +192,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/t
   -<src/gcode/control/M211.cpp>
   -<src/gcode/control/M350_M351.cpp>
   -<src/gcode/control/M605.cpp>
+  -<src/module/ft_motion.cpp> -<src/gcode/feature/ft_motion/M493.cpp>
   -<src/gcode/feature/advance>
   -<src/gcode/feature/camera>
   -<src/gcode/feature/i2c>

commit 0021a58943721a81b1ef23fa5e7366cfd80a3d28
Author: Bob Kuhn <bob.kuhn@att.net>
Date:   Sun Mar 26 04:07:25 2023 -0500

    ‚ú® AnyCubic Vyper / Vyper LCD (#25405)

diff --git a/platformio.ini b/platformio.ini
index f8a8988ef8..9fbc589d2e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -81,6 +81,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/t
   -<src/lcd/menu/menu_ubl.cpp>
   -<src/lcd/menu/menu_x_twist.cpp>
   -<src/lcd/extui/anycubic_chiron>
+  -<src/lcd/extui/anycubic_vyper>
   -<src/lcd/extui/anycubic_i3mega>
   -<src/lcd/extui/dgus> -<src/lcd/extui/dgus/fysetc> -<src/lcd/extui/dgus/hiprecy> -<src/lcd/extui/dgus/mks> -<src/lcd/extui/dgus/origin>
   -<src/lcd/extui/dgus_reloaded>

commit 8b6155deeebd5aa12d0a335dd9087fd7db280d5b
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Mar 24 03:01:09 2023 -0500

    üî® INI Updates
    
    Co-Authored-By: Martin Turski <turningtides@outlook.de>

diff --git a/platformio.ini b/platformio.ini
index d31f23abec..f8a8988ef8 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -224,6 +224,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/t
   -<src/gcode/lcd/M0_M1.cpp>
   -<src/gcode/lcd/M73.cpp>
   -<src/gcode/lcd/M117.cpp>
+  -<src/gcode/lcd/M145.cpp>
   -<src/gcode/lcd/M250.cpp> -<src/gcode/lcd/M255.cpp> -<src/gcode/lcd/M256.cpp>
   -<src/gcode/lcd/M300.cpp>
   -<src/gcode/lcd/M414.cpp>
@@ -251,7 +252,6 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/t
   -<src/gcode/units/M82_M83.cpp>
   -<src/gcode/units/M149.cpp>
   -<src/libs/BL24CXX.cpp> -<src/libs/W25Qxx.cpp>
-  -<src/libs/L64XX> -<src/module/stepper/L64xx.cpp> -<src/HAL/shared/HAL_spi_L6470.cpp>
   -<src/libs/MAX31865.cpp>
   -<src/libs/hex_print.cpp>
   -<src/libs/least_squares_fit.cpp>

commit 10983d0cfe3e353ba465cfcadf8aeb51327f1197
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Wed Mar 15 00:29:37 2023 -0500

    üé® Misc. tramming menu cleanup (#25519)

diff --git a/platformio.ini b/platformio.ini
index 991c17b2ff..d31f23abec 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -60,8 +60,8 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/t
   -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>
   -<src/lcd/menu/game/maze.cpp> -<src/lcd/menu/game/snake.cpp>
   -<src/lcd/menu/menu_backlash.cpp>
-  -<src/lcd/menu/menu_bed_corners.cpp>
   -<src/lcd/menu/menu_bed_leveling.cpp>
+  -<src/lcd/menu/menu_bed_tramming.cpp>
   -<src/lcd/menu/menu_cancelobject.cpp>
   -<src/lcd/menu/menu_delta_calibrate.cpp>
   -<src/lcd/menu/menu_filament.cpp>
@@ -77,7 +77,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/t
   -<src/lcd/menu/menu_temperature.cpp>
   -<src/lcd/menu/menu_tmc.cpp>
   -<src/lcd/menu/menu_touch_screen.cpp>
-  -<src/lcd/menu/menu_tramming.cpp>
+  -<src/lcd/menu/menu_tramming_wizard.cpp>
   -<src/lcd/menu/menu_ubl.cpp>
   -<src/lcd/menu/menu_x_twist.cpp>
   -<src/lcd/extui/anycubic_chiron>

commit 32e8627510498da3a88d9e198f7c17a6a2ad8a66
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Sun Jan 1 15:38:13 2023 +1300

    ‚ú® New DGUS_LCD_UI option, IA_CREALITY (#25143)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 09519532e7..991c17b2ff 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -89,6 +89,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/t
   -<src/lcd/extui/malyan>
   -<src/lcd/extui/mks_ui>
   -<src/lcd/extui/nextion>
+  -<src/lcd/extui/ia_creality>
   -<src/lcd/lcdprint.cpp>
   -<src/lcd/touch/touch_buttons.cpp>
   -<src/sd/usb_flashdrive/lib-uhs2> -<src/sd/usb_flashdrive/lib-uhs3>

commit 049cfe659c8e4af282c50169ebbed98638a013fa
Author: Bart Meijer <brupje@gmail.com>
Date:   Mon Dec 12 22:36:50 2022 +0100

    ‚ú® SAMD21 HAL / Minitronics v2.0 (#24976)

diff --git a/platformio.ini b/platformio.ini
index 613f2c963a..09519532e7 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -23,6 +23,7 @@ extra_configs =
     ini/features.ini
     ini/lpc176x.ini
     ini/native.ini
+    ini/samd21.ini
     ini/samd51.ini
     ini/stm32-common.ini
     ini/stm32f0.ini

commit a460b01c876ff39901fe55a4b66b2c62737ef46c
Author: tombrazier <68918209+tombrazier@users.noreply.github.com>
Date:   Fri Oct 21 22:34:22 2022 +0100

    üöÄ ZV Input Shaping (#24797)

diff --git a/platformio.ini b/platformio.ini
index 751543c8a3..613f2c963a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -192,6 +192,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/t
   -<src/gcode/feature/advance>
   -<src/gcode/feature/camera>
   -<src/gcode/feature/i2c>
+  -<src/gcode/feature/input_shaping>
   -<src/gcode/feature/L6470>
   -<src/gcode/feature/leds/M150.cpp>
   -<src/gcode/feature/leds/M7219.cpp>

commit 83320f1052dd09bff7aae789372e7bffccbced97
Author: Mark <niujl123@sina.com>
Date:   Sat Aug 6 14:14:58 2022 +0800

    ‚ú® Bed Distance Sensor (#24554)

diff --git a/platformio.ini b/platformio.ini
index 4f5598f6af..751543c8a3 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -103,6 +103,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/t
   -<src/feature/backlash.cpp>
   -<src/feature/baricuda.cpp> -<src/gcode/feature/baricuda>
   -<src/feature/bedlevel/abl> -<src/gcode/bedlevel/abl>
+  -<src/feature/bedlevel/bdl> -<src/gcode/probe/M102.cpp>
   -<src/feature/bedlevel/mbl> -<src/gcode/bedlevel/mbl>
   -<src/feature/bedlevel/ubl> -<src/gcode/bedlevel/ubl>
   -<src/feature/bedlevel/hilbert_curve.cpp>

commit 59c2fe4561ffaf9ed90ee42593f5db098ca49877
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Thu Aug 4 17:56:09 2022 -0500

    üßë‚Äçüíª MARLIN_TEST_BUILD ‚Äì for future use (#24077)

diff --git a/platformio.ini b/platformio.ini
index b2f178ec0f..4f5598f6af 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -51,7 +51,7 @@ extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/preflight-checks.py
   post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
 lib_deps           =
-default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<Marlin/Marlin.ino>
+default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/tests>
   -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
   -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
   -<src/lcd/e3v2/common> -<src/lcd/e3v2/creality> -<src/lcd/e3v2/proui> -<src/lcd/e3v2/jyersui> -<src/lcd/e3v2/marlinui>

commit 1bed10c38075a15bfec380c9c7763fea336e787e
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Thu Aug 4 02:38:15 2022 -0500

    üîß Config INI, dump options (#24528)

diff --git a/platformio.ini b/platformio.ini
index 26f58662cc..b2f178ec0f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -16,6 +16,7 @@ boards_dir   = buildroot/share/PlatformIO/boards
 default_envs = mega2560
 include_dir  = Marlin
 extra_configs =
+    Marlin/config.ini
     ini/avr.ini
     ini/due.ini
     ini/esp32.ini
@@ -44,12 +45,13 @@ extra_configs =
 build_flags        = -g3 -D__MARLIN_FIRMWARE__ -DNDEBUG
                      -fmax-errors=5
 extra_scripts      =
+  pre:buildroot/share/PlatformIO/scripts/configuration.py
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
   pre:buildroot/share/PlatformIO/scripts/preflight-checks.py
   post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
 lib_deps           =
-default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
+default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<Marlin/Marlin.ino>
   -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
   -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
   -<src/lcd/e3v2/common> -<src/lcd/e3v2/creality> -<src/lcd/e3v2/proui> -<src/lcd/e3v2/jyersui> -<src/lcd/e3v2/marlinui>

commit 147fbd9d391a55a8d2f41600e7380af691da9bb3
Author: GHGiampy <83699429+GHGiampy@users.noreply.github.com>
Date:   Sat Jul 16 03:11:47 2022 +0200

    üî® Remove log2file monitor filter (#24502)

diff --git a/platformio.ini b/platformio.ini
index 06ab120966..26f58662cc 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -270,7 +270,7 @@ lib_deps          = ${common.lib_deps}
 monitor_speed     = 250000
 monitor_eol       = LF
 monitor_echo      = yes
-monitor_filters   = colorize, time, send_on_enter, log2file
+monitor_filters   = colorize, time, send_on_enter
 
 #
 # Just print the dependency tree

commit 068624a726213dc91f485db4d4eda1d89f656025
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue Jul 12 13:02:54 2022 -0500

    üìå Ask for PlatformIO 6.1.1 or newer (#24435)

diff --git a/platformio.ini b/platformio.ini
index 3820e70193..06ab120966 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -267,17 +267,10 @@ framework         = arduino
 extra_scripts     = ${common.extra_scripts}
 build_flags       = ${common.build_flags}
 lib_deps          = ${common.lib_deps}
-platform_packages = platformio/tool-dfuutil@^1.11.0
 monitor_speed     = 250000
-monitor_flags     =
-  --quiet
-  --echo
-  --eol
-    LF
-  --filter
-    colorize
-  --filter
-    time
+monitor_eol       = LF
+monitor_echo      = yes
+monitor_filters   = colorize, time, send_on_enter, log2file
 
 #
 # Just print the dependency tree

commit f5488f96cc6dddb0f3c6034982de75849cc5461d
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Wed Jun 29 20:16:16 2022 -0500

    üìù Index Mobo Rev03 => Opulo Lumen Rev3

diff --git a/platformio.ini b/platformio.ini
index ae50293e3f..3820e70193 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -263,12 +263,13 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
 # Default values apply to all 'env:' prefixed environments
 #
 [env]
-framework     = arduino
-extra_scripts = ${common.extra_scripts}
-build_flags   = ${common.build_flags}
-lib_deps      = ${common.lib_deps}
-monitor_speed = 250000
-monitor_flags =
+framework         = arduino
+extra_scripts     = ${common.extra_scripts}
+build_flags       = ${common.build_flags}
+lib_deps          = ${common.lib_deps}
+platform_packages = platformio/tool-dfuutil@^1.11.0
+monitor_speed     = 250000
+monitor_flags     =
   --quiet
   --echo
   --eol

commit 460e2436935e65ddbd32d6342063cbab5eab2d38
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Fri May 27 12:02:42 2022 +1200

    üî® Add src_filter for I2C_AMMETER (#24242)

diff --git a/platformio.ini b/platformio.ini
index b715bafb96..ae50293e3f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -96,6 +96,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/HAL/shared/eeprom_if_i2c.cpp>
   -<src/HAL/shared/eeprom_if_spi.cpp>
   -<src/feature/adc> -<src/gcode/feature/adc>
+  -<src/feature/ammeter.cpp>
   -<src/feature/babystep.cpp>
   -<src/feature/backlash.cpp>
   -<src/feature/baricuda.cpp> -<src/gcode/feature/baricuda>

commit 6a880280e4c7e7ed6ebc72d9b446017bd7db3702
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Fri May 20 02:15:57 2022 +1200

    üî® Require PIO >= 6.0.1 (#24205)

diff --git a/platformio.ini b/platformio.ini
index ac52fd7a1f..b715bafb96 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -281,7 +281,7 @@ monitor_flags =
 # Just print the dependency tree
 #
 [env:include_tree]
-platform    = atmelavr
-board       = megaatmega2560
-build_flags = -c -H -std=gnu++11 -Wall -Os -D__MARLIN_FIRMWARE__
-src_filter  = +<src/MarlinCore.cpp>
+platform         = atmelavr
+board            = megaatmega2560
+build_flags      = -c -H -std=gnu++11 -Wall -Os -D__MARLIN_FIRMWARE__
+build_src_filter = +<src/MarlinCore.cpp>

commit 19838d97be0d9ae22efa9d51a412bb1ac0bf056b
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Apr 3 16:50:39 2022 -0500

    üé®  Misc. adjustments, spacing

diff --git a/platformio.ini b/platformio.ini
index 79ef54bd47..ac52fd7a1f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -217,7 +217,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/lcd/M0_M1.cpp>
   -<src/gcode/lcd/M73.cpp>
   -<src/gcode/lcd/M117.cpp>
-  -<src/gcode/lcd/M250.cpp> -<src/gcode/lcd/M256.cpp>
+  -<src/gcode/lcd/M250.cpp> -<src/gcode/lcd/M255.cpp> -<src/gcode/lcd/M256.cpp>
   -<src/gcode/lcd/M300.cpp>
   -<src/gcode/lcd/M414.cpp>
   -<src/gcode/lcd/M995.cpp>

commit 72b2e2b2c7230245dea9fcb46b9b8a92bcb11bcc
Author: tombrazier <68918209+tombrazier@users.noreply.github.com>
Date:   Fri Apr 1 08:14:14 2022 +0100

    ‚öóÔ∏è Temperature Model Predictive Control (#23751)

diff --git a/platformio.ini b/platformio.ini
index 952912b21d..79ef54bd47 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -239,6 +239,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/temp/M123.cpp>
   -<src/gcode/temp/M155.cpp>
   -<src/gcode/temp/M192.cpp>
+  -<src/gcode/temp/M306.cpp>
   -<src/gcode/units/G20_G21.cpp>
   -<src/gcode/units/M82_M83.cpp>
   -<src/gcode/units/M149.cpp>

commit 0752082b85ce94cd81153145d7940fca96b3286a
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue Mar 29 03:48:37 2022 -0500

    üé®  INI cleanup

diff --git a/platformio.ini b/platformio.ini
index 0e50da2b73..952912b21d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -215,11 +215,11 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/host/M360.cpp>
   -<src/gcode/host/M876.cpp>
   -<src/gcode/lcd/M0_M1.cpp>
+  -<src/gcode/lcd/M73.cpp>
   -<src/gcode/lcd/M117.cpp>
   -<src/gcode/lcd/M250.cpp> -<src/gcode/lcd/M256.cpp>
   -<src/gcode/lcd/M300.cpp>
   -<src/gcode/lcd/M414.cpp>
-  -<src/gcode/lcd/M73.cpp>
   -<src/gcode/lcd/M995.cpp>
   -<src/gcode/motion/G2_G3.cpp>
   -<src/gcode/motion/G5.cpp>

commit df4e022a48667369fcc94dfda56505eb3ba2019f
Author: Giuseppe499 <giuseppe499@live.it>
Date:   Sat Mar 12 00:12:03 2022 +0100

    üö∏ Fix, extend X Axis Twist Compensation (#23745)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 9b64bdd377..0e50da2b73 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -150,7 +150,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/tmc_util.cpp> -<src/module/stepper/trinamic.cpp>
   -<src/feature/tramming.cpp>
   -<src/feature/twibus.cpp>
-  -<src/feature/x_twist.cpp>
+  -<src/feature/x_twist.cpp> -<src/gcode/probe/M423.cpp>
   -<src/feature/z_stepper_align.cpp>
   -<src/gcode/bedlevel/G26.cpp>
   -<src/gcode/bedlevel/G35.cpp>

commit 2e39bc30fd748b0ade7aafdab4827f942536cdcd
Author: tombrazier <68918209+tombrazier@users.noreply.github.com>
Date:   Wed Mar 2 22:13:46 2022 +0000

    üö∏ Universal X_AXIS_TWIST_COMPENSATION (#23828)

diff --git a/platformio.ini b/platformio.ini
index 3a02b5ab18..9b64bdd377 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -100,7 +100,6 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/backlash.cpp>
   -<src/feature/baricuda.cpp> -<src/gcode/feature/baricuda>
   -<src/feature/bedlevel/abl> -<src/gcode/bedlevel/abl>
-  -<src/feature/bedlevel/abl/x_twist.cpp>
   -<src/feature/bedlevel/mbl> -<src/gcode/bedlevel/mbl>
   -<src/feature/bedlevel/ubl> -<src/gcode/bedlevel/ubl>
   -<src/feature/bedlevel/hilbert_curve.cpp>
@@ -151,6 +150,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/tmc_util.cpp> -<src/module/stepper/trinamic.cpp>
   -<src/feature/tramming.cpp>
   -<src/feature/twibus.cpp>
+  -<src/feature/x_twist.cpp>
   -<src/feature/z_stepper_align.cpp>
   -<src/gcode/bedlevel/G26.cpp>
   -<src/gcode/bedlevel/G35.cpp>

commit 569f867ea98b7cea729dcbd469372e8f787bb113
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Tue Feb 8 09:49:26 2022 +1300

    üö® Cleaner errors for renamed envs (#23690)

diff --git a/platformio.ini b/platformio.ini
index 8329cb494f..3a02b5ab18 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -32,6 +32,7 @@ extra_configs =
     ini/stm32h7.ini
     ini/stm32g0.ini
     ini/teensy.ini
+    ini/renamed.ini
 
 #
 # The 'common' section applies to most Marlin builds.

commit 0564cb188f1a74dc9ecfb55b793f4225424a9ca4
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sat Feb 5 10:30:17 2022 -0600

    üö∏ Enhanced UI => Professional UI - with updates (#23624)

diff --git a/platformio.ini b/platformio.ini
index e1db73a4bd..8329cb494f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -51,7 +51,7 @@ lib_deps           =
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
   -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
-  -<src/lcd/e3v2/common> -<src/lcd/e3v2/creality> -<src/lcd/e3v2/enhanced> -<src/lcd/e3v2/jyersui> -<src/lcd/e3v2/marlinui>
+  -<src/lcd/e3v2/common> -<src/lcd/e3v2/creality> -<src/lcd/e3v2/proui> -<src/lcd/e3v2/jyersui> -<src/lcd/e3v2/marlinui>
   -<src/lcd/menu>
   -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>
   -<src/lcd/menu/game/maze.cpp> -<src/lcd/menu/game/snake.cpp>

commit 6fbfeb68010e63c76b545e2c27aeb48ee73be68b
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sat Jan 1 22:54:27 2022 -0600

    ‚ú® M919 : Chopper Timing (#23400)

diff --git a/platformio.ini b/platformio.ini
index 74ac012f19..e1db73a4bd 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -204,6 +204,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/feature/trinamic/M569.cpp>
   -<src/gcode/feature/trinamic/M906.cpp>
   -<src/gcode/feature/trinamic/M911-M914.cpp>
+  -<src/gcode/feature/trinamic/M919.cpp>
   -<src/gcode/geometry/G17-G19.cpp>
   -<src/gcode/geometry/G53-G59.cpp>
   -<src/gcode/geometry/M206_M428.cpp>

commit 0077d982cdbc414c60b2be8c7800317883ce6413
Author: BigTreeTech <38851044+bigtreetech@users.noreply.github.com>
Date:   Sat Dec 11 03:38:03 2021 +0800

    ‚ú® BigTreeTech SKR mini E3 V3.0 (STM32G0B1RET6) (#23283)

diff --git a/platformio.ini b/platformio.ini
index 55a2bd2457..74ac012f19 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -30,6 +30,7 @@ extra_configs =
     ini/stm32f4.ini
     ini/stm32f7.ini
     ini/stm32h7.ini
+    ini/stm32g0.ini
     ini/teensy.ini
 
 #

commit a16a059312b0ddb822da2769b5ba5372f9857c48
Author: Giuseppe499 <giuseppe499@live.it>
Date:   Tue Dec 7 02:53:51 2021 +0100

    ‚ú® X Twist Compensation & Calibration (#23238)

diff --git a/platformio.ini b/platformio.ini
index 1b4effcf25..55a2bd2457 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -74,6 +74,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/menu/menu_touch_screen.cpp>
   -<src/lcd/menu/menu_tramming.cpp>
   -<src/lcd/menu/menu_ubl.cpp>
+  -<src/lcd/menu/menu_x_twist.cpp>
   -<src/lcd/extui/anycubic_chiron>
   -<src/lcd/extui/anycubic_i3mega>
   -<src/lcd/extui/dgus> -<src/lcd/extui/dgus/fysetc> -<src/lcd/extui/dgus/hiprecy> -<src/lcd/extui/dgus/mks> -<src/lcd/extui/dgus/origin>
@@ -97,6 +98,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/backlash.cpp>
   -<src/feature/baricuda.cpp> -<src/gcode/feature/baricuda>
   -<src/feature/bedlevel/abl> -<src/gcode/bedlevel/abl>
+  -<src/feature/bedlevel/abl/x_twist.cpp>
   -<src/feature/bedlevel/mbl> -<src/gcode/bedlevel/mbl>
   -<src/feature/bedlevel/ubl> -<src/gcode/bedlevel/ubl>
   -<src/feature/bedlevel/hilbert_curve.cpp>

commit 363a17ac464e72bb013150e742b0e95f9df707eb
Author: Stuart Pittaway <1201909+stuartpittaway@users.noreply.github.com>
Date:   Sat Dec 4 23:44:10 2021 +0000

    ‚ú® M3426 to read i2c MCP3426 ADC (#23184)

diff --git a/platformio.ini b/platformio.ini
index 07821fca96..1b4effcf25 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -92,6 +92,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/HAL/shared/cpu_exception>
   -<src/HAL/shared/eeprom_if_i2c.cpp>
   -<src/HAL/shared/eeprom_if_spi.cpp>
+  -<src/feature/adc> -<src/gcode/feature/adc>
   -<src/feature/babystep.cpp>
   -<src/feature/backlash.cpp>
   -<src/feature/baricuda.cpp> -<src/gcode/feature/baricuda>

commit d4c78edfe37c62e82aee9bfa3ca8b685e3d5cb62
Author: schmttc <89831403+schmttc@users.noreply.github.com>
Date:   Wed Nov 24 08:52:18 2021 +1100

    ‚ú® EasyThreeD ET4000+ board and UI (#23080)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 0be12fb6ae..07821fca96 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -109,6 +109,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/dac> -<src/feature/digipot>
   -<src/feature/direct_stepping.cpp> -<src/gcode/motion/G6.cpp>
   -<src/feature/e_parser.cpp>
+  -<src/feature/easythreed_ui.cpp>
   -<src/feature/encoder_i2c.cpp>
   -<src/feature/ethernet.cpp> -<src/gcode/feature/network/M552-M554.cpp>
   -<src/feature/fancheck.cpp>

commit 7110d11c9d8933c8c412c2fabd3b065a5ab97b6e
Author: Giuliano Zaro <3684609+GMagician@users.noreply.github.com>
Date:   Tue Nov 23 21:01:53 2021 +0100

    ‚ú® Fan tachometer support (#23086)
    
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/platformio.ini b/platformio.ini
index a364e8920f..0be12fb6ae 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -111,6 +111,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/e_parser.cpp>
   -<src/feature/encoder_i2c.cpp>
   -<src/feature/ethernet.cpp> -<src/gcode/feature/network/M552-M554.cpp>
+  -<src/feature/fancheck.cpp>
   -<src/feature/fanmux.cpp>
   -<src/feature/filwidth.cpp> -<src/gcode/feature/filwidth>
   -<src/feature/fwretract.cpp> -<src/gcode/feature/fwretract>
@@ -228,6 +229,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/sd/M32.cpp>
   -<src/gcode/sd/M808.cpp>
   -<src/gcode/temp/M104_M109.cpp>
+  -<src/gcode/temp/M123.cpp>
   -<src/gcode/temp/M155.cpp>
   -<src/gcode/temp/M192.cpp>
   -<src/gcode/units/G20_G21.cpp>

commit 296a6137cd06ce06f062767ab1b59f99ee95a094
Author: tombrazier <68918209+tombrazier@users.noreply.github.com>
Date:   Mon Nov 1 23:03:50 2021 +0000

    üö∏ More flexible Probe Temperature Compensation (#23033)

diff --git a/platformio.ini b/platformio.ini
index 106e454d10..a364e8920f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -152,7 +152,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/calibrate/G33.cpp>
   -<src/gcode/calibrate/G34.cpp>
   -<src/gcode/calibrate/G34_M422.cpp>
-  -<src/gcode/calibrate/G76_M192_M871.cpp>
+  -<src/gcode/calibrate/G76_M871.cpp>
   -<src/gcode/calibrate/G425.cpp>
   -<src/gcode/calibrate/M12.cpp>
   -<src/gcode/calibrate/M48.cpp>
@@ -229,6 +229,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/sd/M808.cpp>
   -<src/gcode/temp/M104_M109.cpp>
   -<src/gcode/temp/M155.cpp>
+  -<src/gcode/temp/M192.cpp>
   -<src/gcode/units/G20_G21.cpp>
   -<src/gcode/units/M82_M83.cpp>
   -<src/gcode/units/M149.cpp>

commit 3344071f24b505d180dd1423b11510172c3f1c1c
Author: Dan Royer <dan@marginallyclever.com>
Date:   Mon Sep 20 13:42:33 2021 -0700

    Polargraph / Makelangelo kinematics (#22790)

diff --git a/platformio.ini b/platformio.ini
index bd2a4ed21f..106e454d10 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -158,6 +158,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/calibrate/M48.cpp>
   -<src/gcode/calibrate/M100.cpp>
   -<src/gcode/calibrate/M425.cpp>
+  -<src/gcode/calibrate/M665.cpp>
   -<src/gcode/calibrate/M666.cpp>
   -<src/gcode/calibrate/M852.cpp>
   -<src/gcode/control/M10-M11.cpp>
@@ -239,9 +240,10 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/libs/nozzle.cpp> -<src/gcode/feature/clean>
   -<src/module/delta.cpp>
   -<src/module/planner_bezier.cpp>
+  -<src/module/polargraph.cpp>
   -<src/module/printcounter.cpp>
   -<src/module/probe.cpp>
-  -<src/module/scara.cpp> -<src/gcode/calibrate/M665.cpp>
+  -<src/module/scara.cpp>
   -<src/module/servo.cpp> -<src/gcode/control/M280.cpp> -<src/gcode/config/M281.cpp> -<src/gcode/control/M282.cpp>
   -<src/module/stepper/TMC26X.cpp>
 

commit 5b5a8798f8fe202e86c008088f847a3edb51cc71
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Wed Sep 15 19:48:29 2021 -0500

    üé® Consolidate Ender-3 V2 DWIN common code (#22778)

diff --git a/platformio.ini b/platformio.ini
index 5e40455098..bd2a4ed21f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -50,7 +50,7 @@ lib_deps           =
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
   -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
-  -<src/lcd/e3v2/creality> -<src/lcd/e3v2/enhanced> -<src/lcd/e3v2/jyersui> -<src/lcd/e3v2/marlinui>
+  -<src/lcd/e3v2/common> -<src/lcd/e3v2/creality> -<src/lcd/e3v2/enhanced> -<src/lcd/e3v2/jyersui> -<src/lcd/e3v2/marlinui>
   -<src/lcd/menu>
   -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>
   -<src/lcd/menu/game/maze.cpp> -<src/lcd/menu/game/snake.cpp>

commit 21e8f99500554d69cb91ac2be0b4ab1497bf9fac
Author: Dakkaron <dak1st@gmx.at>
Date:   Wed Sep 15 02:00:48 2021 +0200

    ‚ú® M282 - Detach Servo (#22760)

diff --git a/platformio.ini b/platformio.ini
index 5502069800..5e40455098 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -87,7 +87,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/touch/touch_buttons.cpp>
   -<src/sd/usb_flashdrive/lib-uhs2> -<src/sd/usb_flashdrive/lib-uhs3>
   -<src/sd/usb_flashdrive/Sd2Card_FlashDrive.cpp>
-  -<src/sd/cardreader.cpp> -<src/sd/Sd2Card.cpp> -<src/sd/SdBaseFile.cpp> -<src/sd/SdFatUtil.cpp> -<src/sd/SdFile.cpp> -<src/sd/SdVolume.cpp> -<src/gcode/sd>
+  -<src/sd/cardreader.cpp> -<src/sd/Sd2Card.cpp> -<src/sd/SdBaseFile.cpp> -<src/sd/SdFatUtil.cpp> -<src/sd/SdFile.cpp> -<src/sd/SdVolume.cpp>
   -<src/HAL/shared/backtrace>
   -<src/HAL/shared/cpu_exception>
   -<src/HAL/shared/eeprom_if_i2c.cpp>
@@ -166,7 +166,6 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/config/M217.cpp>
   -<src/gcode/config/M218.cpp>
   -<src/gcode/config/M221.cpp>
-  -<src/gcode/config/M281.cpp>
   -<src/gcode/config/M301.cpp>
   -<src/gcode/config/M302.cpp>
   -<src/gcode/config/M304.cpp>
@@ -243,7 +242,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/module/printcounter.cpp>
   -<src/module/probe.cpp>
   -<src/module/scara.cpp> -<src/gcode/calibrate/M665.cpp>
-  -<src/module/servo.cpp> -<src/gcode/control/M280.cpp>
+  -<src/module/servo.cpp> -<src/gcode/control/M280.cpp> -<src/gcode/config/M281.cpp> -<src/gcode/control/M282.cpp>
   -<src/module/stepper/TMC26X.cpp>
 
 #

commit 0f61d9e4dd4d4e4f27e5c688ab2c5dbd0f03af84
Author: Miguel Risco-Castillo <mriscoc@users.noreply.github.com>
Date:   Tue Sep 7 02:15:24 2021 -0500

    ‚ú® Ender-3 V2 CrealityUI Enhanced (#21942)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 23ee15d98b..5502069800 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -50,7 +50,7 @@ lib_deps           =
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
   -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
-  -<src/lcd/e3v2/creality> -<src/lcd/e3v2/jyersui> -<src/lcd/e3v2/marlinui>
+  -<src/lcd/e3v2/creality> -<src/lcd/e3v2/enhanced> -<src/lcd/e3v2/jyersui> -<src/lcd/e3v2/marlinui>
   -<src/lcd/menu>
   -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>
   -<src/lcd/menu/game/maze.cpp> -<src/lcd/menu/game/snake.cpp>

commit 43a9c71ef7a1c9e9e294707017d372d344c774ce
Author: Jyers <76993396+Jyers@users.noreply.github.com>
Date:   Mon Sep 6 21:06:27 2021 -0700

    ‚ú® Ender-3 V2 with Jyers UI (#22422)

diff --git a/platformio.ini b/platformio.ini
index 55c7577e37..23ee15d98b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -49,8 +49,8 @@ extra_scripts      =
 lib_deps           =
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
-  -<src/lcd/e3v2/creality> -<src/lcd/e3v2/marlinui>
   -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
+  -<src/lcd/e3v2/creality> -<src/lcd/e3v2/jyersui> -<src/lcd/e3v2/marlinui>
   -<src/lcd/menu>
   -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>
   -<src/lcd/menu/game/maze.cpp> -<src/lcd/menu/game/snake.cpp>

commit b0e798330d8f5ade4a230e0a91f05482d100bb97
Author: mrv96 <mrv96@users.noreply.github.com>
Date:   Tue Sep 7 02:51:04 2021 +0200

    ‚ú®Add DGUS_LCD_UI_RELOADED (#21931)

diff --git a/platformio.ini b/platformio.ini
index 9ee1e76a5b..55c7577e37 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -77,6 +77,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/extui/anycubic_chiron>
   -<src/lcd/extui/anycubic_i3mega>
   -<src/lcd/extui/dgus> -<src/lcd/extui/dgus/fysetc> -<src/lcd/extui/dgus/hiprecy> -<src/lcd/extui/dgus/mks> -<src/lcd/extui/dgus/origin>
+  -<src/lcd/extui/dgus_reloaded>
   -<src/lcd/extui/example>
   -<src/lcd/extui/ftdi_eve_touch_ui>
   -<src/lcd/extui/malyan>

commit 7d416bd055e3ccddf765208b2937dcc1fcd4ea8b
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Aug 22 05:25:07 2021 -0500

    ‚ú® MarlinUI for Ender 3 v2 DWIN LCD (#22594)
    
    Co-Authored-By: Taylor Talkington <taylor.talkington@gmail.com>

diff --git a/platformio.ini b/platformio.ini
index db4d12ea7f..9ee1e76a5b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -48,7 +48,8 @@ extra_scripts      =
   post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
 lib_deps           =
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
-  -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/e3v2/creality> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
+  -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
+  -<src/lcd/e3v2/creality> -<src/lcd/e3v2/marlinui>
   -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
   -<src/lcd/menu>
   -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>

commit 1e33c1a2a78392e9182442db043384b0f96cca20
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Aug 1 14:28:53 2021 -0500

    M256 LCD brightness (#22478)

diff --git a/platformio.ini b/platformio.ini
index 3938b9f8b1..db4d12ea7f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -206,7 +206,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/host/M876.cpp>
   -<src/gcode/lcd/M0_M1.cpp>
   -<src/gcode/lcd/M117.cpp>
-  -<src/gcode/lcd/M250.cpp>
+  -<src/gcode/lcd/M250.cpp> -<src/gcode/lcd/M256.cpp>
   -<src/gcode/lcd/M300.cpp>
   -<src/gcode/lcd/M414.cpp>
   -<src/gcode/lcd/M73.cpp>

commit 9bb5b10c0c9cf5a61d2bfb9dfdb6cfe210b6002b
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sat Jul 31 05:32:13 2021 -0500

    üöö Relocate and adjust DWIN E3V2 (#22471)

diff --git a/platformio.ini b/platformio.ini
index 1fb9ba55e6..3938b9f8b1 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -48,7 +48,7 @@ extra_scripts      =
   post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
 lib_deps           =
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
-  -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
+  -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/e3v2/creality> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
   -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
   -<src/lcd/menu>
   -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>

commit da0450605a31626f423808c4842256671152c489
Author: Katelyn Schiesser <katelyn.schiesser@gmail.com>
Date:   Tue Jul 20 12:20:28 2021 -0700

    ‚ôªÔ∏è Refactor STM32 ini files (#22377)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index afdd823f9e..1fb9ba55e6 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -23,11 +23,13 @@ extra_configs =
     ini/lpc176x.ini
     ini/native.ini
     ini/samd51.ini
+    ini/stm32-common.ini
     ini/stm32f0.ini
     ini/stm32f1-maple.ini
     ini/stm32f1.ini
     ini/stm32f4.ini
     ini/stm32f7.ini
+    ini/stm32h7.ini
     ini/teensy.ini
 
 #

commit b2f0913083d83bd3fd9af1c603d1f4cc1afb64eb
Author: Katelyn Schiesser <katelyn.schiesser@gmail.com>
Date:   Tue Jul 6 17:36:41 2021 -0700

    üêõ Redundant Temp Sensor followup (#22196)

diff --git a/platformio.ini b/platformio.ini
index f55f5f5a93..afdd823f9e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -230,6 +230,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/units/M149.cpp>
   -<src/libs/BL24CXX.cpp> -<src/libs/W25Qxx.cpp>
   -<src/libs/L64XX> -<src/module/stepper/L64xx.cpp> -<src/HAL/shared/HAL_spi_L6470.cpp>
+  -<src/libs/MAX31865.cpp>
   -<src/libs/hex_print.cpp>
   -<src/libs/least_squares_fit.cpp>
   -<src/libs/nozzle.cpp> -<src/gcode/feature/clean>

commit 08155b4875fdb08f1888cacae6e1b68b48b9e51f
Author: ellensp <ellensp@hotmail.com>
Date:   Wed Jun 2 18:42:15 2021 +1200

    üî® Creality v4 with STM32 HAL (#21999)
    
    - New STM32 env for Creality V4 boards.
    - Separate Libmaple targets into their own `ini` file.
    - Temporarily remove unusable targets from `pins.h`.
    
    Co-authored-by: ellensp <ellensp@hotmsil.com>
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/platformio.ini b/platformio.ini
index b552eda81d..f55f5f5a93 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -24,6 +24,7 @@ extra_configs =
     ini/native.ini
     ini/samd51.ini
     ini/stm32f0.ini
+    ini/stm32f1-maple.ini
     ini/stm32f1.ini
     ini/stm32f4.ini
     ini/stm32f7.ini

commit 731370051de73ad4c92d60ec01563def3da53ddb
Author: ellensp <ellensp@hotmail.com>
Date:   Mon May 24 13:29:19 2021 +1200

    ‚ö°Ô∏è PIO filters for M117, M300 and M414 (#21972)

diff --git a/platformio.ini b/platformio.ini
index 0516149da9..b552eda81d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -202,7 +202,10 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/host/M360.cpp>
   -<src/gcode/host/M876.cpp>
   -<src/gcode/lcd/M0_M1.cpp>
+  -<src/gcode/lcd/M117.cpp>
   -<src/gcode/lcd/M250.cpp>
+  -<src/gcode/lcd/M300.cpp>
+  -<src/gcode/lcd/M414.cpp>
   -<src/gcode/lcd/M73.cpp>
   -<src/gcode/lcd/M995.cpp>
   -<src/gcode/motion/G2_G3.cpp>

commit 2de54dab84d82ef69fb9ac3bd9025444f4f84813
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri May 21 08:23:09 2021 -0500

    üé® Move HAS_EXTRUDERS

diff --git a/platformio.ini b/platformio.ini
index 4d69ca12df..0516149da9 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -222,6 +222,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/temp/M104_M109.cpp>
   -<src/gcode/temp/M155.cpp>
   -<src/gcode/units/G20_G21.cpp>
+  -<src/gcode/units/M82_M83.cpp>
   -<src/gcode/units/M149.cpp>
   -<src/libs/BL24CXX.cpp> -<src/libs/W25Qxx.cpp>
   -<src/libs/L64XX> -<src/module/stepper/L64xx.cpp> -<src/HAL/shared/HAL_spi_L6470.cpp>

commit 7f774cab9005dd56667bf4db09c23370bd2c873f
Author: Luu Lac <45380455+shitcreek@users.noreply.github.com>
Date:   Sat May 15 15:02:20 2021 -0500

    M154 Position Auto-Report (#18427)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index e743eb2db4..4d69ca12df 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -198,6 +198,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/geometry/M206_M428.cpp>
   -<src/gcode/host/M16.cpp>
   -<src/gcode/host/M113.cpp>
+  -<src/gcode/host/M154.cpp>
   -<src/gcode/host/M360.cpp>
   -<src/gcode/host/M876.cpp>
   -<src/gcode/lcd/M0_M1.cpp>

commit 8d9021e8069c0550e9a31107adf44b9112b87471
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Thu May 6 04:17:59 2021 -0500

    Move ExtUI subfolders up a level (#21820)

diff --git a/platformio.ini b/platformio.ini
index bbc9ffd904..e743eb2db4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -70,15 +70,14 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/menu/menu_touch_screen.cpp>
   -<src/lcd/menu/menu_tramming.cpp>
   -<src/lcd/menu/menu_ubl.cpp>
-  -<src/lcd/extui/lib/mks_ui>
-  -<src/lcd/extui/lib/dgus> -<src/lcd/extui/dgus_lcd.cpp>
-  -<src/lcd/extui/lib/dgus/fysetc> -<src/lcd/extui/lib/dgus/hiprecy> -<src/lcd/extui/lib/dgus/mks> -<src/lcd/extui/lib/dgus/origin>
-  -<src/lcd/extui/example.cpp>
-  -<src/lcd/extui/malyan_lcd.cpp>
-  -<src/lcd/extui/lib/ftdi_eve_touch_ui>
-  -<src/lcd/extui/anycubic_chiron_lcd.cpp> -<src/lcd/extui/lib/anycubic_chiron>
-  -<src/lcd/extui/anycubic_i3mega_lcd.cpp> -<src/lcd/extui/lib/anycubic_i3mega>
-  -<src/lcd/extui/nextion_lcd.cpp> -<src/lcd/extui/lib/nextion>
+  -<src/lcd/extui/anycubic_chiron>
+  -<src/lcd/extui/anycubic_i3mega>
+  -<src/lcd/extui/dgus> -<src/lcd/extui/dgus/fysetc> -<src/lcd/extui/dgus/hiprecy> -<src/lcd/extui/dgus/mks> -<src/lcd/extui/dgus/origin>
+  -<src/lcd/extui/example>
+  -<src/lcd/extui/ftdi_eve_touch_ui>
+  -<src/lcd/extui/malyan>
+  -<src/lcd/extui/mks_ui>
+  -<src/lcd/extui/nextion>
   -<src/lcd/lcdprint.cpp>
   -<src/lcd/touch/touch_buttons.cpp>
   -<src/sd/usb_flashdrive/lib-uhs2> -<src/sd/usb_flashdrive/lib-uhs3>

commit 69d85cce2da20b88784db68324c228db212af071
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Tue Apr 27 00:22:09 2021 -0700

    BTT SKR V2.0 / Stepper Driver Anti-Reverse Protection (#21503)

diff --git a/platformio.ini b/platformio.ini
index d17c283b72..bbc9ffd904 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -136,6 +136,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/snmm.cpp>
   -<src/feature/solenoid.cpp> -<src/gcode/control/M380_M381.cpp>
   -<src/feature/spindle_laser.cpp> -<src/gcode/control/M3-M5.cpp>
+  -<src/feature/stepper_driver_safety.cpp>
   -<src/feature/tmc_util.cpp> -<src/module/stepper/trinamic.cpp>
   -<src/feature/tramming.cpp>
   -<src/feature/twibus.cpp>

commit a981c33baddb240fb0a48e6c702b9ce6f1128dae
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Mon Apr 26 21:30:34 2021 -0300

    Remove compiler flag merge-constants (#21711)

diff --git a/platformio.ini b/platformio.ini
index 75e7f6a58b..d17c283b72 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -36,7 +36,7 @@ extra_configs =
 # Remove '-fmax-errors=5' from build_flags below to see all.
 #
 [common]
-build_flags        = -g3 -D__MARLIN_FIRMWARE__ -DNDEBUG -fmerge-constants
+build_flags        = -g3 -D__MARLIN_FIRMWARE__ -DNDEBUG
                      -fmax-errors=5
 extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py

commit f075dd0db3496d99c84fcf77242f60731982184c
Author: Mike La Spina <mike.laspina@shaw.ca>
Date:   Thu Apr 22 18:19:41 2021 -0500

    M10-M11 Air Evacuation for Spindle/Laser (#21668)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 8a747404e3..75e7f6a58b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -155,6 +155,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/calibrate/M425.cpp>
   -<src/gcode/calibrate/M666.cpp>
   -<src/gcode/calibrate/M852.cpp>
+  -<src/gcode/control/M10-M11.cpp>
   -<src/gcode/control/M42.cpp> -<src/gcode/control/M226.cpp>
   -<src/gcode/config/M43.cpp>
   -<src/gcode/config/M217.cpp>

commit 8e60b19662c3c05c935ce76f95a39a40747a1180
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Apr 17 19:52:23 2021 -0500

    Disable assert() by default

diff --git a/platformio.ini b/platformio.ini
index 77abb364e7..8a747404e3 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -36,7 +36,7 @@ extra_configs =
 # Remove '-fmax-errors=5' from build_flags below to see all.
 #
 [common]
-build_flags        = -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants
+build_flags        = -g3 -D__MARLIN_FIRMWARE__ -DNDEBUG -fmerge-constants
                      -fmax-errors=5
 extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py

commit c508c2213ee5b0ed130238c058b7cc91beaea654
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Apr 18 14:07:30 2021 -0500

    Misc. pio cleanup

diff --git a/platformio.ini b/platformio.ini
index 87b6e8a90b..77abb364e7 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -10,11 +10,6 @@
 # Automatic targets - enable auto-uploading
 #targets = upload
 
-#
-# By default platformio build will abort after 5 errors.
-# Remove '-fmax-errors=5' from build_flags below to see all.
-#
-
 [platformio]
 src_dir      = Marlin
 boards_dir   = buildroot/share/PlatformIO/boards
@@ -35,10 +30,14 @@ extra_configs =
     ini/teensy.ini
 
 #
-# The 'common' values are used for most Marlin builds
+# The 'common' section applies to most Marlin builds.
+#
+# By default platformio build will abort after 5 errors.
+# Remove '-fmax-errors=5' from build_flags below to see all.
 #
 [common]
-build_flags        = -fmax-errors=5 -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants
+build_flags        = -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants
+                     -fmax-errors=5
 extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py

commit 528b9bd8729656d7ebcd3dc7898ceddc2f377354
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Apr 16 02:43:59 2021 -0500

    Revert experimental NAN patch
    
    Hold changes from #21575 (24a095c) for more testing.

diff --git a/platformio.ini b/platformio.ini
index 53db8fc4b1..87b6e8a90b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -38,7 +38,7 @@ extra_configs =
 # The 'common' values are used for most Marlin builds
 #
 [common]
-build_flags        = -fmax-errors=5 -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants -fno-signed-zeros -ffinite-math-only
+build_flags        = -fmax-errors=5 -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants
 extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py

commit 24a095c5c14b60bcbffc2807d2c8cc8e9af46e90
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon Apr 12 16:49:53 2021 -0500

    Reduce math library code size by 3.4KB (#21575)

diff --git a/platformio.ini b/platformio.ini
index 913bb44ae0..53db8fc4b1 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -38,6 +38,13 @@ extra_configs =
 # The 'common' values are used for most Marlin builds
 #
 [common]
+build_flags        = -fmax-errors=5 -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants -fno-signed-zeros -ffinite-math-only
+extra_scripts      =
+  pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
+  pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
+  pre:buildroot/share/PlatformIO/scripts/preflight-checks.py
+  post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
+lib_deps           =
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
   -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
@@ -227,13 +234,6 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/module/scara.cpp> -<src/gcode/calibrate/M665.cpp>
   -<src/module/servo.cpp> -<src/gcode/control/M280.cpp>
   -<src/module/stepper/TMC26X.cpp>
-extra_scripts      =
-  pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
-  pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
-  pre:buildroot/share/PlatformIO/scripts/preflight-checks.py
-  post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
-build_flags        = -fmax-errors=5 -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants
-lib_deps           =
 
 #
 # Default values apply to all 'env:' prefixed environments

commit 3229100025dc428d5038eca753c70f3c831d6336
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Thu Apr 1 21:53:19 2021 -0500

    Split up platformio.ini (#21507)

diff --git a/platformio.ini b/platformio.ini
index 26b27bbf99..913bb44ae0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -20,6 +20,19 @@ src_dir      = Marlin
 boards_dir   = buildroot/share/PlatformIO/boards
 default_envs = mega2560
 include_dir  = Marlin
+extra_configs =
+    ini/avr.ini
+    ini/due.ini
+    ini/esp32.ini
+    ini/features.ini
+    ini/lpc176x.ini
+    ini/native.ini
+    ini/samd51.ini
+    ini/stm32f0.ini
+    ini/stm32f1.ini
+    ini/stm32f4.ini
+    ini/stm32f7.ini
+    ini/teensy.ini
 
 #
 # The 'common' values are used for most Marlin builds
@@ -222,217 +235,6 @@ extra_scripts      =
 build_flags        = -fmax-errors=5 -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants
 lib_deps           =
 
-#
-# Feature Dependencies
-#
-[features]
-YHCB2004                = red-scorp/LiquidCrystal_AIP31068@^1.0.4, red-scorp/SoftSPIB@^1.1.1
-HAS_TFT_LVGL_UI         = lvgl=https://github.com/makerbase-mks/LVGL-6.1.1-MKS/archive/master.zip
-                          src_filter=+<src/lcd/extui/lib/mks_ui>
-                          extra_scripts=download_mks_assets.py
-POSTMORTEM_DEBUGGING    = src_filter=+<src/HAL/shared/cpu_exception> +<src/HAL/shared/backtrace>
-                          build_flags=-funwind-tables
-MKS_WIFI_MODULE         = QRCode=https://github.com/makerbase-mks/QRCode/archive/master.zip
-HAS_TRINAMIC_CONFIG     = TMCStepper@~0.7.1
-                          src_filter=+<src/feature/tmc_util.cpp> +<src/module/stepper/trinamic.cpp> +<src/gcode/feature/trinamic/M122.cpp> +<src/gcode/feature/trinamic/M906.cpp> +<src/gcode/feature/trinamic/M911-M914.cpp>
-HAS_STEALTHCHOP         = src_filter=+<src/gcode/feature/trinamic/M569.cpp>
-SR_LCD_3W_NL            = SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-HAS_MOTOR_CURRENT_I2C   = SlowSoftI2CMaster
-                          src_filter=+<src/feature/digipot>
-HAS_TMC26X              = TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-                          src_filter=+<src/module/TMC26X.cpp>
-HAS_L64XX               = Arduino-L6470@0.8.0
-                          src_filter=+<src/libs/L64XX> +<src/module/stepper/L64xx.cpp> +<src/gcode/feature/L6470> +<src/HAL/shared/HAL_spi_L6470.cpp>
-NEOPIXEL_LED            = Adafruit NeoPixel@1.5.0
-                          src_filter=+<src/feature/leds/neopixel.cpp>
-TEMP_.+_IS_MAX31865     = Adafruit MAX31865 library@~1.1.0
-USES_LIQUIDCRYSTAL      = bitbucket-fmalpartida/LiquidCrystal@1.5.0
-USES_LIQUIDCRYSTAL_I2C  = marcoschwartz/LiquidCrystal_I2C@1.1.4
-USES_LIQUIDTWI2         = LiquidTWI2@1.2.7
-HAS_WIRED_LCD           = src_filter=+<src/lcd/lcdprint.cpp>
-HAS_MARLINUI_HD44780    = src_filter=+<src/lcd/HD44780>
-HAS_MARLINUI_U8GLIB     = U8glib-HAL@~0.4.1
-                          src_filter=+<src/lcd/dogm>
-HAS_(FSMC|SPI)_TFT      = src_filter=+<src/HAL/STM32/tft> +<src/HAL/STM32F1/tft> +<src/lcd/tft_io>
-HAS_FSMC_TFT            = src_filter=+<src/HAL/STM32/tft/tft_fsmc.cpp> +<src/HAL/STM32F1/tft/tft_fsmc.cpp>
-HAS_SPI_TFT             = src_filter=+<src/HAL/STM32/tft/tft_spi.cpp> +<src/HAL/STM32F1/tft/tft_spi.cpp>
-I2C_EEPROM              = src_filter=+<src/HAL/shared/eeprom_if_i2c.cpp>
-SPI_EEPROM              = src_filter=+<src/HAL/shared/eeprom_if_spi.cpp>
-HAS_GRAPHICAL_TFT       = src_filter=+<src/lcd/tft>
-DWIN_CREALITY_LCD       = src_filter=+<src/lcd/dwin>
-IS_TFTGLCD_PANEL        = src_filter=+<src/lcd/TFTGLCD>
-HAS_TOUCH_BUTTONS       = src_filter=+<src/lcd/touch/touch_buttons.cpp>
-HAS_LCD_MENU            = src_filter=+<src/lcd/menu>
-HAS_GAMES               = src_filter=+<src/lcd/menu/game/game.cpp>
-MARLIN_BRICKOUT         = src_filter=+<src/lcd/menu/game/brickout.cpp>
-MARLIN_INVADERS         = src_filter=+<src/lcd/menu/game/invaders.cpp>
-MARLIN_MAZE             = src_filter=+<src/lcd/menu/game/maze.cpp>
-MARLIN_SNAKE            = src_filter=+<src/lcd/menu/game/snake.cpp>
-HAS_MENU_BACKLASH       = src_filter=+<src/lcd/menu/menu_backlash.cpp>
-HAS_MENU_BED_CORNERS    = src_filter=+<src/lcd/menu/menu_bed_corners.cpp>
-LCD_BED_LEVELING        = src_filter=+<src/lcd/menu/menu_bed_leveling.cpp>
-HAS_MENU_CANCELOBJECT   = src_filter=+<src/lcd/menu/menu_cancelobject.cpp>
-HAS_MENU_DELTA_CALIBRATE = src_filter=+<src/lcd/menu/menu_delta_calibrate.cpp>
-HAS_MENU_FILAMENT       = src_filter=+<src/lcd/menu/menu_filament.cpp>
-LCD_INFO_MENU           = src_filter=+<src/lcd/menu/menu_info.cpp>
-HAS_MENU_JOB_RECOVERY   = src_filter=+<src/lcd/menu/menu_job_recovery.cpp>
-HAS_MULTI_LANGUAGE      = src_filter=+<src/lcd/menu/menu_language.cpp>
-HAS_MENU_LED            = src_filter=+<src/lcd/menu/menu_led.cpp>
-HAS_MENU_MEDIA          = src_filter=+<src/lcd/menu/menu_media.cpp>
-HAS_MENU_MIXER          = src_filter=+<src/lcd/menu/menu_mixer.cpp>
-HAS_MENU_MMU2           = src_filter=+<src/lcd/menu/menu_mmu2.cpp>
-HAS_MENU_PASSWORD       = src_filter=+<src/lcd/menu/menu_password.cpp>
-HAS_MENU_POWER_MONITOR  = src_filter=+<src/lcd/menu/menu_power_monitor.cpp>
-HAS_MENU_CUTTER         = src_filter=+<src/lcd/menu/menu_spindle_laser.cpp>
-HAS_MENU_TEMPERATURE    = src_filter=+<src/lcd/menu/menu_temperature.cpp>
-HAS_MENU_TMC            = src_filter=+<src/lcd/menu/menu_tmc.cpp>
-HAS_MENU_TOUCH_SCREEN   = src_filter=+<src/lcd/menu/menu_touch_screen.cpp>
-HAS_MENU_TRAMMING       = src_filter=+<src/lcd/menu/menu_tramming.cpp>
-HAS_MENU_UBL            = src_filter=+<src/lcd/menu/menu_ubl.cpp>
-ANYCUBIC_LCD_CHIRON     = src_filter=+<src/lcd/extui/anycubic_chiron_lcd.cpp> +<src/lcd/extui/lib/anycubic_chiron>
-ANYCUBIC_LCD_I3MEGA     = src_filter=+<src/lcd/extui/anycubic_i3mega_lcd.cpp> +<src/lcd/extui/lib/anycubic_i3mega>
-NEXTION_TFT             = src_filter=+<src/lcd/extui/nextion_lcd.cpp> +<src/lcd/extui/lib/nextion>
-HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus> +<src/lcd/extui/dgus_lcd.cpp>
-DGUS_LCD_UI_FYSETC      = src_filter=+<src/lcd/extui/lib/dgus/fysetc>
-DGUS_LCD_UI_HIPRECY     = src_filter=+<src/lcd/extui/lib/dgus/hiprecy>
-DGUS_LCD_UI_MKS         = src_filter=+<src/lcd/extui/lib/dgus/mks>
-DGUS_LCD_UI_ORIGIN      = src_filter=+<src/lcd/extui/lib/dgus/origin>
-TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
-EXTUI_EXAMPLE           = src_filter=+<src/lcd/extui/example.cpp>
-MALYAN_LCD              = src_filter=+<src/lcd/extui/malyan_lcd.cpp>
-USE_UHS2_USB            = src_filter=+<src/sd/usb_flashdrive/lib-uhs2>
-USE_UHS3_USB            = src_filter=+<src/sd/usb_flashdrive/lib-uhs3>
-USB_FLASH_DRIVE_SUPPORT = src_filter=+<src/sd/usb_flashdrive/Sd2Card_FlashDrive.cpp>
-AUTO_BED_LEVELING_BILINEAR = src_filter=+<src/feature/bedlevel/abl>
-AUTO_BED_LEVELING_(3POINT|(BI)?LINEAR) = src_filter=+<src/gcode/bedlevel/abl>
-MESH_BED_LEVELING       = src_filter=+<src/feature/bedlevel/mbl> +<src/gcode/bedlevel/mbl>
-AUTO_BED_LEVELING_UBL   = src_filter=+<src/feature/bedlevel/ubl> +<src/gcode/bedlevel/ubl>
-UBL_HILBERT_CURVE       = src_filter=+<src/feature/bedlevel/hilbert_curve.cpp>
-BACKLASH_COMPENSATION   = src_filter=+<src/feature/backlash.cpp>
-BARICUDA                = src_filter=+<src/feature/baricuda.cpp> +<src/gcode/feature/baricuda>
-BINARY_FILE_TRANSFER    = src_filter=+<src/feature/binary_stream.cpp> +<src/libs/heatshrink>
-BLTOUCH                 = src_filter=+<src/feature/bltouch.cpp>
-CANCEL_OBJECTS          = src_filter=+<src/feature/cancel_object.cpp> +<src/gcode/feature/cancel>
-CASE_LIGHT_ENABLE       = src_filter=+<src/feature/caselight.cpp> +<src/gcode/feature/caselight>
-EXTERNAL_CLOSED_LOOP_CONTROLLER = src_filter=+<src/feature/closedloop.cpp> +<src/gcode/calibrate/M12.cpp>
-USE_CONTROLLER_FAN      = src_filter=+<src/feature/controllerfan.cpp>
-HAS_MOTOR_CURRENT_DAC   = src_filter=+<src/feature/dac>
-DIRECT_STEPPING         = src_filter=+<src/feature/direct_stepping.cpp> +<src/gcode/motion/G6.cpp>
-EMERGENCY_PARSER        = src_filter=+<src/feature/e_parser.cpp> -<src/gcode/control/M108_*.cpp>
-I2C_POSITION_ENCODERS   = src_filter=+<src/feature/encoder_i2c.cpp>
-IIC_BL24CXX_EEPROM      = src_filter=+<src/libs/BL24CXX.cpp>
-HAS_SPI_FLASH           = src_filter=+<src/libs/W25Qxx.cpp>
-HAS_ETHERNET            = src_filter=+<src/feature/ethernet.cpp> +<src/gcode/feature/network/M552-M554.cpp>
-HAS_FANMUX              = src_filter=+<src/feature/fanmux.cpp>
-FILAMENT_WIDTH_SENSOR   = src_filter=+<src/feature/filwidth.cpp> +<src/gcode/feature/filwidth>
-FWRETRACT               = src_filter=+<src/feature/fwretract.cpp> +<src/gcode/feature/fwretract>
-HOST_ACTION_COMMANDS    = src_filter=+<src/feature/host_actions.cpp>
-HOTEND_IDLE_TIMEOUT     = src_filter=+<src/feature/hotend_idle.cpp>
-JOYSTICK                = src_filter=+<src/feature/joystick.cpp>
-BLINKM                  = src_filter=+<src/feature/leds/blinkm.cpp>
-HAS_COLOR_LEDS          = src_filter=+<src/feature/leds/leds.cpp> +<src/gcode/feature/leds/M150.cpp>
-PCA9533                 = src_filter=+<src/feature/leds/pca9533.cpp>
-PCA9632                 = src_filter=+<src/feature/leds/pca9632.cpp>
-PRINTER_EVENT_LEDS      = src_filter=+<src/feature/leds/printer_event_leds.cpp>
-TEMP_STAT_LEDS          = src_filter=+<src/feature/leds/tempstat.cpp>
-MAX7219_DEBUG           = src_filter=+<src/feature/max7219.cpp> +<src/gcode/feature/leds/M7219.cpp>
-HAS_MEATPACK            = src_filter=+<src/feature/meatpack.cpp>
-MIXING_EXTRUDER         = src_filter=+<src/feature/mixing.cpp> +<src/gcode/feature/mixing/M163-M165.cpp>
-HAS_PRUSA_MMU1          = src_filter=+<src/feature/mmu/mmu.cpp>
-HAS_PRUSA_MMU2          = src_filter=+<src/feature/mmu/mmu2.cpp> +<src/gcode/feature/prusa_MMU2>
-PASSWORD_FEATURE        = src_filter=+<src/feature/password> +<src/gcode/feature/password>
-ADVANCED_PAUSE_FEATURE  = src_filter=+<src/feature/pause.cpp> +<src/gcode/feature/pause/M600.cpp> +<src/gcode/feature/pause/M603.cpp>
-AUTO_POWER_CONTROL      = src_filter=+<src/feature/power.cpp>
-HAS_POWER_MONITOR       = src_filter=+<src/feature/power_monitor.cpp> +<src/gcode/feature/power_monitor>
-POWER_LOSS_RECOVERY     = src_filter=+<src/feature/powerloss.cpp> +<src/gcode/feature/powerloss>
-PROBE_TEMP_COMPENSATION = src_filter=+<src/feature/probe_temp_comp.cpp> +<src/gcode/calibrate/G76_M192_M871.cpp>
-HAS_FILAMENT_SENSOR     = src_filter=+<src/feature/runout.cpp> +<src/gcode/feature/runout>
-(EXT|MANUAL)_SOLENOID.* = src_filter=+<src/feature/solenoid.cpp> +<src/gcode/control/M380_M381.cpp>
-MK2_MULTIPLEXER         = src_filter=+<src/feature/snmm.cpp>
-HAS_CUTTER              = src_filter=+<src/feature/spindle_laser.cpp> +<src/gcode/control/M3-M5.cpp>
-EXPERIMENTAL_I2CBUS     = src_filter=+<src/feature/twibus.cpp> +<src/gcode/feature/i2c>
-MECHANICAL_GANTRY_CAL.+ = src_filter=+<src/gcode/calibrate/G34.cpp>
-Z_MULTI_ENDSTOPS        = src_filter=+<src/gcode/calibrate/G34_M422.cpp>
-Z_STEPPER_AUTO_ALIGN    = src_filter=+<src/feature/z_stepper_align.cpp> +<src/gcode/calibrate/G34_M422.cpp>
-G26_MESH_VALIDATION     = src_filter=+<src/gcode/bedlevel/G26.cpp>
-ASSISTED_TRAMMING       = src_filter=+<src/feature/tramming.cpp> +<src/gcode/bedlevel/G35.cpp>
-HAS_MESH                = src_filter=+<src/gcode/bedlevel/G42.cpp>
-HAS_LEVELING            = src_filter=+<src/gcode/bedlevel/M420.cpp> +<src/feature/bedlevel/bedlevel.cpp>
-DELTA_AUTO_CALIBRATION  = src_filter=+<src/gcode/calibrate/G33.cpp>
-CALIBRATION_GCODE       = src_filter=+<src/gcode/calibrate/G425.cpp>
-Z_MIN_PROBE_REPEATABILITY_TEST = src_filter=+<src/gcode/calibrate/M48.cpp>
-M100_FREE_MEMORY_WATCHER = src_filter=+<src/gcode/calibrate/M100.cpp>
-BACKLASH_GCODE          = src_filter=+<src/gcode/calibrate/M425.cpp>
-IS_KINEMATIC            = src_filter=+<src/gcode/calibrate/M665.cpp>
-HAS_EXTRA_ENDSTOPS      = src_filter=+<src/gcode/calibrate/M666.cpp>
-SKEW_CORRECTION_GCODE   = src_filter=+<src/gcode/calibrate/M852.cpp>
-DIRECT_PIN_CONTROL      = src_filter=+<src/gcode/control/M42.cpp> +<src/gcode/control/M226.cpp>
-PINS_DEBUGGING          = src_filter=+<src/gcode/config/M43.cpp>
-NO_VOLUMETRICS          = src_filter=-<src/gcode/config/M200-M205.cpp>
-HAS_MULTI_EXTRUDER      = src_filter=+<src/gcode/config/M217.cpp>
-HAS_HOTEND_OFFSET       = src_filter=+<src/gcode/config/M218.cpp>
-EDITABLE_SERVO_ANGLES   = src_filter=+<src/gcode/config/M281.cpp>
-PIDTEMP                 = src_filter=+<src/gcode/config/M301.cpp>
-PREVENT_COLD_EXTRUSION  = src_filter=+<src/gcode/config/M302.cpp>
-PIDTEMPBED              = src_filter=+<src/gcode/config/M304.cpp>
-HAS_USER_THERMISTORS    = src_filter=+<src/gcode/config/M305.cpp>
-SD_ABORT_ON_ENDSTOP_HIT = src_filter=+<src/gcode/config/M540.cpp>
-BAUD_RATE_GCODE         = src_filter=+<src/gcode/config/M575.cpp>
-HAS_SMART_EFF_MOD       = src_filter=+<src/gcode/config/M672.cpp>
-COOLANT_CONTROL         = src_filter=+<src/gcode/control/M7-M9.cpp>
-HAS_SOFTWARE_ENDSTOPS   = src_filter=+<src/gcode/control/M211.cpp>
-HAS_DUPLICATION_MODE    = src_filter=+<src/gcode/control/M605.cpp>
-LIN_ADVANCE             = src_filter=+<src/gcode/feature/advance>
-PHOTO_GCODE             = src_filter=+<src/gcode/feature/camera>
-CONTROLLER_FAN_EDITABLE = src_filter=+<src/gcode/feature/controllerfan>
-GCODE_MACROS            = src_filter=+<src/gcode/feature/macro>
-GRADIENT_MIX            = src_filter=+<src/gcode/feature/mixing/M166.cpp>
-HAS_SAVED_POSITIONS     = src_filter=+<src/gcode/feature/pause/G60.cpp> +<src/gcode/feature/pause/G61.cpp>
-PARK_HEAD_ON_PAUSE      = src_filter=+<src/gcode/feature/pause/M125.cpp>
-FILAMENT_LOAD_UNLOAD_GCODES = src_filter=+<src/gcode/feature/pause/M701_M702.cpp>
-CNC_WORKSPACE_PLANES    = src_filter=+<src/gcode/geometry/G17-G19.cpp>
-CNC_COORDINATE_SYSTEMS  = src_filter=+<src/gcode/geometry/G53-G59.cpp>
-HAS_M206_COMMAND        = src_filter=+<src/gcode/geometry/M206_M428.cpp>
-EXPECTED_PRINTER_CHECK  = src_filter=+<src/gcode/host/M16.cpp>
-HOST_KEEPALIVE_FEATURE  = src_filter=+<src/gcode/host/M113.cpp>
-REPETIER_GCODE_M360     = src_filter=+<src/gcode/host/M360.cpp>
-HAS_GCODE_M876          = src_filter=+<src/gcode/host/M876.cpp>
-HAS_RESUME_CONTINUE     = src_filter=+<src/gcode/lcd/M0_M1.cpp>
-HAS_LCD_CONTRAST        = src_filter=+<src/gcode/lcd/M250.cpp>
-LCD_SET_PROGRESS_MANUALLY = src_filter=+<src/gcode/lcd/M73.cpp>
-TOUCH_SCREEN_CALIBRATION = src_filter=+<src/gcode/lcd/M995.cpp>
-ARC_SUPPORT             = src_filter=+<src/gcode/motion/G2_G3.cpp>
-GCODE_MOTION_MODES      = src_filter=+<src/gcode/motion/G80.cpp>
-BABYSTEPPING            = src_filter=+<src/gcode/motion/M290.cpp> +<src/feature/babystep.cpp>
-Z_PROBE_SLED            = src_filter=+<src/gcode/probe/G31_G32.cpp>
-G38_PROBE_TARGET        = src_filter=+<src/gcode/probe/G38.cpp>
-MAGNETIC_PARKING_EXTRUDER = src_filter=+<src/gcode/probe/M951.cpp>
-SDSUPPORT               = src_filter=+<src/sd/cardreader.cpp> +<src/sd/Sd2Card.cpp> +<src/sd/SdBaseFile.cpp> +<src/sd/SdFatUtil.cpp> +<src/sd/SdFile.cpp> +<src/sd/SdVolume.cpp> +<src/gcode/sd>
-HAS_MEDIA_SUBCALLS      = src_filter=+<src/gcode/sd/M32.cpp>
-GCODE_REPEAT_MARKERS    = src_filter=+<src/feature/repeat.cpp> +<src/gcode/sd/M808.cpp>
-HAS_EXTRUDERS           = src_filter=+<src/gcode/temp/M104_M109.cpp> +<src/gcode/config/M221.cpp>
-HAS_COOLER              = src_filter=+<src/feature/cooler.cpp> +<src/gcode/temp/M143_M193.cpp>
-AUTO_REPORT_TEMPERATURES = src_filter=+<src/gcode/temp/M155.cpp>
-INCH_MODE_SUPPORT       = src_filter=+<src/gcode/units/G20_G21.cpp>
-TEMPERATURE_UNITS_SUPPORT = src_filter=+<src/gcode/units/M149.cpp>
-NEED_HEX_PRINT          = src_filter=+<src/libs/hex_print.cpp>
-NEED_LSF                = src_filter=+<src/libs/least_squares_fit.cpp>
-NOZZLE_PARK_FEATURE     = src_filter=+<src/libs/nozzle.cpp> +<src/gcode/feature/pause/G27.cpp>
-NOZZLE_CLEAN_FEATURE    = src_filter=+<src/libs/nozzle.cpp> +<src/gcode/feature/clean>
-DELTA                   = src_filter=+<src/module/delta.cpp> +<src/gcode/calibrate/M666.cpp>
-BEZIER_CURVE_SUPPORT    = src_filter=+<src/module/planner_bezier.cpp> +<src/gcode/motion/G5.cpp>
-PRINTCOUNTER            = src_filter=+<src/module/printcounter.cpp>
-HAS_BED_PROBE           = src_filter=+<src/module/probe.cpp> +<src/gcode/probe/G30.cpp> +<src/gcode/probe/M401_M402.cpp> +<src/gcode/probe/M851.cpp>
-IS_SCARA                = src_filter=+<src/module/scara.cpp>
-HAS_SERVOS              = src_filter=+<src/module/servo.cpp> +<src/gcode/control/M280.cpp>
-MORGAN_SCARA            = src_filter=+<src/gcode/scara>
-HAS_MICROSTEPS          = src_filter=+<src/gcode/control/M350_M351.cpp>
-(ESP3D_)?WIFISUPPORT    = AsyncTCP, ESP Async WebServer
-  ESP3DLib=https://github.com/luc-github/ESP3DLib/archive/master.zip
-  arduinoWebSockets=links2004/WebSockets@2.3.4
-  luc-github/ESP32SSDP@^1.1.1
-  lib_ignore=ESPAsyncTCP
-
 #
 # Default values apply to all 'env:' prefixed environments
 #
@@ -452,1208 +254,6 @@ monitor_flags =
   --filter
     time
 
-#################################
-#                               #
-#   Unique Core Architectures   #
-#                               #
-#  Add a new "env" below if no  #
-# entry has values suitable to  #
-#   build for a given board.    #
-#                               #
-#################################
-
-#################################
-#                               #
-#       AVR Architecture        #
-#                               #
-#################################
-
-#
-# AVR (8-bit) Common Environment values
-#
-[common_avr8]
-board_build.f_cpu = 16000000L
-src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
-
-#
-# ATmega2560
-#
-[env:mega2560]
-platform = atmelavr
-extends  = common_avr8
-board    = megaatmega2560
-
-#
-# ATmega2560 with extended pins 70-85 defined
-# BOARD_BQ_ZUM_MEGA_3D
-# BOARD_ULTIMAIN_2
-# BOARD_MIGHTYBOARD_REVE
-# BOARD_EINSTART_S
-#
-[env:mega2560ext]
-platform            = atmelavr
-extends             = env:mega2560
-board_build.variant = megaextendedpins
-extra_scripts       = ${common.extra_scripts}
-                      pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
-
-#
-# ATmega1280
-#
-[env:mega1280]
-platform = atmelavr
-extends  = common_avr8
-board    = megaatmega1280
-
-#
-# MightyBoard AVR with extended pins
-#
-[mega_extended_optimized]
-extends             = common_avr8
-board_build.variant = megaextendedpins
-extra_scripts       = ${common.extra_scripts}
-                      pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
-upload_speed        = 57600
-build_flags         = ${common.build_flags} -fno-tree-scev-cprop -fno-split-wide-types -Wl,--relax -mcall-prologues
-
-#
-# MightyBoard ATmega1280
-#
-[env:MightyBoard1280]
-platform = atmelavr
-extends  = mega_extended_optimized
-board    = megaatmega1280
-
-#
-# MightyBoard ATmega2560
-#
-[env:MightyBoard2560]
-platform = atmelavr
-extends  = mega_extended_optimized
-board    = megaatmega2560
-
-#
-# RAMBo
-#
-[env:rambo]
-platform = atmelavr
-extends  = common_avr8
-board    = reprap_rambo
-
-#
-# FYSETC F6 V1.3 / V1.4
-#
-[env:FYSETC_F6]
-platform = atmelavr
-extends  = common_avr8
-board    = fysetc_f6
-
-#
-# Sanguinololu (ATmega644p)
-#
-[env:sanguino644p]
-platform = atmelavr
-extends  = common_avr8
-board    = sanguino_atmega644p
-
-#
-# Sanguinololu (ATmega1284p)
-#
-[env:sanguino1284p]
-platform                  = atmelavr
-extends                   = common_avr8
-board                     = sanguino_atmega1284p
-board_upload.maximum_size = 126976
-
-#
-# Melzi and clones (ATmega1284p)
-#
-[env:melzi]
-platform     = atmelavr
-extends      = env:sanguino1284p
-upload_speed = 57600
-
-#
-# Sanguinololu (ATmega1284p stock bootloader with tuned flags)
-#
-
-[tuned_1284p]
-build_flags = ${common.build_flags} -fno-tree-scev-cprop -fno-split-wide-types -Wl,--relax -mcall-prologues
-
-[env:sanguino1284p_optimized]
-platform    = atmelavr
-extends     = env:melzi
-build_flags = ${tuned_1284p.build_flags}
-
-#
-# Melzi and clones (alias for sanguino1284p_optimized)
-#
-[env:melzi_optimized]
-platform = atmelavr
-extends  = env:sanguino1284p_optimized
-
-#
-# Melzi and clones (Optiboot bootloader)
-#
-[env:melzi_optiboot]
-platform     = atmelavr
-extends      = common_avr8
-board        = sanguino_atmega1284p
-upload_speed = 115200
-
-#
-# Melzi and clones (Zonestar Melzi2 with tuned flags)
-#
-[env:melzi_optiboot_optimized]
-platform    = atmelavr
-extends     = env:melzi_optiboot
-build_flags = ${tuned_1284p.build_flags}
-
-#
-# AT90USB1286 boards using CDC bootloader
-# - BRAINWAVE
-# - BRAINWAVE_PRO
-# - SAV_MKI
-# - TEENSYLU
-#
-[env:at90usb1286_cdc]
-platform   = teensy
-extends    = common_avr8
-board      = at90usb1286
-lib_ignore = ${env:common_avr8.lib_ignore}, Teensy_ADC, NativeEthernet
-
-#
-# AT90USB1286 boards using DFU bootloader
-# - Printrboard
-# - Printrboard Rev.F
-# - ? 5DPRINT ?
-#
-[env:at90usb1286_dfu]
-platform = teensy
-extends  = env:at90usb1286_cdc
-
-#################################
-#                               #
-#       DUE Architecture        #
-#                               #
-#################################
-
-#
-# Due (Atmel SAM3X8E ARM Cortex-M3)
-#
-#  - RAMPS4DUE
-#  - RADDS
-#
-[env:DUE]
-platform   = atmelsam
-board      = due
-src_filter = ${common.default_src_filter} +<src/HAL/DUE> +<src/HAL/shared/backtrace>
-
-[env:DUE_USB]
-platform = atmelsam
-extends  = env:DUE
-board    = dueUSB
-
-#
-# Archim SAM
-#
-[common_DUE_archim]
-platform                 = atmelsam
-extends                  = env:DUE
-board                    = archim
-build_flags              = ${common.build_flags}
-  -DARDUINO_SAM_ARCHIM -DARDUINO_ARCH_SAM -D__SAM3X8E__ -DUSBCON
-board_build.variants_dir = buildroot/share/PlatformIO/variants/
-extra_scripts            = ${common.extra_scripts}
-  Marlin/src/HAL/DUE/upload_extra_script.py
-
-[env:DUE_archim]
-platform = ${common_DUE_archim.platform}
-extends  = common_DUE_archim
-
-#################################
-#                               #
-#      SAMD51 Architecture      #
-#                               #
-#################################
-
-#
-# Adafruit Grand Central M4 (Atmel SAMD51P20A ARM Cortex-M4)
-#
-[env:SAMD51_grandcentral_m4]
-platform       = atmelsam
-board          = adafruit_grandcentral_m4
-build_flags    = ${common.build_flags} -std=gnu++17
-build_unflags  = -std=gnu++11
-src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
-lib_deps       = ${common.lib_deps}
-  SoftwareSerialM
-  Adafruit SPIFlash
-extra_scripts  = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/SAMD51_grandcentral_m4.py
-custom_marlin.SDSUPPORT = SdFat - Adafruit Fork
-debug_tool     = jlink
-
-#################################
-#                               #
-#     LPC176x Architecture      #
-#                               #
-#################################
-
-#
-# NXP LPC176x ARM Cortex-M3
-#
-[common_LPC]
-platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.3.zip
-platform_packages = framework-arduino-lpc176x@^0.2.6
-board             = nxp_lpc1768
-lib_ldf_mode      = off
-lib_compat_mode   = strict
-extra_scripts     = ${common.extra_scripts}
-  Marlin/src/HAL/LPC1768/upload_extra_script.py
-src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768> +<src/HAL/shared/backtrace>
-lib_deps          = ${common.lib_deps}
-  Servo
-custom_marlin.USES_LIQUIDCRYSTAL = arduino-libraries/LiquidCrystal@~1.0.7
-custom_marlin.NEOPIXEL_LED = Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/1.5.0.zip
-build_flags       = ${common.build_flags} -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g
-  # debug options for backtrace
-  #-funwind-tables
-  #-mpoke-function-name
-
-#
-# NXP LPC176x ARM Cortex-M3
-#
-[env:LPC1768]
-platform = ${common_LPC.platform}
-extends  = common_LPC
-board    = nxp_lpc1768
-
-[env:LPC1769]
-platform = ${common_LPC.platform}
-extends  = common_LPC
-board    = nxp_lpc1769
-
-#################################
-#                               #
-#      STM32 Architecture       #
-#                               #
-#################################
-
-#
-# HAL/STM32 Base Environment values
-#
-[common_stm32]
-platform      = ststm32@~12.0
-build_flags   = ${common.build_flags}
-  -std=gnu++14
-  -DUSBCON -DUSBD_USE_CDC
-  -DTIM_IRQ_PRIO=13
-  -DADC_RESOLUTION=12
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32> +<src/HAL/shared/backtrace>
-
-#
-# HAL/STM32F1 Common Environment values
-#
-[common_stm32f1]
-platform          = ststm32@~12.0
-board_build.core  = maple
-build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags}
-  -DARDUINO_ARCH_STM32
-build_unflags     = -std=gnu11 -std=gnu++11
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore        = SPI, FreeRTOS701, FreeRTOS821
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM
-platform_packages = tool-stm32duino
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/fix_framework_weakness.py
-
-#
-# STM32F103RC
-#
-[env:STM32F103RC]
-platform          = ${common_stm32f1.platform}
-extends           = common_stm32f1
-board             = genericSTM32F103RC
-monitor_speed     = 115200
-
-#
-# MEEB_3DP (STM32F103RCT6 with 512K)
-#
-[env:STM32F103RC_meeb]
-platform          = ${common_stm32f1.platform}
-extends           = common_stm32f1
-board             = MEEB_3DP
-build_flags       = ${common_stm32f1.build_flags}
-                    -DDEBUG_LEVEL=0
-                    -DSS_TIMER=4
-                    -DSTM32_FLASH_SIZE=512
-                    -DHSE_VALUE=12000000U
-                    -DUSE_USB_COMPOSITE
-                    -DVECT_TAB_OFFSET=0x2000
-                    -DGENERIC_BOOTLOADER
-extra_scripts     = ${common_stm32f1.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
-  buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP.py
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM
-  USBComposite for STM32F1@0.91
-custom_marlin.NEOPIXEL_LED = Adafruit NeoPixel=https://github.com/ccccmagicboy/Adafruit_NeoPixel#meeb_3dp_use
-debug_tool        = stlink
-upload_protocol   = dfu
-
-#
-# STM32F103RC_fysetc
-#
-[env:STM32F103RC_fysetc]
-platform          = ${common_stm32f1.platform}
-extends           = env:STM32F103RC
-extra_scripts     = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/STM32F103RC_fysetc.py
-build_flags       = ${common_stm32f1.build_flags} -DDEBUG_LEVEL=0
-lib_ldf_mode      = chain
-debug_tool        = stlink
-upload_protocol   = serial
-
-#
-# BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
-#
-#   STM32F103RC_btt ............. RCT6 with 256K
-#   STM32F103RC_btt_USB ......... RCT6 with 256K (USB mass storage)
-#   STM32F103RC_btt_512K ........ RCT6 with 512K
-#   STM32F103RC_btt_512K_USB .... RCT6 with 512K (USB mass storage)
-#
-# WARNING! If you have an SKR Mini v1.1 or an SKR Mini E3 1.0 / 1.2 / 2.0 / DIP
-# and experience a printer freeze, re-flash Marlin using the regular (non-512K)
-# build option. 256K chips may be re-branded 512K chips, but this means the
-# upper 256K is sketchy, and failure is very likely.
-#
-
-[env:STM32F103RC_btt]
-platform          = ${common_stm32f1.platform}
-extends           = env:STM32F103RC
-extra_scripts     = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
-build_flags       = ${common_stm32f1.build_flags}
-  -DDEBUG_LEVEL=0 -DSS_TIMER=4
-monitor_speed     = 115200
-
-[env:STM32F103RC_btt_USB]
-platform          = ${common_stm32f1.platform}
-extends           = env:STM32F103RC_btt
-build_flags       = ${env:STM32F103RC_btt.build_flags} -DUSE_USB_COMPOSITE
-lib_deps          = ${env:STM32F103RC_btt.lib_deps}
-  USBComposite for STM32F1@0.91
-
-[env:STM32F103RC_btt_512K]
-platform          = ${common_stm32f1.platform}
-extends           = env:STM32F103RC_btt
-board_upload.maximum_size=524288
-build_flags       = ${env:STM32F103RC_btt.build_flags} -DSTM32_FLASH_SIZE=512
-
-[env:STM32F103RC_btt_512K_USB]
-platform          = ${common_stm32f1.platform}
-extends           = env:STM32F103RC_btt_512K
-build_flags       = ${env:STM32F103RC_btt_512K.build_flags} -DUSE_USB_COMPOSITE
-lib_deps          = ${env:STM32F103RC_btt_512K.lib_deps}
-  USBComposite for STM32F1@0.91
-
-#
-# STM32F103RE
-#
-[env:STM32F103RE]
-platform          = ${common_stm32f1.platform}
-extends           = common_stm32f1
-board             = genericSTM32F103RE
-monitor_speed     = 115200
-
-#
-#   STM32F103RE_btt ............. RET6
-#   STM32F103RE_btt_USB ......... RET6 (USB mass storage)
-#
-[env:STM32F103RE_btt]
-platform          = ${common_stm32f1.platform}
-extends           = env:STM32F103RE
-extra_scripts     = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
-build_flags       = ${common_stm32f1.build_flags} -DDEBUG_LEVEL=0 -DSS_TIMER=4
-debug_tool        = stlink
-upload_protocol   = stlink
-
-[env:STM32F103RE_btt_USB]
-platform          = ${common_stm32f1.platform}
-extends           = env:STM32F103RE_btt
-build_flags       = ${env:STM32F103RE_btt.build_flags} -DUSE_USB_COMPOSITE
-lib_deps          = ${common_stm32f1.lib_deps}
-  USBComposite for STM32F1@0.91
-
-#
-# REMRAM_V1
-#
-[env:REMRAM_V1]
-platform      = ${common_stm32.platform}
-extends       = common_stm32
-board         = remram_v1
-build_flags   = ${common_stm32.build_flags}
-
-#
-# ST NUCLEO-F767ZI Development Board
-# This environment is for testing purposes prior to control boards
-# being readily available based on STM32F7 MCUs
-#
-[env:NUCLEO_F767ZI]
-platform      = ${common_stm32.platform}
-extends       = common_stm32
-board         = nucleo_f767zi
-build_flags   = ${common_stm32.build_flags} -DTIMER_SERIAL=TIM9
-
-#
-# ARMED (STM32)
-#
-[env:ARMED]
-platform      = ${common_stm32.platform}
-extends       = common_stm32
-board         = armed_v1
-build_flags   = ${common_stm32.build_flags}
-  -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
-
-#
-# Geeetech GTM32 (STM32F103VET6)
-#
-[env:STM32F103VE_GTM32]
-platform          = ${common_stm32f1.platform}
-extends           = common_stm32f1
-board             = genericSTM32F103VE
-build_flags       = ${common_stm32f1.build_flags}
-  -ffunction-sections -fdata-sections -nostdlib -MMD
-  -DMCU_STM32F103VE -DARDUINO_GENERIC_STM32F103V -DARDUINO_ARCH_STM32F1 -DBOARD_generic_stm32f103v
-  -DDEBUG_LEVEL=DEBUG_NONE -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DVECT_TAB_ADDR=0x8000000
-  -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
-upload_protocol   = serial
-
-#
-# Longer 3D board in Alfawise U20 (STM32F103VET6)
-#
-[env:STM32F103VE_longer]
-platform      = ${common_stm32f1.platform}
-extends       = common_stm32f1
-board         = genericSTM32F103VE
-extra_scripts = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
-build_flags   = ${common_stm32f1.build_flags}
-  -DMCU_STM32F103VE -DSTM32F1xx -USERIAL_USB -DU20 -DTS_V12
-build_unflags = ${common_stm32f1.build_unflags}
-  -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
-
-#
-# MKS Robin Mini (STM32F103VET6)
-#
-[env:mks_robin_mini]
-platform      = ${common_stm32f1.platform}
-extends       = common_stm32f1
-board         = genericSTM32F103VE
-extra_scripts = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/mks_robin_mini.py
-build_flags   = ${common_stm32f1.build_flags}
-  -DMCU_STM32F103VE
-
-#
-# MKS Robin Nano (STM32F103VET6)
-#
-[env:mks_robin_nano35]
-platform        = ${common_stm32f1.platform}
-extends         = common_stm32f1
-board           = genericSTM32F103VE
-extra_scripts   = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/mks_robin_nano35.py
-build_flags     = ${common_stm32f1.build_flags}
-  -DMCU_STM32F103VE -DSS_TIMER=4
-debug_tool      = jlink
-upload_protocol = jlink
-
-#
-# MKS Robin (STM32F103ZET6)
-#
-[env:mks_robin]
-platform      = ${common_stm32f1.platform}
-extends       = common_stm32f1
-board         = genericSTM32F103ZE
-extra_scripts = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/mks_robin.py
-build_flags   = ${common_stm32f1.build_flags}
-  -DSS_TIMER=4 -DSTM32_XL_DENSITY
-
-# MKS Robin (STM32F103ZET6)
-# Uses HAL STM32 to support Marlin UI for TFT screen with optional touch panel
-#
-[env:mks_robin_stm32]
-platform             = ${common_stm32.platform}
-extends              = common_stm32
-board                = genericSTM32F103ZE
-board_build.core     = stm32
-board_build.variant  = MARLIN_F103Zx
-board_build.ldscript = ldscript.ld
-board_build.offset   = 0x7000
-board_build.encrypt  = Yes
-board_build.firmware = Robin.bin
-build_flags          = ${common_stm32.build_flags}
-  -DENABLE_HWSERIAL3 -DTIMER_SERIAL=TIM5
-build_unflags        = ${common_stm32.build_unflags}
- -DUSBCON -DUSBD_USE_CDC
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-  buildroot/share/PlatformIO/scripts/mks_encrypt.py
-lib_deps             =
-
-#
-# MKS Robin Pro (STM32F103ZET6)
-#
-[env:mks_robin_pro]
-platform      = ${common_stm32f1.platform}
-extends       = env:mks_robin
-extra_scripts = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/mks_robin_pro.py
-
-#
-# TRIGORILLA PRO (STM32F103ZET6)
-#
-[env:trigorilla_pro]
-platform      = ${common_stm32f1.platform}
-extends       = env:mks_robin
-extra_scripts = ${common_stm32f1.extra_scripts}
-
-#
-# MKS Robin E3D (STM32F103RCT6) and
-# MKS Robin E3 with TMC2209
-#
-[env:mks_robin_e3]
-platform      = ${common_stm32f1.platform}
-extends       = common_stm32f1
-board         = genericSTM32F103RC
-platform_packages = tool-stm32duino
-extra_scripts = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/mks_robin_e3.py
-build_flags   = ${common_stm32f1.build_flags}
-  -DDEBUG_LEVEL=0 -DSS_TIMER=4
-
-#
-# MKS Robin E3p (STM32F103VET6)
-#  - LVGL UI
-#
-[env:mks_robin_e3p]
-platform        = ${common_stm32f1.platform}
-extends         = common_stm32f1
-board           = genericSTM32F103VE
-extra_scripts   = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/mks_robin_e3p.py
-build_flags     = ${common_stm32f1.build_flags}
-  -DMCU_STM32F103VE -DSS_TIMER=4
-debug_tool      = jlink
-upload_protocol = jlink
-
-#
-# MKS Robin Lite/Lite2 (STM32F103RCT6)
-#
-[env:mks_robin_lite]
-platform      = ${common_stm32f1.platform}
-extends       = common_stm32f1
-board         = genericSTM32F103RC
-extra_scripts = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/mks_robin_lite.py
-
-#
-# MKS ROBIN LITE3 (STM32F103RCT6)
-#
-[env:mks_robin_lite3]
-platform      = ${common_stm32f1.platform}
-extends       = common_stm32f1
-board         = genericSTM32F103RC
-extra_scripts = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/mks_robin_lite3.py
-
-#
-# JGAurora A5S A1 (STM32F103ZET6)
-#
-[env:jgaurora_a5s_a1]
-platform      = ${common_stm32f1.platform}
-extends       = common_stm32f1
-board         = genericSTM32F103ZE
-extra_scripts = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
-build_flags   = ${common_stm32f1.build_flags}
-  -DSTM32F1xx -DSTM32_XL_DENSITY
-
-#
-# Malyan M200 (STM32F103CB)
-#
-[env:STM32F103CB_malyan]
-platform      = ${common_stm32f1.platform}
-extends       = common_stm32f1
-board         = malyanM200
-build_flags   = ${common_stm32f1.build_flags}
-  -DMCU_STM32F103CB -D__STM32F1__=1 -std=c++1y -DSERIAL_USB -ffunction-sections -fdata-sections
-  -Wl,--gc-sections -DDEBUG_LEVEL=0 -D__MARLIN_FIRMWARE__
-lib_ignore    = ${common_stm32f1.lib_ignore}
-  SoftwareSerialM
-
-#
-# Malyan M200 v2 (STM32F070RB)
-#
-[env:STM32F070RB_malyan]
-platform    = ${common_stm32.platform}
-extends     = common_stm32
-board       = malyanM200v2
-build_flags = ${common_stm32.build_flags} -DHAL_PCD_MODULE_ENABLED
-  -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
-  -DCUSTOM_STARTUP_FILE
-
-#
-# Malyan M200 v2 (STM32F070CB)
-#
-[env:STM32F070CB_malyan]
-platform    = ${common_stm32.platform}
-extends     = common_stm32
-board       = malyanm200_f070cb
-build_flags = ${common_stm32.build_flags}
-  -DHAL_PCD_MODULE_ENABLED -DDISABLE_GENERIC_SERIALUSB -DHAL_UART_MODULE_ENABLED -DCUSTOM_STARTUP_FILE
-
-#
-# Malyan M300 (STM32F070CB)
-#
-[env:malyan_M300]
-platform    = ${common_stm32.platform}
-extends     = common_stm32
-board       = malyanm300_f070cb
-build_flags = ${common_stm32.build_flags}
-  -DHAL_PCD_MODULE_ENABLED -DDISABLE_GENERIC_SERIALUSB -DHAL_UART_MODULE_ENABLED
-src_filter  = ${common.default_src_filter} +<src/HAL/STM32>
-
-#
-# Chitu boards like Tronxy X5s (STM32F103ZET6)
-#
-[env:chitu_f103]
-platform      = ${common_stm32f1.platform}
-extends       = common_stm32f1
-board         = CHITU_F103
-extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
-  pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
-  buildroot/share/PlatformIO/scripts/chitu_crypt.py
-build_flags   = ${common_stm32f1.build_flags}
-  -DSTM32F1xx -DSTM32_XL_DENSITY
-build_unflags = ${common_stm32f1.build_unflags}
-  -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG= -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
-
-#
-# Some Chitu V5 boards have a problem with GPIO init.
-# Use this target if G28 or G29 are always failing.
-#
-[env:chitu_v5_gpio_init]
-platform      = ${common_stm32f1.platform}
-extends       = env:chitu_f103
-build_flags   = ${env:chitu_f103.build_flags} -DCHITU_V5_Z_MIN_BUGFIX
-
-#
-# Creality (STM32F103RET6)
-#
-[env:STM32F103RET6_creality]
-platform        = ${env:STM32F103RE.platform}
-extends         = env:STM32F103RE
-build_flags     = ${env:STM32F103RE.build_flags} -DTEMP_TIMER_CHAN=4
-extra_scripts   = ${env:STM32F103RE.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/random-bin.py
-  buildroot/share/PlatformIO/scripts/STM32F103RET6_creality.py
-debug_tool      = jlink
-upload_protocol = jlink
-
-#
-# FLSUN QQS Pro (STM32F103VET6) using hal STM32
-# board Hispeedv1
-#
-[env:flsun_hispeedv1]
-platform             = ${common_stm32.platform}
-extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} -DMCU_STM32F103VE -DSS_TIMER=4 -DENABLE_HWSERIAL3
-board                = genericSTM32F103VE
-board_build.core     = stm32
-board_build.variant  = MARLIN_F103Vx
-board_build.ldscript = ldscript.ld
-board_build.offset   = 0x7000
-board_build.firmware = Robin_mini.bin
-board_build.encrypt  = Yes
-board_upload.offset_address = 0x08007000
-build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-  buildroot/share/PlatformIO/scripts/mks_encrypt.py
-
-#
-# STM32F401VE
-# 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
-#
-[env:STM32F401VE_STEVAL]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = STEVAL_STM32F401VE
-build_flags       = ${common_stm32.build_flags}
-  -DARDUINO_STEVAL -DSTM32F401xE
-  -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/STM32F401VE_STEVAL.py
-
-#
-# STM32F401RC
-#
-[env:FYSETC_CHEETAH_V20]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = FYSETC_CHEETAH_V20
-build_flags       = ${common_stm32.build_flags} -DSTM32F401xC -DVECT_TAB_OFFSET=0xC000
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/FYSETC_CHEETAH_V20.py
-
-#
-# FLYF407ZG
-#
-[env:FLYF407ZG]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = FLYF407ZG
-build_flags       = ${common_stm32.build_flags}
-  -DVECT_TAB_OFFSET=0x8000
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-
-#
-# FLY MINI(stm32f103rct6)
-#
-[env:FLY_MINI]
-platform          = ${common_stm32f1.platform}
-extends           = common_stm32f1
-board             = genericSTM32F103RC
-extra_scripts     = ${common_stm32f1.extra_scripts}
- buildroot/share/PlatformIO/scripts/fly_mini.py
-build_flags       = ${common_stm32f1.build_flags}
- -DDEBUG_LEVEL=0 -DSS_TIMER=4
-
-#
-# FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
-#
-[env:FYSETC_S6]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-platform_packages = tool-stm32duino
-board             = marlin_fysetc_s6
-build_flags       = ${common_stm32.build_flags}
-  -DVECT_TAB_OFFSET=0x10000
-  -DHAL_PCD_MODULE_ENABLED
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-debug_tool        = stlink
-upload_protocol   = dfu
-upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
-
-#
-# STM32F407VET6 with RAMPS-like shield
-# 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
-# Shield - https://github.com/jmz52/Hardware
-#
-[env:STM32F407VE_black]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = blackSTM32F407VET6
-build_flags       = ${common_stm32.build_flags}
-  -DARDUINO_BLACK_F407VE
-  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-
-#
-# Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
-# For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
-# Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
-#
-[env:Anet_ET4_OpenBLT]
-platform             = ${common_stm32.platform}
-extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
-board                = genericSTM32F407VGT6
-board_build.core     = stm32
-board_build.variant  = MARLIN_F4x7Vx
-board_build.ldscript = ldscript.ld
-board_build.firmware = firmware.srec
-# Just openblt.py (not stm32_bootloader.py) generates the file
-board_build.encrypt  = Yes
-board_build.offset   = 0x10000
-board_upload.offset_address = 0x08010000
-build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
-debug_tool           = jlink
-upload_protocol      = jlink
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-  buildroot/share/PlatformIO/scripts/openblt.py
-
-#
-# BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
-#
-[env:BIGTREE_SKR_PRO]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = BigTree_SKR_Pro
-build_flags       = ${common_stm32.build_flags}
-  -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-#upload_protocol   = stlink
-#upload_command    = "$PROJECT_PACKAGES_DIR/tool-stm32duino/stlink/ST-LINK_CLI.exe" -c SWD -P "$BUILD_DIR/firmware.bin" 0x8008000 -Rst -Run
-debug_tool        = stlink
-debug_init_break  =
-
-#
-# USB Flash Drive mix-ins for STM32
-#
-[stm32_flash_drive]
-platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc.zip
-build_flags       = ${common_stm32.build_flags}
-  -DHAL_PCD_MODULE_ENABLED -DHAL_HCD_MODULE_ENABLED
-  -DUSBHOST -DUSBH_IRQ_PRIO=3 -DUSBH_IRQ_SUBPRIO=4
-
-#
-# BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4) with USB Flash Drive Support
-#
-[env:BIGTREE_SKR_PRO_usb_flash_drive]
-extends           = env:BIGTREE_SKR_PRO
-platform_packages = ${stm32_flash_drive.platform_packages}
-build_unflags     = -DUSBCON -DUSBD_USE_CDC
-build_flags       = ${stm32_flash_drive.build_flags}
-  -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
-
-#
-# Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
-#
-[env:BIGTREE_GTR_V1_0]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = BigTree_GTR_v1
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-build_flags       = ${common_stm32.build_flags}
-  -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
-
-#
-# Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4) with USB Flash Drive Support
-#
-[env:BIGTREE_GTR_V1_0_usb_flash_drive]
-extends           = env:BIGTREE_GTR_V1_0
-platform_packages = ${stm32_flash_drive.platform_packages}
-build_unflags     = -DUSBCON -DUSBD_USE_CDC
-build_flags       = ${stm32_flash_drive.build_flags}
-  -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
-
-#
-# BigTreeTech BTT002 V1.0 (STM32F407VGT6 ARM Cortex-M4)
-#
-[env:BIGTREE_BTT002]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = BigTree_Btt002
-build_flags       = ${common_stm32.build_flags}
-  -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
-  -DHAVE_HWSERIAL2
-  -DHAVE_HWSERIAL3
-  -DPIN_SERIAL2_RX=PD_6
-  -DPIN_SERIAL2_TX=PD_5
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-
-#
-# Lerdge base
-#
-[lerdge_common]
-platform            = ${common_stm32.platform}
-extends             = common_stm32
-board               = LERDGE
-board_build.offset  = 0x10000
-board_build.encrypt = Yes
-extra_scripts       = ${common.extra_scripts}
-                      pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
-                      buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-                      buildroot/share/PlatformIO/scripts/lerdge.py
-build_flags         = ${common_stm32.build_flags}
-  -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
-  -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
-  -DHAL_SRAM_MODULE_ENABLED
-build_unflags       = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
-
-#
-# Lerdge X
-#
-[env:LERDGEX]
-platform             = ${lerdge_common.platform}
-extends              = lerdge_common
-board_build.firmware = Lerdge_X_firmware_force.bin
-
-#
-# Lerdge X with USB Flash Drive Support
-#
-[env:LERDGEX_usb_flash_drive]
-platform          = ${env:LERDGEX.platform}
-extends           = env:LERDGEX
-platform_packages = ${stm32_flash_drive.platform_packages}
-build_flags       = ${stm32_flash_drive.build_flags}
-
-#
-# Lerdge S
-#
-[env:LERDGES]
-platform             = ${lerdge_common.platform}
-extends              = lerdge_common
-board_build.firmware = Lerdge_firmware_force.bin
-
-#
-# Lerdge S with USB Flash Drive Support
-#
-[env:LERDGES_usb_flash_drive]
-platform          = ${env:LERDGES.platform}
-extends           = env:LERDGES
-platform_packages = ${stm32_flash_drive.platform_packages}
-build_flags       = ${stm32_flash_drive.build_flags}
-
-#
-# Lerdge K
-#
-[env:LERDGEK]
-platform             = ${lerdge_common.platform}
-extends              = lerdge_common
-board_build.firmware = Lerdge_K_firmware_force.bin
-build_flags          = ${lerdge_common.build_flags}
-  -DLERDGEK
-
-#
-# Lerdge K with USB Flash Drive Support
-#
-[env:LERDGEK_usb_flash_drive]
-platform          = ${env:LERDGEK.platform}
-extends           = env:LERDGEK
-platform_packages = ${stm32_flash_drive.platform_packages}
-build_flags       = ${stm32_flash_drive.build_flags}
-
-#
-# RUMBA32
-#
-[env:rumba32]
-platform        = ${common_stm32.platform}
-extends         = common_stm32
-build_flags     = ${common_stm32.build_flags}
-  -Os
-  -DHAL_PCD_MODULE_ENABLED
-  -DDISABLE_GENERIC_SERIALUSB
-  -DHAL_UART_MODULE_ENABLED
-  -DTIMER_SERIAL=TIM9
-board           = rumba32_f446ve
-upload_protocol = dfu
-monitor_speed   = 500000
-
-#
-# MKS Robin Nano V1.2 and V2 using hal STM32
-#
-[env:mks_robin_nano35_stm32]
-platform             = ${common_stm32.platform}
-extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} -DMCU_STM32F103VE -DSS_TIMER=4 -DENABLE_HWSERIAL3
-board                = genericSTM32F103VE
-board_build.core     = stm32
-board_build.variant  = MARLIN_F103Vx
-board_build.ldscript = ldscript.ld
-board_build.offset   = 0x7000
-board_build.encrypt  = Yes
-board_build.firmware = Robin_nano35.bin
-board_upload.offset_address = 0x08007000
-build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
-debug_tool           = jlink
-upload_protocol      = jlink
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-  buildroot/share/PlatformIO/scripts/mks_encrypt.py
-
-#
-# MKS Robin Pro V2
-#
-[env:mks_robin_pro2]
-platform             = ${common_stm32.platform}
-platform_packages    = ${stm32_flash_drive.platform_packages}
-extends              = common_stm32
-build_flags          = ${stm32_flash_drive.build_flags}
-board                = genericSTM32F407VET6
-board_build.core     = stm32
-board_build.variant  = MARLIN_F4x7Vx
-board_build.ldscript = ldscript.ld
-board_build.firmware = firmware.bin
-board_build.offset   = 0x0000
-board_upload.offset_address = 0x08000000
-build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
-debug_tool           = jlink
-upload_protocol      = jlink
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-
-#
-# This SPI is used by Robin Nano V3
-#
-[stm32f4_I2C1]
-build_flags = -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
-
-#
-# MKS Robin Nano V3
-#
-[env:mks_robin_nano_v3]
-platform             = ${common_stm32.platform}
-extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} ${stm32f4_I2C1.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC
-board                = genericSTM32F407VGT6
-board_build.core     = stm32
-board_build.variant  = MARLIN_F4x7Vx
-board_build.ldscript = ldscript.ld
-board_build.firmware = Robin_nano_v3.bin
-board_build.offset   = 0xC000
-board_upload.offset_address = 0x0800C000
-build_unflags        = ${common_stm32.build_unflags}
-debug_tool           = jlink
-upload_protocol      = jlink
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-
-#
-# MKS Robin Nano V3 with USB Flash Drive Support
-# Currently, using a STM32duino fork, until USB Host get merged
-#
-[env:mks_robin_nano_v3_usb_flash_drive]
-extends           = env:mks_robin_nano_v3
-platform_packages = ${stm32_flash_drive.platform_packages}
-build_flags       = ${stm32_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
-  -DUSBCON
-  -DUSE_USBHOST_HS
-  -DUSBD_IRQ_PRIO=5
-  -DUSBD_IRQ_SUBPRIO=6
-  -DUSE_USB_HS_IN_FS
-  -DUSBD_USE_CDC
-
-#
-# MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
-# Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
-#
-[env:mks_robin_nano_v3_usb_flash_drive_msc]
-platform          = ${common_stm32.platform}
-extends           = env:mks_robin_nano_v3
-platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc.zip
-build_unflags     = ${common_stm32.build_unflags} -DUSBD_USE_CDC
-build_flags       = ${stm32_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
-  -DUSBCON
-  -DUSE_USBHOST_HS
-  -DUSBD_IRQ_PRIO=5
-  -DUSBD_IRQ_SUBPRIO=6
-  -DUSE_USB_HS_IN_FS
-  -DUSBD_USE_CDC_MSC
-
-#
-# Mingda MPX_ARM_MINI
-#
-
-[env:mingda_mpx_arm_mini]
-platform             = ${common_stm32.platform}
-extends              = common_stm32
-board                = genericSTM32F103ZE
-board_build.core     = stm32
-board_build.variant  = MARLIN_F103Zx
-board_build.ldscript = ldscript.ld
-board_build.offset   = 0x10000
-build_flags          = ${common_stm32.build_flags} -DENABLE_HWSERIAL3 -DTIMER_SERIAL=TIM5
-build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-
-#################################
-#                               #
-#      Other Architectures      #
-#                               #
-#################################
-
-#
-# Espressif ESP32
-#
-[env:esp32]
-platform      = espressif32@2.1.0
-board         = esp32dev
-build_flags   = ${common.build_flags} -DCORE_DEBUG_LEVEL=0
-src_filter    = ${common.default_src_filter} +<src/HAL/ESP32>
-lib_ignore    = NativeEthernet
-upload_speed  = 500000
-monitor_speed = 250000
-#upload_port   = marlinesp.local
-#board_build.flash_mode = qio
-
-[env:FYSETC_E4]
-platform               = espressif32@1.11.2
-extends                = env:esp32
-board_build.partitions = default_16MB.csv
-
-#
-# Teensy 3.1 / 3.2 (ARM Cortex-M4)
-#
-[env:teensy31]
-platform      = teensy
-board         = teensy31
-src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY31_32>
-lib_ignore    = NativeEthernet
-
-#
-# Teensy 3.5 / 3.6 (ARM Cortex-M4)
-#
-[env:teensy35]
-platform      = teensy
-board         = teensy35
-src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY35_36>
-lib_ignore    = NativeEthernet
-
-[env:teensy36]
-platform      = teensy
-board         = teensy36
-src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY35_36>
-lib_ignore    = NativeEthernet
-
-#
-# Teensy 4.0 / 4.1 (ARM Cortex-M7)
-#
-[env:teensy41]
-platform      = teensy
-board         = teensy41
-src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY40_41>
-
-#
-# Native
-# No supported Arduino libraries, base Marlin only
-#
-[env:linux_native]
-platform        = native
-framework       =
-build_flags     = -D__PLAT_LINUX__ -std=gnu++17 -ggdb -g -lrt -lpthread -D__MARLIN_FIRMWARE__ -Wno-expansion-to-defined
-src_build_flags = -Wall -IMarlin/src/HAL/LINUX/include
-build_unflags   = -Wall
-lib_ldf_mode    = off
-lib_deps        =
-src_filter      = ${common.default_src_filter} +<src/HAL/LINUX>
-
 #
 # Just print the dependency tree
 #

commit ccdbffbf3f599f0860c643647ce6c40f1eb5a4cd
Author: Mike La Spina <mike.laspina@shaw.ca>
Date:   Mon Mar 29 01:41:56 2021 -0500

    Laser Coolant Flow Meter / Safety Shutdown (#21431)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 82c11c2b6d..26b27bbf99 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -82,6 +82,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/caselight.cpp> -<src/gcode/feature/caselight>
   -<src/feature/closedloop.cpp>
   -<src/feature/controllerfan.cpp> -<src/gcode/feature/controllerfan>
+  -<src/feature/cooler.cpp>  -<src/gcode/temp/M143_M193.cpp>
   -<src/feature/dac> -<src/feature/digipot>
   -<src/feature/direct_stepping.cpp> -<src/gcode/motion/G6.cpp>
   -<src/feature/e_parser.cpp>
@@ -198,7 +199,6 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/sd/M32.cpp>
   -<src/gcode/sd/M808.cpp>
   -<src/gcode/temp/M104_M109.cpp>
-  -<src/gcode/temp/M143_M193.cpp>
   -<src/gcode/temp/M155.cpp>
   -<src/gcode/units/G20_G21.cpp>
   -<src/gcode/units/M149.cpp>
@@ -411,7 +411,7 @@ SDSUPPORT               = src_filter=+<src/sd/cardreader.cpp> +<src/sd/Sd2Card.c
 HAS_MEDIA_SUBCALLS      = src_filter=+<src/gcode/sd/M32.cpp>
 GCODE_REPEAT_MARKERS    = src_filter=+<src/feature/repeat.cpp> +<src/gcode/sd/M808.cpp>
 HAS_EXTRUDERS           = src_filter=+<src/gcode/temp/M104_M109.cpp> +<src/gcode/config/M221.cpp>
-HAS_COOLER              = src_filter=-<src/gcode/temp/M143_M193.cpp>
+HAS_COOLER              = src_filter=+<src/feature/cooler.cpp> +<src/gcode/temp/M143_M193.cpp>
 AUTO_REPORT_TEMPERATURES = src_filter=+<src/gcode/temp/M155.cpp>
 INCH_MODE_SUPPORT       = src_filter=+<src/gcode/units/G20_G21.cpp>
 TEMPERATURE_UNITS_SUPPORT = src_filter=+<src/gcode/units/M149.cpp>

commit c45b91aa94c7008e3fd8ea297df57948af9158a3
Author: Marcio T <mlt4356-github@yahoo.com>
Date:   Sat Mar 27 21:57:12 2021 -0600

    Refactor Hilbert curve. Enhance Touch UI Bed Level Screen. (#21453)

diff --git a/platformio.ini b/platformio.ini
index 941426d732..82c11c2b6d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -75,6 +75,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/bedlevel/abl> -<src/gcode/bedlevel/abl>
   -<src/feature/bedlevel/mbl> -<src/gcode/bedlevel/mbl>
   -<src/feature/bedlevel/ubl> -<src/gcode/bedlevel/ubl>
+  -<src/feature/bedlevel/hilbert_curve.cpp>
   -<src/feature/binary_stream.cpp> -<src/libs/heatshrink>
   -<src/feature/bltouch.cpp>
   -<src/feature/cancel_object.cpp> -<src/gcode/feature/cancel>
@@ -306,6 +307,7 @@ AUTO_BED_LEVELING_BILINEAR = src_filter=+<src/feature/bedlevel/abl>
 AUTO_BED_LEVELING_(3POINT|(BI)?LINEAR) = src_filter=+<src/gcode/bedlevel/abl>
 MESH_BED_LEVELING       = src_filter=+<src/feature/bedlevel/mbl> +<src/gcode/bedlevel/mbl>
 AUTO_BED_LEVELING_UBL   = src_filter=+<src/feature/bedlevel/ubl> +<src/gcode/bedlevel/ubl>
+UBL_HILBERT_CURVE       = src_filter=+<src/feature/bedlevel/hilbert_curve.cpp>
 BACKLASH_COMPENSATION   = src_filter=+<src/feature/backlash.cpp>
 BARICUDA                = src_filter=+<src/feature/baricuda.cpp> +<src/gcode/feature/baricuda>
 BINARY_FILE_TRANSFER    = src_filter=+<src/feature/binary_stream.cpp> +<src/libs/heatshrink>

commit b51aed8aa54f41cc5897485d3b34b019ce38343d
Author: Skorpi08 <skorpik08@gmail.com>
Date:   Fri Mar 19 02:51:19 2021 +0100

    Nextion TFT touch screen (#21324)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 11dcecfc99..941426d732 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -59,6 +59,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/extui/lib/ftdi_eve_touch_ui>
   -<src/lcd/extui/anycubic_chiron_lcd.cpp> -<src/lcd/extui/lib/anycubic_chiron>
   -<src/lcd/extui/anycubic_i3mega_lcd.cpp> -<src/lcd/extui/lib/anycubic_i3mega>
+  -<src/lcd/extui/nextion_lcd.cpp> -<src/lcd/extui/lib/nextion>
   -<src/lcd/lcdprint.cpp>
   -<src/lcd/touch/touch_buttons.cpp>
   -<src/sd/usb_flashdrive/lib-uhs2> -<src/sd/usb_flashdrive/lib-uhs3>
@@ -289,6 +290,7 @@ HAS_MENU_TRAMMING       = src_filter=+<src/lcd/menu/menu_tramming.cpp>
 HAS_MENU_UBL            = src_filter=+<src/lcd/menu/menu_ubl.cpp>
 ANYCUBIC_LCD_CHIRON     = src_filter=+<src/lcd/extui/anycubic_chiron_lcd.cpp> +<src/lcd/extui/lib/anycubic_chiron>
 ANYCUBIC_LCD_I3MEGA     = src_filter=+<src/lcd/extui/anycubic_i3mega_lcd.cpp> +<src/lcd/extui/lib/anycubic_i3mega>
+NEXTION_TFT             = src_filter=+<src/lcd/extui/nextion_lcd.cpp> +<src/lcd/extui/lib/nextion>
 HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus> +<src/lcd/extui/dgus_lcd.cpp>
 DGUS_LCD_UI_FYSETC      = src_filter=+<src/lcd/extui/lib/dgus/fysetc>
 DGUS_LCD_UI_HIPRECY     = src_filter=+<src/lcd/extui/lib/dgus/hiprecy>

commit 4d6ebf95fced1393d13f1cf4b43fe789754e3141
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Wed Mar 10 12:57:54 2021 -0800

    Fix LERDGE 'extends' env references (#21305)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 3b1604a296..11dcecfc99 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1401,7 +1401,7 @@ board_build.firmware = Lerdge_X_firmware_force.bin
 #
 [env:LERDGEX_usb_flash_drive]
 platform          = ${env:LERDGEX.platform}
-extends           = LERDGEX
+extends           = env:LERDGEX
 platform_packages = ${stm32_flash_drive.platform_packages}
 build_flags       = ${stm32_flash_drive.build_flags}
 
@@ -1418,7 +1418,7 @@ board_build.firmware = Lerdge_firmware_force.bin
 #
 [env:LERDGES_usb_flash_drive]
 platform          = ${env:LERDGES.platform}
-extends           = LERDGES
+extends           = env:LERDGES
 platform_packages = ${stm32_flash_drive.platform_packages}
 build_flags       = ${stm32_flash_drive.build_flags}
 
@@ -1437,7 +1437,7 @@ build_flags          = ${lerdge_common.build_flags}
 #
 [env:LERDGEK_usb_flash_drive]
 platform          = ${env:LERDGEK.platform}
-extends           = LERDGEK
+extends           = env:LERDGEK
 platform_packages = ${stm32_flash_drive.platform_packages}
 build_flags       = ${stm32_flash_drive.build_flags}
 

commit f147a8990a68503cd5eb2bb0fc7b26b7c00efe91
Author: X-Ryl669 <boite.pour.spam@gmail.com>
Date:   Wed Mar 10 21:22:20 2021 +0100

    Fix MeatPack with per-serial-port instances (#21306)

diff --git a/platformio.ini b/platformio.ini
index b8235c84fd..3b1604a296 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -332,7 +332,7 @@ PCA9632                 = src_filter=+<src/feature/leds/pca9632.cpp>
 PRINTER_EVENT_LEDS      = src_filter=+<src/feature/leds/printer_event_leds.cpp>
 TEMP_STAT_LEDS          = src_filter=+<src/feature/leds/tempstat.cpp>
 MAX7219_DEBUG           = src_filter=+<src/feature/max7219.cpp> +<src/gcode/feature/leds/M7219.cpp>
-MEATPACK                = src_filter=+<src/feature/meatpack.cpp>
+HAS_MEATPACK            = src_filter=+<src/feature/meatpack.cpp>
 MIXING_EXTRUDER         = src_filter=+<src/feature/mixing.cpp> +<src/gcode/feature/mixing/M163-M165.cpp>
 HAS_PRUSA_MMU1          = src_filter=+<src/feature/mmu/mmu.cpp>
 HAS_PRUSA_MMU2          = src_filter=+<src/feature/mmu/mmu2.cpp> +<src/gcode/feature/prusa_MMU2>

commit 1b9ff68f8ce59a2b142bbabd0fad3d3b377b5997
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Mon Mar 8 04:11:37 2021 -0300

    Fix Host Keepalive serial target (#21283)
    
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/platformio.ini b/platformio.ini
index d26b2a37ea..b8235c84fd 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -424,9 +424,9 @@ HAS_SERVOS              = src_filter=+<src/module/servo.cpp> +<src/gcode/control
 MORGAN_SCARA            = src_filter=+<src/gcode/scara>
 HAS_MICROSTEPS          = src_filter=+<src/gcode/control/M350_M351.cpp>
 (ESP3D_)?WIFISUPPORT    = AsyncTCP, ESP Async WebServer
-  ESP3DLib=https://github.com/luc-github/ESP3DLib.git
-  arduinoWebSockets=https://github.com/Links2004/arduinoWebSockets.git
-  ESP32SSDP=https://github.com/luc-github/ESP32SSDP.git
+  ESP3DLib=https://github.com/luc-github/ESP3DLib/archive/master.zip
+  arduinoWebSockets=links2004/WebSockets@2.3.4
+  luc-github/ESP32SSDP@^1.1.1
   lib_ignore=ESPAsyncTCP
 
 #

commit b95e548ddbcbc1c088eabc17992d0a06f82ac167
Author: Mike La Spina <mike.laspina@shaw.ca>
Date:   Sat Mar 6 14:13:28 2021 -0600

    Cooler (for Laser) - M143, M193 (#21255)

diff --git a/platformio.ini b/platformio.ini
index aad59362cc..d26b2a37ea 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -196,6 +196,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/sd/M32.cpp>
   -<src/gcode/sd/M808.cpp>
   -<src/gcode/temp/M104_M109.cpp>
+  -<src/gcode/temp/M143_M193.cpp>
   -<src/gcode/temp/M155.cpp>
   -<src/gcode/units/G20_G21.cpp>
   -<src/gcode/units/M149.cpp>
@@ -406,6 +407,7 @@ SDSUPPORT               = src_filter=+<src/sd/cardreader.cpp> +<src/sd/Sd2Card.c
 HAS_MEDIA_SUBCALLS      = src_filter=+<src/gcode/sd/M32.cpp>
 GCODE_REPEAT_MARKERS    = src_filter=+<src/feature/repeat.cpp> +<src/gcode/sd/M808.cpp>
 HAS_EXTRUDERS           = src_filter=+<src/gcode/temp/M104_M109.cpp> +<src/gcode/config/M221.cpp>
+HAS_COOLER              = src_filter=-<src/gcode/temp/M143_M193.cpp>
 AUTO_REPORT_TEMPERATURES = src_filter=+<src/gcode/temp/M155.cpp>
 INCH_MODE_SUPPORT       = src_filter=+<src/gcode/units/G20_G21.cpp>
 TEMPERATURE_UNITS_SUPPORT = src_filter=+<src/gcode/units/M149.cpp>

commit 2c5967925f5a09db2522d1611efd225dbd3990dd
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Sat Mar 6 01:50:26 2021 -0800

    Pins/tests followup (#21268)
    
    Missing commit from #21254
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/platformio.ini b/platformio.ini
index 0ed883ba0d..aad59362cc 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -215,6 +215,7 @@ extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
   pre:buildroot/share/PlatformIO/scripts/preflight-checks.py
+  post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
 build_flags        = -fmax-errors=5 -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants
 lib_deps           =
 
@@ -727,12 +728,6 @@ platform = ${common_LPC.platform}
 extends  = common_LPC
 board    = nxp_lpc1769
 
-# BTT SKR 1.4 needs a UART3 tweak
-[env:LPC1768_btt_skr_v1_4]
-platform    = ${env:LPC1768.platform}
-extends     = env:LPC1768
-build_flags = ${env:LPC1768.build_flags} -DLPC_PINCFG_UART3_P4_28
-
 #################################
 #                               #
 #      STM32 Architecture       #

commit 3eb8e26174efd20797addced921069050d1a344f
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Fri Mar 5 23:53:44 2021 -0800

    Tweak/Consolidate followup (#21261)

diff --git a/platformio.ini b/platformio.ini
index 74452754ad..0ed883ba0d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -729,7 +729,7 @@ board    = nxp_lpc1769
 
 # BTT SKR 1.4 needs a UART3 tweak
 [env:LPC1768_btt_skr_v1_4]
-platform    = ${LPC1768.platform}
+platform    = ${env:LPC1768.platform}
 extends     = env:LPC1768
 build_flags = ${env:LPC1768.build_flags} -DLPC_PINCFG_UART3_P4_28
 

commit 3ea56ba4c72fb1e9c4bb4a896b8cf87361a48f4b
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Mar 5 04:30:52 2021 -0600

    Tweak tests, consolidate pins target validation (#21254)

diff --git a/platformio.ini b/platformio.ini
index aad59362cc..74452754ad 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -215,7 +215,6 @@ extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
   pre:buildroot/share/PlatformIO/scripts/preflight-checks.py
-  post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
 build_flags        = -fmax-errors=5 -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants
 lib_deps           =
 
@@ -728,6 +727,12 @@ platform = ${common_LPC.platform}
 extends  = common_LPC
 board    = nxp_lpc1769
 
+# BTT SKR 1.4 needs a UART3 tweak
+[env:LPC1768_btt_skr_v1_4]
+platform    = ${LPC1768.platform}
+extends     = env:LPC1768
+build_flags = ${env:LPC1768.build_flags} -DLPC_PINCFG_UART3_P4_28
+
 #################################
 #                               #
 #      STM32 Architecture       #

commit dad486c01b34d78ab3a62b8815a3f9f48406d775
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Mar 4 03:21:15 2021 -0600

    MK2_MULTIPLEXER dependency

diff --git a/platformio.ini b/platformio.ini
index 157b3d6201..aad59362cc 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -111,6 +111,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/probe_temp_comp.cpp>
   -<src/feature/repeat.cpp>
   -<src/feature/runout.cpp> -<src/gcode/feature/runout>
+  -<src/feature/snmm.cpp>
   -<src/feature/solenoid.cpp> -<src/gcode/control/M380_M381.cpp>
   -<src/feature/spindle_laser.cpp> -<src/gcode/control/M3-M5.cpp>
   -<src/feature/tmc_util.cpp> -<src/module/stepper/trinamic.cpp>
@@ -342,6 +343,7 @@ POWER_LOSS_RECOVERY     = src_filter=+<src/feature/powerloss.cpp> +<src/gcode/fe
 PROBE_TEMP_COMPENSATION = src_filter=+<src/feature/probe_temp_comp.cpp> +<src/gcode/calibrate/G76_M192_M871.cpp>
 HAS_FILAMENT_SENSOR     = src_filter=+<src/feature/runout.cpp> +<src/gcode/feature/runout>
 (EXT|MANUAL)_SOLENOID.* = src_filter=+<src/feature/solenoid.cpp> +<src/gcode/control/M380_M381.cpp>
+MK2_MULTIPLEXER         = src_filter=+<src/feature/snmm.cpp>
 HAS_CUTTER              = src_filter=+<src/feature/spindle_laser.cpp> +<src/gcode/control/M3-M5.cpp>
 EXPERIMENTAL_I2CBUS     = src_filter=+<src/feature/twibus.cpp> +<src/gcode/feature/i2c>
 MECHANICAL_GANTRY_CAL.+ = src_filter=+<src/gcode/calibrate/G34.cpp>

commit 254b25296b37cdb170e32a5530348907e7b8c9fc
Author: Giuliano Zaro <3684609+GMagician@users.noreply.github.com>
Date:   Sun Feb 28 05:41:16 2021 +0100

    [SAMD51] Respect serial buffer size (#21194)

diff --git a/platformio.ini b/platformio.ini
index 7ddd832f8e..157b3d6201 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -681,6 +681,8 @@ src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
 lib_deps       = ${common.lib_deps}
   SoftwareSerialM
   Adafruit SPIFlash
+extra_scripts  = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/SAMD51_grandcentral_m4.py
 custom_marlin.SDSUPPORT = SdFat - Adafruit Fork
 debug_tool     = jlink
 

commit 903d0b91fc28b1198e7b90131f94f02a7c3f1530
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sat Feb 27 22:38:57 2021 -0600

    Tweaks to build scripts

diff --git a/platformio.ini b/platformio.ini
index 2c011a9e87..7ddd832f8e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1155,7 +1155,7 @@ extends         = env:STM32F103RE
 build_flags     = ${env:STM32F103RE.build_flags} -DTEMP_TIMER_CHAN=4
 extra_scripts   = ${env:STM32F103RE.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/random-bin.py
-  buildroot/share/PlatformIO/scripts/creality.py
+  buildroot/share/PlatformIO/scripts/STM32F103RET6_creality.py
 debug_tool      = jlink
 upload_protocol = jlink
 
@@ -1194,7 +1194,7 @@ build_flags       = ${common_stm32.build_flags}
   -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/STEVAL__F401XX.py
+  buildroot/share/PlatformIO/scripts/STM32F401VE_STEVAL.py
 
 #
 # STM32F401RC
@@ -1569,7 +1569,9 @@ board_build.ldscript = ldscript.ld
 board_build.offset   = 0x10000
 build_flags          = ${common_stm32.build_flags} -DENABLE_HWSERIAL3 -DTIMER_SERIAL=TIM5
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
-extra_scripts        = ${common.extra_scripts} pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 
 #################################
 #                               #

commit 54ccfcc7053bfa57dfe88abca5e420e72548c99c
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sat Feb 27 16:26:49 2021 -0600

    whitespace

diff --git a/platformio.ini b/platformio.ini
index 12f709bc70..2c011a9e87 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1344,7 +1344,7 @@ build_flags       = ${common_stm32.build_flags}
 extends           = env:BIGTREE_GTR_V1_0
 platform_packages = ${stm32_flash_drive.platform_packages}
 build_unflags     = -DUSBCON -DUSBD_USE_CDC
-build_flags       = ${stm32_flash_drive.build_flags} 
+build_flags       = ${stm32_flash_drive.build_flags}
   -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
 
 #

commit dfacd260bb9ba1257d64bb1377627286c43675e1
Author: ldursw <37294448+ldursw@users.noreply.github.com>
Date:   Sun Feb 28 01:32:34 2021 -0300

    ST STM32 platform version 12 (#21219)

diff --git a/platformio.ini b/platformio.ini
index a63ee9f96a..12f709bc70 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -734,7 +734,7 @@ board    = nxp_lpc1769
 # HAL/STM32 Base Environment values
 #
 [common_stm32]
-platform      = ststm32@~11.0
+platform      = ststm32@~12.0
 build_flags   = ${common.build_flags}
   -std=gnu++14
   -DUSBCON -DUSBD_USE_CDC
@@ -747,7 +747,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32> +<src/HAL/shared/b
 # HAL/STM32F1 Common Environment values
 #
 [common_stm32f1]
-platform          = ststm32@~11.0
+platform          = ststm32@~12.0
 board_build.core  = maple
 build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags}

commit c76008bd6a7bc0f88fec7fa58f11cfec88ab366f
Author: Sola <42537573+solawc@users.noreply.github.com>
Date:   Sun Feb 28 07:35:32 2021 +0800

    MKS H43 controller (#20609)

diff --git a/platformio.ini b/platformio.ini
index b35cd878d0..a63ee9f96a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -53,6 +53,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/menu/menu_ubl.cpp>
   -<src/lcd/extui/lib/mks_ui>
   -<src/lcd/extui/lib/dgus> -<src/lcd/extui/dgus_lcd.cpp>
+  -<src/lcd/extui/lib/dgus/fysetc> -<src/lcd/extui/lib/dgus/hiprecy> -<src/lcd/extui/lib/dgus/mks> -<src/lcd/extui/lib/dgus/origin>
   -<src/lcd/extui/example.cpp>
   -<src/lcd/extui/malyan_lcd.cpp>
   -<src/lcd/extui/lib/ftdi_eve_touch_ui>
@@ -287,6 +288,10 @@ HAS_MENU_UBL            = src_filter=+<src/lcd/menu/menu_ubl.cpp>
 ANYCUBIC_LCD_CHIRON     = src_filter=+<src/lcd/extui/anycubic_chiron_lcd.cpp> +<src/lcd/extui/lib/anycubic_chiron>
 ANYCUBIC_LCD_I3MEGA     = src_filter=+<src/lcd/extui/anycubic_i3mega_lcd.cpp> +<src/lcd/extui/lib/anycubic_i3mega>
 HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus> +<src/lcd/extui/dgus_lcd.cpp>
+DGUS_LCD_UI_FYSETC      = src_filter=+<src/lcd/extui/lib/dgus/fysetc>
+DGUS_LCD_UI_HIPRECY     = src_filter=+<src/lcd/extui/lib/dgus/hiprecy>
+DGUS_LCD_UI_MKS         = src_filter=+<src/lcd/extui/lib/dgus/mks>
+DGUS_LCD_UI_ORIGIN      = src_filter=+<src/lcd/extui/lib/dgus/origin>
 TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
 EXTUI_EXAMPLE           = src_filter=+<src/lcd/extui/example.cpp>
 MALYAN_LCD              = src_filter=+<src/lcd/extui/malyan_lcd.cpp>

commit f384f81253fbd70d3d0cee799ab8fc5de80b63b3
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Fri Feb 26 20:36:22 2021 -0300

    Fix GTR / SKR PRO + USB Flash Drive build (#21197)

diff --git a/platformio.ini b/platformio.ini
index 1d2ef0e03b..b35cd878d0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1316,7 +1316,9 @@ build_flags       = ${common_stm32.build_flags}
 [env:BIGTREE_SKR_PRO_usb_flash_drive]
 extends           = env:BIGTREE_SKR_PRO
 platform_packages = ${stm32_flash_drive.platform_packages}
+build_unflags     = -DUSBCON -DUSBD_USE_CDC
 build_flags       = ${stm32_flash_drive.build_flags}
+  -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
@@ -1336,7 +1338,9 @@ build_flags       = ${common_stm32.build_flags}
 [env:BIGTREE_GTR_V1_0_usb_flash_drive]
 extends           = env:BIGTREE_GTR_V1_0
 platform_packages = ${stm32_flash_drive.platform_packages}
-build_flags       = ${stm32_flash_drive.build_flags}
+build_unflags     = -DUSBCON -DUSBD_USE_CDC
+build_flags       = ${stm32_flash_drive.build_flags} 
+  -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
 
 #
 # BigTreeTech BTT002 V1.0 (STM32F407VGT6 ARM Cortex-M4)

commit 427b5d61f46ce0e751e09c841ae62ddeec3df1ac
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Fri Feb 26 20:33:34 2021 -0300

    More LERDGE envs followup (#21205)

diff --git a/platformio.ini b/platformio.ini
index c03b224533..1d2ef0e03b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1385,7 +1385,7 @@ board_build.firmware = Lerdge_X_firmware_force.bin
 # Lerdge X with USB Flash Drive Support
 #
 [env:LERDGEX_usb_flash_drive]
-platform          = ${LERDGEX.platform}
+platform          = ${env:LERDGEX.platform}
 extends           = LERDGEX
 platform_packages = ${stm32_flash_drive.platform_packages}
 build_flags       = ${stm32_flash_drive.build_flags}
@@ -1402,7 +1402,7 @@ board_build.firmware = Lerdge_firmware_force.bin
 # Lerdge S with USB Flash Drive Support
 #
 [env:LERDGES_usb_flash_drive]
-platform          = ${LERDGES.platform}
+platform          = ${env:LERDGES.platform}
 extends           = LERDGES
 platform_packages = ${stm32_flash_drive.platform_packages}
 build_flags       = ${stm32_flash_drive.build_flags}
@@ -1421,7 +1421,7 @@ build_flags          = ${lerdge_common.build_flags}
 # Lerdge K with USB Flash Drive Support
 #
 [env:LERDGEK_usb_flash_drive]
-platform          = ${LERDGEK.platform}
+platform          = ${env:LERDGEK.platform}
 extends           = LERDGEK
 platform_packages = ${stm32_flash_drive.platform_packages}
 build_flags       = ${stm32_flash_drive.build_flags}

commit bb1039d4c91b7bfd282cd5b2b86e1466db80ba28
Author: ellensp <ellensp@hotmail.com>
Date:   Fri Feb 26 03:15:55 2021 +1300

    Preflight checks for PlatformIO builds (#21068)
    
    Co-authored-by: Alexander D. Kanevskiy <alexander.kanevskiy@intel.com>

diff --git a/platformio.ini b/platformio.ini
index fab20018d9..c03b224533 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -212,6 +212,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
 extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
+  pre:buildroot/share/PlatformIO/scripts/preflight-checks.py
   post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
 build_flags        = -fmax-errors=5 -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants
 lib_deps           =

commit 0cc03f912cf0a7f0923bdcf8ee6981e03da15fde
Author: X-Ryl669 <boite.pour.spam@gmail.com>
Date:   Thu Feb 25 08:26:56 2021 +0100

    Let libmaple accept RX/TX_BUFFER_SIZE (#21177)

diff --git a/platformio.ini b/platformio.ini
index 5b2e5cd3bd..fab20018d9 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -753,7 +753,7 @@ lib_deps          = ${common.lib_deps}
   SoftwareSerialM
 platform_packages = tool-stm32duino
 extra_scripts     = ${common.extra_scripts}
-  buildroot/share/PlatformIO/scripts/fix_framework_weakness.py
+  pre:buildroot/share/PlatformIO/scripts/fix_framework_weakness.py
 
 #
 # STM32F103RC
@@ -795,7 +795,7 @@ upload_protocol   = dfu
 [env:STM32F103RC_fysetc]
 platform          = ${common_stm32f1.platform}
 extends           = env:STM32F103RC
-extra_scripts     = ${common.extra_scripts}
+extra_scripts     = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/STM32F103RC_fysetc.py
 build_flags       = ${common_stm32f1.build_flags} -DDEBUG_LEVEL=0
 lib_ldf_mode      = chain
@@ -819,7 +819,7 @@ upload_protocol   = serial
 [env:STM32F103RC_btt]
 platform          = ${common_stm32f1.platform}
 extends           = env:STM32F103RC
-extra_scripts     = ${common.extra_scripts}
+extra_scripts     = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = ${common_stm32f1.build_flags}
   -DDEBUG_LEVEL=0 -DSS_TIMER=4
@@ -861,7 +861,7 @@ monitor_speed     = 115200
 [env:STM32F103RE_btt]
 platform          = ${common_stm32f1.platform}
 extends           = env:STM32F103RE
-extra_scripts     = ${common.extra_scripts}
+extra_scripts     = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
 build_flags       = ${common_stm32f1.build_flags} -DDEBUG_LEVEL=0 -DSS_TIMER=4
 debug_tool        = stlink
@@ -951,7 +951,7 @@ build_flags   = ${common_stm32f1.build_flags}
 platform        = ${common_stm32f1.platform}
 extends         = common_stm32f1
 board           = genericSTM32F103VE
-extra_scripts   = ${common.extra_scripts}
+extra_scripts   = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_nano35.py
 build_flags     = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE -DSS_TIMER=4
@@ -1019,7 +1019,7 @@ platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103RC
 platform_packages = tool-stm32duino
-extra_scripts = ${common.extra_scripts}
+extra_scripts = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_e3.py
 build_flags   = ${common_stm32f1.build_flags}
   -DDEBUG_LEVEL=0 -DSS_TIMER=4

commit 13c4eef63752387b1a90b0b0c3834bcf276a5ac8
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Feb 25 00:56:15 2021 -0600

    Expose more env builds in PlatformIO extension

diff --git a/platformio.ini b/platformio.ini
index d2ed8a4a5a..5b2e5cd3bd 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1376,6 +1376,7 @@ build_unflags       = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUS
 # Lerdge X
 #
 [env:LERDGEX]
+platform             = ${lerdge_common.platform}
 extends              = lerdge_common
 board_build.firmware = Lerdge_X_firmware_force.bin
 
@@ -1383,6 +1384,7 @@ board_build.firmware = Lerdge_X_firmware_force.bin
 # Lerdge X with USB Flash Drive Support
 #
 [env:LERDGEX_usb_flash_drive]
+platform          = ${LERDGEX.platform}
 extends           = LERDGEX
 platform_packages = ${stm32_flash_drive.platform_packages}
 build_flags       = ${stm32_flash_drive.build_flags}
@@ -1391,6 +1393,7 @@ build_flags       = ${stm32_flash_drive.build_flags}
 # Lerdge S
 #
 [env:LERDGES]
+platform             = ${lerdge_common.platform}
 extends              = lerdge_common
 board_build.firmware = Lerdge_firmware_force.bin
 
@@ -1398,6 +1401,7 @@ board_build.firmware = Lerdge_firmware_force.bin
 # Lerdge S with USB Flash Drive Support
 #
 [env:LERDGES_usb_flash_drive]
+platform          = ${LERDGES.platform}
 extends           = LERDGES
 platform_packages = ${stm32_flash_drive.platform_packages}
 build_flags       = ${stm32_flash_drive.build_flags}
@@ -1406,6 +1410,7 @@ build_flags       = ${stm32_flash_drive.build_flags}
 # Lerdge K
 #
 [env:LERDGEK]
+platform             = ${lerdge_common.platform}
 extends              = lerdge_common
 board_build.firmware = Lerdge_K_firmware_force.bin
 build_flags          = ${lerdge_common.build_flags}
@@ -1415,6 +1420,7 @@ build_flags          = ${lerdge_common.build_flags}
 # Lerdge K with USB Flash Drive Support
 #
 [env:LERDGEK_usb_flash_drive]
+platform          = ${LERDGEK.platform}
 extends           = LERDGEK
 platform_packages = ${stm32_flash_drive.platform_packages}
 build_flags       = ${stm32_flash_drive.build_flags}
@@ -1480,13 +1486,19 @@ extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 
+#
+# This SPI is used by Robin Nano V3
+#
+[stm32f4_I2C1]
+build_flags = -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
+
 #
 # MKS Robin Nano V3
 #
 [env:mks_robin_nano_v3]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
+build_flags          = ${common_stm32.build_flags} ${stm32f4_I2C1.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC
 board                = genericSTM32F407VGT6
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
@@ -1508,8 +1520,7 @@ extra_scripts        = ${common.extra_scripts}
 [env:mks_robin_nano_v3_usb_flash_drive]
 extends           = env:mks_robin_nano_v3
 platform_packages = ${stm32_flash_drive.platform_packages}
-build_flags       = ${stm32_flash_drive.build_flags}
-  -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
+build_flags       = ${stm32_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
   -DUSBCON
   -DUSE_USBHOST_HS
   -DUSBD_IRQ_PRIO=5
@@ -1522,11 +1533,11 @@ build_flags       = ${stm32_flash_drive.build_flags}
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive_msc]
+platform          = ${common_stm32.platform}
 extends           = env:mks_robin_nano_v3
 platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc.zip
 build_unflags     = ${common_stm32.build_unflags} -DUSBD_USE_CDC
-build_flags       = ${stm32_flash_drive.build_flags}
-  -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
+build_flags       = ${stm32_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
   -DUSBCON
   -DUSE_USBHOST_HS
   -DUSBD_IRQ_PRIO=5

commit d5b06624fb2b14b57a9621d7b86caf9f1c5dbfb9
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Wed Feb 24 21:36:55 2021 -0300

    Fix MKS Robin Nano V3 I2C pins (#21174)

diff --git a/platformio.ini b/platformio.ini
index dd8a396849..d2ed8a4a5a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1486,7 +1486,7 @@ extra_scripts        = ${common.extra_scripts}
 [env:mks_robin_nano_v3]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC
+build_flags          = ${common_stm32.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
 board                = genericSTM32F407VGT6
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
@@ -1509,6 +1509,7 @@ extra_scripts        = ${common.extra_scripts}
 extends           = env:mks_robin_nano_v3
 platform_packages = ${stm32_flash_drive.platform_packages}
 build_flags       = ${stm32_flash_drive.build_flags}
+  -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
   -DUSBCON
   -DUSE_USBHOST_HS
   -DUSBD_IRQ_PRIO=5
@@ -1525,6 +1526,7 @@ extends           = env:mks_robin_nano_v3
 platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc.zip
 build_unflags     = ${common_stm32.build_unflags} -DUSBD_USE_CDC
 build_flags       = ${stm32_flash_drive.build_flags}
+  -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
   -DUSBCON
   -DUSE_USBHOST_HS
   -DUSBD_IRQ_PRIO=5

commit 8d2885377435e423eaa187b52f33ce5d12fb03be
Author: X-Ryl669 <boite.pour.spam@gmail.com>
Date:   Sun Feb 21 03:22:20 2021 +0100

    Postmortem Debugging to serial port (#20492)

diff --git a/platformio.ini b/platformio.ini
index 15fbf220d4..dd8a396849 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -64,6 +64,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/sd/usb_flashdrive/Sd2Card_FlashDrive.cpp>
   -<src/sd/cardreader.cpp> -<src/sd/Sd2Card.cpp> -<src/sd/SdBaseFile.cpp> -<src/sd/SdFatUtil.cpp> -<src/sd/SdFile.cpp> -<src/sd/SdVolume.cpp> -<src/gcode/sd>
   -<src/HAL/shared/backtrace>
+  -<src/HAL/shared/cpu_exception>
   -<src/HAL/shared/eeprom_if_i2c.cpp>
   -<src/HAL/shared/eeprom_if_spi.cpp>
   -<src/feature/babystep.cpp>
@@ -223,6 +224,8 @@ YHCB2004                = red-scorp/LiquidCrystal_AIP31068@^1.0.4, red-scorp/Sof
 HAS_TFT_LVGL_UI         = lvgl=https://github.com/makerbase-mks/LVGL-6.1.1-MKS/archive/master.zip
                           src_filter=+<src/lcd/extui/lib/mks_ui>
                           extra_scripts=download_mks_assets.py
+POSTMORTEM_DEBUGGING    = src_filter=+<src/HAL/shared/cpu_exception> +<src/HAL/shared/backtrace>
+                          build_flags=-funwind-tables
 MKS_WIFI_MODULE         = QRCode=https://github.com/makerbase-mks/QRCode/archive/master.zip
 HAS_TRINAMIC_CONFIG     = TMCStepper@~0.7.1
                           src_filter=+<src/feature/tmc_util.cpp> +<src/module/stepper/trinamic.cpp> +<src/gcode/feature/trinamic/M122.cpp> +<src/gcode/feature/trinamic/M906.cpp> +<src/gcode/feature/trinamic/M911-M914.cpp>
@@ -637,14 +640,6 @@ platform = atmelsam
 extends  = env:DUE
 board    = dueUSB
 
-[env:DUE_debug]
-# Used when WATCHDOG_RESET_MANUAL is enabled
-platform    = atmelsam
-extends     = env:DUE
-build_flags = ${common.build_flags}
-  -funwind-tables
-  -mpoke-function-name
-
 #
 # Archim SAM
 #
@@ -662,12 +657,6 @@ extra_scripts            = ${common.extra_scripts}
 platform = ${common_DUE_archim.platform}
 extends  = common_DUE_archim
 
-# Used when WATCHDOG_RESET_MANUAL is enabled
-[env:DUE_archim_debug]
-platform    = ${common_DUE_archim.platform}
-extends     = common_DUE_archim
-build_flags = ${common_DUE_archim.build_flags} -funwind-tables -mpoke-function-name
-
 #################################
 #                               #
 #      SAMD51 Architecture      #
@@ -763,6 +752,8 @@ lib_ignore        = SPI, FreeRTOS701, FreeRTOS821
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM
 platform_packages = tool-stm32duino
+extra_scripts     = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/fix_framework_weakness.py
 
 #
 # STM32F103RC
@@ -788,7 +779,7 @@ build_flags       = ${common_stm32f1.build_flags}
                     -DUSE_USB_COMPOSITE
                     -DVECT_TAB_OFFSET=0x2000
                     -DGENERIC_BOOTLOADER
-extra_scripts     = ${common.extra_scripts}
+extra_scripts     = ${common_stm32f1.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
   buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP.py
 lib_deps          = ${common.lib_deps}
@@ -934,7 +925,7 @@ upload_protocol   = serial
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103VE
-extra_scripts = ${common.extra_scripts}
+extra_scripts = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
 build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE -DSTM32F1xx -USERIAL_USB -DU20 -DTS_V12
@@ -948,7 +939,7 @@ build_unflags = ${common_stm32f1.build_unflags}
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103VE
-extra_scripts = ${common.extra_scripts}
+extra_scripts = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_mini.py
 build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE
@@ -974,7 +965,7 @@ upload_protocol = jlink
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103ZE
-extra_scripts = ${common.extra_scripts}
+extra_scripts = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin.py
 build_flags   = ${common_stm32f1.build_flags}
   -DSS_TIMER=4 -DSTM32_XL_DENSITY
@@ -1008,7 +999,7 @@ lib_deps             =
 [env:mks_robin_pro]
 platform      = ${common_stm32f1.platform}
 extends       = env:mks_robin
-extra_scripts = ${common.extra_scripts}
+extra_scripts = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_pro.py
 
 #
@@ -1017,7 +1008,7 @@ extra_scripts = ${common.extra_scripts}
 [env:trigorilla_pro]
 platform      = ${common_stm32f1.platform}
 extends       = env:mks_robin
-extra_scripts = ${common.extra_scripts}
+extra_scripts = ${common_stm32f1.extra_scripts}
 
 #
 # MKS Robin E3D (STM32F103RCT6) and
@@ -1041,7 +1032,7 @@ build_flags   = ${common_stm32f1.build_flags}
 platform        = ${common_stm32f1.platform}
 extends         = common_stm32f1
 board           = genericSTM32F103VE
-extra_scripts   = ${common.extra_scripts}
+extra_scripts   = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_e3p.py
 build_flags     = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE -DSS_TIMER=4
@@ -1055,7 +1046,7 @@ upload_protocol = jlink
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103RC
-extra_scripts = ${common.extra_scripts}
+extra_scripts = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_lite.py
 
 #
@@ -1065,7 +1056,7 @@ extra_scripts = ${common.extra_scripts}
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103RC
-extra_scripts = ${common.extra_scripts}
+extra_scripts = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_lite3.py
 
 #
@@ -1075,7 +1066,7 @@ extra_scripts = ${common.extra_scripts}
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103ZE
-extra_scripts = ${common.extra_scripts}
+extra_scripts = ${common_stm32f1.extra_scripts}
   buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
 build_flags   = ${common_stm32f1.build_flags}
   -DSTM32F1xx -DSTM32_XL_DENSITY
@@ -1230,7 +1221,7 @@ extra_scripts     = ${common.extra_scripts}
 platform          = ${common_stm32f1.platform}
 extends           = common_stm32f1
 board             = genericSTM32F103RC
-extra_scripts     = ${common.extra_scripts}
+extra_scripts     = ${common_stm32f1.extra_scripts}
  buildroot/share/PlatformIO/scripts/fly_mini.py
 build_flags       = ${common_stm32f1.build_flags}
  -DDEBUG_LEVEL=0 -DSS_TIMER=4
@@ -1557,7 +1548,6 @@ build_flags          = ${common_stm32.build_flags} -DENABLE_HWSERIAL3 -DTIMER_SE
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
 extra_scripts        = ${common.extra_scripts} pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 
-
 #################################
 #                               #
 #      Other Architectures      #

commit 490d4a504a40a70e1a51c4758d37ec6116272b38
Author: Vert <45634861+Vertabreak@users.noreply.github.com>
Date:   Tue Feb 16 21:29:55 2021 -0500

    GT2560 v4.1B, YHCB2004 SPI character LCD (#21091)
    
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/platformio.ini b/platformio.ini
index bcf90df0f2..15fbf220d4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -219,6 +219,7 @@ lib_deps           =
 # Feature Dependencies
 #
 [features]
+YHCB2004                = red-scorp/LiquidCrystal_AIP31068@^1.0.4, red-scorp/SoftSPIB@^1.1.1
 HAS_TFT_LVGL_UI         = lvgl=https://github.com/makerbase-mks/LVGL-6.1.1-MKS/archive/master.zip
                           src_filter=+<src/lcd/extui/lib/mks_ui>
                           extra_scripts=download_mks_assets.py

commit 31a434b9d79bb771d2410a5ce02dea0d577a8c93
Author: jbuck2005 <59450931+jbuck2005@users.noreply.github.com>
Date:   Mon Feb 15 07:03:44 2021 -0500

    Update platform ststm32 to 11.0 (#20928)

diff --git a/platformio.ini b/platformio.ini
index 63933183a4..bcf90df0f2 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -738,7 +738,7 @@ board    = nxp_lpc1769
 # HAL/STM32 Base Environment values
 #
 [common_stm32]
-platform      = ststm32@~10.0
+platform      = ststm32@~11.0
 build_flags   = ${common.build_flags}
   -std=gnu++14
   -DUSBCON -DUSBD_USE_CDC
@@ -751,7 +751,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32> +<src/HAL/shared/b
 # HAL/STM32F1 Common Environment values
 #
 [common_stm32f1]
-platform          = ststm32@~10.0
+platform          = ststm32@~11.0
 board_build.core  = maple
 build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags}

commit 52e8d8db54cfc89b41735dd25e57ecd830a9260e
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Feb 13 21:51:26 2021 -0600

    anet_et4_openblt.py => openblt.py

diff --git a/platformio.ini b/platformio.ini
index c138a4a48c..63933183a4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1280,7 +1280,7 @@ board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.ldscript = ldscript.ld
 board_build.firmware = firmware.srec
-# Just anet_et4_openblt.py generates the file, not stm32_bootloader.py
+# Just openblt.py (not stm32_bootloader.py) generates the file
 board_build.encrypt  = Yes
 board_build.offset   = 0x10000
 board_upload.offset_address = 0x08010000
@@ -1290,7 +1290,7 @@ upload_protocol      = jlink
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-  buildroot/share/PlatformIO/scripts/anet_et4_openblt.py
+  buildroot/share/PlatformIO/scripts/openblt.py
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)

commit ce1ec227048ec7af26f6bfd58148268fa2189882
Author: X-Ryl669 <boite.pour.spam@gmail.com>
Date:   Fri Feb 12 15:33:27 2021 +0100

    Use -g3 to include macros in debug symbols (#21052)

diff --git a/platformio.ini b/platformio.ini
index 9239ace72c..c138a4a48c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -212,7 +212,7 @@ extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
   post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
-build_flags        = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-constants
+build_flags        = -fmax-errors=5 -g3 -D__MARLIN_FIRMWARE__ -fmerge-constants
 lib_deps           =
 
 #

commit b35bfeb1c3f1271016227a1d79dcb552e67e3cb9
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Feb 7 16:58:06 2021 -0600

    Fix TEMP_0_TR_ENABLE, rename temp conditions (#21016)

diff --git a/platformio.ini b/platformio.ini
index 6008b943ec..9239ace72c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -235,7 +235,7 @@ HAS_L64XX               = Arduino-L6470@0.8.0
                           src_filter=+<src/libs/L64XX> +<src/module/stepper/L64xx.cpp> +<src/gcode/feature/L6470> +<src/HAL/shared/HAL_spi_L6470.cpp>
 NEOPIXEL_LED            = Adafruit NeoPixel@1.5.0
                           src_filter=+<src/feature/leds/neopixel.cpp>
-MAX6675_._IS_MAX31865   = Adafruit MAX31865 library@~1.1.0
+TEMP_.+_IS_MAX31865     = Adafruit MAX31865 library@~1.1.0
 USES_LIQUIDCRYSTAL      = bitbucket-fmalpartida/LiquidCrystal@1.5.0
 USES_LIQUIDCRYSTAL_I2C  = marcoschwartz/LiquidCrystal_I2C@1.1.4
 USES_LIQUIDTWI2         = LiquidTWI2@1.2.7

commit 28b8bf566b7a9ea116926a94466c3e1be6a5ddd8
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Tue Feb 2 17:55:11 2021 -0300

    STM32 Shared Media - USB Mass Storage Device (#20956)

diff --git a/platformio.ini b/platformio.ini
index 2d81baa200..6008b943ec 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1524,6 +1524,22 @@ build_flags       = ${stm32_flash_drive.build_flags}
   -DUSE_USB_HS_IN_FS
   -DUSBD_USE_CDC
 
+#
+# MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
+# Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
+#
+[env:mks_robin_nano_v3_usb_flash_drive_msc]
+extends           = env:mks_robin_nano_v3
+platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc.zip
+build_unflags     = ${common_stm32.build_unflags} -DUSBD_USE_CDC
+build_flags       = ${stm32_flash_drive.build_flags}
+  -DUSBCON
+  -DUSE_USBHOST_HS
+  -DUSBD_IRQ_PRIO=5
+  -DUSBD_IRQ_SUBPRIO=6
+  -DUSE_USB_HS_IN_FS
+  -DUSBD_USE_CDC_MSC
+
 #
 # Mingda MPX_ARM_MINI
 #

commit 0d2645b3e12b14ad613d977e366fb64596fb97e6
Author: rafaljot <rafal@jastrzebscy.org>
Date:   Fri Jan 29 06:22:18 2021 +0100

    MPX_ARM_MINI board (Mingda MD-16) (#20711)

diff --git a/platformio.ini b/platformio.ini
index cce10c0b32..2d81baa200 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1524,6 +1524,23 @@ build_flags       = ${stm32_flash_drive.build_flags}
   -DUSE_USB_HS_IN_FS
   -DUSBD_USE_CDC
 
+#
+# Mingda MPX_ARM_MINI
+#
+
+[env:mingda_mpx_arm_mini]
+platform             = ${common_stm32.platform}
+extends              = common_stm32
+board                = genericSTM32F103ZE
+board_build.core     = stm32
+board_build.variant  = MARLIN_F103Zx
+board_build.ldscript = ldscript.ld
+board_build.offset   = 0x10000
+build_flags          = ${common_stm32.build_flags} -DENABLE_HWSERIAL3 -DTIMER_SERIAL=TIM5
+build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
+extra_scripts        = ${common.extra_scripts} pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+
+
 #################################
 #                               #
 #      Other Architectures      #

commit 5ac08a44c6e22c1647f059b06cbd9876f45eaf11
Author: George Fu <nailao_5918@163.com>
Date:   Fri Jan 29 09:52:49 2021 +0800

    FYSETC Cheetah 2.0 (#20897)

diff --git a/platformio.ini b/platformio.ini
index 65d0b9ad8c..cce10c0b32 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1198,6 +1198,18 @@ extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/STEVAL__F401XX.py
 
+#
+# STM32F401RC
+#
+[env:FYSETC_CHEETAH_V20]
+platform          = ${common_stm32.platform}
+extends           = common_stm32
+board             = FYSETC_CHEETAH_V20
+build_flags       = ${common_stm32.build_flags} -DSTM32F401xC -DVECT_TAB_OFFSET=0xC000
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/FYSETC_CHEETAH_V20.py
+
 #
 # FLYF407ZG
 #

commit ea8d682664ba769d240b61e35047c84253fb67d2
Author: Jason Smith <jason.inet@gmail.com>
Date:   Sun Jan 24 13:24:16 2021 -0800

    Fix LiquidCrystal CI failures (#20873)
    
    Fix incorrect dependency syntax for LPC.
    Disambiguate LiquidCrystal library names.

diff --git a/platformio.ini b/platformio.ini
index 11248d7650..65d0b9ad8c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -236,7 +236,7 @@ HAS_L64XX               = Arduino-L6470@0.8.0
 NEOPIXEL_LED            = Adafruit NeoPixel@1.5.0
                           src_filter=+<src/feature/leds/neopixel.cpp>
 MAX6675_._IS_MAX31865   = Adafruit MAX31865 library@~1.1.0
-USES_LIQUIDCRYSTAL      = LiquidCrystal@1.5.0
+USES_LIQUIDCRYSTAL      = bitbucket-fmalpartida/LiquidCrystal@1.5.0
 USES_LIQUIDCRYSTAL_I2C  = marcoschwartz/LiquidCrystal_I2C@1.1.4
 USES_LIQUIDTWI2         = LiquidTWI2@1.2.7
 HAS_WIRED_LCD           = src_filter=+<src/lcd/lcdprint.cpp>
@@ -708,7 +708,7 @@ extra_scripts     = ${common.extra_scripts}
 src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768> +<src/HAL/shared/backtrace>
 lib_deps          = ${common.lib_deps}
   Servo
-custom_marlin.USES_LIQUIDCRYSTAL = LiquidCrystal~1.0.7
+custom_marlin.USES_LIQUIDCRYSTAL = arduino-libraries/LiquidCrystal@~1.0.7
 custom_marlin.NEOPIXEL_LED = Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/1.5.0.zip
 build_flags       = ${common.build_flags} -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g
   # debug options for backtrace

commit 3921369f98f39280800b1c9944677e9644278106
Author: ellensp <ellensp@hotmail.com>
Date:   Sun Jan 24 19:43:23 2021 +1300

    MeatPack serial encoding (#20802)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 822f1df8d1..11248d7650 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -97,6 +97,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/leds/printer_event_leds.cpp>
   -<src/feature/leds/tempstat.cpp>
   -<src/feature/max7219.cpp>
+  -<src/feature/meatpack.cpp>
   -<src/feature/mixing.cpp>
   -<src/feature/mmu/mmu.cpp>
   -<src/feature/mmu/mmu2.cpp> -<src/gcode/feature/prusa_MMU2>
@@ -319,6 +320,7 @@ PCA9632                 = src_filter=+<src/feature/leds/pca9632.cpp>
 PRINTER_EVENT_LEDS      = src_filter=+<src/feature/leds/printer_event_leds.cpp>
 TEMP_STAT_LEDS          = src_filter=+<src/feature/leds/tempstat.cpp>
 MAX7219_DEBUG           = src_filter=+<src/feature/max7219.cpp> +<src/gcode/feature/leds/M7219.cpp>
+MEATPACK                = src_filter=+<src/feature/meatpack.cpp>
 MIXING_EXTRUDER         = src_filter=+<src/feature/mixing.cpp> +<src/gcode/feature/mixing/M163-M165.cpp>
 HAS_PRUSA_MMU1          = src_filter=+<src/feature/mmu/mmu.cpp>
 HAS_PRUSA_MMU2          = src_filter=+<src/feature/mmu/mmu2.cpp> +<src/gcode/feature/prusa_MMU2>
@@ -706,7 +708,7 @@ extra_scripts     = ${common.extra_scripts}
 src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768> +<src/HAL/shared/backtrace>
 lib_deps          = ${common.lib_deps}
   Servo
-custom_marlin.USES_LIQUIDCRYSTAL = LiquidCrystal@1.0.0
+custom_marlin.USES_LIQUIDCRYSTAL = LiquidCrystal~1.0.7
 custom_marlin.NEOPIXEL_LED = Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/1.5.0.zip
 build_flags       = ${common.build_flags} -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g
   # debug options for backtrace

commit a54154e760c0e3012b7841b317b277353174354d
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Jan 22 20:51:58 2021 -0600

    üõ† Replace lib_deps for custom_marlin.FEATURE (#20858)

diff --git a/platformio.ini b/platformio.ini
index 6b1543fa53..822f1df8d1 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -404,7 +404,7 @@ BEZIER_CURVE_SUPPORT    = src_filter=+<src/module/planner_bezier.cpp> +<src/gcod
 PRINTCOUNTER            = src_filter=+<src/module/printcounter.cpp>
 HAS_BED_PROBE           = src_filter=+<src/module/probe.cpp> +<src/gcode/probe/G30.cpp> +<src/gcode/probe/M401_M402.cpp> +<src/gcode/probe/M851.cpp>
 IS_SCARA                = src_filter=+<src/module/scara.cpp>
-HAS_SERVOS              = src_filter=+<src/module/servo.cpp> +<src/gcode/control/M280.cpp> 
+HAS_SERVOS              = src_filter=+<src/module/servo.cpp> +<src/gcode/control/M280.cpp>
 MORGAN_SCARA            = src_filter=+<src/gcode/scara>
 HAS_MICROSTEPS          = src_filter=+<src/gcode/control/M350_M351.cpp>
 (ESP3D_)?WIFISUPPORT    = AsyncTCP, ESP Async WebServer

commit d62aa6221bd905f4d4b9f26b7818f1bf227fd824
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Wed Jan 20 23:26:12 2021 -0800

    Lerdge K/S/X support for Flash Drive (#20593)

diff --git a/platformio.ini b/platformio.ini
index a142fe891a..6b1543fa53 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1373,6 +1373,14 @@ build_unflags       = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUS
 extends              = lerdge_common
 board_build.firmware = Lerdge_X_firmware_force.bin
 
+#
+# Lerdge X with USB Flash Drive Support
+#
+[env:LERDGEX_usb_flash_drive]
+extends           = LERDGEX
+platform_packages = ${stm32_flash_drive.platform_packages}
+build_flags       = ${stm32_flash_drive.build_flags}
+
 #
 # Lerdge S
 #
@@ -1380,6 +1388,14 @@ board_build.firmware = Lerdge_X_firmware_force.bin
 extends              = lerdge_common
 board_build.firmware = Lerdge_firmware_force.bin
 
+#
+# Lerdge S with USB Flash Drive Support
+#
+[env:LERDGES_usb_flash_drive]
+extends           = LERDGES
+platform_packages = ${stm32_flash_drive.platform_packages}
+build_flags       = ${stm32_flash_drive.build_flags}
+
 #
 # Lerdge K
 #
@@ -1389,6 +1405,14 @@ board_build.firmware = Lerdge_K_firmware_force.bin
 build_flags          = ${lerdge_common.build_flags}
   -DLERDGEK
 
+#
+# Lerdge K with USB Flash Drive Support
+#
+[env:LERDGEK_usb_flash_drive]
+extends           = LERDGEK
+platform_packages = ${stm32_flash_drive.platform_packages}
+build_flags       = ${stm32_flash_drive.build_flags}
+
 #
 # RUMBA32
 #

commit 68abaeab19b41824bc151bc0f65e76ce8a2e4916
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Wed Jan 20 18:52:06 2021 -0600

    MarlinUI multi-language support (#20725)

diff --git a/platformio.ini b/platformio.ini
index a32bf53d67..a142fe891a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -39,6 +39,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/menu/menu_filament.cpp>
   -<src/lcd/menu/menu_info.cpp>
   -<src/lcd/menu/menu_job_recovery.cpp>
+  -<src/lcd/menu/menu_language.cpp>
   -<src/lcd/menu/menu_led.cpp>
   -<src/lcd/menu/menu_media.cpp>
   -<src/lcd/menu/menu_mmu2.cpp>
@@ -264,6 +265,7 @@ HAS_MENU_DELTA_CALIBRATE = src_filter=+<src/lcd/menu/menu_delta_calibrate.cpp>
 HAS_MENU_FILAMENT       = src_filter=+<src/lcd/menu/menu_filament.cpp>
 LCD_INFO_MENU           = src_filter=+<src/lcd/menu/menu_info.cpp>
 HAS_MENU_JOB_RECOVERY   = src_filter=+<src/lcd/menu/menu_job_recovery.cpp>
+HAS_MULTI_LANGUAGE      = src_filter=+<src/lcd/menu/menu_language.cpp>
 HAS_MENU_LED            = src_filter=+<src/lcd/menu/menu_led.cpp>
 HAS_MENU_MEDIA          = src_filter=+<src/lcd/menu/menu_media.cpp>
 HAS_MENU_MIXER          = src_filter=+<src/lcd/menu/menu_mixer.cpp>

commit 03b53ffde1ab0887459fa29aa7e5e4b02664f9ce
Author: ellensp <ellensp@hotmail.com>
Date:   Thu Jan 21 13:18:22 2021 +1300

    More PlatformIO source filters (#20822)

diff --git a/platformio.ini b/platformio.ini
index 24209ba1cf..a32bf53d67 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -60,7 +60,11 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/lcdprint.cpp>
   -<src/lcd/touch/touch_buttons.cpp>
   -<src/sd/usb_flashdrive/lib-uhs2> -<src/sd/usb_flashdrive/lib-uhs3>
+  -<src/sd/usb_flashdrive/Sd2Card_FlashDrive.cpp>
+  -<src/sd/cardreader.cpp> -<src/sd/Sd2Card.cpp> -<src/sd/SdBaseFile.cpp> -<src/sd/SdFatUtil.cpp> -<src/sd/SdFile.cpp> -<src/sd/SdVolume.cpp> -<src/gcode/sd>
   -<src/HAL/shared/backtrace>
+  -<src/HAL/shared/eeprom_if_i2c.cpp>
+  -<src/HAL/shared/eeprom_if_spi.cpp>
   -<src/feature/babystep.cpp>
   -<src/feature/backlash.cpp>
   -<src/feature/baricuda.cpp> -<src/gcode/feature/baricuda>
@@ -77,7 +81,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/direct_stepping.cpp> -<src/gcode/motion/G6.cpp>
   -<src/feature/e_parser.cpp>
   -<src/feature/encoder_i2c.cpp>
-  -<src/feature/ethernet.cpp>
+  -<src/feature/ethernet.cpp> -<src/gcode/feature/network/M552-M554.cpp>
   -<src/feature/fanmux.cpp>
   -<src/feature/filwidth.cpp> -<src/gcode/feature/filwidth>
   -<src/feature/fwretract.cpp> -<src/gcode/feature/fwretract>
@@ -112,7 +116,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/bedlevel/G26.cpp>
   -<src/gcode/bedlevel/G35.cpp>
   -<src/gcode/bedlevel/G42.cpp>
-  -<src/gcode/bedlevel/M420.cpp>
+  -<src/gcode/bedlevel/M420.cpp> -<src/feature/bedlevel/bedlevel.cpp>
   -<src/gcode/calibrate/G33.cpp>
   -<src/gcode/calibrate/G34.cpp>
   -<src/gcode/calibrate/G34_M422.cpp>
@@ -139,6 +143,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/config/M672.cpp>
   -<src/gcode/control/M7-M9.cpp>
   -<src/gcode/control/M211.cpp>
+  -<src/gcode/control/M350_M351.cpp>
   -<src/gcode/control/M605.cpp>
   -<src/gcode/feature/advance>
   -<src/gcode/feature/camera>
@@ -190,7 +195,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/units/G20_G21.cpp>
   -<src/gcode/units/M149.cpp>
   -<src/libs/BL24CXX.cpp> -<src/libs/W25Qxx.cpp>
-  -<src/libs/L64XX> -<src/module/stepper/L64xx.cpp>
+  -<src/libs/L64XX> -<src/module/stepper/L64xx.cpp> -<src/HAL/shared/HAL_spi_L6470.cpp>
   -<src/libs/hex_print.cpp>
   -<src/libs/least_squares_fit.cpp>
   -<src/libs/nozzle.cpp> -<src/gcode/feature/clean>
@@ -199,6 +204,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/module/printcounter.cpp>
   -<src/module/probe.cpp>
   -<src/module/scara.cpp> -<src/gcode/calibrate/M665.cpp>
+  -<src/module/servo.cpp> -<src/gcode/control/M280.cpp>
   -<src/module/stepper/TMC26X.cpp>
 extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
@@ -224,7 +230,7 @@ HAS_MOTOR_CURRENT_I2C   = SlowSoftI2CMaster
 HAS_TMC26X              = TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
                           src_filter=+<src/module/TMC26X.cpp>
 HAS_L64XX               = Arduino-L6470@0.8.0
-                          src_filter=+<src/libs/L64XX> +<src/module/stepper/L64xx.cpp> +<src/gcode/feature/L6470>
+                          src_filter=+<src/libs/L64XX> +<src/module/stepper/L64xx.cpp> +<src/gcode/feature/L6470> +<src/HAL/shared/HAL_spi_L6470.cpp>
 NEOPIXEL_LED            = Adafruit NeoPixel@1.5.0
                           src_filter=+<src/feature/leds/neopixel.cpp>
 MAX6675_._IS_MAX31865   = Adafruit MAX31865 library@~1.1.0
@@ -238,6 +244,8 @@ HAS_MARLINUI_U8GLIB     = U8glib-HAL@~0.4.1
 HAS_(FSMC|SPI)_TFT      = src_filter=+<src/HAL/STM32/tft> +<src/HAL/STM32F1/tft> +<src/lcd/tft_io>
 HAS_FSMC_TFT            = src_filter=+<src/HAL/STM32/tft/tft_fsmc.cpp> +<src/HAL/STM32F1/tft/tft_fsmc.cpp>
 HAS_SPI_TFT             = src_filter=+<src/HAL/STM32/tft/tft_spi.cpp> +<src/HAL/STM32F1/tft/tft_spi.cpp>
+I2C_EEPROM              = src_filter=+<src/HAL/shared/eeprom_if_i2c.cpp>
+SPI_EEPROM              = src_filter=+<src/HAL/shared/eeprom_if_spi.cpp>
 HAS_GRAPHICAL_TFT       = src_filter=+<src/lcd/tft>
 DWIN_CREALITY_LCD       = src_filter=+<src/lcd/dwin>
 IS_TFTGLCD_PANEL        = src_filter=+<src/lcd/TFTGLCD>
@@ -276,6 +284,7 @@ EXTUI_EXAMPLE           = src_filter=+<src/lcd/extui/example.cpp>
 MALYAN_LCD              = src_filter=+<src/lcd/extui/malyan_lcd.cpp>
 USE_UHS2_USB            = src_filter=+<src/sd/usb_flashdrive/lib-uhs2>
 USE_UHS3_USB            = src_filter=+<src/sd/usb_flashdrive/lib-uhs3>
+USB_FLASH_DRIVE_SUPPORT = src_filter=+<src/sd/usb_flashdrive/Sd2Card_FlashDrive.cpp>
 AUTO_BED_LEVELING_BILINEAR = src_filter=+<src/feature/bedlevel/abl>
 AUTO_BED_LEVELING_(3POINT|(BI)?LINEAR) = src_filter=+<src/gcode/bedlevel/abl>
 MESH_BED_LEVELING       = src_filter=+<src/feature/bedlevel/mbl> +<src/gcode/bedlevel/mbl>
@@ -294,7 +303,7 @@ EMERGENCY_PARSER        = src_filter=+<src/feature/e_parser.cpp> -<src/gcode/con
 I2C_POSITION_ENCODERS   = src_filter=+<src/feature/encoder_i2c.cpp>
 IIC_BL24CXX_EEPROM      = src_filter=+<src/libs/BL24CXX.cpp>
 HAS_SPI_FLASH           = src_filter=+<src/libs/W25Qxx.cpp>
-HAS_ETHERNET            = src_filter=+<src/feature/ethernet.cpp>
+HAS_ETHERNET            = src_filter=+<src/feature/ethernet.cpp> +<src/gcode/feature/network/M552-M554.cpp>
 HAS_FANMUX              = src_filter=+<src/feature/fanmux.cpp>
 FILAMENT_WIDTH_SENSOR   = src_filter=+<src/feature/filwidth.cpp> +<src/gcode/feature/filwidth>
 FWRETRACT               = src_filter=+<src/feature/fwretract.cpp> +<src/gcode/feature/fwretract>
@@ -327,7 +336,7 @@ Z_STEPPER_AUTO_ALIGN    = src_filter=+<src/feature/z_stepper_align.cpp> +<src/gc
 G26_MESH_VALIDATION     = src_filter=+<src/gcode/bedlevel/G26.cpp>
 ASSISTED_TRAMMING       = src_filter=+<src/feature/tramming.cpp> +<src/gcode/bedlevel/G35.cpp>
 HAS_MESH                = src_filter=+<src/gcode/bedlevel/G42.cpp>
-HAS_LEVELING            = src_filter=+<src/gcode/bedlevel/M420.cpp>
+HAS_LEVELING            = src_filter=+<src/gcode/bedlevel/M420.cpp> +<src/feature/bedlevel/bedlevel.cpp>
 DELTA_AUTO_CALIBRATION  = src_filter=+<src/gcode/calibrate/G33.cpp>
 CALIBRATION_GCODE       = src_filter=+<src/gcode/calibrate/G425.cpp>
 Z_MIN_PROBE_REPEATABILITY_TEST = src_filter=+<src/gcode/calibrate/M48.cpp>
@@ -377,7 +386,7 @@ BABYSTEPPING            = src_filter=+<src/gcode/motion/M290.cpp> +<src/feature/
 Z_PROBE_SLED            = src_filter=+<src/gcode/probe/G31_G32.cpp>
 G38_PROBE_TARGET        = src_filter=+<src/gcode/probe/G38.cpp>
 MAGNETIC_PARKING_EXTRUDER = src_filter=+<src/gcode/probe/M951.cpp>
-SDSUPPORT               = src_filter=+<src/gcode/sd>
+SDSUPPORT               = src_filter=+<src/sd/cardreader.cpp> +<src/sd/Sd2Card.cpp> +<src/sd/SdBaseFile.cpp> +<src/sd/SdFatUtil.cpp> +<src/sd/SdFile.cpp> +<src/sd/SdVolume.cpp> +<src/gcode/sd>
 HAS_MEDIA_SUBCALLS      = src_filter=+<src/gcode/sd/M32.cpp>
 GCODE_REPEAT_MARKERS    = src_filter=+<src/feature/repeat.cpp> +<src/gcode/sd/M808.cpp>
 HAS_EXTRUDERS           = src_filter=+<src/gcode/temp/M104_M109.cpp> +<src/gcode/config/M221.cpp>
@@ -393,7 +402,9 @@ BEZIER_CURVE_SUPPORT    = src_filter=+<src/module/planner_bezier.cpp> +<src/gcod
 PRINTCOUNTER            = src_filter=+<src/module/printcounter.cpp>
 HAS_BED_PROBE           = src_filter=+<src/module/probe.cpp> +<src/gcode/probe/G30.cpp> +<src/gcode/probe/M401_M402.cpp> +<src/gcode/probe/M851.cpp>
 IS_SCARA                = src_filter=+<src/module/scara.cpp>
+HAS_SERVOS              = src_filter=+<src/module/servo.cpp> +<src/gcode/control/M280.cpp> 
 MORGAN_SCARA            = src_filter=+<src/gcode/scara>
+HAS_MICROSTEPS          = src_filter=+<src/gcode/control/M350_M351.cpp>
 (ESP3D_)?WIFISUPPORT    = AsyncTCP, ESP Async WebServer
   ESP3DLib=https://github.com/luc-github/ESP3DLib.git
   arduinoWebSockets=https://github.com/Links2004/arduinoWebSockets.git

commit 8049db20ff3e543af03dbbaa418aa17e630e22a8
Author: EvilGremlin <evilgremlin8@gmail.com>
Date:   Thu Jan 14 11:33:50 2021 +0300

    ESP32 Tone Generator (#20704)

diff --git a/platformio.ini b/platformio.ini
index 81ed916eeb..24209ba1cf 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1483,12 +1483,13 @@ build_flags       = ${stm32_flash_drive.build_flags}
 # Espressif ESP32
 #
 [env:esp32]
-platform      = espressif32@1.11.2
+platform      = espressif32@2.1.0
 board         = esp32dev
 build_flags   = ${common.build_flags} -DCORE_DEBUG_LEVEL=0
 src_filter    = ${common.default_src_filter} +<src/HAL/ESP32>
 lib_ignore    = NativeEthernet
-upload_speed  = 115200
+upload_speed  = 500000
+monitor_speed = 250000
 #upload_port   = marlinesp.local
 #board_build.flash_mode = qio
 

commit 35c1b330ec62e698a455176330e7d75600af461d
Author: MKS-Sean <56996910+MKS-Sean@users.noreply.github.com>
Date:   Thu Jan 14 12:41:09 2021 +0800

    MKS WiFi for TFT_LVGL_UI (#20191)

diff --git a/platformio.ini b/platformio.ini
index daeaee4021..81ed916eeb 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -214,6 +214,7 @@ lib_deps           =
 HAS_TFT_LVGL_UI         = lvgl=https://github.com/makerbase-mks/LVGL-6.1.1-MKS/archive/master.zip
                           src_filter=+<src/lcd/extui/lib/mks_ui>
                           extra_scripts=download_mks_assets.py
+MKS_WIFI_MODULE         = QRCode=https://github.com/makerbase-mks/QRCode/archive/master.zip
 HAS_TRINAMIC_CONFIG     = TMCStepper@~0.7.1
                           src_filter=+<src/feature/tmc_util.cpp> +<src/module/stepper/trinamic.cpp> +<src/gcode/feature/trinamic/M122.cpp> +<src/gcode/feature/trinamic/M906.cpp> +<src/gcode/feature/trinamic/M911-M914.cpp>
 HAS_STEALTHCHOP         = src_filter=+<src/gcode/feature/trinamic/M569.cpp>

commit e685950d97ba6cf2c55f935358b5eb7215e08ba5
Author: qwewer0 <57561110+qwewer0@users.noreply.github.com>
Date:   Sat Jan 2 09:33:31 2021 +0100

    Assisted Tramming improvements (#20298)

diff --git a/platformio.ini b/platformio.ini
index 3e87968eef..daeaee4021 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -106,6 +106,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/solenoid.cpp> -<src/gcode/control/M380_M381.cpp>
   -<src/feature/spindle_laser.cpp> -<src/gcode/control/M3-M5.cpp>
   -<src/feature/tmc_util.cpp> -<src/module/stepper/trinamic.cpp>
+  -<src/feature/tramming.cpp>
   -<src/feature/twibus.cpp>
   -<src/feature/z_stepper_align.cpp>
   -<src/gcode/bedlevel/G26.cpp>
@@ -323,7 +324,7 @@ MECHANICAL_GANTRY_CAL.+ = src_filter=+<src/gcode/calibrate/G34.cpp>
 Z_MULTI_ENDSTOPS        = src_filter=+<src/gcode/calibrate/G34_M422.cpp>
 Z_STEPPER_AUTO_ALIGN    = src_filter=+<src/feature/z_stepper_align.cpp> +<src/gcode/calibrate/G34_M422.cpp>
 G26_MESH_VALIDATION     = src_filter=+<src/gcode/bedlevel/G26.cpp>
-ASSISTED_TRAMMING       = src_filter=+<src/gcode/bedlevel/G35.cpp>
+ASSISTED_TRAMMING       = src_filter=+<src/feature/tramming.cpp> +<src/gcode/bedlevel/G35.cpp>
 HAS_MESH                = src_filter=+<src/gcode/bedlevel/G42.cpp>
 HAS_LEVELING            = src_filter=+<src/gcode/bedlevel/M420.cpp>
 DELTA_AUTO_CALIBRATION  = src_filter=+<src/gcode/calibrate/G33.cpp>

commit 84ab088b4093c997d3a3e005ca90bfd756839299
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Tue Dec 29 02:16:38 2020 -0300

    USB FD via native USB Host + MSC (#20571)

diff --git a/platformio.ini b/platformio.ini
index 2aff7aad23..3e87968eef 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -59,7 +59,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/extui/anycubic_i3mega_lcd.cpp> -<src/lcd/extui/lib/anycubic_i3mega>
   -<src/lcd/lcdprint.cpp>
   -<src/lcd/touch/touch_buttons.cpp>
-  -<src/sd/usb_flashdrive>
+  -<src/sd/usb_flashdrive/lib-uhs2> -<src/sd/usb_flashdrive/lib-uhs3>
   -<src/HAL/shared/backtrace>
   -<src/feature/babystep.cpp>
   -<src/feature/backlash.cpp>
@@ -272,7 +272,8 @@ HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus> +<src/lcd/extui/d
 TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
 EXTUI_EXAMPLE           = src_filter=+<src/lcd/extui/example.cpp>
 MALYAN_LCD              = src_filter=+<src/lcd/extui/malyan_lcd.cpp>
-USB_FLASH_DRIVE_SUPPORT = src_filter=+<src/sd/usb_flashdrive>
+USE_UHS2_USB            = src_filter=+<src/sd/usb_flashdrive/lib-uhs2>
+USE_UHS3_USB            = src_filter=+<src/sd/usb_flashdrive/lib-uhs3>
 AUTO_BED_LEVELING_BILINEAR = src_filter=+<src/feature/bedlevel/abl>
 AUTO_BED_LEVELING_(3POINT|(BI)?LINEAR) = src_filter=+<src/gcode/bedlevel/abl>
 MESH_BED_LEVELING       = src_filter=+<src/feature/bedlevel/mbl> +<src/gcode/bedlevel/mbl>
@@ -1278,6 +1279,23 @@ extra_scripts     = ${common.extra_scripts}
 debug_tool        = stlink
 debug_init_break  =
 
+#
+# USB Flash Drive mix-ins for STM32
+#
+[stm32_flash_drive]
+platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc.zip
+build_flags       = ${common_stm32.build_flags}
+  -DHAL_PCD_MODULE_ENABLED -DHAL_HCD_MODULE_ENABLED
+  -DUSBHOST -DUSBH_IRQ_PRIO=3 -DUSBH_IRQ_SUBPRIO=4
+
+#
+# BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4) with USB Flash Drive Support
+#
+[env:BIGTREE_SKR_PRO_usb_flash_drive]
+extends           = env:BIGTREE_SKR_PRO
+platform_packages = ${stm32_flash_drive.platform_packages}
+build_flags       = ${stm32_flash_drive.build_flags}
+
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
 #
@@ -1290,6 +1308,14 @@ extra_scripts     = ${common.extra_scripts}
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
 
+#
+# Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4) with USB Flash Drive Support
+#
+[env:BIGTREE_GTR_V1_0_usb_flash_drive]
+extends           = env:BIGTREE_GTR_V1_0
+platform_packages = ${stm32_flash_drive.platform_packages}
+build_flags       = ${stm32_flash_drive.build_flags}
+
 #
 # BigTreeTech BTT002 V1.0 (STM32F407VGT6 ARM Cortex-M4)
 #
@@ -1392,13 +1418,16 @@ extra_scripts        = ${common.extra_scripts}
 #
 [env:mks_robin_pro2]
 platform             = ${common_stm32.platform}
+platform_packages    = ${stm32_flash_drive.platform_packages}
 extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} -DHAL_HCD_MODULE_ENABLED -DUSBHOST
+build_flags          = ${stm32_flash_drive.build_flags}
 board                = genericSTM32F407VET6
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.ldscript = ldscript.ld
 board_build.firmware = firmware.bin
+board_build.offset   = 0x0000
+board_upload.offset_address = 0x08000000
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
 debug_tool           = jlink
 upload_protocol      = jlink
@@ -1427,6 +1456,21 @@ extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 
+#
+# MKS Robin Nano V3 with USB Flash Drive Support
+# Currently, using a STM32duino fork, until USB Host get merged
+#
+[env:mks_robin_nano_v3_usb_flash_drive]
+extends           = env:mks_robin_nano_v3
+platform_packages = ${stm32_flash_drive.platform_packages}
+build_flags       = ${stm32_flash_drive.build_flags}
+  -DUSBCON
+  -DUSE_USBHOST_HS
+  -DUSBD_IRQ_PRIO=5
+  -DUSBD_IRQ_SUBPRIO=6
+  -DUSE_USB_HS_IN_FS
+  -DUSBD_USE_CDC
+
 #################################
 #                               #
 #      Other Architectures      #

commit 28a3d95cda797bd585f8f2dce5966bbc021bfdd3
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Mon Dec 28 02:14:08 2020 -0300

    Use ADC_RESOLUTION 12 for all STM32 (#20562)

diff --git a/platformio.ini b/platformio.ini
index 924da69a74..2aff7aad23 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -725,6 +725,7 @@ build_flags   = ${common.build_flags}
   -std=gnu++14
   -DUSBCON -DUSBD_USE_CDC
   -DTIM_IRQ_PRIO=13
+  -DADC_RESOLUTION=12
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32> +<src/HAL/shared/backtrace>
 

commit 2ce9fa4b9c960fef703dc0d5cf31b0d312737a74
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Mon Dec 28 02:08:06 2020 -0300

    Better defaults, compatibility for SDIO + STM32 (#20570)

diff --git a/platformio.ini b/platformio.ini
index a95647cf42..924da69a74 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -973,7 +973,7 @@ board_build.offset   = 0x7000
 board_build.encrypt  = Yes
 board_build.firmware = Robin.bin
 build_flags          = ${common_stm32.build_flags}
-  -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8 -DTIMER_SERIAL=TIM5
+  -DENABLE_HWSERIAL3 -DTIMER_SERIAL=TIM5
 build_unflags        = ${common_stm32.build_unflags}
  -DUSBCON -DUSBD_USE_CDC
 extra_scripts        = ${common.extra_scripts}
@@ -1149,7 +1149,7 @@ upload_protocol = jlink
 [env:flsun_hispeedv1]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} -DMCU_STM32F103VE -DSS_TIMER=4 -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
+build_flags          = ${common_stm32.build_flags} -DMCU_STM32F103VE -DSS_TIMER=4 -DENABLE_HWSERIAL3
 board                = genericSTM32F103VE
 board_build.core     = stm32
 board_build.variant  = MARLIN_F103Vx
@@ -1321,7 +1321,7 @@ extra_scripts       = ${common.extra_scripts}
 build_flags         = ${common_stm32.build_flags}
   -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
   -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
-  -DTRANSFER_CLOCK_DIV=8 -DHAL_SRAM_MODULE_ENABLED
+  -DHAL_SRAM_MODULE_ENABLED
 build_unflags       = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 
 #
@@ -1369,7 +1369,7 @@ monitor_speed   = 500000
 [env:mks_robin_nano35_stm32]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} -DMCU_STM32F103VE -DSS_TIMER=4 -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
+build_flags          = ${common_stm32.build_flags} -DMCU_STM32F103VE -DSS_TIMER=4 -DENABLE_HWSERIAL3
 board                = genericSTM32F103VE
 board_build.core     = stm32
 board_build.variant  = MARLIN_F103Vx

commit 4d6b6bcffc5082de84614aea0bdd2b280f503430
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Wed Dec 23 23:01:21 2020 -0300

    LVGL and Classic UI for STM32 (#20552)

diff --git a/platformio.ini b/platformio.ini
index bf44808b32..a95647cf42 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -970,6 +970,7 @@ board_build.core     = stm32
 board_build.variant  = MARLIN_F103Zx
 board_build.ldscript = ldscript.ld
 board_build.offset   = 0x7000
+board_build.encrypt  = Yes
 board_build.firmware = Robin.bin
 build_flags          = ${common_stm32.build_flags}
   -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8 -DTIMER_SERIAL=TIM5
@@ -1155,6 +1156,7 @@ board_build.variant  = MARLIN_F103Vx
 board_build.ldscript = ldscript.ld
 board_build.offset   = 0x7000
 board_build.firmware = Robin_mini.bin
+board_build.encrypt  = Yes
 board_upload.offset_address = 0x08007000
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
 extra_scripts        = ${common.extra_scripts}
@@ -1247,6 +1249,8 @@ board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.ldscript = ldscript.ld
 board_build.firmware = firmware.srec
+# Just anet_et4_openblt.py generates the file, not stm32_bootloader.py
+board_build.encrypt  = Yes
 board_build.offset   = 0x10000
 board_upload.offset_address = 0x08010000
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
@@ -1255,6 +1259,7 @@ upload_protocol      = jlink
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+  buildroot/share/PlatformIO/scripts/anet_et4_openblt.py
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
@@ -1304,19 +1309,20 @@ extra_scripts     = ${common.extra_scripts}
 # Lerdge base
 #
 [lerdge_common]
-platform           = ${common_stm32.platform}
-extends            = common_stm32
-board              = LERDGE
-board_build.offset = 0x10000
-extra_scripts      = ${common.extra_scripts}
-                     pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
-                     buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-                     buildroot/share/PlatformIO/scripts/lerdge.py
-build_flags        = ${common_stm32.build_flags}
+platform            = ${common_stm32.platform}
+extends             = common_stm32
+board               = LERDGE
+board_build.offset  = 0x10000
+board_build.encrypt = Yes
+extra_scripts       = ${common.extra_scripts}
+                      pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
+                      buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+                      buildroot/share/PlatformIO/scripts/lerdge.py
+build_flags         = ${common_stm32.build_flags}
   -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
   -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
   -DTRANSFER_CLOCK_DIV=8 -DHAL_SRAM_MODULE_ENABLED
-build_unflags      = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
+build_unflags       = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 
 #
 # Lerdge X
@@ -1369,6 +1375,7 @@ board_build.core     = stm32
 board_build.variant  = MARLIN_F103Vx
 board_build.ldscript = ldscript.ld
 board_build.offset   = 0x7000
+board_build.encrypt  = Yes
 board_build.firmware = Robin_nano35.bin
 board_upload.offset_address = 0x08007000
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
@@ -1385,19 +1392,18 @@ extra_scripts        = ${common.extra_scripts}
 [env:mks_robin_pro2]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} -DHAL_HCD_MODULE_ENABLED  -DUSBHOST -DARDUINO_BLACK_F407VE
+build_flags          = ${common_stm32.build_flags} -DHAL_HCD_MODULE_ENABLED -DUSBHOST
 board                = genericSTM32F407VET6
 board_build.core     = stm32
-board_build.variant  = MARLIN_F407VE
+board_build.variant  = MARLIN_F4x7Vx
 board_build.ldscript = ldscript.ld
-board_build.firmware = Robin_nano35.bin
+board_build.firmware = firmware.bin
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
 debug_tool           = jlink
 upload_protocol      = jlink
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-  buildroot/share/PlatformIO/scripts/mks_encrypt.py
 
 #
 # MKS Robin Nano V3
@@ -1419,7 +1425,6 @@ upload_protocol      = jlink
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-  buildroot/share/PlatformIO/scripts/mks_encrypt.py
 
 #################################
 #                               #

commit cfad5cb4356f90179eef636ec6c27db242227fff
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Tue Dec 22 09:57:11 2020 -0300

    Unify FYSETC F6 1.3 / 1.4 (#20507)
    
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/platformio.ini b/platformio.ini
index 0b2e7c0915..bf44808b32 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -505,20 +505,12 @@ extends  = common_avr8
 board    = reprap_rambo
 
 #
-# FYSETC F6 V1.3
+# FYSETC F6 V1.3 / V1.4
 #
-[env:FYSETC_F6_13]
+[env:FYSETC_F6]
 platform = atmelavr
 extends  = common_avr8
-board    = fysetc_f6_13
-
-#
-# FYSETC F6 V1.4
-#
-[env:FYSETC_F6_14]
-platform = atmelavr
-extends  = common_avr8
-board    = fysetc_f6_14
+board    = fysetc_f6
 
 #
 # Sanguinololu (ATmega644p)

commit a0c8d348a0baa179a13bc47be6edce4bb652dac9
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Tue Dec 22 04:51:29 2020 -0800

    Anet ET4 / ET4P and Anet TFT28 / TFT35 (#20280)

diff --git a/platformio.ini b/platformio.ini
index acb5990edb..0b2e7c0915 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1241,6 +1241,29 @@ build_flags       = ${common_stm32.build_flags}
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
+#
+# Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
+# For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
+# Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
+#
+[env:Anet_ET4_OpenBLT]
+platform             = ${common_stm32.platform}
+extends              = common_stm32
+build_flags          = ${common_stm32.build_flags} -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
+board                = genericSTM32F407VGT6
+board_build.core     = stm32
+board_build.variant  = MARLIN_F4x7Vx
+board_build.ldscript = ldscript.ld
+board_build.firmware = firmware.srec
+board_build.offset   = 0x10000
+board_upload.offset_address = 0x08010000
+build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
+debug_tool           = jlink
+upload_protocol      = jlink
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #

commit 5e3be83dbbfc0ee60a6b43246b998616c4d05ae5
Author: Jason Smith <jason.inet@gmail.com>
Date:   Tue Dec 22 04:02:25 2020 -0800

    Overrides to prevent STM32 timer conflicts (#20545)

diff --git a/platformio.ini b/platformio.ini
index e7f22e3f09..acb5990edb 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -980,7 +980,7 @@ board_build.ldscript = ldscript.ld
 board_build.offset   = 0x7000
 board_build.firmware = Robin.bin
 build_flags          = ${common_stm32.build_flags}
-  -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
+  -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8 -DTIMER_SERIAL=TIM5
 build_unflags        = ${common_stm32.build_unflags}
  -DUSBCON -DUSBD_USE_CDC
 extra_scripts        = ${common.extra_scripts}

commit 777c50a1ecd68c8b35531b654498e73bd5078b24
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Dec 20 00:38:10 2020 -0600

    Fix PIO typo

diff --git a/platformio.ini b/platformio.ini
index d907ee68d0..e7f22e3f09 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -486,7 +486,7 @@ build_flags         = ${common.build_flags} -fno-tree-scev-cprop -fno-split-wide
 [env:MightyBoard1280]
 platform = atmelavr
 extends  = mega_extended_optimized
-board    = megamega1280
+board    = megaatmega1280
 
 #
 # MightyBoard ATmega2560

commit 0a99f8feed0f8d486a17315ce7412f03f6f166cb
Author: Foxies <Foxies-CSTL@users.noreply.github.com>
Date:   Sun Dec 20 07:17:24 2020 +0100

    Migrate Hispeedv1 (QQS-Pro) to HAL/STM32 (#20354)

diff --git a/platformio.ini b/platformio.ini
index 11918bc35a..d907ee68d0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1150,18 +1150,25 @@ debug_tool      = jlink
 upload_protocol = jlink
 
 #
-# FLSUN QQ (STM32F103VET6)
+# FLSUN QQS Pro (STM32F103VET6) using hal STM32
+# board Hispeedv1
 #
-[env:flsun_hispeed]
-platform          = ${common_stm32f1.platform}
-extends           = common_stm32f1
-board             = genericSTM32F103VE
-extra_scripts     = ${common.extra_scripts}
-  buildroot/share/PlatformIO/scripts/mks_robin_mini.py
-  buildroot/share/PlatformIO/scripts/add_nanolib.py
-build_flags       = ${common_stm32f1.build_flags} -DMCU_STM32F103VE -DSS_TIMER=4
-lib_deps          = SoftwareSerialM
-  #Adafruit NeoPixel=https://github.com/Foxies-CSTL/Robin-NeoPixel-Lib/archive/master.zip
+[env:flsun_hispeedv1]
+platform             = ${common_stm32.platform}
+extends              = common_stm32
+build_flags          = ${common_stm32.build_flags} -DMCU_STM32F103VE -DSS_TIMER=4 -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
+board                = genericSTM32F103VE
+board_build.core     = stm32
+board_build.variant  = MARLIN_F103Vx
+board_build.ldscript = ldscript.ld
+board_build.offset   = 0x7000
+board_build.firmware = Robin_mini.bin
+board_upload.offset_address = 0x08007000
+build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+  buildroot/share/PlatformIO/scripts/mks_encrypt.py
 
 #
 # STM32F401VE

commit b167cd242754a6e451d5443416c30774bc969e4d
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Fri Dec 18 19:18:04 2020 -0300

    MKS Robin Nano V3 and STM32F4x0Vx Variant (#20430)

diff --git a/platformio.ini b/platformio.ini
index 2a0901d14d..11918bc35a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1377,6 +1377,28 @@ extra_scripts        = ${common.extra_scripts}
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
   buildroot/share/PlatformIO/scripts/mks_encrypt.py
 
+#
+# MKS Robin Nano V3
+#
+[env:mks_robin_nano_v3]
+platform             = ${common_stm32.platform}
+extends              = common_stm32
+build_flags          = ${common_stm32.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC
+board                = genericSTM32F407VGT6
+board_build.core     = stm32
+board_build.variant  = MARLIN_F4x7Vx
+board_build.ldscript = ldscript.ld
+board_build.firmware = Robin_nano_v3.bin
+board_build.offset   = 0xC000
+board_upload.offset_address = 0x0800C000
+build_unflags        = ${common_stm32.build_unflags}
+debug_tool           = jlink
+upload_protocol      = jlink
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+  buildroot/share/PlatformIO/scripts/mks_encrypt.py
+
 #################################
 #                               #
 #      Other Architectures      #

commit e9677594ea164319dea1c6cc2dc905237ad0dec4
Author: grauerfuchs <42082416+grauerfuchs@users.noreply.github.com>
Date:   Thu Dec 17 18:22:59 2020 -0500

    Fix and optimize MightyBoard (#20493)

diff --git a/platformio.ini b/platformio.ini
index 753140467c..2a0901d14d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -457,7 +457,6 @@ board    = megaatmega2560
 [env:mega2560ext]
 platform            = atmelavr
 extends             = env:mega2560
-board               = megaatmega2560
 board_build.variant = megaextendedpins
 extra_scripts       = ${common.extra_scripts}
                       pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
@@ -471,24 +470,31 @@ extends  = common_avr8
 board    = megaatmega1280
 
 #
-# MightyBoard ATmega2560 (MegaCore 100 pin boards variants)
+# MightyBoard AVR with extended pins
+#
+[mega_extended_optimized]
+extends             = common_avr8
+board_build.variant = megaextendedpins
+extra_scripts       = ${common.extra_scripts}
+                      pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
+upload_speed        = 57600
+build_flags         = ${common.build_flags} -fno-tree-scev-cprop -fno-split-wide-types -Wl,--relax -mcall-prologues
+
+#
+# MightyBoard ATmega1280
 #
 [env:MightyBoard1280]
-platform      = atmelavr
-extends       = common_avr8
-board         = ATmega1280
-upload_speed  = 57600
+platform = atmelavr
+extends  = mega_extended_optimized
+board    = megamega1280
 
 #
-# MightyBoard ATmega2560 (MegaCore 100 pin boards variants)
+# MightyBoard ATmega2560
 #
 [env:MightyBoard2560]
-platform                  = atmelavr
-extends                   = common_avr8
-board                     = ATmega2560
-upload_protocol           = wiring
-upload_speed              = 57600
-board_upload.maximum_size = 253952
+platform = atmelavr
+extends  = mega_extended_optimized
+board    = megaatmega2560
 
 #
 # RAMBo

commit 9fd358f10cccfacf210890e788fb8ddf73335bdd
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Mon Dec 14 22:36:25 2020 +0000

    LPC176x framework update (#20469)

diff --git a/platformio.ini b/platformio.ini
index e2f1388efd..753140467c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -683,7 +683,7 @@ debug_tool     = jlink
 #
 [common_LPC]
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.3.zip
-platform_packages = framework-arduino-lpc176x@^0.2.5
+platform_packages = framework-arduino-lpc176x@^0.2.6
 board             = nxp_lpc1768
 lib_ldf_mode      = off
 lib_compat_mode   = strict

commit 885b0d2ec5f431d07aced632746eec5e7e371b6d
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Dec 8 20:17:55 2020 -0600

    Style, spacing, typo cleanup for recent changes

diff --git a/platformio.ini b/platformio.ini
index a8b81d755e..e2f1388efd 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1355,10 +1355,10 @@ extra_scripts        = ${common.extra_scripts}
 # MKS Robin Pro V2
 #
 [env:mks_robin_pro2]
-platform      = ${common_stm32.platform}
-extends       = common_stm32
-build_flags   = ${common_stm32.build_flags} -DHAL_HCD_MODULE_ENABLED  -DUSBHOST -DARDUINO_BLACK_F407VE
-board         = genericSTM32F407VET6
+platform             = ${common_stm32.platform}
+extends              = common_stm32
+build_flags          = ${common_stm32.build_flags} -DHAL_HCD_MODULE_ENABLED  -DUSBHOST -DARDUINO_BLACK_F407VE
+board                = genericSTM32F407VET6
 board_build.core     = stm32
 board_build.variant  = MARLIN_F407VE
 board_build.ldscript = ldscript.ld

commit 9ead6a30f2876700413802d2d1445b9a33f05838
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Tue Dec 8 02:26:39 2020 -0300

    SPI TFT for STM32F4 boards (#20384)
    
    * fix pinsDebug for F1 boards
    
    * add MKS Robin PRO V2 board - development board
    
    * tft spi working with F4 boards
    
    * pins formating
    
    * sanity check for TFT on supported cores in STM32
    
    * Fix tabs/spaces in pins file
    
    Co-authored-by: Jason Smith <jason.inet@gmail.com>

diff --git a/platformio.ini b/platformio.ini
index 237634a454..a8b81d755e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1351,6 +1351,26 @@ extra_scripts        = ${common.extra_scripts}
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
   buildroot/share/PlatformIO/scripts/mks_encrypt.py
 
+#
+# MKS Robin Pro V2
+#
+[env:mks_robin_pro2]
+platform      = ${common_stm32.platform}
+extends       = common_stm32
+build_flags   = ${common_stm32.build_flags} -DHAL_HCD_MODULE_ENABLED  -DUSBHOST -DARDUINO_BLACK_F407VE
+board         = genericSTM32F407VET6
+board_build.core     = stm32
+board_build.variant  = MARLIN_F407VE
+board_build.ldscript = ldscript.ld
+board_build.firmware = Robin_nano35.bin
+build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
+debug_tool           = jlink
+upload_protocol      = jlink
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+  buildroot/share/PlatformIO/scripts/mks_encrypt.py
+
 #################################
 #                               #
 #      Other Architectures      #

commit 1a04c8c7bb65a4802bc5fedad442b4d1bfc41a89
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Sun Dec 6 17:36:36 2020 -0300

    Avoid invalid memory optimizations (#20389)
    
    When building for AVR, merge-all-constants can incorrectly combine constants stored in flash with constants stored in RAM. These have different access requirements, leading to undefined behavior during execution.
    Co-authored-by: ellensp <ellensp@hotmail.com>

diff --git a/platformio.ini b/platformio.ini
index 0cff2dac60..237634a454 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -203,7 +203,7 @@ extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
   post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
-build_flags        = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
+build_flags        = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-constants
 lib_deps           =
 
 #

commit 31352f8a8a4f1019d235b9c48048676828fa5e5a
Author: ellensp <ellensp@hotmail.com>
Date:   Thu Dec 3 23:44:33 2020 +1300

    Fix up start, monitor baud (#20326)

diff --git a/platformio.ini b/platformio.ini
index b26ece4026..0cff2dac60 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -405,7 +405,7 @@ framework     = arduino
 extra_scripts = ${common.extra_scripts}
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-monitor_speed = 115200
+monitor_speed = 250000
 monitor_flags =
   --quiet
   --echo

commit 753cf994b6d529da9c8dd710a24a96b0388425ee
Author: Mathias Rasmussen <mathiasvr@gmail.com>
Date:   Wed Dec 2 06:51:04 2020 +0100

    Update to STM32 v10, optimize build (#20325)

diff --git a/platformio.ini b/platformio.ini
index 52310e6b81..b26ece4026 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -722,7 +722,7 @@ board    = nxp_lpc1769
 # HAL/STM32 Base Environment values
 #
 [common_stm32]
-platform      = ststm32@~8.0
+platform      = ststm32@~10.0
 build_flags   = ${common.build_flags}
   -std=gnu++14
   -DUSBCON -DUSBD_USE_CDC
@@ -734,14 +734,17 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32> +<src/HAL/shared/b
 # HAL/STM32F1 Common Environment values
 #
 [common_stm32f1]
-platform      = ststm32@~6.1
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
+platform          = ststm32@~10.0
+board_build.core  = maple
+build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags}
-build_unflags = -std=gnu11 -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore    = SPI
-lib_deps      = ${common.lib_deps}
+  -DARDUINO_ARCH_STM32
+build_unflags     = -std=gnu11 -std=gnu++11
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
+lib_ignore        = SPI, FreeRTOS701, FreeRTOS821
+lib_deps          = ${common.lib_deps}
   SoftwareSerialM
+platform_packages = tool-stm32duino
 
 #
 # STM32F103RC
@@ -750,7 +753,6 @@ lib_deps      = ${common.lib_deps}
 platform          = ${common_stm32f1.platform}
 extends           = common_stm32f1
 board             = genericSTM32F103RC
-platform_packages = tool-stm32duino
 monitor_speed     = 115200
 
 #
@@ -760,7 +762,6 @@ monitor_speed     = 115200
 platform          = ${common_stm32f1.platform}
 extends           = common_stm32f1
 board             = MEEB_3DP
-platform_packages = tool-stm32duino
 build_flags       = ${common_stm32f1.build_flags}
                     -DDEBUG_LEVEL=0
                     -DSS_TIMER=4
@@ -842,7 +843,6 @@ lib_deps          = ${env:STM32F103RC_btt_512K.lib_deps}
 platform          = ${common_stm32f1.platform}
 extends           = common_stm32f1
 board             = genericSTM32F103RE
-platform_packages = tool-stm32duino
 monitor_speed     = 115200
 
 #
@@ -922,7 +922,6 @@ build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE -DSTM32F1xx -USERIAL_USB -DU20 -DTS_V12
 build_unflags = ${common_stm32f1.build_unflags}
   -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
-lib_ignore    = ${common_stm32f1.lib_ignore}
 
 #
 # MKS Robin Mini (STM32F103VET6)
@@ -943,7 +942,6 @@ build_flags   = ${common_stm32f1.build_flags}
 platform        = ${common_stm32f1.platform}
 extends         = common_stm32f1
 board           = genericSTM32F103VE
-platform_packages = tool-stm32duino
 extra_scripts   = ${common.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_nano35.py
 build_flags     = ${common_stm32f1.build_flags}
@@ -1024,7 +1022,6 @@ build_flags   = ${common_stm32f1.build_flags}
 platform        = ${common_stm32f1.platform}
 extends         = common_stm32f1
 board           = genericSTM32F103VE
-platform_packages = tool-stm32duino
 extra_scripts   = ${common.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_e3p.py
 build_flags     = ${common_stm32f1.build_flags}
@@ -1153,7 +1150,6 @@ upload_protocol = jlink
 platform          = ${common_stm32f1.platform}
 extends           = common_stm32f1
 board             = genericSTM32F103VE
-platform_packages = tool-stm32duino
 extra_scripts     = ${common.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_mini.py
   buildroot/share/PlatformIO/scripts/add_nanolib.py
@@ -1195,7 +1191,6 @@ extra_scripts     = ${common.extra_scripts}
 platform          = ${common_stm32f1.platform}
 extends           = common_stm32f1
 board             = genericSTM32F103RC
-platform_packages = tool-stm32duino
 extra_scripts     = ${common.extra_scripts}
  buildroot/share/PlatformIO/scripts/fly_mini.py
 build_flags       = ${common_stm32f1.build_flags}

commit b6a32500c401877e3ee1300fa613e81086bb31d3
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Thu Nov 26 21:18:40 2020 -0600

    M808 Repeat Markers (#20084)

diff --git a/platformio.ini b/platformio.ini
index 062514c882..52310e6b81 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -101,6 +101,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/power_monitor.cpp> -<src/gcode/feature/power_monitor>
   -<src/feature/powerloss.cpp> -<src/gcode/feature/powerloss>
   -<src/feature/probe_temp_comp.cpp>
+  -<src/feature/repeat.cpp>
   -<src/feature/runout.cpp> -<src/gcode/feature/runout>
   -<src/feature/solenoid.cpp> -<src/gcode/control/M380_M381.cpp>
   -<src/feature/spindle_laser.cpp> -<src/gcode/control/M3-M5.cpp>
@@ -182,6 +183,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/scara>
   -<src/gcode/sd>
   -<src/gcode/sd/M32.cpp>
+  -<src/gcode/sd/M808.cpp>
   -<src/gcode/temp/M104_M109.cpp>
   -<src/gcode/temp/M155.cpp>
   -<src/gcode/units/G20_G21.cpp>
@@ -374,6 +376,7 @@ G38_PROBE_TARGET        = src_filter=+<src/gcode/probe/G38.cpp>
 MAGNETIC_PARKING_EXTRUDER = src_filter=+<src/gcode/probe/M951.cpp>
 SDSUPPORT               = src_filter=+<src/gcode/sd>
 HAS_MEDIA_SUBCALLS      = src_filter=+<src/gcode/sd/M32.cpp>
+GCODE_REPEAT_MARKERS    = src_filter=+<src/feature/repeat.cpp> +<src/gcode/sd/M808.cpp>
 HAS_EXTRUDERS           = src_filter=+<src/gcode/temp/M104_M109.cpp> +<src/gcode/config/M221.cpp>
 AUTO_REPORT_TEMPERATURES = src_filter=+<src/gcode/temp/M155.cpp>
 INCH_MODE_SUPPORT       = src_filter=+<src/gcode/units/G20_G21.cpp>
@@ -402,7 +405,7 @@ framework     = arduino
 extra_scripts = ${common.extra_scripts}
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-monitor_speed = 250000
+monitor_speed = 115200
 monitor_flags =
   --quiet
   --echo

commit 3a396a25dc9e33be2c18a1bdc23600295e42c82e
Author: Jason Smith <jason.inet@gmail.com>
Date:   Wed Nov 25 22:37:18 2020 -0800

    Retire HAL for STM32F4 / F7 (#20153)

diff --git a/platformio.ini b/platformio.ini
index 9fb4904020..062514c882 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -863,22 +863,13 @@ lib_deps          = ${common_stm32f1.lib_deps}
   USBComposite for STM32F1@0.91
 
 #
-# STM32F4 with STM32GENERIC
+# REMRAM_V1
 #
-[env:STM32F4]
-platform      = ${common_stm32.platform}
-board         = disco_f407vg
-build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/STM32_F4_F7/STM32F7>
-
-#
-# STM32F7 with STM32GENERIC
-#
-[env:STM32F7]
+[env:REMRAM_V1]
 platform      = ${common_stm32.platform}
+extends       = common_stm32
 board         = remram_v1
-build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/STM32_F4_F7/STM32F4>
+build_flags   = ${common_stm32.build_flags}
 
 #
 # ST NUCLEO-F767ZI Development Board

commit b3bd47b4b2d966af1241d63768c151559222cf78
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Nov 20 17:41:01 2020 -0600

    Printrboard labels

diff --git a/platformio.ini b/platformio.ini
index 862c42b01b..9fb4904020 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -587,8 +587,8 @@ lib_ignore = ${env:common_avr8.lib_ignore}, Teensy_ADC, NativeEthernet
 
 #
 # AT90USB1286 boards using DFU bootloader
-# - PrintrBoard
-# - PrintrBoard Rev.F
+# - Printrboard
+# - Printrboard Rev.F
 # - ? 5DPRINT ?
 #
 [env:at90usb1286_dfu]

commit 41529b65988a58ba512977e0fe1692aaeeb6c811
Author: Giuliano Zaro <3684609+GMagician@users.noreply.github.com>
Date:   Wed Nov 18 08:27:21 2020 +0100

    SMUFF (MMU2 clone) support (#19912)

diff --git a/platformio.ini b/platformio.ini
index 1e0b84b625..862c42b01b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -93,7 +93,8 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/leds/tempstat.cpp>
   -<src/feature/max7219.cpp>
   -<src/feature/mixing.cpp>
-  -<src/feature/mmu2> -<src/gcode/feature/prusa_MMU2>
+  -<src/feature/mmu/mmu.cpp>
+  -<src/feature/mmu/mmu2.cpp> -<src/gcode/feature/prusa_MMU2>
   -<src/feature/password> -<src/gcode/feature/password>
   -<src/feature/pause.cpp>
   -<src/feature/power.cpp>
@@ -101,7 +102,6 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/powerloss.cpp> -<src/gcode/feature/powerloss>
   -<src/feature/probe_temp_comp.cpp>
   -<src/feature/runout.cpp> -<src/gcode/feature/runout>
-  -<src/feature/snmm.cpp>
   -<src/feature/solenoid.cpp> -<src/gcode/control/M380_M381.cpp>
   -<src/feature/spindle_laser.cpp> -<src/gcode/control/M3-M5.cpp>
   -<src/feature/tmc_util.cpp> -<src/module/stepper/trinamic.cpp>
@@ -304,7 +304,8 @@ PRINTER_EVENT_LEDS      = src_filter=+<src/feature/leds/printer_event_leds.cpp>
 TEMP_STAT_LEDS          = src_filter=+<src/feature/leds/tempstat.cpp>
 MAX7219_DEBUG           = src_filter=+<src/feature/max7219.cpp> +<src/gcode/feature/leds/M7219.cpp>
 MIXING_EXTRUDER         = src_filter=+<src/feature/mixing.cpp> +<src/gcode/feature/mixing/M163-M165.cpp>
-PRUSA_MMU2              = src_filter=+<src/feature/mmu2> +<src/gcode/feature/prusa_MMU2>
+HAS_PRUSA_MMU1          = src_filter=+<src/feature/mmu/mmu.cpp>
+HAS_PRUSA_MMU2          = src_filter=+<src/feature/mmu/mmu2.cpp> +<src/gcode/feature/prusa_MMU2>
 PASSWORD_FEATURE        = src_filter=+<src/feature/password> +<src/gcode/feature/password>
 ADVANCED_PAUSE_FEATURE  = src_filter=+<src/feature/pause.cpp> +<src/gcode/feature/pause/M600.cpp> +<src/gcode/feature/pause/M603.cpp>
 AUTO_POWER_CONTROL      = src_filter=+<src/feature/power.cpp>
@@ -312,8 +313,7 @@ HAS_POWER_MONITOR       = src_filter=+<src/feature/power_monitor.cpp> +<src/gcod
 POWER_LOSS_RECOVERY     = src_filter=+<src/feature/powerloss.cpp> +<src/gcode/feature/powerloss>
 PROBE_TEMP_COMPENSATION = src_filter=+<src/feature/probe_temp_comp.cpp> +<src/gcode/calibrate/G76_M192_M871.cpp>
 HAS_FILAMENT_SENSOR     = src_filter=+<src/feature/runout.cpp> +<src/gcode/feature/runout>
-MK2_MULTIPLEXER         = src_filter=+<src/feature/snmm.cpp>
-EXT_SOLENOID|MANUAL_SOLENOID_CONTROL = src_filter=+<src/feature/solenoid.cpp> +<src/gcode/control/M380_M381.cpp>
+(EXT|MANUAL)_SOLENOID.* = src_filter=+<src/feature/solenoid.cpp> +<src/gcode/control/M380_M381.cpp>
 HAS_CUTTER              = src_filter=+<src/feature/spindle_laser.cpp> +<src/gcode/control/M3-M5.cpp>
 EXPERIMENTAL_I2CBUS     = src_filter=+<src/feature/twibus.cpp> +<src/gcode/feature/i2c>
 MECHANICAL_GANTRY_CAL.+ = src_filter=+<src/gcode/calibrate/G34.cpp>

commit b57ca6e4accb8d438fa3277de80448fbe9b01823
Author: ellensp <ellensp@hotmail.com>
Date:   Tue Nov 17 21:45:43 2020 +1300

    add ethernet to src filter (#20136)
    
    Co-authored-by: ellensp <ellensp@ellensp-HP-ProBook-6470b.fritz.box>

diff --git a/platformio.ini b/platformio.ini
index 626c7d2bec..1e0b84b625 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -77,6 +77,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/direct_stepping.cpp> -<src/gcode/motion/G6.cpp>
   -<src/feature/e_parser.cpp>
   -<src/feature/encoder_i2c.cpp>
+  -<src/feature/ethernet.cpp>
   -<src/feature/fanmux.cpp>
   -<src/feature/filwidth.cpp> -<src/gcode/feature/filwidth>
   -<src/feature/fwretract.cpp> -<src/gcode/feature/fwretract>

commit ea371618da71dc43e6aee95a8e479c8797867e04
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Sun Nov 15 19:39:58 2020 -0300

    Add Touch Calibration screen (#20049)

diff --git a/platformio.ini b/platformio.ini
index 932d19075d..626c7d2bec 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -236,7 +236,7 @@ HAS_SPI_TFT             = src_filter=+<src/HAL/STM32/tft/tft_spi.cpp> +<src/HAL/
 HAS_GRAPHICAL_TFT       = src_filter=+<src/lcd/tft>
 DWIN_CREALITY_LCD       = src_filter=+<src/lcd/dwin>
 IS_TFTGLCD_PANEL        = src_filter=+<src/lcd/TFTGLCD>
-HAS_TOUCH_XPT2046       = src_filter=+<src/lcd/touch/touch_buttons.cpp>
+HAS_TOUCH_BUTTONS       = src_filter=+<src/lcd/touch/touch_buttons.cpp>
 HAS_LCD_MENU            = src_filter=+<src/lcd/menu>
 HAS_GAMES               = src_filter=+<src/lcd/menu/game/game.cpp>
 MARLIN_BRICKOUT         = src_filter=+<src/lcd/menu/game/brickout.cpp>

commit 1b0a5abd73d162b68b2881486630f60a1e9e7825
Author: InsanityAutomation <38436470+InsanityAutomation@users.noreply.github.com>
Date:   Thu Nov 12 23:54:18 2020 -0500

    G34 Z stepper locking (#20091)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 360a02f420..932d19075d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -316,6 +316,7 @@ EXT_SOLENOID|MANUAL_SOLENOID_CONTROL = src_filter=+<src/feature/solenoid.cpp> +<
 HAS_CUTTER              = src_filter=+<src/feature/spindle_laser.cpp> +<src/gcode/control/M3-M5.cpp>
 EXPERIMENTAL_I2CBUS     = src_filter=+<src/feature/twibus.cpp> +<src/gcode/feature/i2c>
 MECHANICAL_GANTRY_CAL.+ = src_filter=+<src/gcode/calibrate/G34.cpp>
+Z_MULTI_ENDSTOPS        = src_filter=+<src/gcode/calibrate/G34_M422.cpp>
 Z_STEPPER_AUTO_ALIGN    = src_filter=+<src/feature/z_stepper_align.cpp> +<src/gcode/calibrate/G34_M422.cpp>
 G26_MESH_VALIDATION     = src_filter=+<src/gcode/bedlevel/G26.cpp>
 ASSISTED_TRAMMING       = src_filter=+<src/gcode/bedlevel/G35.cpp>

commit 40d442fde294faedf839e3a80c82cd72c1824ba8
Author: JoAnn Manges <joannmanges@gmail.com>
Date:   Wed Nov 11 16:52:35 2020 -0500

    Fix MAX31865 on SPI (PT100/1000) support (#20074)

diff --git a/platformio.ini b/platformio.ini
index 15b8d4c23a..360a02f420 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -222,7 +222,7 @@ HAS_L64XX               = Arduino-L6470@0.8.0
                           src_filter=+<src/libs/L64XX> +<src/module/stepper/L64xx.cpp> +<src/gcode/feature/L6470>
 NEOPIXEL_LED            = Adafruit NeoPixel@1.5.0
                           src_filter=+<src/feature/leds/neopixel.cpp>
-MAX6675_IS_MAX31865     = Adafruit MAX31865 library@~1.1.0
+MAX6675_._IS_MAX31865   = Adafruit MAX31865 library@~1.1.0
 USES_LIQUIDCRYSTAL      = LiquidCrystal@1.5.0
 USES_LIQUIDCRYSTAL_I2C  = marcoschwartz/LiquidCrystal_I2C@1.1.4
 USES_LIQUIDTWI2         = LiquidTWI2@1.2.7

commit f17394d67740e1f5591b3e0e23cc7313b218776d
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon Nov 9 18:53:19 2020 -0600

    Ability to disable M32

diff --git a/platformio.ini b/platformio.ini
index af7ce47a50..15b8d4c23a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -180,6 +180,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/probe/M951.cpp>
   -<src/gcode/scara>
   -<src/gcode/sd>
+  -<src/gcode/sd/M32.cpp>
   -<src/gcode/temp/M104_M109.cpp>
   -<src/gcode/temp/M155.cpp>
   -<src/gcode/units/G20_G21.cpp>
@@ -370,6 +371,7 @@ Z_PROBE_SLED            = src_filter=+<src/gcode/probe/G31_G32.cpp>
 G38_PROBE_TARGET        = src_filter=+<src/gcode/probe/G38.cpp>
 MAGNETIC_PARKING_EXTRUDER = src_filter=+<src/gcode/probe/M951.cpp>
 SDSUPPORT               = src_filter=+<src/gcode/sd>
+HAS_MEDIA_SUBCALLS      = src_filter=+<src/gcode/sd/M32.cpp>
 HAS_EXTRUDERS           = src_filter=+<src/gcode/temp/M104_M109.cpp> +<src/gcode/config/M221.cpp>
 AUTO_REPORT_TEMPERATURES = src_filter=+<src/gcode/temp/M155.cpp>
 INCH_MODE_SUPPORT       = src_filter=+<src/gcode/units/G20_G21.cpp>

commit 6954772ece00a5fa2fdd327a6af1a0d593d22723
Author: Speaka <48431623+Speaka@users.noreply.github.com>
Date:   Sat Nov 7 10:20:27 2020 +0100

    Tramming Wizard submenu option (#20000)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 07edbf3918..af7ce47a50 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -48,6 +48,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/menu/menu_temperature.cpp>
   -<src/lcd/menu/menu_tmc.cpp>
   -<src/lcd/menu/menu_touch_screen.cpp>
+  -<src/lcd/menu/menu_tramming.cpp>
   -<src/lcd/menu/menu_ubl.cpp>
   -<src/lcd/extui/lib/mks_ui>
   -<src/lcd/extui/lib/dgus> -<src/lcd/extui/dgus_lcd.cpp>
@@ -259,6 +260,7 @@ HAS_MENU_CUTTER         = src_filter=+<src/lcd/menu/menu_spindle_laser.cpp>
 HAS_MENU_TEMPERATURE    = src_filter=+<src/lcd/menu/menu_temperature.cpp>
 HAS_MENU_TMC            = src_filter=+<src/lcd/menu/menu_tmc.cpp>
 HAS_MENU_TOUCH_SCREEN   = src_filter=+<src/lcd/menu/menu_touch_screen.cpp>
+HAS_MENU_TRAMMING       = src_filter=+<src/lcd/menu/menu_tramming.cpp>
 HAS_MENU_UBL            = src_filter=+<src/lcd/menu/menu_ubl.cpp>
 ANYCUBIC_LCD_CHIRON     = src_filter=+<src/lcd/extui/anycubic_chiron_lcd.cpp> +<src/lcd/extui/lib/anycubic_chiron>
 ANYCUBIC_LCD_I3MEGA     = src_filter=+<src/lcd/extui/anycubic_i3mega_lcd.cpp> +<src/lcd/extui/lib/anycubic_i3mega>

commit 53cc8a0d6eca6ca306208eb44914241ec80a185b
Author: Darren Horrocks <killallthehumans@gmail.com>
Date:   Sat Nov 7 08:43:51 2020 +0000

    Optimized (non-optiboot) Melzi env (#20021)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 7ab0755cdc..07edbf3918 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -434,9 +434,9 @@ src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
 # ATmega2560
 #
 [env:mega2560]
-platform            = atmelavr
-extends             = common_avr8
-board               = megaatmega2560
+platform = atmelavr
+extends  = common_avr8
+board    = megaatmega2560
 
 #
 # ATmega2560 with extended pins 70-85 defined
@@ -457,9 +457,9 @@ extra_scripts       = ${common.extra_scripts}
 # ATmega1280
 #
 [env:mega1280]
-platform      = atmelavr
-extends       = common_avr8
-board         = megaatmega1280
+platform = atmelavr
+extends  = common_avr8
+board    = megaatmega1280
 
 #
 # MightyBoard ATmega2560 (MegaCore 100 pin boards variants)
@@ -474,81 +474,97 @@ upload_speed  = 57600
 # MightyBoard ATmega2560 (MegaCore 100 pin boards variants)
 #
 [env:MightyBoard2560]
-platform      = atmelavr
-extends       = common_avr8
-board         = ATmega2560
-upload_protocol = wiring
-upload_speed  = 57600
+platform                  = atmelavr
+extends                   = common_avr8
+board                     = ATmega2560
+upload_protocol           = wiring
+upload_speed              = 57600
 board_upload.maximum_size = 253952
 
 #
 # RAMBo
 #
 [env:rambo]
-platform      = atmelavr
-extends       = common_avr8
-board         = reprap_rambo
+platform = atmelavr
+extends  = common_avr8
+board    = reprap_rambo
 
 #
 # FYSETC F6 V1.3
 #
 [env:FYSETC_F6_13]
-platform      = atmelavr
-extends       = common_avr8
-board         = fysetc_f6_13
+platform = atmelavr
+extends  = common_avr8
+board    = fysetc_f6_13
 
 #
 # FYSETC F6 V1.4
 #
 [env:FYSETC_F6_14]
-platform      = atmelavr
-extends       = common_avr8
-board         = fysetc_f6_14
+platform = atmelavr
+extends  = common_avr8
+board    = fysetc_f6_14
 
 #
 # Sanguinololu (ATmega644p)
 #
 [env:sanguino644p]
-platform      = atmelavr
-extends       = common_avr8
-board         = sanguino_atmega644p
+platform = atmelavr
+extends  = common_avr8
+board    = sanguino_atmega644p
 
 #
 # Sanguinololu (ATmega1284p)
 #
 [env:sanguino1284p]
-platform      = atmelavr
-extends       = common_avr8
-board         = sanguino_atmega1284p
+platform                  = atmelavr
+extends                   = common_avr8
+board                     = sanguino_atmega1284p
 board_upload.maximum_size = 126976
 
 #
 # Melzi and clones (ATmega1284p)
 #
 [env:melzi]
-platform      = atmelavr
-extends       = common_avr8
-board         = sanguino_atmega1284p
-upload_speed  = 57600
-board_upload.maximum_size = 126976
+platform     = atmelavr
+extends      = env:sanguino1284p
+upload_speed = 57600
+
+#
+# Sanguinololu (ATmega1284p stock bootloader with tuned flags)
+#
+
+[tuned_1284p]
+build_flags = ${common.build_flags} -fno-tree-scev-cprop -fno-split-wide-types -Wl,--relax -mcall-prologues
+
+[env:sanguino1284p_optimized]
+platform    = atmelavr
+extends     = env:melzi
+build_flags = ${tuned_1284p.build_flags}
+
+#
+# Melzi and clones (alias for sanguino1284p_optimized)
+#
+[env:melzi_optimized]
+platform = atmelavr
+extends  = env:sanguino1284p_optimized
 
 #
 # Melzi and clones (Optiboot bootloader)
 #
 [env:melzi_optiboot]
-platform      = atmelavr
-extends       = common_avr8
-board         = sanguino_atmega1284p
-upload_speed  = 115200
+platform     = atmelavr
+extends      = common_avr8
+board        = sanguino_atmega1284p
+upload_speed = 115200
 
 #
 # Melzi and clones (Zonestar Melzi2 with tuned flags)
 #
-[env:melzi_optimized]
-platform      = atmelavr
-extends       = env:melzi_optiboot
-build_flags   = ${common.build_flags} -fno-tree-scev-cprop -fno-split-wide-types -Wl,--relax -mcall-prologues
-build_unflags = -g -ggdb
+[env:melzi_optiboot_optimized]
+platform    = atmelavr
+extends     = env:melzi_optiboot
+build_flags = ${tuned_1284p.build_flags}
 
 #
 # AT90USB1286 boards using CDC bootloader
@@ -558,10 +574,10 @@ build_unflags = -g -ggdb
 # - TEENSYLU
 #
 [env:at90usb1286_cdc]
-platform      = teensy
-extends       = common_avr8
-board         = at90usb1286
-lib_ignore    = ${env:common_avr8.lib_ignore}, Teensy_ADC, NativeEthernet
+platform   = teensy
+extends    = common_avr8
+board      = at90usb1286
+lib_ignore = ${env:common_avr8.lib_ignore}, Teensy_ADC, NativeEthernet
 
 #
 # AT90USB1286 boards using DFU bootloader
@@ -570,8 +586,8 @@ lib_ignore    = ${env:common_avr8.lib_ignore}, Teensy_ADC, NativeEthernet
 # - ? 5DPRINT ?
 #
 [env:at90usb1286_dfu]
-platform      = teensy
-extends       = env:at90usb1286_cdc
+platform = teensy
+extends  = env:at90usb1286_cdc
 
 #################################
 #                               #
@@ -586,20 +602,20 @@ extends       = env:at90usb1286_cdc
 #  - RADDS
 #
 [env:DUE]
-platform      = atmelsam
-board         = due
-src_filter    = ${common.default_src_filter} +<src/HAL/DUE> +<src/HAL/shared/backtrace>
+platform   = atmelsam
+board      = due
+src_filter = ${common.default_src_filter} +<src/HAL/DUE> +<src/HAL/shared/backtrace>
 
 [env:DUE_USB]
-platform      = atmelsam
-extends       = env:DUE
-board         = dueUSB
+platform = atmelsam
+extends  = env:DUE
+board    = dueUSB
 
 [env:DUE_debug]
 # Used when WATCHDOG_RESET_MANUAL is enabled
-platform      = atmelsam
-extends       = env:DUE
-build_flags   = ${common.build_flags}
+platform    = atmelsam
+extends     = env:DUE
+build_flags = ${common.build_flags}
   -funwind-tables
   -mpoke-function-name
 
@@ -607,24 +623,24 @@ build_flags   = ${common.build_flags}
 # Archim SAM
 #
 [common_DUE_archim]
-platform      = atmelsam
-extends       = env:DUE
-board         = archim
-build_flags   = ${common.build_flags}
+platform                 = atmelsam
+extends                  = env:DUE
+board                    = archim
+build_flags              = ${common.build_flags}
   -DARDUINO_SAM_ARCHIM -DARDUINO_ARCH_SAM -D__SAM3X8E__ -DUSBCON
 board_build.variants_dir = buildroot/share/PlatformIO/variants/
-extra_scripts = ${common.extra_scripts}
+extra_scripts            = ${common.extra_scripts}
   Marlin/src/HAL/DUE/upload_extra_script.py
 
 [env:DUE_archim]
-platform      = ${common_DUE_archim.platform}
-extends       = common_DUE_archim
+platform = ${common_DUE_archim.platform}
+extends  = common_DUE_archim
 
 # Used when WATCHDOG_RESET_MANUAL is enabled
 [env:DUE_archim_debug]
-platform      = ${common_DUE_archim.platform}
-extends       = common_DUE_archim
-build_flags   = ${common_DUE_archim.build_flags} -funwind-tables -mpoke-function-name
+platform    = ${common_DUE_archim.platform}
+extends     = common_DUE_archim
+build_flags = ${common_DUE_archim.build_flags} -funwind-tables -mpoke-function-name
 
 #################################
 #                               #
@@ -678,14 +694,14 @@ build_flags       = ${common.build_flags} -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC17
 # NXP LPC176x ARM Cortex-M3
 #
 [env:LPC1768]
-platform  = ${common_LPC.platform}
-extends   = common_LPC
-board     = nxp_lpc1768
+platform = ${common_LPC.platform}
+extends  = common_LPC
+board    = nxp_lpc1768
 
 [env:LPC1769]
-platform  = ${common_LPC.platform}
-extends   = common_LPC
-board     = nxp_lpc1769
+platform = ${common_LPC.platform}
+extends  = common_LPC
+board    = nxp_lpc1769
 
 #################################
 #                               #

commit bd872d5dcfd49d3182b535e06791fb17f7a96b0d
Author: Jason Smith <jason.inet@gmail.com>
Date:   Fri Nov 6 21:51:52 2020 -0800

    STM32F1 cleanup, incl. SoftwareSerial removal (#20046)

diff --git a/platformio.ini b/platformio.ini
index 0bd4fbe7a1..7ab0755cdc 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -711,7 +711,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32> +<src/HAL/shared/b
 [common_stm32f1]
 platform      = ststm32@~6.1
 build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL
+  ${common.build_flags}
 build_unflags = -std=gnu11 -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore    = SPI
@@ -1121,18 +1121,14 @@ build_flags   = ${env:chitu_f103.build_flags} -DCHITU_V5_Z_MIN_BUGFIX
 # Creality (STM32F103RET6)
 #
 [env:STM32F103RET6_creality]
-platform        = ${common_stm32f1.platform}
-extends         = common_stm32f1
-board           = genericSTM32F103RE
-build_flags     = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY -DTEMP_TIMER_CHAN=4
-extra_scripts   = ${common.extra_scripts}
+platform        = ${env:STM32F103RE.platform}
+extends         = env:STM32F103RE
+build_flags     = ${env:STM32F103RE.build_flags} -DTEMP_TIMER_CHAN=4
+extra_scripts   = ${env:STM32F103RE.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/random-bin.py
   buildroot/share/PlatformIO/scripts/creality.py
-lib_ignore      = ${common_stm32f1.lib_ignore}
 debug_tool      = jlink
 upload_protocol = jlink
-monitor_speed   = 115200
 
 #
 # FLSUN QQ (STM32F103VET6)

commit 4785b04aa13470ee8f1b8f2db07058d473616b06
Author: George Fu <nailao_5918@163.com>
Date:   Sat Nov 7 13:48:52 2020 +0800

    FYSETC E4 board support (#20032)

diff --git a/platformio.ini b/platformio.ini
index b052a26b58..0bd4fbe7a1 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1363,6 +1363,11 @@ upload_speed  = 115200
 #upload_port   = marlinesp.local
 #board_build.flash_mode = qio
 
+[env:FYSETC_E4]
+platform               = espressif32@1.11.2
+extends                = env:esp32
+board_build.partitions = default_16MB.csv
+
 #
 # Teensy 3.1 / 3.2 (ARM Cortex-M4)
 #

commit 50ba20fe1f27cdcb0f0f98f11cb42248dbc186f7
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Thu Oct 29 04:01:25 2020 -0300

    PIO env for MKS Nano boards in STM32 (#19905)

diff --git a/platformio.ini b/platformio.ini
index 3e565e6c4e..b052a26b58 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1310,17 +1310,39 @@ build_flags          = ${lerdge_common.build_flags}
 # RUMBA32
 #
 [env:rumba32]
-platform      = ${common_stm32.platform}
-extends       = common_stm32
-build_flags   = ${common_stm32.build_flags}
+platform        = ${common_stm32.platform}
+extends         = common_stm32
+build_flags     = ${common_stm32.build_flags}
   -Os
   -DHAL_PCD_MODULE_ENABLED
   -DDISABLE_GENERIC_SERIALUSB
   -DHAL_UART_MODULE_ENABLED
   -DTIMER_SERIAL=TIM9
-board         = rumba32_f446ve
+board           = rumba32_f446ve
 upload_protocol = dfu
-monitor_speed = 500000
+monitor_speed   = 500000
+
+#
+# MKS Robin Nano V1.2 and V2 using hal STM32
+#
+[env:mks_robin_nano35_stm32]
+platform             = ${common_stm32.platform}
+extends              = common_stm32
+build_flags          = ${common_stm32.build_flags} -DMCU_STM32F103VE -DSS_TIMER=4 -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
+board                = genericSTM32F103VE
+board_build.core     = stm32
+board_build.variant  = MARLIN_F103Vx
+board_build.ldscript = ldscript.ld
+board_build.offset   = 0x7000
+board_build.firmware = Robin_nano35.bin
+board_upload.offset_address = 0x08007000
+build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
+debug_tool           = jlink
+upload_protocol      = jlink
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+  buildroot/share/PlatformIO/scripts/mks_encrypt.py
 
 #################################
 #                               #

commit 8cc0369d97fc762f2fd0ede31635de9f2ab9dd2b
Author: ellensp <ellensp@hotmail.com>
Date:   Sun Oct 25 13:46:27 2020 +1300

    Use LiquidCrystal_I2C@1.1.4 for RA_CONTROL_PANEL (#19875)

diff --git a/platformio.ini b/platformio.ini
index 56ace1b6e2..3e565e6c4e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -222,6 +222,7 @@ NEOPIXEL_LED            = Adafruit NeoPixel@1.5.0
                           src_filter=+<src/feature/leds/neopixel.cpp>
 MAX6675_IS_MAX31865     = Adafruit MAX31865 library@~1.1.0
 USES_LIQUIDCRYSTAL      = LiquidCrystal@1.5.0
+USES_LIQUIDCRYSTAL_I2C  = marcoschwartz/LiquidCrystal_I2C@1.1.4
 USES_LIQUIDTWI2         = LiquidTWI2@1.2.7
 HAS_WIRED_LCD           = src_filter=+<src/lcd/lcdprint.cpp>
 HAS_MARLINUI_HD44780    = src_filter=+<src/lcd/HD44780>

commit ea0afd0b4d918b9afe09f38a97c977151851d770
Author: Jason Smith <jason.inet@gmail.com>
Date:   Sat Oct 24 17:43:42 2020 -0700

    Ignore NativeEthernet on AT90USB1286 (#19885)

diff --git a/platformio.ini b/platformio.ini
index 326dca172f..56ace1b6e2 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -560,7 +560,7 @@ build_unflags = -g -ggdb
 platform      = teensy
 extends       = common_avr8
 board         = at90usb1286
-lib_ignore    = ${env:common_avr8.lib_ignore} Teensy_ADC
+lib_ignore    = ${env:common_avr8.lib_ignore}, Teensy_ADC, NativeEthernet
 
 #
 # AT90USB1286 boards using DFU bootloader

commit 9aee6674bb1ffca1057de2c14b5ae79d6d4b875a
Author: Foxies <Foxies-CSTL@users.noreply.github.com>
Date:   Thu Oct 22 02:00:57 2020 +0200

    FLSUN Delta QQS-Pro pins (#19793)

diff --git a/platformio.ini b/platformio.ini
index 8416b93a27..326dca172f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1133,6 +1133,21 @@ debug_tool      = jlink
 upload_protocol = jlink
 monitor_speed   = 115200
 
+#
+# FLSUN QQ (STM32F103VET6)
+#
+[env:flsun_hispeed]
+platform          = ${common_stm32f1.platform}
+extends           = common_stm32f1
+board             = genericSTM32F103VE
+platform_packages = tool-stm32duino
+extra_scripts     = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/mks_robin_mini.py
+  buildroot/share/PlatformIO/scripts/add_nanolib.py
+build_flags       = ${common_stm32f1.build_flags} -DMCU_STM32F103VE -DSS_TIMER=4
+lib_deps          = SoftwareSerialM
+  #Adafruit NeoPixel=https://github.com/Foxies-CSTL/Robin-NeoPixel-Lib/archive/master.zip
+
 #
 # STM32F401VE
 # 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html

commit 072f996af70b5ac635893eca2d4bd4bbb4f00acc
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Wed Oct 21 12:45:27 2020 -0500

    General cleanup, mostly MKS UI (#19825)

diff --git a/platformio.ini b/platformio.ini
index 9d5f6c5ab8..8416b93a27 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -977,7 +977,6 @@ extends       = env:mks_robin
 extra_scripts = ${common.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_pro.py
 
-
 #
 # TRIGORILLA PRO (STM32F103ZET6)
 #
@@ -1026,7 +1025,6 @@ board         = genericSTM32F103RC
 extra_scripts = ${common.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_lite.py
 
-
 #
 # MKS ROBIN LITE3 (STM32F103RCT6)
 #

commit 9baa944460e0bf5f15e46a501b64ebd39a9d5f34
Author: bilsef <bilsef1@gmail.com>
Date:   Tue Oct 20 12:35:29 2020 -0700

    Teensy 4.1 Ethernet support (#19801)

diff --git a/platformio.ini b/platformio.ini
index 0abb4ac388..9d5f6c5ab8 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -284,6 +284,7 @@ EMERGENCY_PARSER        = src_filter=+<src/feature/e_parser.cpp> -<src/gcode/con
 I2C_POSITION_ENCODERS   = src_filter=+<src/feature/encoder_i2c.cpp>
 IIC_BL24CXX_EEPROM      = src_filter=+<src/libs/BL24CXX.cpp>
 HAS_SPI_FLASH           = src_filter=+<src/libs/W25Qxx.cpp>
+HAS_ETHERNET            = src_filter=+<src/feature/ethernet.cpp>
 HAS_FANMUX              = src_filter=+<src/feature/fanmux.cpp>
 FILAMENT_WIDTH_SENSOR   = src_filter=+<src/feature/filwidth.cpp> +<src/gcode/feature/filwidth>
 FWRETRACT               = src_filter=+<src/feature/fwretract.cpp> +<src/gcode/feature/fwretract>
@@ -1321,6 +1322,7 @@ platform      = espressif32@1.11.2
 board         = esp32dev
 build_flags   = ${common.build_flags} -DCORE_DEBUG_LEVEL=0
 src_filter    = ${common.default_src_filter} +<src/HAL/ESP32>
+lib_ignore    = NativeEthernet
 upload_speed  = 115200
 #upload_port   = marlinesp.local
 #board_build.flash_mode = qio
@@ -1332,6 +1334,7 @@ upload_speed  = 115200
 platform      = teensy
 board         = teensy31
 src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY31_32>
+lib_ignore    = NativeEthernet
 
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
@@ -1340,11 +1343,13 @@ src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY31_32>
 platform      = teensy
 board         = teensy35
 src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY35_36>
+lib_ignore    = NativeEthernet
 
 [env:teensy36]
 platform      = teensy
 board         = teensy36
 src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY35_36>
+lib_ignore    = NativeEthernet
 
 #
 # Teensy 4.0 / 4.1 (ARM Cortex-M7)

commit 9507c49b18b2710b81a80b2780f14db7185b32fe
Author: Jason Smith <jason.inet@gmail.com>
Date:   Wed Oct 14 11:43:36 2020 -0700

    Fix mega2560ext environment (#19730)

diff --git a/platformio.ini b/platformio.ini
index bb5cc243e5..0abb4ac388 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -445,7 +445,7 @@ board               = megaatmega2560
 #
 [env:mega2560ext]
 platform            = atmelavr
-extends             = mega2560
+extends             = env:mega2560
 board               = megaatmega2560
 board_build.variant = megaextendedpins
 extra_scripts       = ${common.extra_scripts}

commit 54315252c7c70513f7b39f4c37d975dbf539d490
Author: Jason Smith <jason.inet@gmail.com>
Date:   Tue Oct 13 16:03:09 2020 -0700

    Add NUCLEO-F767ZI dev board (#19373)
    
    Co-authored-by: Lorenzo Delana <lorenzo.delana@gmail.com>

diff --git a/platformio.ini b/platformio.ini
index 9c9460d1a3..bb5cc243e5 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -856,6 +856,17 @@ board         = remram_v1
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/STM32_F4_F7/STM32F4>
 
+#
+# ST NUCLEO-F767ZI Development Board
+# This environment is for testing purposes prior to control boards
+# being readily available based on STM32F7 MCUs
+#
+[env:NUCLEO_F767ZI]
+platform      = ${common_stm32.platform}
+extends       = common_stm32
+board         = nucleo_f767zi
+build_flags   = ${common_stm32.build_flags} -DTIMER_SERIAL=TIM9
+
 #
 # ARMED (STM32)
 #

commit c0920bbf6a2490b7ea66d2a9e828c0f527a6c77b
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Mon Oct 12 18:38:07 2020 -0300

    TFT Refactoring (#19192)
    
    * split tft folder in two: tft for color ui; tft_io for shared tft code
    
    * after the files got moved, now the code was moved to the right place
    
    * classic ui using TFT IO init lcd codes
    
    * feature to compile tft_io when enabled
    
    * compiling fix
    
    * lvgl spi tft working with tft io init codes
    
    * there is no need for separeted fsmc and spi class in lvgl anymore, as tft io handle everything
    
    * remove debug
    
    * base for TFT rotation and mirroring API, and ILI9488 support
    
    * ST7796S rotate and mirror support
    
    * ST7789V rotate and mirror support
    
    * ST7735 rotate and mirror support
    
    * ILI9341 rotate and mirror support
    
    * ILI9328 rotate and mirror support
    
    * R61505 rotate and mirror support
    
    * MKS TFT definitions
    
    * more configs for mks tfts
    
    * update config
    
    * naming typo
    
    * to configure the user interface
    
    * ANYCUBIC_TFT35
    
    * tft configs
    
    * support for SSD1963
    
    * tft display types
    
    * updated conditionals lcd; first board fully working with the new code - all 3 ui!
    
    * compatiblity
    
    * changed name
    
    * move classic ui file name
    
    * rename TURN -> ROTATE
    
    * GRAPHICAL_TFT_ROTATE_180 deprecated
    
    * first fsmc board fully working - chitu v5
    
    * mks robin nano v1.2 + tft 35 ok!
    
    * right pin name
    
    * anycubic tft tested in a TRIGORILLA_PRO
    
    * chitu v6
    
    * nano 32 tft orientation
    
    * mks tft43
    
    * mks tft43 rotation
    
    * fixed LONGER LK tft setup
    
    * GRAPHICAL_TFT_UPSCALE defined by the display type
    
    * better offsets defaults
    
    * Update Configuration.h
    
    * Update tft_fsmc.cpp
    
    * Update Conditionals_LCD.h
    
    * Tweak comments
    
    * update nano tests
    
    * Revert "update nano tests"
    
    This reverts commit a071ebbfad30e28855a4a5695ec8a726542a1a65.
    
    * default tft
    
    * outdated comments
    
    * to not break non-vscode builds
    
    * upscale tft 35
    
    * support tft 180 rotation for color ui
    
    * Each TFT Driver is responsible for its default color mode.
    
    * use auto detect in mks displays, because some of them could be shipped with diferent drivers
    
    * extra s
    
    * unused code
    
    * wrong -1
    
    * missing mirror options
    
    * Smaller regex pattern
    
    * Comment updates
    
    * Clean up old defines
    
    * Apply pins formatting
    
    * GRAPHICAL_TFT_ROTATE_180 => TFT_ROTATE_180
    
    * MKS_ROBIN_TFT_V1_1R
    
    * merge fix
    
    * correct resolution
    
    * auto is default, dont need be there, and it will allow the user to configure it even for named displays
    
    * to not use rotation with MKS_ROBIN_TFT_V1_1R
    
    * i like () in macros
    
    * avoid sleepy commits
    
    * default for st7789 is rgb
    
    * nano follow up
    
    * to allow ili9328 rotation
    
    * default is rgb
    
    * boards merge follow up
    
    * to match bootloader orientation
    
    * HAS_TOUCH_XPT2046 is not hal specific anymore
    
    * lets not forget LPC
    
    * 180 rotation for ili9328 and R61505
    
    * Clean up whitespace
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/platformio.ini b/platformio.ini
index 4c974e5a87..9c9460d1a3 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -26,7 +26,7 @@ include_dir  = Marlin
 #
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
-  -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/tft>
+  -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/tft_io>
   -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
   -<src/lcd/menu>
   -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>
@@ -227,7 +227,7 @@ HAS_WIRED_LCD           = src_filter=+<src/lcd/lcdprint.cpp>
 HAS_MARLINUI_HD44780    = src_filter=+<src/lcd/HD44780>
 HAS_MARLINUI_U8GLIB     = U8glib-HAL@~0.4.1
                           src_filter=+<src/lcd/dogm>
-HAS_(FSMC|SPI)_TFT      = src_filter=+<src/HAL/STM32/tft> +<src/HAL/STM32F1/tft>
+HAS_(FSMC|SPI)_TFT      = src_filter=+<src/HAL/STM32/tft> +<src/HAL/STM32F1/tft> +<src/lcd/tft_io>
 HAS_FSMC_TFT            = src_filter=+<src/HAL/STM32/tft/tft_fsmc.cpp> +<src/HAL/STM32F1/tft/tft_fsmc.cpp>
 HAS_SPI_TFT             = src_filter=+<src/HAL/STM32/tft/tft_spi.cpp> +<src/HAL/STM32F1/tft/tft_spi.cpp>
 HAS_GRAPHICAL_TFT       = src_filter=+<src/lcd/tft>
@@ -909,8 +909,6 @@ build_flags   = ${common_stm32f1.build_flags}
 
 #
 # MKS Robin Nano (STM32F103VET6)
-# v1.2 - Emulated Graphical 128x64 (DOGM) UI and LVGL UI
-# v2.0 - LVGL UI
 #
 [env:mks_robin_nano35]
 platform        = ${common_stm32f1.platform}

commit e7838c5f7904924eed7e996d2ff95fff0f64e30e
Author: InsanityAutomation <38436470+InsanityAutomation@users.noreply.github.com>
Date:   Sun Oct 11 22:34:27 2020 -0400

    G34 Mechanical Gantry Calibration (like Prusa M915) (#18972)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index d2c7cfafbe..4c974e5a87 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -110,6 +110,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/bedlevel/G42.cpp>
   -<src/gcode/bedlevel/M420.cpp>
   -<src/gcode/calibrate/G33.cpp>
+  -<src/gcode/calibrate/G34.cpp>
   -<src/gcode/calibrate/G34_M422.cpp>
   -<src/gcode/calibrate/G76_M192_M871.cpp>
   -<src/gcode/calibrate/G425.cpp>
@@ -309,6 +310,7 @@ MK2_MULTIPLEXER         = src_filter=+<src/feature/snmm.cpp>
 EXT_SOLENOID|MANUAL_SOLENOID_CONTROL = src_filter=+<src/feature/solenoid.cpp> +<src/gcode/control/M380_M381.cpp>
 HAS_CUTTER              = src_filter=+<src/feature/spindle_laser.cpp> +<src/gcode/control/M3-M5.cpp>
 EXPERIMENTAL_I2CBUS     = src_filter=+<src/feature/twibus.cpp> +<src/gcode/feature/i2c>
+MECHANICAL_GANTRY_CAL.+ = src_filter=+<src/gcode/calibrate/G34.cpp>
 Z_STEPPER_AUTO_ALIGN    = src_filter=+<src/feature/z_stepper_align.cpp> +<src/gcode/calibrate/G34_M422.cpp>
 G26_MESH_VALIDATION     = src_filter=+<src/gcode/bedlevel/G26.cpp>
 ASSISTED_TRAMMING       = src_filter=+<src/gcode/bedlevel/G35.cpp>

commit 45731bd0221beee768e009195ee3aa9a0b0f2a88
Author: Jason Smith <jason.inet@gmail.com>
Date:   Sun Oct 11 16:13:01 2020 -0700

    Fix at90usb1286 build (#19687)
    
    * Skip check for USBCON during dependency detection
    * Ignore incompatible Teensy_ADC library, which requires Teensy >= 3
    * Add IS_AT90USB
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 9d3fafd69e..d2c7cfafbe 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -557,6 +557,7 @@ build_unflags = -g -ggdb
 platform      = teensy
 extends       = common_avr8
 board         = at90usb1286
+lib_ignore    = ${env:common_avr8.lib_ignore} Teensy_ADC
 
 #
 # AT90USB1286 boards using DFU bootloader

commit 492ba2a111ce541513d4515c4af3f57ceaa897ea
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Oct 11 14:58:35 2020 -0500

    Digipots refactor / cleanup (#19690)

diff --git a/platformio.ini b/platformio.ini
index d4beca6519..9d3fafd69e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -211,7 +211,7 @@ HAS_TRINAMIC_CONFIG     = TMCStepper@~0.7.1
                           src_filter=+<src/feature/tmc_util.cpp> +<src/module/stepper/trinamic.cpp> +<src/gcode/feature/trinamic/M122.cpp> +<src/gcode/feature/trinamic/M906.cpp> +<src/gcode/feature/trinamic/M911-M914.cpp>
 HAS_STEALTHCHOP         = src_filter=+<src/gcode/feature/trinamic/M569.cpp>
 SR_LCD_3W_NL            = SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-HAS_I2C_DIGIPOT         = SlowSoftI2CMaster
+HAS_MOTOR_CURRENT_I2C   = SlowSoftI2CMaster
                           src_filter=+<src/feature/digipot>
 HAS_TMC26X              = TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
                           src_filter=+<src/module/TMC26X.cpp>
@@ -277,7 +277,7 @@ CANCEL_OBJECTS          = src_filter=+<src/feature/cancel_object.cpp> +<src/gcod
 CASE_LIGHT_ENABLE       = src_filter=+<src/feature/caselight.cpp> +<src/gcode/feature/caselight>
 EXTERNAL_CLOSED_LOOP_CONTROLLER = src_filter=+<src/feature/closedloop.cpp> +<src/gcode/calibrate/M12.cpp>
 USE_CONTROLLER_FAN      = src_filter=+<src/feature/controllerfan.cpp>
-DAC_STEPPER_CURRENT     = src_filter=+<src/feature/dac>
+HAS_MOTOR_CURRENT_DAC   = src_filter=+<src/feature/dac>
 DIRECT_STEPPING         = src_filter=+<src/feature/direct_stepping.cpp> +<src/gcode/motion/G6.cpp>
 EMERGENCY_PARSER        = src_filter=+<src/feature/e_parser.cpp> -<src/gcode/control/M108_*.cpp>
 I2C_POSITION_ENCODERS   = src_filter=+<src/feature/encoder_i2c.cpp>

commit 0988af453c567fae1796cc821bbc41e930b45836
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Oct 9 16:42:23 2020 -0500

    Optional `M42`/`M226`; Add more features filters (#19664)

diff --git a/platformio.ini b/platformio.ini
index cf4dfc932a..d4beca6519 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -27,6 +27,7 @@ include_dir  = Marlin
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/tft>
+  -<src/HAL/STM32/tft> -<src/HAL/STM32F1/tft>
   -<src/lcd/menu>
   -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>
   -<src/lcd/menu/game/maze.cpp> -<src/lcd/menu/game/snake.cpp>
@@ -53,10 +54,13 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/extui/example.cpp>
   -<src/lcd/extui/malyan_lcd.cpp>
   -<src/lcd/extui/lib/ftdi_eve_touch_ui>
-  -<src/lcd/extui/anycubic_chiron_lcd.cpp>
+  -<src/lcd/extui/anycubic_chiron_lcd.cpp> -<src/lcd/extui/lib/anycubic_chiron>
   -<src/lcd/extui/anycubic_i3mega_lcd.cpp> -<src/lcd/extui/lib/anycubic_i3mega>
   -<src/lcd/lcdprint.cpp>
+  -<src/lcd/touch/touch_buttons.cpp>
   -<src/sd/usb_flashdrive>
+  -<src/HAL/shared/backtrace>
+  -<src/feature/babystep.cpp>
   -<src/feature/backlash.cpp>
   -<src/feature/baricuda.cpp> -<src/gcode/feature/baricuda>
   -<src/feature/bedlevel/abl> -<src/gcode/bedlevel/abl>
@@ -65,7 +69,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/binary_stream.cpp> -<src/libs/heatshrink>
   -<src/feature/bltouch.cpp>
   -<src/feature/cancel_object.cpp> -<src/gcode/feature/cancel>
-  -<src/feature/caselight> -<src/gcode/feature/caselight>
+  -<src/feature/caselight.cpp> -<src/gcode/feature/caselight>
   -<src/feature/closedloop.cpp>
   -<src/feature/controllerfan.cpp> -<src/gcode/feature/controllerfan>
   -<src/feature/dac> -<src/feature/digipot>
@@ -80,6 +84,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/joystick.cpp>
   -<src/feature/leds/blinkm.cpp>
   -<src/feature/leds/leds.cpp>
+  -<src/feature/leds/neopixel.cpp>
   -<src/feature/leds/pca9533.cpp>
   -<src/feature/leds/pca9632.cpp>
   -<src/feature/leds/printer_event_leds.cpp>
@@ -95,7 +100,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/probe_temp_comp.cpp>
   -<src/feature/runout.cpp> -<src/gcode/feature/runout>
   -<src/feature/snmm.cpp>
-  -<src/feature/solenoid.cpp>
+  -<src/feature/solenoid.cpp> -<src/gcode/control/M380_M381.cpp>
   -<src/feature/spindle_laser.cpp> -<src/gcode/control/M3-M5.cpp>
   -<src/feature/tmc_util.cpp> -<src/module/stepper/trinamic.cpp>
   -<src/feature/twibus.cpp>
@@ -106,7 +111,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/bedlevel/M420.cpp>
   -<src/gcode/calibrate/G33.cpp>
   -<src/gcode/calibrate/G34_M422.cpp>
-  -<src/gcode/calibrate/G76_M871.cpp>
+  -<src/gcode/calibrate/G76_M192_M871.cpp>
   -<src/gcode/calibrate/G425.cpp>
   -<src/gcode/calibrate/M12.cpp>
   -<src/gcode/calibrate/M48.cpp>
@@ -114,14 +119,19 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/calibrate/M425.cpp>
   -<src/gcode/calibrate/M666.cpp>
   -<src/gcode/calibrate/M852.cpp>
+  -<src/gcode/control/M42.cpp> -<src/gcode/control/M226.cpp>
   -<src/gcode/config/M43.cpp>
   -<src/gcode/config/M217.cpp>
   -<src/gcode/config/M218.cpp>
   -<src/gcode/config/M221.cpp>
   -<src/gcode/config/M281.cpp>
+  -<src/gcode/config/M301.cpp>
   -<src/gcode/config/M302.cpp>
+  -<src/gcode/config/M304.cpp>
   -<src/gcode/config/M305.cpp>
   -<src/gcode/config/M540.cpp>
+  -<src/gcode/config/M575.cpp>
+  -<src/gcode/config/M672.cpp>
   -<src/gcode/control/M7-M9.cpp>
   -<src/gcode/control/M211.cpp>
   -<src/gcode/control/M605.cpp>
@@ -169,8 +179,10 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/scara>
   -<src/gcode/sd>
   -<src/gcode/temp/M104_M109.cpp>
+  -<src/gcode/temp/M155.cpp>
   -<src/gcode/units/G20_G21.cpp>
   -<src/gcode/units/M149.cpp>
+  -<src/libs/BL24CXX.cpp> -<src/libs/W25Qxx.cpp>
   -<src/libs/L64XX> -<src/module/stepper/L64xx.cpp>
   -<src/libs/hex_print.cpp>
   -<src/libs/least_squares_fit.cpp>
@@ -214,9 +226,13 @@ HAS_WIRED_LCD           = src_filter=+<src/lcd/lcdprint.cpp>
 HAS_MARLINUI_HD44780    = src_filter=+<src/lcd/HD44780>
 HAS_MARLINUI_U8GLIB     = U8glib-HAL@~0.4.1
                           src_filter=+<src/lcd/dogm>
+HAS_(FSMC|SPI)_TFT      = src_filter=+<src/HAL/STM32/tft> +<src/HAL/STM32F1/tft>
+HAS_FSMC_TFT            = src_filter=+<src/HAL/STM32/tft/tft_fsmc.cpp> +<src/HAL/STM32F1/tft/tft_fsmc.cpp>
+HAS_SPI_TFT             = src_filter=+<src/HAL/STM32/tft/tft_spi.cpp> +<src/HAL/STM32F1/tft/tft_spi.cpp>
 HAS_GRAPHICAL_TFT       = src_filter=+<src/lcd/tft>
 DWIN_CREALITY_LCD       = src_filter=+<src/lcd/dwin>
 IS_TFTGLCD_PANEL        = src_filter=+<src/lcd/TFTGLCD>
+HAS_TOUCH_XPT2046       = src_filter=+<src/lcd/touch/touch_buttons.cpp>
 HAS_LCD_MENU            = src_filter=+<src/lcd/menu>
 HAS_GAMES               = src_filter=+<src/lcd/menu/game/game.cpp>
 MARLIN_BRICKOUT         = src_filter=+<src/lcd/menu/game/brickout.cpp>
@@ -242,7 +258,7 @@ HAS_MENU_TEMPERATURE    = src_filter=+<src/lcd/menu/menu_temperature.cpp>
 HAS_MENU_TMC            = src_filter=+<src/lcd/menu/menu_tmc.cpp>
 HAS_MENU_TOUCH_SCREEN   = src_filter=+<src/lcd/menu/menu_touch_screen.cpp>
 HAS_MENU_UBL            = src_filter=+<src/lcd/menu/menu_ubl.cpp>
-ANYCUBIC_LCD_CHIRON     = src_filter=+<src/lcd/extui/anycubic_chiron_lcd.cpp>
+ANYCUBIC_LCD_CHIRON     = src_filter=+<src/lcd/extui/anycubic_chiron_lcd.cpp> +<src/lcd/extui/lib/anycubic_chiron>
 ANYCUBIC_LCD_I3MEGA     = src_filter=+<src/lcd/extui/anycubic_i3mega_lcd.cpp> +<src/lcd/extui/lib/anycubic_i3mega>
 HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus> +<src/lcd/extui/dgus_lcd.cpp>
 TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
@@ -258,13 +274,15 @@ BARICUDA                = src_filter=+<src/feature/baricuda.cpp> +<src/gcode/fea
 BINARY_FILE_TRANSFER    = src_filter=+<src/feature/binary_stream.cpp> +<src/libs/heatshrink>
 BLTOUCH                 = src_filter=+<src/feature/bltouch.cpp>
 CANCEL_OBJECTS          = src_filter=+<src/feature/cancel_object.cpp> +<src/gcode/feature/cancel>
-CASE_LIGHT_ENABLE       = src_filter=+<src/feature/caselight> +<src/gcode/feature/caselight>
+CASE_LIGHT_ENABLE       = src_filter=+<src/feature/caselight.cpp> +<src/gcode/feature/caselight>
 EXTERNAL_CLOSED_LOOP_CONTROLLER = src_filter=+<src/feature/closedloop.cpp> +<src/gcode/calibrate/M12.cpp>
 USE_CONTROLLER_FAN      = src_filter=+<src/feature/controllerfan.cpp>
 DAC_STEPPER_CURRENT     = src_filter=+<src/feature/dac>
 DIRECT_STEPPING         = src_filter=+<src/feature/direct_stepping.cpp> +<src/gcode/motion/G6.cpp>
 EMERGENCY_PARSER        = src_filter=+<src/feature/e_parser.cpp> -<src/gcode/control/M108_*.cpp>
 I2C_POSITION_ENCODERS   = src_filter=+<src/feature/encoder_i2c.cpp>
+IIC_BL24CXX_EEPROM      = src_filter=+<src/libs/BL24CXX.cpp>
+HAS_SPI_FLASH           = src_filter=+<src/libs/W25Qxx.cpp>
 HAS_FANMUX              = src_filter=+<src/feature/fanmux.cpp>
 FILAMENT_WIDTH_SENSOR   = src_filter=+<src/feature/filwidth.cpp> +<src/gcode/feature/filwidth>
 FWRETRACT               = src_filter=+<src/feature/fwretract.cpp> +<src/gcode/feature/fwretract>
@@ -285,10 +303,10 @@ ADVANCED_PAUSE_FEATURE  = src_filter=+<src/feature/pause.cpp> +<src/gcode/featur
 AUTO_POWER_CONTROL      = src_filter=+<src/feature/power.cpp>
 HAS_POWER_MONITOR       = src_filter=+<src/feature/power_monitor.cpp> +<src/gcode/feature/power_monitor>
 POWER_LOSS_RECOVERY     = src_filter=+<src/feature/powerloss.cpp> +<src/gcode/feature/powerloss>
-PROBE_TEMP_COMPENSATION = src_filter=+<src/feature/probe_temp_comp.cpp> +<src/gcode/calibrate/G76_M871.cpp>
+PROBE_TEMP_COMPENSATION = src_filter=+<src/feature/probe_temp_comp.cpp> +<src/gcode/calibrate/G76_M192_M871.cpp>
 HAS_FILAMENT_SENSOR     = src_filter=+<src/feature/runout.cpp> +<src/gcode/feature/runout>
 MK2_MULTIPLEXER         = src_filter=+<src/feature/snmm.cpp>
-EXT_SOLENOID|MANUAL_SOLENOID_CONTROL = src_filter=+<src/feature/solenoid.cpp>
+EXT_SOLENOID|MANUAL_SOLENOID_CONTROL = src_filter=+<src/feature/solenoid.cpp> +<src/gcode/control/M380_M381.cpp>
 HAS_CUTTER              = src_filter=+<src/feature/spindle_laser.cpp> +<src/gcode/control/M3-M5.cpp>
 EXPERIMENTAL_I2CBUS     = src_filter=+<src/feature/twibus.cpp> +<src/gcode/feature/i2c>
 Z_STEPPER_AUTO_ALIGN    = src_filter=+<src/feature/z_stepper_align.cpp> +<src/gcode/calibrate/G34_M422.cpp>
@@ -304,14 +322,19 @@ BACKLASH_GCODE          = src_filter=+<src/gcode/calibrate/M425.cpp>
 IS_KINEMATIC            = src_filter=+<src/gcode/calibrate/M665.cpp>
 HAS_EXTRA_ENDSTOPS      = src_filter=+<src/gcode/calibrate/M666.cpp>
 SKEW_CORRECTION_GCODE   = src_filter=+<src/gcode/calibrate/M852.cpp>
-PINS_DEBUGGING          = src_filter=-<src/gcode/config/M43.cpp>
+DIRECT_PIN_CONTROL      = src_filter=+<src/gcode/control/M42.cpp> +<src/gcode/control/M226.cpp>
+PINS_DEBUGGING          = src_filter=+<src/gcode/config/M43.cpp>
 NO_VOLUMETRICS          = src_filter=-<src/gcode/config/M200-M205.cpp>
 HAS_MULTI_EXTRUDER      = src_filter=+<src/gcode/config/M217.cpp>
 HAS_HOTEND_OFFSET       = src_filter=+<src/gcode/config/M218.cpp>
 EDITABLE_SERVO_ANGLES   = src_filter=+<src/gcode/config/M281.cpp>
+PIDTEMP                 = src_filter=+<src/gcode/config/M301.cpp>
 PREVENT_COLD_EXTRUSION  = src_filter=+<src/gcode/config/M302.cpp>
+PIDTEMPBED              = src_filter=+<src/gcode/config/M304.cpp>
 HAS_USER_THERMISTORS    = src_filter=+<src/gcode/config/M305.cpp>
 SD_ABORT_ON_ENDSTOP_HIT = src_filter=+<src/gcode/config/M540.cpp>
+BAUD_RATE_GCODE         = src_filter=+<src/gcode/config/M575.cpp>
+HAS_SMART_EFF_MOD       = src_filter=+<src/gcode/config/M672.cpp>
 COOLANT_CONTROL         = src_filter=+<src/gcode/control/M7-M9.cpp>
 HAS_SOFTWARE_ENDSTOPS   = src_filter=+<src/gcode/control/M211.cpp>
 HAS_DUPLICATION_MODE    = src_filter=+<src/gcode/control/M605.cpp>
@@ -336,12 +359,13 @@ LCD_SET_PROGRESS_MANUALLY = src_filter=+<src/gcode/lcd/M73.cpp>
 TOUCH_SCREEN_CALIBRATION = src_filter=+<src/gcode/lcd/M995.cpp>
 ARC_SUPPORT             = src_filter=+<src/gcode/motion/G2_G3.cpp>
 GCODE_MOTION_MODES      = src_filter=+<src/gcode/motion/G80.cpp>
-BABYSTEPPING            = src_filter=+<src/gcode/motion/M290.cpp>
+BABYSTEPPING            = src_filter=+<src/gcode/motion/M290.cpp> +<src/feature/babystep.cpp>
 Z_PROBE_SLED            = src_filter=+<src/gcode/probe/G31_G32.cpp>
 G38_PROBE_TARGET        = src_filter=+<src/gcode/probe/G38.cpp>
 MAGNETIC_PARKING_EXTRUDER = src_filter=+<src/gcode/probe/M951.cpp>
 SDSUPPORT               = src_filter=+<src/gcode/sd>
 HAS_EXTRUDERS           = src_filter=+<src/gcode/temp/M104_M109.cpp> +<src/gcode/config/M221.cpp>
+AUTO_REPORT_TEMPERATURES = src_filter=+<src/gcode/temp/M155.cpp>
 INCH_MODE_SUPPORT       = src_filter=+<src/gcode/units/G20_G21.cpp>
 TEMPERATURE_UNITS_SUPPORT = src_filter=+<src/gcode/units/M149.cpp>
 NEED_HEX_PRINT          = src_filter=+<src/libs/hex_print.cpp>
@@ -559,7 +583,7 @@ extends       = env:at90usb1286_cdc
 [env:DUE]
 platform      = atmelsam
 board         = due
-src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
+src_filter    = ${common.default_src_filter} +<src/HAL/DUE> +<src/HAL/shared/backtrace>
 
 [env:DUE_USB]
 platform      = atmelsam
@@ -635,7 +659,7 @@ lib_ldf_mode      = off
 lib_compat_mode   = strict
 extra_scripts     = ${common.extra_scripts}
   Marlin/src/HAL/LPC1768/upload_extra_script.py
-src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
+src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768> +<src/HAL/shared/backtrace>
 lib_deps          = ${common.lib_deps}
   Servo
 custom_marlin.USES_LIQUIDCRYSTAL = LiquidCrystal@1.0.0
@@ -674,7 +698,7 @@ build_flags   = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC
   -DTIM_IRQ_PRIO=13
 build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32> +<src/HAL/shared/backtrace>
 
 #
 # HAL/STM32F1 Common Environment values

commit bec184495432b74fd5b1601ce7e2081a715ef969
Author: Áü≥Á´ãÊû´ <49380822+FLYmaker@users.noreply.github.com>
Date:   Fri Oct 9 19:09:27 2020 +0800

    Support for FLY MINI (#19185)

diff --git a/platformio.ini b/platformio.ini
index ac7d9804d8..cf4dfc932a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1125,6 +1125,19 @@ build_flags       = ${common_stm32.build_flags}
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
+#
+# FLY MINI(stm32f103rct6)
+#
+[env:FLY_MINI]
+platform          = ${common_stm32f1.platform}
+extends           = common_stm32f1
+board             = genericSTM32F103RC
+platform_packages = tool-stm32duino
+extra_scripts     = ${common.extra_scripts}
+ buildroot/share/PlatformIO/scripts/fly_mini.py
+build_flags       = ${common_stm32f1.build_flags}
+ -DDEBUG_LEVEL=0 -DSS_TIMER=4
+
 #
 # FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
 #

commit 321afd5fef7bbd1afe9844543a74a9ad6be6b3d3
Author: ellensp <ellensp@hotmail.com>
Date:   Thu Oct 8 20:30:31 2020 +1300

    Apply env:mega2560ext to relevant boards (#19624)

diff --git a/platformio.ini b/platformio.ini
index 1f2586e26b..ac7d9804d8 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -412,6 +412,10 @@ board               = megaatmega2560
 
 #
 # ATmega2560 with extended pins 70-85 defined
+# BOARD_BQ_ZUM_MEGA_3D
+# BOARD_ULTIMAIN_2
+# BOARD_MIGHTYBOARD_REVE
+# BOARD_EINSTART_S
 #
 [env:mega2560ext]
 platform            = atmelavr

commit 8989353fabf82ac809d5d4db72b23324ec3b7669
Author: Ryan V1 <55478432+V1EngineeringInc@users.noreply.github.com>
Date:   Sun Oct 4 15:41:41 2020 -0700

    Fix Archim1 stepper timing (with new variant) (#19596)

diff --git a/platformio.ini b/platformio.ini
index c426c5223b..1f2586e26b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -576,8 +576,10 @@ build_flags   = ${common.build_flags}
 [common_DUE_archim]
 platform      = atmelsam
 extends       = env:DUE
+board         = archim
 build_flags   = ${common.build_flags}
   -DARDUINO_SAM_ARCHIM -DARDUINO_ARCH_SAM -D__SAM3X8E__ -DUSBCON
+board_build.variants_dir = buildroot/share/PlatformIO/variants/
 extra_scripts = ${common.extra_scripts}
   Marlin/src/HAL/DUE/upload_extra_script.py
 

commit 27bdf4b24e8da06ea7923b6382f38b5fb6292914
Author: Serhiy-K <52166448+Serhiy-K@users.noreply.github.com>
Date:   Mon Sep 28 09:52:38 2020 +0300

    MarlinUI for SPI/I2C TFT-GLCD character-based display bridge (#19375)

diff --git a/platformio.ini b/platformio.ini
index ff3c0fb810..c426c5223b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -26,7 +26,7 @@ include_dir  = Marlin
 #
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
-  -<src/lcd/HD44780> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/tft>
+  -<src/lcd/HD44780> -<src/lcd/TFTGLCD> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/tft>
   -<src/lcd/menu>
   -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>
   -<src/lcd/menu/game/maze.cpp> -<src/lcd/menu/game/snake.cpp>
@@ -216,6 +216,7 @@ HAS_MARLINUI_U8GLIB     = U8glib-HAL@~0.4.1
                           src_filter=+<src/lcd/dogm>
 HAS_GRAPHICAL_TFT       = src_filter=+<src/lcd/tft>
 DWIN_CREALITY_LCD       = src_filter=+<src/lcd/dwin>
+IS_TFTGLCD_PANEL        = src_filter=+<src/lcd/TFTGLCD>
 HAS_LCD_MENU            = src_filter=+<src/lcd/menu>
 HAS_GAMES               = src_filter=+<src/lcd/menu/game/game.cpp>
 MARLIN_BRICKOUT         = src_filter=+<src/lcd/menu/game/brickout.cpp>

commit c2c6a679ea4bdf48ce1800a8831fcec36c09ce53
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon Sep 28 01:13:27 2020 -0500

    Rename LCD conditionals (#19533)

diff --git a/platformio.ini b/platformio.ini
index 75c64504ca..ff3c0fb810 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -208,13 +208,14 @@ HAS_L64XX               = Arduino-L6470@0.8.0
 NEOPIXEL_LED            = Adafruit NeoPixel@1.5.0
                           src_filter=+<src/feature/leds/neopixel.cpp>
 MAX6675_IS_MAX31865     = Adafruit MAX31865 library@~1.1.0
-HAS_GRAPHICAL_LCD       = U8glib-HAL@~0.4.1
-                          src_filter=+<src/lcd/dogm>
 USES_LIQUIDCRYSTAL      = LiquidCrystal@1.5.0
 USES_LIQUIDTWI2         = LiquidTWI2@1.2.7
-DWIN_CREALITY_LCD       = src_filter=+<src/lcd/dwin>
-HAS_CHARACTER_LCD       = src_filter=+<src/lcd/HD44780>
+HAS_WIRED_LCD           = src_filter=+<src/lcd/lcdprint.cpp>
+HAS_MARLINUI_HD44780    = src_filter=+<src/lcd/HD44780>
+HAS_MARLINUI_U8GLIB     = U8glib-HAL@~0.4.1
+                          src_filter=+<src/lcd/dogm>
 HAS_GRAPHICAL_TFT       = src_filter=+<src/lcd/tft>
+DWIN_CREALITY_LCD       = src_filter=+<src/lcd/dwin>
 HAS_LCD_MENU            = src_filter=+<src/lcd/menu>
 HAS_GAMES               = src_filter=+<src/lcd/menu/game/game.cpp>
 MARLIN_BRICKOUT         = src_filter=+<src/lcd/menu/game/brickout.cpp>
@@ -246,7 +247,6 @@ HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus> +<src/lcd/extui/d
 TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
 EXTUI_EXAMPLE           = src_filter=+<src/lcd/extui/example.cpp>
 MALYAN_LCD              = src_filter=+<src/lcd/extui/malyan_lcd.cpp>
-HAS_SPI_LCD             = src_filter=+<src/lcd/lcdprint.cpp>
 USB_FLASH_DRIVE_SUPPORT = src_filter=+<src/sd/usb_flashdrive>
 AUTO_BED_LEVELING_BILINEAR = src_filter=+<src/feature/bedlevel/abl>
 AUTO_BED_LEVELING_(3POINT|(BI)?LINEAR) = src_filter=+<src/gcode/bedlevel/abl>

commit 1c372df449d18546b45860aa14a394ee2a3e900f
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon Sep 28 01:10:36 2020 -0500

    Prettier INI

diff --git a/platformio.ini b/platformio.ini
index bb4c74b7c6..75c64504ca 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -53,8 +53,8 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/extui/example.cpp>
   -<src/lcd/extui/malyan_lcd.cpp>
   -<src/lcd/extui/lib/ftdi_eve_touch_ui>
-  -<src/lcd/extui/anycubic_chiron_lcd.cpp> -<src/lcd/extui/lib/anycubic_i3mega>
-  -<src/lcd/extui/anycubic_i3mega_lcd.cpp>
+  -<src/lcd/extui/anycubic_chiron_lcd.cpp>
+  -<src/lcd/extui/anycubic_i3mega_lcd.cpp> -<src/lcd/extui/lib/anycubic_i3mega>
   -<src/lcd/lcdprint.cpp>
   -<src/sd/usb_flashdrive>
   -<src/feature/backlash.cpp>

commit 303d871ca78d7256b7ee0a493aed57f3b9d4974e
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon Sep 28 01:01:52 2020 -0500

    Update AnyCubic deps

diff --git a/platformio.ini b/platformio.ini
index f8ec029de3..bb4c74b7c6 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -53,8 +53,8 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/extui/example.cpp>
   -<src/lcd/extui/malyan_lcd.cpp>
   -<src/lcd/extui/lib/ftdi_eve_touch_ui>
-  -<src/lcd/extui/lib/anycubic_i3mega>
-  -<src/lcd/extui/anycubic_tft.cpp>
+  -<src/lcd/extui/anycubic_chiron_lcd.cpp> -<src/lcd/extui/lib/anycubic_i3mega>
+  -<src/lcd/extui/anycubic_i3mega_lcd.cpp>
   -<src/lcd/lcdprint.cpp>
   -<src/sd/usb_flashdrive>
   -<src/feature/backlash.cpp>
@@ -240,10 +240,10 @@ HAS_MENU_TEMPERATURE    = src_filter=+<src/lcd/menu/menu_temperature.cpp>
 HAS_MENU_TMC            = src_filter=+<src/lcd/menu/menu_tmc.cpp>
 HAS_MENU_TOUCH_SCREEN   = src_filter=+<src/lcd/menu/menu_touch_screen.cpp>
 HAS_MENU_UBL            = src_filter=+<src/lcd/menu/menu_ubl.cpp>
-ANYCUBIC_LCD_I3MEGA     = src_filter=+<src/lcd/extui/lib/anycubic_i3mega>
+ANYCUBIC_LCD_CHIRON     = src_filter=+<src/lcd/extui/anycubic_chiron_lcd.cpp>
+ANYCUBIC_LCD_I3MEGA     = src_filter=+<src/lcd/extui/anycubic_i3mega_lcd.cpp> +<src/lcd/extui/lib/anycubic_i3mega>
 HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus> +<src/lcd/extui/dgus_lcd.cpp>
 TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
-HAS_ANYCUBIC_TFT_EXTUI  = src_filter=+<src/lcd/extui/anycubic_tft.cpp>
 EXTUI_EXAMPLE           = src_filter=+<src/lcd/extui/example.cpp>
 MALYAN_LCD              = src_filter=+<src/lcd/extui/malyan_lcd.cpp>
 HAS_SPI_LCD             = src_filter=+<src/lcd/lcdprint.cpp>

commit 90bc1993b6811623dd9d0de00251e0c63415cb49
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Wed Sep 23 17:06:36 2020 -0300

    Include pins.h in dependencies script (#19468)

diff --git a/platformio.ini b/platformio.ini
index c68daf2c71..f8ec029de3 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -184,6 +184,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
 extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
+  post:buildroot/share/PlatformIO/scripts/common-dependencies-post.py
 build_flags        = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
 lib_deps           =
 

commit 5f5f76956f11c7c58278fd449f6ad85e07cd6e10
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue Sep 22 19:58:06 2020 -0500

    Fix up tests, warnings

diff --git a/platformio.ini b/platformio.ini
index c1b6f2c24d..c68daf2c71 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -207,7 +207,7 @@ HAS_L64XX               = Arduino-L6470@0.8.0
 NEOPIXEL_LED            = Adafruit NeoPixel@1.5.0
                           src_filter=+<src/feature/leds/neopixel.cpp>
 MAX6675_IS_MAX31865     = Adafruit MAX31865 library@~1.1.0
-HAS_GRAPHICAL_LCD       = U8glib-HAL@0.4.1
+HAS_GRAPHICAL_LCD       = U8glib-HAL@~0.4.1
                           src_filter=+<src/lcd/dogm>
 USES_LIQUIDCRYSTAL      = LiquidCrystal@1.5.0
 USES_LIQUIDTWI2         = LiquidTWI2@1.2.7

commit d8ed74904559aa8bdccc8b68acbccfbf1bf779d3
Author: makerbase <4164049@qq.com>
Date:   Mon Sep 21 09:55:02 2020 +0800

    Add MKS Robin E3P, improve LVGL UI (#19442)

diff --git a/platformio.ini b/platformio.ini
index bf43936df6..c1b6f2c24d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -191,7 +191,7 @@ lib_deps           =
 # Feature Dependencies
 #
 [features]
-HAS_TFT_LVGL_UI         = lvgl=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
+HAS_TFT_LVGL_UI         = lvgl=https://github.com/makerbase-mks/LVGL-6.1.1-MKS/archive/master.zip
                           src_filter=+<src/lcd/extui/lib/mks_ui>
                           extra_scripts=download_mks_assets.py
 HAS_TRINAMIC_CONFIG     = TMCStepper@~0.7.1
@@ -955,6 +955,22 @@ extra_scripts = ${common.extra_scripts}
 build_flags   = ${common_stm32f1.build_flags}
   -DDEBUG_LEVEL=0 -DSS_TIMER=4
 
+#
+# MKS Robin E3p (STM32F103VET6)
+#  - LVGL UI
+#
+[env:mks_robin_e3p]
+platform        = ${common_stm32f1.platform}
+extends         = common_stm32f1
+board           = genericSTM32F103VE
+platform_packages = tool-stm32duino
+extra_scripts   = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/mks_robin_e3p.py
+build_flags     = ${common_stm32f1.build_flags}
+  -DMCU_STM32F103VE -DSS_TIMER=4
+debug_tool      = jlink
+upload_protocol = jlink
+
 #
 # MKS Robin Lite/Lite2 (STM32F103RCT6)
 #

commit 073b7f1e3a77f6d00d58bb144fe3aa96ce3770f3
Author: cosmoderp <36945803+cosmoderp@users.noreply.github.com>
Date:   Thu Sep 17 06:35:04 2020 -0400

    E3 V2 DWIN: Z-Offset, cleanup, versatility (#19384)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index d0a4cb7b10..bf43936df6 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -153,7 +153,6 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/gcode/host/M360.cpp>
   -<src/gcode/host/M876.cpp>
   -<src/gcode/lcd/M0_M1.cpp>
-  -<src/gcode/lcd/M145.cpp>
   -<src/gcode/lcd/M250.cpp>
   -<src/gcode/lcd/M73.cpp>
   -<src/gcode/lcd/M995.cpp>
@@ -330,7 +329,6 @@ HOST_KEEPALIVE_FEATURE  = src_filter=+<src/gcode/host/M113.cpp>
 REPETIER_GCODE_M360     = src_filter=+<src/gcode/host/M360.cpp>
 HAS_GCODE_M876          = src_filter=+<src/gcode/host/M876.cpp>
 HAS_RESUME_CONTINUE     = src_filter=+<src/gcode/lcd/M0_M1.cpp>
-HAS_PREHEAT_COUNT       = src_filter=+<src/gcode/lcd/M145.cpp>
 HAS_LCD_CONTRAST        = src_filter=+<src/gcode/lcd/M250.cpp>
 LCD_SET_PROGRESS_MANUALLY = src_filter=+<src/gcode/lcd/M73.cpp>
 TOUCH_SCREEN_CALIBRATION = src_filter=+<src/gcode/lcd/M995.cpp>

commit cb9a34c6f75bed9d8782658d7680d77ea428f48d
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Fri Sep 11 00:12:49 2020 -0700

    Fix Creality RET6 env - RE (#19340)

diff --git a/platformio.ini b/platformio.ini
index 0c301a4044..d0a4cb7b10 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1065,7 +1065,7 @@ build_flags   = ${env:chitu_f103.build_flags} -DCHITU_V5_Z_MIN_BUGFIX
 [env:STM32F103RET6_creality]
 platform        = ${common_stm32f1.platform}
 extends         = common_stm32f1
-board           = genericSTM32F103RC
+board           = genericSTM32F103RE
 build_flags     = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY -DTEMP_TIMER_CHAN=4
 extra_scripts   = ${common.extra_scripts}

commit 160f70be6374d752a88ea5a98d351bc8d3a3903e
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Thu Sep 10 02:41:26 2020 -0300

    LPC: Finish DMA transfer, use HW SPI class (#19191)

diff --git a/platformio.ini b/platformio.ini
index 4a2abf5830..0c301a4044 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -623,6 +623,7 @@ debug_tool     = jlink
 #
 [common_LPC]
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.3.zip
+platform_packages = framework-arduino-lpc176x@^0.2.5
 board             = nxp_lpc1768
 lib_ldf_mode      = off
 lib_compat_mode   = strict

commit 700e0fe7d736de45cb7b1e82271dfa46e0288440
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Wed Sep 9 19:59:42 2020 -0700

    Warn in platformio.ini about RCT6 512K (#19312)

diff --git a/platformio.ini b/platformio.ini
index 38d874d865..4a2abf5830 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -739,6 +739,11 @@ upload_protocol   = serial
 #   STM32F103RC_btt_512K ........ RCT6 with 512K
 #   STM32F103RC_btt_512K_USB .... RCT6 with 512K (USB mass storage)
 #
+# WARNING! If you have an SKR Mini v1.1 or an SKR Mini E3 1.0 / 1.2 / 2.0 / DIP
+# and experience a printer freeze, re-flash Marlin using the regular (non-512K)
+# build option. 256K chips may be re-branded 512K chips, but this means the
+# upper 256K is sketchy, and failure is very likely.
+#
 
 [env:STM32F103RC_btt]
 platform          = ${common_stm32f1.platform}

commit 049fbc92a99d83178a5b99b14539b4ceeba8d5d4
Author: bilsef <bilsef1@gmail.com>
Date:   Wed Sep 9 16:57:20 2020 -0700

    Support for Teensy 4 (#19311)

diff --git a/platformio.ini b/platformio.ini
index f46e609969..38d874d865 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1264,6 +1264,19 @@ platform      = teensy
 board         = teensy35
 src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY35_36>
 
+[env:teensy36]
+platform      = teensy
+board         = teensy36
+src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY35_36>
+
+#
+# Teensy 4.0 / 4.1 (ARM Cortex-M7)
+#
+[env:teensy41]
+platform      = teensy
+board         = teensy41
+src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY40_41>
+
 #
 # Native
 # No supported Arduino libraries, base Marlin only

commit 4fc1aba8482920bcd5905f26642cec0de314ea09
Author: Jason Smith <jason.inet@gmail.com>
Date:   Mon Sep 7 19:41:48 2020 -0700

    Update HAL/STM32 platform to 8.0 (#18496)

diff --git a/platformio.ini b/platformio.ini
index e3ff6c1526..f46e609969 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -661,13 +661,10 @@ board     = nxp_lpc1769
 # HAL/STM32 Base Environment values
 #
 [common_stm32]
-platform      = ststm32@~6.1.0
-platform_packages = framework-arduinoststm32@>=4.10700,<4.10800
-lib_ignore    = SoftwareSerial
+platform      = ststm32@~8.0
 build_flags   = ${common.build_flags}
-  -IMarlin/src/HAL/STM32 -std=gnu++14
+  -std=gnu++14
   -DUSBCON -DUSBD_USE_CDC
-  -DUSBD_VID=0x0483
   -DTIM_IRQ_PRIO=13
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
@@ -676,7 +673,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 # HAL/STM32F1 Common Environment values
 #
 [common_stm32f1]
-platform      = ${common_stm32.platform}
+platform      = ststm32@~6.1
 build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL
 build_unflags = -std=gnu11 -std=gnu++11
@@ -828,7 +825,6 @@ platform      = ${common_stm32.platform}
 extends       = common_stm32
 board         = armed_v1
 build_flags   = ${common_stm32.build_flags}
-  '-DUSB_PRODUCT="ARMED_V1"'
   -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
 
 #
@@ -1008,20 +1004,29 @@ lib_ignore    = ${common_stm32f1.lib_ignore}
 platform    = ${common_stm32.platform}
 extends     = common_stm32
 board       = malyanM200v2
-build_flags = ${common_stm32.build_flags} -DSTM32F0xx -DUSB_PRODUCT=\"STM32F070RB\" -DHAL_PCD_MODULE_ENABLED
-  -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
+build_flags = ${common_stm32.build_flags} -DHAL_PCD_MODULE_ENABLED
+  -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
   -DCUSTOM_STARTUP_FILE
-lib_ignore  = SoftwareSerial
+
+#
+# Malyan M200 v2 (STM32F070CB)
+#
+[env:STM32F070CB_malyan]
+platform    = ${common_stm32.platform}
+extends     = common_stm32
+board       = malyanm200_f070cb
+build_flags = ${common_stm32.build_flags}
+  -DHAL_PCD_MODULE_ENABLED -DDISABLE_GENERIC_SERIALUSB -DHAL_UART_MODULE_ENABLED -DCUSTOM_STARTUP_FILE
 
 #
 # Malyan M300 (STM32F070CB)
 #
 [env:malyan_M300]
-platform    = ststm32@>=6.1.0,<6.2.0
+platform    = ${common_stm32.platform}
+extends     = common_stm32
 board       = malyanm300_f070cb
-build_flags = ${common.build_flags}
-  -DUSBCON -DUSBD_VID=0x0483 "-DUSB_MANUFACTURER=\"Unknown\"" "-DUSB_PRODUCT=\"MALYAN_M300\""
-  -DHAL_PCD_MODULE_ENABLED -DUSBD_USE_CDC -DDISABLE_GENERIC_SERIALUSB -DHAL_UART_MODULE_ENABLED
+build_flags = ${common_stm32.build_flags}
+  -DHAL_PCD_MODULE_ENABLED -DDISABLE_GENERIC_SERIALUSB -DHAL_UART_MODULE_ENABLED
 src_filter  = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
@@ -1074,13 +1079,11 @@ platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = STEVAL_STM32F401VE
 build_flags       = ${common_stm32.build_flags}
-  -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
-  -DUSB_PRODUCT=\"STEVAL_F401VE\"
+  -DARDUINO_STEVAL -DSTM32F401xE
   -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/STEVAL__F401XX.py
-lib_ignore        = SoftwareSerial
 
 #
 # FLYF407ZG
@@ -1090,8 +1093,7 @@ platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = FLYF407ZG
 build_flags       = ${common_stm32.build_flags}
-  -DSTM32F4 -DUSB_PRODUCT=\"STM32F407ZG\"
-  -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x8000
+  -DVECT_TAB_OFFSET=0x8000
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
@@ -1101,14 +1103,13 @@ extra_scripts     = ${common.extra_scripts}
 [env:FYSETC_S6]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
-platform_packages = ${common_stm32.platform_packages}
-   tool-stm32duino
-board             = fysetc_s6
+platform_packages = tool-stm32duino
+board             = marlin_fysetc_s6
 build_flags       = ${common_stm32.build_flags}
-  -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x10000
-  -DHAL_PCD_MODULE_ENABLED '-DUSB_PRODUCT="FYSETC_S6"'
+  -DVECT_TAB_OFFSET=0x10000
+  -DHAL_PCD_MODULE_ENABLED
 extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 debug_tool        = stlink
 upload_protocol   = dfu
 upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
@@ -1123,12 +1124,10 @@ platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = blackSTM32F407VET6
 build_flags       = ${common_stm32.build_flags}
-  -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
-  -DUSB_PRODUCT=\"BLACK_F407VE\"
+  -DARDUINO_BLACK_F407VE
   -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_ignore        = SoftwareSerial
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
@@ -1138,8 +1137,7 @@ platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = BigTree_SKR_Pro
 build_flags       = ${common_stm32.build_flags}
-  -DUSB_PRODUCT=\"STM32F407ZG\"
-  -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
+  -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 #upload_protocol   = stlink
@@ -1151,14 +1149,13 @@ debug_init_break  =
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_GTR_V1_0]
-platform          = ststm32@>=5.7.0,<6.2.0
+platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = BigTree_GTR_v1
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags       = ${common_stm32.build_flags}
-  -DUSB_PRODUCT=\"STM32F407IG\"
-  -DTARGET_STM32F4 -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
+  -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
 
 #
 # BigTreeTech BTT002 V1.0 (STM32F407VGT6 ARM Cortex-M4)
@@ -1168,8 +1165,7 @@ platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = BigTree_Btt002
 build_flags       = ${common_stm32.build_flags}
-  -DUSB_PRODUCT=\"STM32F407VG\"
-  -DTARGET_STM32F4 -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
+  -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DHAVE_HWSERIAL2
   -DHAVE_HWSERIAL3
   -DPIN_SERIAL2_RX=PD_6
@@ -1226,10 +1222,10 @@ platform      = ${common_stm32.platform}
 extends       = common_stm32
 build_flags   = ${common_stm32.build_flags}
   -Os
-  "-DUSB_PRODUCT=\"RUMBA32\""
   -DHAL_PCD_MODULE_ENABLED
   -DDISABLE_GENERIC_SERIALUSB
   -DHAL_UART_MODULE_ENABLED
+  -DTIMER_SERIAL=TIM9
 board         = rumba32_f446ve
 upload_protocol = dfu
 monitor_speed = 500000

commit 853aec2c9a355c262001e0a0516bbb0decfd7749
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Thu Aug 20 01:38:22 2020 -0500

    Move ExtUI displays to sub-folder (#19070)

diff --git a/platformio.ini b/platformio.ini
index 27b11b2aa7..e3ff6c1526 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -49,12 +49,12 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/menu/menu_touch_screen.cpp>
   -<src/lcd/menu/menu_ubl.cpp>
   -<src/lcd/extui/lib/mks_ui>
-  -<src/lcd/extui/lib/dgus> -<src/lcd/extui_dgus_lcd.cpp>
-  -<src/lcd/extui_example.cpp>
-  -<src/lcd/extui_malyan_lcd.cpp>
+  -<src/lcd/extui/lib/dgus> -<src/lcd/extui/dgus_lcd.cpp>
+  -<src/lcd/extui/example.cpp>
+  -<src/lcd/extui/malyan_lcd.cpp>
   -<src/lcd/extui/lib/ftdi_eve_touch_ui>
   -<src/lcd/extui/lib/anycubic_i3mega>
-  -<src/lcd/extui_anycubic_tft.cpp>
+  -<src/lcd/extui/anycubic_tft.cpp>
   -<src/lcd/lcdprint.cpp>
   -<src/sd/usb_flashdrive>
   -<src/feature/backlash.cpp>
@@ -241,11 +241,11 @@ HAS_MENU_TMC            = src_filter=+<src/lcd/menu/menu_tmc.cpp>
 HAS_MENU_TOUCH_SCREEN   = src_filter=+<src/lcd/menu/menu_touch_screen.cpp>
 HAS_MENU_UBL            = src_filter=+<src/lcd/menu/menu_ubl.cpp>
 ANYCUBIC_LCD_I3MEGA     = src_filter=+<src/lcd/extui/lib/anycubic_i3mega>
-HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus> +<src/lcd/extui_dgus_lcd.cpp>
+HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus> +<src/lcd/extui/dgus_lcd.cpp>
 TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
-HAS_ANYCUBIC_TFT_EXTUI  = src_filter=+<src/lcd/extui_anycubic_tft.cpp>
-EXTUI_EXAMPLE           = src_filter=+<src/lcd/extui_example.cpp>
-MALYAN_LCD              = src_filter=+<src/lcd/extui_malyan_lcd.cpp>
+HAS_ANYCUBIC_TFT_EXTUI  = src_filter=+<src/lcd/extui/anycubic_tft.cpp>
+EXTUI_EXAMPLE           = src_filter=+<src/lcd/extui/example.cpp>
+MALYAN_LCD              = src_filter=+<src/lcd/extui/malyan_lcd.cpp>
 HAS_SPI_LCD             = src_filter=+<src/lcd/lcdprint.cpp>
 USB_FLASH_DRIVE_SUPPORT = src_filter=+<src/sd/usb_flashdrive>
 AUTO_BED_LEVELING_BILINEAR = src_filter=+<src/feature/bedlevel/abl>

commit 64e181979c347ff5a12eb33b03e527216088eca7
Author: ellensp <ellensp@hotmail.com>
Date:   Thu Aug 20 12:18:39 2020 +1200

    Env mega2560ext adds pins 70-85 (#19022)

diff --git a/platformio.ini b/platformio.ini
index 10990b4d21..27b11b2aa7 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -406,9 +406,20 @@ src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
 # ATmega2560
 #
 [env:mega2560]
-platform      = atmelavr
-extends       = common_avr8
-board         = megaatmega2560
+platform            = atmelavr
+extends             = common_avr8
+board               = megaatmega2560
+
+#
+# ATmega2560 with extended pins 70-85 defined
+#
+[env:mega2560ext]
+platform            = atmelavr
+extends             = mega2560
+board               = megaatmega2560
+board_build.variant = megaextendedpins
+extra_scripts       = ${common.extra_scripts}
+                      pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
 
 #
 # ATmega1280

commit 852e5ae0421810ecc6f44631237208030e70751f
Author: sherwin-dc <59867245+sherwin-dc@users.noreply.github.com>
Date:   Sun Aug 9 09:00:42 2020 +0800

    Password via G-code and MarlinUI (#18399)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index fdb120ae88..10990b4d21 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -41,6 +41,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/lcd/menu/menu_led.cpp>
   -<src/lcd/menu/menu_media.cpp>
   -<src/lcd/menu/menu_mmu2.cpp>
+  -<src/lcd/menu/menu_password.cpp>
   -<src/lcd/menu/menu_power_monitor.cpp>
   -<src/lcd/menu/menu_spindle_laser.cpp>
   -<src/lcd/menu/menu_temperature.cpp>
@@ -86,6 +87,7 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
   -<src/feature/max7219.cpp>
   -<src/feature/mixing.cpp>
   -<src/feature/mmu2> -<src/gcode/feature/prusa_MMU2>
+  -<src/feature/password> -<src/gcode/feature/password>
   -<src/feature/pause.cpp>
   -<src/feature/power.cpp>
   -<src/feature/power_monitor.cpp> -<src/gcode/feature/power_monitor>
@@ -231,6 +233,7 @@ HAS_MENU_LED            = src_filter=+<src/lcd/menu/menu_led.cpp>
 HAS_MENU_MEDIA          = src_filter=+<src/lcd/menu/menu_media.cpp>
 HAS_MENU_MIXER          = src_filter=+<src/lcd/menu/menu_mixer.cpp>
 HAS_MENU_MMU2           = src_filter=+<src/lcd/menu/menu_mmu2.cpp>
+HAS_MENU_PASSWORD       = src_filter=+<src/lcd/menu/menu_password.cpp>
 HAS_MENU_POWER_MONITOR  = src_filter=+<src/lcd/menu/menu_power_monitor.cpp>
 HAS_MENU_CUTTER         = src_filter=+<src/lcd/menu/menu_spindle_laser.cpp>
 HAS_MENU_TEMPERATURE    = src_filter=+<src/lcd/menu/menu_temperature.cpp>
@@ -276,6 +279,7 @@ TEMP_STAT_LEDS          = src_filter=+<src/feature/leds/tempstat.cpp>
 MAX7219_DEBUG           = src_filter=+<src/feature/max7219.cpp> +<src/gcode/feature/leds/M7219.cpp>
 MIXING_EXTRUDER         = src_filter=+<src/feature/mixing.cpp> +<src/gcode/feature/mixing/M163-M165.cpp>
 PRUSA_MMU2              = src_filter=+<src/feature/mmu2> +<src/gcode/feature/prusa_MMU2>
+PASSWORD_FEATURE        = src_filter=+<src/feature/password> +<src/gcode/feature/password>
 ADVANCED_PAUSE_FEATURE  = src_filter=+<src/feature/pause.cpp> +<src/gcode/feature/pause/M600.cpp> +<src/gcode/feature/pause/M603.cpp>
 AUTO_POWER_CONTROL      = src_filter=+<src/feature/power.cpp>
 HAS_POWER_MONITOR       = src_filter=+<src/feature/power_monitor.cpp> +<src/gcode/feature/power_monitor>

commit da4eaebdc9c1adc7387e302fe6516ed009974edd
Author: wmariz <11435639+wmariz@users.noreply.github.com>
Date:   Fri Aug 7 19:03:59 2020 -0300

    ZoneStar Z6FB (#18918)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index ee4d4e12f8..fdb120ae88 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -869,7 +869,6 @@ board           = genericSTM32F103VE
 platform_packages = tool-stm32duino
 extra_scripts   = ${common.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_nano35.py
-lib_deps        = ${common_stm32f1.lib_deps}
 build_flags     = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE -DSS_TIMER=4
 debug_tool      = jlink

commit c3fdc7f81ec015fff664c4cddb61077e503e6a3f
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Thu Aug 6 19:33:42 2020 -0300

    Apply PIO-supported custom_option for deps (#18935)

diff --git a/platformio.ini b/platformio.ini
index 6c3214d544..ee4d4e12f8 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -594,7 +594,7 @@ src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
 lib_deps       = ${common.lib_deps}
   SoftwareSerialM
   Adafruit SPIFlash
-marlin.SDSUPPORT = SdFat - Adafruit Fork
+custom_marlin.SDSUPPORT = SdFat - Adafruit Fork
 debug_tool     = jlink
 
 #################################
@@ -616,8 +616,8 @@ extra_scripts     = ${common.extra_scripts}
 src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
 lib_deps          = ${common.lib_deps}
   Servo
-marlin.USES_LIQUIDCRYSTAL = LiquidCrystal@1.0.0
-marlin.NEOPIXEL_LED = Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/1.5.0.zip
+custom_marlin.USES_LIQUIDCRYSTAL = LiquidCrystal@1.0.0
+custom_marlin.NEOPIXEL_LED = Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/1.5.0.zip
 build_flags       = ${common.build_flags} -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g
   # debug options for backtrace
   #-funwind-tables
@@ -702,7 +702,7 @@ extra_scripts     = ${common.extra_scripts}
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM
   USBComposite for STM32F1@0.91
-marlin.NEOPIXEL_LED = Adafruit NeoPixel=https://github.com/ccccmagicboy/Adafruit_NeoPixel#meeb_3dp_use
+custom_marlin.NEOPIXEL_LED = Adafruit NeoPixel=https://github.com/ccccmagicboy/Adafruit_NeoPixel#meeb_3dp_use
 debug_tool        = stlink
 upload_protocol   = dfu
 

commit 99ba866d8d3c9abc16558ca12ba34efb9a7922e5
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Thu Aug 6 08:14:00 2020 -0500

    Optimize G-code / feature dependencies (#18919)

diff --git a/platformio.ini b/platformio.ini
index 029ce65881..6c3214d544 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -26,15 +26,160 @@ include_dir  = Marlin
 #
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
-  -<src/lcd/HD44780> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/menu>
-  -<src/lcd/extui/lib/mks_ui> -<src/lcd/extui/lib/dgus> -<src/lcd/extui/lib/ftdi_eve_touch_ui> -<src/lcd/extui/lib/anycubic>
+  -<src/lcd/HD44780> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/tft>
+  -<src/lcd/menu>
+  -<src/lcd/menu/game/game.cpp> -<src/lcd/menu/game/brickout.cpp> -<src/lcd/menu/game/invaders.cpp>
+  -<src/lcd/menu/game/maze.cpp> -<src/lcd/menu/game/snake.cpp>
+  -<src/lcd/menu/menu_backlash.cpp>
+  -<src/lcd/menu/menu_bed_corners.cpp>
+  -<src/lcd/menu/menu_bed_leveling.cpp>
+  -<src/lcd/menu/menu_cancelobject.cpp>
+  -<src/lcd/menu/menu_delta_calibrate.cpp>
+  -<src/lcd/menu/menu_filament.cpp>
+  -<src/lcd/menu/menu_info.cpp>
+  -<src/lcd/menu/menu_job_recovery.cpp>
+  -<src/lcd/menu/menu_led.cpp>
+  -<src/lcd/menu/menu_media.cpp>
+  -<src/lcd/menu/menu_mmu2.cpp>
+  -<src/lcd/menu/menu_power_monitor.cpp>
+  -<src/lcd/menu/menu_spindle_laser.cpp>
+  -<src/lcd/menu/menu_temperature.cpp>
+  -<src/lcd/menu/menu_tmc.cpp>
+  -<src/lcd/menu/menu_touch_screen.cpp>
+  -<src/lcd/menu/menu_ubl.cpp>
+  -<src/lcd/extui/lib/mks_ui>
+  -<src/lcd/extui/lib/dgus> -<src/lcd/extui_dgus_lcd.cpp>
+  -<src/lcd/extui_example.cpp>
+  -<src/lcd/extui_malyan_lcd.cpp>
+  -<src/lcd/extui/lib/ftdi_eve_touch_ui>
+  -<src/lcd/extui/lib/anycubic_i3mega>
+  -<src/lcd/extui_anycubic_tft.cpp>
+  -<src/lcd/lcdprint.cpp>
   -<src/sd/usb_flashdrive>
-  -<src/gcode/feature/trinamic>
+  -<src/feature/backlash.cpp>
+  -<src/feature/baricuda.cpp> -<src/gcode/feature/baricuda>
   -<src/feature/bedlevel/abl> -<src/gcode/bedlevel/abl>
   -<src/feature/bedlevel/mbl> -<src/gcode/bedlevel/mbl>
   -<src/feature/bedlevel/ubl> -<src/gcode/bedlevel/ubl>
+  -<src/feature/binary_stream.cpp> -<src/libs/heatshrink>
+  -<src/feature/bltouch.cpp>
+  -<src/feature/cancel_object.cpp> -<src/gcode/feature/cancel>
+  -<src/feature/caselight> -<src/gcode/feature/caselight>
+  -<src/feature/closedloop.cpp>
+  -<src/feature/controllerfan.cpp> -<src/gcode/feature/controllerfan>
   -<src/feature/dac> -<src/feature/digipot>
-  -<src/feature/leds>
+  -<src/feature/direct_stepping.cpp> -<src/gcode/motion/G6.cpp>
+  -<src/feature/e_parser.cpp>
+  -<src/feature/encoder_i2c.cpp>
+  -<src/feature/fanmux.cpp>
+  -<src/feature/filwidth.cpp> -<src/gcode/feature/filwidth>
+  -<src/feature/fwretract.cpp> -<src/gcode/feature/fwretract>
+  -<src/feature/host_actions.cpp>
+  -<src/feature/hotend_idle.cpp>
+  -<src/feature/joystick.cpp>
+  -<src/feature/leds/blinkm.cpp>
+  -<src/feature/leds/leds.cpp>
+  -<src/feature/leds/pca9533.cpp>
+  -<src/feature/leds/pca9632.cpp>
+  -<src/feature/leds/printer_event_leds.cpp>
+  -<src/feature/leds/tempstat.cpp>
+  -<src/feature/max7219.cpp>
+  -<src/feature/mixing.cpp>
+  -<src/feature/mmu2> -<src/gcode/feature/prusa_MMU2>
+  -<src/feature/pause.cpp>
+  -<src/feature/power.cpp>
+  -<src/feature/power_monitor.cpp> -<src/gcode/feature/power_monitor>
+  -<src/feature/powerloss.cpp> -<src/gcode/feature/powerloss>
+  -<src/feature/probe_temp_comp.cpp>
+  -<src/feature/runout.cpp> -<src/gcode/feature/runout>
+  -<src/feature/snmm.cpp>
+  -<src/feature/solenoid.cpp>
+  -<src/feature/spindle_laser.cpp> -<src/gcode/control/M3-M5.cpp>
+  -<src/feature/tmc_util.cpp> -<src/module/stepper/trinamic.cpp>
+  -<src/feature/twibus.cpp>
+  -<src/feature/z_stepper_align.cpp>
+  -<src/gcode/bedlevel/G26.cpp>
+  -<src/gcode/bedlevel/G35.cpp>
+  -<src/gcode/bedlevel/G42.cpp>
+  -<src/gcode/bedlevel/M420.cpp>
+  -<src/gcode/calibrate/G33.cpp>
+  -<src/gcode/calibrate/G34_M422.cpp>
+  -<src/gcode/calibrate/G76_M871.cpp>
+  -<src/gcode/calibrate/G425.cpp>
+  -<src/gcode/calibrate/M12.cpp>
+  -<src/gcode/calibrate/M48.cpp>
+  -<src/gcode/calibrate/M100.cpp>
+  -<src/gcode/calibrate/M425.cpp>
+  -<src/gcode/calibrate/M666.cpp>
+  -<src/gcode/calibrate/M852.cpp>
+  -<src/gcode/config/M43.cpp>
+  -<src/gcode/config/M217.cpp>
+  -<src/gcode/config/M218.cpp>
+  -<src/gcode/config/M221.cpp>
+  -<src/gcode/config/M281.cpp>
+  -<src/gcode/config/M302.cpp>
+  -<src/gcode/config/M305.cpp>
+  -<src/gcode/config/M540.cpp>
+  -<src/gcode/control/M7-M9.cpp>
+  -<src/gcode/control/M211.cpp>
+  -<src/gcode/control/M605.cpp>
+  -<src/gcode/feature/advance>
+  -<src/gcode/feature/camera>
+  -<src/gcode/feature/i2c>
+  -<src/gcode/feature/L6470>
+  -<src/gcode/feature/leds/M150.cpp>
+  -<src/gcode/feature/leds/M7219.cpp>
+  -<src/gcode/feature/macro>
+  -<src/gcode/feature/mixing/M163-M165.cpp>
+  -<src/gcode/feature/mixing/M166.cpp>
+  -<src/gcode/feature/pause/G27.cpp>
+  -<src/gcode/feature/pause/G60.cpp>
+  -<src/gcode/feature/pause/G61.cpp>
+  -<src/gcode/feature/pause/M125.cpp>
+  -<src/gcode/feature/pause/M600.cpp>
+  -<src/gcode/feature/pause/M603.cpp>
+  -<src/gcode/feature/pause/M701_M702.cpp>
+  -<src/gcode/feature/trinamic/M122.cpp>
+  -<src/gcode/feature/trinamic/M569.cpp>
+  -<src/gcode/feature/trinamic/M906.cpp>
+  -<src/gcode/feature/trinamic/M911-M914.cpp>
+  -<src/gcode/geometry/G17-G19.cpp>
+  -<src/gcode/geometry/G53-G59.cpp>
+  -<src/gcode/geometry/M206_M428.cpp>
+  -<src/gcode/host/M16.cpp>
+  -<src/gcode/host/M113.cpp>
+  -<src/gcode/host/M360.cpp>
+  -<src/gcode/host/M876.cpp>
+  -<src/gcode/lcd/M0_M1.cpp>
+  -<src/gcode/lcd/M145.cpp>
+  -<src/gcode/lcd/M250.cpp>
+  -<src/gcode/lcd/M73.cpp>
+  -<src/gcode/lcd/M995.cpp>
+  -<src/gcode/motion/G2_G3.cpp>
+  -<src/gcode/motion/G5.cpp>
+  -<src/gcode/motion/G80.cpp>
+  -<src/gcode/motion/M290.cpp>
+  -<src/gcode/probe/G30.cpp>
+  -<src/gcode/probe/G31_G32.cpp>
+  -<src/gcode/probe/G38.cpp>
+  -<src/gcode/probe/M401_M402.cpp>
+  -<src/gcode/probe/M851.cpp>
+  -<src/gcode/probe/M951.cpp>
+  -<src/gcode/scara>
+  -<src/gcode/sd>
+  -<src/gcode/temp/M104_M109.cpp>
+  -<src/gcode/units/G20_G21.cpp>
+  -<src/gcode/units/M149.cpp>
+  -<src/libs/L64XX> -<src/module/stepper/L64xx.cpp>
+  -<src/libs/hex_print.cpp>
+  -<src/libs/least_squares_fit.cpp>
+  -<src/libs/nozzle.cpp> -<src/gcode/feature/clean>
+  -<src/module/delta.cpp>
+  -<src/module/planner_bezier.cpp>
+  -<src/module/printcounter.cpp>
+  -<src/module/probe.cpp>
+  -<src/module/scara.cpp> -<src/gcode/calibrate/M665.cpp>
+  -<src/module/stepper/TMC26X.cpp>
 extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
@@ -49,12 +194,17 @@ HAS_TFT_LVGL_UI         = lvgl=https://github.com/makerbase-mks/MKS-LittlevGL/ar
                           src_filter=+<src/lcd/extui/lib/mks_ui>
                           extra_scripts=download_mks_assets.py
 HAS_TRINAMIC_CONFIG     = TMCStepper@~0.7.1
-                          src_filter=+<src/gcode/feature/trinamic>
+                          src_filter=+<src/feature/tmc_util.cpp> +<src/module/stepper/trinamic.cpp> +<src/gcode/feature/trinamic/M122.cpp> +<src/gcode/feature/trinamic/M906.cpp> +<src/gcode/feature/trinamic/M911-M914.cpp>
+HAS_STEALTHCHOP         = src_filter=+<src/gcode/feature/trinamic/M569.cpp>
 SR_LCD_3W_NL            = SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-DIGIPOT_MCP4...         = SlowSoftI2CMaster
+HAS_I2C_DIGIPOT         = SlowSoftI2CMaster
+                          src_filter=+<src/feature/digipot>
 HAS_TMC26X              = TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+                          src_filter=+<src/module/TMC26X.cpp>
 HAS_L64XX               = Arduino-L6470@0.8.0
+                          src_filter=+<src/libs/L64XX> +<src/module/stepper/L64xx.cpp> +<src/gcode/feature/L6470>
 NEOPIXEL_LED            = Adafruit NeoPixel@1.5.0
+                          src_filter=+<src/feature/leds/neopixel.cpp>
 MAX6675_IS_MAX31865     = Adafruit MAX31865 library@~1.1.0
 HAS_GRAPHICAL_LCD       = U8glib-HAL@0.4.1
                           src_filter=+<src/lcd/dogm>
@@ -64,17 +214,143 @@ DWIN_CREALITY_LCD       = src_filter=+<src/lcd/dwin>
 HAS_CHARACTER_LCD       = src_filter=+<src/lcd/HD44780>
 HAS_GRAPHICAL_TFT       = src_filter=+<src/lcd/tft>
 HAS_LCD_MENU            = src_filter=+<src/lcd/menu>
-HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus>
-TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
+HAS_GAMES               = src_filter=+<src/lcd/menu/game/game.cpp>
+MARLIN_BRICKOUT         = src_filter=+<src/lcd/menu/game/brickout.cpp>
+MARLIN_INVADERS         = src_filter=+<src/lcd/menu/game/invaders.cpp>
+MARLIN_MAZE             = src_filter=+<src/lcd/menu/game/maze.cpp>
+MARLIN_SNAKE            = src_filter=+<src/lcd/menu/game/snake.cpp>
+HAS_MENU_BACKLASH       = src_filter=+<src/lcd/menu/menu_backlash.cpp>
+HAS_MENU_BED_CORNERS    = src_filter=+<src/lcd/menu/menu_bed_corners.cpp>
+LCD_BED_LEVELING        = src_filter=+<src/lcd/menu/menu_bed_leveling.cpp>
+HAS_MENU_CANCELOBJECT   = src_filter=+<src/lcd/menu/menu_cancelobject.cpp>
+HAS_MENU_DELTA_CALIBRATE = src_filter=+<src/lcd/menu/menu_delta_calibrate.cpp>
+HAS_MENU_FILAMENT       = src_filter=+<src/lcd/menu/menu_filament.cpp>
+LCD_INFO_MENU           = src_filter=+<src/lcd/menu/menu_info.cpp>
+HAS_MENU_JOB_RECOVERY   = src_filter=+<src/lcd/menu/menu_job_recovery.cpp>
+HAS_MENU_LED            = src_filter=+<src/lcd/menu/menu_led.cpp>
+HAS_MENU_MEDIA          = src_filter=+<src/lcd/menu/menu_media.cpp>
+HAS_MENU_MIXER          = src_filter=+<src/lcd/menu/menu_mixer.cpp>
+HAS_MENU_MMU2           = src_filter=+<src/lcd/menu/menu_mmu2.cpp>
+HAS_MENU_POWER_MONITOR  = src_filter=+<src/lcd/menu/menu_power_monitor.cpp>
+HAS_MENU_CUTTER         = src_filter=+<src/lcd/menu/menu_spindle_laser.cpp>
+HAS_MENU_TEMPERATURE    = src_filter=+<src/lcd/menu/menu_temperature.cpp>
+HAS_MENU_TMC            = src_filter=+<src/lcd/menu/menu_tmc.cpp>
+HAS_MENU_TOUCH_SCREEN   = src_filter=+<src/lcd/menu/menu_touch_screen.cpp>
+HAS_MENU_UBL            = src_filter=+<src/lcd/menu/menu_ubl.cpp>
 ANYCUBIC_LCD_I3MEGA     = src_filter=+<src/lcd/extui/lib/anycubic_i3mega>
+HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus> +<src/lcd/extui_dgus_lcd.cpp>
+TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
+HAS_ANYCUBIC_TFT_EXTUI  = src_filter=+<src/lcd/extui_anycubic_tft.cpp>
+EXTUI_EXAMPLE           = src_filter=+<src/lcd/extui_example.cpp>
+MALYAN_LCD              = src_filter=+<src/lcd/extui_malyan_lcd.cpp>
+HAS_SPI_LCD             = src_filter=+<src/lcd/lcdprint.cpp>
 USB_FLASH_DRIVE_SUPPORT = src_filter=+<src/sd/usb_flashdrive>
-AUTO_BED_LEVELING_(3POINT|(BI)?LINEAR) = src_filter=+<src/feature/bedlevel/abl> +<src/gcode/bedlevel/abl>
+AUTO_BED_LEVELING_BILINEAR = src_filter=+<src/feature/bedlevel/abl>
+AUTO_BED_LEVELING_(3POINT|(BI)?LINEAR) = src_filter=+<src/gcode/bedlevel/abl>
 MESH_BED_LEVELING       = src_filter=+<src/feature/bedlevel/mbl> +<src/gcode/bedlevel/mbl>
 AUTO_BED_LEVELING_UBL   = src_filter=+<src/feature/bedlevel/ubl> +<src/gcode/bedlevel/ubl>
+BACKLASH_COMPENSATION   = src_filter=+<src/feature/backlash.cpp>
+BARICUDA                = src_filter=+<src/feature/baricuda.cpp> +<src/gcode/feature/baricuda>
+BINARY_FILE_TRANSFER    = src_filter=+<src/feature/binary_stream.cpp> +<src/libs/heatshrink>
+BLTOUCH                 = src_filter=+<src/feature/bltouch.cpp>
+CANCEL_OBJECTS          = src_filter=+<src/feature/cancel_object.cpp> +<src/gcode/feature/cancel>
+CASE_LIGHT_ENABLE       = src_filter=+<src/feature/caselight> +<src/gcode/feature/caselight>
+EXTERNAL_CLOSED_LOOP_CONTROLLER = src_filter=+<src/feature/closedloop.cpp> +<src/gcode/calibrate/M12.cpp>
+USE_CONTROLLER_FAN      = src_filter=+<src/feature/controllerfan.cpp>
 DAC_STEPPER_CURRENT     = src_filter=+<src/feature/dac>
-HAS_I2C_DIGIPOT         = src_filter=+<src/feature/digipot>
-HAS_LED_FEATURE         = src_filter=+<src/feature/leds>
-(ESP3D_)?WIFISUPPORT = AsyncTCP, ESP Async WebServer
+DIRECT_STEPPING         = src_filter=+<src/feature/direct_stepping.cpp> +<src/gcode/motion/G6.cpp>
+EMERGENCY_PARSER        = src_filter=+<src/feature/e_parser.cpp> -<src/gcode/control/M108_*.cpp>
+I2C_POSITION_ENCODERS   = src_filter=+<src/feature/encoder_i2c.cpp>
+HAS_FANMUX              = src_filter=+<src/feature/fanmux.cpp>
+FILAMENT_WIDTH_SENSOR   = src_filter=+<src/feature/filwidth.cpp> +<src/gcode/feature/filwidth>
+FWRETRACT               = src_filter=+<src/feature/fwretract.cpp> +<src/gcode/feature/fwretract>
+HOST_ACTION_COMMANDS    = src_filter=+<src/feature/host_actions.cpp>
+HOTEND_IDLE_TIMEOUT     = src_filter=+<src/feature/hotend_idle.cpp>
+JOYSTICK                = src_filter=+<src/feature/joystick.cpp>
+BLINKM                  = src_filter=+<src/feature/leds/blinkm.cpp>
+HAS_COLOR_LEDS          = src_filter=+<src/feature/leds/leds.cpp> +<src/gcode/feature/leds/M150.cpp>
+PCA9533                 = src_filter=+<src/feature/leds/pca9533.cpp>
+PCA9632                 = src_filter=+<src/feature/leds/pca9632.cpp>
+PRINTER_EVENT_LEDS      = src_filter=+<src/feature/leds/printer_event_leds.cpp>
+TEMP_STAT_LEDS          = src_filter=+<src/feature/leds/tempstat.cpp>
+MAX7219_DEBUG           = src_filter=+<src/feature/max7219.cpp> +<src/gcode/feature/leds/M7219.cpp>
+MIXING_EXTRUDER         = src_filter=+<src/feature/mixing.cpp> +<src/gcode/feature/mixing/M163-M165.cpp>
+PRUSA_MMU2              = src_filter=+<src/feature/mmu2> +<src/gcode/feature/prusa_MMU2>
+ADVANCED_PAUSE_FEATURE  = src_filter=+<src/feature/pause.cpp> +<src/gcode/feature/pause/M600.cpp> +<src/gcode/feature/pause/M603.cpp>
+AUTO_POWER_CONTROL      = src_filter=+<src/feature/power.cpp>
+HAS_POWER_MONITOR       = src_filter=+<src/feature/power_monitor.cpp> +<src/gcode/feature/power_monitor>
+POWER_LOSS_RECOVERY     = src_filter=+<src/feature/powerloss.cpp> +<src/gcode/feature/powerloss>
+PROBE_TEMP_COMPENSATION = src_filter=+<src/feature/probe_temp_comp.cpp> +<src/gcode/calibrate/G76_M871.cpp>
+HAS_FILAMENT_SENSOR     = src_filter=+<src/feature/runout.cpp> +<src/gcode/feature/runout>
+MK2_MULTIPLEXER         = src_filter=+<src/feature/snmm.cpp>
+EXT_SOLENOID|MANUAL_SOLENOID_CONTROL = src_filter=+<src/feature/solenoid.cpp>
+HAS_CUTTER              = src_filter=+<src/feature/spindle_laser.cpp> +<src/gcode/control/M3-M5.cpp>
+EXPERIMENTAL_I2CBUS     = src_filter=+<src/feature/twibus.cpp> +<src/gcode/feature/i2c>
+Z_STEPPER_AUTO_ALIGN    = src_filter=+<src/feature/z_stepper_align.cpp> +<src/gcode/calibrate/G34_M422.cpp>
+G26_MESH_VALIDATION     = src_filter=+<src/gcode/bedlevel/G26.cpp>
+ASSISTED_TRAMMING       = src_filter=+<src/gcode/bedlevel/G35.cpp>
+HAS_MESH                = src_filter=+<src/gcode/bedlevel/G42.cpp>
+HAS_LEVELING            = src_filter=+<src/gcode/bedlevel/M420.cpp>
+DELTA_AUTO_CALIBRATION  = src_filter=+<src/gcode/calibrate/G33.cpp>
+CALIBRATION_GCODE       = src_filter=+<src/gcode/calibrate/G425.cpp>
+Z_MIN_PROBE_REPEATABILITY_TEST = src_filter=+<src/gcode/calibrate/M48.cpp>
+M100_FREE_MEMORY_WATCHER = src_filter=+<src/gcode/calibrate/M100.cpp>
+BACKLASH_GCODE          = src_filter=+<src/gcode/calibrate/M425.cpp>
+IS_KINEMATIC            = src_filter=+<src/gcode/calibrate/M665.cpp>
+HAS_EXTRA_ENDSTOPS      = src_filter=+<src/gcode/calibrate/M666.cpp>
+SKEW_CORRECTION_GCODE   = src_filter=+<src/gcode/calibrate/M852.cpp>
+PINS_DEBUGGING          = src_filter=-<src/gcode/config/M43.cpp>
+NO_VOLUMETRICS          = src_filter=-<src/gcode/config/M200-M205.cpp>
+HAS_MULTI_EXTRUDER      = src_filter=+<src/gcode/config/M217.cpp>
+HAS_HOTEND_OFFSET       = src_filter=+<src/gcode/config/M218.cpp>
+EDITABLE_SERVO_ANGLES   = src_filter=+<src/gcode/config/M281.cpp>
+PREVENT_COLD_EXTRUSION  = src_filter=+<src/gcode/config/M302.cpp>
+HAS_USER_THERMISTORS    = src_filter=+<src/gcode/config/M305.cpp>
+SD_ABORT_ON_ENDSTOP_HIT = src_filter=+<src/gcode/config/M540.cpp>
+COOLANT_CONTROL         = src_filter=+<src/gcode/control/M7-M9.cpp>
+HAS_SOFTWARE_ENDSTOPS   = src_filter=+<src/gcode/control/M211.cpp>
+HAS_DUPLICATION_MODE    = src_filter=+<src/gcode/control/M605.cpp>
+LIN_ADVANCE             = src_filter=+<src/gcode/feature/advance>
+PHOTO_GCODE             = src_filter=+<src/gcode/feature/camera>
+CONTROLLER_FAN_EDITABLE = src_filter=+<src/gcode/feature/controllerfan>
+GCODE_MACROS            = src_filter=+<src/gcode/feature/macro>
+GRADIENT_MIX            = src_filter=+<src/gcode/feature/mixing/M166.cpp>
+HAS_SAVED_POSITIONS     = src_filter=+<src/gcode/feature/pause/G60.cpp> +<src/gcode/feature/pause/G61.cpp>
+PARK_HEAD_ON_PAUSE      = src_filter=+<src/gcode/feature/pause/M125.cpp>
+FILAMENT_LOAD_UNLOAD_GCODES = src_filter=+<src/gcode/feature/pause/M701_M702.cpp>
+CNC_WORKSPACE_PLANES    = src_filter=+<src/gcode/geometry/G17-G19.cpp>
+CNC_COORDINATE_SYSTEMS  = src_filter=+<src/gcode/geometry/G53-G59.cpp>
+HAS_M206_COMMAND        = src_filter=+<src/gcode/geometry/M206_M428.cpp>
+EXPECTED_PRINTER_CHECK  = src_filter=+<src/gcode/host/M16.cpp>
+HOST_KEEPALIVE_FEATURE  = src_filter=+<src/gcode/host/M113.cpp>
+REPETIER_GCODE_M360     = src_filter=+<src/gcode/host/M360.cpp>
+HAS_GCODE_M876          = src_filter=+<src/gcode/host/M876.cpp>
+HAS_RESUME_CONTINUE     = src_filter=+<src/gcode/lcd/M0_M1.cpp>
+HAS_PREHEAT_COUNT       = src_filter=+<src/gcode/lcd/M145.cpp>
+HAS_LCD_CONTRAST        = src_filter=+<src/gcode/lcd/M250.cpp>
+LCD_SET_PROGRESS_MANUALLY = src_filter=+<src/gcode/lcd/M73.cpp>
+TOUCH_SCREEN_CALIBRATION = src_filter=+<src/gcode/lcd/M995.cpp>
+ARC_SUPPORT             = src_filter=+<src/gcode/motion/G2_G3.cpp>
+GCODE_MOTION_MODES      = src_filter=+<src/gcode/motion/G80.cpp>
+BABYSTEPPING            = src_filter=+<src/gcode/motion/M290.cpp>
+Z_PROBE_SLED            = src_filter=+<src/gcode/probe/G31_G32.cpp>
+G38_PROBE_TARGET        = src_filter=+<src/gcode/probe/G38.cpp>
+MAGNETIC_PARKING_EXTRUDER = src_filter=+<src/gcode/probe/M951.cpp>
+SDSUPPORT               = src_filter=+<src/gcode/sd>
+HAS_EXTRUDERS           = src_filter=+<src/gcode/temp/M104_M109.cpp> +<src/gcode/config/M221.cpp>
+INCH_MODE_SUPPORT       = src_filter=+<src/gcode/units/G20_G21.cpp>
+TEMPERATURE_UNITS_SUPPORT = src_filter=+<src/gcode/units/M149.cpp>
+NEED_HEX_PRINT          = src_filter=+<src/libs/hex_print.cpp>
+NEED_LSF                = src_filter=+<src/libs/least_squares_fit.cpp>
+NOZZLE_PARK_FEATURE     = src_filter=+<src/libs/nozzle.cpp> +<src/gcode/feature/pause/G27.cpp>
+NOZZLE_CLEAN_FEATURE    = src_filter=+<src/libs/nozzle.cpp> +<src/gcode/feature/clean>
+DELTA                   = src_filter=+<src/module/delta.cpp> +<src/gcode/calibrate/M666.cpp>
+BEZIER_CURVE_SUPPORT    = src_filter=+<src/module/planner_bezier.cpp> +<src/gcode/motion/G5.cpp>
+PRINTCOUNTER            = src_filter=+<src/module/printcounter.cpp>
+HAS_BED_PROBE           = src_filter=+<src/module/probe.cpp> +<src/gcode/probe/G30.cpp> +<src/gcode/probe/M401_M402.cpp> +<src/gcode/probe/M851.cpp>
+IS_SCARA                = src_filter=+<src/module/scara.cpp>
+MORGAN_SCARA            = src_filter=+<src/gcode/scara>
+(ESP3D_)?WIFISUPPORT    = AsyncTCP, ESP Async WebServer
   ESP3DLib=https://github.com/luc-github/ESP3DLib.git
   arduinoWebSockets=https://github.com/Links2004/arduinoWebSockets.git
   ESP32SSDP=https://github.com/luc-github/ESP32SSDP.git
@@ -268,14 +544,13 @@ src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
 
 [env:DUE_USB]
 platform      = atmelsam
+extends       = env:DUE
 board         = dueUSB
-src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
 
 [env:DUE_debug]
 # Used when WATCHDOG_RESET_MANUAL is enabled
 platform      = atmelsam
-board         = due
-src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
+extends       = env:DUE
 build_flags   = ${common.build_flags}
   -funwind-tables
   -mpoke-function-name
@@ -285,8 +560,7 @@ build_flags   = ${common.build_flags}
 #
 [common_DUE_archim]
 platform      = atmelsam
-board         = due
-src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
+extends       = env:DUE
 build_flags   = ${common.build_flags}
   -DARDUINO_SAM_ARCHIM -DARDUINO_ARCH_SAM -D__SAM3X8E__ -DUSBCON
 extra_scripts = ${common.extra_scripts}
@@ -320,7 +594,7 @@ src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
 lib_deps       = ${common.lib_deps}
   SoftwareSerialM
   Adafruit SPIFlash
-  SdFat - Adafruit Fork
+marlin.SDSUPPORT = SdFat - Adafruit Fork
 debug_tool     = jlink
 
 #################################
@@ -342,8 +616,8 @@ extra_scripts     = ${common.extra_scripts}
 src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
 lib_deps          = ${common.lib_deps}
   Servo
-  LiquidCrystal@1.0.0
-  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/1.5.0.zip
+marlin.USES_LIQUIDCRYSTAL = LiquidCrystal@1.0.0
+marlin.NEOPIXEL_LED = Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/1.5.0.zip
 build_flags       = ${common.build_flags} -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g
   # debug options for backtrace
   #-funwind-tables
@@ -426,9 +700,9 @@ extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
   buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP.py
 lib_deps          = ${common.lib_deps}
-  Adafruit NeoPixel=https://github.com/ccccmagicboy/Adafruit_NeoPixel#meeb_3dp_use
   SoftwareSerialM
   USBComposite for STM32F1@0.91
+marlin.NEOPIXEL_LED = Adafruit NeoPixel=https://github.com/ccccmagicboy/Adafruit_NeoPixel#meeb_3dp_use
 debug_tool        = stlink
 upload_protocol   = dfu
 

commit 6bcfb58cd4b208cf042fa4a66faf14f382d33d07
Author: Marco Burato <zmaster.adsl@gmail.com>
Date:   Thu Aug 6 12:38:18 2020 +0200

    More Anycubic + Trigorilla mappings, ExtUI (#18903)

diff --git a/platformio.ini b/platformio.ini
index 450fffcc00..029ce65881 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -66,7 +66,7 @@ HAS_GRAPHICAL_TFT       = src_filter=+<src/lcd/tft>
 HAS_LCD_MENU            = src_filter=+<src/lcd/menu>
 HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus>
 TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
-ANYCUBIC_TFT_MODEL      = src_filter=+<src/lcd/extui/lib/anycubic>
+ANYCUBIC_LCD_I3MEGA     = src_filter=+<src/lcd/extui/lib/anycubic_i3mega>
 USB_FLASH_DRIVE_SUPPORT = src_filter=+<src/sd/usb_flashdrive>
 AUTO_BED_LEVELING_(3POINT|(BI)?LINEAR) = src_filter=+<src/feature/bedlevel/abl> +<src/gcode/bedlevel/abl>
 MESH_BED_LEVELING       = src_filter=+<src/feature/bedlevel/mbl> +<src/gcode/bedlevel/mbl>

commit 4d36baf3759dcf951e815ed18012adac2f504930
Author: Claus N√§veke <nitek@blickt.es>
Date:   Mon Aug 3 03:17:43 2020 +0200

    No mks_robin extra_scripts in Trigorilla build (#18872)

diff --git a/platformio.ini b/platformio.ini
index 790d6f9d0f..450fffcc00 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -651,6 +651,7 @@ extra_scripts = ${common.extra_scripts}
 [env:trigorilla_pro]
 platform      = ${common_stm32f1.platform}
 extends       = env:mks_robin
+extra_scripts = ${common.extra_scripts}
 
 #
 # MKS Robin E3D (STM32F103RCT6) and

commit cc50c4956d3743ec5fe11e1c118d105cf6672304
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Jul 30 02:07:29 2020 -0500

    Add monitor_flags

diff --git a/platformio.ini b/platformio.ini
index 0b1155abad..790d6f9d0f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -89,6 +89,15 @@ extra_scripts = ${common.extra_scripts}
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 monitor_speed = 250000
+monitor_flags =
+  --quiet
+  --echo
+  --eol
+    LF
+  --filter
+    colorize
+  --filter
+    time
 
 #################################
 #                               #

commit f3b37229fa9e7fead9c89fb4b477ba7f9d544c72
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Jul 28 18:13:20 2020 -0500

    Update include_tree

diff --git a/platformio.ini b/platformio.ini
index 2f7059e488..0b1155abad 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -991,4 +991,4 @@ src_filter      = ${common.default_src_filter} +<src/HAL/LINUX>
 platform    = atmelavr
 board       = megaatmega2560
 build_flags = -c -H -std=gnu++11 -Wall -Os -D__MARLIN_FIRMWARE__
-src_filter  = +<src/Marlin.cpp>
+src_filter  = +<src/MarlinCore.cpp>

commit 117df87d193994f6fbcd46c45573095adf921784
Author: Alexander Gavrilenko <jmz52@users.noreply.github.com>
Date:   Thu Jul 30 09:43:19 2020 +0300

    Support for TFT & Touch Screens (#18130)

diff --git a/platformio.ini b/platformio.ini
index 24d416444f..2f7059e488 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -26,7 +26,7 @@ include_dir  = Marlin
 #
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
-  -<src/lcd/HD44780> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/menu>
+  -<src/lcd/HD44780> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/tft> -<src/lcd/menu>
   -<src/lcd/extui/lib/mks_ui> -<src/lcd/extui/lib/dgus> -<src/lcd/extui/lib/ftdi_eve_touch_ui> -<src/lcd/extui/lib/anycubic>
   -<src/sd/usb_flashdrive>
   -<src/gcode/feature/trinamic>
@@ -62,6 +62,7 @@ USES_LIQUIDCRYSTAL      = LiquidCrystal@1.5.0
 USES_LIQUIDTWI2         = LiquidTWI2@1.2.7
 DWIN_CREALITY_LCD       = src_filter=+<src/lcd/dwin>
 HAS_CHARACTER_LCD       = src_filter=+<src/lcd/HD44780>
+HAS_GRAPHICAL_TFT       = src_filter=+<src/lcd/tft>
 HAS_LCD_MENU            = src_filter=+<src/lcd/menu>
 HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus>
 TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
@@ -603,6 +604,28 @@ extra_scripts = ${common.extra_scripts}
 build_flags   = ${common_stm32f1.build_flags}
   -DSS_TIMER=4 -DSTM32_XL_DENSITY
 
+# MKS Robin (STM32F103ZET6)
+# Uses HAL STM32 to support Marlin UI for TFT screen with optional touch panel
+#
+[env:mks_robin_stm32]
+platform             = ${common_stm32.platform}
+extends              = common_stm32
+board                = genericSTM32F103ZE
+board_build.core     = stm32
+board_build.variant  = MARLIN_F103Zx
+board_build.ldscript = ldscript.ld
+board_build.offset   = 0x7000
+board_build.firmware = Robin.bin
+build_flags          = ${common_stm32.build_flags}
+  -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
+build_unflags        = ${common_stm32.build_unflags}
+ -DUSBCON -DUSBD_USE_CDC
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+  buildroot/share/PlatformIO/scripts/mks_encrypt.py
+lib_deps             =
+
 #
 # MKS Robin Pro (STM32F103ZET6)
 #

commit b80cc09b13dbac0b1b289a89568641a07e226345
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Jul 28 03:10:00 2020 -0500

    Keep -std=gnu++11 in stm32 build_unflags

diff --git a/platformio.ini b/platformio.ini
index f60ebcce35..24d416444f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -380,7 +380,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 platform      = ${common_stm32.platform}
 build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL
-build_unflags = -std=gnu11
+build_unflags = -std=gnu11 -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore    = SPI
 lib_deps      = ${common.lib_deps}

commit de5cca6b1f660776e85d646d9c227c03ef60ccf1
Author: Diego von Deschwanden <68632259+Diegovd@users.noreply.github.com>
Date:   Tue Jul 28 08:04:44 2020 +0200

    Update more external links (#18819)

diff --git a/platformio.ini b/platformio.ini
index 543b837f54..f60ebcce35 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -4,7 +4,7 @@
 #
 # For detailed documentation with EXAMPLES:
 #
-# https://docs.platformio.org/en/latest/projectconf.html
+# https://docs.platformio.org/en/latest/projectconf/index.html
 #
 
 # Automatic targets - enable auto-uploading

commit 3eef000e2a7623d0d1d1f56fbf3109023f5d74c2
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Sun Jul 26 01:08:30 2020 -0300

    Fix MKS Robin Nano V2 build / upload (#18784)

diff --git a/platformio.ini b/platformio.ini
index 429091fbf0..543b837f54 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -574,27 +574,20 @@ build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE
 
 #
-# MKS Robin Nano (STM32F103VET6) - Emulated Graphical 128x64 (DOGM) UI and LVGL UI
+# MKS Robin Nano (STM32F103VET6)
+# v1.2 - Emulated Graphical 128x64 (DOGM) UI and LVGL UI
+# v2.0 - LVGL UI
 #
-[env:mks_robin_nano]
-platform      = ${common_stm32f1.platform}
-extends       = common_stm32f1
-board         = genericSTM32F103VE
-platform_packages = tool-stm32duino
-extra_scripts = ${common.extra_scripts}
-  buildroot/share/PlatformIO/scripts/mks_robin_nano.py
-build_flags   = ${common_stm32f1.build_flags}
-  -DMCU_STM32F103VE -DSS_TIMER=4
-
-#
-# MKS Robin Nano v2.0 (STM32F103VET6) - LVGL UI
-#
-[env:mks_robin_nano35_v2]
+[env:mks_robin_nano35]
 platform        = ${common_stm32f1.platform}
-extends         = env:mks_robin_nano
+extends         = common_stm32f1
+board           = genericSTM32F103VE
+platform_packages = tool-stm32duino
 extra_scripts   = ${common.extra_scripts}
   buildroot/share/PlatformIO/scripts/mks_robin_nano35.py
 lib_deps        = ${common_stm32f1.lib_deps}
+build_flags     = ${common_stm32f1.build_flags}
+  -DMCU_STM32F103VE -DSS_TIMER=4
 debug_tool      = jlink
 upload_protocol = jlink
 

commit d0222e5c76276d4bb1c46a4731ec63938f545eb0
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Jul 25 22:57:00 2020 -0500

    Randomize firmware.bin, fix unflag

diff --git a/platformio.ini b/platformio.ini
index 838ce11611..429091fbf0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -380,7 +380,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 platform      = ${common_stm32.platform}
 build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL
-build_unflags = -std=gnu++11
+build_unflags = -std=gnu11
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore    = SPI
 lib_deps      = ${common.lib_deps}
@@ -744,6 +744,7 @@ board           = genericSTM32F103RC
 build_flags     = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY -DTEMP_TIMER_CHAN=4
 extra_scripts   = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/random-bin.py
   buildroot/share/PlatformIO/scripts/creality.py
 lib_ignore      = ${common_stm32f1.lib_ignore}
 debug_tool      = jlink

commit e02817b07798b92aa31091c78c16581f0c867923
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Sat Jul 25 23:40:44 2020 -0300

    More folders only compiled when their feature is Enabled (#18780)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 743499e899..838ce11611 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -25,10 +25,18 @@ include_dir  = Marlin
 # The 'common' values are used for most Marlin builds
 #
 [common]
-default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/lcd/extui/lib/mks_ui>
-  -<src/lcd/menu> -<src/lcd/dwin> -<src/lcd/extui/lib/dgus> -<src/lcd/extui/lib/ftdi_eve_touch_ui> -<src/lcd/dogm>
+default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
+  -<src/lcd/HD44780> -<src/lcd/dwin> -<src/lcd/dogm> -<src/lcd/menu>
+  -<src/lcd/extui/lib/mks_ui> -<src/lcd/extui/lib/dgus> -<src/lcd/extui/lib/ftdi_eve_touch_ui> -<src/lcd/extui/lib/anycubic>
+  -<src/sd/usb_flashdrive>
+  -<src/gcode/feature/trinamic>
+  -<src/feature/bedlevel/abl> -<src/gcode/bedlevel/abl>
+  -<src/feature/bedlevel/mbl> -<src/gcode/bedlevel/mbl>
+  -<src/feature/bedlevel/ubl> -<src/gcode/bedlevel/ubl>
+  -<src/feature/dac> -<src/feature/digipot>
+  -<src/feature/leds>
 extra_scripts      =
-  pre:buildroot/share/PlatformIO/scripts/common-features-dependencies.py
+  pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
 build_flags        = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
 lib_deps           =
@@ -37,24 +45,34 @@ lib_deps           =
 # Feature Dependencies
 #
 [features]
-HAS_TFT_LVGL_UI     = lvgl=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
-                      src_filter=+<src/lcd/extui/lib/mks_ui>
-                      extra_scripts=download_mks_assets.py
-HAS_TRINAMIC_CONFIG = TMCStepper@~0.7.1
-SR_LCD_3W_NL        = SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-DIGIPOT_MCP4...     = SlowSoftI2CMaster
-HAS_TMC26X          = TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-HAS_L64XX           = Arduino-L6470@0.8.0
-NEOPIXEL_LED        = Adafruit NeoPixel@1.5.0
-MAX6675_IS_MAX31865 = Adafruit MAX31865 library@~1.1.0
-HAS_GRAPHICAL_LCD   = U8glib-HAL@0.4.1
-                      src_filter=+<src/lcd/dogm>
-USES_LIQUIDCRYSTAL  = LiquidCrystal@1.5.0
-USES_LIQUIDTWI2     = LiquidTWI2@1.2.7
-TOUCH_UI_FTDI_EVE   = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
-HAS_DGUS_LCD        = src_filter=+<src/lcd/extui/lib/dgus>
-DWIN_CREALITY_LCD   = src_filter=+<src/lcd/dwin>
-HAS_LCD_MENU        = src_filter=+<src/lcd/menu>
+HAS_TFT_LVGL_UI         = lvgl=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
+                          src_filter=+<src/lcd/extui/lib/mks_ui>
+                          extra_scripts=download_mks_assets.py
+HAS_TRINAMIC_CONFIG     = TMCStepper@~0.7.1
+                          src_filter=+<src/gcode/feature/trinamic>
+SR_LCD_3W_NL            = SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
+DIGIPOT_MCP4...         = SlowSoftI2CMaster
+HAS_TMC26X              = TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+HAS_L64XX               = Arduino-L6470@0.8.0
+NEOPIXEL_LED            = Adafruit NeoPixel@1.5.0
+MAX6675_IS_MAX31865     = Adafruit MAX31865 library@~1.1.0
+HAS_GRAPHICAL_LCD       = U8glib-HAL@0.4.1
+                          src_filter=+<src/lcd/dogm>
+USES_LIQUIDCRYSTAL      = LiquidCrystal@1.5.0
+USES_LIQUIDTWI2         = LiquidTWI2@1.2.7
+DWIN_CREALITY_LCD       = src_filter=+<src/lcd/dwin>
+HAS_CHARACTER_LCD       = src_filter=+<src/lcd/HD44780>
+HAS_LCD_MENU            = src_filter=+<src/lcd/menu>
+HAS_DGUS_LCD            = src_filter=+<src/lcd/extui/lib/dgus>
+TOUCH_UI_FTDI_EVE       = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
+ANYCUBIC_TFT_MODEL      = src_filter=+<src/lcd/extui/lib/anycubic>
+USB_FLASH_DRIVE_SUPPORT = src_filter=+<src/sd/usb_flashdrive>
+AUTO_BED_LEVELING_(3POINT|(BI)?LINEAR) = src_filter=+<src/feature/bedlevel/abl> +<src/gcode/bedlevel/abl>
+MESH_BED_LEVELING       = src_filter=+<src/feature/bedlevel/mbl> +<src/gcode/bedlevel/mbl>
+AUTO_BED_LEVELING_UBL   = src_filter=+<src/feature/bedlevel/ubl> +<src/gcode/bedlevel/ubl>
+DAC_STEPPER_CURRENT     = src_filter=+<src/feature/dac>
+HAS_I2C_DIGIPOT         = src_filter=+<src/feature/digipot>
+HAS_LED_FEATURE         = src_filter=+<src/feature/leds>
 (ESP3D_)?WIFISUPPORT = AsyncTCP, ESP Async WebServer
   ESP3DLib=https://github.com/luc-github/ESP3DLib.git
   arduinoWebSockets=https://github.com/Links2004/arduinoWebSockets.git
@@ -699,7 +717,7 @@ src_filter  = ${common.default_src_filter} +<src/HAL/STM32>
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = CHITU_F103
-extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-features-dependencies.py
+extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
   buildroot/share/PlatformIO/scripts/chitu_crypt.py
 build_flags   = ${common_stm32f1.build_flags}

commit d20d4591321aa467c062f0050355d2aca84e03ad
Author: MKS-Sean <56996910+MKS-Sean@users.noreply.github.com>
Date:   Sat Jul 25 13:52:07 2020 +0800

    Robin nano V2, TFT LVGL UI parameters, and more (#18500)

diff --git a/platformio.ini b/platformio.ini
index 6ad1916a93..743499e899 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -37,8 +37,9 @@ lib_deps           =
 # Feature Dependencies
 #
 [features]
-TFT_LVGL_UI         = MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
+HAS_TFT_LVGL_UI     = lvgl=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
                       src_filter=+<src/lcd/extui/lib/mks_ui>
+                      extra_scripts=download_mks_assets.py
 HAS_TRINAMIC_CONFIG = TMCStepper@~0.7.1
 SR_LCD_3W_NL        = SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 DIGIPOT_MCP4...     = SlowSoftI2CMaster
@@ -525,7 +526,7 @@ build_flags       = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE -DARDUINO_GENERIC_STM32F103V -DARDUINO_ARCH_STM32F1 -DBOARD_generic_stm32f103v
   -DDEBUG_LEVEL=DEBUG_NONE -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DVECT_TAB_ADDR=0x8000000
   -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
-upload_protocol = serial
+upload_protocol   = serial
 
 #
 # Longer 3D board in Alfawise U20 (STM32F103VET6)
@@ -555,7 +556,7 @@ build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE
 
 #
-# MKS Robin Nano (STM32F103VET6) - Emulated Graphical 128x64 (DOGM) UI
+# MKS Robin Nano (STM32F103VET6) - Emulated Graphical 128x64 (DOGM) UI and LVGL UI
 #
 [env:mks_robin_nano]
 platform      = ${common_stm32f1.platform}
@@ -567,6 +568,18 @@ extra_scripts = ${common.extra_scripts}
 build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE -DSS_TIMER=4
 
+#
+# MKS Robin Nano v2.0 (STM32F103VET6) - LVGL UI
+#
+[env:mks_robin_nano35_v2]
+platform        = ${common_stm32f1.platform}
+extends         = env:mks_robin_nano
+extra_scripts   = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/mks_robin_nano35.py
+lib_deps        = ${common_stm32f1.lib_deps}
+debug_tool      = jlink
+upload_protocol = jlink
+
 #
 # MKS Robin (STM32F103ZET6)
 #
@@ -753,8 +766,8 @@ extra_scripts     = ${common.extra_scripts}
 # FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
-platform      = ${common_stm32.platform}
-extends       = common_stm32
+platform          = ${common_stm32.platform}
+extends           = common_stm32
 platform_packages = ${common_stm32.platform_packages}
    tool-stm32duino
 board             = fysetc_s6

commit 60500c0c49259960d11863f9af24df039b7d5fec
Author: J.C. Nelson <32139633+xC0000005@users.noreply.github.com>
Date:   Fri Jul 24 20:56:33 2020 -0700

    Fix Lerdge variant script (#18771)

diff --git a/platformio.ini b/platformio.ini
index f51f0a3194..6ad1916a93 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -846,7 +846,7 @@ extra_scripts      = ${common.extra_scripts}
 build_flags        = ${common_stm32.build_flags}
   -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
   -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
-  -DTRANSFER_CLOCK_DIV=8
+  -DTRANSFER_CLOCK_DIV=8 -DHAL_SRAM_MODULE_ENABLED
 build_unflags      = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 
 #

commit 1d2d616a7c010160b12131c2c344e36abe95378e
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Jul 23 23:35:19 2020 -0500

    Fix ESP3D_WIFISUPPORT ini typo

diff --git a/platformio.ini b/platformio.ini
index edc027a6d3..f51f0a3194 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -54,7 +54,7 @@ TOUCH_UI_FTDI_EVE   = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
 HAS_DGUS_LCD        = src_filter=+<src/lcd/extui/lib/dgus>
 DWIN_CREALITY_LCD   = src_filter=+<src/lcd/dwin>
 HAS_LCD_MENU        = src_filter=+<src/lcd/menu>
-(ESP32_)?WIFISUPPORT = AsyncTCP, ESP Async WebServer
+(ESP3D_)?WIFISUPPORT = AsyncTCP, ESP Async WebServer
   ESP3DLib=https://github.com/luc-github/ESP3DLib.git
   arduinoWebSockets=https://github.com/Links2004/arduinoWebSockets.git
   ESP32SSDP=https://github.com/luc-github/ESP32SSDP.git

commit d1e20eb29f15c0dc4faa21769251709c455d18b8
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Jul 23 20:46:11 2020 -0500

    Update links, README, contributing, etc.

diff --git a/platformio.ini b/platformio.ini
index 246abc11bd..edc027a6d3 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -769,7 +769,7 @@ upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
 
 #
 # STM32F407VET6 with RAMPS-like shield
-# 'Black' STM32F407VET6 board - http://wiki.stm32duino.com/index.php?title=STM32F407
+# 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]

commit 42fbd527f3bcc317ae6851aca5a45bdbf979de55
Author: Diego von Deschwanden <68632259+Diegovd@users.noreply.github.com>
Date:   Thu Jul 23 05:20:14 2020 +0200

    Fix links to secure sites (#18745)

diff --git a/platformio.ini b/platformio.ini
index cfbd5e5a19..246abc11bd 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -4,7 +4,7 @@
 #
 # For detailed documentation with EXAMPLES:
 #
-# http://docs.platformio.org/en/latest/projectconf.html
+# https://docs.platformio.org/en/latest/projectconf.html
 #
 
 # Automatic targets - enable auto-uploading

commit 748c8a7ecd7aa90b7dddbebcd7e2ecb856ee91e4
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Jul 21 23:37:15 2020 -0500

    Explicit SdFat

diff --git a/platformio.ini b/platformio.ini
index c59f279073..cfbd5e5a19 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -290,7 +290,8 @@ build_unflags  = -std=gnu++11
 src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
 lib_deps       = ${common.lib_deps}
   SoftwareSerialM
-  Adafruit_SPIFlash=https://github.com/adafruit/Adafruit_SPIFlash/archive/master.zip
+  Adafruit SPIFlash
+  SdFat - Adafruit Fork
 debug_tool     = jlink
 
 #################################

commit 6027055695f6fa49b857bec0552bf362e0b2bb56
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue Jul 21 04:00:39 2020 -0500

    Optimize LCD, Wifi, etc. libraries (#18730)

diff --git a/platformio.ini b/platformio.ini
index 865755d73f..c59f279073 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -40,21 +40,25 @@ lib_deps           =
 TFT_LVGL_UI         = MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
                       src_filter=+<src/lcd/extui/lib/mks_ui>
 HAS_TRINAMIC_CONFIG = TMCStepper@~0.7.1
-SR_LCD_2W_NL        = SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 SR_LCD_3W_NL        = SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-DIGIPOT_MCP4018     = SlowSoftI2CMaster
-DIGIPOT_MCP4451     = SlowSoftI2CMaster
+DIGIPOT_MCP4...     = SlowSoftI2CMaster
 HAS_TMC26X          = TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 HAS_L64XX           = Arduino-L6470@0.8.0
 NEOPIXEL_LED        = Adafruit NeoPixel@1.5.0
 MAX6675_IS_MAX31865 = Adafruit MAX31865 library@~1.1.0
 HAS_GRAPHICAL_LCD   = U8glib-HAL@0.4.1
                       src_filter=+<src/lcd/dogm>
-HAS_CHARACTER_LCD   = LiquidCrystal@1.5.0, LiquidTWI2@1.2.7
+USES_LIQUIDCRYSTAL  = LiquidCrystal@1.5.0
+USES_LIQUIDTWI2     = LiquidTWI2@1.2.7
 TOUCH_UI_FTDI_EVE   = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
 HAS_DGUS_LCD        = src_filter=+<src/lcd/extui/lib/dgus>
 DWIN_CREALITY_LCD   = src_filter=+<src/lcd/dwin>
 HAS_LCD_MENU        = src_filter=+<src/lcd/menu>
+(ESP32_)?WIFISUPPORT = AsyncTCP, ESP Async WebServer
+  ESP3DLib=https://github.com/luc-github/ESP3DLib.git
+  arduinoWebSockets=https://github.com/Links2004/arduinoWebSockets.git
+  ESP32SSDP=https://github.com/luc-github/ESP32SSDP.git
+  lib_ignore=ESPAsyncTCP
 
 #
 # Default values apply to all 'env:' prefixed environments
@@ -306,14 +310,11 @@ lib_compat_mode   = strict
 extra_scripts     = ${common.extra_scripts}
   Marlin/src/HAL/LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
-lib_deps          = Servo
+lib_deps          = ${common.lib_deps}
+  Servo
   LiquidCrystal@1.0.0
-  U8glib-HAL@0.4.1
-  TMCStepper@~0.7.1
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/1.5.0.zip
-  SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 build_flags       = ${common.build_flags} -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g
-lib_ignore        = LiquidTWI2
   # debug options for backtrace
   #-funwind-tables
   #-mpoke-function-name
@@ -361,8 +362,7 @@ build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore    =
-  SPI
+lib_ignore    = SPI
 lib_deps      = ${common.lib_deps}
   SoftwareSerialM
 
@@ -395,18 +395,10 @@ build_flags       = ${common_stm32f1.build_flags}
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
   buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP.py
-lib_deps          =
-  TMCStepper@~0.7.1
-  Adafruit MAX31865 library@~1.1.0
-  U8glib-HAL@0.4.1
-  Arduino-L6470@0.8.0
-  SlowSoftI2CMaster
-  LiquidTWI2@1.2.7
+lib_deps          = ${common.lib_deps}
   Adafruit NeoPixel=https://github.com/ccccmagicboy/Adafruit_NeoPixel#meeb_3dp_use
-  SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
   SoftwareSerialM
   USBComposite for STM32F1@0.91
-lib_ignore        = SPI
 debug_tool        = stlink
 upload_protocol   = dfu
 
@@ -498,7 +490,6 @@ lib_deps          = ${common_stm32f1.lib_deps}
 platform      = ${common_stm32.platform}
 board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
-lib_ignore    = Adafruit NeoPixel, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/STM32_F4_F7/STM32F7>
 
 #
@@ -508,7 +499,6 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/ST
 platform      = ${common_stm32.platform}
 board         = remram_v1
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
-lib_ignore    = Adafruit NeoPixel, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/STM32_F4_F7/STM32F4>
 
 #
@@ -550,7 +540,6 @@ build_flags   = ${common_stm32f1.build_flags}
 build_unflags = ${common_stm32f1.build_unflags}
   -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 lib_ignore    = ${common_stm32f1.lib_ignore}
-  LiquidTWI2
 
 #
 # MKS Robin Mini (STM32F103VET6)
@@ -911,13 +900,6 @@ monitor_speed = 500000
 platform      = espressif32@1.11.2
 board         = esp32dev
 build_flags   = ${common.build_flags} -DCORE_DEBUG_LEVEL=0
-lib_deps      = ${common.lib_deps}
-  AsyncTCP=https://github.com/me-no-dev/AsyncTCP/archive/master.zip
-  ESPAsyncWebServer=https://github.com/me-no-dev/ESPAsyncWebServer/archive/master.zip
-  ESP3DLib=https://github.com/luc-github/ESP3DLib.git
-  arduinoWebSockets=https://github.com/Links2004/arduinoWebSockets.git
-  ESP32SSDP=https://github.com/luc-github/ESP32SSDP.git
-lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, ESPAsyncTCP
 src_filter    = ${common.default_src_filter} +<src/HAL/ESP32>
 upload_speed  = 115200
 #upload_port   = marlinesp.local
@@ -929,8 +911,6 @@ upload_speed  = 115200
 [env:teensy31]
 platform      = teensy
 board         = teensy31
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY31_32>
 
 #
@@ -939,8 +919,6 @@ src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY31_32>
 [env:teensy35]
 platform      = teensy
 board         = teensy35
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY35_36>
 
 #
@@ -964,6 +942,4 @@ src_filter      = ${common.default_src_filter} +<src/HAL/LINUX>
 platform    = atmelavr
 board       = megaatmega2560
 build_flags = -c -H -std=gnu++11 -Wall -Os -D__MARLIN_FIRMWARE__
-lib_deps    = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter  = +<src/Marlin.cpp>

commit f34024af3457d1d5e2f6b4d7fe83f5b00f8fb597
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Tue Jul 21 05:15:20 2020 -0300

    Filter some unused Marlin/src subfolders (#18729)

diff --git a/platformio.ini b/platformio.ini
index 0bc559b09b..865755d73f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -26,6 +26,7 @@ include_dir  = Marlin
 #
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/lcd/extui/lib/mks_ui>
+  -<src/lcd/menu> -<src/lcd/dwin> -<src/lcd/extui/lib/dgus> -<src/lcd/extui/lib/ftdi_eve_touch_ui> -<src/lcd/dogm>
 extra_scripts      =
   pre:buildroot/share/PlatformIO/scripts/common-features-dependencies.py
   pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
@@ -48,7 +49,12 @@ HAS_L64XX           = Arduino-L6470@0.8.0
 NEOPIXEL_LED        = Adafruit NeoPixel@1.5.0
 MAX6675_IS_MAX31865 = Adafruit MAX31865 library@~1.1.0
 HAS_GRAPHICAL_LCD   = U8glib-HAL@0.4.1
+                      src_filter=+<src/lcd/dogm>
 HAS_CHARACTER_LCD   = LiquidCrystal@1.5.0, LiquidTWI2@1.2.7
+TOUCH_UI_FTDI_EVE   = src_filter=+<src/lcd/extui/lib/ftdi_eve_touch_ui>
+HAS_DGUS_LCD        = src_filter=+<src/lcd/extui/lib/dgus>
+DWIN_CREALITY_LCD   = src_filter=+<src/lcd/dwin>
+HAS_LCD_MENU        = src_filter=+<src/lcd/menu>
 
 #
 # Default values apply to all 'env:' prefixed environments

commit 4a55bdb1656de2fc63d3d93f53ff50a1e1ce393d
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Sun Jul 19 23:42:30 2020 -0300

    Only download & compile required libraries (#18699)

diff --git a/platformio.ini b/platformio.ini
index 762a66f920..0bc559b09b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -25,25 +25,37 @@ include_dir  = Marlin
 # The 'common' values are used for most Marlin builds
 #
 [common]
-default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
-extra_scripts      = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
+default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared> -<src/lcd/extui/lib/mks_ui>
+extra_scripts      =
+  pre:buildroot/share/PlatformIO/scripts/common-features-dependencies.py
+  pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
 build_flags        = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
 lib_deps           =
-  LiquidCrystal@1.5.0
-  TMCStepper@~0.7.1
-  Adafruit MAX31865 library@~1.1.0
-  Adafruit NeoPixel@1.5.0
-  U8glib-HAL@0.4.1
-  Arduino-L6470@0.8.0
-  SlowSoftI2CMaster
-  LiquidTWI2@1.2.7
-  SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
+
+#
+# Feature Dependencies
+#
+[features]
+TFT_LVGL_UI         = MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
+                      src_filter=+<src/lcd/extui/lib/mks_ui>
+HAS_TRINAMIC_CONFIG = TMCStepper@~0.7.1
+SR_LCD_2W_NL        = SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
+SR_LCD_3W_NL        = SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
+DIGIPOT_MCP4018     = SlowSoftI2CMaster
+DIGIPOT_MCP4451     = SlowSoftI2CMaster
+HAS_TMC26X          = TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+HAS_L64XX           = Arduino-L6470@0.8.0
+NEOPIXEL_LED        = Adafruit NeoPixel@1.5.0
+MAX6675_IS_MAX31865 = Adafruit MAX31865 library@~1.1.0
+HAS_GRAPHICAL_LCD   = U8glib-HAL@0.4.1
+HAS_CHARACTER_LCD   = LiquidCrystal@1.5.0, LiquidTWI2@1.2.7
 
 #
 # Default values apply to all 'env:' prefixed environments
 #
 [env]
 framework     = arduino
+extra_scripts = ${common.extra_scripts}
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 monitor_speed = 250000
@@ -69,8 +81,6 @@ monitor_speed = 250000
 #
 [common_avr8]
 board_build.f_cpu = 16000000L
-lib_deps          = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
@@ -157,7 +167,6 @@ board_upload.maximum_size = 126976
 platform      = atmelavr
 extends       = common_avr8
 board         = sanguino_atmega1284p
-lib_ignore    = TMCStepper
 upload_speed  = 57600
 board_upload.maximum_size = 126976
 
@@ -168,7 +177,6 @@ board_upload.maximum_size = 126976
 platform      = atmelavr
 extends       = common_avr8
 board         = sanguino_atmega1284p
-lib_ignore    = TMCStepper
 upload_speed  = 115200
 
 #
@@ -191,7 +199,6 @@ build_unflags = -g -ggdb
 platform      = teensy
 extends       = common_avr8
 board         = at90usb1286
-lib_ignore    = TMCStepper
 
 #
 # AT90USB1286 boards using DFU bootloader
@@ -243,7 +250,8 @@ board         = due
 src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
 build_flags   = ${common.build_flags}
   -DARDUINO_SAM_ARCHIM -DARDUINO_ARCH_SAM -D__SAM3X8E__ -DUSBCON
-extra_scripts = Marlin/src/HAL/DUE/upload_extra_script.py
+extra_scripts = ${common.extra_scripts}
+  Marlin/src/HAL/DUE/upload_extra_script.py
 
 [env:DUE_archim]
 platform      = ${common_DUE_archim.platform}
@@ -268,7 +276,6 @@ build_flags   = ${common_DUE_archim.build_flags} -funwind-tables -mpoke-function
 platform       = atmelsam
 board          = adafruit_grandcentral_m4
 build_flags    = ${common.build_flags} -std=gnu++17
-extra_scripts  = ${common.extra_scripts}
 build_unflags  = -std=gnu++11
 src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
 lib_deps       = ${common.lib_deps}
@@ -290,7 +297,8 @@ platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.
 board             = nxp_lpc1768
 lib_ldf_mode      = off
 lib_compat_mode   = strict
-extra_scripts     = Marlin/src/HAL/LPC1768/upload_extra_script.py
+extra_scripts     = ${common.extra_scripts}
+  Marlin/src/HAL/LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
 lib_deps          = Servo
   LiquidCrystal@1.0.0
@@ -298,7 +306,8 @@ lib_deps          = Servo
   TMCStepper@~0.7.1
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/1.5.0.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g ${common.build_flags}
+build_flags       = ${common.build_flags} -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g
+lib_ignore        = LiquidTWI2
   # debug options for backtrace
   #-funwind-tables
   #-mpoke-function-name
@@ -328,7 +337,6 @@ board     = nxp_lpc1769
 [common_stm32]
 platform      = ststm32@~6.1.0
 platform_packages = framework-arduinoststm32@>=4.10700,<4.10800
-lib_deps      = ${common.lib_deps}
 lib_ignore    = SoftwareSerial
 build_flags   = ${common.build_flags}
   -IMarlin/src/HAL/STM32 -std=gnu++14
@@ -348,7 +356,6 @@ build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore    =
-  Adafruit NeoPixel
   SPI
 lib_deps      = ${common.lib_deps}
   SoftwareSerialM
@@ -379,8 +386,9 @@ build_flags       = ${common_stm32f1.build_flags}
                     -DUSE_USB_COMPOSITE
                     -DVECT_TAB_OFFSET=0x2000
                     -DGENERIC_BOOTLOADER
-extra_scripts     = pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
-    buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP.py
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
+  buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP.py
 lib_deps          =
   TMCStepper@~0.7.1
   Adafruit MAX31865 library@~1.1.0
@@ -402,7 +410,8 @@ upload_protocol   = dfu
 [env:STM32F103RC_fysetc]
 platform          = ${common_stm32f1.platform}
 extends           = env:STM32F103RC
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_fysetc.py
+extra_scripts     = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/STM32F103RC_fysetc.py
 build_flags       = ${common_stm32f1.build_flags} -DDEBUG_LEVEL=0
 lib_ldf_mode      = chain
 debug_tool        = stlink
@@ -420,7 +429,8 @@ upload_protocol   = serial
 [env:STM32F103RC_btt]
 platform          = ${common_stm32f1.platform}
 extends           = env:STM32F103RC
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
+extra_scripts     = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = ${common_stm32f1.build_flags}
   -DDEBUG_LEVEL=0 -DSS_TIMER=4
 monitor_speed     = 115200
@@ -462,7 +472,8 @@ monitor_speed     = 115200
 [env:STM32F103RE_btt]
 platform          = ${common_stm32f1.platform}
 extends           = env:STM32F103RE
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
+extra_scripts     = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
 build_flags       = ${common_stm32f1.build_flags} -DDEBUG_LEVEL=0 -DSS_TIMER=4
 debug_tool        = stlink
 upload_protocol   = stlink
@@ -526,7 +537,8 @@ upload_protocol = serial
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103VE
-extra_scripts = buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
+extra_scripts = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
 build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE -DSTM32F1xx -USERIAL_USB -DU20 -DTS_V12
 build_unflags = ${common_stm32f1.build_unflags}
@@ -541,7 +553,8 @@ lib_ignore    = ${common_stm32f1.lib_ignore}
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103VE
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
+extra_scripts = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/mks_robin_mini.py
 build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE
 
@@ -553,20 +566,11 @@ platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103VE
 platform_packages = tool-stm32duino
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
+extra_scripts = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/mks_robin_nano.py
 build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE -DSS_TIMER=4
 
-#
-# MKS Robin Nano (STM32F103VET6) - MKS UI (LVGL)
-#
-[env:mks_robin_nano35]
-platform      = ${common_stm32f1.platform}
-extends       = env:mks_robin_nano
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano35.py
-lib_deps      = ${common_stm32f1.lib_deps}
-  MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
-
 #
 # MKS Robin (STM32F103ZET6)
 #
@@ -574,7 +578,8 @@ lib_deps      = ${common_stm32f1.lib_deps}
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103ZE
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
+extra_scripts = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/mks_robin.py
 build_flags   = ${common_stm32f1.build_flags}
   -DSS_TIMER=4 -DSTM32_XL_DENSITY
 
@@ -584,7 +589,8 @@ build_flags   = ${common_stm32f1.build_flags}
 [env:mks_robin_pro]
 platform      = ${common_stm32f1.platform}
 extends       = env:mks_robin
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_pro.py
+extra_scripts = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/mks_robin_pro.py
 
 
 #
@@ -603,7 +609,8 @@ platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103RC
 platform_packages = tool-stm32duino
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_e3.py
+extra_scripts = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/mks_robin_e3.py
 build_flags   = ${common_stm32f1.build_flags}
   -DDEBUG_LEVEL=0 -DSS_TIMER=4
 
@@ -614,7 +621,8 @@ build_flags   = ${common_stm32f1.build_flags}
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103RC
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite.py
+extra_scripts = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/mks_robin_lite.py
 
 
 #
@@ -624,7 +632,8 @@ extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite.py
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103RC
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite3.py
+extra_scripts = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/mks_robin_lite3.py
 
 #
 # JGAurora A5S A1 (STM32F103ZET6)
@@ -633,7 +642,8 @@ extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite3.py
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103ZE
-extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
+extra_scripts = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
 build_flags   = ${common_stm32f1.build_flags}
   -DSTM32F1xx -DSTM32_XL_DENSITY
 
@@ -648,7 +658,7 @@ build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103CB -D__STM32F1__=1 -std=c++1y -DSERIAL_USB -ffunction-sections -fdata-sections
   -Wl,--gc-sections -DDEBUG_LEVEL=0 -D__MARLIN_FIRMWARE__
 lib_ignore    = ${common_stm32f1.lib_ignore}
-  LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SoftwareSerialM
+  SoftwareSerialM
 
 #
 # Malyan M200 v2 (STM32F070RB)
@@ -660,7 +670,7 @@ board       = malyanM200v2
 build_flags = ${common_stm32.build_flags} -DSTM32F0xx -DUSB_PRODUCT=\"STM32F070RB\" -DHAL_PCD_MODULE_ENABLED
   -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
   -DCUSTOM_STARTUP_FILE
-lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-HAL, SoftwareSerial
+lib_ignore  = SoftwareSerial
 
 #
 # Malyan M300 (STM32F070CB)
@@ -672,7 +682,6 @@ build_flags = ${common.build_flags}
   -DUSBCON -DUSBD_VID=0x0483 "-DUSB_MANUFACTURER=\"Unknown\"" "-DUSB_PRODUCT=\"MALYAN_M300\""
   -DHAL_PCD_MODULE_ENABLED -DUSBD_USE_CDC -DDISABLE_GENERIC_SERIALUSB -DHAL_UART_MODULE_ENABLED
 src_filter  = ${common.default_src_filter} +<src/HAL/STM32>
-lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-HAL
 
 #
 # Chitu boards like Tronxy X5s (STM32F103ZET6)
@@ -681,7 +690,8 @@ lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-H
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = CHITU_F103
-extra_scripts = pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
+extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-features-dependencies.py
+  pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
   buildroot/share/PlatformIO/scripts/chitu_crypt.py
 build_flags   = ${common_stm32f1.build_flags}
   -DSTM32F1xx -DSTM32_XL_DENSITY
@@ -697,17 +707,6 @@ platform      = ${common_stm32f1.platform}
 extends       = env:chitu_f103
 build_flags   = ${env:chitu_f103.build_flags} -DCHITU_V5_Z_MIN_BUGFIX
 
-#
-# Chitu boards like Tronxy X5SA (STM32F103ZET6) using TFT LVGL UI
-#
-[env:chitu_f103_lvgl]
-platform      = ${common_stm32f1.platform}
-extends       = env:chitu_f103
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps      = ${common.lib_deps}
-  SoftwareSerialM
-  MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
-
 #
 # Creality (STM32F103RET6)
 #
@@ -717,9 +716,9 @@ extends         = common_stm32f1
 board           = genericSTM32F103RC
 build_flags     = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY -DTEMP_TIMER_CHAN=4
-extra_scripts   = buildroot/share/PlatformIO/scripts/creality.py
+extra_scripts   = ${common.extra_scripts}
+  buildroot/share/PlatformIO/scripts/creality.py
 lib_ignore      = ${common_stm32f1.lib_ignore}
-  LiquidCrystal, LiquidTWI2, U8glib-HAL, Adafruit_MAX31865, Arduino-L6470, SailfishLCD, SlowSoftI2CMaster
 debug_tool      = jlink
 upload_protocol = jlink
 monitor_speed   = 115200
@@ -736,9 +735,10 @@ build_flags       = ${common_stm32.build_flags}
   -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
   -DUSB_PRODUCT=\"STEVAL_F401VE\"
   -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/STEVAL__F401XX.py
-lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
+lib_ignore        = SoftwareSerial
 
 #
 # FLYF407ZG
@@ -750,7 +750,8 @@ board             = FLYF407ZG
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F4 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x8000
-extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
 # FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
@@ -764,7 +765,8 @@ board             = fysetc_s6
 build_flags       = ${common_stm32.build_flags}
   -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x10000
   -DHAL_PCD_MODULE_ENABLED '-DUSB_PRODUCT="FYSETC_S6"'
-extra_scripts     = pre:buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
 debug_tool        = stlink
 upload_protocol   = dfu
 upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
@@ -782,8 +784,9 @@ build_flags       = ${common_stm32.build_flags}
   -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
   -DUSB_PRODUCT=\"BLACK_F407VE\"
   -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+lib_ignore        = SoftwareSerial
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
@@ -795,7 +798,8 @@ board             = BigTree_SKR_Pro
 build_flags       = ${common_stm32.build_flags}
   -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
-extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 #upload_protocol   = stlink
 #upload_command    = "$PROJECT_PACKAGES_DIR/tool-stm32duino/stlink/ST-LINK_CLI.exe" -c SWD -P "$BUILD_DIR/firmware.bin" 0x8008000 -Rst -Run
 debug_tool        = stlink
@@ -808,7 +812,8 @@ debug_init_break  =
 platform          = ststm32@>=5.7.0,<6.2.0
 extends           = common_stm32
 board             = BigTree_GTR_v1
-extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags       = ${common_stm32.build_flags}
   -DUSB_PRODUCT=\"STM32F407IG\"
   -DTARGET_STM32F4 -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
@@ -827,8 +832,8 @@ build_flags       = ${common_stm32.build_flags}
   -DHAVE_HWSERIAL3
   -DPIN_SERIAL2_RX=PD_6
   -DPIN_SERIAL2_TX=PD_5
-extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
 # Lerdge base
@@ -838,7 +843,8 @@ platform           = ${common_stm32.platform}
 extends            = common_stm32
 board              = LERDGE
 board_build.offset = 0x10000
-extra_scripts      = pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
+extra_scripts      = ${common.extra_scripts}
+                     pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
                      buildroot/share/PlatformIO/scripts/stm32_bootloader.py
                      buildroot/share/PlatformIO/scripts/lerdge.py
 build_flags        = ${common_stm32.build_flags}
@@ -919,7 +925,6 @@ platform      = teensy
 board         = teensy31
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY31_32>
 
 #
@@ -930,7 +935,6 @@ platform      = teensy
 board         = teensy35
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY35_36>
 
 #

commit afce012960e474c41e3b52ea75d19178cad6019b
Author: Claus N√§veke <github@naeveke.de>
Date:   Sun Jul 19 00:40:10 2020 +0200

    Trigorilla Pro board (#18692)

diff --git a/platformio.ini b/platformio.ini
index 7cc3adaa90..762a66f920 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -586,6 +586,14 @@ platform      = ${common_stm32f1.platform}
 extends       = env:mks_robin
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_pro.py
 
+
+#
+# TRIGORILLA PRO (STM32F103ZET6)
+#
+[env:trigorilla_pro]
+platform      = ${common_stm32f1.platform}
+extends       = env:mks_robin
+
 #
 # MKS Robin E3D (STM32F103RCT6) and
 # MKS Robin E3 with TMC2209

commit 3513ea7ae11efa1c3d54392a4f8a398400e3ca19
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Jul 14 17:59:31 2020 -0500

    Specify ststm32 @ 6.1.x

diff --git a/platformio.ini b/platformio.ini
index eac46b660f..7cc3adaa90 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -326,7 +326,7 @@ board     = nxp_lpc1769
 # HAL/STM32 Base Environment values
 #
 [common_stm32]
-platform      = ststm32@<6.2.0
+platform      = ststm32@~6.1.0
 platform_packages = framework-arduinoststm32@>=4.10700,<4.10800
 lib_deps      = ${common.lib_deps}
 lib_ignore    = SoftwareSerial

commit 8f725e25b5242121662248a66d96ecb69ea59d72
Author: ellensp <ellensp@hotmail.com>
Date:   Fri Jul 10 15:51:04 2020 +1200

    Fix CHITU_F103 pio.board name (#18486)

diff --git a/platformio.ini b/platformio.ini
index ae08ee9335..eac46b660f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -672,7 +672,7 @@ lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-H
 [env:chitu_f103]
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
-board         = chitu_f103
+board         = CHITU_F103
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
   buildroot/share/PlatformIO/scripts/chitu_crypt.py
 build_flags   = ${common_stm32f1.build_flags}

commit 67b2b78717ed1dfd1950872832e94a11e77357a8
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Jul 7 19:31:44 2020 -0500

    Fix warning with PIO

diff --git a/platformio.ini b/platformio.ini
index da08d2d14a..ae08ee9335 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -19,6 +19,7 @@
 src_dir      = Marlin
 boards_dir   = buildroot/share/PlatformIO/boards
 default_envs = mega2560
+include_dir  = Marlin
 
 #
 # The 'common' values are used for most Marlin builds

commit 378b5685b3510d59d5b1b0b46942f2cc9df0c8fa
Author: Jason Smith <jason.inet@gmail.com>
Date:   Mon Jul 6 15:51:36 2020 -0700

    0.7.1 <= TMCStepper <= 0.7.9 (#18564)

diff --git a/platformio.ini b/platformio.ini
index a493db9237..da08d2d14a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -29,7 +29,7 @@ extra_scripts      = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
 build_flags        = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
 lib_deps           =
   LiquidCrystal@1.5.0
-  TMCStepper@~0.7.0
+  TMCStepper@~0.7.1
   Adafruit MAX31865 library@~1.1.0
   Adafruit NeoPixel@1.5.0
   U8glib-HAL@0.4.1
@@ -294,7 +294,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
 lib_deps          = Servo
   LiquidCrystal@1.0.0
   U8glib-HAL@0.4.1
-  TMCStepper@~0.7.0
+  TMCStepper@~0.7.1
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/1.5.0.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g ${common.build_flags}
@@ -381,7 +381,7 @@ build_flags       = ${common_stm32f1.build_flags}
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
     buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP.py
 lib_deps          =
-  TMCStepper@~0.7.0
+  TMCStepper@~0.7.1
   Adafruit MAX31865 library@~1.1.0
   U8glib-HAL@0.4.1
   Arduino-L6470@0.8.0

commit 6f14d2d37fbd4c294401243dd2575df1fee9c2bc
Author: J.C. Nelson <32139633+xC0000005@users.noreply.github.com>
Date:   Mon Jul 6 15:08:52 2020 -0700

    Add Lerdge S,X,K (#18302)

diff --git a/platformio.ini b/platformio.ini
index 2c0df405a2..a493db9237 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -821,6 +821,46 @@ build_flags       = ${common_stm32.build_flags}
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
 
+#
+# Lerdge base
+#
+[lerdge_common]
+platform           = ${common_stm32.platform}
+extends            = common_stm32
+board              = LERDGE
+board_build.offset = 0x10000
+extra_scripts      = pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
+                     buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+                     buildroot/share/PlatformIO/scripts/lerdge.py
+build_flags        = ${common_stm32.build_flags}
+  -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
+  -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
+  -DTRANSFER_CLOCK_DIV=8
+build_unflags      = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
+
+#
+# Lerdge X
+#
+[env:LERDGEX]
+extends              = lerdge_common
+board_build.firmware = Lerdge_X_firmware_force.bin
+
+#
+# Lerdge S
+#
+[env:LERDGES]
+extends              = lerdge_common
+board_build.firmware = Lerdge_firmware_force.bin
+
+#
+# Lerdge K
+#
+[env:LERDGEK]
+extends              = lerdge_common
+board_build.firmware = Lerdge_K_firmware_force.bin
+build_flags          = ${lerdge_common.build_flags}
+  -DLERDGEK
+
 #
 # RUMBA32
 #

commit 9f5b8c9bbc9fcabfcbab8a0a2e4de2b7be361da3
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Mon Jul 6 00:11:21 2020 -0500

    Get SAMD51 CXX flags from script

diff --git a/platformio.ini b/platformio.ini
index a54221c7c2..2c0df405a2 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -266,7 +266,8 @@ build_flags   = ${common_DUE_archim.build_flags} -funwind-tables -mpoke-function
 [env:SAMD51_grandcentral_m4]
 platform       = atmelsam
 board          = adafruit_grandcentral_m4
-build_flags    = ${common.build_flags} -std=gnu++17 -Wno-register
+build_flags    = ${common.build_flags} -std=gnu++17
+extra_scripts  = ${common.extra_scripts}
 build_unflags  = -std=gnu++11
 src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
 lib_deps       = ${common.lib_deps}

commit bb89e33e24bccf52fdcbd963e5edc07693ee0bb6
Author: ellensp <ellensp@hotmail.com>
Date:   Sat Jul 4 09:18:09 2020 +1200

    FIx Sanguino/1284p board_upload.maximum_size (#18502)

diff --git a/platformio.ini b/platformio.ini
index 2d390026b5..a54221c7c2 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -147,6 +147,7 @@ board         = sanguino_atmega644p
 platform      = atmelavr
 extends       = common_avr8
 board         = sanguino_atmega1284p
+board_upload.maximum_size = 126976
 
 #
 # Melzi and clones (ATmega1284p)
@@ -157,13 +158,16 @@ extends       = common_avr8
 board         = sanguino_atmega1284p
 lib_ignore    = TMCStepper
 upload_speed  = 57600
+board_upload.maximum_size = 126976
 
 #
 # Melzi and clones (Optiboot bootloader)
 #
 [env:melzi_optiboot]
 platform      = atmelavr
-extends       = env:melzi
+extends       = common_avr8
+board         = sanguino_atmega1284p
+lib_ignore    = TMCStepper
 upload_speed  = 115200
 
 #
@@ -171,8 +175,7 @@ upload_speed  = 115200
 #
 [env:melzi_optimized]
 platform      = atmelavr
-extends       = env:melzi
-upload_speed  = 115200
+extends       = env:melzi_optiboot
 build_flags   = ${common.build_flags} -fno-tree-scev-cprop -fno-split-wide-types -Wl,--relax -mcall-prologues
 build_unflags = -g -ggdb
 

commit 382c566a7771badce5161c5418ff1a329a6e340f
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Fri Jul 3 09:51:44 2020 -0700

    Fix env:mks_robin_nano35 (#18516)

diff --git a/platformio.ini b/platformio.ini
index f0b71d439e..2d390026b5 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -552,6 +552,16 @@ extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
 build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE -DSS_TIMER=4
 
+#
+# MKS Robin Nano (STM32F103VET6) - MKS UI (LVGL)
+#
+[env:mks_robin_nano35]
+platform      = ${common_stm32f1.platform}
+extends       = env:mks_robin_nano
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano35.py
+lib_deps      = ${common_stm32f1.lib_deps}
+  MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
+
 #
 # MKS Robin (STM32F103ZET6)
 #
@@ -627,23 +637,6 @@ build_flags   = ${common_stm32f1.build_flags}
 lib_ignore    = ${common_stm32f1.lib_ignore}
   LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SoftwareSerialM
 
-#
-# MKS Robin Nano (STM32F103VET6) - MKS UI (LVGL)
-#
-[env:mks_robin_nano35]
-platform      = ststm32
-board         = genericSTM32F103VE
-platform_packages = tool-stm32duino
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
-build_unflags = -std=gnu++11
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano35.py
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps      = ${common.lib_deps}
-  SoftwareSerialM
-  MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
-lib_ignore    = Adafruit NeoPixel, SPI
-
 #
 # Malyan M200 v2 (STM32F070RB)
 #
@@ -699,8 +692,8 @@ platform      = ${common_stm32f1.platform}
 extends       = env:chitu_f103
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps      = ${common.lib_deps}
-   SoftwareSerialM
-   MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
+  SoftwareSerialM
+  MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
 
 #
 # Creality (STM32F103RET6)

commit e5bc9d31cc87be5c7ef2bd3cd70c2599f76d2bd7
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Wed Jul 1 03:30:24 2020 -0300

    Add TFT_LVGL_UI support (#18438)

diff --git a/platformio.ini b/platformio.ini
index 1f5385ca51..f0b71d439e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -267,7 +267,7 @@ build_flags    = ${common.build_flags} -std=gnu++17 -Wno-register
 build_unflags  = -std=gnu++11
 src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
 lib_deps       = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  SoftwareSerialM
   Adafruit_SPIFlash=https://github.com/adafruit/Adafruit_SPIFlash/archive/master.zip
 debug_tool     = jlink
 
@@ -346,7 +346,7 @@ lib_ignore    =
   Adafruit NeoPixel
   SPI
 lib_deps      = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  SoftwareSerialM
 
 #
 # STM32F103RC
@@ -385,7 +385,7 @@ lib_deps          =
   LiquidTWI2@1.2.7
   Adafruit NeoPixel=https://github.com/ccccmagicboy/Adafruit_NeoPixel#meeb_3dp_use
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  SoftwareSerialM
   USBComposite for STM32F1@0.91
 lib_ignore        = SPI
 debug_tool        = stlink
@@ -640,7 +640,7 @@ build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano35.py
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps      = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  SoftwareSerialM
   MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
 lib_ignore    = Adafruit NeoPixel, SPI
 
@@ -691,6 +691,17 @@ platform      = ${common_stm32f1.platform}
 extends       = env:chitu_f103
 build_flags   = ${env:chitu_f103.build_flags} -DCHITU_V5_Z_MIN_BUGFIX
 
+#
+# Chitu boards like Tronxy X5SA (STM32F103ZET6) using TFT LVGL UI
+#
+[env:chitu_f103_lvgl]
+platform      = ${common_stm32f1.platform}
+extends       = env:chitu_f103
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
+lib_deps      = ${common.lib_deps}
+   SoftwareSerialM
+   MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
+
 #
 # Creality (STM32F103RET6)
 #

commit c6a066c0be1dce2cd7595d8fb38d0b82f924f786
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Thu Jun 25 23:37:22 2020 -0700

    Update MKS Robin Nano auto-build env (#18417)

diff --git a/platformio.ini b/platformio.ini
index 7415631312..1f5385ca51 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -541,7 +541,7 @@ build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE
 
 #
-# MKS Robin Nano (STM32F103VET6)
+# MKS Robin Nano (STM32F103VET6) - Emulated Graphical 128x64 (DOGM) UI
 #
 [env:mks_robin_nano]
 platform      = ${common_stm32f1.platform}
@@ -628,7 +628,7 @@ lib_ignore    = ${common_stm32f1.lib_ignore}
   LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SoftwareSerialM
 
 #
-# MKS Robin Nano (STM32F103VET6)
+# MKS Robin Nano (STM32F103VET6) - MKS UI (LVGL)
 #
 [env:mks_robin_nano35]
 platform      = ststm32

commit ea569ca29eff699f4e678908660f69e3a1e5e78c
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Tue Jun 23 22:30:35 2020 +0100

    Update LPC176x platform version (#18392)

diff --git a/platformio.ini b/platformio.ini
index dab718cd84..7415631312 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -281,7 +281,7 @@ debug_tool     = jlink
 # NXP LPC176x ARM Cortex-M3
 #
 [common_LPC]
-platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.2.zip
+platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.3.zip
 board             = nxp_lpc1768
 lib_ldf_mode      = off
 lib_compat_mode   = strict

commit a0bbdde4218395ba61538a32c0ace5b3f1b44ac3
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Mon Jun 22 21:28:04 2020 -0500

    Use libraries from the registry

diff --git a/platformio.ini b/platformio.ini
index 3461d195cc..dab718cd84 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -25,18 +25,18 @@ default_envs = mega2560
 #
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
-extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
-build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
-lib_deps =
-  LiquidCrystal
-  TMCStepper@>=0.7.0
-  Adafruit MAX31865 library@>=1.1,<1.2
-  Adafruit NeoPixel
-  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
-  Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/0.8.0.zip
+extra_scripts      = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
+build_flags        = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
+lib_deps           =
+  LiquidCrystal@1.5.0
+  TMCStepper@~0.7.0
+  Adafruit MAX31865 library@~1.1.0
+  Adafruit NeoPixel@1.5.0
+  U8glib-HAL@0.4.1
+  Arduino-L6470@0.8.0
+  SlowSoftI2CMaster
+  LiquidTWI2@1.2.7
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-  SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
 
 #
 # Default values apply to all 'env:' prefixed environments
@@ -283,20 +283,20 @@ debug_tool     = jlink
 [common_LPC]
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.2.zip
 board             = nxp_lpc1768
-build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g ${common.build_flags}
 lib_ldf_mode      = off
 lib_compat_mode   = strict
 extra_scripts     = Marlin/src/HAL/LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
 lib_deps          = Servo
-  LiquidCrystal
-  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  TMCStepper@>=0.6.2
-  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/release.zip
+  LiquidCrystal@1.0.0
+  U8glib-HAL@0.4.1
+  TMCStepper@~0.7.0
+  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/1.5.0.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-# debug options for backtrace
-#  -funwind-tables
-#  -mpoke-function-name
+build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g ${common.build_flags}
+  # debug options for backtrace
+  #-funwind-tables
+  #-mpoke-function-name
 
 #
 # NXP LPC176x ARM Cortex-M3
@@ -376,10 +376,18 @@ build_flags       = ${common_stm32f1.build_flags}
                     -DGENERIC_BOOTLOADER
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
     buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP.py
-lib_deps          = ${common_stm32f1.lib_deps}
-    USBComposite for STM32F1@==0.91
-    Adafruit NeoPixel=https://github.com/ccccmagicboy/Adafruit_NeoPixel#meeb_3dp_use
-lib_ignore        = SPI, LiquidCrystal
+lib_deps          =
+  TMCStepper@~0.7.0
+  Adafruit MAX31865 library@~1.1.0
+  U8glib-HAL@0.4.1
+  Arduino-L6470@0.8.0
+  SlowSoftI2CMaster
+  LiquidTWI2@1.2.7
+  Adafruit NeoPixel=https://github.com/ccccmagicboy/Adafruit_NeoPixel#meeb_3dp_use
+  SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  USBComposite for STM32F1@0.91
+lib_ignore        = SPI
 debug_tool        = stlink
 upload_protocol   = dfu
 
@@ -417,7 +425,7 @@ platform          = ${common_stm32f1.platform}
 extends           = env:STM32F103RC_btt
 build_flags       = ${env:STM32F103RC_btt.build_flags} -DUSE_USB_COMPOSITE
 lib_deps          = ${env:STM32F103RC_btt.lib_deps}
-  USBComposite for STM32F1@==0.91
+  USBComposite for STM32F1@0.91
 
 [env:STM32F103RC_btt_512K]
 platform          = ${common_stm32f1.platform}
@@ -430,7 +438,7 @@ platform          = ${common_stm32f1.platform}
 extends           = env:STM32F103RC_btt_512K
 build_flags       = ${env:STM32F103RC_btt_512K.build_flags} -DUSE_USB_COMPOSITE
 lib_deps          = ${env:STM32F103RC_btt_512K.lib_deps}
-  USBComposite for STM32F1@==0.91
+  USBComposite for STM32F1@0.91
 
 #
 # STM32F103RE
@@ -459,7 +467,7 @@ platform          = ${common_stm32f1.platform}
 extends           = env:STM32F103RE_btt
 build_flags       = ${env:STM32F103RE_btt.build_flags} -DUSE_USB_COMPOSITE
 lib_deps          = ${common_stm32f1.lib_deps}
-  USBComposite for STM32F1@==0.91
+  USBComposite for STM32F1@0.91
 
 #
 # STM32F4 with STM32GENERIC

commit e52afa8b19baf13fe0e6b1818a62fc658b2600c5
Author: Jason Smith <jason.inet@gmail.com>
Date:   Mon Jun 22 13:30:45 2020 -0700

    Better STM32 Tone timer int priority (#18385)

diff --git a/platformio.ini b/platformio.ini
index 2c18fd54b2..3461d195cc 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -329,6 +329,7 @@ build_flags   = ${common.build_flags}
   -IMarlin/src/HAL/STM32 -std=gnu++14
   -DUSBCON -DUSBD_USE_CDC
   -DUSBD_VID=0x0483
+  -DTIM_IRQ_PRIO=13
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 

commit 31167c158b6ed7fc7a5105c7f7848ae85058c11a
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Jun 21 22:10:29 2020 -0500

    TMCStepper 0.7.0

diff --git a/platformio.ini b/platformio.ini
index ee6bebb4dc..2c18fd54b2 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -29,7 +29,7 @@ extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
 build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
 lib_deps =
   LiquidCrystal
-  TMCStepper@>=0.6.2
+  TMCStepper@>=0.7.0
   Adafruit MAX31865 library@>=1.1,<1.2
   Adafruit NeoPixel
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
@@ -810,7 +810,7 @@ lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster, SoftwareS
 [env:rumba32]
 platform      = ${common_stm32.platform}
 extends       = common_stm32
-build_flags   = ${common_stm32.build_flags} 
+build_flags   = ${common_stm32.build_flags}
   -Os
   "-DUSB_PRODUCT=\"RUMBA32\""
   -DHAL_PCD_MODULE_ENABLED

commit d2363c5b35a95ffc8adaa59a4a118faf64fe34e9
Author: Chris Barr <chris@chrisbarrbuilds.com>
Date:   Fri Jun 19 07:56:40 2020 +0930

    Clean up RUMBA32 PlatformIO & tests (#18271)

diff --git a/platformio.ini b/platformio.ini
index 7aa118427d..ee6bebb4dc 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -320,7 +320,7 @@ board     = nxp_lpc1769
 #
 # HAL/STM32 Base Environment values
 #
-[base_stm32]
+[common_stm32]
 platform      = ststm32@<6.2.0
 platform_packages = framework-arduinoststm32@>=4.10700,<4.10800
 lib_deps      = ${common.lib_deps}
@@ -328,17 +328,10 @@ lib_ignore    = SoftwareSerial
 build_flags   = ${common.build_flags}
   -IMarlin/src/HAL/STM32 -std=gnu++14
   -DUSBCON -DUSBD_USE_CDC
+  -DUSBD_VID=0x0483
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 
-#
-# HAL/STM32 Common Environment values
-#
-[common_stm32]
-platform      = ${base_stm32.platform}
-extends       = base_stm32
-build_flags   = ${base_stm32.build_flags} -DUSBD_VID=0x0483
-
 #
 # HAL/STM32F1 Common Environment values
 #
@@ -814,13 +807,12 @@ lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster, SoftwareS
 #
 # RUMBA32
 #
-
-[common_rumba32]
-platform      = ${base_stm32.platform}
-extends       = base_stm32
-build_flags   = ${base_stm32.build_flags} -Os
-  -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
-  -DSTM32F446xx "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
+[env:rumba32]
+platform      = ${common_stm32.platform}
+extends       = common_stm32
+build_flags   = ${common_stm32.build_flags} 
+  -Os
+  "-DUSB_PRODUCT=\"RUMBA32\""
   -DHAL_PCD_MODULE_ENABLED
   -DDISABLE_GENERIC_SERIALUSB
   -DHAL_UART_MODULE_ENABLED
@@ -828,22 +820,6 @@ board         = rumba32_f446ve
 upload_protocol = dfu
 monitor_speed = 500000
 
-#
-# RUMBA32 F446VE
-#
-[env:rumba32_f446ve]
-platform      = ${common_rumba32.platform}
-extends       = common_rumba32
-build_flags   = ${common_rumba32.build_flags} -DUSBD_VID=0x0483
-
-#
-# MKS RUMBA32 (adds TMC2208/2209 UART interface and AUX-1)
-#
-[env:rumba32_mks]
-platform      = ${common_rumba32.platform}
-extends       = common_rumba32
-build_flags   = ${common_rumba32.build_flags} -DUSBD_VID=0x8000
-
 #################################
 #                               #
 #      Other Architectures      #

commit f4c258dc2355fee871bec6e11095c7c4777b160d
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue Jun 16 01:45:27 2020 -0500

    Creality Ender 3 v2 (#17719)

diff --git a/platformio.ini b/platformio.ini
index 34a0a41159..7aa118427d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -689,6 +689,22 @@ platform      = ${common_stm32f1.platform}
 extends       = env:chitu_f103
 build_flags   = ${env:chitu_f103.build_flags} -DCHITU_V5_Z_MIN_BUGFIX
 
+#
+# Creality (STM32F103RET6)
+#
+[env:STM32F103RET6_creality]
+platform        = ${common_stm32f1.platform}
+extends         = common_stm32f1
+board           = genericSTM32F103RC
+build_flags     = !python Marlin/src/HAL/STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY -DTEMP_TIMER_CHAN=4
+extra_scripts   = buildroot/share/PlatformIO/scripts/creality.py
+lib_ignore      = ${common_stm32f1.lib_ignore}
+  LiquidCrystal, LiquidTWI2, U8glib-HAL, Adafruit_MAX31865, Arduino-L6470, SailfishLCD, SlowSoftI2CMaster
+debug_tool      = jlink
+upload_protocol = jlink
+monitor_speed   = 115200
+
 #
 # STM32F401VE
 # 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html

commit 642112d3eb7c1af9a52feec8134c85ed3e34891c
Author: makerbase <4164049@qq.com>
Date:   Tue Jun 16 10:05:33 2020 +0800

    Add MKS UI (TFT_LITTLE_VGL_UI) (#18071)

diff --git a/platformio.ini b/platformio.ini
index 2ef6b70b89..34a0a41159 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -550,7 +550,6 @@ extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
 build_flags   = ${common_stm32f1.build_flags}
   -DMCU_STM32F103VE -DSS_TIMER=4
 
-
 #
 # MKS Robin (STM32F103ZET6)
 #
@@ -626,6 +625,23 @@ build_flags   = ${common_stm32f1.build_flags}
 lib_ignore    = ${common_stm32f1.lib_ignore}
   LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SoftwareSerialM
 
+#
+# MKS Robin Nano (STM32F103VET6)
+#
+[env:mks_robin_nano35]
+platform      = ststm32
+board         = genericSTM32F103VE
+platform_packages = tool-stm32duino
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
+build_unflags = -std=gnu++11
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano35.py
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
+lib_deps      = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  MKS-LittlevGL=https://github.com/makerbase-mks/MKS-LittlevGL/archive/master.zip
+lib_ignore    = Adafruit NeoPixel, SPI
+
 #
 # Malyan M200 v2 (STM32F070RB)
 #

commit 8358f3eadb621f361233ccae6b72179e94573e5e
Author: Victor <rhapsodyv@gmail.com>
Date:   Mon Jun 15 22:00:44 2020 -0300

    Chitu V5 with extra GPIO init (#18299)
    
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/platformio.ini b/platformio.ini
index 3b64e717f2..2ef6b70b89 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -664,6 +664,15 @@ build_flags   = ${common_stm32f1.build_flags}
 build_unflags = ${common_stm32f1.build_unflags}
   -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG= -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 
+#
+# Some Chitu V5 boards have a problem with GPIO init.
+# Use this target if G28 or G29 are always failing.
+#
+[env:chitu_v5_gpio_init]
+platform      = ${common_stm32f1.platform}
+extends       = env:chitu_f103
+build_flags   = ${env:chitu_f103.build_flags} -DCHITU_V5_Z_MIN_BUGFIX
+
 #
 # STM32F401VE
 # 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html

commit 10601a932ace48207f7597b1cfaecf73aa48f817
Author: Per Ivar Nerseth <perivar@nerseth.com>
Date:   Mon Jun 15 03:09:25 2020 +0200

    Zonestar P802M bed thermistor (#18289)
    
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/platformio.ini b/platformio.ini
index cfd04e26cb..3b64e717f2 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -166,6 +166,16 @@ platform      = atmelavr
 extends       = env:melzi
 upload_speed  = 115200
 
+#
+# Melzi and clones (Zonestar Melzi2 with tuned flags)
+#
+[env:melzi_optimized]
+platform      = atmelavr
+extends       = env:melzi
+upload_speed  = 115200
+build_flags   = ${common.build_flags} -fno-tree-scev-cprop -fno-split-wide-types -Wl,--relax -mcall-prologues
+build_unflags = -g -ggdb
+
 #
 # AT90USB1286 boards using CDC bootloader
 # - BRAINWAVE

commit 40f55f8b983bbac5d2bb08785b4c852926567fe5
Author: J.C. Nelson <32139633+xC0000005@users.noreply.github.com>
Date:   Thu Jun 11 19:53:26 2020 -0700

    Chitu variant for disk-based update (#18264)

diff --git a/platformio.ini b/platformio.ini
index d3a57aee2c..cfd04e26cb 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -646,8 +646,9 @@ lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-H
 [env:chitu_f103]
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
-board         = genericSTM32F103ZE
-#extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
+board         = chitu_f103
+extra_scripts = pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
+  buildroot/share/PlatformIO/scripts/chitu_crypt.py
 build_flags   = ${common_stm32f1.build_flags}
   -DSTM32F1xx -DSTM32_XL_DENSITY
 build_unflags = ${common_stm32f1.build_unflags}

commit ea20c77df90b5618f00dd80905474702dc3881e3
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Jun 11 20:17:22 2020 -0500

    Clean up envs / variants

diff --git a/platformio.ini b/platformio.ini
index 2cd95fc692..d3a57aee2c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -8,7 +8,7 @@
 #
 
 # Automatic targets - enable auto-uploading
-# targets = upload
+#targets = upload
 
 #
 # By default platformio build will abort after 5 errors.
@@ -20,6 +20,9 @@ src_dir      = Marlin
 boards_dir   = buildroot/share/PlatformIO/boards
 default_envs = mega2560
 
+#
+# The 'common' values are used for most Marlin builds
+#
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
@@ -35,44 +38,9 @@ lib_deps =
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
   SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
 
-# Common traits for environments using HAL/STM32
-[base_stm32]
-platform      = ststm32@<6.2.0
-platform_packages = framework-arduinoststm32@>=4.10700,<4.10800
-lib_deps      = ${common.lib_deps}
-lib_ignore    = SoftwareSerial
-build_flags   = ${common.build_flags}
-  -IMarlin/src/HAL/STM32 -std=gnu++14
-  -DUSBCON -DUSBD_USE_CDC
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
-
-[common_stm32]
-platform      = ${base_stm32.platform}
-extends       = base_stm32
-build_flags   = ${base_stm32.build_flags} -DUSBD_VID=0x0483
-
-# Common traits for environments using HAL/STM32F1
-[common_stm32f1]
-platform      = ${common_stm32.platform}
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore    =
-  Adafruit NeoPixel
-  SPI
-lib_deps      = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-
-[common_avr8]
-board_build.f_cpu = 16000000L
-lib_deps          = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
-
-# Globally defined properties
-# inherited by all environments
+#
+# Default values apply to all 'env:' prefixed environments
+#
 [env]
 framework     = arduino
 build_flags   = ${common.build_flags}
@@ -89,6 +57,21 @@ monitor_speed = 250000
 #                               #
 #################################
 
+#################################
+#                               #
+#       AVR Architecture        #
+#                               #
+#################################
+
+#
+# AVR (8-bit) Common Environment values
+#
+[common_avr8]
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
+
 #
 # ATmega2560
 #
@@ -206,6 +189,12 @@ lib_ignore    = TMCStepper
 platform      = teensy
 extends       = env:at90usb1286_cdc
 
+#################################
+#                               #
+#       DUE Architecture        #
+#                               #
+#################################
+
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
 #
@@ -252,6 +241,32 @@ platform      = ${common_DUE_archim.platform}
 extends       = common_DUE_archim
 build_flags   = ${common_DUE_archim.build_flags} -funwind-tables -mpoke-function-name
 
+#################################
+#                               #
+#      SAMD51 Architecture      #
+#                               #
+#################################
+
+#
+# Adafruit Grand Central M4 (Atmel SAMD51P20A ARM Cortex-M4)
+#
+[env:SAMD51_grandcentral_m4]
+platform       = atmelsam
+board          = adafruit_grandcentral_m4
+build_flags    = ${common.build_flags} -std=gnu++17 -Wno-register
+build_unflags  = -std=gnu++11
+src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
+lib_deps       = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  Adafruit_SPIFlash=https://github.com/adafruit/Adafruit_SPIFlash/archive/master.zip
+debug_tool     = jlink
+
+#################################
+#                               #
+#     LPC176x Architecture      #
+#                               #
+#################################
+
 #
 # NXP LPC176x ARM Cortex-M3
 #
@@ -286,6 +301,49 @@ platform  = ${common_LPC.platform}
 extends   = common_LPC
 board     = nxp_lpc1769
 
+#################################
+#                               #
+#      STM32 Architecture       #
+#                               #
+#################################
+
+#
+# HAL/STM32 Base Environment values
+#
+[base_stm32]
+platform      = ststm32@<6.2.0
+platform_packages = framework-arduinoststm32@>=4.10700,<4.10800
+lib_deps      = ${common.lib_deps}
+lib_ignore    = SoftwareSerial
+build_flags   = ${common.build_flags}
+  -IMarlin/src/HAL/STM32 -std=gnu++14
+  -DUSBCON -DUSBD_USE_CDC
+build_unflags = -std=gnu++11
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
+
+#
+# HAL/STM32 Common Environment values
+#
+[common_stm32]
+platform      = ${base_stm32.platform}
+extends       = base_stm32
+build_flags   = ${base_stm32.build_flags} -DUSBD_VID=0x0483
+
+#
+# HAL/STM32F1 Common Environment values
+#
+[common_stm32f1]
+platform      = ${common_stm32.platform}
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL
+build_unflags = -std=gnu++11
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
+lib_ignore    =
+  Adafruit NeoPixel
+  SPI
+lib_deps      = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+
 #
 # STM32F103RC
 #
@@ -312,7 +370,7 @@ build_flags       = ${common_stm32f1.build_flags}
                     -DUSE_USB_COMPOSITE
                     -DVECT_TAB_OFFSET=0x2000
                     -DGENERIC_BOOTLOADER
-extra_scripts     = pre:buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP_create_variant.py
+extra_scripts     = pre:buildroot/share/PlatformIO/scripts/STM32F1_create_variant.py
     buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP.py
 lib_deps          = ${common_stm32f1.lib_deps}
     USBComposite for STM32F1@==0.91
@@ -702,26 +760,43 @@ extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_varian
 lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
 
 #
-# Teensy 3.1 / 3.2 (ARM Cortex-M4)
+# RUMBA32
 #
-[env:teensy31]
-platform      = teensy
-board         = teensy31
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-lib_ignore    = Adafruit NeoPixel
-src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY31_32>
+
+[common_rumba32]
+platform      = ${base_stm32.platform}
+extends       = base_stm32
+build_flags   = ${base_stm32.build_flags} -Os
+  -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
+  -DSTM32F446xx "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
+  -DHAL_PCD_MODULE_ENABLED
+  -DDISABLE_GENERIC_SERIALUSB
+  -DHAL_UART_MODULE_ENABLED
+board         = rumba32_f446ve
+upload_protocol = dfu
+monitor_speed = 500000
 
 #
-# Teensy 3.5 / 3.6 (ARM Cortex-M4)
+# RUMBA32 F446VE
 #
-[env:teensy35]
-platform      = teensy
-board         = teensy35
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-lib_ignore    = Adafruit NeoPixel
-src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY35_36>
+[env:rumba32_f446ve]
+platform      = ${common_rumba32.platform}
+extends       = common_rumba32
+build_flags   = ${common_rumba32.build_flags} -DUSBD_VID=0x0483
+
+#
+# MKS RUMBA32 (adds TMC2208/2209 UART interface and AUX-1)
+#
+[env:rumba32_mks]
+platform      = ${common_rumba32.platform}
+extends       = common_rumba32
+build_flags   = ${common_rumba32.build_flags} -DUSBD_VID=0x8000
+
+#################################
+#                               #
+#      Other Architectures      #
+#                               #
+#################################
 
 #
 # Espressif ESP32
@@ -742,6 +817,28 @@ upload_speed  = 115200
 #upload_port   = marlinesp.local
 #board_build.flash_mode = qio
 
+#
+# Teensy 3.1 / 3.2 (ARM Cortex-M4)
+#
+[env:teensy31]
+platform      = teensy
+board         = teensy31
+lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+lib_ignore    = Adafruit NeoPixel
+src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY31_32>
+
+#
+# Teensy 3.5 / 3.6 (ARM Cortex-M4)
+#
+[env:teensy35]
+platform      = teensy
+board         = teensy35
+lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+lib_ignore    = Adafruit NeoPixel
+src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY35_36>
+
 #
 # Native
 # No supported Arduino libraries, base Marlin only
@@ -756,53 +853,6 @@ lib_ldf_mode    = off
 lib_deps        =
 src_filter      = ${common.default_src_filter} +<src/HAL/LINUX>
 
-#
-# Adafruit Grand Central M4 (Atmel SAMD51P20A ARM Cortex-M4)
-#
-[env:SAMD51_grandcentral_m4]
-platform       = atmelsam
-board          = adafruit_grandcentral_m4
-build_flags    = ${common.build_flags} -std=gnu++17 -Wno-register
-build_unflags  = -std=gnu++11
-src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
-lib_deps       = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-  Adafruit_SPIFlash=https://github.com/adafruit/Adafruit_SPIFlash/archive/master.zip
-debug_tool     = jlink
-
-#
-# RUMBA32
-#
-
-[common_rumba32]
-platform      = ${base_stm32.platform}
-extends       = base_stm32
-build_flags   = ${base_stm32.build_flags} -Os
-  -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
-  -DSTM32F446xx "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
-  -DHAL_PCD_MODULE_ENABLED
-  -DDISABLE_GENERIC_SERIALUSB
-  -DHAL_UART_MODULE_ENABLED
-board         = rumba32_f446ve
-upload_protocol = dfu
-monitor_speed = 500000
-
-#
-# RUMBA32 F446VE
-#
-[env:rumba32_f446ve]
-platform      = ${common_rumba32.platform}
-extends       = common_rumba32
-build_flags   = ${common_rumba32.build_flags} -DUSBD_VID=0x0483
-
-#
-# MKS RUMBA32 (adds TMC2208/2209 UART interface and AUX-1)
-#
-[env:rumba32_mks]
-platform      = ${common_rumba32.platform}
-extends       = common_rumba32
-build_flags   = ${common_rumba32.build_flags} -DUSBD_VID=0x8000
-
 #
 # Just print the dependency tree
 #

commit e2cc96662155118f16179518770b03e87e7c05d3
Author: Victor <rhapsodyv@gmail.com>
Date:   Wed Jun 10 19:16:22 2020 -0300

    Tronxy X5SA (V5 / V6 boards) (#18243)

diff --git a/platformio.ini b/platformio.ini
index f89653cba3..2cd95fc692 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -589,7 +589,7 @@ lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-H
 platform      = ${common_stm32f1.platform}
 extends       = common_stm32f1
 board         = genericSTM32F103ZE
-extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
+#extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
 build_flags   = ${common_stm32f1.build_flags}
   -DSTM32F1xx -DSTM32_XL_DENSITY
 build_unflags = ${common_stm32f1.build_unflags}

commit 5ac66b0f959f0591441514754d5b2bb5b4ccb44e
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Jun 7 23:45:25 2020 -0500

    Rumba in the junga

diff --git a/platformio.ini b/platformio.ini
index cfddd9584a..f89653cba3 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -777,6 +777,12 @@ debug_tool     = jlink
 [common_rumba32]
 platform      = ${base_stm32.platform}
 extends       = base_stm32
+build_flags   = ${base_stm32.build_flags} -Os
+  -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
+  -DSTM32F446xx "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
+  -DHAL_PCD_MODULE_ENABLED
+  -DDISABLE_GENERIC_SERIALUSB
+  -DHAL_UART_MODULE_ENABLED
 board         = rumba32_f446ve
 upload_protocol = dfu
 monitor_speed = 500000
@@ -784,11 +790,10 @@ monitor_speed = 500000
 #
 # RUMBA32 F446VE
 #
-
 [env:rumba32_f446ve]
 platform      = ${common_rumba32.platform}
 extends       = common_rumba32
-build_flags   = ${base_stm32.build_flags} -DUSBD_VID=0x0483
+build_flags   = ${common_rumba32.build_flags} -DUSBD_VID=0x0483
 
 #
 # MKS RUMBA32 (adds TMC2208/2209 UART interface and AUX-1)
@@ -796,7 +801,7 @@ build_flags   = ${base_stm32.build_flags} -DUSBD_VID=0x0483
 [env:rumba32_mks]
 platform      = ${common_rumba32.platform}
 extends       = common_rumba32
-build_flags   = ${base_stm32.build_flags} -DUSBD_VID=0x8000
+build_flags   = ${common_rumba32.build_flags} -DUSBD_VID=0x8000
 
 #
 # Just print the dependency tree

commit d7561c4b98f960551b084187ba445da489336f48
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Jun 7 22:34:39 2020 -0500

    Fix rumba32 environments
    
    Followup to #18116

diff --git a/platformio.ini b/platformio.ini
index 18390e1d21..cfddd9584a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -36,17 +36,22 @@ lib_deps =
   SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
 
 # Common traits for environments using HAL/STM32
-[common_stm32]
+[base_stm32]
 platform      = ststm32@<6.2.0
 platform_packages = framework-arduinoststm32@>=4.10700,<4.10800
 lib_deps      = ${common.lib_deps}
 lib_ignore    = SoftwareSerial
 build_flags   = ${common.build_flags}
   -IMarlin/src/HAL/STM32 -std=gnu++14
-  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
+  -DUSBCON -DUSBD_USE_CDC
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 
+[common_stm32]
+platform      = ${base_stm32.platform}
+extends       = base_stm32
+build_flags   = ${base_stm32.build_flags} -DUSBD_VID=0x0483
+
 # Common traits for environments using HAL/STM32F1
 [common_stm32f1]
 platform      = ${common_stm32.platform}
@@ -768,26 +773,30 @@ debug_tool     = jlink
 #
 # RUMBA32
 #
-[env:rumba32_f446ve]
-platform      = ${common_stm32.platform}
-extends       = common_stm32
+
+[common_rumba32]
+platform      = ${base_stm32.platform}
+extends       = base_stm32
 board         = rumba32_f446ve
-build_flags   = ${common_stm32.build_flags} -Os
-  -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
-  -DSTM32F446xx "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
-  -DHAL_PCD_MODULE_ENABLED
-  -DDISABLE_GENERIC_SERIALUSB
-  -DHAL_UART_MODULE_ENABLED
-monitor_speed = 500000
 upload_protocol = dfu
+monitor_speed = 500000
+
+#
+# RUMBA32 F446VE
+#
+
+[env:rumba32_f446ve]
+platform      = ${common_rumba32.platform}
+extends       = common_rumba32
+build_flags   = ${base_stm32.build_flags} -DUSBD_VID=0x0483
 
 #
 # MKS RUMBA32 (adds TMC2208/2209 UART interface and AUX-1)
 #
 [env:rumba32_mks]
-platform      = ${common_stm32.platform}
-extends       = env:rumba32_f446ve
-build_flags   = ${rumba32_f446ve.build_flags} -UUSBD_VID -DUSBD_VID=0x8000
+platform      = ${common_rumba32.platform}
+extends       = common_rumba32
+build_flags   = ${base_stm32.build_flags} -DUSBD_VID=0x8000
 
 #
 # Just print the dependency tree

commit 1a5663fbf4fc54efd8a9ca9ecad888fbae2cc76f
Author: Jason Smith <jason.inet@gmail.com>
Date:   Sun Jun 7 18:29:10 2020 -0700

    PIO base STM32 environment (#18116)

diff --git a/platformio.ini b/platformio.ini
index eec9710c64..18390e1d21 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -21,7 +21,6 @@ boards_dir   = buildroot/share/PlatformIO/boards
 default_envs = mega2560
 
 [common]
-arduinoststm32_ver = >=4.10700,<4.10800
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
 build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
@@ -36,8 +35,21 @@ lib_deps =
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
   SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
 
-[common_stm32f1]
+# Common traits for environments using HAL/STM32
+[common_stm32]
 platform      = ststm32@<6.2.0
+platform_packages = framework-arduinoststm32@>=4.10700,<4.10800
+lib_deps      = ${common.lib_deps}
+lib_ignore    = SoftwareSerial
+build_flags   = ${common.build_flags}
+  -IMarlin/src/HAL/STM32 -std=gnu++14
+  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
+build_unflags = -std=gnu++11
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
+
+# Common traits for environments using HAL/STM32F1
+[common_stm32f1]
+platform      = ${common_stm32.platform}
 build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL
 build_unflags = -std=gnu++11
@@ -386,7 +398,7 @@ lib_deps          = ${common_stm32f1.lib_deps}
 # STM32F4 with STM32GENERIC
 #
 [env:STM32F4]
-platform      = ststm32@<6.2.0
+platform      = ${common_stm32.platform}
 board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
 lib_ignore    = Adafruit NeoPixel, TMCStepper
@@ -396,7 +408,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/ST
 # STM32F7 with STM32GENERIC
 #
 [env:STM32F7]
-platform      = ststm32@<6.2.0
+platform      = ${common_stm32.platform}
 board         = remram_v1
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
 lib_ignore    = Adafruit NeoPixel, TMCStepper
@@ -406,15 +418,12 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/ST
 # ARMED (STM32)
 #
 [env:ARMED]
-platform      = ststm32@<6.2.0
-platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
+platform      = ${common_stm32.platform}
+extends       = common_stm32
 board         = armed_v1
-build_flags   = ${common.build_flags}
-  -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DUSBD_USE_CDC
-  -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
-  -IMarlin/src/HAL/STM32
-lib_ignore    = Adafruit NeoPixel, SoftwareSerial
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
+build_flags   = ${common_stm32.build_flags}
+  '-DUSB_PRODUCT="ARMED_V1"'
+  -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
 
 #
 # Geeetech GTM32 (STM32F103VET6)
@@ -548,14 +557,12 @@ lib_ignore    = ${common_stm32f1.lib_ignore}
 # Malyan M200 v2 (STM32F070RB)
 #
 [env:STM32F070RB_malyan]
-platform    = ststm32@<6.2.0
-platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
+platform    = ${common_stm32.platform}
+extends     = common_stm32
 board       = malyanM200v2
-build_flags = -DSTM32F0xx -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED
+build_flags = ${common_stm32.build_flags} -DSTM32F0xx -DUSB_PRODUCT=\"STM32F070RB\" -DHAL_PCD_MODULE_ENABLED
   -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
   -DCUSTOM_STARTUP_FILE
-  -IMarlin/src/HAL/STM32
-src_filter  = ${common.default_src_filter} +<src/HAL/STM32>
 lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-HAL, SoftwareSerial
 
 #
@@ -588,56 +595,42 @@ build_unflags = ${common_stm32f1.build_unflags}
 # 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
 #
 [env:STM32F401VE_STEVAL]
-platform          = ststm32@<6.2.0
-platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
+platform          = ${common_stm32.platform}
+extends           = common_stm32
 board             = STEVAL_STM32F401VE
-build_flags       = ${common.build_flags}
-  -DTARGET_STM32F4 -DSTM32F401xE -DUSBCON
-  -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STEVAL_F401VE\"
-  -DARDUINO_STEVAL -DDISABLE_GENERIC_SERIALUSB
-  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-  -IMarlin/src/HAL/STM32
-build_unflags     = -std=gnu++11
+build_flags       = ${common_stm32.build_flags}
+  -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
+  -DUSB_PRODUCT=\"STEVAL_F401VE\"
+  -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/STEVAL__F401XX.py
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
 # FLYF407ZG
 #
 [env:FLYF407ZG]
-platform          = ststm32@<6.2.0
-platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
+platform          = ${common_stm32.platform}
+extends           = common_stm32
 board             = FLYF407ZG
-build_flags       = ${common.build_flags}
-  -DTARGET_STM32F4 -DSTM32F4 -DUSBCON
-  -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
-  -DVECT_TAB_OFFSET=0x8000 -IMarlin/src/HAL/STM32
-build_unflags     = -std=gnu++11
+build_flags       = ${common_stm32.build_flags}
+  -DSTM32F4 -DUSB_PRODUCT=\"STM32F407ZG\"
+  -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x8000
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
-
 
 #
 # FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
-platform          = ststm32@<6.2.0
-platform_packages =
+platform      = ${common_stm32.platform}
+extends       = common_stm32
+platform_packages = ${common_stm32.platform_packages}
    tool-stm32duino
-   framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = fysetc_s6
-build_flags       = ${common.build_flags}
-  -DTARGET_STM32F4 -std=gnu++14
-  -DVECT_TAB_OFFSET=0x10000
-  -DUSBCON -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED -DUSBD_VID=0x0483 '-DUSB_PRODUCT="FYSETC_S6"'
-  -IMarlin/src/HAL/STM32
-build_unflags     = -std=gnu++11
+build_flags       = ${common_stm32.build_flags}
+  -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x10000
+  -DHAL_PCD_MODULE_ENABLED '-DUSB_PRODUCT="FYSETC_S6"'
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
-lib_ignore        = Arduino-L6470, SoftwareSerial
 debug_tool        = stlink
 upload_protocol   = dfu
 upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
@@ -648,34 +641,27 @@ upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
-platform          = ststm32@<6.2.0
-platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
+platform          = ${common_stm32.platform}
+extends           = common_stm32
 board             = blackSTM32F407VET6
-build_flags       = ${common.build_flags}
+build_flags       = ${common_stm32.build_flags}
   -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
-  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
+  -DUSB_PRODUCT=\"BLACK_F407VE\"
   -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-  -IMarlin/src/HAL/STM32
-build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
-platform          = ststm32@<6.2.0
-platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
+platform          = ${common_stm32.platform}
+extends           = common_stm32
 board             = BigTree_SKR_Pro
-build_flags       = ${common.build_flags}
-  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
+build_flags       = ${common_stm32.build_flags}
+  -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
-  -IMarlin/src/HAL/STM32
-build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_ignore        = SoftwareSerial, SoftwareSerialM
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 #upload_protocol   = stlink
 #upload_command    = "$PROJECT_PACKAGES_DIR/tool-stm32duino/stlink/ST-LINK_CLI.exe" -c SWD -P "$BUILD_DIR/firmware.bin" 0x8008000 -Rst -Run
 debug_tool        = stlink
@@ -686,42 +672,29 @@ debug_init_break  =
 #
 [env:BIGTREE_GTR_V1_0]
 platform          = ststm32@>=5.7.0,<6.2.0
-platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
+extends           = common_stm32
 board             = BigTree_GTR_v1
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-build_flags       = ${common.build_flags}
-  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407IG\"
+build_flags       = ${common_stm32.build_flags}
+  -DUSB_PRODUCT=\"STM32F407IG\"
   -DTARGET_STM32F4 -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
-  -IMarlin/src/HAL/STM32
-lib_deps          =
-  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  LiquidCrystal
-  TMCStepper@>=0.5.2,<1.0.0
-  Adafruit NeoPixel
-  LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
-  Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
-lib_ignore        = SoftwareSerial, SoftwareSerialM
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
 # BigTreeTech BTT002 V1.0 (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
-platform          = ststm32@5.6.0
-platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
+platform          = ${common_stm32.platform}
+extends           = common_stm32
 board             = BigTree_Btt002
-build_flags       = ${common.build_flags}
-  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407VG\"
+build_flags       = ${common_stm32.build_flags}
+  -DUSB_PRODUCT=\"STM32F407VG\"
   -DTARGET_STM32F4 -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DHAVE_HWSERIAL2
   -DHAVE_HWSERIAL3
   -DPIN_SERIAL2_RX=PD_6
   -DPIN_SERIAL2_TX=PD_5
-  -IMarlin/src/HAL/STM32
-build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
 # Teensy 3.1 / 3.2 (ARM Cortex-M4)
@@ -795,35 +768,26 @@ debug_tool     = jlink
 #
 # RUMBA32
 #
-
-[common_rumba32]
-platform      = ststm32@<6.2.0
-platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
+[env:rumba32_f446ve]
+platform      = ${common_stm32.platform}
+extends       = common_stm32
 board         = rumba32_f446ve
-build_flags   = ${common.build_flags} -Os -IMarlin/src/HAL/STM32
+build_flags   = ${common_stm32.build_flags} -Os
   -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
-  -DSTM32F446xx -DUSBCON "-DUSB_MANUFACTURER=\"Unknown\"" "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
+  -DSTM32F446xx "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
   -DHAL_PCD_MODULE_ENABLED
-  -DUSBD_USE_CDC
   -DDISABLE_GENERIC_SERIALUSB
   -DHAL_UART_MODULE_ENABLED
-lib_ignore    = Adafruit NeoPixel, SoftwareSerial
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
-upload_protocol = dfu
-
-[env:rumba32_f446ve]
-platform      = ${common_rumba32.platform}
-extends       = common_rumba32
-build_flags   = ${common_rumba32.build_flags} -DUSBD_VID=0x0483
 monitor_speed = 500000
+upload_protocol = dfu
 
 #
 # MKS RUMBA32 (adds TMC2208/2209 UART interface and AUX-1)
 #
 [env:rumba32_mks]
-platform    = ${common_rumba32.platform}
-extends     = common_rumba32
-build_flags = ${common_rumba32.build_flags} -DUSBD_VID=0x8000
+platform      = ${common_stm32.platform}
+extends       = env:rumba32_f446ve
+build_flags   = ${rumba32_f446ve.build_flags} -UUSBD_VID -DUSBD_VID=0x8000
 
 #
 # Just print the dependency tree

commit 89704ce7f92831d9729bd8b348f932486cee8717
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Jun 7 19:40:13 2020 -0500

    Support STM32 platform up to 6.1.x

diff --git a/platformio.ini b/platformio.ini
index 4ecf0e3df7..eec9710c64 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -37,7 +37,7 @@ lib_deps =
   SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
 
 [common_stm32f1]
-platform      = ststm32
+platform      = ststm32@<6.2.0
 build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL
 build_unflags = -std=gnu++11
@@ -386,7 +386,7 @@ lib_deps          = ${common_stm32f1.lib_deps}
 # STM32F4 with STM32GENERIC
 #
 [env:STM32F4]
-platform      = ststm32
+platform      = ststm32@<6.2.0
 board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
 lib_ignore    = Adafruit NeoPixel, TMCStepper
@@ -396,7 +396,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/ST
 # STM32F7 with STM32GENERIC
 #
 [env:STM32F7]
-platform      = ststm32
+platform      = ststm32@<6.2.0
 board         = remram_v1
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
 lib_ignore    = Adafruit NeoPixel, TMCStepper
@@ -406,7 +406,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/ST
 # ARMED (STM32)
 #
 [env:ARMED]
-platform      = ststm32
+platform      = ststm32@<6.2.0
 platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board         = armed_v1
 build_flags   = ${common.build_flags}
@@ -548,7 +548,7 @@ lib_ignore    = ${common_stm32f1.lib_ignore}
 # Malyan M200 v2 (STM32F070RB)
 #
 [env:STM32F070RB_malyan]
-platform    = ststm32
+platform    = ststm32@<6.2.0
 platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board       = malyanM200v2
 build_flags = -DSTM32F0xx -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED
@@ -562,7 +562,7 @@ lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-H
 # Malyan M300 (STM32F070CB)
 #
 [env:malyan_M300]
-platform    = ststm32@>=6.1.0
+platform    = ststm32@>=6.1.0,<6.2.0
 board       = malyanm300_f070cb
 build_flags = ${common.build_flags}
   -DUSBCON -DUSBD_VID=0x0483 "-DUSB_MANUFACTURER=\"Unknown\"" "-DUSB_PRODUCT=\"MALYAN_M300\""
@@ -588,7 +588,7 @@ build_unflags = ${common_stm32f1.build_unflags}
 # 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
 #
 [env:STM32F401VE_STEVAL]
-platform          = ststm32
+platform          = ststm32@<6.2.0
 platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = STEVAL_STM32F401VE
 build_flags       = ${common.build_flags}
@@ -607,7 +607,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 # FLYF407ZG
 #
 [env:FLYF407ZG]
-platform          = ststm32
+platform          = ststm32@<6.2.0
 platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = FLYF407ZG
 build_flags       = ${common.build_flags}
@@ -624,7 +624,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 # FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
-platform          = ststm32
+platform          = ststm32@<6.2.0
 platform_packages =
    tool-stm32duino
    framework-arduinoststm32@${common.arduinoststm32_ver}
@@ -648,7 +648,7 @@ upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
-platform          = ststm32
+platform          = ststm32@<6.2.0
 platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = blackSTM32F407VET6
 build_flags       = ${common.build_flags}
@@ -665,7 +665,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
-platform          = ststm32
+platform          = ststm32@<6.2.0
 platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = BigTree_SKR_Pro
 build_flags       = ${common.build_flags}
@@ -685,7 +685,7 @@ debug_init_break  =
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_GTR_V1_0]
-platform          = ststm32@>=5.7.0
+platform          = ststm32@>=5.7.0,<6.2.0
 platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = BigTree_GTR_v1
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
@@ -795,52 +795,35 @@ debug_tool     = jlink
 #
 # RUMBA32
 #
-[env:rumba32_f446ve]
-platform      = ststm32
+
+[common_rumba32]
+platform      = ststm32@<6.2.0
 platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board         = rumba32_f446ve
-build_flags   = ${common.build_flags}
-  -DSTM32F4xx
-  -DARDUINO_RUMBA32_F446VE
-  -DARDUINO_ARCH_STM32
-  "-DBOARD_NAME=\"RUMBA32_F446VE\""
-  -DSTM32F446xx
-  -DUSBCON
-  -DUSBD_VID=0x0483
-  "-DUSB_MANUFACTURER=\"Unknown\""
-  "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
+build_flags   = ${common.build_flags} -Os -IMarlin/src/HAL/STM32
+  -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
+  -DSTM32F446xx -DUSBCON "-DUSB_MANUFACTURER=\"Unknown\"" "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
   -DHAL_PCD_MODULE_ENABLED
   -DUSBD_USE_CDC
   -DDISABLE_GENERIC_SERIALUSB
   -DHAL_UART_MODULE_ENABLED
-  -Os
-  -IMarlin/src/HAL/STM32
 lib_ignore    = Adafruit NeoPixel, SoftwareSerial
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
-monitor_speed = 500000
 upload_protocol = dfu
 
+[env:rumba32_f446ve]
+platform      = ${common_rumba32.platform}
+extends       = common_rumba32
+build_flags   = ${common_rumba32.build_flags} -DUSBD_VID=0x0483
+monitor_speed = 500000
+
 #
 # MKS RUMBA32 (adds TMC2208/2209 UART interface and AUX-1)
 #
 [env:rumba32_mks]
-platform      = ststm32
-platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
-board         = rumba32_f446ve
-build_flags   = ${common.build_flags}
-  -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
-  -DSTM32F446xx -DUSBCON -DUSBD_VID=0x8000
-  "-DUSB_MANUFACTURER=\"Unknown\""
-  "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
-  -DHAL_PCD_MODULE_ENABLED
-  -DUSBD_USE_CDC
-  -DDISABLE_GENERIC_SERIALUSB
-  -DHAL_UART_MODULE_ENABLED
-  -Os
-  -IMarlin/src/HAL/STM32
-lib_ignore    = Adafruit NeoPixel, SoftwareSerial
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
-upload_protocol = dfu
+platform    = ${common_rumba32.platform}
+extends     = common_rumba32
+build_flags = ${common_rumba32.build_flags} -DUSBD_VID=0x8000
 
 #
 # Just print the dependency tree

commit d5bfc5b07beb624d30fbed15b6eb4d2b258e5095
Author: grauerfuchs <42082416+grauerfuchs@users.noreply.github.com>
Date:   Thu Jun 4 00:23:53 2020 -0400

    Fix Mightyboard envs (#18194)

diff --git a/platformio.ini b/platformio.ini
index 78dc01bf0a..4ecf0e3df7 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -94,7 +94,7 @@ board         = megaatmega1280
 [env:MightyBoard1280]
 platform      = atmelavr
 extends       = common_avr8
-board         = megaatmega1280
+board         = ATmega1280
 upload_speed  = 57600
 
 #
@@ -103,7 +103,7 @@ upload_speed  = 57600
 [env:MightyBoard2560]
 platform      = atmelavr
 extends       = common_avr8
-board         = megaatmega2560
+board         = ATmega2560
 upload_protocol = wiring
 upload_speed  = 57600
 board_upload.maximum_size = 253952

commit 419f31f3713607d6867e342ee4e907f28112f945
Author: cccc <cuiwei_cv@163.com>
Date:   Wed Jun 3 10:03:59 2020 +0800

    SoftwareSerialM for MEEB (#18178)

diff --git a/platformio.ini b/platformio.ini
index a8948024b8..78dc01bf0a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -297,7 +297,7 @@ build_flags       = ${common_stm32f1.build_flags}
                     -DGENERIC_BOOTLOADER
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP_create_variant.py
     buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP.py
-lib_deps          = ${common.lib_deps}
+lib_deps          = ${common_stm32f1.lib_deps}
     USBComposite for STM32F1@==0.91
     Adafruit NeoPixel=https://github.com/ccccmagicboy/Adafruit_NeoPixel#meeb_3dp_use
 lib_ignore        = SPI, LiquidCrystal

commit c9a260ee12c9cc6a877a9e1155ddc8c619e4b7a4
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun May 31 02:12:29 2020 -0500

    MEEB cleanup, whitespace
    
    Followup to #18138

diff --git a/platformio.ini b/platformio.ini
index fa27fb9a9a..a8948024b8 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -282,7 +282,7 @@ monitor_speed     = 115200
 #
 # MEEB_3DP (STM32F103RCT6 with 512K)
 #
-[env:STM32F103RC_cc_meeb_3dp]
+[env:STM32F103RC_meeb]
 platform          = ${common_stm32f1.platform}
 extends           = common_stm32f1
 board             = MEEB_3DP

commit 2bf63e29c627ec6396cd2ac84e76c2cd45d03780
Author: cccc <cuiwei_cv@163.com>
Date:   Tue Jun 2 07:25:13 2020 +0800

    Support for MEEB 3DP board (#18138)

diff --git a/platformio.ini b/platformio.ini
index aa8dd21983..fa27fb9a9a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -45,15 +45,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore    =
   Adafruit NeoPixel
   SPI
-lib_deps      =
-  LiquidCrystal
-  TMCStepper@>=0.6.2
-  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  Adafruit MAX31865 library@>=1.1,<1.2
-  LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
-  Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/0.8.0.zip
-  SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-  SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
+lib_deps      = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 
 [common_avr8]
@@ -287,6 +279,31 @@ board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
 monitor_speed     = 115200
 
+#
+# MEEB_3DP (STM32F103RCT6 with 512K)
+#
+[env:STM32F103RC_cc_meeb_3dp]
+platform          = ${common_stm32f1.platform}
+extends           = common_stm32f1
+board             = MEEB_3DP
+platform_packages = tool-stm32duino
+build_flags       = ${common_stm32f1.build_flags}
+                    -DDEBUG_LEVEL=0
+                    -DSS_TIMER=4
+                    -DSTM32_FLASH_SIZE=512
+                    -DHSE_VALUE=12000000U
+                    -DUSE_USB_COMPOSITE
+                    -DVECT_TAB_OFFSET=0x2000
+                    -DGENERIC_BOOTLOADER
+extra_scripts     = pre:buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP_create_variant.py
+    buildroot/share/PlatformIO/scripts/STM32F103RC_MEEB_3DP.py
+lib_deps          = ${common.lib_deps}
+    USBComposite for STM32F1@==0.91
+    Adafruit NeoPixel=https://github.com/ccccmagicboy/Adafruit_NeoPixel#meeb_3dp_use
+lib_ignore        = SPI, LiquidCrystal
+debug_tool        = stlink
+upload_protocol   = dfu
+
 #
 # STM32F103RC_fysetc
 #

commit a740b6b3180f2407dec41f944faf69b8f2100615
Author: ellensp <ellensp@hotmail.com>
Date:   Fri May 29 05:52:13 2020 +1200

    More 'extend'ed environments (#18118)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 416d21f82f..aa8dd21983 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -56,6 +56,12 @@ lib_deps      =
   SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 
+[common_avr8]
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
+
 # Globally defined properties
 # inherited by all environments
 [env]
@@ -78,112 +84,85 @@ monitor_speed = 250000
 # ATmega2560
 #
 [env:mega2560]
-platform          = atmelavr
-board             = megaatmega2560
-board_build.f_cpu = 16000000L
-lib_deps          = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
+platform      = atmelavr
+extends       = common_avr8
+board         = megaatmega2560
 
 #
 # ATmega1280
 #
 [env:mega1280]
-platform          = atmelavr
-board             = megaatmega1280
-board_build.f_cpu = 16000000L
-lib_deps          = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
+platform      = atmelavr
+extends       = common_avr8
+board         = megaatmega1280
 
 #
 # MightyBoard ATmega2560 (MegaCore 100 pin boards variants)
 #
 [env:MightyBoard1280]
-platform          = atmelavr
-board             = ATmega1280
-board_build.f_cpu = 16000000L
-lib_deps          = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
-upload_speed      = 57600
+platform      = atmelavr
+extends       = common_avr8
+board         = megaatmega1280
+upload_speed  = 57600
 
 #
 # MightyBoard ATmega2560 (MegaCore 100 pin boards variants)
 #
 [env:MightyBoard2560]
-platform          = atmelavr
-board             = ATmega2560
-board_build.f_cpu = 16000000L
-lib_deps          = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
-upload_protocol   = wiring
-upload_speed      = 57600
+platform      = atmelavr
+extends       = common_avr8
+board         = megaatmega2560
+upload_protocol = wiring
+upload_speed  = 57600
 board_upload.maximum_size = 253952
 
 #
 # RAMBo
 #
 [env:rambo]
-platform          = atmelavr
-board             = reprap_rambo
-board_build.f_cpu = 16000000L
-lib_deps          = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
+platform      = atmelavr
+extends       = common_avr8
+board         = reprap_rambo
 
 #
 # FYSETC F6 V1.3
 #
 [env:FYSETC_F6_13]
-platform          = atmelavr
-board             = fysetc_f6_13
-board_build.f_cpu = 16000000L
-lib_deps          = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
+platform      = atmelavr
+extends       = common_avr8
+board         = fysetc_f6_13
 
 #
 # FYSETC F6 V1.4
 #
 [env:FYSETC_F6_14]
-platform          = atmelavr
-board             = fysetc_f6_14
-board_build.f_cpu = 16000000L
-lib_deps          = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
+platform      = atmelavr
+extends       = common_avr8
+board         = fysetc_f6_14
 
 #
 # Sanguinololu (ATmega644p)
 #
 [env:sanguino644p]
 platform      = atmelavr
+extends       = common_avr8
 board         = sanguino_atmega644p
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # Sanguinololu (ATmega1284p)
 #
 [env:sanguino1284p]
 platform      = atmelavr
+extends       = common_avr8
 board         = sanguino_atmega1284p
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # Melzi and clones (ATmega1284p)
 #
 [env:melzi]
 platform      = atmelavr
+extends       = common_avr8
 board         = sanguino_atmega1284p
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
 lib_ignore    = TMCStepper
 upload_speed  = 57600
 
@@ -192,11 +171,7 @@ upload_speed  = 57600
 #
 [env:melzi_optiboot]
 platform      = atmelavr
-board         = sanguino_atmega1284p
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
-lib_ignore    = TMCStepper
+extends       = env:melzi
 upload_speed  = 115200
 
 #
@@ -208,11 +183,9 @@ upload_speed  = 115200
 #
 [env:at90usb1286_cdc]
 platform      = teensy
+extends       = common_avr8
 board         = at90usb1286
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 lib_ignore    = TMCStepper
-src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # AT90USB1286 boards using DFU bootloader
@@ -222,10 +195,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
 #
 [env:at90usb1286_dfu]
 platform      = teensy
-board         = at90usb1286
-lib_deps      = ${common.lib_deps}
-lib_ignore    = TMCStepper
-src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
+extends       = env:at90usb1286_cdc
 
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
@@ -255,7 +225,7 @@ build_flags   = ${common.build_flags}
 #
 # Archim SAM
 #
-[env:DUE_archim]
+[common_DUE_archim]
 platform      = atmelsam
 board         = due
 src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
@@ -263,26 +233,23 @@ build_flags   = ${common.build_flags}
   -DARDUINO_SAM_ARCHIM -DARDUINO_ARCH_SAM -D__SAM3X8E__ -DUSBCON
 extra_scripts = Marlin/src/HAL/DUE/upload_extra_script.py
 
-[env:DUE_archim_debug]
+[env:DUE_archim]
+platform      = ${common_DUE_archim.platform}
+extends       = common_DUE_archim
+
 # Used when WATCHDOG_RESET_MANUAL is enabled
-platform      = atmelsam
-board         = due
-src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
-build_flags   = ${common.build_flags}
-  -DARDUINO_SAM_ARCHIM -DARDUINO_ARCH_SAM -D__SAM3X8E__ -DUSBCON
-  -funwind-tables -mpoke-function-name
-extra_scripts = Marlin/src/HAL/DUE/upload_extra_script.py
+[env:DUE_archim_debug]
+platform      = ${common_DUE_archim.platform}
+extends       = common_DUE_archim
+build_flags   = ${common_DUE_archim.build_flags} -funwind-tables -mpoke-function-name
 
 #
 # NXP LPC176x ARM Cortex-M3
 #
-[env:LPC1768]
+[common_LPC]
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.2.zip
 board             = nxp_lpc1768
 build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g ${common.build_flags}
-# debug options for backtrace
-#  -funwind-tables
-#  -mpoke-function-name
 lib_ldf_mode      = off
 lib_compat_mode   = strict
 extra_scripts     = Marlin/src/HAL/LPC1768/upload_extra_script.py
@@ -293,24 +260,22 @@ lib_deps          = Servo
   TMCStepper@>=0.6.2
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/release.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-
-[env:LPC1769]
-platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.2.zip
-board             = nxp_lpc1769
-build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g ${common.build_flags}
 # debug options for backtrace
 #  -funwind-tables
 #  -mpoke-function-name
-lib_ldf_mode      = off
-lib_compat_mode   = strict
-extra_scripts     = Marlin/src/HAL/LPC1768/upload_extra_script.py
-src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
-lib_deps          = Servo
-  LiquidCrystal
-  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  TMCStepper@>=0.6.2
-  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/release.zip
-  SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
+
+#
+# NXP LPC176x ARM Cortex-M3
+#
+[env:LPC1768]
+platform  = ${common_LPC.platform}
+extends   = common_LPC
+board     = nxp_lpc1768
+
+[env:LPC1769]
+platform  = ${common_LPC.platform}
+extends   = common_LPC
+board     = nxp_lpc1769
 
 #
 # STM32F103RC
@@ -610,9 +575,10 @@ platform          = ststm32
 platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = STEVAL_STM32F401VE
 build_flags       = ${common.build_flags}
-  -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
-  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STEVAL_F401VE\"
-  -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+  -DTARGET_STM32F4 -DSTM32F401xE -DUSBCON
+  -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STEVAL_F401VE\"
+  -DARDUINO_STEVAL -DDISABLE_GENERIC_SERIALUSB
+  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
   -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
@@ -628,9 +594,9 @@ platform          = ststm32
 platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = FLYF407ZG
 build_flags       = ${common.build_flags}
-  -DSTM32F4 -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
-  -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x8000
-  -IMarlin/src/HAL/STM32
+  -DTARGET_STM32F4 -DSTM32F4 -DUSBCON
+  -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
+  -DVECT_TAB_OFFSET=0x8000 -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial

commit f402ab7afb8bf7b9989bf0b75769be30c302d921
Author: Jason Smith <jason.inet@gmail.com>
Date:   Mon May 25 16:39:51 2020 -0700

    Limit MAX31865 library to <1.2 (#18089)

diff --git a/platformio.ini b/platformio.ini
index 350095e37f..416d21f82f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -28,7 +28,7 @@ build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
 lib_deps =
   LiquidCrystal
   TMCStepper@>=0.6.2
-  Adafruit MAX31865 library
+  Adafruit MAX31865 library@>=1.1,<1.2
   Adafruit NeoPixel
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip

commit 5fefecc5268f596ded2154ae323249c003e5d934
Author: Jason Smith <jason.inet@gmail.com>
Date:   Mon May 25 16:24:16 2020 -0700

    Use 'extends' for STM32F1, fix lib versions (#18099)

diff --git a/platformio.ini b/platformio.ini
index 9d7da43fba..350095e37f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -27,15 +27,35 @@ extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
 build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
 lib_deps =
   LiquidCrystal
-  TMCStepper@>=0.6.2,<1.0.0
+  TMCStepper@>=0.6.2
+  Adafruit MAX31865 library
   Adafruit NeoPixel
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  Adafruit_MAX31865=https://github.com/adafruit/Adafruit_MAX31865/archive/master.zip
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/0.8.0.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
   SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
 
+[common_stm32f1]
+platform      = ststm32
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL
+build_unflags = -std=gnu++11
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
+lib_ignore    =
+  Adafruit NeoPixel
+  SPI
+lib_deps      =
+  LiquidCrystal
+  TMCStepper@>=0.6.2
+  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
+  Adafruit MAX31865 library@>=1.1,<1.2
+  LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
+  Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/0.8.0.zip
+  SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
+  SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+
 # Globally defined properties
 # inherited by all environments
 [env]
@@ -296,34 +316,20 @@ lib_deps          = Servo
 # STM32F103RC
 #
 [env:STM32F103RC]
-platform          = ststm32
+platform          = ${common_stm32f1.platform}
+extends           = common_stm32f1
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-build_unflags     = -std=gnu++11
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
 #
 # STM32F103RC_fysetc
 #
 [env:STM32F103RC_fysetc]
-platform          = ststm32
-board             = genericSTM32F103RC
-#board_build.core = maple
-platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DDEBUG_LEVEL=0 -DHAVE_SW_SERIAL
-build_unflags     = -std=gnu++11
+platform          = ${common_stm32f1.platform}
+extends           = env:STM32F103RC
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_fysetc.py
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
+build_flags       = ${common_stm32f1.build_flags} -DDEBUG_LEVEL=0
 lib_ldf_mode      = chain
 debug_tool        = stlink
 upload_protocol   = serial
@@ -338,79 +344,41 @@ upload_protocol   = serial
 #
 
 [env:STM32F103RC_btt]
-platform          = ststm32
-board             = genericSTM32F103RC
-platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
-build_unflags     = -std=gnu++11
+platform          = ${common_stm32f1.platform}
+extends           = env:STM32F103RC
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
+build_flags       = ${common_stm32f1.build_flags}
+  -DDEBUG_LEVEL=0 -DSS_TIMER=4
 monitor_speed     = 115200
 
 [env:STM32F103RC_btt_USB]
-platform          = ststm32
-board             = genericSTM32F103RC
-platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DUSE_USB_COMPOSITE
-build_unflags     = -std=gnu++11
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+platform          = ${common_stm32f1.platform}
+extends           = env:STM32F103RC_btt
+build_flags       = ${env:STM32F103RC_btt.build_flags} -DUSE_USB_COMPOSITE
+lib_deps          = ${env:STM32F103RC_btt.lib_deps}
   USBComposite for STM32F1@==0.91
-lib_ignore        = Adafruit NeoPixel, SPI
-monitor_speed     = 115200
 
 [env:STM32F103RC_btt_512K]
-platform          = ststm32
-board             = genericSTM32F103RC
+platform          = ${common_stm32f1.platform}
+extends           = env:STM32F103RC_btt
 board_upload.maximum_size=524288
-platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512
-build_unflags     = -std=gnu++11
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
-monitor_speed     = 115200
+build_flags       = ${env:STM32F103RC_btt.build_flags} -DSTM32_FLASH_SIZE=512
 
 [env:STM32F103RC_btt_512K_USB]
-platform          = ststm32
-board             = genericSTM32F103RC
-board_upload.maximum_size=524288
-platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512 -DUSE_USB_COMPOSITE
-build_unflags     = -std=gnu++11
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+platform          = ${common_stm32f1.platform}
+extends           = env:STM32F103RC_btt_512K
+build_flags       = ${env:STM32F103RC_btt_512K.build_flags} -DUSE_USB_COMPOSITE
+lib_deps          = ${env:STM32F103RC_btt_512K.lib_deps}
   USBComposite for STM32F1@==0.91
-lib_ignore        = Adafruit NeoPixel, SPI
-monitor_speed     = 115200
 
 #
 # STM32F103RE
 #
 [env:STM32F103RE]
-platform          = ststm32
+platform          = ${common_stm32f1.platform}
+extends           = common_stm32f1
 board             = genericSTM32F103RE
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-build_unflags     = -std=gnu++11
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
 #
@@ -418,37 +386,19 @@ monitor_speed     = 115200
 #   STM32F103RE_btt_USB ......... RET6 (USB mass storage)
 #
 [env:STM32F103RE_btt]
-platform          = ststm32
-board             = genericSTM32F103RE
-platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
-build_unflags     = -std=gnu++11
+platform          = ${common_stm32f1.platform}
+extends           = env:STM32F103RE
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
+build_flags       = ${common_stm32f1.build_flags} -DDEBUG_LEVEL=0 -DSS_TIMER=4
 debug_tool        = stlink
 upload_protocol   = stlink
-monitor_speed     = 115200
 
 [env:STM32F103RE_btt_USB]
-platform          = ststm32
-board             = genericSTM32F103RE
-platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DUSE_USB_COMPOSITE
-build_unflags     = -std=gnu++11
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+platform          = ${common_stm32f1.platform}
+extends           = env:STM32F103RE_btt
+build_flags       = ${env:STM32F103RE_btt.build_flags} -DUSE_USB_COMPOSITE
+lib_deps          = ${common_stm32f1.lib_deps}
   USBComposite for STM32F1@==0.91
-lib_ignore        = Adafruit NeoPixel, SPI
-debug_tool        = stlink
-upload_protocol   = stlink
-monitor_speed     = 115200
 
 #
 # STM32F4 with STM32GENERIC
@@ -488,156 +438,129 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 # Geeetech GTM32 (STM32F103VET6)
 #
 [env:STM32F103VE_GTM32]
-platform        = ststm32
-board           = genericSTM32F103VE
-build_flags     = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -ffunction-sections -fdata-sections -nostdlib -MMD
+platform          = ${common_stm32f1.platform}
+extends           = common_stm32f1
+board             = genericSTM32F103VE
+build_flags       = ${common_stm32f1.build_flags}
+  -ffunction-sections -fdata-sections -nostdlib -MMD
   -DMCU_STM32F103VE -DARDUINO_GENERIC_STM32F103V -DARDUINO_ARCH_STM32F1 -DBOARD_generic_stm32f103v
-  -DDEBUG_LEVEL=DEBUG_NONE -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DVECT_TAB_ADDR=0x8000000 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
-build_unflags = -std=gnu++11
-src_filter      = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore      = Adafruit NeoPixel, SPI
+  -DDEBUG_LEVEL=DEBUG_NONE -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DVECT_TAB_ADDR=0x8000000
+  -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 upload_protocol = serial
 
 #
 # Longer 3D board in Alfawise U20 (STM32F103VET6)
 #
 [env:STM32F103VE_longer]
-platform      = ststm32
+platform      = ${common_stm32f1.platform}
+extends       = common_stm32f1
 board         = genericSTM32F103VE
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DMCU_STM32F103VE -DSTM32F1xx -USERIAL_USB -DU20 -DTS_V12
-build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 extra_scripts = buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI
+build_flags   = ${common_stm32f1.build_flags}
+  -DMCU_STM32F103VE -DSTM32F1xx -USERIAL_USB -DU20 -DTS_V12
+build_unflags = ${common_stm32f1.build_unflags}
+  -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
+lib_ignore    = ${common_stm32f1.lib_ignore}
+  LiquidTWI2
 
 #
 # MKS Robin Mini (STM32F103VET6)
 #
 [env:mks_robin_mini]
-platform      = ststm32
+platform      = ${common_stm32f1.platform}
+extends       = common_stm32f1
 board         = genericSTM32F103VE
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DMCU_STM32F103VE
-build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore    = Adafruit NeoPixel, SPI
+build_flags   = ${common_stm32f1.build_flags}
+  -DMCU_STM32F103VE
 
 #
 # MKS Robin Nano (STM32F103VET6)
 #
 [env:mks_robin_nano]
-platform      = ststm32
+platform      = ${common_stm32f1.platform}
+extends       = common_stm32f1
 board         = genericSTM32F103VE
 platform_packages = tool-stm32duino
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DMCU_STM32F103VE -DHAVE_SW_SERIAL -DSS_TIMER=4
-build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps      = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore    = Adafruit NeoPixel, SPI
+build_flags   = ${common_stm32f1.build_flags}
+  -DMCU_STM32F103VE -DSS_TIMER=4
+
 
 #
 # MKS Robin (STM32F103ZET6)
 #
 [env:mks_robin]
-platform      = ststm32
+platform      = ${common_stm32f1.platform}
+extends       = common_stm32f1
 board         = genericSTM32F103ZE
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_XL_DENSITY
-build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps      = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore    = Adafruit NeoPixel, SPI
+build_flags   = ${common_stm32f1.build_flags}
+  -DSS_TIMER=4 -DSTM32_XL_DENSITY
 
 #
 # MKS Robin Pro (STM32F103ZET6)
 #
 [env:mks_robin_pro]
-platform      = ststm32
-board         = genericSTM32F103ZE
+platform      = ${common_stm32f1.platform}
+extends       = env:mks_robin
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_pro.py
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_XL_DENSITY
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps      = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # MKS Robin E3D (STM32F103RCT6) and
 # MKS Robin E3 with TMC2209
 #
 [env:mks_robin_e3]
-platform          = ststm32
-board             = genericSTM32F103RC
+platform      = ${common_stm32f1.platform}
+extends       = common_stm32f1
+board         = genericSTM32F103RC
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
-build_unflags     = -std=gnu++11
-extra_scripts     = buildroot/share/PlatformIO/scripts/mks_robin_e3.py
-src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_e3.py
+build_flags   = ${common_stm32f1.build_flags}
+  -DDEBUG_LEVEL=0 -DSS_TIMER=4
 
 #
 # MKS Robin Lite/Lite2 (STM32F103RCT6)
 #
 [env:mks_robin_lite]
-platform      = ststm32
+platform      = ${common_stm32f1.platform}
+extends       = common_stm32f1
 board         = genericSTM32F103RC
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite.py
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore    = Adafruit NeoPixel, SPI
+
 
 #
 # MKS ROBIN LITE3 (STM32F103RCT6)
 #
 [env:mks_robin_lite3]
-platform      = ststm32
+platform      = ${common_stm32f1.platform}
+extends       = common_stm32f1
 board         = genericSTM32F103RC
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite3.py
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # JGAurora A5S A1 (STM32F103ZET6)
 #
 [env:jgaurora_a5s_a1]
-platform      = ststm32
+platform      = ${common_stm32f1.platform}
+extends       = common_stm32f1
 board         = genericSTM32F103ZE
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -DSTM32F1xx -std=gnu++14 -DSTM32_XL_DENSITY
-build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore    = Adafruit NeoPixel, SPI
+build_flags   = ${common_stm32f1.build_flags}
+  -DSTM32F1xx -DSTM32_XL_DENSITY
 
 #
 # Malyan M200 (STM32F103CB)
 #
 [env:STM32F103CB_malyan]
-platform    = ststm32
-board       = malyanM200
-build_flags = !python Marlin/src/HAL/STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
-  -DDEBUG_LEVEL=0 -D__MARLIN_FIRMWARE__
-src_filter  = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-HAL, SPI
+platform      = ${common_stm32f1.platform}
+extends       = common_stm32f1
+board         = malyanM200
+build_flags   = ${common_stm32f1.build_flags}
+  -DMCU_STM32F103CB -D__STM32F1__=1 -std=c++1y -DSERIAL_USB -ffunction-sections -fdata-sections
+  -Wl,--gc-sections -DDEBUG_LEVEL=0 -D__MARLIN_FIRMWARE__
+lib_ignore    = ${common_stm32f1.lib_ignore}
+  LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SoftwareSerialM
 
 #
 # Malyan M200 v2 (STM32F070RB)
@@ -669,14 +592,14 @@ lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-H
 # Chitu boards like Tronxy X5s (STM32F103ZET6)
 #
 [env:chitu_f103]
-platform      = ststm32
+platform      = ${common_stm32f1.platform}
+extends       = common_stm32f1
 board         = genericSTM32F103ZE
-build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -DSTM32F1xx -std=gnu++14 -DSTM32_XL_DENSITY
-build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG= -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore    = Adafruit NeoPixel
+build_flags   = ${common_stm32f1.build_flags}
+  -DSTM32F1xx -DSTM32_XL_DENSITY
+build_unflags = ${common_stm32f1.build_unflags}
+  -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG= -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 
 #
 # STM32F401VE

commit 7d7f58c3e3e2ddb633ea81e67aa55ed7ac646d84
Author: grauerfuchs <42082416+grauerfuchs@users.noreply.github.com>
Date:   Mon May 25 17:24:50 2020 -0400

    Fix Mightyboard PIO env (#18098)

diff --git a/platformio.ini b/platformio.ini
index 413b5201da..9d7da43fba 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -86,6 +86,7 @@ board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
+upload_speed      = 57600
 
 #
 # MightyBoard ATmega2560 (MegaCore 100 pin boards variants)
@@ -97,6 +98,9 @@ board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
+upload_protocol   = wiring
+upload_speed      = 57600
+board_upload.maximum_size = 253952
 
 #
 # RAMBo

commit a06a0c5b88edb923db5b45414226ad20fdcfda1d
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon May 11 23:56:44 2020 -0500

    Fix SKR/GTR PeripheralPins.c (#17937)
    
    * Add a separate GTR board/variant.
    * Revert SKR Pro MOSI (before 248b7dfa59).

diff --git a/platformio.ini b/platformio.ini
index 81855b3030..413b5201da 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -777,7 +777,7 @@ debug_init_break  =
 [env:BIGTREE_GTR_V1_0]
 platform          = ststm32@>=5.7.0
 platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
-board             = BigTree_SKR_Pro
+board             = BigTree_GTR_v1
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407IG\"

commit 9d545f1231cd8405dce65eba04c461e205f814b7
Author: Eric Ptak <trouch@trouch.com>
Date:   Mon May 11 08:07:19 2020 +0200

    Fysetc S6 direct DFU upload (#17943)

diff --git a/platformio.ini b/platformio.ini
index aca4b55297..81855b3030 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -729,8 +729,8 @@ extra_scripts     = pre:buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 lib_ignore        = Arduino-L6470, SoftwareSerial
 debug_tool        = stlink
-#upload_protocol   = stlink
-upload_protocol   = serial
+upload_protocol   = dfu
+upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
 
 #
 # STM32F407VET6 with RAMPS-like shield

commit 8d3caa9944da8990b07494974fe0ab710c321dd1
Author: Jason Smith <jason.inet@gmail.com>
Date:   Sun May 10 01:08:01 2020 -0700

    Newer TMCStepper better for LPC176x (#17934)

diff --git a/platformio.ini b/platformio.ini
index 99d1a46303..aca4b55297 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -266,7 +266,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
 lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  TMCStepper@>=0.6.1,<1.0.0
+  TMCStepper@>=0.6.2
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/release.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 
@@ -284,7 +284,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
 lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  TMCStepper@>=0.6.1,<1.0.0
+  TMCStepper@>=0.6.2
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/release.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 

commit ba9a9bbe587f21e4bfa3552aa504a16213b6c28f
Author: Jason Smith <jason.inet@gmail.com>
Date:   Sat May 9 23:49:30 2020 -0700

    Normalize HAL/STM32 targets (#17904)

diff --git a/platformio.ini b/platformio.ini
index 1dbb9a6817..99d1a46303 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -21,6 +21,7 @@ boards_dir   = buildroot/share/PlatformIO/boards
 default_envs = mega2560
 
 [common]
+arduinoststm32_ver = >=4.10700,<4.10800
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
 build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
@@ -470,6 +471,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/ST
 #
 [env:ARMED]
 platform      = ststm32
+platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board         = armed_v1
 build_flags   = ${common.build_flags}
   -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DUSBD_USE_CDC
@@ -638,12 +640,14 @@ lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-H
 #
 [env:STM32F070RB_malyan]
 platform    = ststm32
+platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board       = malyanM200v2
 build_flags = -DSTM32F0xx -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED
   -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
+  -DCUSTOM_STARTUP_FILE
   -IMarlin/src/HAL/STM32
 src_filter  = ${common.default_src_filter} +<src/HAL/STM32>
-lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-HAL
+lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-HAL, SoftwareSerial
 
 #
 # Malyan M300 (STM32F070CB)
@@ -676,8 +680,8 @@ lib_ignore    = Adafruit NeoPixel
 #
 [env:STM32F401VE_STEVAL]
 platform          = ststm32
+platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = STEVAL_STM32F401VE
-platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
   -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STEVAL_F401VE\"
@@ -694,15 +698,15 @@ src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 #
 [env:FLYF407ZG]
 platform          = ststm32
+platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = FLYF407ZG
-platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
   -DSTM32F4 -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x8000
   -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
+lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 
@@ -711,10 +715,10 @@ src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 #
 [env:FYSETC_S6]
 platform          = ststm32
-board             = fysetc_s6
 platform_packages =
    tool-stm32duino
-   framework-arduinoststm32@>=3.10700,<4
+   framework-arduinoststm32@${common.arduinoststm32_ver}
+board             = fysetc_s6
 build_flags       = ${common.build_flags}
   -DTARGET_STM32F4 -std=gnu++14
   -DVECT_TAB_OFFSET=0x10000
@@ -735,8 +739,8 @@ upload_protocol   = serial
 #
 [env:STM32F407VE_black]
 platform          = ststm32
+platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = blackSTM32F407VET6
-platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
   -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
@@ -752,8 +756,8 @@ src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 #
 [env:BIGTREE_SKR_PRO]
 platform          = ststm32
+platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = BigTree_SKR_Pro
-platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
@@ -772,7 +776,7 @@ debug_init_break  =
 #
 [env:BIGTREE_GTR_V1_0]
 platform          = ststm32@>=5.7.0
-platform_packages = framework-arduinoststm32@>=3.10700,<4
+platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = BigTree_SKR_Pro
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags       = ${common.build_flags}
@@ -794,8 +798,8 @@ src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 #
 [env:BIGTREE_BTT002]
 platform          = ststm32@5.6.0
+platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board             = BigTree_Btt002
-platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407VG\"
   -DTARGET_STM32F4 -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
@@ -883,6 +887,7 @@ debug_tool     = jlink
 #
 [env:rumba32_f446ve]
 platform      = ststm32
+platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board         = rumba32_f446ve
 build_flags   = ${common.build_flags}
   -DSTM32F4xx
@@ -899,7 +904,8 @@ build_flags   = ${common.build_flags}
   -DDISABLE_GENERIC_SERIALUSB
   -DHAL_UART_MODULE_ENABLED
   -Os
-lib_ignore    = Adafruit NeoPixel
+  -IMarlin/src/HAL/STM32
+lib_ignore    = Adafruit NeoPixel, SoftwareSerial
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 monitor_speed = 500000
 upload_protocol = dfu
@@ -909,6 +915,7 @@ upload_protocol = dfu
 #
 [env:rumba32_mks]
 platform      = ststm32
+platform_packages = framework-arduinoststm32@${common.arduinoststm32_ver}
 board         = rumba32_f446ve
 build_flags   = ${common.build_flags}
   -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
@@ -920,8 +927,9 @@ build_flags   = ${common.build_flags}
   -DDISABLE_GENERIC_SERIALUSB
   -DHAL_UART_MODULE_ENABLED
   -Os
-lib_ignore    = Adafruit NeoPixel
-src_filter    = ${common.default_src_filter} +<src/HAL/STM32> +<src/HAL/STM32_F4_F7> -<src/HAL/STM32_F4_F7/STM32F7>
+  -IMarlin/src/HAL/STM32
+lib_ignore    = Adafruit NeoPixel, SoftwareSerial
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 upload_protocol = dfu
 
 #

commit 703e97b7af7da222c8d6a301600712678ea2d187
Author: Jason Smith <jason.inet@gmail.com>
Date:   Thu May 7 23:19:28 2020 -0700

    Support TMCStepper with MKS Robin Pro (#17908)

diff --git a/platformio.ini b/platformio.ini
index a2c587ebc9..1dbb9a6817 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -558,11 +558,12 @@ platform      = ststm32
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_pro.py
 build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY
+  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_XL_DENSITY
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, SPI, TMCStepper
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # MKS Robin E3D (STM32F103RCT6) and

commit 2acdd2fadc0fda6e53ea70957273c7c0f1c931a3
Author: Axel <ansepulveda@uc.cl>
Date:   Tue May 5 03:25:22 2020 -0400

    Add Mightyboard Mega env (#17861)

diff --git a/platformio.ini b/platformio.ini
index 9f77af1afc..a2c587ebc9 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -75,6 +75,28 @@ lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
 
+#
+# MightyBoard ATmega2560 (MegaCore 100 pin boards variants)
+#
+[env:MightyBoard1280]
+platform          = atmelavr
+board             = ATmega1280
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
+
+#
+# MightyBoard ATmega2560 (MegaCore 100 pin boards variants)
+#
+[env:MightyBoard2560]
+platform          = atmelavr
+board             = ATmega2560
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
+
 #
 # RAMBo
 #

commit 0080305fa6b81340f30e7b05068c68def6136199
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Mon May 4 17:41:41 2020 -0500

    Tweaks to platformio.ini

diff --git a/platformio.ini b/platformio.ini
index 163c6b7419..9f77af1afc 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -629,8 +629,8 @@ lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-H
 platform    = ststm32@>=6.1.0
 board       = malyanm300_f070cb
 build_flags = ${common.build_flags}
-    -DUSBCON -DUSBD_VID=0x0483 "-DUSB_MANUFACTURER=\"Unknown\"" "-DUSB_PRODUCT=\"MALYAN_M300\""
-    -DHAL_PCD_MODULE_ENABLED -DUSBD_USE_CDC -DDISABLE_GENERIC_SERIALUSB -DHAL_UART_MODULE_ENABLED
+  -DUSBCON -DUSBD_VID=0x0483 "-DUSB_MANUFACTURER=\"Unknown\"" "-DUSB_PRODUCT=\"MALYAN_M300\""
+  -DHAL_PCD_MODULE_ENABLED -DUSBD_USE_CDC -DDISABLE_GENERIC_SERIALUSB -DHAL_UART_MODULE_ENABLED
 src_filter  = ${common.default_src_filter} +<src/HAL/STM32>
 lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-HAL
 
@@ -656,10 +656,10 @@ platform          = ststm32
 board             = STEVAL_STM32F401VE
 platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
- -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
- -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STEVAL_F401VE\"
- -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
- -IMarlin/src/HAL/STM32
+  -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
+  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STEVAL_F401VE\"
+  -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+  -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/STEVAL__F401XX.py
@@ -715,10 +715,10 @@ platform          = ststm32
 board             = blackSTM32F407VET6
 platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
- -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
- -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
- -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
- -IMarlin/src/HAL/STM32
+  -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
+  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
+  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+  -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
@@ -749,7 +749,6 @@ debug_init_break  =
 #
 [env:BIGTREE_GTR_V1_0]
 platform          = ststm32@>=5.7.0
-framework         = arduino
 platform_packages = framework-arduinoststm32@>=3.10700,<4
 board             = BigTree_SKR_Pro
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
@@ -766,7 +765,6 @@ lib_deps          =
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
 lib_ignore        = SoftwareSerial, SoftwareSerialM
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
-monitor_speed     = 250000
 
 #
 # BigTreeTech BTT002 V1.0 (STM32F407VGT6 ARM Cortex-M4)
@@ -890,8 +888,8 @@ upload_protocol = dfu
 platform      = ststm32
 board         = rumba32_f446ve
 build_flags   = ${common.build_flags}
- -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
- -DSTM32F446xx -DUSBCON -DUSBD_VID=0x8000
+  -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
+  -DSTM32F446xx -DUSBCON -DUSBD_VID=0x8000
   "-DUSB_MANUFACTURER=\"Unknown\""
   "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
   -DHAL_PCD_MODULE_ENABLED

commit 38d1587091ba7b7258a194f6ad950e80c1490225
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon May 4 14:37:43 2020 -0500

    Malyan M200 V2 (#17840)

diff --git a/platformio.ini b/platformio.ini
index 36d943d670..163c6b7419 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -605,10 +605,22 @@ lib_ignore    = Adafruit NeoPixel, SPI
 [env:STM32F103CB_malyan]
 platform    = ststm32
 board       = malyanM200
-build_flags = !python Marlin/src/HAL/STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
+build_flags = !python Marlin/src/HAL/STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
   -DDEBUG_LEVEL=0 -D__MARLIN_FIRMWARE__
 src_filter  = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SPI
+lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-HAL, SPI
+
+#
+# Malyan M200 v2 (STM32F070RB)
+#
+[env:STM32F070RB_malyan]
+platform    = ststm32
+board       = malyanM200v2
+build_flags = -DSTM32F0xx -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED
+  -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
+  -IMarlin/src/HAL/STM32
+src_filter  = ${common.default_src_filter} +<src/HAL/STM32>
+lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-HAL
 
 #
 # Malyan M300 (STM32F070CB)
@@ -620,7 +632,7 @@ build_flags = ${common.build_flags}
     -DUSBCON -DUSBD_VID=0x0483 "-DUSB_MANUFACTURER=\"Unknown\"" "-DUSB_PRODUCT=\"MALYAN_M300\""
     -DHAL_PCD_MODULE_ENABLED -DUSBD_USE_CDC -DDISABLE_GENERIC_SERIALUSB -DHAL_UART_MODULE_ENABLED
 src_filter  = ${common.default_src_filter} +<src/HAL/STM32>
-lib_ignore  = U8glib, LiquidCrystal_I2C, LiquidCrystal, NewliquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, Servo(STM32F1), TMC26XStepper, U8glib-HAL
+lib_ignore  = LiquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, U8glib-HAL
 
 #
 # Chitu boards like Tronxy X5s (STM32F103ZET6)

commit 714df3001ae3130ecf1bd639a6d5707fc3e08959
Author: MigueKun <37217942+kunpoolsion@users.noreply.github.com>
Date:   Mon May 4 20:59:22 2020 +0200

    Fix Fysetc S6 PIO env (#17865)

diff --git a/platformio.ini b/platformio.ini
index dad4beb143..36d943d670 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -684,10 +684,11 @@ build_flags       = ${common.build_flags}
   -DTARGET_STM32F4 -std=gnu++14
   -DVECT_TAB_OFFSET=0x10000
   -DUSBCON -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED -DUSBD_VID=0x0483 '-DUSB_PRODUCT="FYSETC_S6"'
+  -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
-lib_ignore        = Arduino-L6470
+lib_ignore        = Arduino-L6470, SoftwareSerial
 debug_tool        = stlink
 #upload_protocol   = stlink
 upload_protocol   = serial

commit 208af8cb15ca35190845efdca171f83915a294fa
Author: Jason Smith <jason.inet@gmail.com>
Date:   Sat May 2 15:24:51 2020 -0700

    Fix STM32 + SoftwareSerial compile (#17831)

diff --git a/platformio.ini b/platformio.ini
index 9a6dbad1f1..dad4beb143 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -769,9 +769,10 @@ build_flags       = ${common.build_flags}
   -DHAVE_HWSERIAL3
   -DPIN_SERIAL2_RX=PD_6
   -DPIN_SERIAL2_TX=PD_5
+  -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster
+lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 #

commit 33bb7859d446a42d699761f6b5c0a449b40a7d35
Author: Bob Kuhn <bob.kuhn@att.net>
Date:   Wed Apr 22 15:00:10 2020 -0500

    Composite USB for STM32 SDIO (experimental) (#17222)

diff --git a/platformio.ini b/platformio.ini
index d4c56876fc..9a6dbad1f1 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -646,7 +646,7 @@ platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
  -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STEVAL_F401VE\"
- -DDISABLE_GENERIC_SERIALUSB
+ -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
  -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
@@ -704,7 +704,8 @@ platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
  -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
-  -IMarlin/src/HAL/STM32
+ -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+ -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial

commit f94ab84dac095ad57c9a465712ce66e625f303ff
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Apr 17 09:10:41 2020 -0500

    Malyan M300 support (#17421)

diff --git a/platformio.ini b/platformio.ini
index 0828170e44..d4c56876fc 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -610,6 +610,18 @@ build_flags = !python Marlin/src/HAL/STM32F1/build_flags.py -DMCU_STM32F103CB -D
 src_filter  = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SPI
 
+#
+# Malyan M300 (STM32F070CB)
+#
+[env:malyan_M300]
+platform    = ststm32@>=6.1.0
+board       = malyanm300_f070cb
+build_flags = ${common.build_flags}
+    -DUSBCON -DUSBD_VID=0x0483 "-DUSB_MANUFACTURER=\"Unknown\"" "-DUSB_PRODUCT=\"MALYAN_M300\""
+    -DHAL_PCD_MODULE_ENABLED -DUSBD_USE_CDC -DDISABLE_GENERIC_SERIALUSB -DHAL_UART_MODULE_ENABLED
+src_filter  = ${common.default_src_filter} +<src/HAL/STM32>
+lib_ignore  = U8glib, LiquidCrystal_I2C, LiquidCrystal, NewliquidCrystal, LiquidTWI2, Adafruit NeoPixel, TMCStepper, Servo(STM32F1), TMC26XStepper, U8glib-HAL
+
 #
 # Chitu boards like Tronxy X5s (STM32F103ZET6)
 #

commit 847ea583f624328f9fcc97d1354f5c2bcb991960
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Thu Apr 16 15:34:44 2020 -0500

    STM32F103VE has 512K Flash EEPROM (#17565)

diff --git a/platformio.ini b/platformio.ini
index aab3198bfd..0828170e44 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -463,9 +463,9 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 platform        = ststm32
 board           = genericSTM32F103VE
 build_flags     = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=DEBUG_NONE -std=gnu++14 -MMD -ffunction-sections -fdata-sections -nostdlib
-  -DBOARD_generic_stm32f103v -DARDUINO_GENERIC_STM32F103V -DARDUINO_ARCH_STM32F1
-  -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DVECT_TAB_ADDR=0x8000000 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
+  ${common.build_flags} -std=gnu++14 -ffunction-sections -fdata-sections -nostdlib -MMD
+  -DMCU_STM32F103VE -DARDUINO_GENERIC_STM32F103V -DARDUINO_ARCH_STM32F1 -DBOARD_generic_stm32f103v
+  -DDEBUG_LEVEL=DEBUG_NONE -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DVECT_TAB_ADDR=0x8000000 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 build_unflags = -std=gnu++11
 src_filter      = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore      = Adafruit NeoPixel, SPI
@@ -478,8 +478,7 @@ upload_protocol = serial
 platform      = ststm32
 board         = genericSTM32F103VE
 build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -USERIAL_USB
-  -DSTM32F1xx -DU20 -DTS_V12
+  ${common.build_flags} -std=gnu++14 -DMCU_STM32F103VE -DSTM32F1xx -USERIAL_USB -DU20 -DTS_V12
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 extra_scripts = buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
@@ -492,7 +491,7 @@ lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI
 platform      = ststm32
 board         = genericSTM32F103VE
 build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
+  ${common.build_flags} -std=gnu++14 -DMCU_STM32F103VE
 build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
@@ -506,7 +505,7 @@ platform      = ststm32
 board         = genericSTM32F103VE
 platform_packages = tool-stm32duino
 build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
+  ${common.build_flags} -std=gnu++14 -DMCU_STM32F103VE -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>

commit 7d0ea3e2c46698942c7262dfdd003128013f49a6
Author: Jason Smith <jason.inet@gmail.com>
Date:   Thu Apr 16 01:43:32 2020 -0700

    Fix framework-arduinoststm32 minimum version (#17512)

diff --git a/platformio.ini b/platformio.ini
index 63df14cf63..aab3198bfd 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -631,7 +631,7 @@ lib_ignore    = Adafruit NeoPixel
 [env:STM32F401VE_STEVAL]
 platform          = ststm32
 board             = STEVAL_STM32F401VE
-platform_packages = framework-arduinoststm32@>=3.107,<4
+platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
  -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STEVAL_F401VE\"
@@ -649,7 +649,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 [env:FLYF407ZG]
 platform          = ststm32
 board             = FLYF407ZG
-platform_packages = framework-arduinoststm32@>=3.107,<4
+platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
   -DSTM32F4 -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x8000
@@ -668,7 +668,7 @@ platform          = ststm32
 board             = fysetc_s6
 platform_packages =
    tool-stm32duino
-   framework-arduinoststm32@>=3.107,<4
+   framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
   -DTARGET_STM32F4 -std=gnu++14
   -DVECT_TAB_OFFSET=0x10000
@@ -689,7 +689,7 @@ upload_protocol   = serial
 [env:STM32F407VE_black]
 platform          = ststm32
 board             = blackSTM32F407VET6
-platform_packages = framework-arduinoststm32@>=3.107,<4
+platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
  -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
@@ -705,7 +705,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 [env:BIGTREE_SKR_PRO]
 platform          = ststm32
 board             = BigTree_SKR_Pro
-platform_packages = framework-arduinoststm32@>=3.107,<4
+platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
@@ -725,7 +725,7 @@ debug_init_break  =
 [env:BIGTREE_GTR_V1_0]
 platform          = ststm32@>=5.7.0
 framework         = arduino
-platform_packages = framework-arduinoststm32@>=3.107,<4
+platform_packages = framework-arduinoststm32@>=3.10700,<4
 board             = BigTree_SKR_Pro
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags       = ${common.build_flags}
@@ -749,7 +749,7 @@ monitor_speed     = 250000
 [env:BIGTREE_BTT002]
 platform          = ststm32@5.6.0
 board             = BigTree_Btt002
-platform_packages = framework-arduinoststm32@>=3.107,<4
+platform_packages = framework-arduinoststm32@>=3.10700,<4
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407VG\"
   -DTARGET_STM32F4 -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000

commit bc856fd8ec5a157e1d58b5afee25418a8fa0a0fb
Author: mks-viva <1224833100@qq.com>
Date:   Thu Apr 16 14:19:24 2020 +0800

    MKS Robin E3 / E3D support (#17569)
    
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/platformio.ini b/platformio.ini
index 38e3065f20..63df14cf63 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -543,6 +543,23 @@ src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, SPI, TMCStepper
 
+#
+# MKS Robin E3D (STM32F103RCT6) and
+# MKS Robin E3 with TMC2209
+#
+[env:mks_robin_e3]
+platform          = ststm32
+board             = genericSTM32F103RC
+platform_packages = tool-stm32duino
+build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
+build_unflags     = -std=gnu++11
+extra_scripts     = buildroot/share/PlatformIO/scripts/mks_robin_e3.py
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
+
 #
 # MKS Robin Lite/Lite2 (STM32F103RCT6)
 #

commit a97ae51cc7d3fa4b8fa1180d71023964e495b304
Author: Ryan <allted@gmail.com>
Date:   Sat Apr 11 18:39:02 2020 -0700

    Archim: PIO upload on Windows, Arduino IDE LCD (#17405)
    
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/platformio.ini b/platformio.ini
index d072ae4cc9..38e3065f20 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -214,6 +214,7 @@ board         = due
 src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
 build_flags   = ${common.build_flags}
   -DARDUINO_SAM_ARCHIM -DARDUINO_ARCH_SAM -D__SAM3X8E__ -DUSBCON
+extra_scripts = Marlin/src/HAL/DUE/upload_extra_script.py
 
 [env:DUE_archim_debug]
 # Used when WATCHDOG_RESET_MANUAL is enabled
@@ -223,6 +224,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
 build_flags   = ${common.build_flags}
   -DARDUINO_SAM_ARCHIM -DARDUINO_ARCH_SAM -D__SAM3X8E__ -DUSBCON
   -funwind-tables -mpoke-function-name
+extra_scripts = Marlin/src/HAL/DUE/upload_extra_script.py
 
 #
 # NXP LPC176x ARM Cortex-M3

commit 397fa59eee70290dd0f0b16227f3f34ad75f42cf
Author: Gustavo Alvarez <462213+sl1pkn07@users.noreply.github.com>
Date:   Thu Apr 9 22:58:45 2020 +0200

    Sort out USBComposite for STM32F1 confusion (#17400)

diff --git a/platformio.ini b/platformio.ini
index 2ba1c5c1f3..d072ae4cc9 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -319,7 +319,6 @@ extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-  USBComposite for STM32F1@==0.91
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
@@ -350,7 +349,6 @@ extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-  USBComposite for STM32F1@==0.91
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
@@ -417,6 +415,7 @@ extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  USBComposite for STM32F1@==0.91
 lib_ignore        = Adafruit NeoPixel, SPI
 debug_tool        = stlink
 upload_protocol   = stlink

commit 293a0997c9a7a84de37018581c1ccc6ef454c298
Author: grauerfuchs <42082416+grauerfuchs@users.noreply.github.com>
Date:   Wed Apr 8 13:53:28 2020 -0400

    Fix / optimize PCA9533 LED (Mightyboard) (#17381)

diff --git a/platformio.ini b/platformio.ini
index f7fb31ec2e..2ba1c5c1f3 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -33,7 +33,6 @@ lib_deps =
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/0.8.0.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
-  SailfishRGB_LED=https://github.com/mikeshub/SailfishRGB_LED/archive/master.zip
   SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
 
 # Globally defined properties
@@ -623,7 +622,7 @@ build_flags       = ${common.build_flags}
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/STEVAL__F401XX.py
-lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
+lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
@@ -639,7 +638,7 @@ build_flags       = ${common.build_flags}
   -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
+lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 
@@ -679,7 +678,7 @@ build_flags       = ${common.build_flags}
   -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
+lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SlowSoftI2CMaster, SoftwareSerial
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
@@ -742,7 +741,7 @@ build_flags       = ${common.build_flags}
   -DPIN_SERIAL2_TX=PD_5
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_ignore        = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+lib_ignore        = Adafruit NeoPixel, SailfishLCD, SlowSoftI2CMaster
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
@@ -780,7 +779,7 @@ lib_deps      = ${common.lib_deps}
   ESP3DLib=https://github.com/luc-github/ESP3DLib.git
   arduinoWebSockets=https://github.com/Links2004/arduinoWebSockets.git
   ESP32SSDP=https://github.com/luc-github/ESP32SSDP.git
-lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED, ESPAsyncTCP
+lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, ESPAsyncTCP
 src_filter    = ${common.default_src_filter} +<src/HAL/ESP32>
 upload_speed  = 115200
 #upload_port   = marlinesp.local

commit 966e0e4a77f6f62a173a2b08de73c25512b40072
Author: thisiskeithb <13375512+thisiskeithb@users.noreply.github.com>
Date:   Mon Apr 6 13:51:09 2020 -0700

    BTT002 release V1 uses STM32F407VGT6 (#17387)

diff --git a/platformio.ini b/platformio.ini
index bf3dea01bc..f7fb31ec2e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -727,14 +727,14 @@ src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 monitor_speed     = 250000
 
 #
-# BigTreeTech BTT002 (STM32F407VET6 ARM Cortex-M4)
+# BigTreeTech BTT002 V1.0 (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
 platform          = ststm32@5.6.0
 board             = BigTree_Btt002
 platform_packages = framework-arduinoststm32@>=3.107,<4
 build_flags       = ${common.build_flags}
-  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407VE\"
+  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407VG\"
   -DTARGET_STM32F4 -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DHAVE_HWSERIAL2
   -DHAVE_HWSERIAL3

commit 723d4d6f610e922dbdc56e7f4f69e4a15ebb0fc8
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Apr 4 02:18:01 2020 -0500

    Fix Archim 2 build for PIO

diff --git a/platformio.ini b/platformio.ini
index 4e801713a0..bf3dea01bc 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -206,6 +206,25 @@ build_flags   = ${common.build_flags}
   -funwind-tables
   -mpoke-function-name
 
+#
+# Archim SAM
+#
+[env:DUE_archim]
+platform      = atmelsam
+board         = due
+src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
+build_flags   = ${common.build_flags}
+  -DARDUINO_SAM_ARCHIM -DARDUINO_ARCH_SAM -D__SAM3X8E__ -DUSBCON
+
+[env:DUE_archim_debug]
+# Used when WATCHDOG_RESET_MANUAL is enabled
+platform      = atmelsam
+board         = due
+src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
+build_flags   = ${common.build_flags}
+  -DARDUINO_SAM_ARCHIM -DARDUINO_ARCH_SAM -D__SAM3X8E__ -DUSBCON
+  -funwind-tables -mpoke-function-name
+
 #
 # NXP LPC176x ARM Cortex-M3
 #

commit add34aa286bbcbd081aff4a25055505759f3e9f1
Author: thisiskeithb <thisiskeithb@outlook.com>
Date:   Sat Mar 28 06:49:59 2020 -0700

    Fix STM32F1 USB Composite Dependency
    
    Co-authored-by: Lord-Quake <Lord-Quake@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index 13808d299a..4e801713a0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -301,7 +301,7 @@ extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-  USBComposite_stm32f1@==0.91
+  USBComposite for STM32F1@==0.91
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
@@ -316,7 +316,7 @@ extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-  USBComposite_stm32f1@==0.91
+  USBComposite for STM32F1@==0.91
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
@@ -332,7 +332,7 @@ extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-  USBComposite_stm32f1@==0.91
+  USBComposite for STM32F1@==0.91
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
@@ -348,7 +348,7 @@ extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-  USBComposite_stm32f1@==0.91
+  USBComposite for STM32F1@==0.91
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 

commit 129b270628781eae776764e63fd514553e6c2204
Author: Giuliano Zaro <3684609+GMagician@users.noreply.github.com>
Date:   Fri Mar 27 23:29:17 2020 +0100

    QSPI EEPROM for SAMD51 (#17292)

diff --git a/platformio.ini b/platformio.ini
index 2f3e86c316..13808d299a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -792,6 +792,7 @@ build_unflags  = -std=gnu++11
 src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
 lib_deps       = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  Adafruit_SPIFlash=https://github.com/adafruit/Adafruit_SPIFlash/archive/master.zip
 debug_tool     = jlink
 
 #

commit 7455bb09b348c5126d651200f0fae9d00d78cc39
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue Mar 24 16:14:30 2020 -0500

    Add SoftwareSerialM for MKS Robin (#17207)

diff --git a/platformio.ini b/platformio.ini
index 62582e1d93..2f3e86c316 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -491,7 +491,7 @@ build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
 build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
-lib_deps = ${common.lib_deps}
+lib_deps      = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore    = Adafruit NeoPixel, SPI
 
@@ -502,10 +502,12 @@ lib_ignore    = Adafruit NeoPixel, SPI
 platform      = ststm32
 board         = genericSTM32F103ZE
 build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY
+  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_XL_DENSITY
 build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
+lib_deps      = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore    = Adafruit NeoPixel, SPI
 
 #

commit 1674df00b14009e7c3c2daa5c8585cabe3fc7fc4
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Mar 21 18:15:37 2020 -0500

    Stay at v0.91 of USBComposite for STM32F1

diff --git a/platformio.ini b/platformio.ini
index 39885b0cd3..62582e1d93 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -301,6 +301,7 @@ extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  USBComposite_stm32f1@==0.91
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
@@ -315,6 +316,7 @@ extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  USBComposite_stm32f1@==0.91
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
@@ -330,6 +332,7 @@ extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  USBComposite_stm32f1@==0.91
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
@@ -345,6 +348,7 @@ extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+  USBComposite_stm32f1@==0.91
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 

commit 6bead0c1b04152f6a291d851f6cd4029fe0fc616
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Mar 13 16:29:29 2020 -0500

    Shorter paths to HAL, ExtUI (#17156)

diff --git a/platformio.ini b/platformio.ini
index 943889c7d5..39885b0cd3 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -63,7 +63,7 @@ board             = megaatmega2560
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # ATmega1280
@@ -74,7 +74,7 @@ board             = megaatmega1280
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # RAMBo
@@ -85,7 +85,7 @@ board             = reprap_rambo
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # FYSETC F6 V1.3
@@ -96,7 +96,7 @@ board             = fysetc_f6_13
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # FYSETC F6 V1.4
@@ -107,7 +107,7 @@ board             = fysetc_f6_14
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter        = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # Sanguinololu (ATmega644p)
@@ -117,7 +117,7 @@ platform      = atmelavr
 board         = sanguino_atmega644p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # Sanguinololu (ATmega1284p)
@@ -127,7 +127,7 @@ platform      = atmelavr
 board         = sanguino_atmega1284p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # Melzi and clones (ATmega1284p)
@@ -137,7 +137,7 @@ platform      = atmelavr
 board         = sanguino_atmega1284p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
 lib_ignore    = TMCStepper
 upload_speed  = 57600
 
@@ -149,7 +149,7 @@ platform      = atmelavr
 board         = sanguino_atmega1284p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
 lib_ignore    = TMCStepper
 upload_speed  = 115200
 
@@ -166,7 +166,7 @@ board         = at90usb1286
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 lib_ignore    = TMCStepper
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # AT90USB1286 boards using DFU bootloader
@@ -179,7 +179,7 @@ platform      = teensy
 board         = at90usb1286
 lib_deps      = ${common.lib_deps}
 lib_ignore    = TMCStepper
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter    = ${common.default_src_filter} +<src/HAL/AVR>
 
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
@@ -190,18 +190,18 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 [env:DUE]
 platform      = atmelsam
 board         = due
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
+src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
 
 [env:DUE_USB]
 platform      = atmelsam
 board         = dueUSB
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
+src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
 
 [env:DUE_debug]
 # Used when WATCHDOG_RESET_MANUAL is enabled
 platform      = atmelsam
 board         = due
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
+src_filter    = ${common.default_src_filter} +<src/HAL/DUE>
 build_flags   = ${common.build_flags}
   -funwind-tables
   -mpoke-function-name
@@ -212,14 +212,14 @@ build_flags   = ${common.build_flags}
 [env:LPC1768]
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.2.zip
 board             = nxp_lpc1768
-build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
+build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g ${common.build_flags}
 # debug options for backtrace
 #  -funwind-tables
 #  -mpoke-function-name
 lib_ldf_mode      = off
 lib_compat_mode   = strict
-extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
+extra_scripts     = Marlin/src/HAL/LPC1768/upload_extra_script.py
+src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
 lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
@@ -230,14 +230,14 @@ lib_deps          = Servo
 [env:LPC1769]
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.2.zip
 board             = nxp_lpc1769
-build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
+build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/LPC1768/include -IMarlin/src/HAL/LPC1768/u8g ${common.build_flags}
 # debug options for backtrace
 #  -funwind-tables
 #  -mpoke-function-name
 lib_ldf_mode      = off
 lib_compat_mode   = strict
-extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
+extra_scripts     = Marlin/src/HAL/LPC1768/upload_extra_script.py
+src_filter        = ${common.default_src_filter} +<src/HAL/LPC1768>
 lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
@@ -252,10 +252,10 @@ lib_deps          = Servo
 platform          = ststm32
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
 build_unflags     = -std=gnu++11
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore        = Adafruit NeoPixel, SPI
@@ -269,11 +269,11 @@ platform          = ststm32
 board             = genericSTM32F103RC
 #board_build.core = maple
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DDEBUG_LEVEL=0 -DHAVE_SW_SERIAL
 build_unflags     = -std=gnu++11
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_fysetc.py
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore        = Adafruit NeoPixel, SPI
@@ -294,11 +294,11 @@ upload_protocol   = serial
 platform          = ststm32
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags     = -std=gnu++11
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore        = Adafruit NeoPixel, SPI
@@ -308,11 +308,11 @@ monitor_speed     = 115200
 platform          = ststm32
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DUSE_USB_COMPOSITE
 build_unflags     = -std=gnu++11
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore        = Adafruit NeoPixel, SPI
@@ -323,11 +323,11 @@ platform          = ststm32
 board             = genericSTM32F103RC
 board_upload.maximum_size=524288
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512
 build_unflags     = -std=gnu++11
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore        = Adafruit NeoPixel, SPI
@@ -338,11 +338,11 @@ platform          = ststm32
 board             = genericSTM32F103RC
 board_upload.maximum_size=524288
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512 -DUSE_USB_COMPOSITE
 build_unflags     = -std=gnu++11
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore        = Adafruit NeoPixel, SPI
@@ -355,10 +355,10 @@ monitor_speed     = 115200
 platform          = ststm32
 board             = genericSTM32F103RE
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
 build_unflags     = -std=gnu++11
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore        = Adafruit NeoPixel, SPI
@@ -372,11 +372,11 @@ monitor_speed     = 115200
 platform          = ststm32
 board             = genericSTM32F103RE
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags     = -std=gnu++11
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore        = Adafruit NeoPixel, SPI
@@ -388,11 +388,11 @@ monitor_speed     = 115200
 platform          = ststm32
 board             = genericSTM32F103RE
 platform_packages = tool-stm32duino
-build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags       = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DUSE_USB_COMPOSITE
 build_unflags     = -std=gnu++11
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore        = Adafruit NeoPixel, SPI
@@ -408,7 +408,7 @@ platform      = ststm32
 board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
 lib_ignore    = Adafruit NeoPixel, TMCStepper
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F7>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/STM32_F4_F7/STM32F7>
 
 #
 # STM32F7 with STM32GENERIC
@@ -418,7 +418,7 @@ platform      = ststm32
 board         = remram_v1
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
 lib_ignore    = Adafruit NeoPixel, TMCStepper
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F4>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32_F4_F7> -<src/HAL/STM32_F4_F7/STM32F4>
 
 #
 # ARMED (STM32)
@@ -429,9 +429,9 @@ board         = armed_v1
 build_flags   = ${common.build_flags}
   -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DUSBD_USE_CDC
   -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
-  -IMarlin/src/HAL/HAL_STM32
+  -IMarlin/src/HAL/STM32
 lib_ignore    = Adafruit NeoPixel, SoftwareSerial
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
 # Geeetech GTM32 (STM32F103VET6)
@@ -439,12 +439,12 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 [env:STM32F103VE_GTM32]
 platform        = ststm32
 board           = genericSTM32F103VE
-build_flags     = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags     = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=DEBUG_NONE -std=gnu++14 -MMD -ffunction-sections -fdata-sections -nostdlib
   -DBOARD_generic_stm32f103v -DARDUINO_GENERIC_STM32F103V -DARDUINO_ARCH_STM32F1
   -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DVECT_TAB_ADDR=0x8000000 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 build_unflags = -std=gnu++11
-src_filter      = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter      = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore      = Adafruit NeoPixel, SPI
 upload_protocol = serial
 
@@ -454,12 +454,12 @@ upload_protocol = serial
 [env:STM32F103VE_longer]
 platform      = ststm32
 board         = genericSTM32F103VE
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -USERIAL_USB
   -DSTM32F1xx -DU20 -DTS_V12
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 extra_scripts = buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI
 
 #
@@ -468,11 +468,11 @@ lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI
 [env:mks_robin_mini]
 platform      = ststm32
 board         = genericSTM32F103VE
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
 build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
 
 #
@@ -482,11 +482,11 @@ lib_ignore    = Adafruit NeoPixel, SPI
 platform      = ststm32
 board         = genericSTM32F103VE
 platform_packages = tool-stm32duino
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore    = Adafruit NeoPixel, SPI
@@ -497,11 +497,11 @@ lib_ignore    = Adafruit NeoPixel, SPI
 [env:mks_robin]
 platform      = ststm32
 board         = genericSTM32F103ZE
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY
 build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
 
 #
@@ -511,10 +511,10 @@ lib_ignore    = Adafruit NeoPixel, SPI
 platform      = ststm32
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_pro.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY
 build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, SPI, TMCStepper
 
@@ -524,11 +524,11 @@ lib_ignore    = Adafruit NeoPixel, SPI, TMCStepper
 [env:mks_robin_lite]
 platform      = ststm32
 board         = genericSTM32F103RC
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
 build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite.py
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
 
 #
@@ -538,10 +538,10 @@ lib_ignore    = Adafruit NeoPixel, SPI
 platform      = ststm32
 board         = genericSTM32F103RC
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite3.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
 build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, SPI
 
@@ -551,11 +551,11 @@ lib_ignore    = Adafruit NeoPixel, SPI
 [env:jgaurora_a5s_a1]
 platform      = ststm32
 board         = genericSTM32F103ZE
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -DSTM32F1xx -std=gnu++14 -DSTM32_XL_DENSITY
 build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
 
 #
@@ -564,9 +564,9 @@ lib_ignore    = Adafruit NeoPixel, SPI
 [env:STM32F103CB_malyan]
 platform    = ststm32
 board       = malyanM200
-build_flags = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
+build_flags = !python Marlin/src/HAL/STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
   -DDEBUG_LEVEL=0 -D__MARLIN_FIRMWARE__
-src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter  = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SPI
 
 #
@@ -575,11 +575,11 @@ lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-H
 [env:chitu_f103]
 platform      = ststm32
 board         = genericSTM32F103ZE
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+build_flags   = !python Marlin/src/HAL/STM32F1/build_flags.py
   ${common.build_flags} -DSTM32F1xx -std=gnu++14 -DSTM32_XL_DENSITY
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG= -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32F1>
 lib_ignore    = Adafruit NeoPixel
 
 #
@@ -594,12 +594,12 @@ build_flags       = ${common.build_flags}
  -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STEVAL_F401VE\"
  -DDISABLE_GENERIC_SERIALUSB
- -IMarlin/src/HAL/HAL_STM32
+ -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/STEVAL__F401XX.py
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
 # FLYF407ZG
@@ -611,11 +611,11 @@ platform_packages = framework-arduinoststm32@>=3.107,<4
 build_flags       = ${common.build_flags}
   -DSTM32F4 -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x8000
-  -IMarlin/src/HAL/HAL_STM32
+  -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 
 #
@@ -633,7 +633,7 @@ build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED -DUSBD_VID=0x0483 '-DUSB_PRODUCT="FYSETC_S6"'
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 lib_ignore        = Arduino-L6470
 debug_tool        = stlink
 #upload_protocol   = stlink
@@ -651,11 +651,11 @@ platform_packages = framework-arduinoststm32@>=3.107,<4
 build_flags       = ${common.build_flags}
  -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
-  -IMarlin/src/HAL/HAL_STM32
+  -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
@@ -667,11 +667,11 @@ platform_packages = framework-arduinoststm32@>=3.107,<4
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
-  -IMarlin/src/HAL/HAL_STM32
+  -IMarlin/src/HAL/STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = SoftwareSerial, SoftwareSerialM
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 #upload_protocol   = stlink
 #upload_command    = "$PROJECT_PACKAGES_DIR/tool-stm32duino/stlink/ST-LINK_CLI.exe" -c SWD -P "$BUILD_DIR/firmware.bin" 0x8008000 -Rst -Run
 debug_tool        = stlink
@@ -689,7 +689,7 @@ extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_varian
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407IG\"
   -DTARGET_STM32F4 -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
-  -IMarlin/src/HAL/HAL_STM32
+  -IMarlin/src/HAL/STM32
 lib_deps          =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal
@@ -698,7 +698,7 @@ lib_deps          =
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
 lib_ignore        = SoftwareSerial, SoftwareSerialM
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 monitor_speed     = 250000
 
 #
@@ -718,7 +718,7 @@ build_flags       = ${common.build_flags}
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+src_filter        = ${common.default_src_filter} +<src/HAL/STM32>
 
 #
 # Teensy 3.1 / 3.2 (ARM Cortex-M4)
@@ -729,7 +729,7 @@ board         = teensy31
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 lib_ignore    = Adafruit NeoPixel
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY31_32>
+src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY31_32>
 
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
@@ -740,7 +740,7 @@ board         = teensy35
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 lib_ignore    = Adafruit NeoPixel
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
+src_filter    = ${common.default_src_filter} +<src/HAL/TEENSY35_36>
 
 #
 # Espressif ESP32
@@ -756,7 +756,7 @@ lib_deps      = ${common.lib_deps}
   arduinoWebSockets=https://github.com/Links2004/arduinoWebSockets.git
   ESP32SSDP=https://github.com/luc-github/ESP32SSDP.git
 lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED, ESPAsyncTCP
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
+src_filter    = ${common.default_src_filter} +<src/HAL/ESP32>
 upload_speed  = 115200
 #upload_port   = marlinesp.local
 #board_build.flash_mode = qio
@@ -769,11 +769,11 @@ upload_speed  = 115200
 platform        = native
 framework       =
 build_flags     = -D__PLAT_LINUX__ -std=gnu++17 -ggdb -g -lrt -lpthread -D__MARLIN_FIRMWARE__ -Wno-expansion-to-defined
-src_build_flags = -Wall -IMarlin/src/HAL/HAL_LINUX/include
+src_build_flags = -Wall -IMarlin/src/HAL/LINUX/include
 build_unflags   = -Wall
 lib_ldf_mode    = off
 lib_deps        =
-src_filter      = ${common.default_src_filter} +<src/HAL/HAL_LINUX>
+src_filter      = ${common.default_src_filter} +<src/HAL/LINUX>
 
 #
 # Adafruit Grand Central M4 (Atmel SAMD51P20A ARM Cortex-M4)
@@ -783,7 +783,7 @@ platform       = atmelsam
 board          = adafruit_grandcentral_m4
 build_flags    = ${common.build_flags} -std=gnu++17 -Wno-register
 build_unflags  = -std=gnu++11
-src_filter     = ${common.default_src_filter} +<src/HAL/HAL_SAMD51>
+src_filter     = ${common.default_src_filter} +<src/HAL/SAMD51>
 lib_deps       = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 debug_tool     = jlink
@@ -810,7 +810,7 @@ build_flags   = ${common.build_flags}
   -DHAL_UART_MODULE_ENABLED
   -Os
 lib_ignore    = Adafruit NeoPixel
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32>
 monitor_speed = 500000
 upload_protocol = dfu
 
@@ -831,7 +831,7 @@ build_flags   = ${common.build_flags}
   -DHAL_UART_MODULE_ENABLED
   -Os
 lib_ignore    = Adafruit NeoPixel
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32> +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F7>
+src_filter    = ${common.default_src_filter} +<src/HAL/STM32> +<src/HAL/STM32_F4_F7> -<src/HAL/STM32_F4_F7/STM32F7>
 upload_protocol = dfu
 
 #

commit 4e96a014a824783829041f551dffb3f52a64078b
Author: Jason Smith <jason.inet@gmail.com>
Date:   Thu Mar 12 17:20:22 2020 -0700

    Use arduinoststm32 3.x for FYSETC S6 (#17131)

diff --git a/platformio.ini b/platformio.ini
index c57c1818bd..943889c7d5 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -624,7 +624,9 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 [env:FYSETC_S6]
 platform          = ststm32
 board             = fysetc_s6
-platform_packages = tool-stm32duino
+platform_packages =
+   tool-stm32duino
+   framework-arduinoststm32@>=3.107,<4
 build_flags       = ${common.build_flags}
   -DTARGET_STM32F4 -std=gnu++14
   -DVECT_TAB_OFFSET=0x10000

commit 631addbbb4d03151520f935a00c00a501f097e07
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Wed Mar 4 13:15:32 2020 -0600

    SAMD51 SoftwareSerial (#17041)

diff --git a/platformio.ini b/platformio.ini
index 89afb91235..c57c1818bd 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -771,20 +771,20 @@ src_build_flags = -Wall -IMarlin/src/HAL/HAL_LINUX/include
 build_unflags   = -Wall
 lib_ldf_mode    = off
 lib_deps        =
-extra_scripts   =
 src_filter      = ${common.default_src_filter} +<src/HAL/HAL_LINUX>
 
 #
 # Adafruit Grand Central M4 (Atmel SAMD51P20A ARM Cortex-M4)
 #
 [env:SAMD51_grandcentral_m4]
-platform      = atmelsam
-board         = adafruit_grandcentral_m4
-build_flags   = ${common.build_flags} -std=gnu++17
-extra_scripts = ${common.extra_scripts}
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_SAMD51>
-debug_tool    = jlink
+platform       = atmelsam
+board          = adafruit_grandcentral_m4
+build_flags    = ${common.build_flags} -std=gnu++17 -Wno-register
+build_unflags  = -std=gnu++11
+src_filter     = ${common.default_src_filter} +<src/HAL/HAL_SAMD51>
+lib_deps       = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+debug_tool     = jlink
 
 #
 # RUMBA32

commit 736521a3f1124a84a023e5ba1f030e09a95f16dc
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Mar 1 17:39:46 2020 -0600

    Balance mega tests, shorten some env names

diff --git a/platformio.ini b/platformio.ini
index f69842cafe..89afb91235 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -18,7 +18,7 @@
 [platformio]
 src_dir      = Marlin
 boards_dir   = buildroot/share/PlatformIO/boards
-default_envs = megaatmega2560
+default_envs = mega2560
 
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
@@ -57,7 +57,7 @@ monitor_speed = 250000
 #
 # ATmega2560
 #
-[env:megaatmega2560]
+[env:mega2560]
 platform          = atmelavr
 board             = megaatmega2560
 board_build.f_cpu = 16000000L
@@ -68,7 +68,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 #
 # ATmega1280
 #
-[env:megaatmega1280]
+[env:mega1280]
 platform          = atmelavr
 board             = megaatmega1280
 board_build.f_cpu = 16000000L
@@ -112,7 +112,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 #
 # Sanguinololu (ATmega644p)
 #
-[env:sanguino_atmega644p]
+[env:sanguino644p]
 platform      = atmelavr
 board         = sanguino_atmega644p
 lib_deps      = ${common.lib_deps}
@@ -122,7 +122,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 #
 # Sanguinololu (ATmega1284p)
 #
-[env:sanguino_atmega1284p]
+[env:sanguino1284p]
 platform      = atmelavr
 board         = sanguino_atmega1284p
 lib_deps      = ${common.lib_deps}
@@ -284,13 +284,13 @@ upload_protocol   = serial
 #
 # BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
 #
-#   STM32F103RC_bigtree ............. RCT6 with 256K
-#   STM32F103RC_bigtree_USB ......... RCT6 with 256K (USB mass storage)
-#   STM32F103RC_bigtree_512K ........ RCT6 with 512K
-#   STM32F103RC_bigtree_512K_USB .... RCT6 with 512K (USB mass storage)
+#   STM32F103RC_btt ............. RCT6 with 256K
+#   STM32F103RC_btt_USB ......... RCT6 with 256K (USB mass storage)
+#   STM32F103RC_btt_512K ........ RCT6 with 512K
+#   STM32F103RC_btt_512K_USB .... RCT6 with 512K (USB mass storage)
 #
 
-[env:STM32F103RC_bigtree]
+[env:STM32F103RC_btt]
 platform          = ststm32
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
@@ -304,7 +304,7 @@ lib_deps          = ${common.lib_deps}
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
-[env:STM32F103RC_bigtree_USB]
+[env:STM32F103RC_btt_USB]
 platform          = ststm32
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
@@ -318,7 +318,7 @@ lib_deps          = ${common.lib_deps}
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
-[env:STM32F103RC_bigtree_512K]
+[env:STM32F103RC_btt_512K]
 platform          = ststm32
 board             = genericSTM32F103RC
 board_upload.maximum_size=524288
@@ -333,7 +333,7 @@ lib_deps          = ${common.lib_deps}
 lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
-[env:STM32F103RC_bigtree_512K_USB]
+[env:STM32F103RC_btt_512K_USB]
 platform          = ststm32
 board             = genericSTM32F103RC
 board_upload.maximum_size=524288
@@ -365,10 +365,10 @@ lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
 #
-#   STM32F103RE_bigtree ............. RET6
-#   STM32F103RE_bigtree_USB ......... RET6 (USB mass storage)
+#   STM32F103RE_btt ............. RET6
+#   STM32F103RE_btt_USB ......... RET6 (USB mass storage)
 #
-[env:STM32F103RE_bigtree]
+[env:STM32F103RE_btt]
 platform          = ststm32
 board             = genericSTM32F103RE
 platform_packages = tool-stm32duino
@@ -384,7 +384,7 @@ debug_tool        = stlink
 upload_protocol   = stlink
 monitor_speed     = 115200
 
-[env:STM32F103RE_bigtree_USB]
+[env:STM32F103RE_btt_USB]
 platform          = ststm32
 board             = genericSTM32F103RE
 platform_packages = tool-stm32duino

commit cc822bf70fd4683a00fcf5c3ea5b5e6a62a0d10b
Author: Jason Smith <jason.inet@gmail.com>
Date:   Sun Mar 1 19:19:02 2020 -0800

    Fix some 8 extruders issues, GTR build (#17043)

diff --git a/platformio.ini b/platformio.ini
index 405efd8624..f69842cafe 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -681,13 +681,12 @@ debug_init_break  =
 [env:BIGTREE_GTR_V1_0]
 platform          = ststm32@>=5.7.0
 framework         = arduino
-platform_packages = framework-arduinoststm32@>=3.10700.191028
+platform_packages = framework-arduinoststm32@>=3.107,<4
 board             = BigTree_SKR_Pro
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407IG\"
   -DTARGET_STM32F4 -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
-
   -IMarlin/src/HAL/HAL_STM32
 lib_deps          =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip

commit ba4f49f4a269642a1743618c3b2e44ccf6fb89f1
Author: InsanityAutomation <38436470+InsanityAutomation@users.noreply.github.com>
Date:   Tue Feb 25 23:56:52 2020 -0500

    Fix GTR10 overlapping defines (#16976)

diff --git a/platformio.ini b/platformio.ini
index fc8c0dc1af..405efd8624 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -687,12 +687,6 @@ extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_varian
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407IG\"
   -DTARGET_STM32F4 -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
-  -DHAVE_HWSERIAL3
-  -DHAVE_HWSERIAL6
-  -DPIN_SERIAL3_RX=PD_9
-  -DPIN_SERIAL3_TX=PD_8
-  -DPIN_SERIAL6_RX=PC_7
-  -DPIN_SERIAL6_TX=PC_6
 
   -IMarlin/src/HAL/HAL_STM32
 lib_deps          =

commit 72fae2faa5c95f63f50daf49be67657ddc3ad069
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Feb 15 18:51:23 2020 -0600

    Require TMCStepper 0.6.2

diff --git a/platformio.ini b/platformio.ini
index 06946b7747..fc8c0dc1af 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -26,7 +26,7 @@ extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
 build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
 lib_deps =
   LiquidCrystal
-  TMCStepper@>=0.6.1,<1.0.0
+  TMCStepper@>=0.6.2,<1.0.0
   Adafruit NeoPixel
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   Adafruit_MAX31865=https://github.com/adafruit/Adafruit_MAX31865/archive/master.zip

commit 64b96f390867700834641b01bbb37a40867a7bef
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sat Feb 15 19:10:46 2020 -0600

    Double ADC read frequency (#16864)

diff --git a/platformio.ini b/platformio.ini
index 450fc32eb9..06946b7747 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -138,7 +138,6 @@ board         = sanguino_atmega1284p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-build_flags   = ${common.build_flags}
 lib_ignore    = TMCStepper
 upload_speed  = 57600
 
@@ -151,7 +150,6 @@ board         = sanguino_atmega1284p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-build_flags   = ${common.build_flags}
 lib_ignore    = TMCStepper
 upload_speed  = 115200
 

commit a16f3baecc6cd5da2fe71faac49650b5ff766cd7
Author: vivian-ng <vivian@maplerain.com>
Date:   Fri Feb 14 14:22:52 2020 +0900

    Add ESPAsyncTCP to lib_ignore (#16844)

diff --git a/platformio.ini b/platformio.ini
index 5ea93ab8e0..450fc32eb9 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -762,7 +762,7 @@ lib_deps      = ${common.lib_deps}
   ESP3DLib=https://github.com/luc-github/ESP3DLib.git
   arduinoWebSockets=https://github.com/Links2004/arduinoWebSockets.git
   ESP32SSDP=https://github.com/luc-github/ESP32SSDP.git
-lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED
+lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED, ESPAsyncTCP
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
 upload_speed  = 115200
 #upload_port   = marlinesp.local

commit 49a66bc4cc74f115b1846056a8ac4ae40ad5473b
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Feb 13 19:21:51 2020 -0600

    Fix ESP32 warning, specify supported version

diff --git a/platformio.ini b/platformio.ini
index db8f5dd6b7..5ea93ab8e0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -753,7 +753,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
 # Espressif ESP32
 #
 [env:esp32]
-platform      = espressif32
+platform      = espressif32@1.11.2
 board         = esp32dev
 build_flags   = ${common.build_flags} -DCORE_DEBUG_LEVEL=0
 lib_deps      = ${common.lib_deps}

commit d8b2726fd3248c90da719b2ec1bf87eb0bb5aadd
Author: darksiah <siatam@gmail.com>
Date:   Mon Feb 10 19:49:36 2020 -0300

    Fix MKS Robin Nano platformio.ini entry (#16826)

diff --git a/platformio.ini b/platformio.ini
index 2e57e7d773..db8f5dd6b7 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -489,7 +489,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
 build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_deps =
+lib_deps = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore    = Adafruit NeoPixel, SPI
 

commit 78fea4a9ca198b737e00025ff42fc2ddace38092
Author: Bob Kuhn <bob.kuhn@att.net>
Date:   Wed Feb 5 20:28:28 2020 -0600

    Split up MKS_RUMBA32 into two variants (#16781)

diff --git a/platformio.ini b/platformio.ini
index df3dcb0f66..2e57e7d773 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -822,9 +822,9 @@ monitor_speed = 500000
 upload_protocol = dfu
 
 #
-# MKS RUMBA32(add TMC2208/2209 UART interface and AUX-1)
+# MKS RUMBA32 (adds TMC2208/2209 UART interface and AUX-1)
 #
-[env:mks_rumba32]
+[env:rumba32_mks]
 platform      = ststm32
 board         = rumba32_f446ve
 build_flags   = ${common.build_flags}

commit 248b7dfa591a34a8aa1c6960944e1a3a468ad1de
Author: yangwenxiong <46896566+yangwenxiong@users.noreply.github.com>
Date:   Sat Jan 25 16:13:39 2020 +0800

    BigTreeTech GTR V1.0 / Support 8 extruders, heaters, temp sensors, fans (#16595)

diff --git a/platformio.ini b/platformio.ini
index 9cf2c918ed..df3dcb0f66 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -586,7 +586,7 @@ lib_ignore    = Adafruit NeoPixel
 
 #
 # STM32F401VE
-# 'STEVAL-3DP001)' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
+# 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
 #
 [env:STM32F401VE_STEVAL]
 platform          = ststm32
@@ -677,6 +677,37 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 debug_tool        = stlink
 debug_init_break  =
 
+#
+# Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
+#
+[env:BIGTREE_GTR_V1_0]
+platform          = ststm32@>=5.7.0
+framework         = arduino
+platform_packages = framework-arduinoststm32@>=3.10700.191028
+board             = BigTree_SKR_Pro
+extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+build_flags       = ${common.build_flags}
+  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407IG\"
+  -DTARGET_STM32F4 -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
+  -DHAVE_HWSERIAL3
+  -DHAVE_HWSERIAL6
+  -DPIN_SERIAL3_RX=PD_9
+  -DPIN_SERIAL3_TX=PD_8
+  -DPIN_SERIAL6_RX=PC_7
+  -DPIN_SERIAL6_TX=PC_6
+
+  -IMarlin/src/HAL/HAL_STM32
+lib_deps          =
+  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
+  LiquidCrystal
+  TMCStepper@>=0.5.2,<1.0.0
+  Adafruit NeoPixel
+  LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
+  Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
+lib_ignore        = SoftwareSerial, SoftwareSerialM
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed     = 250000
+
 #
 # BigTreeTech BTT002 (STM32F407VET6 ARM Cortex-M4)
 #

commit 2ef6b86ccdc3fdd3fde332f36181f4b2009e15b6
Author: Artur Petrzak <petrzmax@gmail.com>
Date:   Thu Jan 23 04:52:16 2020 +0100

    Enable use of latest TMCStepper on MKS Robin Nano (#16652)

diff --git a/platformio.ini b/platformio.ini
index 7689aea3c3..9cf2c918ed 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -483,11 +483,14 @@ lib_ignore    = Adafruit NeoPixel, SPI
 [env:mks_robin_nano]
 platform      = ststm32
 board         = genericSTM32F103VE
+platform_packages = tool-stm32duino
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
+  ${common.build_flags} -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps =
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore    = Adafruit NeoPixel, SPI
 
 #

commit 6d1f6a95168fd36e6ca49fa0012ca308b9679771
Author: Vertabreaker <opyrus@hotmail.com>
Date:   Fri Jan 17 03:46:50 2020 -0500

    Adjust GTM32 build flags (#16582)

diff --git a/platformio.ini b/platformio.ini
index 2726ab7865..7689aea3c3 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -442,11 +442,12 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 platform        = ststm32
 board           = genericSTM32F103VE
 build_flags     = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=DEBUG_NONE -std=gnu++11 -MMD -ffunction-sections -fdata-sections -nostdlib
+  ${common.build_flags} -DDEBUG_LEVEL=DEBUG_NONE -std=gnu++14 -MMD -ffunction-sections -fdata-sections -nostdlib
   -DBOARD_generic_stm32f103v -DARDUINO_GENERIC_STM32F103V -DARDUINO_ARCH_STM32F1
   -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DVECT_TAB_ADDR=0x8000000 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
+build_unflags = -std=gnu++11
 src_filter      = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_ignore      = Adafruit NeoPixel, LiquidTWI2, SPI
+lib_ignore      = Adafruit NeoPixel, SPI
 upload_protocol = serial
 
 #

commit b310047dedcbb47387b1313d7d69ac42ff11bf05
Author: Vertabreaker <opyrus@hotmail.com>
Date:   Wed Jan 15 04:27:46 2020 -0500

    Fix GTM32 environment (to prevent a crash)

diff --git a/platformio.ini b/platformio.ini
index b0cf2be831..2726ab7865 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -442,8 +442,9 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 platform        = ststm32
 board           = genericSTM32F103VE
 build_flags     = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-build_unflags   = -std=gnu++11
+  ${common.build_flags} -DDEBUG_LEVEL=DEBUG_NONE -std=gnu++11 -MMD -ffunction-sections -fdata-sections -nostdlib
+  -DBOARD_generic_stm32f103v -DARDUINO_GENERIC_STM32F103V -DARDUINO_ARCH_STM32F1
+  -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DVECT_TAB_ADDR=0x8000000 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 src_filter      = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore      = Adafruit NeoPixel, LiquidTWI2, SPI
 upload_protocol = serial

commit fc773c278433c1b400b5ac45eae7b21342538fe5
Author: Jason Smith <jason.inet@gmail.com>
Date:   Tue Jan 14 13:36:47 2020 -0800

    Fix Fysetc S6 FLASH_PAGE_SIZE and test build (#16560)

diff --git a/platformio.ini b/platformio.ini
index f3d24799a7..b0cf2be831 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -627,7 +627,7 @@ build_flags       = ${common.build_flags}
   -DVECT_TAB_OFFSET=0x10000
   -DUSBCON -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED -DUSBD_VID=0x0483 '-DUSB_PRODUCT="FYSETC_S6"'
 build_unflags     = -std=gnu++11
-extra_scripts     = buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
+extra_scripts     = pre:buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 lib_ignore        = Arduino-L6470
 debug_tool        = stlink

commit ffd8b595d16dde892e0a48f2afd9b4e79bce47fa
Author: InsanityAutomation <38436470+InsanityAutomation@users.noreply.github.com>
Date:   Mon Jan 13 21:52:24 2020 -0500

    Fix PLR cancel with ExtUI (#16556)

diff --git a/platformio.ini b/platformio.ini
index cc50614730..f3d24799a7 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -437,7 +437,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 
 #
 # Geeetech GTM32 (STM32F103VET6)
-#  
+#
 [env:STM32F103VE_GTM32]
 platform        = ststm32
 board           = genericSTM32F103VE

commit 1ad53cee1f4e2768310fca98de0381df9c39b617
Author: Bob Kuhn <bob.kuhn@att.net>
Date:   Mon Jan 13 18:47:30 2020 -0600

    Improved STMicro L64XX stepper driver support (#16452)

diff --git a/platformio.ini b/platformio.ini
index 141468c435..cc50614730 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -31,7 +31,7 @@ lib_deps =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   Adafruit_MAX31865=https://github.com/adafruit/Adafruit_MAX31865/archive/master.zip
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
-  Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
+  Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/0.8.0.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
   SailfishRGB_LED=https://github.com/mikeshub/SailfishRGB_LED/archive/master.zip
   SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip

commit 51f2733b7ff640fe0e9ec43c14e06470d51c2fc4
Author: Vertabreaker <opyrus@hotmail.com>
Date:   Sun Jan 12 23:27:58 2020 -0500

    Add GTM32 (STM32F103VET6) environment (#16454)

diff --git a/platformio.ini b/platformio.ini
index d0d2052591..141468c435 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -435,6 +435,19 @@ build_flags   = ${common.build_flags}
 lib_ignore    = Adafruit NeoPixel, SoftwareSerial
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 
+#
+# Geeetech GTM32 (STM32F103VET6)
+#  
+[env:STM32F103VE_GTM32]
+platform        = ststm32
+board           = genericSTM32F103VE
+build_flags     = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14
+build_unflags   = -std=gnu++11
+src_filter      = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_ignore      = Adafruit NeoPixel, LiquidTWI2, SPI
+upload_protocol = serial
+
 #
 # Longer 3D board in Alfawise U20 (STM32F103VET6)
 #
@@ -449,6 +462,32 @@ extra_scripts = buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI
 
+#
+# MKS Robin Mini (STM32F103VET6)
+#
+[env:mks_robin_mini]
+platform      = ststm32
+board         = genericSTM32F103VE
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_ignore    = Adafruit NeoPixel, SPI
+
+#
+# MKS Robin Nano (STM32F103VET6)
+#
+[env:mks_robin_nano]
+platform      = ststm32
+board         = genericSTM32F103VE
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_ignore    = Adafruit NeoPixel, SPI
+
 #
 # MKS Robin (STM32F103ZET6)
 #
@@ -462,7 +501,6 @@ extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
 
-
 #
 # MKS Robin Pro (STM32F103ZET6)
 #
@@ -504,33 +542,6 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, SPI
 
-
-#
-# MKS Robin Mini (STM32F103VET6)
-#
-[env:mks_robin_mini]
-platform      = ststm32
-board         = genericSTM32F103VE
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-build_unflags = -std=gnu++11
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_ignore    = Adafruit NeoPixel, SPI
-
-#
-# MKS Robin Nano (STM32F103VET6)
-#
-[env:mks_robin_nano]
-platform      = ststm32
-board         = genericSTM32F103VE
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-build_unflags = -std=gnu++11
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_ignore    = Adafruit NeoPixel, SPI
-
 #
 # JGAurora A5S A1 (STM32F103ZET6)
 #

commit d854c8fa5fb4f65eeafd230885a6eea982fbed22
Author: Luc <8822552+luc-github@users.noreply.github.com>
Date:   Sat Jan 11 00:15:05 2020 +0100

    ESP3d integration for ESP32 (#16515)

diff --git a/platformio.ini b/platformio.ini
index c7b71167cf..d0d2052591 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -712,6 +712,9 @@ build_flags   = ${common.build_flags} -DCORE_DEBUG_LEVEL=0
 lib_deps      = ${common.lib_deps}
   AsyncTCP=https://github.com/me-no-dev/AsyncTCP/archive/master.zip
   ESPAsyncWebServer=https://github.com/me-no-dev/ESPAsyncWebServer/archive/master.zip
+  ESP3DLib=https://github.com/luc-github/ESP3DLib.git
+  arduinoWebSockets=https://github.com/Links2004/arduinoWebSockets.git
+  ESP32SSDP=https://github.com/luc-github/ESP32SSDP.git
 lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
 upload_speed  = 115200

commit 07509febcd0e4d9ad0083426faaffd113e1473ee
Author: Lino Barreca <linobarreca@hotmail.com>
Date:   Sat Jan 4 04:01:42 2020 +0100

    Fix serials available on SKR Pro 1.1 (#16439)

diff --git a/platformio.ini b/platformio.ini
index 420c002298..c7b71167cf 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -25,10 +25,10 @@ default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
 build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
 lib_deps =
+  LiquidCrystal
+  TMCStepper@>=0.6.1,<1.0.0
+  Adafruit NeoPixel
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  LiquidCrystal@1.3.4
-  TMCStepper@>=0.5.2,<1.0.0
-  Adafruit NeoPixel@1.2.5
   Adafruit_MAX31865=https://github.com/adafruit/Adafruit_MAX31865/archive/master.zip
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
@@ -651,19 +651,15 @@ platform_packages = framework-arduinoststm32@>=3.107,<4
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
-  -DHAVE_HWSERIAL6
   -IMarlin/src/HAL/HAL_STM32
 build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_deps          =
-  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  LiquidCrystal
-  TMCStepper@>=0.5.2,<1.0.0
-  Adafruit NeoPixel
-  LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
-  Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
 lib_ignore        = SoftwareSerial, SoftwareSerialM
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+#upload_protocol   = stlink
+#upload_command    = "$PROJECT_PACKAGES_DIR/tool-stm32duino/stlink/ST-LINK_CLI.exe" -c SWD -P "$BUILD_DIR/firmware.bin" 0x8008000 -Rst -Run
+debug_tool        = stlink
+debug_init_break  =
 
 #
 # BigTreeTech BTT002 (STM32F407VET6 ARM Cortex-M4)

commit ceeba58dc9688f7d92a77cc32468db9d8ad69f56
Author: George Fu <nailao_5918@163.com>
Date:   Sat Jan 4 10:29:25 2020 +0800

    FYSETC F6 v1.4 board support (#16321)

diff --git a/platformio.ini b/platformio.ini
index ba4dc4dfc0..420c002298 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -98,6 +98,17 @@ lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 
+#
+# FYSETC F6 V1.4
+#
+[env:FYSETC_F6_14]
+platform          = atmelavr
+board             = fysetc_f6_14
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+
 #
 # Sanguinololu (ATmega644p)
 #

commit 00e27503ce9dec72df4610622159dd1c49eace42
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Jan 3 19:37:23 2020 -0600

    Use a default monitor_speed of 250000

diff --git a/platformio.ini b/platformio.ini
index f309430d81..ba4dc4dfc0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -39,9 +39,10 @@ lib_deps =
 # Globally defined properties
 # inherited by all environments
 [env]
-framework   = arduino
-build_flags = ${common.build_flags}
-lib_deps    = ${common.lib_deps}
+framework     = arduino
+build_flags   = ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+monitor_speed = 250000
 
 #################################
 #                               #
@@ -63,7 +64,6 @@ board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed     = 250000
 
 #
 # ATmega1280
@@ -75,7 +75,6 @@ board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed     = 250000
 
 #
 # RAMBo
@@ -87,7 +86,6 @@ board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed     = 250000
 
 #
 # FYSETC F6 V1.3
@@ -99,7 +97,6 @@ board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed     = 250000
 
 #
 # Sanguinololu (ATmega644p)
@@ -110,7 +107,6 @@ board         = sanguino_atmega644p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
 
 #
 # Sanguinololu (ATmega1284p)
@@ -121,7 +117,6 @@ board         = sanguino_atmega1284p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
 
 #
 # Melzi and clones (ATmega1284p)
@@ -132,7 +127,6 @@ board         = sanguino_atmega1284p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
 build_flags   = ${common.build_flags}
 lib_ignore    = TMCStepper
 upload_speed  = 57600
@@ -146,7 +140,6 @@ board         = sanguino_atmega1284p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
 build_flags   = ${common.build_flags}
 lib_ignore    = TMCStepper
 upload_speed  = 115200
@@ -165,7 +158,6 @@ lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 lib_ignore    = TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
 
 #
 # AT90USB1286 boards using DFU bootloader
@@ -179,7 +171,6 @@ board         = at90usb1286
 lib_deps      = ${common.lib_deps}
 lib_ignore    = TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
 
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
@@ -191,20 +182,17 @@ monitor_speed = 250000
 platform      = atmelsam
 board         = due
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
-monitor_speed = 250000
 
 [env:DUE_USB]
 platform      = atmelsam
 board         = dueUSB
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
-monitor_speed = 250000
 
 [env:DUE_debug]
 # Used when WATCHDOG_RESET_MANUAL is enabled
 platform      = atmelsam
 board         = due
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
-monitor_speed = 250000
 build_flags   = ${common.build_flags}
   -funwind-tables
   -mpoke-function-name
@@ -223,7 +211,6 @@ lib_ldf_mode      = off
 lib_compat_mode   = strict
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
-monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
@@ -242,7 +229,6 @@ lib_ldf_mode      = off
 lib_compat_mode   = strict
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
-monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
@@ -285,7 +271,6 @@ lib_ignore        = Adafruit NeoPixel, SPI
 lib_ldf_mode      = chain
 debug_tool        = stlink
 upload_protocol   = serial
-monitor_speed     = 250000
 
 #
 # BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
@@ -415,7 +400,6 @@ board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
 lib_ignore    = Adafruit NeoPixel, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F7>
-monitor_speed = 250000
 
 #
 # STM32F7 with STM32GENERIC
@@ -426,7 +410,6 @@ board         = remram_v1
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
 lib_ignore    = Adafruit NeoPixel, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F4>
-monitor_speed = 250000
 
 #
 # ARMED (STM32)
@@ -440,7 +423,6 @@ build_flags   = ${common.build_flags}
   -IMarlin/src/HAL/HAL_STM32
 lib_ignore    = Adafruit NeoPixel, SoftwareSerial
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed = 250000
 
 #
 # Longer 3D board in Alfawise U20 (STM32F103VET6)
@@ -455,7 +437,6 @@ build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_
 extra_scripts = buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI
-monitor_speed = 250000
 
 #
 # MKS Robin (STM32F103ZET6)
@@ -469,7 +450,6 @@ build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
-monitor_speed = 250000
 
 
 #
@@ -498,7 +478,6 @@ build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite.py
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
-monitor_speed = 250000
 
 #
 # MKS ROBIN LITE3 (STM32F103RCT6)
@@ -527,7 +506,6 @@ build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
-monitor_speed = 250000
 
 #
 # MKS Robin Nano (STM32F103VET6)
@@ -541,7 +519,6 @@ build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
-monitor_speed = 250000
 
 #
 # JGAurora A5S A1 (STM32F103ZET6)
@@ -555,7 +532,6 @@ build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
-monitor_speed = 250000
 
 #
 # Malyan M200 (STM32F103CB)
@@ -580,7 +556,6 @@ build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG= -DERROR_LED_P
 extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel
-monitor_speed = 250000
 
 #
 # STM32F401VE
@@ -600,7 +575,6 @@ extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_varian
   buildroot/share/PlatformIO/scripts/STEVAL__F401XX.py
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed     = 250000
 
 #
 # FLYF407ZG
@@ -617,7 +591,6 @@ build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed     = 250000
 
 
 #
@@ -638,7 +611,6 @@ lib_ignore        = Arduino-L6470
 debug_tool        = stlink
 #upload_protocol   = stlink
 upload_protocol   = serial
-monitor_speed     = 250000
 
 #
 # STM32F407VET6 with RAMPS-like shield
@@ -657,7 +629,6 @@ build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed     = 250000
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
@@ -682,7 +653,6 @@ lib_deps          =
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
 lib_ignore        = SoftwareSerial, SoftwareSerialM
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed     = 250000
 
 #
 # BigTreeTech BTT002 (STM32F407VET6 ARM Cortex-M4)
@@ -702,7 +672,6 @@ build_unflags     = -std=gnu++11
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed     = 250000
 
 #
 # Teensy 3.1 / 3.2 (ARM Cortex-M4)
@@ -714,7 +683,6 @@ lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY31_32>
-monitor_speed = 250000
 
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
@@ -726,7 +694,6 @@ lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
-monitor_speed = 250000
 
 #
 # Espressif ESP32
@@ -741,7 +708,6 @@ lib_deps      = ${common.lib_deps}
 lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
 upload_speed  = 115200
-monitor_speed = 250000
 #upload_port   = marlinesp.local
 #board_build.flash_mode = qio
 
@@ -816,7 +782,6 @@ build_flags   = ${common.build_flags}
   -Os
 lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32> +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F7>
-monitor_speed = 250000
 upload_protocol = dfu
 
 #

commit f7e3a5ad85fe13a00b381c2c876489a6ec5a9dcf
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Jan 3 18:57:15 2020 -0600

    Temporary CI fix for STM32

diff --git a/platformio.ini b/platformio.ini
index 66b60de070..f309430d81 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -589,7 +589,7 @@ monitor_speed = 250000
 [env:STM32F401VE_STEVAL]
 platform          = ststm32
 board             = STEVAL_STM32F401VE
-platform_packages = framework-arduinoststm32@>=3.10700.191028
+platform_packages = framework-arduinoststm32@>=3.107,<4
 build_flags       = ${common.build_flags}
  -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STEVAL_F401VE\"
@@ -608,7 +608,7 @@ monitor_speed     = 250000
 [env:FLYF407ZG]
 platform          = ststm32
 board             = FLYF407ZG
-platform_packages = framework-arduinoststm32@>=3.10700.191028
+platform_packages = framework-arduinoststm32@>=3.107,<4
 build_flags       = ${common.build_flags}
   -DSTM32F4 -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x8000
@@ -648,7 +648,7 @@ monitor_speed     = 250000
 [env:STM32F407VE_black]
 platform          = ststm32
 board             = blackSTM32F407VET6
-platform_packages = framework-arduinoststm32@>=3.10700.191028
+platform_packages = framework-arduinoststm32@>=3.107,<4
 build_flags       = ${common.build_flags}
  -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
@@ -665,7 +665,7 @@ monitor_speed     = 250000
 [env:BIGTREE_SKR_PRO]
 platform          = ststm32
 board             = BigTree_SKR_Pro
-platform_packages = framework-arduinoststm32@>=3.10700.191028
+platform_packages = framework-arduinoststm32@>=3.107,<4
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
@@ -690,7 +690,7 @@ monitor_speed     = 250000
 [env:BIGTREE_BTT002]
 platform          = ststm32@5.6.0
 board             = BigTree_Btt002
-platform_packages = framework-arduinoststm32@>=3.10700.191028
+platform_packages = framework-arduinoststm32@>=3.107,<4
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407VE\"
   -DTARGET_STM32F4 -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000

commit a7b0b390cda561d670e4d2ee87af5de7688fecc0
Author: Jason Smith <jason.inet@gmail.com>
Date:   Wed Jan 1 20:14:14 2020 -0800

    Fix PrintrBoard build (ignore TMC libraries) (#16346)
    
    (In future try to get Teensy processors better supported by `TMCStepper`.)

diff --git a/platformio.ini b/platformio.ini
index 3dc1782419..66b60de070 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -163,6 +163,7 @@ platform      = teensy
 board         = at90usb1286
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+lib_ignore    = TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 
@@ -176,7 +177,7 @@ monitor_speed = 250000
 platform      = teensy
 board         = at90usb1286
 lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+lib_ignore    = TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 

commit 747b2b9bf45b4882c2b8c9c1186b399bf53b0421
Author: Bob Kuhn <bob.kuhn@att.net>
Date:   Wed Jan 1 20:52:56 2020 -0600

    Improve STEVAL_3DP001V1 and future STEVAL_* support (#16404)

diff --git a/platformio.ini b/platformio.ini
index e89a476b07..3dc1782419 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -581,6 +581,25 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel
 monitor_speed = 250000
 
+#
+# STM32F401VE
+# 'STEVAL-3DP001)' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
+#
+[env:STM32F401VE_STEVAL]
+platform          = ststm32
+board             = STEVAL_STM32F401VE
+platform_packages = framework-arduinoststm32@>=3.10700.191028
+build_flags       = ${common.build_flags}
+ -DTARGET_STM32F4 -DARDUINO_STEVAL -DSTM32F401xE
+ -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STEVAL_F401VE\"
+ -DDISABLE_GENERIC_SERIALUSB
+ -IMarlin/src/HAL/HAL_STM32
+build_unflags     = -std=gnu++11
+extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/STEVAL__F401XX.py
+lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed     = 250000
 
 #
 # FLYF407ZG

commit a333bba725c7e64ceec04d980e43318b396376a8
Author: thisiskeithb <13375512+thisiskeithb@users.noreply.github.com>
Date:   Sun Dec 22 16:08:52 2019 -0800

    Add Rumba32 support for PIO (#16202)

diff --git a/platformio.ini b/platformio.ini
index 4597b6f0ed..e89a476b07 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -752,6 +752,53 @@ build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_SAMD51>
 debug_tool    = jlink
 
+#
+# RUMBA32
+#
+[env:rumba32_f446ve]
+platform      = ststm32
+board         = rumba32_f446ve
+build_flags   = ${common.build_flags}
+  -DSTM32F4xx
+  -DARDUINO_RUMBA32_F446VE
+  -DARDUINO_ARCH_STM32
+  "-DBOARD_NAME=\"RUMBA32_F446VE\""
+  -DSTM32F446xx
+  -DUSBCON
+  -DUSBD_VID=0x0483
+  "-DUSB_MANUFACTURER=\"Unknown\""
+  "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
+  -DHAL_PCD_MODULE_ENABLED
+  -DUSBD_USE_CDC
+  -DDISABLE_GENERIC_SERIALUSB
+  -DHAL_UART_MODULE_ENABLED
+  -Os
+lib_ignore    = Adafruit NeoPixel
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed = 500000
+upload_protocol = dfu
+
+#
+# MKS RUMBA32(add TMC2208/2209 UART interface and AUX-1)
+#
+[env:mks_rumba32]
+platform      = ststm32
+board         = rumba32_f446ve
+build_flags   = ${common.build_flags}
+ -DSTM32F4xx -DARDUINO_RUMBA32_F446VE -DARDUINO_ARCH_STM32 "-DBOARD_NAME=\"RUMBA32_F446VE\""
+ -DSTM32F446xx -DUSBCON -DUSBD_VID=0x8000
+  "-DUSB_MANUFACTURER=\"Unknown\""
+  "-DUSB_PRODUCT=\"RUMBA32_F446VE\""
+  -DHAL_PCD_MODULE_ENABLED
+  -DUSBD_USE_CDC
+  -DDISABLE_GENERIC_SERIALUSB
+  -DHAL_UART_MODULE_ENABLED
+  -Os
+lib_ignore    = Adafruit NeoPixel
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32> +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F7>
+monitor_speed = 250000
+upload_protocol = dfu
+
 #
 # Just print the dependency tree
 #

commit 24eaf2d7e0bad4ad3a11f1835ed60c031b0d521c
Author: Luc <8822552+luc-github@users.noreply.github.com>
Date:   Sun Dec 22 23:11:17 2019 +0100

    Some ESP32 patches (#16297)

diff --git a/platformio.ini b/platformio.ini
index b16dc2c0cb..4597b6f0ed 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -715,7 +715,7 @@ monitor_speed = 250000
 platform      = espressif32
 board         = esp32dev
 build_flags   = ${common.build_flags} -DCORE_DEBUG_LEVEL=0
-lib_deps      =
+lib_deps      = ${common.lib_deps}
   AsyncTCP=https://github.com/me-no-dev/AsyncTCP/archive/master.zip
   ESPAsyncWebServer=https://github.com/me-no-dev/ESPAsyncWebServer/archive/master.zip
 lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED

commit 59f9bb2120b199f082ae24f4d7f6c3be4904fe53
Author: FLYmaker <49380822+FLYmaker@users.noreply.github.com>
Date:   Sun Dec 22 17:05:30 2019 +0800

    Add FLYBOARD (STM32F407ZG) (#16257)

diff --git a/platformio.ini b/platformio.ini
index ba277316bb..b16dc2c0cb 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -581,6 +581,25 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel
 monitor_speed = 250000
 
+
+#
+# FLYF407ZG
+#
+[env:FLYF407ZG]
+platform          = ststm32
+board             = FLYF407ZG
+platform_packages = framework-arduinoststm32@>=3.10700.191028
+build_flags       = ${common.build_flags}
+  -DSTM32F4 -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
+  -DTARGET_STM32F4 -DVECT_TAB_OFFSET=0x8000
+  -IMarlin/src/HAL/HAL_STM32
+build_unflags     = -std=gnu++11
+extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed     = 250000
+
+
 #
 # FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
 #

commit bbe0ffb2fafad854457390540ca47165e62986b9
Author: BigTreeTech <38851044+bigtreetech@users.noreply.github.com>
Date:   Thu Dec 19 16:41:35 2019 +0800

    BigTreeTech SKR v1.4 support (#16236)

diff --git a/platformio.ini b/platformio.ini
index 42ad37bdd8..ba277316bb 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -621,7 +621,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed     = 250000
 
 #
-# Bigtreetech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
+# BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
 platform          = ststm32
@@ -646,7 +646,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed     = 250000
 
 #
-# Bigtreetech BTT002 (STM32F407VET6 ARM Cortex-M4)
+# BigTreeTech BTT002 (STM32F407VET6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
 platform          = ststm32@5.6.0

commit 42a336f8bc84357e5b9af5b439dba8592800e3d6
Author: chzj333 <53591189+chzj333@users.noreply.github.com>
Date:   Mon Dec 16 02:24:54 2019 +0800

    Update BTT002 platform (fixing SD init) (#16217)

diff --git a/platformio.ini b/platformio.ini
index 1b42b63f6c..42ad37bdd8 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -646,12 +646,13 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed     = 250000
 
 #
-# Bigtreetech SKR BTT002 (STM32F407VET6 ARM Cortex-M4)
+# Bigtreetech BTT002 (STM32F407VET6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
 platform          = ststm32@5.6.0
-board         = BigTree_Btt002
-build_flags   = ${common.build_flags}
+board             = BigTree_Btt002
+platform_packages = framework-arduinoststm32@>=3.10700.191028
+build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407VE\"
   -DTARGET_STM32F4 -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DHAVE_HWSERIAL2
@@ -659,8 +660,8 @@ build_flags   = ${common.build_flags}
   -DPIN_SERIAL2_RX=PD_6
   -DPIN_SERIAL2_TX=PD_5
 build_unflags     = -std=gnu++11
-extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-lib_ignore    = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+lib_ignore        = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed     = 250000
 

commit 9d6b2ebf50415ac04ce438a58f62319a6c010b7c
Author: Luc <8822552+luc-github@users.noreply.github.com>
Date:   Sun Dec 15 18:39:39 2019 +0100

    Improve ESP32 HAL (EEPROM, watchdog) (#16228)

diff --git a/platformio.ini b/platformio.ini
index 4cb7eb7f0d..1b42b63f6c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -694,14 +694,16 @@ monitor_speed = 250000
 [env:esp32]
 platform      = espressif32
 board         = esp32dev
-upload_speed  = 115200
-monitor_speed = 115200
-upload_port   = /dev/ttyUSB0
+build_flags   = ${common.build_flags} -DCORE_DEBUG_LEVEL=0
 lib_deps      =
   AsyncTCP=https://github.com/me-no-dev/AsyncTCP/archive/master.zip
   ESPAsyncWebServer=https://github.com/me-no-dev/ESPAsyncWebServer/archive/master.zip
 lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
+upload_speed  = 115200
+monitor_speed = 250000
+#upload_port   = marlinesp.local
+#board_build.flash_mode = qio
 
 #
 # Native

commit 23d1801022c1d9e7fa23a1f73b6a645db396779d
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Wed Dec 11 08:47:21 2019 +0100

    Update BTT comments for USB/SD Composite (#16130)

diff --git a/platformio.ini b/platformio.ini
index 1ff3445362..4cb7eb7f0d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -290,9 +290,9 @@ monitor_speed     = 250000
 # BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
 #
 #   STM32F103RC_bigtree ............. RCT6 with 256K
-#   STM32F103RC_bigtree_USB ......... RCT6 with 256K (USB)
+#   STM32F103RC_bigtree_USB ......... RCT6 with 256K (USB mass storage)
 #   STM32F103RC_bigtree_512K ........ RCT6 with 512K
-#   STM32F103RC_bigtree_512K_USB .... RCT6 with 512K (USB)
+#   STM32F103RC_bigtree_512K_USB .... RCT6 with 512K (USB mass storage)
 #
 
 [env:STM32F103RC_bigtree]
@@ -371,7 +371,7 @@ monitor_speed     = 115200
 
 #
 #   STM32F103RE_bigtree ............. RET6
-#   STM32F103RE_bigtree_USB ......... RET6 (USB)
+#   STM32F103RE_bigtree_USB ......... RET6 (USB mass storage)
 #
 [env:STM32F103RE_bigtree]
 platform          = ststm32

commit 31fdaea26910e174dd6c2c12f8073aba74057e7e
Author: MS1987 <lms228@163.com>
Date:   Wed Dec 11 14:23:47 2019 +0800

    Add MKS Robin Pro, MKS Robin Lite3 (#16163)

diff --git a/platformio.ini b/platformio.ini
index 18a644c7cd..1ff3445362 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -470,6 +470,21 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
 monitor_speed = 250000
 
+
+#
+# MKS Robin Pro (STM32F103ZET6)
+#
+[env:mks_robin_pro]
+platform      = ststm32
+board         = genericSTM32F103ZE
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_pro.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY
+build_unflags = -std=gnu++11
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = Adafruit NeoPixel, SPI, TMCStepper
+
 #
 # MKS Robin Lite/Lite2 (STM32F103RCT6)
 #
@@ -484,6 +499,21 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel, SPI
 monitor_speed = 250000
 
+#
+# MKS ROBIN LITE3 (STM32F103RCT6)
+#
+[env:mks_robin_lite3]
+platform      = ststm32
+board         = genericSTM32F103RC
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite3.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = Adafruit NeoPixel, SPI
+
+
 #
 # MKS Robin Mini (STM32F103VET6)
 #

commit afd865d8dd4916ebe4122d8535c18800d72f79e3
Author: thisiskeithb <13375512+thisiskeithb@users.noreply.github.com>
Date:   Tue Dec 3 23:26:27 2019 -0800

    Melzi has a 1284 (#16090)

diff --git a/platformio.ini b/platformio.ini
index 0c2d9b706e..18a644c7cd 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -128,7 +128,7 @@ monitor_speed = 250000
 #
 [env:melzi]
 platform      = atmelavr
-board         = sanguino_atmega644p
+board         = sanguino_atmega1284p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
@@ -142,7 +142,7 @@ upload_speed  = 57600
 #
 [env:melzi_optiboot]
 platform      = atmelavr
-board         = sanguino_atmega644p
+board         = sanguino_atmega1284p
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>

commit 6134bff81becb5c6e28db33ad409d94b1258a3e9
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Mon Dec 2 21:19:23 2019 -0600

    Expand environments in platformio.ini

diff --git a/platformio.ini b/platformio.ini
index 57d72e6bd4..0c2d9b706e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -69,22 +69,37 @@ monitor_speed     = 250000
 # ATmega1280
 #
 [env:megaatmega1280]
-extends           = env:megaatmega2560
+platform          = atmelavr
 board             = megaatmega1280
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+monitor_speed     = 250000
 
 #
 # RAMBo
 #
 [env:rambo]
-extends           = env:megaatmega2560
+platform          = atmelavr
 board             = reprap_rambo
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+monitor_speed     = 250000
 
 #
 # FYSETC F6 V1.3
 #
-[env:fysetc_f6_13]
-extends           = env:megaatmega2560
+[env:FYSETC_F6_13]
+platform          = atmelavr
 board             = fysetc_f6_13
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+monitor_speed     = 250000
 
 #
 # Sanguinololu (ATmega644p)
@@ -101,14 +116,23 @@ monitor_speed = 250000
 # Sanguinololu (ATmega1284p)
 #
 [env:sanguino_atmega1284p]
-extends       = env:sanguino_atmega644p
+platform      = atmelavr
 board         = sanguino_atmega1284p
+lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+monitor_speed = 250000
 
 #
 # Melzi and clones (ATmega1284p)
 #
 [env:melzi]
-extends       = env:sanguino_atmega1284p
+platform      = atmelavr
+board         = sanguino_atmega644p
+lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+monitor_speed = 250000
 build_flags   = ${common.build_flags}
 lib_ignore    = TMCStepper
 upload_speed  = 57600
@@ -117,7 +141,14 @@ upload_speed  = 57600
 # Melzi and clones (Optiboot bootloader)
 #
 [env:melzi_optiboot]
-extends       = env:melzi
+platform      = atmelavr
+board         = sanguino_atmega644p
+lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+monitor_speed = 250000
+build_flags   = ${common.build_flags}
+lib_ignore    = TMCStepper
 upload_speed  = 115200
 
 #
@@ -142,7 +173,12 @@ monitor_speed = 250000
 # - ? 5DPRINT ?
 #
 [env:at90usb1286_dfu]
-extends       = env:at90usb1286_cdc
+platform      = teensy
+board         = at90usb1286
+lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+monitor_speed = 250000
 
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
@@ -157,12 +193,17 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
 
 [env:DUE_USB]
-extends       = env:DUE
+platform      = atmelsam
 board         = dueUSB
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
+monitor_speed = 250000
 
 [env:DUE_debug]
 # Used when WATCHDOG_RESET_MANUAL is enabled
-extends       = env:DUE
+platform      = atmelsam
+board         = due
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
+monitor_speed = 250000
 build_flags   = ${common.build_flags}
   -funwind-tables
   -mpoke-function-name
@@ -190,41 +231,56 @@ lib_deps          = Servo
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 
 [env:LPC1769]
-extends           = env:LPC1768
+platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.2.zip
 board             = nxp_lpc1769
-
-#
-# STM32F1 base
-#
-[env:STM32F1_base]
-platform      = ststm32
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_ignore    = Adafruit NeoPixel, SPI
-monitor_speed = 250000
+build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
+# debug options for backtrace
+#  -funwind-tables
+#  -mpoke-function-name
+lib_ldf_mode      = off
+lib_compat_mode   = strict
+extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
+monitor_speed     = 250000
+lib_deps          = Servo
+  LiquidCrystal
+  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
+  TMCStepper@>=0.6.1,<1.0.0
+  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/release.zip
+  SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 
 #
 # STM32F103RC
 #
-[env:STM32F103RC_base]
-extends           = env:STM32F1_base
+[env:STM32F103RC]
+platform          = ststm32
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
+build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14
+build_unflags     = -std=gnu++11
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
 #
 # STM32F103RC_fysetc
 #
 [env:STM32F103RC_fysetc]
-extends           = env:STM32F103RC_base
+platform          = ststm32
+board             = genericSTM32F103RC
 #board_build.core = maple
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_fysetc.py
+platform_packages = tool-stm32duino
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DDEBUG_LEVEL=0 -DHAVE_SW_SERIAL
+build_unflags     = -std=gnu++11
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_fysetc.py
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
 lib_ldf_mode      = chain
 debug_tool        = stlink
 upload_protocol   = serial
@@ -240,61 +296,114 @@ monitor_speed     = 250000
 #
 
 [env:STM32F103RC_bigtree]
-extends           = env:STM32F103RC_base
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
+platform          = ststm32
+board             = genericSTM32F103RC
+platform_packages = tool-stm32duino
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
+build_unflags     = -std=gnu++11
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
+monitor_speed     = 115200
 
 [env:STM32F103RC_bigtree_USB]
-extends           = env:STM32F103RC_bigtree
+platform          = ststm32
+board             = genericSTM32F103RC
+platform_packages = tool-stm32duino
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DUSE_USB_COMPOSITE
+build_unflags     = -std=gnu++11
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
+monitor_speed     = 115200
 
 [env:STM32F103RC_bigtree_512K]
-extends           = env:STM32F103RC_bigtree
+platform          = ststm32
+board             = genericSTM32F103RC
 board_upload.maximum_size=524288
+platform_packages = tool-stm32duino
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512
+build_unflags     = -std=gnu++11
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
+monitor_speed     = 115200
 
 [env:STM32F103RC_bigtree_512K_USB]
-extends           = env:STM32F103RC_bigtree_512K
+platform          = ststm32
+board             = genericSTM32F103RC
 board_upload.maximum_size=524288
+platform_packages = tool-stm32duino
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512 -DUSE_USB_COMPOSITE
-
-#
-# STM32F103RE_base
-#
-[env:STM32F103RE_base]
-extends           = env:STM32F1_base
-board             = genericSTM32F103RE
-platform_packages = tool-stm32duino
+build_unflags     = -std=gnu++11
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
 monitor_speed     = 115200
 
 #
 # STM32F103RE
 #
 [env:STM32F103RE]
-extends           = env:STM32F103RE_base
+platform          = ststm32
+board             = genericSTM32F103RE
+platform_packages = tool-stm32duino
+build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14
+build_unflags     = -std=gnu++11
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
+monitor_speed     = 115200
 
 #
 #   STM32F103RE_bigtree ............. RET6
 #   STM32F103RE_bigtree_USB ......... RET6 (USB)
 #
 [env:STM32F103RE_bigtree]
-extends           = env:STM32F103RE_base
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
+platform          = ststm32
+board             = genericSTM32F103RE
+platform_packages = tool-stm32duino
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
+build_unflags     = -std=gnu++11
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
 debug_tool        = stlink
 upload_protocol   = stlink
+monitor_speed     = 115200
 
 [env:STM32F103RE_bigtree_USB]
-extends           = env:STM32F103RE_bigtree
+platform          = ststm32
+board             = genericSTM32F103RE
+platform_packages = tool-stm32duino
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DUSE_USB_COMPOSITE
+build_unflags     = -std=gnu++11
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
+debug_tool        = stlink
+upload_protocol   = stlink
+monitor_speed     = 115200
 
 #
 # STM32F4 with STM32GENERIC
@@ -336,58 +445,86 @@ monitor_speed = 250000
 # Longer 3D board in Alfawise U20 (STM32F103VET6)
 #
 [env:STM32F103VE_longer]
-extends       = env:STM32F1_base
+platform      = ststm32
 board         = genericSTM32F103VE
-extra_scripts = buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -USERIAL_USB
   -DSTM32F1xx -DU20 -DTS_V12
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
+extra_scripts = buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI
+monitor_speed = 250000
 
 #
 # MKS Robin (STM32F103ZET6)
 #
 [env:mks_robin]
-extends       = env:STM32F1_base
+platform      = ststm32
 board         = genericSTM32F103ZE
-extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY
+build_unflags = -std=gnu++11
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_ignore    = Adafruit NeoPixel, SPI
+monitor_speed = 250000
 
 #
 # MKS Robin Lite/Lite2 (STM32F103RCT6)
 #
 [env:mks_robin_lite]
-extends       = env:STM32F1_base
+platform      = ststm32
 board         = genericSTM32F103RC
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite.py
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_ignore    = Adafruit NeoPixel, SPI
+monitor_speed = 250000
 
 #
 # MKS Robin Mini (STM32F103VET6)
 #
 [env:mks_robin_mini]
-extends       = env:STM32F1_base
+platform      = ststm32
 board         = genericSTM32F103VE
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_ignore    = Adafruit NeoPixel, SPI
+monitor_speed = 250000
 
 #
 # MKS Robin Nano (STM32F103VET6)
 #
 [env:mks_robin_nano]
-extends       = env:STM32F1_base
+platform      = ststm32
 board         = genericSTM32F103VE
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_ignore    = Adafruit NeoPixel, SPI
+monitor_speed = 250000
 
 #
 # JGAurora A5S A1 (STM32F103ZET6)
 #
 [env:jgaurora_a5s_a1]
-extends       = env:STM32F1_base
+platform      = ststm32
 board         = genericSTM32F103ZE
-extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DSTM32F1xx -std=gnu++14 -DSTM32_XL_DENSITY
+build_unflags = -std=gnu++11
+extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_ignore    = Adafruit NeoPixel, SPI
+monitor_speed = 250000
 
 #
 # Malyan M200 (STM32F103CB)
@@ -404,39 +541,35 @@ lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-H
 # Chitu boards like Tronxy X5s (STM32F103ZET6)
 #
 [env:chitu_f103]
-extends       = env:STM32F1_base
+platform      = ststm32
 board         = genericSTM32F103ZE
-extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DSTM32F1xx -std=gnu++14 -DSTM32_XL_DENSITY
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG= -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
+extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_ignore    = Adafruit NeoPixel
-
-#
-# STM32 HAL environments
-#
-[env:STM32_hal]
-platform      = ststm32
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
 #
 # FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
-extends           = env:STM32_hal
+platform          = ststm32
 board             = fysetc_s6
-extra_scripts     = buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
+platform_packages = tool-stm32duino
 build_flags       = ${common.build_flags}
   -DTARGET_STM32F4 -std=gnu++14
   -DVECT_TAB_OFFSET=0x10000
   -DUSBCON -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED -DUSBD_VID=0x0483 '-DUSB_PRODUCT="FYSETC_S6"'
+build_unflags     = -std=gnu++11
+extra_scripts     = buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 lib_ignore        = Arduino-L6470
-platform_packages = tool-stm32duino
 debug_tool        = stlink
 #upload_protocol   = stlink
 upload_protocol   = serial
+monitor_speed     = 250000
 
 #
 # STM32F407VET6 with RAMPS-like shield
@@ -444,29 +577,33 @@ upload_protocol   = serial
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
-extends           = env:STM32_hal
-platform_packages = framework-arduinoststm32@>=3.10700.191028
+platform          = ststm32
 board             = blackSTM32F407VET6
-extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+platform_packages = framework-arduinoststm32@>=3.10700.191028
 build_flags       = ${common.build_flags}
  -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
   -IMarlin/src/HAL/HAL_STM32
+build_unflags     = -std=gnu++11
+extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed     = 250000
 
 #
 # Bigtreetech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
-extends           = env:STM32_hal
-platform_packages = framework-arduinoststm32@>=3.10700.191028
+platform          = ststm32
 board             = BigTree_SKR_Pro
-extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+platform_packages = framework-arduinoststm32@>=3.10700.191028
 build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
   -DHAVE_HWSERIAL6
   -IMarlin/src/HAL/HAL_STM32
+build_unflags     = -std=gnu++11
+extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_deps          =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal
@@ -475,15 +612,15 @@ lib_deps          =
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
 lib_ignore        = SoftwareSerial, SoftwareSerialM
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed     = 250000
 
 #
 # Bigtreetech SKR BTT002 (STM32F407VET6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
-extends       = env:STM32_hal
-platform      = ststm32@5.6.0
+platform          = ststm32@5.6.0
 board         = BigTree_Btt002
-extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags   = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407VE\"
   -DTARGET_STM32F4 -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
@@ -491,7 +628,11 @@ build_flags   = ${common.build_flags}
   -DHAVE_HWSERIAL3
   -DPIN_SERIAL2_RX=PD_6
   -DPIN_SERIAL2_TX=PD_5
+build_unflags     = -std=gnu++11
+extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 lib_ignore    = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed     = 250000
 
 #
 # Teensy 3.1 / 3.2 (ARM Cortex-M4)
@@ -509,9 +650,13 @@ monitor_speed = 250000
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #
 [env:teensy35]
-extends       = env:teensy31
+platform      = teensy
 board         = teensy35
+lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
+monitor_speed = 250000
 
 #
 # Espressif ESP32

commit 102c9595f280ac016aad849e9ae32c21f36091f5
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Dec 1 13:42:00 2019 -0600

    Restore STM32F103RE environment

diff --git a/platformio.ini b/platformio.ini
index 28ed229f8a..57d72e6bd4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -216,19 +216,6 @@ lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 monitor_speed     = 115200
 
-#
-# STM32F103RE_base
-#
-[env:STM32F103RE_base]
-extends           = env:STM32F1_base
-board             = genericSTM32F103RE
-platform_packages = tool-stm32duino
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-debug_tool        = stlink
-upload_protocol   = stlink
-monitor_speed     = 115200
-
 #
 # STM32F103RC_fysetc
 #
@@ -250,8 +237,6 @@ monitor_speed     = 250000
 #   STM32F103RC_bigtree_USB ......... RCT6 with 256K (USB)
 #   STM32F103RC_bigtree_512K ........ RCT6 with 512K
 #   STM32F103RC_bigtree_512K_USB .... RCT6 with 512K (USB)
-#   STM32F103RE_bigtree ............. RET6
-#   STM32F103RE_bigtree_USB ......... RET6 (USB)
 #
 
 [env:STM32F103RC_bigtree]
@@ -277,11 +262,34 @@ board_upload.maximum_size=524288
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512 -DUSE_USB_COMPOSITE
 
+#
+# STM32F103RE_base
+#
+[env:STM32F103RE_base]
+extends           = env:STM32F1_base
+board             = genericSTM32F103RE
+platform_packages = tool-stm32duino
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+monitor_speed     = 115200
+
+#
+# STM32F103RE
+#
+[env:STM32F103RE]
+extends           = env:STM32F103RE_base
+
+#
+#   STM32F103RE_bigtree ............. RET6
+#   STM32F103RE_bigtree_USB ......... RET6 (USB)
+#
 [env:STM32F103RE_bigtree]
 extends           = env:STM32F103RE_base
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
+debug_tool        = stlink
+upload_protocol   = stlink
 
 [env:STM32F103RE_bigtree_USB]
 extends           = env:STM32F103RE_bigtree

commit efc38731495daefae2553ae4866c7d2deea00492
Author: Gustavo Alvarez <462213+sl1pkn07@users.noreply.github.com>
Date:   Sun Dec 1 20:17:45 2019 +0100

    Reorder F103RE environments (#16054)

diff --git a/platformio.ini b/platformio.ini
index fb0697555a..28ed229f8a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -217,16 +217,17 @@ lib_deps          = ${common.lib_deps}
 monitor_speed     = 115200
 
 #
-# STM32F103RE
+# STM32F103RE_base
 #
-[env:STM32F103RE]
-extends         = env:STM32F1_base
-board           = genericSTM32F103RE
-build_flags     = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14 -DDEBUG_LEVEL=0
-src_filter      = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-debug_tool      = stlink
-upload_protocol = stlink
+[env:STM32F103RE_base]
+extends           = env:STM32F1_base
+board             = genericSTM32F103RE
+platform_packages = tool-stm32duino
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+debug_tool        = stlink
+upload_protocol   = stlink
+monitor_speed     = 115200
 
 #
 # STM32F103RC_fysetc
@@ -277,22 +278,15 @@ build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512 -DUSE_USB_COMPOSITE
 
 [env:STM32F103RE_bigtree]
-extends           = env:STM32F1_base
-board             = genericSTM32F103RE
-board_upload.maximum_size=524288
-platform_packages = tool-stm32duino
+extends           = env:STM32F103RE_base
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-monitor_speed     = 115200
 
 [env:STM32F103RE_bigtree_USB]
 extends           = env:STM32F103RE_bigtree
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DUSE_USB_COMPOSITE
 
 #
 # STM32F4 with STM32GENERIC
@@ -354,7 +348,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY
 
 #
-# MKS ROBIN LITE/LITE2 (STM32F103RCT6)
+# MKS Robin Lite/Lite2 (STM32F103RCT6)
 #
 [env:mks_robin_lite]
 extends       = env:STM32F1_base
@@ -475,7 +469,7 @@ lib_deps          =
 lib_ignore        = SoftwareSerial, SoftwareSerialM
 
 #
-# BIGTREE_SKR_BTT002 (STM32F407VET6 ARM Cortex-M4)
+# Bigtreetech SKR BTT002 (STM32F407VET6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
 extends       = env:STM32_hal

commit 8431af2bff8bb01eb62a10f6da6b2476680dd841
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Nov 29 22:56:59 2019 -0600

    Add -fmerge-all-constants flag

diff --git a/platformio.ini b/platformio.ini
index 7bd88b0a26..fb0697555a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -23,7 +23,7 @@ default_envs = megaatmega2560
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
-build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__
+build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__ -fmerge-all-constants
 lib_deps =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal@1.3.4
@@ -109,7 +109,7 @@ board         = sanguino_atmega1284p
 #
 [env:melzi]
 extends       = env:sanguino_atmega1284p
-build_flags   = ${common.build_flags} -fmerge-all-constants
+build_flags   = ${common.build_flags}
 lib_ignore    = TMCStepper
 upload_speed  = 57600
 

commit 3a88cfd9920b0ef2a6be3824391141b1bb68ff9b
Author: Bj√∂rn Wedi <bjoern.wedi@sky.de>
Date:   Fri Nov 29 12:05:46 2019 +0100

    Simplify platformio.ini with 'extends' (#16035)
    
    - Add [env] with default settings
    - Use 'extends' to shrink similar env entries

diff --git a/platformio.ini b/platformio.ini
index 2ad1bb9a3a..7bd88b0a26 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -36,6 +36,13 @@ lib_deps =
   SailfishRGB_LED=https://github.com/mikeshub/SailfishRGB_LED/archive/master.zip
   SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
 
+# Globally defined properties
+# inherited by all environments
+[env]
+framework   = arduino
+build_flags = ${common.build_flags}
+lib_deps    = ${common.lib_deps}
+
 #################################
 #                               #
 #   Unique Core Architectures   #
@@ -51,9 +58,7 @@ lib_deps =
 #
 [env:megaatmega2560]
 platform          = atmelavr
-framework         = arduino
 board             = megaatmega2560
-build_flags       = ${common.build_flags}
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
@@ -64,15 +69,56 @@ monitor_speed     = 250000
 # ATmega1280
 #
 [env:megaatmega1280]
-platform          = atmelavr
-framework         = arduino
+extends           = env:megaatmega2560
 board             = megaatmega1280
-build_flags       = ${common.build_flags}
-board_build.f_cpu = 16000000L
-lib_deps          = ${common.lib_deps}
+
+#
+# RAMBo
+#
+[env:rambo]
+extends           = env:megaatmega2560
+board             = reprap_rambo
+
+#
+# FYSETC F6 V1.3
+#
+[env:fysetc_f6_13]
+extends           = env:megaatmega2560
+board             = fysetc_f6_13
+
+#
+# Sanguinololu (ATmega644p)
+#
+[env:sanguino_atmega644p]
+platform      = atmelavr
+board         = sanguino_atmega644p
+lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed     = 250000
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+monitor_speed = 250000
+
+#
+# Sanguinololu (ATmega1284p)
+#
+[env:sanguino_atmega1284p]
+extends       = env:sanguino_atmega644p
+board         = sanguino_atmega1284p
+
+#
+# Melzi and clones (ATmega1284p)
+#
+[env:melzi]
+extends       = env:sanguino_atmega1284p
+build_flags   = ${common.build_flags} -fmerge-all-constants
+lib_ignore    = TMCStepper
+upload_speed  = 57600
+
+#
+# Melzi and clones (Optiboot bootloader)
+#
+[env:melzi_optiboot]
+extends       = env:melzi
+upload_speed  = 115200
 
 #
 # AT90USB1286 boards using CDC bootloader
@@ -83,9 +129,7 @@ monitor_speed     = 250000
 #
 [env:at90usb1286_cdc]
 platform      = teensy
-framework     = arduino
 board         = at90usb1286
-build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
@@ -98,14 +142,7 @@ monitor_speed = 250000
 # - ? 5DPRINT ?
 #
 [env:at90usb1286_dfu]
-platform      = teensy
-framework     = arduino
-board         = at90usb1286
-build_flags   = ${common.build_flags}
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
+extends       = env:at90usb1286_cdc
 
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
@@ -115,38 +152,26 @@ monitor_speed = 250000
 #
 [env:DUE]
 platform      = atmelsam
-framework     = arduino
 board         = due
-build_flags   = ${common.build_flags}
-lib_deps      = ${common.lib_deps}
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
+
 [env:DUE_USB]
-platform      = atmelsam
-framework     = arduino
+extends       = env:DUE
 board         = dueUSB
-build_flags   = ${common.build_flags}
-lib_deps      = ${common.lib_deps}
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
-monitor_speed = 250000
+
 [env:DUE_debug]
 # Used when WATCHDOG_RESET_MANUAL is enabled
-platform      = atmelsam
-framework     = arduino
-board         = due
+extends       = env:DUE
 build_flags   = ${common.build_flags}
   -funwind-tables
   -mpoke-function-name
-lib_deps      = ${common.lib_deps}
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
-monitor_speed = 250000
 
 #
 # NXP LPC176x ARM Cortex-M3
 #
 [env:LPC1768]
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.2.zip
-framework         = arduino
 board             = nxp_lpc1768
 build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
 # debug options for backtrace
@@ -169,113 +194,53 @@ extends           = env:LPC1768
 board             = nxp_lpc1769
 
 #
-# Sanguinololu (ATmega644p)
-#
-[env:sanguino_atmega644p]
-platform      = atmelavr
-framework     = arduino
-board         = sanguino_atmega644p
-build_flags   = ${common.build_flags}
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
-
-#
-# Sanguinololu (ATmega1284p)
-#
-[env:sanguino_atmega1284p]
-platform      = atmelavr
-framework     = arduino
-board         = sanguino_atmega1284p
-build_flags   = ${common.build_flags}
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
-
+# STM32F1 base
 #
-# Melzi and clones (ATmega1284p)
-#
-[env:melzi]
-platform      = atmelavr
-framework     = arduino
-board         = sanguino_atmega1284p
-build_flags   = ${common.build_flags} -fmerge-all-constants
-upload_speed  = 57600
-lib_deps      = ${common.lib_deps}
-lib_ignore    = TMCStepper
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
-
-#
-# Melzi and clones (Optiboot bootloader)
-#
-[env:melzi_optiboot]
-platform      = atmelavr
-framework     = arduino
-board         = sanguino_atmega1284p
-build_flags   = ${common.build_flags}
-upload_speed  = 115200
-lib_deps      = ${common.lib_deps}
-lib_ignore    = TMCStepper
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+[env:STM32F1_base]
+platform      = ststm32
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_ignore    = Adafruit NeoPixel, SPI
 monitor_speed = 250000
 
 #
-# RAMBo
+# STM32F103RC
 #
-[env:rambo]
-platform          = atmelavr
-framework         = arduino
-board             = reprap_rambo
-build_flags       = ${common.build_flags}
-board_build.f_cpu = 16000000L
+[env:STM32F103RC_base]
+extends           = env:STM32F1_base
+board             = genericSTM32F103RC
+platform_packages = tool-stm32duino
 lib_deps          = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed     = 250000
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+monitor_speed     = 115200
 
 #
 # STM32F103RE
 #
 [env:STM32F103RE]
-platform      = ststm32
-framework     = arduino
-board         = genericSTM32F103RE
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-  -DDEBUG_LEVEL=0
-build_unflags = -std=gnu++11
-lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, SPI
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-monitor_speed = 250000
-debug_tool    = stlink
+extends         = env:STM32F1_base
+board           = genericSTM32F103RE
+build_flags     = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -std=gnu++14 -DDEBUG_LEVEL=0
+src_filter      = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+debug_tool      = stlink
 upload_protocol = stlink
 
 #
 # STM32F103RC_fysetc
 #
 [env:STM32F103RC_fysetc]
-platform          = ststm32
-framework         = arduino
-board             = genericSTM32F103RC
+extends           = env:STM32F103RC_base
 #board_build.core = maple
-platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_fysetc.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-  -DDEBUG_LEVEL=0 -DHAVE_SW_SERIAL
-build_unflags     = -std=gnu++11
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
+  ${common.build_flags} -std=gnu++14 -DDEBUG_LEVEL=0 -DHAVE_SW_SERIAL
 lib_ldf_mode      = chain
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-monitor_speed     = 250000
 debug_tool        = stlink
 upload_protocol   = serial
+monitor_speed     = 250000
 
 #
 # BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
@@ -289,143 +254,64 @@ upload_protocol   = serial
 #
 
 [env:STM32F103RC_bigtree]
-platform          = ststm32
-framework         = arduino
-board             = genericSTM32F103RC
-platform_packages = tool-stm32duino
+extends           = env:STM32F103RC_base
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
-build_unflags     = -std=gnu++11
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-monitor_speed     = 115200
 
 [env:STM32F103RC_bigtree_USB]
-platform          = ststm32
-framework         = arduino
-board             = genericSTM32F103RC
-platform_packages = tool-stm32duino
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
+extends           = env:STM32F103RC_bigtree
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4
-build_unflags     = -std=gnu++11
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-monitor_speed     = 115200
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DUSE_USB_COMPOSITE
 
 [env:STM32F103RC_bigtree_512K]
-platform          = ststm32
-framework         = arduino
-board             = genericSTM32F103RC
+extends           = env:STM32F103RC_bigtree
 board_upload.maximum_size=524288
-platform_packages = tool-stm32duino
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512
-build_unflags     = -std=gnu++11
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-monitor_speed     = 115200
 
 [env:STM32F103RC_bigtree_512K_USB]
-platform          = ststm32
-framework         = arduino
-board             = genericSTM32F103RC
+extends           = env:STM32F103RC_bigtree_512K
 board_upload.maximum_size=524288
-platform_packages = tool-stm32duino
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512
-build_unflags     = -std=gnu++11
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-monitor_speed     = 115200
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512 -DUSE_USB_COMPOSITE
 
 [env:STM32F103RE_bigtree]
-platform          = ststm32
-framework         = arduino
+extends           = env:STM32F1_base
 board             = genericSTM32F103RE
 board_upload.maximum_size=524288
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
-build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
 
 [env:STM32F103RE_bigtree_USB]
-platform          = ststm32
-framework         = arduino
-board             = genericSTM32F103RE
-board_upload.maximum_size=524288
-platform_packages = tool-stm32duino
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
+extends           = env:STM32F103RE_bigtree
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4
-build_unflags     = -std=gnu++11
-lib_deps          = ${common.lib_deps}
-  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel, SPI
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-monitor_speed     = 115200
 
 #
 # STM32F4 with STM32GENERIC
 #
 [env:STM32F4]
 platform      = ststm32
-framework     = arduino
 board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
-lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F7>
 monitor_speed = 250000
 
-#
-# FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
-#
-[env:FYSETC_S6]
-platform          = ststm32
-framework         = arduino
-board             = fysetc_s6
-extra_scripts     = buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
-build_flags       = ${common.build_flags}
-  -DTARGET_STM32F4 -std=gnu++14
-  -DVECT_TAB_OFFSET=0x10000
-  -DUSBCON -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED -DUSBD_VID=0x0483 '-DUSB_PRODUCT="FYSETC_S6"'
-build_unflags     = -std=gnu++11
-lib_deps          = ${common.lib_deps}
-lib_ignore        = Arduino-L6470
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed     = 250000
-platform_packages = tool-stm32duino
-debug_tool        = stlink
-#upload_protocol   = stlink
-upload_protocol   = serial
-
 #
 # STM32F7 with STM32GENERIC
 #
 [env:STM32F7]
 platform      = ststm32
-framework     = arduino
 board         = remram_v1
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
-lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F4>
 monitor_speed = 250000
@@ -435,13 +321,11 @@ monitor_speed = 250000
 #
 [env:ARMED]
 platform      = ststm32
-framework     = arduino
 board         = armed_v1
 build_flags   = ${common.build_flags}
   -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DUSBD_USE_CDC
   -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
   -IMarlin/src/HAL/HAL_STM32
-lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, SoftwareSerial
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
@@ -450,103 +334,115 @@ monitor_speed = 250000
 # Longer 3D board in Alfawise U20 (STM32F103VET6)
 #
 [env:STM32F103VE_longer]
-platform      = ststm32
-framework     = arduino
+extends       = env:STM32F1_base
 board         = genericSTM32F103VE
-monitor_speed = 250000
 extra_scripts = buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -USERIAL_USB
   -DSTM32F1xx -DU20 -DTS_V12
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI
 
 #
 # MKS Robin (STM32F103ZET6)
 #
 [env:mks_robin]
-platform      = ststm32
-framework     = arduino
+extends       = env:STM32F1_base
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # MKS ROBIN LITE/LITE2 (STM32F103RCT6)
 #
 [env:mks_robin_lite]
-platform      = ststm32
-framework     = arduino
+extends       = env:STM32F1_base
 board         = genericSTM32F103RC
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # MKS Robin Mini (STM32F103VET6)
 #
 [env:mks_robin_mini]
-platform      = ststm32
-framework     = arduino
+extends       = env:STM32F1_base
 board         = genericSTM32F103VE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # MKS Robin Nano (STM32F103VET6)
 #
 [env:mks_robin_nano]
-platform      = ststm32
-framework     = arduino
+extends       = env:STM32F1_base
 board         = genericSTM32F103VE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # JGAurora A5S A1 (STM32F103ZET6)
 #
 [env:jgaurora_a5s_a1]
-platform      = ststm32
-framework     = arduino
+extends       = env:STM32F1_base
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DSTM32F1xx -std=gnu++14 -DSTM32_XL_DENSITY
+
+#
+# Malyan M200 (STM32F103CB)
+#
+[env:STM32F103CB_malyan]
+platform    = ststm32
+board       = malyanM200
+build_flags = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
+  -DDEBUG_LEVEL=0 -D__MARLIN_FIRMWARE__
+src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SPI
+
+#
+# Chitu boards like Tronxy X5s (STM32F103ZET6)
+#
+[env:chitu_f103]
+extends       = env:STM32F1_base
+board         = genericSTM32F103ZE
+extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -DSTM32F1xx -std=gnu++14 -DSTM32_XL_DENSITY
+build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG= -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
+lib_ignore    = Adafruit NeoPixel
+
+#
+# STM32 HAL environments
+#
+[env:STM32_hal]
+platform      = ststm32
 build_unflags = -std=gnu++11
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, SPI
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
+#
+# FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
+#
+[env:FYSETC_S6]
+extends           = env:STM32_hal
+board             = fysetc_s6
+extra_scripts     = buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
+build_flags       = ${common.build_flags}
+  -DTARGET_STM32F4 -std=gnu++14
+  -DVECT_TAB_OFFSET=0x10000
+  -DUSBCON -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED -DUSBD_VID=0x0483 '-DUSB_PRODUCT="FYSETC_S6"'
+lib_ignore        = Arduino-L6470
+platform_packages = tool-stm32duino
+debug_tool        = stlink
+#upload_protocol   = stlink
+upload_protocol   = serial
+
 #
 # STM32F407VET6 with RAMPS-like shield
 # 'Black' STM32F407VET6 board - http://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
-platform          = ststm32
-framework         = arduino
+extends           = env:STM32_hal
 platform_packages = framework-arduinoststm32@>=3.10700.191028
 board             = blackSTM32F407VET6
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
@@ -554,17 +450,13 @@ build_flags       = ${common.build_flags}
  -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
   -IMarlin/src/HAL/HAL_STM32
-lib_deps          = ${common.lib_deps}
 lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed     = 250000
 
 #
 # Bigtreetech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
-platform          = ststm32
-framework         = arduino
+extends           = env:STM32_hal
 platform_packages = framework-arduinoststm32@>=3.10700.191028
 board             = BigTree_SKR_Pro
 extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
@@ -581,15 +473,13 @@ lib_deps          =
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
 lib_ignore        = SoftwareSerial, SoftwareSerialM
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed     = 250000
 
 #
 # BIGTREE_SKR_BTT002 (STM32F407VET6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
+extends       = env:STM32_hal
 platform      = ststm32@5.6.0
-framework     = arduino
 board         = BigTree_Btt002
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags   = ${common.build_flags}
@@ -599,65 +489,27 @@ build_flags   = ${common.build_flags}
   -DHAVE_HWSERIAL3
   -DPIN_SERIAL2_RX=PD_6
   -DPIN_SERIAL2_TX=PD_5
-lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed = 250000
 
 #
 # Teensy 3.1 / 3.2 (ARM Cortex-M4)
 #
 [env:teensy31]
 platform      = teensy
-framework     = arduino
 board         = teensy31
-build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY31_32>
 monitor_speed = 250000
 
-#
-# Malyan M200 (STM32F103CB)
-#
-[env:STM32F103CB_malyan]
-platform    = ststm32
-framework   = arduino
-board       = malyanM200
-build_flags = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
-  -DDEBUG_LEVEL=0 -D__MARLIN_FIRMWARE__
-src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SPI
-
-#
-# Chitu boards like Tronxy X5s (STM32F103ZET6)
-#
-[env:chitu_f103]
-platform      = ststm32
-framework     = arduino
-board         = genericSTM32F103ZE
-extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DSTM32F1xx -std=gnu++14 -DSTM32_XL_DENSITY
-build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG= -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel
-
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #
 [env:teensy35]
-platform      = teensy
-framework     = arduino
+extends       = env:teensy31
 board         = teensy35
-build_flags   = ${common.build_flags}
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
-monitor_speed = 250000
 
 #
 # Espressif ESP32
@@ -665,7 +517,6 @@ monitor_speed = 250000
 [env:esp32]
 platform      = espressif32
 board         = esp32dev
-framework     = arduino
 upload_speed  = 115200
 monitor_speed = 115200
 upload_port   = /dev/ttyUSB0
@@ -675,26 +526,13 @@ lib_deps      =
 lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
 
-#
-# FYSETC F6 V1.3
-#
-[env:fysetc_f6_13]
-platform          = atmelavr
-framework         = arduino
-board             = fysetc_f6_13
-build_flags       = ${common.build_flags}
-board_build.f_cpu = 16000000L
-lib_deps          = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed     = 250000
-
 #
 # Native
 # No supported Arduino libraries, base Marlin only
 #
 [env:linux_native]
 platform        = native
+framework       =
 build_flags     = -D__PLAT_LINUX__ -std=gnu++17 -ggdb -g -lrt -lpthread -D__MARLIN_FIRMWARE__ -Wno-expansion-to-defined
 src_build_flags = -Wall -IMarlin/src/HAL/HAL_LINUX/include
 build_unflags   = -Wall
@@ -709,11 +547,9 @@ src_filter      = ${common.default_src_filter} +<src/HAL/HAL_LINUX>
 [env:SAMD51_grandcentral_m4]
 platform      = atmelsam
 board         = adafruit_grandcentral_m4
-framework     = arduino
 build_flags   = ${common.build_flags} -std=gnu++17
 extra_scripts = ${common.extra_scripts}
 build_unflags = -std=gnu++11
-lib_deps      = ${common.lib_deps}
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_SAMD51>
 debug_tool    = jlink
 
@@ -722,7 +558,6 @@ debug_tool    = jlink
 #
 [env:include_tree]
 platform    = atmelavr
-framework   = arduino
 board       = megaatmega2560
 build_flags = -c -H -std=gnu++11 -Wall -Os -D__MARLIN_FIRMWARE__
 lib_deps    = ${common.lib_deps}

commit cf1e19d167f8dcb1a7b077922249cc8e4627ad88
Author: George Fu <nailao_5918@163.com>
Date:   Wed Nov 27 06:15:03 2019 +0800

    Fysetc S6 support (#15850)

diff --git a/platformio.ini b/platformio.ini
index 37b6352d16..2ad1bb9a3a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -395,6 +395,28 @@ lib_ignore    = Adafruit NeoPixel, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F7>
 monitor_speed = 250000
 
+#
+# FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
+#
+[env:FYSETC_S6]
+platform          = ststm32
+framework         = arduino
+board             = fysetc_s6
+extra_scripts     = buildroot/share/PlatformIO/scripts/fysetc_STM32S6.py
+build_flags       = ${common.build_flags}
+  -DTARGET_STM32F4 -std=gnu++14
+  -DVECT_TAB_OFFSET=0x10000
+  -DUSBCON -DUSBD_USE_CDC -DHAL_PCD_MODULE_ENABLED -DUSBD_VID=0x0483 '-DUSB_PRODUCT="FYSETC_S6"'
+build_unflags     = -std=gnu++11
+lib_deps          = ${common.lib_deps}
+lib_ignore        = Arduino-L6470
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed     = 250000
+platform_packages = tool-stm32duino
+debug_tool        = stlink
+#upload_protocol   = stlink
+upload_protocol   = serial
+
 #
 # STM32F7 with STM32GENERIC
 #
@@ -412,7 +434,7 @@ monitor_speed = 250000
 # ARMED (STM32)
 #
 [env:ARMED]
-platform      = ststm32@>=5.7.0
+platform      = ststm32
 framework     = arduino
 board         = armed_v1
 build_flags   = ${common.build_flags}
@@ -523,7 +545,7 @@ monitor_speed = 250000
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
-platform          = ststm32@>=5.7.0
+platform          = ststm32
 framework         = arduino
 platform_packages = framework-arduinoststm32@>=3.10700.191028
 board             = blackSTM32F407VET6
@@ -541,7 +563,7 @@ monitor_speed     = 250000
 # Bigtreetech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
-platform          = ststm32@>=5.7.0
+platform          = ststm32
 framework         = arduino
 platform_packages = framework-arduinoststm32@>=3.10700.191028
 board             = BigTree_SKR_Pro
@@ -600,7 +622,7 @@ monitor_speed = 250000
 # Malyan M200 (STM32F103CB)
 #
 [env:STM32F103CB_malyan]
-platform    = ststm32@>=5.7.0
+platform    = ststm32
 framework   = arduino
 board       = malyanM200
 build_flags = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections

commit f786cc5145ddccdae02c29b0ccda315c86c159d9
Author: thisiskeithb <13375512+thisiskeithb@users.noreply.github.com>
Date:   Tue Nov 26 02:28:13 2019 -0800

    Revert default BTT STM32F103 environment (#16006)

diff --git a/platformio.ini b/platformio.ini
index 4256b1c67e..37b6352d16 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -280,12 +280,12 @@ upload_protocol   = serial
 #
 # BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
 #
-#   STM32F103RC_bigtree .............. RCT6 with 256K
-#   STM32F103RC_bigtree_NOUSB ........ RCT6 with 256K (no USB)
-#   STM32F103RC_bigtree_512K.......... RCT6 with 512K
-#   STM32F103RC_bigtree_512K_NOUSB ... RCT6 with 512K (no USB)
-#   STM32F103RE_bigtree .............. RET6
-#   STM32F103RE_bigtree_NOUSB ........ RET6 (no USB)
+#   STM32F103RC_bigtree ............. RCT6 with 256K
+#   STM32F103RC_bigtree_USB ......... RCT6 with 256K (USB)
+#   STM32F103RC_bigtree_512K ........ RCT6 with 512K
+#   STM32F103RC_bigtree_512K_USB .... RCT6 with 512K (USB)
+#   STM32F103RE_bigtree ............. RET6
+#   STM32F103RE_bigtree_USB ......... RET6 (USB)
 #
 
 [env:STM32F103RC_bigtree]
@@ -295,7 +295,7 @@ board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=256
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
@@ -303,14 +303,14 @@ lib_ignore        = Adafruit NeoPixel, SPI
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
 
-[env:STM32F103RC_bigtree_NOUSB]
+[env:STM32F103RC_bigtree_USB]
 platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
@@ -326,7 +326,7 @@ board_upload.maximum_size=524288
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
@@ -334,7 +334,7 @@ lib_ignore        = Adafruit NeoPixel, SPI
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
 
-[env:STM32F103RC_bigtree_512K_NOUSB]
+[env:STM32F103RC_bigtree_512K_USB]
 platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
@@ -342,7 +342,7 @@ board_upload.maximum_size=524288
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
@@ -358,7 +358,7 @@ board_upload.maximum_size=524288
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
@@ -366,7 +366,7 @@ lib_ignore        = Adafruit NeoPixel, SPI
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
 
-[env:STM32F103RE_bigtree_NOUSB]
+[env:STM32F103RE_bigtree_USB]
 platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RE
@@ -374,7 +374,7 @@ board_upload.maximum_size=524288
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip

commit e7519c50b6e2885405fc0f19b73360fa313cb3e3
Author: Bob <bob808@users.noreply.github.com>
Date:   Tue Nov 26 11:23:51 2019 +0200

    Include MAX31865 library (#15969)

diff --git a/platformio.ini b/platformio.ini
index 6397b7eaff..4256b1c67e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -29,6 +29,7 @@ lib_deps =
   LiquidCrystal@1.3.4
   TMCStepper@>=0.5.2,<1.0.0
   Adafruit NeoPixel@1.2.5
+  Adafruit_MAX31865=https://github.com/adafruit/Adafruit_MAX31865/archive/master.zip
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip

commit 48e264e4e1e5ff37638e65366fd4d55e9d92d4c6
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Sat Nov 23 18:43:12 2019 +0000

    Update platformio.ini (env:LPC176x) (#15971)

diff --git a/platformio.ini b/platformio.ini
index aa8c555fdf..6397b7eaff 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -159,28 +159,13 @@ monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  TMCStepper=https://github.com/p3p/TMCStepper/archive/pr_lpctimingfix.zip
+  TMCStepper@>=0.6.1,<1.0.0
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/release.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 
 [env:LPC1769]
-platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.2.zip
-framework         = arduino
+extends           = env:LPC1768
 board             = nxp_lpc1769
-build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
-# debug options for backtrace
-#  -funwind-tables
-#  -mpoke-function-name
-lib_ldf_mode      = off
-lib_compat_mode   = strict
-extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
-src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
-monitor_speed     = 250000
-lib_deps          = Servo
-  LiquidCrystal
-  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  TMCStepper=https://github.com/p3p/TMCStepper/archive/pr_lpctimingfix.zip
-  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/release.zip
 
 #
 # Sanguinololu (ATmega644p)

commit b2a275891c5f6f9af0170ae24084ab9dd598651a
Author: Gustavo Alvarez <462213+sl1pkn07@users.noreply.github.com>
Date:   Thu Nov 21 12:09:01 2019 +0100

    Support RET6 in BTT SKR Mini (#15957)

diff --git a/platformio.ini b/platformio.ini
index 633afb5964..aa8c555fdf 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -298,6 +298,8 @@ upload_protocol   = serial
 #   STM32F103RC_bigtree_NOUSB ........ RCT6 with 256K (no USB)
 #   STM32F103RC_bigtree_512K.......... RCT6 with 512K
 #   STM32F103RC_bigtree_512K_NOUSB ... RCT6 with 512K (no USB)
+#   STM32F103RE_bigtree .............. RET6
+#   STM32F103RE_bigtree_NOUSB ........ RET6 (no USB)
 #
 
 [env:STM32F103RC_bigtree]
@@ -362,6 +364,38 @@ lib_ignore        = Adafruit NeoPixel, SPI
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
 
+[env:STM32F103RE_bigtree]
+platform          = ststm32
+framework         = arduino
+board             = genericSTM32F103RE
+board_upload.maximum_size=524288
+platform_packages = tool-stm32duino
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
+build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4
+build_unflags     = -std=gnu++11
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+monitor_speed     = 115200
+
+[env:STM32F103RE_bigtree_NOUSB]
+platform          = ststm32
+framework         = arduino
+board             = genericSTM32F103RE
+board_upload.maximum_size=524288
+platform_packages = tool-stm32duino
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RE_SKR_E3_DIP.py
+build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
+build_unflags     = -std=gnu++11
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+monitor_speed     = 115200
+
 #
 # STM32F4 with STM32GENERIC
 #

commit e9bd6ef9fea8cac2770c98b8f4b1653e7b4368d7
Author: swilkens <stefanwilkens@gmail.com>
Date:   Wed Nov 20 04:06:11 2019 +0100

    TMCStepper 0.6.x is now Marlin-compatible (#15950)

diff --git a/platformio.ini b/platformio.ini
index bf882c1531..633afb5964 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -27,7 +27,7 @@ build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__
 lib_deps =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal@1.3.4
-  TMCStepper@>=0.5.2,<0.6.0
+  TMCStepper@>=0.5.2,<1.0.0
   Adafruit NeoPixel@1.2.5
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip

commit d33ca3d0589c426b9ed855fc9320721e3b7243e1
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Nov 15 17:53:43 2019 -0600

    Only TMCStepper 0.5.x is certified

diff --git a/platformio.ini b/platformio.ini
index f02e97f812..bf882c1531 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -27,7 +27,7 @@ build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__
 lib_deps =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal@1.3.4
-  TMCStepper@>=0.5.0,<1.0.0
+  TMCStepper@>=0.5.2,<0.6.0
   Adafruit NeoPixel@1.2.5
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip

commit 0f57818f2decca8340fd5fc86f9ea7b792d9d802
Author: thisiskeithb <13375512+thisiskeithb@users.noreply.github.com>
Date:   Fri Nov 15 00:51:26 2019 -0800

    Support 512K "RCT6" in BTT SKR Mini (#15890)

diff --git a/platformio.ini b/platformio.ini
index 7801fe9023..f02e97f812 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -294,12 +294,33 @@ upload_protocol   = serial
 #
 # BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
 #
+#   STM32F103RC_bigtree .............. RCT6 with 256K
+#   STM32F103RC_bigtree_NOUSB ........ RCT6 with 256K (no USB)
+#   STM32F103RC_bigtree_512K.......... RCT6 with 512K
+#   STM32F103RC_bigtree_512K_NOUSB ... RCT6 with 512K (no USB)
+#
+
 [env:STM32F103RC_bigtree]
 platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
+build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=256
+build_unflags     = -std=gnu++11
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+monitor_speed     = 115200
+
+[env:STM32F103RC_bigtree_NOUSB]
+platform          = ststm32
+framework         = arduino
+board             = genericSTM32F103RC
+platform_packages = tool-stm32duino
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags     = -std=gnu++11
@@ -309,14 +330,31 @@ lib_ignore        = Adafruit NeoPixel, SPI
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
 
-[env:STM32F103RC_bigtree_USB]
+[env:STM32F103RC_bigtree_512K]
+platform          = ststm32
+framework         = arduino
+board             = genericSTM32F103RC
+board_upload.maximum_size=524288
+platform_packages = tool-stm32duino
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
+build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512
+build_unflags     = -std=gnu++11
+lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
+lib_ignore        = Adafruit NeoPixel, SPI
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+monitor_speed     = 115200
+
+[env:STM32F103RC_bigtree_512K_NOUSB]
 platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
+board_upload.maximum_size=524288
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4 -DSTM32_FLASH_SIZE=512
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip

commit 227951a4ec4f9c5f0d594253465e988918d7d33c
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Nov 13 04:29:15 2019 -0600

    Tweak platformio.ini alignment

diff --git a/platformio.ini b/platformio.ini
index 11db00a6b2..7801fe9023 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -354,16 +354,16 @@ monitor_speed = 250000
 # ARMED (STM32)
 #
 [env:ARMED]
-platform    = ststm32@>=5.7.0
-framework   = arduino
-board       = armed_v1
-build_flags =
-  ${common.build_flags} -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DUSBD_USE_CDC
+platform      = ststm32@>=5.7.0
+framework     = arduino
+board         = armed_v1
+build_flags   = ${common.build_flags}
+  -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DUSBD_USE_CDC
   -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
   -IMarlin/src/HAL/HAL_STM32
-lib_deps    = ${common.lib_deps}
-lib_ignore  = Adafruit NeoPixel, SoftwareSerial
-src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = Adafruit NeoPixel, SoftwareSerial
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
 #
@@ -588,12 +588,12 @@ board         = esp32dev
 framework     = arduino
 upload_speed  = 115200
 monitor_speed = 115200
-upload_port = /dev/ttyUSB0
-lib_deps =
+upload_port   = /dev/ttyUSB0
+lib_deps      =
   AsyncTCP=https://github.com/me-no-dev/AsyncTCP/archive/master.zip
   ESPAsyncWebServer=https://github.com/me-no-dev/ESPAsyncWebServer/archive/master.zip
-lib_ignore  = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED
-src_filter  = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
+lib_ignore    = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
 
 #
 # FYSETC F6 V1.3

commit 9fd35c84ce722c71b6d42b2c618c93ca66f2537f
Author: Jason Smith <jason.inet@gmail.com>
Date:   Tue Nov 12 20:16:54 2019 -0800

    SoftwareSerialM for SKR STM32F1 boards (#15875)

diff --git a/platformio.ini b/platformio.ini
index 5904ee8371..11db00a6b2 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -301,9 +301,10 @@ board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore        = Adafruit NeoPixel, SPI
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
@@ -315,9 +316,10 @@ board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE -DHAVE_SW_SERIAL -DSS_TIMER=4
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore        = Adafruit NeoPixel, SPI
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200

commit 8e7d1004cf33689b189a3b27f9aa1aebc1a74715
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Wed Nov 13 03:59:10 2019 +0000

    Update LPC176x platform version

diff --git a/platformio.ini b/platformio.ini
index 7be03584a0..5904ee8371 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -144,7 +144,7 @@ monitor_speed = 250000
 # NXP LPC176x ARM Cortex-M3
 #
 [env:LPC1768]
-platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.1.zip
+platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.2.zip
 framework         = arduino
 board             = nxp_lpc1768
 build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
@@ -164,7 +164,7 @@ lib_deps          = Servo
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 
 [env:LPC1769]
-platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.1.zip
+platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.2.zip
 framework         = arduino
 board             = nxp_lpc1769
 build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}

commit ac71cdc265374717c067102b2bc22af002c86ee3
Author: Lino Barreca <linobarreca@hotmail.com>
Date:   Wed Nov 13 02:23:02 2019 +0100

    New HardwareTimer for STM32 5.7.0 (#15655)

diff --git a/platformio.ini b/platformio.ini
index 7c038922e4..7be03584a0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -352,12 +352,15 @@ monitor_speed = 250000
 # ARMED (STM32)
 #
 [env:ARMED]
-platform    = ststm32@5.6.0
+platform    = ststm32@>=5.7.0
 framework   = arduino
 board       = armed_v1
-build_flags = ${common.build_flags} -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DHAL_PCD_MODULE_ENABLED -DUSBD_USE_CDC -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
+build_flags =
+  ${common.build_flags} -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DUSBD_USE_CDC
+  -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
+  -IMarlin/src/HAL/HAL_STM32
 lib_deps    = ${common.lib_deps}
-lib_ignore  = Adafruit NeoPixel
+lib_ignore  = Adafruit NeoPixel, SoftwareSerial
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
@@ -460,38 +463,44 @@ monitor_speed = 250000
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
-platform      = ststm32@5.4.3
-framework     = arduino
-board         = blackSTM32F407VET6
-extra_scripts = pre:buildroot/share/PlatformIO/scripts/black_stm32f407vet6.py
-build_flags   = ${common.build_flags}
-  -DSTM32F4 -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
-lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed = 250000
+platform          = ststm32@>=5.7.0
+framework         = arduino
+platform_packages = framework-arduinoststm32@>=3.10700.191028
+board             = blackSTM32F407VET6
+extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+build_flags       = ${common.build_flags}
+ -DTARGET_STM32F4 -DARDUINO_BLACK_F407VE
+ -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
+  -IMarlin/src/HAL/HAL_STM32
+lib_deps          = ${common.lib_deps}
+lib_ignore        = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster, SoftwareSerial
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed     = 250000
 
 #
 # Bigtreetech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
-platform      = ststm32@5.6.0
-framework     = arduino
-board         = BigTree_SKR_Pro
-extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-build_flags   = ${common.build_flags}
+platform          = ststm32@>=5.7.0
+framework         = arduino
+platform_packages = framework-arduinoststm32@>=3.10700.191028
+board             = BigTree_SKR_Pro
+extra_scripts     = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+build_flags       = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
-  -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000 -DHAVE_HWSERIAL6 -DSS_TIMER=4
-lib_deps      =
+  -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
+  -DHAVE_HWSERIAL6
+  -IMarlin/src/HAL/HAL_STM32
+lib_deps          =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  LiquidCrystal@1.3.4
+  LiquidCrystal
   TMCStepper@>=0.5.2,<1.0.0
   Adafruit NeoPixel
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
-  SoftwareSerialM=https://github.com/sjasonsmith/SoftwareSerialM/archive/SKR_PRO.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
-monitor_speed = 250000
+lib_ignore        = SoftwareSerial, SoftwareSerialM
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed     = 250000
 
 #
 # BIGTREE_SKR_BTT002 (STM32F407VET6 ARM Cortex-M4)
@@ -531,7 +540,7 @@ monitor_speed = 250000
 # Malyan M200 (STM32F103CB)
 #
 [env:STM32F103CB_malyan]
-platform    = ststm32@5.6.0
+platform    = ststm32@>=5.7.0
 framework   = arduino
 board       = malyanM200
 build_flags = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections

commit af61f37b6595edeb43ec880529880e75dd1649be
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Mon Nov 11 03:25:56 2019 +0000

    Update lpc176x requirements (#15869)

diff --git a/platformio.ini b/platformio.ini
index 00c5b756de..7c038922e4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -144,7 +144,7 @@ monitor_speed = 250000
 # NXP LPC176x ARM Cortex-M3
 #
 [env:LPC1768]
-platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.0.zip
+platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.1.zip
 framework         = arduino
 board             = nxp_lpc1768
 build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
@@ -164,7 +164,7 @@ lib_deps          = Servo
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 
 [env:LPC1769]
-platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.0.zip
+platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.1.zip
 framework         = arduino
 board             = nxp_lpc1769
 build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}

commit d13573c9cd6452a76a795555d6f18f4cee70f4c2
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Wed Nov 6 23:56:35 2019 +0100

    STM32F1: restore latest ststm32 version (#15776)

diff --git a/platformio.ini b/platformio.ini
index ca08ee3ac7..00c5b756de 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -254,7 +254,7 @@ monitor_speed     = 250000
 # STM32F103RE
 #
 [env:STM32F103RE]
-platform      = ststm32@5.6.0
+platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103RE
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
@@ -272,7 +272,7 @@ upload_protocol = stlink
 # STM32F103RC_fysetc
 #
 [env:STM32F103RC_fysetc]
-platform          = ststm32@5.6.0
+platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
 #board_build.core = maple
@@ -295,7 +295,7 @@ upload_protocol   = serial
 # BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
 #
 [env:STM32F103RC_bigtree]
-platform          = ststm32@5.6.0
+platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
@@ -309,7 +309,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
 
 [env:STM32F103RC_bigtree_USB]
-platform          = ststm32@5.6.0
+platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
@@ -365,7 +365,7 @@ monitor_speed = 250000
 # Longer 3D board in Alfawise U20 (STM32F103VET6)
 #
 [env:STM32F103VE_longer]
-platform      = ststm32@5.6.0
+platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103VE
 monitor_speed = 250000
@@ -382,7 +382,7 @@ lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI
 # MKS Robin (STM32F103ZET6)
 #
 [env:mks_robin]
-platform      = ststm32@5.6.0
+platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
@@ -397,7 +397,7 @@ lib_ignore    = Adafruit NeoPixel, SPI
 # MKS ROBIN LITE/LITE2 (STM32F103RCT6)
 #
 [env:mks_robin_lite]
-platform      = ststm32@5.6.0
+platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103RC
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite.py
@@ -412,7 +412,7 @@ lib_ignore    = Adafruit NeoPixel, SPI
 # MKS Robin Mini (STM32F103VET6)
 #
 [env:mks_robin_mini]
-platform      = ststm32@5.6.0
+platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103VE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
@@ -427,7 +427,7 @@ lib_ignore    = Adafruit NeoPixel, SPI
 # MKS Robin Nano (STM32F103VET6)
 #
 [env:mks_robin_nano]
-platform      = ststm32@5.6.0
+platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103VE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
@@ -442,7 +442,7 @@ lib_ignore    = Adafruit NeoPixel, SPI
 # JGAurora A5S A1 (STM32F103ZET6)
 #
 [env:jgaurora_a5s_a1]
-platform      = ststm32@5.6.0
+platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
@@ -543,7 +543,7 @@ lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-H
 # Chitu boards like Tronxy X5s (STM32F103ZET6)
 #
 [env:chitu_f103]
-platform      = ststm32@5.6.0
+platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py

commit 1fe0646d255553a9dddaa2e5862b9c28a848b48a
Author: Jason Smith <jason.inet@gmail.com>
Date:   Mon Nov 4 13:17:42 2019 -0800

    Use modified SoftwareSerialM which works with SKR Pro (#15796)

diff --git a/platformio.ini b/platformio.ini
index 816f1ff001..ca08ee3ac7 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -481,14 +481,15 @@ board         = BigTree_SKR_Pro
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags   = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
-  -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000 -DHAVE_HWSERIAL6
+  -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000 -DHAVE_HWSERIAL6 -DSS_TIMER=4
 lib_deps      =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal@1.3.4
-  TMCStepper@>=0.5.0,<1.0.0
+  TMCStepper@>=0.5.2,<1.0.0
   Adafruit NeoPixel
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
+  SoftwareSerialM=https://github.com/sjasonsmith/SoftwareSerialM/archive/SKR_PRO.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 

commit b9116d4050c2ac0529fb7f63815ea47a99904a80
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Sun Nov 3 02:34:09 2019 +0000

    LPC176x Framework update (#15722)
    
    Changes required for compatibility with framework-arduino-lpc176x 0.2.0

diff --git a/platformio.ini b/platformio.ini
index b36f538d1d..816f1ff001 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -144,10 +144,10 @@ monitor_speed = 250000
 # NXP LPC176x ARM Cortex-M3
 #
 [env:LPC1768]
-platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/master.zip
+platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.0.zip
 framework         = arduino
 board             = nxp_lpc1768
-build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS  -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
+build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
 # debug options for backtrace
 #  -funwind-tables
 #  -mpoke-function-name
@@ -159,15 +159,15 @@ monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  TMCStepper@>=0.5.0,<1.0.0
-  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/master.zip
+  TMCStepper=https://github.com/p3p/TMCStepper/archive/pr_lpctimingfix.zip
+  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/release.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 
 [env:LPC1769]
-platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/master.zip
+platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/0.1.0.zip
 framework         = arduino
 board             = nxp_lpc1769
-build_flags       = -DTARGET_LPC1768 -DLPC1769 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
+build_flags       = -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
 # debug options for backtrace
 #  -funwind-tables
 #  -mpoke-function-name
@@ -179,8 +179,8 @@ monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  TMCStepper@>=0.5.0,<1.0.0
-  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/master.zip
+  TMCStepper=https://github.com/p3p/TMCStepper/archive/pr_lpctimingfix.zip
+  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/release.zip
 
 #
 # Sanguinololu (ATmega644p)

commit a5df89eef7e07a4cf6ab62e5dc2ee224bdd9ed56
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Nov 1 21:54:08 2019 -0500

    Add HAL_IWDG_MODULE_ENABLED to generic F4/F7

diff --git a/platformio.ini b/platformio.ini
index 2596acdec4..b36f538d1d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -326,10 +326,10 @@ monitor_speed     = 115200
 # STM32F4 with STM32GENERIC
 #
 [env:STM32F4]
-platform      = ststm32@5.6.0
+platform      = ststm32
 framework     = arduino
 board         = disco_f407vg
-build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
+build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
 lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F7>
@@ -339,10 +339,10 @@ monitor_speed = 250000
 # STM32F7 with STM32GENERIC
 #
 [env:STM32F7]
-platform      = ststm32@5.6.0
+platform      = ststm32
 framework     = arduino
 board         = remram_v1
-build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
+build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -DHAL_IWDG_MODULE_ENABLED
 lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F4>

commit 55c3929359f51a51ca6dc6a8ec1677d7a22b00db
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Oct 29 15:57:18 2019 -0500

    Group AVRx4 boards together

diff --git a/platformio.ini b/platformio.ini
index 3e0244422f..2596acdec4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -182,6 +182,32 @@ lib_deps          = Servo
   TMCStepper@>=0.5.0,<1.0.0
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/master.zip
 
+#
+# Sanguinololu (ATmega644p)
+#
+[env:sanguino_atmega644p]
+platform      = atmelavr
+framework     = arduino
+board         = sanguino_atmega644p
+build_flags   = ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+monitor_speed = 250000
+
+#
+# Sanguinololu (ATmega1284p)
+#
+[env:sanguino_atmega1284p]
+platform      = atmelavr
+framework     = arduino
+board         = sanguino_atmega1284p
+build_flags   = ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+monitor_speed = 250000
+
 #
 # Melzi and clones (ATmega1284p)
 #
@@ -224,32 +250,6 @@ lib_deps          = ${common.lib_deps}
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed     = 250000
 
-#
-# Sanguinololu (ATmega644p)
-#
-[env:sanguino_atmega644p]
-platform      = atmelavr
-framework     = arduino
-board         = sanguino_atmega644p
-build_flags   = ${common.build_flags}
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
-
-#
-# Sanguinololu (ATmega1284p)
-#
-[env:sanguino_atmega1284p]
-platform      = atmelavr
-framework     = arduino
-board         = sanguino_atmega1284p
-build_flags   = ${common.build_flags}
-lib_deps      = ${common.lib_deps}
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-monitor_speed = 250000
-
 #
 # STM32F103RE
 #

commit e7b22a0ed4dc17021794acfc161eddc71450a083
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Oct 26 16:39:13 2019 -0500

    Use 5.4.3 for STM32F407VE_black

diff --git a/platformio.ini b/platformio.ini
index 4e3a0d1859..3e0244422f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -460,7 +460,7 @@ monitor_speed = 250000
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
-platform      = ststm32@5.6.0
+platform      = ststm32@5.4.3
 framework     = arduino
 board         = blackSTM32F407VET6
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/black_stm32f407vet6.py

commit e0f68cda1e0ffe4a969c34efb1d4dff893ce67b2
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Oct 26 12:45:39 2019 -0500

    Use ststm32 5.6.0 for now

diff --git a/platformio.ini b/platformio.ini
index a07db85bde..4e3a0d1859 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -254,7 +254,7 @@ monitor_speed = 250000
 # STM32F103RE
 #
 [env:STM32F103RE]
-platform      = ststm32
+platform      = ststm32@5.6.0
 framework     = arduino
 board         = genericSTM32F103RE
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
@@ -272,7 +272,7 @@ upload_protocol = stlink
 # STM32F103RC_fysetc
 #
 [env:STM32F103RC_fysetc]
-platform          = ststm32
+platform          = ststm32@5.6.0
 framework         = arduino
 board             = genericSTM32F103RC
 #board_build.core = maple
@@ -295,7 +295,7 @@ upload_protocol   = serial
 # BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
 #
 [env:STM32F103RC_bigtree]
-platform          = ststm32
+platform          = ststm32@5.6.0
 framework         = arduino
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
@@ -309,7 +309,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
 
 [env:STM32F103RC_bigtree_USB]
-platform          = ststm32
+platform          = ststm32@5.6.0
 framework         = arduino
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
@@ -326,7 +326,7 @@ monitor_speed     = 115200
 # STM32F4 with STM32GENERIC
 #
 [env:STM32F4]
-platform      = ststm32
+platform      = ststm32@5.6.0
 framework     = arduino
 board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
@@ -339,7 +339,7 @@ monitor_speed = 250000
 # STM32F7 with STM32GENERIC
 #
 [env:STM32F7]
-platform      = ststm32
+platform      = ststm32@5.6.0
 framework     = arduino
 board         = remram_v1
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
@@ -352,7 +352,7 @@ monitor_speed = 250000
 # ARMED (STM32)
 #
 [env:ARMED]
-platform    = ststm32
+platform    = ststm32@5.6.0
 framework   = arduino
 board       = armed_v1
 build_flags = ${common.build_flags} -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DHAL_PCD_MODULE_ENABLED -DUSBD_USE_CDC -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
@@ -365,7 +365,7 @@ monitor_speed = 250000
 # Longer 3D board in Alfawise U20 (STM32F103VET6)
 #
 [env:STM32F103VE_longer]
-platform      = ststm32
+platform      = ststm32@5.6.0
 framework     = arduino
 board         = genericSTM32F103VE
 monitor_speed = 250000
@@ -382,7 +382,7 @@ lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI
 # MKS Robin (STM32F103ZET6)
 #
 [env:mks_robin]
-platform      = ststm32
+platform      = ststm32@5.6.0
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
@@ -397,7 +397,7 @@ lib_ignore    = Adafruit NeoPixel, SPI
 # MKS ROBIN LITE/LITE2 (STM32F103RCT6)
 #
 [env:mks_robin_lite]
-platform      = ststm32
+platform      = ststm32@5.6.0
 framework     = arduino
 board         = genericSTM32F103RC
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite.py
@@ -412,7 +412,7 @@ lib_ignore    = Adafruit NeoPixel, SPI
 # MKS Robin Mini (STM32F103VET6)
 #
 [env:mks_robin_mini]
-platform      = ststm32
+platform      = ststm32@5.6.0
 framework     = arduino
 board         = genericSTM32F103VE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
@@ -427,7 +427,7 @@ lib_ignore    = Adafruit NeoPixel, SPI
 # MKS Robin Nano (STM32F103VET6)
 #
 [env:mks_robin_nano]
-platform      = ststm32
+platform      = ststm32@5.6.0
 framework     = arduino
 board         = genericSTM32F103VE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
@@ -442,7 +442,7 @@ lib_ignore    = Adafruit NeoPixel, SPI
 # JGAurora A5S A1 (STM32F103ZET6)
 #
 [env:jgaurora_a5s_a1]
-platform      = ststm32
+platform      = ststm32@5.6.0
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
@@ -460,56 +460,56 @@ monitor_speed = 250000
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
-platform = ststm32@5.4.3
-framework = arduino
-board = blackSTM32F407VET6
+platform      = ststm32@5.6.0
+framework     = arduino
+board         = blackSTM32F407VET6
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/black_stm32f407vet6.py
-build_flags = ${common.build_flags}
+build_flags   = ${common.build_flags}
   -DSTM32F4 -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
-lib_deps = ${common.lib_deps}
-lib_ignore = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
 #
 # Bigtreetech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
-platform = ststm32
-framework = arduino
-board = BigTree_SKR_Pro
+platform      = ststm32@5.6.0
+framework     = arduino
+board         = BigTree_SKR_Pro
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-build_flags = ${common.build_flags}
+build_flags   = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000 -DHAVE_HWSERIAL6
-lib_deps =
+lib_deps      =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal@1.3.4
   TMCStepper@>=0.5.0,<1.0.0
   Adafruit NeoPixel
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
 #
 # BIGTREE_SKR_BTT002 (STM32F407VET6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
-platform = ststm32
-framework = arduino
-board = BigTree_Btt002
+platform      = ststm32@5.6.0
+framework     = arduino
+board         = BigTree_Btt002
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-build_flags = ${common.build_flags}
+build_flags   = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407VE\"
   -DTARGET_STM32F4 -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DHAVE_HWSERIAL2
   -DHAVE_HWSERIAL3
   -DPIN_SERIAL2_RX=PD_6
   -DPIN_SERIAL2_TX=PD_5
-lib_deps = ${common.lib_deps}
-lib_ignore = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
 #
@@ -530,7 +530,7 @@ monitor_speed = 250000
 # Malyan M200 (STM32F103CB)
 #
 [env:STM32F103CB_malyan]
-platform    = ststm32
+platform    = ststm32@5.6.0
 framework   = arduino
 board       = malyanM200
 build_flags = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
@@ -542,7 +542,7 @@ lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-H
 # Chitu boards like Tronxy X5s (STM32F103ZET6)
 #
 [env:chitu_f103]
-platform      = ststm32
+platform      = ststm32@5.6.0
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py

commit c58cc113dddadb2ea15ef7a57de2ee1a9b7ba50a
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Sat Oct 26 02:30:44 2019 +0200

    MKS Robin: restore the TFT v2.0 support (ST7789V) (#15675)

diff --git a/platformio.ini b/platformio.ini
index ddc2642a64..a07db85bde 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -387,7 +387,7 @@ framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
+  ${common.build_flags} -std=gnu++14 -DSTM32_XL_DENSITY
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
@@ -447,7 +447,7 @@ framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DSTM32F1xx -std=gnu++14
+  ${common.build_flags} -DSTM32F1xx -std=gnu++14 -DSTM32_XL_DENSITY
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
@@ -547,7 +547,7 @@ framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DSTM32F1xx -std=gnu++14
+  ${common.build_flags} -DSTM32F1xx -std=gnu++14 -DSTM32_XL_DENSITY
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG= -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}

commit 167ecd8620abb58cfdf952a7bd30fc7dfd411ef8
Author: J.C. Nelson <32139633+xC0000005@users.noreply.github.com>
Date:   Fri Oct 25 15:11:25 2019 -0700

    Chitu board support (e.g., Tronxy X5s) (#15493)

diff --git a/platformio.ini b/platformio.ini
index 5b829b812e..ddc2642a64 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -526,6 +526,33 @@ lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY31_32>
 monitor_speed = 250000
 
+#
+# Malyan M200 (STM32F103CB)
+#
+[env:STM32F103CB_malyan]
+platform    = ststm32
+framework   = arduino
+board       = malyanM200
+build_flags = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
+  -DDEBUG_LEVEL=0 -D__MARLIN_FIRMWARE__
+src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SPI
+
+#
+# Chitu boards like Tronxy X5s (STM32F103ZET6)
+#
+[env:chitu_f103]
+platform      = ststm32
+framework     = arduino
+board         = genericSTM32F103ZE
+extra_scripts = buildroot/share/PlatformIO/scripts/chitu_crypt.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -DSTM32F1xx -std=gnu++14
+build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG= -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = Adafruit NeoPixel
+
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #
@@ -540,19 +567,6 @@ lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
 monitor_speed = 250000
 
-#
-# Malyan M200 (STM32F103CB)
-#
-[env:STM32F103CB_malyan]
-platform    = ststm32
-framework   = arduino
-board       = malyanM200
-build_flags = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
-  -DDEBUG_LEVEL=0 -D__MARLIN_FIRMWARE__
-src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-#-<frameworks>
-lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SPI
-
 #
 # Espressif ESP32
 #

commit 0737b1aecfae3ace32cedf7dfd62bcddace9445f
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Thu Oct 24 19:30:10 2019 +0200

    env: SKRmini can't use STLink (#15645)

diff --git a/platformio.ini b/platformio.ini
index 2597b4f7de..5b829b812e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -265,6 +265,8 @@ lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, SPI
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
+debug_tool    = stlink
+upload_protocol = stlink
 
 #
 # STM32F103RC_fysetc
@@ -305,8 +307,6 @@ lib_deps          = ${common.lib_deps}
 lib_ignore        = Adafruit NeoPixel, SPI
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
-upload_protocol   = stlink
-debug_tool        = stlink
 
 [env:STM32F103RC_bigtree_USB]
 platform          = ststm32
@@ -315,14 +315,12 @@ board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -DDEBUG_LEVEL=0 -DUSE_USB_COMPOSITE -std=gnu++14
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14 -DUSE_USB_COMPOSITE
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
 lib_ignore        = Adafruit NeoPixel, SPI
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
-upload_protocol   = stlink
-debug_tool        = stlink
 
 #
 # STM32F4 with STM32GENERIC

commit 139b7196a0eb2cf74763c9879ff5e1e14ac935c3
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Sep 29 17:57:29 2019 -0500

    Watchdog cleanup (#15283)

diff --git a/platformio.ini b/platformio.ini
index 70a0ae0e58..2597b4f7de 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -591,7 +591,7 @@ monitor_speed     = 250000
 #
 [env:linux_native]
 platform        = native
-build_flags     = -D__PLAT_LINUX__ -std=gnu++17 -ggdb -g -lrt -lpthread -D__MARLIN_FIRMWARE__
+build_flags     = -D__PLAT_LINUX__ -std=gnu++17 -ggdb -g -lrt -lpthread -D__MARLIN_FIRMWARE__ -Wno-expansion-to-defined
 src_build_flags = -Wall -IMarlin/src/HAL/HAL_LINUX/include
 build_unflags   = -Wall
 lib_ldf_mode    = off

commit d0dd1a387e2d80303a50d686112af25377b15f8d
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Sep 29 17:30:58 2019 -0500

    Require a newer Neopixel

diff --git a/platformio.ini b/platformio.ini
index 447a10e81a..70a0ae0e58 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -28,7 +28,7 @@ lib_deps =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal@1.3.4
   TMCStepper@>=0.5.0,<1.0.0
-  Adafruit NeoPixel@1.1.3
+  Adafruit NeoPixel@1.2.5
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip

commit 43d6e9fa4361cf744b6497b8819fa241812692e2
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Sun Sep 29 09:04:53 2019 +0200

    STM32F103.. reorganization, SKR mini fix (#15398)

diff --git a/platformio.ini b/platformio.ini
index 190c8af5da..447a10e81a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -253,7 +253,7 @@ monitor_speed = 250000
 #
 # STM32F103RE
 #
-[env:STM32F103R]
+[env:STM32F103RE]
 platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103RE
@@ -262,20 +262,20 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   -DDEBUG_LEVEL=0
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
-lib_ignore    = U8glib-HAL, Adafruit NeoPixel, SPI
+lib_ignore    = Adafruit NeoPixel, SPI
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
 
 #
-# STM32F103R_fysetc
+# STM32F103RC_fysetc
 #
-[env:STM32F103R_fysetc]
+[env:STM32F103RC_fysetc]
 platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
 #board_build.core = maple
 platform_packages = tool-stm32duino
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103R_fysetc.py
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_fysetc.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
   -DDEBUG_LEVEL=0 -DHAVE_SW_SERIAL
@@ -292,12 +292,12 @@ upload_protocol   = serial
 #
 # BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
 #
-[env:STM32F103R_bigtree]
+[env:STM32F103RC_bigtree]
 platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14
 build_unflags     = -std=gnu++11
@@ -308,12 +308,12 @@ monitor_speed     = 115200
 upload_protocol   = stlink
 debug_tool        = stlink
 
-[env:STM32F103R_bigtree_USB]
+[env:STM32F103RC_bigtree_USB]
 platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
-extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103RC_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DDEBUG_LEVEL=0 -DUSE_USB_COMPOSITE -std=gnu++14
 build_unflags     = -std=gnu++11
@@ -366,12 +366,12 @@ monitor_speed = 250000
 #
 # Longer 3D board in Alfawise U20 (STM32F103VET6)
 #
-[env:STM32F103V_longer]
+[env:STM32F103VE_longer]
 platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103VE
 monitor_speed = 250000
-extra_scripts = buildroot/share/PlatformIO/scripts/longer_STM32.py
+extra_scripts = buildroot/share/PlatformIO/scripts/STM32F103VE_longer.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14 -USERIAL_USB
   -DSTM32F1xx -DU20 -DTS_V12
@@ -543,9 +543,9 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
 monitor_speed = 250000
 
 #
-# Malyan M200 (STM32F1)
+# Malyan M200 (STM32F103CB)
 #
-[env:malyanm200]
+[env:STM32F103CB_malyan]
 platform    = ststm32
 framework   = arduino
 board       = malyanM200

commit 5f18f5bb905bcdc5c8688d457e0255548ea7c448
Author: Jason Smith <jason.inet@gmail.com>
Date:   Fri Sep 27 17:18:12 2019 -0700

    Require TMCStepper >= 0.5.0 in platformio.ini (#15382)

diff --git a/platformio.ini b/platformio.ini
index 8817fb9bf1..190c8af5da 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -27,7 +27,7 @@ build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__
 lib_deps =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal@1.3.4
-  TMCStepper@<1.0.0
+  TMCStepper@>=0.5.0,<1.0.0
   Adafruit NeoPixel@1.1.3
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
@@ -159,7 +159,7 @@ monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  TMCStepper@<1.0.0
+  TMCStepper@>=0.5.0,<1.0.0
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/master.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 
@@ -179,7 +179,7 @@ monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
-  TMCStepper@<1.0.0
+  TMCStepper@>=0.5.0,<1.0.0
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/master.zip
 
 #
@@ -487,7 +487,7 @@ build_flags = ${common.build_flags}
 lib_deps =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal@1.3.4
-  TMCStepper@<1.0.0
+  TMCStepper@>=0.5.0,<1.0.0
   Adafruit NeoPixel
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip

commit f362dab7be04cf35d6ccaa1080acf144e61858d1
Author: Dave Johnson <davejohnson3000@gmail.com>
Date:   Wed Sep 25 07:37:27 2019 -0700

    Disable PIO extra_scripts for AT90USB (#15347)

diff --git a/platformio.ini b/platformio.ini
index 14844d4181..8817fb9bf1 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -88,7 +88,6 @@ build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_CDC.py
 monitor_speed = 250000
 
 #
@@ -105,7 +104,6 @@ build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
-extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_DFU.py
 monitor_speed = 250000
 
 #

commit 12e0581f249d7aafb394a6b9ca511a9b5f337cba
Author: Evgeny Zyatkov <Evg33@users.noreply.github.com>
Date:   Thu Sep 19 01:06:01 2019 +0300

    SKR Pro Neopixel support (#15274)

diff --git a/platformio.ini b/platformio.ini
index d448876e5f..14844d4181 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -486,8 +486,13 @@ extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000 -DHAVE_HWSERIAL6
-lib_deps = ${common.lib_deps}
-lib_ignore = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+lib_deps =
+  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
+  LiquidCrystal@1.3.4
+  TMCStepper@<1.0.0
+  Adafruit NeoPixel
+  LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
+  Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 

commit c7acd5c45b2ecd1ba1ceb90e25e3be197f065df3
Author: Bas Stottelaar <basilfx@users.noreply.github.com>
Date:   Tue Sep 17 12:08:47 2019 +0200

    Upgrade BigTrees to latest platform ststm32 (#15285)

diff --git a/platformio.ini b/platformio.ini
index a88f113811..d448876e5f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -479,7 +479,7 @@ monitor_speed = 250000
 # Bigtreetech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
-platform = ststm32@5.4.3
+platform = ststm32
 framework = arduino
 board = BigTree_SKR_Pro
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
@@ -495,7 +495,7 @@ monitor_speed = 250000
 # BIGTREE_SKR_BTT002 (STM32F407VET6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
-platform = ststm32@5.4.3
+platform = ststm32
 framework = arduino
 board = BigTree_Btt002
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py

commit 6282655d77d2f9811651843a547b61ca43bd61a9
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Mon Sep 16 19:17:21 2019 -0500

    Separate STM32F103R_bigtree_USB environment

diff --git a/platformio.ini b/platformio.ini
index d446aeb7e0..a88f113811 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -301,8 +301,23 @@ board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
-  -DDEBUG_LEVEL=0 -DUSE_USB_COMPOSITE
+  ${common.build_flags} -DDEBUG_LEVEL=0 -std=gnu++14
+build_unflags     = -std=gnu++11
+lib_deps          = ${common.lib_deps}
+lib_ignore        = Adafruit NeoPixel, SPI
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+monitor_speed     = 115200
+upload_protocol   = stlink
+debug_tool        = stlink
+
+[env:STM32F103R_bigtree_USB]
+platform          = ststm32
+framework         = arduino
+board             = genericSTM32F103RC
+platform_packages = tool-stm32duino
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
+build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
+  ${common.build_flags} -DDEBUG_LEVEL=0 -DUSE_USB_COMPOSITE -std=gnu++14
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
 lib_ignore        = Adafruit NeoPixel, SPI

commit 20fbb751f1edd31f33335ce2d4aa26e44c40d524
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Sep 15 02:26:30 2019 -0500

    Tell externals it's Marlin

diff --git a/platformio.ini b/platformio.ini
index 5225929732..d446aeb7e0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -23,7 +23,7 @@ default_envs = megaatmega2560
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
-build_flags = -fmax-errors=5 -g
+build_flags = -fmax-errors=5 -g -D__MARLIN_FIRMWARE__
 lib_deps =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal@1.3.4
@@ -149,7 +149,7 @@ monitor_speed = 250000
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/master.zip
 framework         = arduino
 board             = nxp_lpc1768
-build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
+build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS  -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
 # debug options for backtrace
 #  -funwind-tables
 #  -mpoke-function-name
@@ -532,7 +532,7 @@ platform    = ststm32
 framework   = arduino
 board       = malyanM200
 build_flags = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
-  -DDEBUG_LEVEL=0
+  -DDEBUG_LEVEL=0 -D__MARLIN_FIRMWARE__
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 #-<frameworks>
 lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SPI
@@ -573,7 +573,7 @@ monitor_speed     = 250000
 #
 [env:linux_native]
 platform        = native
-build_flags     = -D__PLAT_LINUX__ -std=gnu++17 -ggdb -g -lrt -lpthread
+build_flags     = -D__PLAT_LINUX__ -std=gnu++17 -ggdb -g -lrt -lpthread -D__MARLIN_FIRMWARE__
 src_build_flags = -Wall -IMarlin/src/HAL/HAL_LINUX/include
 build_unflags   = -Wall
 lib_ldf_mode    = off
@@ -602,7 +602,7 @@ debug_tool    = jlink
 platform    = atmelavr
 framework   = arduino
 board       = megaatmega2560
-build_flags = -c -H -std=gnu++11 -Wall -Os
+build_flags = -c -H -std=gnu++11 -Wall -Os -D__MARLIN_FIRMWARE__
 lib_deps    = ${common.lib_deps}
   TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter  = +<src/Marlin.cpp>

commit 5bf635cec2b9f511c7ab3d87c21993cae0407208
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Fri Sep 13 01:35:27 2019 +0200

    STM32F1: Only include USBComposite if flagged (#15243)

diff --git a/platformio.ini b/platformio.ini
index c6ae62e1ff..5225929732 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -23,9 +23,7 @@ default_envs = megaatmega2560
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
-build_flags = -fmax-errors=5
-  -g
-  -ggdb
+build_flags = -fmax-errors=5 -g
 lib_deps =
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal@1.3.4

commit f1162243f602aa45913996a8fd870efc4d5f5902
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Fri Sep 13 00:59:31 2019 +0200

    STM32F1: No USBSerial without USB-serial bridge (#15242)

diff --git a/platformio.ini b/platformio.ini
index 83019cd029..c6ae62e1ff 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -362,7 +362,7 @@ board         = genericSTM32F103VE
 monitor_speed = 250000
 extra_scripts = buildroot/share/PlatformIO/scripts/longer_STM32.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
-  ${common.build_flags} -std=gnu++14
+  ${common.build_flags} -std=gnu++14 -USERIAL_USB
   -DSTM32F1xx -DU20 -DTS_V12
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>

commit dbea6f0022dcb805e4b57c8f5b8dc6dce5820344
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Sep 8 02:27:23 2019 -0500

    STM32F1 USB cdc/msc composite device (#15180)
    
    Co-Authored-By: bigtreetech <38851044+bigtreetech@users.noreply.github.com>

diff --git a/platformio.ini b/platformio.ini
index a2df18720c..83019cd029 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -304,7 +304,7 @@ platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
 build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
-  -DDEBUG_LEVEL=0
+  -DDEBUG_LEVEL=0 -DUSE_USB_COMPOSITE
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
 lib_ignore        = Adafruit NeoPixel, SPI

commit 53af7cad0a85bf3340752eac987890b37c779123
Author: Giuliano Zaro <3684609+GMagician@users.noreply.github.com>
Date:   Thu Sep 5 00:00:30 2019 +0200

    SAMD51 include u8g library (#15165)

diff --git a/platformio.ini b/platformio.ini
index cdf5c76143..a2df18720c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -594,7 +594,6 @@ build_flags   = ${common.build_flags} -std=gnu++17
 extra_scripts = ${common.extra_scripts}
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
-lib_ignore    = U8glib-HAL
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_SAMD51>
 debug_tool    = jlink
 

commit 75efa3cdacd8271ca360e7d1680f25f5be218da3
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon Sep 2 19:49:58 2019 -0500

    Reorganize HAL (#14832)

diff --git a/platformio.ini b/platformio.ini
index 18b1439544..cdf5c76143 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -257,11 +257,11 @@ monitor_speed = 250000
 #
 # STM32F103RE
 #
-[env:STM32F1]
+[env:STM32F103R]
 platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103RE
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
   -DDEBUG_LEVEL=0
 build_unflags = -std=gnu++11
@@ -271,16 +271,16 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
 
 #
-# fysetc_STM32F1
+# STM32F103R_fysetc
 #
-[env:fysetc_STM32F1]
+[env:STM32F103R_fysetc]
 platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
 #board_build.core = maple
 platform_packages = tool-stm32duino
-extra_scripts     = buildroot/share/PlatformIO/scripts/fysetc_STM32F1.py
-build_flags       = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F103R_fysetc.py
+build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
   -DDEBUG_LEVEL=0 -DHAVE_SW_SERIAL
 build_unflags     = -std=gnu++11
@@ -296,13 +296,13 @@ upload_protocol   = serial
 #
 # BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
 #
-[env:BIGTREE_SKR_MINI]
+[env:STM32F103R_bigtree]
 platform          = ststm32
 framework         = arduino
 board             = genericSTM32F103RC
 platform_packages = tool-stm32duino
 extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
-build_flags       = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+build_flags       = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
   -DDEBUG_LEVEL=0
 build_unflags     = -std=gnu++11
@@ -355,13 +355,13 @@ monitor_speed = 250000
 #
 # Longer 3D board in Alfawise U20 (STM32F103VET6)
 #
-[env:alfawise_U20]
+[env:STM32F103V_longer]
 platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103VE
 monitor_speed = 250000
-extra_scripts = buildroot/share/PlatformIO/scripts/alfawise_Ux0.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+extra_scripts = buildroot/share/PlatformIO/scripts/longer_STM32.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
   -DSTM32F1xx -DU20 -DTS_V12
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
@@ -377,7 +377,7 @@ platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
@@ -392,7 +392,7 @@ platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103RC
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
@@ -407,7 +407,7 @@ platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103VE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
@@ -422,7 +422,7 @@ platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103VE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -std=gnu++14
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
@@ -437,7 +437,7 @@ platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py
   ${common.build_flags} -DSTM32F1xx -std=gnu++14
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
@@ -450,7 +450,7 @@ monitor_speed = 250000
 # 'Black' STM32F407VET6 board - http://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
-[env:black_stm32f407ve]
+[env:STM32F407VE_black]
 platform = ststm32@5.4.3
 framework = arduino
 board = blackSTM32F407VET6
@@ -533,7 +533,7 @@ monitor_speed = 250000
 platform    = ststm32
 framework   = arduino
 board       = malyanM200
-build_flags = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
+build_flags = !python Marlin/src/HAL/HAL_STM32F1/build_flags.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
   -DDEBUG_LEVEL=0
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 #-<frameworks>
@@ -586,7 +586,7 @@ src_filter      = ${common.default_src_filter} +<src/HAL/HAL_LINUX>
 #
 # Adafruit Grand Central M4 (Atmel SAMD51P20A ARM Cortex-M4)
 #
-[env:adafruit_grandcentral_m4]
+[env:SAMD51_grandcentral_m4]
 platform      = atmelsam
 board         = adafruit_grandcentral_m4
 framework     = arduino

commit d59d9b59730ba28de1306dc8100b06b678361783
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Sun Sep 1 11:10:35 2019 +0200

    Alfawise - LK1/LK2/LK4 and BLTouch (#15118)

diff --git a/platformio.ini b/platformio.ini
index 6a35733c82..18b1439544 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -364,7 +364,7 @@ extra_scripts = buildroot/share/PlatformIO/scripts/alfawise_Ux0.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags} -std=gnu++14
   -DSTM32F1xx -DU20 -DTS_V12
-build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1
+build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1 -DERROR_LED_PORT=GPIOE -DERROR_LED_PIN=6
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI

commit 2aef83ddcdd3317c3191e79c3be3fc06969f7768
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Aug 27 20:28:42 2019 -0500

    Add a PlatformIO hook to alter CXXFLAGS

diff --git a/platformio.ini b/platformio.ini
index ce49569dff..6a35733c82 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -22,6 +22,7 @@ default_envs = megaatmega2560
 
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
+extra_scripts = pre:buildroot/share/PlatformIO/scripts/common-cxxflags.py
 build_flags = -fmax-errors=5
   -g
   -ggdb
@@ -590,6 +591,7 @@ platform      = atmelsam
 board         = adafruit_grandcentral_m4
 framework     = arduino
 build_flags   = ${common.build_flags} -std=gnu++17
+extra_scripts = ${common.extra_scripts}
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
 lib_ignore    = U8glib-HAL

commit 23cffb2c210d14936f5d5c2160bea36306f475fd
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Aug 27 20:50:48 2019 -0500

    Add an env to get the Include Tree

diff --git a/platformio.ini b/platformio.ini
index a688e0562e..ce49569dff 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -595,3 +595,15 @@ lib_deps      = ${common.lib_deps}
 lib_ignore    = U8glib-HAL
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_SAMD51>
 debug_tool    = jlink
+
+#
+# Just print the dependency tree
+#
+[env:include_tree]
+platform    = atmelavr
+framework   = arduino
+board       = megaatmega2560
+build_flags = -c -H -std=gnu++11 -Wall -Os
+lib_deps    = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
+src_filter  = +<src/Marlin.cpp>

commit a61c91ae9ec89746e1f4eca0b776c14ebfcde7b6
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Aug 28 21:28:21 2019 -0500

    Use 'bugfix' branch of U8glib-HAL

diff --git a/platformio.ini b/platformio.ini
index 6cd3110f14..a688e0562e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -26,7 +26,7 @@ build_flags = -fmax-errors=5
   -g
   -ggdb
 lib_deps =
-  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
+  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   LiquidCrystal@1.3.4
   TMCStepper@<1.0.0
   Adafruit NeoPixel@1.1.3
@@ -161,7 +161,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
-  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
+  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   TMCStepper@<1.0.0
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/master.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
@@ -181,7 +181,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
-  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
+  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/bugfix.zip
   TMCStepper@<1.0.0
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/master.zip
 

commit 0a280f00c2e1d0a59791fbefeca578ca9ef73f6e
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Sat Aug 24 05:21:30 2019 +0200

    Flag unused variables without buzzer (#15016)

diff --git a/platformio.ini b/platformio.ini
index f3da5f9f62..6cd3110f14 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -366,7 +366,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, SPI
+lib_ignore    = Adafruit NeoPixel, LiquidTWI2, SPI
 
 #
 # MKS Robin (STM32F103ZET6)

commit 012f577bb0068af1479d470c02fa5ef597a32f3f
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Wed Aug 21 13:22:23 2019 +0200

    STM32F1: Import (rogerclarkmelbourne) SPI class (#15002)

diff --git a/platformio.ini b/platformio.ini
index a005f613e6..f3da5f9f62 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -265,7 +265,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   -DDEBUG_LEVEL=0
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
-lib_ignore    = U8glib-HAL, Adafruit NeoPixel
+lib_ignore    = U8glib-HAL, Adafruit NeoPixel, SPI
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
 
@@ -285,7 +285,7 @@ build_flags       = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = Adafruit NeoPixel
+lib_ignore        = Adafruit NeoPixel, SPI
 lib_ldf_mode      = chain
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 250000
@@ -306,7 +306,7 @@ build_flags       = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   -DDEBUG_LEVEL=0
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
-lib_ignore        = Adafruit NeoPixel
+lib_ignore        = Adafruit NeoPixel, SPI
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
 upload_protocol   = stlink
@@ -366,7 +366,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel
+lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # MKS Robin (STM32F103ZET6)
@@ -381,7 +381,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel
+lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # MKS ROBIN LITE/LITE2 (STM32F103RCT6)
@@ -396,7 +396,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel
+lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # MKS Robin Mini (STM32F103VET6)
@@ -411,7 +411,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel
+lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # MKS Robin Nano (STM32F103VET6)
@@ -426,7 +426,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel
+lib_ignore    = Adafruit NeoPixel, SPI
 
 #
 # JGAurora A5S A1 (STM32F103ZET6)
@@ -441,7 +441,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel
+lib_ignore    = Adafruit NeoPixel, SPI
 monitor_speed = 250000
 
 #
@@ -536,7 +536,7 @@ build_flags = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py -DMCU_ST
   -DDEBUG_LEVEL=0
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 #-<frameworks>
-lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL
+lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL, SPI
 
 #
 # Espressif ESP32

commit 8c2cfaa90703cdd1435d92a31bb5400629318758
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Aug 20 23:45:38 2019 -0500

    Fix BigTree_Btt002 build

diff --git a/platformio.ini b/platformio.ini
index c4d20e9c98..a005f613e6 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -483,7 +483,7 @@ monitor_speed = 250000
 [env:BIGTREE_BTT002]
 platform = ststm32@5.4.3
 framework = arduino
-board = BigTree_BTT002
+board = BigTree_Btt002
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407VE\"

commit 0b47558a09ab4b21a11bff330b53818557522ffc
Author: chzj333 <53591189+chzj333@users.noreply.github.com>
Date:   Tue Aug 20 16:05:12 2019 +0800

    New board STM32F407 (#14994)

diff --git a/platformio.ini b/platformio.ini
index e04d369393..c4d20e9c98 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -477,6 +477,26 @@ lib_ignore = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
+#
+# BIGTREE_SKR_BTT002 (STM32F407VET6 ARM Cortex-M4)
+#
+[env:BIGTREE_BTT002]
+platform = ststm32@5.4.3
+framework = arduino
+board = BigTree_BTT002
+extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+build_flags = ${common.build_flags}
+  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407VE\"
+  -DTARGET_STM32F4 -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
+  -DHAVE_HWSERIAL2
+  -DHAVE_HWSERIAL3
+  -DPIN_SERIAL2_RX=PD_6
+  -DPIN_SERIAL2_TX=PD_5
+lib_deps = ${common.lib_deps}
+lib_ignore = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed = 250000
+
 #
 # Teensy 3.1 / 3.2 (ARM Cortex-M4)
 #
@@ -516,7 +536,7 @@ build_flags = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py -DMCU_ST
   -DDEBUG_LEVEL=0
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 #-<frameworks>
-lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, TMC26XStepper, U8glib-HAL
+lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, U8glib-HAL
 
 #
 # Espressif ESP32
@@ -531,7 +551,7 @@ upload_port = /dev/ttyUSB0
 lib_deps =
   AsyncTCP=https://github.com/me-no-dev/AsyncTCP/archive/master.zip
   ESPAsyncWebServer=https://github.com/me-no-dev/ESPAsyncWebServer/archive/master.zip
-lib_ignore  = TMC26XStepper, LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED
+lib_ignore  = LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
 
 #

commit 08434b36057ce9119404823b5dc448babe533c51
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Aug 18 20:49:33 2019 -0500

    Add TMC26XStepper, not ignore

diff --git a/platformio.ini b/platformio.ini
index f6e0458c00..e04d369393 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -32,7 +32,6 @@ lib_deps =
   Adafruit NeoPixel@1.1.3
   LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
   Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
-  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
   SailfishRGB_LED=https://github.com/mikeshub/SailfishRGB_LED/archive/master.zip
   SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
@@ -57,6 +56,7 @@ board             = megaatmega2560
 build_flags       = ${common.build_flags}
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed     = 250000
 
@@ -70,6 +70,7 @@ board             = megaatmega1280
 build_flags       = ${common.build_flags}
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed     = 250000
 
@@ -86,6 +87,7 @@ framework     = arduino
 board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_CDC.py
 monitor_speed = 250000
@@ -102,6 +104,7 @@ framework     = arduino
 board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_DFU.py
 monitor_speed = 250000
@@ -118,7 +121,6 @@ framework     = arduino
 board         = due
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-lib_ignore    = TMC26XStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
 [env:DUE_USB]
@@ -127,7 +129,6 @@ framework     = arduino
 board         = dueUSB
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-lib_ignore    = TMC26XStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
 [env:DUE_debug]
@@ -139,7 +140,6 @@ build_flags   = ${common.build_flags}
   -funwind-tables
   -mpoke-function-name
 lib_deps      = ${common.lib_deps}
-lib_ignore    = TMC26XStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
 
@@ -195,7 +195,7 @@ board         = sanguino_atmega1284p
 build_flags   = ${common.build_flags} -fmerge-all-constants
 upload_speed  = 57600
 lib_deps      = ${common.lib_deps}
-lib_ignore    = TMCStepper, TMC26XStepper
+lib_ignore    = TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 
@@ -209,7 +209,7 @@ board         = sanguino_atmega1284p
 build_flags   = ${common.build_flags}
 upload_speed  = 115200
 lib_deps      = ${common.lib_deps}
-lib_ignore    = TMCStepper, TMC26XStepper
+lib_ignore    = TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 
@@ -223,6 +223,7 @@ board             = reprap_rambo
 build_flags       = ${common.build_flags}
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed     = 250000
 
@@ -235,6 +236,7 @@ framework     = arduino
 board         = sanguino_atmega644p
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 
@@ -247,6 +249,7 @@ framework     = arduino
 board         = sanguino_atmega1284p
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 
@@ -262,7 +265,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   -DDEBUG_LEVEL=0
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
-lib_ignore    = U8glib-HAL, TMC26XStepper, Adafruit NeoPixel
+lib_ignore    = U8glib-HAL, Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
 
@@ -282,7 +285,7 @@ build_flags       = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore        = TMC26XStepper, Adafruit NeoPixel
+lib_ignore        = Adafruit NeoPixel
 lib_ldf_mode      = chain
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 250000
@@ -303,7 +306,7 @@ build_flags       = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   -DDEBUG_LEVEL=0
 build_unflags     = -std=gnu++11
 lib_deps          = ${common.lib_deps}
-lib_ignore        = TMC26XStepper, Adafruit NeoPixel
+lib_ignore        = Adafruit NeoPixel
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed     = 115200
 upload_protocol   = stlink
@@ -318,7 +321,7 @@ framework     = arduino
 board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, TMCStepper, TMC26XStepper
+lib_ignore    = Adafruit NeoPixel, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F7>
 monitor_speed = 250000
 
@@ -331,7 +334,7 @@ framework     = arduino
 board         = remram_v1
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, TMCStepper, TMC26XStepper
+lib_ignore    = Adafruit NeoPixel, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F4>
 monitor_speed = 250000
 
@@ -344,7 +347,7 @@ framework   = arduino
 board       = armed_v1
 build_flags = ${common.build_flags} -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DHAL_PCD_MODULE_ENABLED -DUSBD_USE_CDC -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
 lib_deps    = ${common.lib_deps}
-lib_ignore  = Adafruit NeoPixel, TMC26XStepper
+lib_ignore  = Adafruit NeoPixel
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
@@ -363,7 +366,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, TMC26XStepper
+lib_ignore    = Adafruit NeoPixel
 
 #
 # MKS Robin (STM32F103ZET6)
@@ -378,7 +381,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, TMC26XStepper
+lib_ignore    = Adafruit NeoPixel
 
 #
 # MKS ROBIN LITE/LITE2 (STM32F103RCT6)
@@ -393,7 +396,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, TMC26XStepper
+lib_ignore    = Adafruit NeoPixel
 
 #
 # MKS Robin Mini (STM32F103VET6)
@@ -408,7 +411,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, TMC26XStepper
+lib_ignore    = Adafruit NeoPixel
 
 #
 # MKS Robin Nano (STM32F103VET6)
@@ -423,7 +426,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, TMC26XStepper
+lib_ignore    = Adafruit NeoPixel
 
 #
 # JGAurora A5S A1 (STM32F103ZET6)
@@ -438,7 +441,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, TMC26XStepper
+lib_ignore    = Adafruit NeoPixel
 monitor_speed = 250000
 
 #
@@ -454,7 +457,7 @@ extra_scripts = pre:buildroot/share/PlatformIO/scripts/black_stm32f407vet6.py
 build_flags = ${common.build_flags}
   -DSTM32F4 -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
 lib_deps = ${common.lib_deps}
-lib_ignore = Adafruit NeoPixel, TMCStepper, TMC26XStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+lib_ignore = Adafruit NeoPixel, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
@@ -470,7 +473,7 @@ build_flags = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000 -DHAVE_HWSERIAL6
 lib_deps = ${common.lib_deps}
-lib_ignore = Adafruit NeoPixel, TMC26XStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+lib_ignore = Adafruit NeoPixel, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
@@ -483,6 +486,7 @@ framework     = arduino
 board         = teensy31
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY31_32>
 monitor_speed = 250000
@@ -496,6 +500,7 @@ framework     = arduino
 board         = teensy35
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
 monitor_speed = 250000
@@ -539,6 +544,7 @@ board             = fysetc_f6_13
 build_flags       = ${common.build_flags}
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed     = 250000
 
@@ -566,6 +572,6 @@ framework     = arduino
 build_flags   = ${common.build_flags} -std=gnu++17
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
-lib_ignore    = U8glib-HAL, TMC26XStepper
+lib_ignore    = U8glib-HAL
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_SAMD51>
 debug_tool    = jlink

commit d2072f9acedc6b1346cd278703b3b0db34197079
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Aug 18 19:36:14 2019 -0500

    Clean up PlatformIO lib_ignore (#14988)
    
    Originally from #14832.
    
    Users may need to delete platformio work folders before building.

diff --git a/platformio.ini b/platformio.ini
index d62388726a..f6e0458c00 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -262,14 +262,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   -DDEBUG_LEVEL=0
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
-lib_ignore    = U8glib-HAL
-  TMC26XStepper
-  libf3c
-  lib066
-  Adafruit NeoPixel_ID28
-  Adafruit NeoPixel
-  libf3e
-#lib_ldf_mode  = chain
+lib_ignore    = U8glib-HAL, TMC26XStepper, Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
 
@@ -277,52 +270,44 @@ monitor_speed = 250000
 # fysetc_STM32F1
 #
 [env:fysetc_STM32F1]
-platform      = ststm32
-framework     = arduino
-board         = genericSTM32F103RC
-extra_scripts = buildroot/share/PlatformIO/scripts/fysetc_STM32F1.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+platform          = ststm32
+framework         = arduino
+board             = genericSTM32F103RC
+#board_build.core = maple
+platform_packages = tool-stm32duino
+extra_scripts     = buildroot/share/PlatformIO/scripts/fysetc_STM32F1.py
+build_flags       = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags} -std=gnu++14
   -DDEBUG_LEVEL=0 -DHAVE_SW_SERIAL
-build_unflags = -std=gnu++11
-lib_deps      = ${common.lib_deps}
+build_unflags     = -std=gnu++11
+lib_deps          = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore    = TMC26XStepper
-  libf3c
-  lib066
-  Adafruit NeoPixel_ID28
-  Adafruit NeoPixel
-  libf3e
-lib_ldf_mode  = chain
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-monitor_speed = 250000
-debug_tool    = stlink
-upload_protocol = serial
+lib_ignore        = TMC26XStepper, Adafruit NeoPixel
+lib_ldf_mode      = chain
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+monitor_speed     = 250000
+debug_tool        = stlink
+upload_protocol   = serial
 
 #
 # BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
 #
 [env:BIGTREE_SKR_MINI]
-platform      = ststm32
-framework     = arduino
-board         = genericSTM32F103RC
-extra_scripts = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+platform          = ststm32
+framework         = arduino
+board             = genericSTM32F103RC
+platform_packages = tool-stm32duino
+extra_scripts     = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
+build_flags       = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags} -std=gnu++14
   -DDEBUG_LEVEL=0
-build_unflags = -std=gnu++11
-lib_deps      = ${common.lib_deps}
-lib_ignore    = TMC26XStepper
-  libf3c
-  lib066
-  Adafruit NeoPixel_ID28
-  Adafruit NeoPixel
-  libf3e
-#lib_ldf_mode  = chain
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
-monitor_speed = 115200
-upload_protocol = stlink
-debug_tool = stlink
+build_unflags     = -std=gnu++11
+lib_deps          = ${common.lib_deps}
+lib_ignore        = TMC26XStepper, Adafruit NeoPixel
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+monitor_speed     = 115200
+upload_protocol   = stlink
+debug_tool        = stlink
 
 #
 # STM32F4 with STM32GENERIC
@@ -331,10 +316,10 @@ debug_tool = stlink
 platform      = ststm32
 framework     = arduino
 board         = disco_f407vg
-build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
+build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F4 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, TMC26XStepper, TMCStepper
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/*> +<src/HAL/HAL_STM32_F4_F7/STM32F4>
+lib_ignore    = Adafruit NeoPixel, TMCStepper, TMC26XStepper
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F7>
 monitor_speed = 250000
 
 #
@@ -343,11 +328,11 @@ monitor_speed = 250000
 [env:STM32F7]
 platform      = ststm32
 framework     = arduino
-board         = disco_f765vg
-build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
+board         = remram_v1
+build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DSTM32F7 -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, TMC26XStepper, TMCStepper
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/*> +<src/HAL/HAL_STM32_F4_F7/STM32F7>
+lib_ignore    = Adafruit NeoPixel, TMCStepper, TMC26XStepper
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/STM32F4>
 monitor_speed = 250000
 
 #
@@ -364,7 +349,7 @@ src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
 #
-# Alfawise U20 (STM32F103VET6)
+# Longer 3D board in Alfawise U20 (STM32F103VET6)
 #
 [env:alfawise_U20]
 platform      = ststm32
@@ -378,12 +363,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = TMC26XStepper
-  libf3c
-  lib066
-  Adafruit NeoPixel_ID28
-  Adafruit NeoPixel
-  libf3e
+lib_ignore    = Adafruit NeoPixel, TMC26XStepper
 
 #
 # MKS Robin (STM32F103ZET6)
@@ -398,13 +378,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = TMC26XStepper
-  libf3c
-  lib066
-  Adafruit NeoPixel_ID28
-  Adafruit NeoPixel
-  libf3e
-  U8glib-HAL
+lib_ignore    = Adafruit NeoPixel, TMC26XStepper
 
 #
 # MKS ROBIN LITE/LITE2 (STM32F103RCT6)
@@ -419,12 +393,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = TMC26XStepper
-  libf3c
-  lib066
-  Adafruit NeoPixel_ID28
-  Adafruit NeoPixel
-  libf3e
+lib_ignore    = Adafruit NeoPixel, TMC26XStepper
 
 #
 # MKS Robin Mini (STM32F103VET6)
@@ -439,12 +408,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = TMC26XStepper
-  libf3c
-  lib066
-  Adafruit NeoPixel_ID28
-  Adafruit NeoPixel
-  libf3e
+lib_ignore    = Adafruit NeoPixel, TMC26XStepper
 
 #
 # MKS Robin Nano (STM32F103VET6)
@@ -459,12 +423,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = TMC26XStepper
-  libf3c
-  lib066
-  Adafruit NeoPixel_ID28
-  Adafruit NeoPixel
-  libf3e
+lib_ignore    = Adafruit NeoPixel, TMC26XStepper
 
 #
 # JGAurora A5S A1 (STM32F103ZET6)
@@ -479,12 +438,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = TMC26XStepper
-  libf3c
-  lib066
-  Adafruit NeoPixel_ID28
-  Adafruit NeoPixel
-  libf3e
+lib_ignore    = Adafruit NeoPixel, TMC26XStepper
 monitor_speed = 250000
 
 #
@@ -498,14 +452,14 @@ framework = arduino
 board = blackSTM32F407VET6
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/black_stm32f407vet6.py
 build_flags = ${common.build_flags}
-  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
+  -DSTM32F4 -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
 lib_deps = ${common.lib_deps}
-lib_ignore = Adafruit NeoPixel, TMC26XStepper, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+lib_ignore = Adafruit NeoPixel, TMCStepper, TMC26XStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
 #
-# BIGTREE_SKR_PRO (STM32F407ZGT6 ARM Cortex-M4)
+# Bigtreetech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
 platform = ststm32@5.4.3
@@ -557,16 +511,7 @@ build_flags = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py -DMCU_ST
   -DDEBUG_LEVEL=0
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 #-<frameworks>
-lib_ignore  = Adafruit NeoPixel
-  U8glib
-  LiquidCrystal_I2C
-  LiquidCrystal
-  NewliquidCrystal
-  LiquidTWI2
-  TMC26XStepper
-  TMCStepper
-  Servo(STM32F1)
-  U8glib-HAL
+lib_ignore  = Adafruit NeoPixel, LiquidCrystal, LiquidTWI2, TMCStepper, TMC26XStepper, U8glib-HAL
 
 #
 # Espressif ESP32
@@ -581,13 +526,7 @@ upload_port = /dev/ttyUSB0
 lib_deps =
   AsyncTCP=https://github.com/me-no-dev/AsyncTCP/archive/master.zip
   ESPAsyncWebServer=https://github.com/me-no-dev/ESPAsyncWebServer/archive/master.zip
-lib_ignore  = TMC26XStepper
-  LiquidCrystal_I2C
-  LiquidCrystal
-  NewliquidCrystal
-  LiquidTWI2
-  SailfishLCD
-  SailfishRGB_LED
+lib_ignore  = TMC26XStepper, LiquidCrystal, LiquidTWI2, SailfishLCD, SailfishRGB_LED
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
 
 #

commit 5d2519ed50ca0a7700eda1d6dde38cd80a1912e2
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Sat Aug 10 08:45:36 2019 +0200

    Allow use of Fysetc SoftwareSerialM (#14893)

diff --git a/platformio.ini b/platformio.ini
index c98b0f4d32..d62388726a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -280,11 +280,10 @@ monitor_speed = 250000
 platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103RC
-#board_build.core = maple
 extra_scripts = buildroot/share/PlatformIO/scripts/fysetc_STM32F1.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags} -std=gnu++14
-  -DDEBUG_LEVEL=0
+  -DDEBUG_LEVEL=0 -DHAVE_SW_SERIAL
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip

commit 2971b48a128662ab2f50a0a238aedfb64ec785d9
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Thu Aug 8 14:29:33 2019 +0100

    Use PlatformIO 4 default dir structure (#14879)

diff --git a/platformio.ini b/platformio.ini
index 32803da116..c98b0f4d32 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -17,9 +17,6 @@
 
 [platformio]
 src_dir      = Marlin
-build_dir    = .pioenvs
-lib_dir      = .piolib
-libdeps_dir  = .piolibdeps
 boards_dir   = buildroot/share/PlatformIO/boards
 default_envs = megaatmega2560
 

commit 3e5620283e1f7d965c7a6ad182f53af5cbebf244
Author: Giuliano Zaro <3684609+GMagician@users.noreply.github.com>
Date:   Wed Aug 7 07:45:00 2019 +0200

    AGCM4 debug option (#14838)

diff --git a/platformio.ini b/platformio.ini
index 5b742faf77..32803da116 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -628,8 +628,9 @@ src_filter      = ${common.default_src_filter} +<src/HAL/HAL_LINUX>
 platform      = atmelsam
 board         = adafruit_grandcentral_m4
 framework     = arduino
-build_flags   = ${common.build_flags}
-  -Wl,-Map,$BUILD_DIR/firmware.map -Wl,--cref
+build_flags   = ${common.build_flags} -std=gnu++17
+build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
 lib_ignore    = U8glib-HAL, TMC26XStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_SAMD51>
+debug_tool    = jlink

commit ab792d004cf22722088e0021c34f84724daa32ca
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Aug 3 18:29:18 2019 -0500

    More PlatformIO aliases

diff --git a/platformio.ini b/platformio.ini
index 7a3137e443..5b742faf77 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -29,13 +29,13 @@ build_flags = -fmax-errors=5
   -g
   -ggdb
 lib_deps =
-  https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
+  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal@1.3.4
   TMCStepper@<1.0.0
   Adafruit NeoPixel@1.1.3
-  https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
-  https://github.com/ameyer/Arduino-L6470/archive/dev.zip
-  https://github.com/trinamic/TMC26XStepper/archive/c1921b4.zip
+  LiquidTWI2=https://github.com/lincomatic/LiquidTWI2/archive/master.zip
+  Arduino-L6470=https://github.com/ameyer/Arduino-L6470/archive/dev.zip
+  TMC26XStepper=https://github.com/trinamic/TMC26XStepper/archive/master.zip
   SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
   SailfishRGB_LED=https://github.com/mikeshub/SailfishRGB_LED/archive/master.zip
   SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
@@ -121,7 +121,7 @@ framework     = arduino
 board         = due
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-lib_ignore    = c1921b4
+lib_ignore    = TMC26XStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
 [env:DUE_USB]
@@ -130,7 +130,7 @@ framework     = arduino
 board         = dueUSB
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-lib_ignore    = c1921b4
+lib_ignore    = TMC26XStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
 [env:DUE_debug]
@@ -142,7 +142,7 @@ build_flags   = ${common.build_flags}
   -funwind-tables
   -mpoke-function-name
 lib_deps      = ${common.lib_deps}
-lib_ignore    = c1921b4
+lib_ignore    = TMC26XStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
 
@@ -266,13 +266,12 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
 lib_ignore    = U8glib-HAL
-  c1921b4
+  TMC26XStepper
   libf3c
   lib066
   Adafruit NeoPixel_ID28
   Adafruit NeoPixel
   libf3e
-  TMC26XStepper
 #lib_ldf_mode  = chain
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
@@ -292,14 +291,12 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
   SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
-lib_ignore    =
-  c1921b4
+lib_ignore    = TMC26XStepper
   libf3c
   lib066
   Adafruit NeoPixel_ID28
   Adafruit NeoPixel
   libf3e
-  TMC26XStepper
 lib_ldf_mode  = chain
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
@@ -319,14 +316,12 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   -DDEBUG_LEVEL=0
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
-lib_ignore    =
-  c1921b4
+lib_ignore    = TMC26XStepper
   libf3c
   lib066
   Adafruit NeoPixel_ID28
   Adafruit NeoPixel
   libf3e
-  TMC26XStepper
 #lib_ldf_mode  = chain
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 115200
@@ -342,7 +337,7 @@ framework     = arduino
 board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, c1921b4, TMCStepper
+lib_ignore    = Adafruit NeoPixel, TMC26XStepper, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/*> +<src/HAL/HAL_STM32_F4_F7/STM32F4>
 monitor_speed = 250000
 
@@ -355,7 +350,7 @@ framework     = arduino
 board         = disco_f765vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, c1921b4, TMCStepper
+lib_ignore    = Adafruit NeoPixel, TMC26XStepper, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/*> +<src/HAL/HAL_STM32_F4_F7/STM32F7>
 monitor_speed = 250000
 
@@ -368,7 +363,7 @@ framework   = arduino
 board       = armed_v1
 build_flags = ${common.build_flags} -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DHAL_PCD_MODULE_ENABLED -DUSBD_USE_CDC -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
 lib_deps    = ${common.lib_deps}
-lib_ignore  = Adafruit NeoPixel, c1921b4
+lib_ignore  = Adafruit NeoPixel, TMC26XStepper
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
@@ -387,13 +382,12 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = c1921b4
+lib_ignore    = TMC26XStepper
   libf3c
   lib066
   Adafruit NeoPixel_ID28
   Adafruit NeoPixel
   libf3e
-  TMC26XStepper
 
 #
 # MKS Robin (STM32F103ZET6)
@@ -408,13 +402,12 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = c1921b4
+lib_ignore    = TMC26XStepper
   libf3c
   lib066
   Adafruit NeoPixel_ID28
   Adafruit NeoPixel
   libf3e
-  TMC26XStepper
   U8glib-HAL
 
 #
@@ -430,13 +423,12 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = c1921b4
+lib_ignore    = TMC26XStepper
   libf3c
   lib066
   Adafruit NeoPixel_ID28
   Adafruit NeoPixel
   libf3e
-  TMC26XStepper
 
 #
 # MKS Robin Mini (STM32F103VET6)
@@ -451,13 +443,12 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = c1921b4
+lib_ignore    = TMC26XStepper
   libf3c
   lib066
   Adafruit NeoPixel_ID28
   Adafruit NeoPixel
   libf3e
-  TMC26XStepper
 
 #
 # MKS Robin Nano (STM32F103VET6)
@@ -472,13 +463,12 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = c1921b4
+lib_ignore    = TMC26XStepper
   libf3c
   lib066
   Adafruit NeoPixel_ID28
   Adafruit NeoPixel
   libf3e
-  TMC26XStepper
 
 #
 # JGAurora A5S A1 (STM32F103ZET6)
@@ -493,13 +483,12 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
-lib_ignore    = c1921b4
+lib_ignore    = TMC26XStepper
   libf3c
   lib066
   Adafruit NeoPixel_ID28
   Adafruit NeoPixel
   libf3e
-  TMC26XStepper
 monitor_speed = 250000
 
 #
@@ -515,7 +504,7 @@ extra_scripts = pre:buildroot/share/PlatformIO/scripts/black_stm32f407vet6.py
 build_flags = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
 lib_deps = ${common.lib_deps}
-lib_ignore = Adafruit NeoPixel, c1921b4, TMCStepper, TMC26XStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+lib_ignore = Adafruit NeoPixel, TMC26XStepper, TMCStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
@@ -531,7 +520,7 @@ build_flags = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
   -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000 -DHAVE_HWSERIAL6
 lib_deps = ${common.lib_deps}
-lib_ignore = Adafruit NeoPixel, c1921b4, TMC26XStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+lib_ignore = Adafruit NeoPixel, TMC26XStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
@@ -572,18 +561,16 @@ build_flags = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py -DMCU_ST
   -DDEBUG_LEVEL=0
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 #-<frameworks>
-lib_ignore  =
+lib_ignore  = Adafruit NeoPixel
   U8glib
   LiquidCrystal_I2C
   LiquidCrystal
   NewliquidCrystal
   LiquidTWI2
-  Adafruit NeoPixel
+  TMC26XStepper
   TMCStepper
   Servo(STM32F1)
-  TMC26XStepper
   U8glib-HAL
-  c1921b4
 
 #
 # Espressif ESP32
@@ -598,13 +585,11 @@ upload_port = /dev/ttyUSB0
 lib_deps =
   AsyncTCP=https://github.com/me-no-dev/AsyncTCP/archive/master.zip
   ESPAsyncWebServer=https://github.com/me-no-dev/ESPAsyncWebServer/archive/master.zip
-lib_ignore  =
+lib_ignore  = TMC26XStepper
   LiquidCrystal_I2C
   LiquidCrystal
   NewliquidCrystal
   LiquidTWI2
-  TMC26XStepper
-  c1921b4
   SailfishLCD
   SailfishRGB_LED
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
@@ -646,6 +631,5 @@ framework     = arduino
 build_flags   = ${common.build_flags}
   -Wl,-Map,$BUILD_DIR/firmware.map -Wl,--cref
 lib_deps      = ${common.lib_deps}
-lib_ignore    = U8glib-HAL
- c1921b4
+lib_ignore    = U8glib-HAL, TMC26XStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_SAMD51>

commit f89eb8bf358b890fa62352a8d11bac2d5b04e9f9
Author: George Fu <nailao_5918@163.com>
Date:   Sun Aug 4 07:12:35 2019 +0800

    Fysetc Cheetah updates (#14800)

diff --git a/platformio.ini b/platformio.ini
index 6d4b8f4a4a..7a3137e443 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -36,9 +36,9 @@ lib_deps =
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
   https://github.com/ameyer/Arduino-L6470/archive/dev.zip
   https://github.com/trinamic/TMC26XStepper/archive/c1921b4.zip
-  https://github.com/mikeshub/SailfishLCD.git
-  https://github.com/mikeshub/SailfishRGB_LED.git
-  https://github.com/mikeshub/SlowSoftI2CMaster.git
+  SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
+  SailfishRGB_LED=https://github.com/mikeshub/SailfishRGB_LED/archive/master.zip
+  SlowSoftI2CMaster=https://github.com/mikeshub/SlowSoftI2CMaster/archive/master.zip
 
 #################################
 #                               #
@@ -167,7 +167,7 @@ lib_deps          = Servo
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMCStepper@<1.0.0
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/master.zip
-  https://github.com/mikeshub/SailfishLCD.git
+  SailfishLCD=https://github.com/mikeshub/SailfishLCD/archive/master.zip
 
 [env:LPC1769]
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/master.zip
@@ -291,6 +291,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   -DDEBUG_LEVEL=0
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
+  SoftwareSerialM=https://github.com/FYSETC/SoftwareSerialM/archive/master.zip
 lib_ignore    =
   c1921b4
   libf3c
@@ -595,8 +596,8 @@ upload_speed  = 115200
 monitor_speed = 115200
 upload_port = /dev/ttyUSB0
 lib_deps =
-  https://github.com/me-no-dev/AsyncTCP.git
-  https://github.com/me-no-dev/ESPAsyncWebServer.git
+  AsyncTCP=https://github.com/me-no-dev/AsyncTCP/archive/master.zip
+  ESPAsyncWebServer=https://github.com/me-no-dev/ESPAsyncWebServer/archive/master.zip
 lib_ignore  =
   LiquidCrystal_I2C
   LiquidCrystal

commit 8efa3455c21a6ef9a8b3c13ccb2085015a65113a
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Fri Aug 2 14:28:38 2019 +0200

    STM32F1: Reduce binary by 2K by dropping full path asserts (#14807)

diff --git a/platformio.ini b/platformio.ini
index 0c7c8d4031..6d4b8f4a4a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -262,6 +262,7 @@ framework     = arduino
 board         = genericSTM32F103RE
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags} -std=gnu++14
+  -DDEBUG_LEVEL=0
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
 lib_ignore    = U8glib-HAL
@@ -286,7 +287,9 @@ board         = genericSTM32F103RC
 #board_build.core = maple
 extra_scripts = buildroot/share/PlatformIO/scripts/fysetc_STM32F1.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
-  ${common.build_flags}
+  ${common.build_flags} -std=gnu++14
+  -DDEBUG_LEVEL=0
+build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
 lib_ignore    =
   c1921b4
@@ -312,6 +315,7 @@ board         = genericSTM32F103RC
 extra_scripts = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags} -std=gnu++14
+  -DDEBUG_LEVEL=0
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
 lib_ignore    =
@@ -564,6 +568,7 @@ platform    = ststm32
 framework   = arduino
 board       = malyanM200
 build_flags = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
+  -DDEBUG_LEVEL=0
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 #-<frameworks>
 lib_ignore  =

commit e85eca2630db50574f3829aa9d58237d7562d38f
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Aug 2 07:22:07 2019 -0500

    HAL cleanup, Teensy 3.1 platform

diff --git a/platformio.ini b/platformio.ini
index 1a2e0fe2e5..0c7c8d4031 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -530,6 +530,19 @@ lib_ignore = Adafruit NeoPixel, c1921b4, TMC26XStepper, SailfishLCD, SailfishRGB
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
+#
+# Teensy 3.1 / 3.2 (ARM Cortex-M4)
+#
+[env:teensy31]
+platform      = teensy
+framework     = arduino
+board         = teensy31
+build_flags   = ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+lib_ignore    = Adafruit NeoPixel
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY31_32>
+monitor_speed = 250000
+
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #

commit f8b8cbfc53b4ecad27470f08864920c75218b0e1
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Jul 31 15:02:11 2019 -0500

    Press the big red button on PlatformIO 4.0

diff --git a/platformio.ini b/platformio.ini
index 18fc812795..1a2e0fe2e5 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -21,7 +21,7 @@ build_dir    = .pioenvs
 lib_dir      = .piolib
 libdeps_dir  = .piolibdeps
 boards_dir   = buildroot/share/PlatformIO/boards
-env_default  = megaatmega2560
+default_envs = megaatmega2560
 
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>

commit d98b9d54f112e9a66cf372ffcee165b799479f31
Author: pinchies <pinchies@gmail.com>
Date:   Wed Jul 31 08:08:11 2019 +1000

    JGAurora A5S & A1 touch support (#14768)

diff --git a/platformio.ini b/platformio.ini
index 2c8942e70e..18fc812795 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -478,13 +478,13 @@ lib_ignore    = c1921b4
 #
 # JGAurora A5S A1 (STM32F103ZET6)
 #
-[env:JGAURORA_A5S_A1]
+[env:jgaurora_a5s_a1]
 platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
-  ${common.build_flags} -std=gnu++14
+  ${common.build_flags} -DSTM32F1xx -std=gnu++14
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
@@ -495,7 +495,6 @@ lib_ignore    = c1921b4
   Adafruit NeoPixel
   libf3e
   TMC26XStepper
-lib_ldf_mode  = chain
 monitor_speed = 250000
 
 #

commit 290466578f8bb6ba0cd61e1dd3dc0839ae53d4f3
Author: Giuliano Zaro <3684609+GMagician@users.noreply.github.com>
Date:   Sun Jul 28 21:48:29 2019 +0200

    Adafruit Grand Central M4 (#14749)

diff --git a/platformio.ini b/platformio.ini
index 27a5604b65..2c8942e70e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -617,3 +617,17 @@ lib_ldf_mode    = off
 lib_deps        =
 extra_scripts   =
 src_filter      = ${common.default_src_filter} +<src/HAL/HAL_LINUX>
+
+#
+# Adafruit Grand Central M4 (Atmel SAMD51P20A ARM Cortex-M4)
+#
+[env:adafruit_grandcentral_m4]
+platform      = atmelsam
+board         = adafruit_grandcentral_m4
+framework     = arduino
+build_flags   = ${common.build_flags}
+  -Wl,-Map,$BUILD_DIR/firmware.map -Wl,--cref
+lib_deps      = ${common.lib_deps}
+lib_ignore    = U8glib-HAL
+ c1921b4
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_SAMD51>

commit d74efd9d46eef7676832f6fb40b80008b4537b69
Author: thisiskeithb <13375512+thisiskeithb@users.noreply.github.com>
Date:   Sat Jul 27 02:43:37 2019 -0700

    MKS Robin Lite/Lite2 Board Support (#14729)

diff --git a/platformio.ini b/platformio.ini
index 2b71e75228..27a5604b65 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -412,6 +412,27 @@ lib_ignore    = c1921b4
   TMC26XStepper
   U8glib-HAL
 
+#
+# MKS ROBIN LITE/LITE2 (STM32F103RCT6)
+#
+[env:mks_robin_lite]
+platform      = ststm32
+framework     = arduino
+board         = genericSTM32F103RC
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_lite.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = c1921b4
+  libf3c
+  lib066
+  Adafruit NeoPixel_ID28
+  Adafruit NeoPixel
+  libf3e
+  TMC26XStepper
+
 #
 # MKS Robin Mini (STM32F103VET6)
 #

commit 7084f3647a87966e1df6af9ef3e86c5dec3c1bfd
Author: Benjamin Reed <br33d@yahoo.com>
Date:   Sat Jul 27 02:36:22 2019 -0700

    Flag to reduce Melzi binary size (#14730)

diff --git a/platformio.ini b/platformio.ini
index 9a879365e9..2b71e75228 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -195,7 +195,7 @@ lib_deps          = Servo
 platform      = atmelavr
 framework     = arduino
 board         = sanguino_atmega1284p
-build_flags   = ${common.build_flags}
+build_flags   = ${common.build_flags} -fmerge-all-constants
 upload_speed  = 57600
 lib_deps      = ${common.lib_deps}
 lib_ignore    = TMCStepper, TMC26XStepper

commit f0be92259b20c44972a71d5279f72b477ec237f9
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Fri Jul 19 05:38:03 2019 +0200

    PIO env, Travis test for STM32F407VE (#14674)

diff --git a/platformio.ini b/platformio.ini
index b7a5e335fd..9a879365e9 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -458,12 +458,13 @@ lib_ignore    = c1921b4
 # JGAurora A5S A1 (STM32F103ZET6)
 #
 [env:JGAURORA_A5S_A1]
-platform      = ststm32@5.3.0
+platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
-  ${common.build_flags}
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
 lib_ignore    = c1921b4
@@ -482,7 +483,7 @@ monitor_speed = 250000
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:black_stm32f407ve]
-platform = ststm32
+platform = ststm32@5.4.3
 framework = arduino
 board = blackSTM32F407VET6
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/black_stm32f407vet6.py
@@ -497,13 +498,13 @@ monitor_speed = 250000
 # BIGTREE_SKR_PRO (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
-platform = ststm32
+platform = ststm32@5.4.3
 framework = arduino
 board = BigTree_SKR_Pro
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
-  -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
+  -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000 -DHAVE_HWSERIAL6
 lib_deps = ${common.lib_deps}
 lib_ignore = Adafruit NeoPixel, c1921b4, TMC26XStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>

commit 6920b7fe910ce230368d395419c99f4bd53c02a0
Author: Msq001 <760675063@qq.com>
Date:   Thu Jul 18 18:43:49 2019 +0800

    BigTreeTech SKR E3 DIP (#14638)

diff --git a/platformio.ini b/platformio.ini
index 84a4a67752..b7a5e335fd 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -303,7 +303,7 @@ debug_tool    = stlink
 upload_protocol = serial
 
 #
-# BIGTREE_SKR_MINI
+# BigTree SKR Mini V1.1 / SKR mini E3 / SKR E3 DIP (STM32F103RCT6 ARM Cortex-M3)
 #
 [env:BIGTREE_SKR_MINI]
 platform      = ststm32

commit 45bde333d594b7a7031780acad88c9af80dde026
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Mon Jul 15 01:05:24 2019 +0200

    Initial Longer3D LK1/2 (Alfawise U20/U20+/U30) support (#14597)

diff --git a/platformio.ini b/platformio.ini
index 7ac2cdc7ad..84a4a67752 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -367,6 +367,29 @@ lib_ignore  = Adafruit NeoPixel, c1921b4
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
+#
+# Alfawise U20 (STM32F103VET6)
+#
+[env:alfawise_U20]
+platform      = ststm32
+framework     = arduino
+board         = genericSTM32F103VE
+monitor_speed = 250000
+extra_scripts = buildroot/share/PlatformIO/scripts/alfawise_Ux0.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+  ${common.build_flags} -std=gnu++14
+  -DSTM32F1xx -DU20 -DTS_V12
+build_unflags = -std=gnu++11 -DCONFIG_MAPLE_MINI_NO_DISABLE_DEBUG=1
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = c1921b4
+  libf3c
+  lib066
+  Adafruit NeoPixel_ID28
+  Adafruit NeoPixel
+  libf3e
+  TMC26XStepper
+
 #
 # MKS Robin (STM32F103ZET6)
 #

commit 21e1148d98045c28b7120b97f098120faf837267
Author: Msq001 <760675063@qq.com>
Date:   Sun Jul 14 22:43:38 2019 +0800

    Remove upload_protocol "cmsis-dap" (#14606)

diff --git a/platformio.ini b/platformio.ini
index 68a87bb569..7ac2cdc7ad 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -485,7 +485,6 @@ lib_deps = ${common.lib_deps}
 lib_ignore = Adafruit NeoPixel, c1921b4, TMC26XStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
-upload_protocol = cmsis-dap
 
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)

commit 4a5f135c5d7493f42a1876552c0fccf068d62b9c
Author: Giuliano Zaro <3684609+GMagician@users.noreply.github.com>
Date:   Fri Jul 12 11:20:34 2019 +0200

    PIO 4 strict parser fix (1 => chain) (#14586)

diff --git a/platformio.ini b/platformio.ini
index 0ca1b1a87c..68a87bb569 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -272,7 +272,7 @@ lib_ignore    = U8glib-HAL
   Adafruit NeoPixel
   libf3e
   TMC26XStepper
-#lib_ldf_mode  = 1
+#lib_ldf_mode  = chain
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
 
@@ -296,7 +296,7 @@ lib_ignore    =
   Adafruit NeoPixel
   libf3e
   TMC26XStepper
-lib_ldf_mode  = 1
+lib_ldf_mode  = chain
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
 debug_tool    = stlink
@@ -322,7 +322,7 @@ lib_ignore    =
   Adafruit NeoPixel
   libf3e
   TMC26XStepper
-#lib_ldf_mode  = 1
+#lib_ldf_mode  = chain
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 115200
 upload_protocol = stlink
@@ -450,7 +450,7 @@ lib_ignore    = c1921b4
   Adafruit NeoPixel
   libf3e
   TMC26XStepper
-lib_ldf_mode  = 1
+lib_ldf_mode  = chain
 monitor_speed = 250000
 
 #

commit ad1c061e7b4522f30e8bc4deac565baa0c4b6568
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Jul 9 23:54:34 2019 -0500

    Bring STM32F4/F7 together

diff --git a/platformio.ini b/platformio.ini
index 1dbd74b94d..0ca1b1a87c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -329,7 +329,7 @@ upload_protocol = stlink
 debug_tool = stlink
 
 #
-# STM32F4
+# STM32F4 with STM32GENERIC
 #
 [env:STM32F4]
 platform      = ststm32
@@ -338,7 +338,20 @@ board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
 lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, c1921b4, TMCStepper
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F4>
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/*> +<src/HAL/HAL_STM32_F4_F7/STM32F4>
+monitor_speed = 250000
+
+#
+# STM32F7 with STM32GENERIC
+#
+[env:STM32F7]
+platform      = ststm32
+framework     = arduino
+board         = disco_f765vg
+build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
+lib_deps      = ${common.lib_deps}
+lib_ignore    = Adafruit NeoPixel, c1921b4, TMCStepper
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32_F4_F7> -<src/HAL/HAL_STM32_F4_F7/*> +<src/HAL/HAL_STM32_F4_F7/STM32F7>
 monitor_speed = 250000
 
 #
@@ -467,7 +480,7 @@ board = BigTree_SKR_Pro
 extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags = ${common.build_flags}
   -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
-  -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000  
+  -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
 lib_deps = ${common.lib_deps}
 lib_ignore = Adafruit NeoPixel, c1921b4, TMC26XStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>

commit 439e28783bc24b371fa2cd5e73a647b7b63f1b4e
Author: Msq001 <760675063@qq.com>
Date:   Sun Jul 7 10:52:17 2019 +0800

    BigTree SKR Pro V1.1 board support (#14523)

diff --git a/platformio.ini b/platformio.ini
index 24250e4950..1dbd74b94d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -457,6 +457,23 @@ lib_ignore = Adafruit NeoPixel, c1921b4, TMCStepper, TMC26XStepper, SailfishLCD,
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
+#
+# BIGTREE_SKR_PRO (STM32F407ZGT6 ARM Cortex-M4)
+#
+[env:BIGTREE_SKR_PRO]
+platform = ststm32
+framework = arduino
+board = BigTree_SKR_Pro
+extra_scripts = pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+build_flags = ${common.build_flags}
+  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"STM32F407ZG\"
+  -DTARGET_STM32F4 -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000  
+lib_deps = ${common.lib_deps}
+lib_ignore = Adafruit NeoPixel, c1921b4, TMC26XStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed = 250000
+upload_protocol = cmsis-dap
+
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #

commit fb9d30673f24c4dd4709a5f2cfbf6081347148b7
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Mon Jul 1 05:40:15 2019 -0500

    platformio.ini compatible with PIO 3.x

diff --git a/platformio.ini b/platformio.ini
index 30b6dc91b5..24250e4950 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -21,7 +21,7 @@ build_dir    = .pioenvs
 lib_dir      = .piolib
 libdeps_dir  = .piolibdeps
 boards_dir   = buildroot/share/PlatformIO/boards
-default_envs = megaatmega2560
+env_default  = megaatmega2560
 
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>

commit 6550a222aab41d31c7338cd4f5bfc27427110fab
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Jun 29 02:21:36 2019 -0500

    env_default => default_envs

diff --git a/platformio.ini b/platformio.ini
index 82e7cf6dfb..30b6dc91b5 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -16,12 +16,12 @@
 #
 
 [platformio]
-src_dir     = Marlin
-build_dir   = .pioenvs
-lib_dir     = .piolib
-libdeps_dir = .piolibdeps
-boards_dir  = buildroot/share/PlatformIO/boards
-env_default = megaatmega2560
+src_dir      = Marlin
+build_dir    = .pioenvs
+lib_dir      = .piolib
+libdeps_dir  = .piolibdeps
+boards_dir   = buildroot/share/PlatformIO/boards
+default_envs = megaatmega2560
 
 [common]
 default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>

commit 8b63e3701fea411e38762882e7b74805d32fd261
Author: thisiskeithb <13375512+thisiskeithb@users.noreply.github.com>
Date:   Thu Jun 27 19:33:41 2019 -0700

    MKS Robin Nano board support (#14363)

diff --git a/platformio.ini b/platformio.ini
index 45eba7e771..82e7cf6dfb 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -377,7 +377,7 @@ lib_ignore    = c1921b4
   U8glib-HAL
 
 #
-# MKS Robin nano (STM32F103VET6)
+# MKS Robin Mini (STM32F103VET6)
 #
 [env:mks_robin_mini]
 platform      = ststm32
@@ -397,6 +397,27 @@ lib_ignore    = c1921b4
   libf3e
   TMC26XStepper
 
+#
+# MKS Robin Nano (STM32F103VET6)
+#
+[env:mks_robin_nano]
+platform      = ststm32
+framework     = arduino
+board         = genericSTM32F103VE
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_nano.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = c1921b4
+  libf3c
+  lib066
+  Adafruit NeoPixel_ID28
+  Adafruit NeoPixel
+  libf3e
+  TMC26XStepper
+
 #
 # JGAurora A5S A1 (STM32F103ZET6)
 #

commit 39c0c2aebe41f2cad6fbc5411d8bd6b9d50c4711
Author: InsanityAutomation <38436470+InsanityAutomation@users.noreply.github.com>
Date:   Thu Jun 27 17:57:38 2019 -0400

    Add TMCStepper libs to lib_ignore for Melzi (#14322)

diff --git a/platformio.ini b/platformio.ini
index a81bc8b7d7..45eba7e771 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -198,6 +198,7 @@ board         = sanguino_atmega1284p
 build_flags   = ${common.build_flags}
 upload_speed  = 57600
 lib_deps      = ${common.lib_deps}
+lib_ignore    = TMCStepper, TMC26XStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 
@@ -211,6 +212,7 @@ board         = sanguino_atmega1284p
 build_flags   = ${common.build_flags}
 upload_speed  = 115200
 lib_deps      = ${common.lib_deps}
+lib_ignore    = TMCStepper, TMC26XStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 

commit e3846ec7a1acbe4b69913daa325d3f2707baa9b6
Author: Msq001 <760675063@qq.com>
Date:   Wed Jun 26 14:12:41 2019 +0800

    SKR mini can use 128x64 LCD (#14388)

diff --git a/platformio.ini b/platformio.ini
index 65ddf8be56..a81bc8b7d7 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -312,7 +312,7 @@ build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags} -std=gnu++14
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
-lib_ignore    = U8glib-HAL
+lib_ignore    =
   c1921b4
   libf3c
   lib066

commit 8934b32f1b9bd388eae25f0372ed62b57200bab8
Author: Eric Ptak <trouch@trouch.com>
Date:   Wed Jun 26 07:40:29 2019 +0200

    Fysetc AIO II / Cheetah STM32F1 (#14407)

diff --git a/platformio.ini b/platformio.ini
index d023d14d6d..65ddf8be56 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -274,6 +274,32 @@ lib_ignore    = U8glib-HAL
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
 
+#
+# fysetc_STM32F1
+#
+[env:fysetc_STM32F1]
+platform      = ststm32
+framework     = arduino
+board         = genericSTM32F103RC
+#board_build.core = maple
+extra_scripts = buildroot/share/PlatformIO/scripts/fysetc_STM32F1.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+  ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+lib_ignore    =
+  c1921b4
+  libf3c
+  lib066
+  Adafruit NeoPixel_ID28
+  Adafruit NeoPixel
+  libf3e
+  TMC26XStepper
+lib_ldf_mode  = 1
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+monitor_speed = 250000
+debug_tool    = stlink
+upload_protocol = serial
+
 #
 # BIGTREE_SKR_MINI
 #

commit a4aa3621c087667ced39b796dfb9b8fdd4680a36
Author: thisiskeithb <13375512+thisiskeithb@users.noreply.github.com>
Date:   Mon Jun 24 01:42:22 2019 -0700

    MKS Robin Mini Board Support (#14366)

diff --git a/platformio.ini b/platformio.ini
index d683e2cd79..d023d14d6d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -284,7 +284,6 @@ board         = genericSTM32F103RC
 extra_scripts = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags} -std=gnu++14
-  -g
 build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
 lib_ignore    = U8glib-HAL
@@ -337,7 +336,6 @@ board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags} -std=gnu++14
-  -DSTM32_XL_DENSITY
 build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
@@ -350,6 +348,27 @@ lib_ignore    = c1921b4
   TMC26XStepper
   U8glib-HAL
 
+#
+# MKS Robin nano (STM32F103VET6)
+#
+[env:mks_robin_mini]
+platform      = ststm32
+framework     = arduino
+board         = genericSTM32F103VE
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin_mini.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = c1921b4
+  libf3c
+  lib066
+  Adafruit NeoPixel_ID28
+  Adafruit NeoPixel
+  libf3e
+  TMC26XStepper
+
 #
 # JGAurora A5S A1 (STM32F103ZET6)
 #
@@ -359,7 +378,7 @@ framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
-  ${common.build_flags} -DSTM32_XL_DENSITY
+  ${common.build_flags}
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
 lib_ignore    = c1921b4

commit 1b1a4677f56bb21ee39067417693e5ff2814a534
Author: mikeshub <mikesbaker@gmail.com>
Date:   Sat Jun 22 21:08:30 2019 -0500

    Fix LCD.h compilation error (#14377)

diff --git a/platformio.ini b/platformio.ini
index 5a298e42b4..d683e2cd79 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -167,6 +167,7 @@ lib_deps          = Servo
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMCStepper@<1.0.0
   Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/master.zip
+  https://github.com/mikeshub/SailfishLCD.git
 
 [env:LPC1769]
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/master.zip

commit 3021097888e3ba6be034046d6592de53ea6ec786
Author: pinchies <pinchies@gmail.com>
Date:   Sun Jun 16 05:28:22 2019 +1000

    Add JGAurora A5S and A1 (STM32F103ZET6) (#14291)
    
    - Now compiles and works correctly with changes to HAL timers and watchdog.
    - Does NOT include awesome work on touch screen function.
    - Does have working LCD and SD-based EEPROM.

diff --git a/platformio.ini b/platformio.ini
index 0835ff4d0e..5a298e42b4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -349,6 +349,28 @@ lib_ignore    = c1921b4
   TMC26XStepper
   U8glib-HAL
 
+#
+# JGAurora A5S A1 (STM32F103ZET6)
+#
+[env:JGAURORA_A5S_A1]
+platform      = ststm32@5.3.0
+framework     = arduino
+board         = genericSTM32F103ZE
+extra_scripts = buildroot/share/PlatformIO/scripts/jgaurora_a5s_a1_with_bootloader.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+  ${common.build_flags} -DSTM32_XL_DENSITY
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = c1921b4
+  libf3c
+  lib066
+  Adafruit NeoPixel_ID28
+  Adafruit NeoPixel
+  libf3e
+  TMC26XStepper
+lib_ldf_mode  = 1
+monitor_speed = 250000
+
 #
 # STM32F407VET6 with RAMPS-like shield
 # 'Black' STM32F407VET6 board - http://wiki.stm32duino.com/index.php?title=STM32F407

commit 7d1eafc80acb2437607f2cfa6ed8eca7bf13201e
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Thu Jun 13 01:44:32 2019 +0200

    STM32F1: C++14 for static_assert, etc. (#14278)

diff --git a/platformio.ini b/platformio.ini
index 2c244a2ba8..0835ff4d0e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -258,7 +258,8 @@ platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103RE
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
-  ${common.build_flags}
+  ${common.build_flags} -std=gnu++14
+build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
 lib_ignore    = U8glib-HAL
   c1921b4
@@ -268,7 +269,7 @@ lib_ignore    = U8glib-HAL
   Adafruit NeoPixel
   libf3e
   TMC26XStepper
-lib_ldf_mode  = 1
+#lib_ldf_mode  = 1
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
 
@@ -281,8 +282,9 @@ framework     = arduino
 board         = genericSTM32F103RC
 extra_scripts = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
-  ${common.build_flags}
+  ${common.build_flags} -std=gnu++14
   -g
+build_unflags = -std=gnu++11
 lib_deps      = ${common.lib_deps}
 lib_ignore    = U8glib-HAL
   c1921b4
@@ -292,7 +294,7 @@ lib_ignore    = U8glib-HAL
   Adafruit NeoPixel
   libf3e
   TMC26XStepper
-lib_ldf_mode  = 1
+#lib_ldf_mode  = 1
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 115200
 upload_protocol = stlink
@@ -328,13 +330,14 @@ monitor_speed = 250000
 # MKS Robin (STM32F103ZET6)
 #
 [env:mks_robin]
-platform      = ststm32@5.3.0
+platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
-  ${common.build_flags}
+  ${common.build_flags} -std=gnu++14
   -DSTM32_XL_DENSITY
+build_unflags = -std=gnu++11
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
 lib_ignore    = c1921b4

commit 9439fab7fd415d2a08d8044491145c1b155b20d3
Author: felixstorm <felix.storm@gmx.de>
Date:   Tue Jun 11 06:22:19 2019 +0200

    Fix ESP32 servos, platformio.ini, etc. (#14247)

diff --git a/platformio.ini b/platformio.ini
index 6953a9caec..2c244a2ba8 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -403,10 +403,10 @@ lib_ignore  =
 # Espressif ESP32
 #
 [env:esp32]
-platform    = https://github.com/platformio/platform-espressif32.git ; #feature/stage
-board       = esp32dev
-framework   = arduino
-upload_speed = 115200
+platform      = espressif32
+board         = esp32dev
+framework     = arduino
+upload_speed  = 115200
 monitor_speed = 115200
 upload_port = /dev/ttyUSB0
 lib_deps =

commit b0a4ea79b84e92326b7da4349126a5cf2d9821a0
Author: yangwenxiong <46896566+yangwenxiong@users.noreply.github.com>
Date:   Tue Jun 11 10:10:51 2019 +0800

    BigTreeTech SKR Mini v1.1 (#14041)

diff --git a/platformio.ini b/platformio.ini
index 96f33b3eba..6953a9caec 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -272,6 +272,32 @@ lib_ldf_mode  = 1
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
 
+#
+# BIGTREE_SKR_MINI
+#
+[env:BIGTREE_SKR_MINI]
+platform      = ststm32
+framework     = arduino
+board         = genericSTM32F103RC
+extra_scripts = buildroot/share/PlatformIO/scripts/STM32F1_SKR_MINI.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+  ${common.build_flags}
+  -g
+lib_deps      = ${common.lib_deps}
+lib_ignore    = U8glib-HAL
+  c1921b4
+  libf3c
+  lib066
+  Adafruit NeoPixel_ID28
+  Adafruit NeoPixel
+  libf3e
+  TMC26XStepper
+lib_ldf_mode  = 1
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+monitor_speed = 115200
+upload_protocol = stlink
+debug_tool = stlink
+
 #
 # STM32F4
 #

commit 3bf43b6c1e5051ee279a07babffdfb73e3aa812d
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Sun May 12 01:10:40 2019 +0200

    Re-enable STM32F1 Travis test (#13978)

diff --git a/platformio.ini b/platformio.ini
index c9327f299a..96f33b3eba 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -254,7 +254,7 @@ monitor_speed = 250000
 # STM32F103RE
 #
 [env:STM32F1]
-platform      = ststm32@<4.4.0
+platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103RE
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py

commit 1de6e7fb9d7a4eef4f10125a05ec608aca9d5168
Author: SmallSharky <kizzyol76@gmail.com>
Date:   Sun Apr 7 02:07:21 2019 +0300

    Fix MKS Robin section in platformio.ini (#13598)
    
    Updated ststm32 version because the old version gives build errors. Added `U8glib-HAL` to ignore list because there are also build errors.

diff --git a/platformio.ini b/platformio.ini
index 9d3b4cdc04..c9327f299a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -302,7 +302,7 @@ monitor_speed = 250000
 # MKS Robin (STM32F103ZET6)
 #
 [env:mks_robin]
-platform      = ststm32@5.1.0
+platform      = ststm32@5.3.0
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
@@ -318,6 +318,7 @@ lib_ignore    = c1921b4
   Adafruit NeoPixel
   libf3e
   TMC26XStepper
+  U8glib-HAL
 
 #
 # STM32F407VET6 with RAMPS-like shield

commit 3c47e1b4d15ab491e37b2bc4e2a4968fec27125f
Author: Alexander Gavrilenko <jmz52@users.noreply.github.com>
Date:   Fri Apr 5 23:30:19 2019 +0300

    Support Black STM32F407VET6 with RAMPS-like shield (#13524)

diff --git a/platformio.ini b/platformio.ini
index e605a3d837..9d3b4cdc04 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -307,7 +307,6 @@ framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
- -DSTM32_XL_DENSITY
   ${common.build_flags}
   -DSTM32_XL_DENSITY
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
@@ -320,6 +319,23 @@ lib_ignore    = c1921b4
   libf3e
   TMC26XStepper
 
+#
+# STM32F407VET6 with RAMPS-like shield
+# 'Black' STM32F407VET6 board - http://wiki.stm32duino.com/index.php?title=STM32F407
+# Shield - https://github.com/jmz52/Hardware
+#
+[env:black_stm32f407ve]
+platform = ststm32
+framework = arduino
+board = blackSTM32F407VET6
+extra_scripts = pre:buildroot/share/PlatformIO/scripts/black_stm32f407vet6.py
+build_flags = ${common.build_flags}
+  -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSB_PRODUCT=\"BLACK_F407VE\"
+lib_deps = ${common.lib_deps}
+lib_ignore = Adafruit NeoPixel, c1921b4, TMCStepper, TMC26XStepper, SailfishLCD, SailfishRGB_LED, SlowSoftI2CMaster
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_STM32>
+monitor_speed = 250000
+
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #

commit cacec5764aee0d1fb5b439d550287970e19f1686
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Apr 3 20:21:06 2019 -0500

    Clean up whitespace

diff --git a/platformio.ini b/platformio.ini
index d8f1de564a..e605a3d837 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -307,7 +307,7 @@ framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
- -DSTM32_XL_DENSITY 
+ -DSTM32_XL_DENSITY
   ${common.build_flags}
   -DSTM32_XL_DENSITY
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>

commit de0f35f2d943d3e4889936173c8f53d92601580e
Author: pinchies <pinchies@gmail.com>
Date:   Sat Mar 30 05:57:19 2019 +1100

    Fix platformio.ini for MKS Robin (#13502)

diff --git a/platformio.ini b/platformio.ini
index b474361ce9..d8f1de564a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -302,11 +302,12 @@ monitor_speed = 250000
 # MKS Robin (STM32F103ZET6)
 #
 [env:mks_robin]
-platform      = ststm32
+platform      = ststm32@5.1.0
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
+ -DSTM32_XL_DENSITY 
   ${common.build_flags}
   -DSTM32_XL_DENSITY
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>

commit 6d9aaca0828cab5abf0541394ebe60f04d01c989
Author: Alexander Gavrilenko <jmz52@users.noreply.github.com>
Date:   Fri Mar 29 20:40:24 2019 +0300

    Fix compilation error for MKS Robin (#13506)

diff --git a/platformio.ini b/platformio.ini
index 6ca0fe7125..b474361ce9 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -308,6 +308,7 @@ board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags}
+  -DSTM32_XL_DENSITY
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
 lib_ignore    = c1921b4

commit 0278ad0a6d4bc49bf6343d5e61b695cf57601c53
Author: Hadrien Jouet <hadrien.jouet@gmail.com>
Date:   Tue Mar 12 22:48:08 2019 -0700

    Add ESP32 WiFi interface (#11209)

diff --git a/platformio.ini b/platformio.ini
index 5a1372d030..6ca0fe7125 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -286,7 +286,7 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F4>
 monitor_speed = 250000
 
 #
-# ARMED
+# ARMED (STM32)
 #
 [env:ARMED]
 platform    = ststm32
@@ -331,6 +331,9 @@ lib_ignore    = Adafruit NeoPixel
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
 monitor_speed = 250000
 
+#
+# Malyan M200 (STM32F1)
+#
 [env:malyanm200]
 platform    = ststm32
 framework   = arduino
@@ -355,11 +358,15 @@ lib_ignore  =
 # Espressif ESP32
 #
 [env:esp32]
-platform    = https://github.com/platformio/platform-espressif32.git#feature/stage
+platform    = https://github.com/platformio/platform-espressif32.git ; #feature/stage
 board       = esp32dev
 framework   = arduino
 upload_speed = 115200
 monitor_speed = 115200
+upload_port = /dev/ttyUSB0
+lib_deps =
+  https://github.com/me-no-dev/AsyncTCP.git
+  https://github.com/me-no-dev/ESPAsyncWebServer.git
 lib_ignore  =
   LiquidCrystal_I2C
   LiquidCrystal

commit 8d950194427e2920caea908d2845d53336cc07ef
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Wed Mar 6 23:54:19 2019 +0000

    LPC176x NeoPixel Support (#13322)

diff --git a/platformio.ini b/platformio.ini
index 93938d45c9..5a1372d030 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -166,6 +166,7 @@ lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMCStepper@<1.0.0
+  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/master.zip
 
 [env:LPC1769]
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/master.zip
@@ -184,6 +185,7 @@ lib_deps          = Servo
   LiquidCrystal
   U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMCStepper@<1.0.0
+  Adafruit NeoPixel=https://github.com/p3p/Adafruit_NeoPixel/archive/master.zip
 
 #
 # Melzi and clones (ATmega1284p)

commit 15aa932aa6becbcb917cd0bd547dcc5ae0068b82
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Feb 22 19:09:10 2019 -0600

    HAL for Linux (#13146)

diff --git a/platformio.ini b/platformio.ini
index d877926a92..93938d45c9 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -381,3 +381,17 @@ board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed     = 250000
+
+#
+# Native
+# No supported Arduino libraries, base Marlin only
+#
+[env:linux_native]
+platform        = native
+build_flags     = -D__PLAT_LINUX__ -std=gnu++17 -ggdb -g -lrt -lpthread
+src_build_flags = -Wall -IMarlin/src/HAL/HAL_LINUX/include
+build_unflags   = -Wall
+lib_ldf_mode    = off
+lib_deps        =
+extra_scripts   =
+src_filter      = ${common.default_src_filter} +<src/HAL/HAL_LINUX>

commit 5cd0fa3ce1ea2e6839c2a19816b16c821fddc8a5
Author: Simon Jouet <simon-jouet@users.noreply.github.com>
Date:   Sun Feb 10 11:40:31 2019 +0000

    Basic GPIO expander using the ESP32 I2S peripheral (#12959)

diff --git a/platformio.ini b/platformio.ini
index 2b85f1ce2a..d877926a92 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -356,7 +356,8 @@ lib_ignore  =
 platform    = https://github.com/platformio/platform-espressif32.git#feature/stage
 board       = esp32dev
 framework   = arduino
-upload_port = COM3
+upload_speed = 115200
+monitor_speed = 115200
 lib_ignore  =
   LiquidCrystal_I2C
   LiquidCrystal
@@ -364,6 +365,8 @@ lib_ignore  =
   LiquidTWI2
   TMC26XStepper
   c1921b4
+  SailfishLCD
+  SailfishRGB_LED
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
 
 #

commit 02ab66fca36a3fe981dce3cc96f3ceb9d948673e
Author: Thomas Moore <tcm0116@users.noreply.github.com>
Date:   Mon Jan 28 00:11:34 2019 -0500

    Update Cohesion3D Pins Files (#13027)

diff --git a/platformio.ini b/platformio.ini
index b096d5a562..2b85f1ce2a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -171,7 +171,7 @@ lib_deps          = Servo
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/master.zip
 framework         = arduino
 board             = nxp_lpc1769
-build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
+build_flags       = -DTARGET_LPC1768 -DLPC1769 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
 # debug options for backtrace
 #  -funwind-tables
 #  -mpoke-function-name

commit 2f35747f294c4b3dc3e6920b34e208f89bd4841d
Author: Bob Kuhn <bob.kuhn@att.net>
Date:   Wed Jan 23 19:06:54 2019 -0600

    L6470 SPI daisy chain support (#12895)

diff --git a/platformio.ini b/platformio.ini
index c957114ddc..b096d5a562 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -34,7 +34,7 @@ lib_deps =
   TMCStepper@<1.0.0
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
-  https://github.com/ameyer/Arduino-L6470/archive/master.zip
+  https://github.com/ameyer/Arduino-L6470/archive/dev.zip
   https://github.com/trinamic/TMC26XStepper/archive/c1921b4.zip
   https://github.com/mikeshub/SailfishLCD.git
   https://github.com/mikeshub/SailfishRGB_LED.git

commit 7fde8d9d1e264c09246b0c7f64fc5c56b3752cd6
Author: mikeshub <mikesbaker@gmail.com>
Date:   Mon Jan 14 14:29:55 2019 -0600

    Add CreatorPro / Makerbot / QIDI / etc and Mightboard RevE support (#12855)
    
    - Fix a bug in MAXxxxx thermocouple temp reporting.
    - Add support for 3-wire HD44780.
    - Add support for PCA9533 RGB driver.
    - Add configuration examples for FlashForge CreatorPro.

diff --git a/platformio.ini b/platformio.ini
index d847ea033f..c957114ddc 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -36,6 +36,9 @@ lib_deps =
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
   https://github.com/ameyer/Arduino-L6470/archive/master.zip
   https://github.com/trinamic/TMC26XStepper/archive/c1921b4.zip
+  https://github.com/mikeshub/SailfishLCD.git
+  https://github.com/mikeshub/SailfishRGB_LED.git
+  https://github.com/mikeshub/SlowSoftI2CMaster.git
 
 #################################
 #                               #

commit 2919f3045de2a7faa35b1d8a2c1709e9cf5ed993
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Sat Jan 12 01:45:33 2019 +0000

    [LPC176x] Update PIO extrascript (#12878)

diff --git a/platformio.ini b/platformio.ini
index f1340effd0..d847ea033f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -161,7 +161,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
-  https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
+  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMCStepper@<1.0.0
 
 [env:LPC1769]
@@ -179,7 +179,7 @@ src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
-  https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
+  U8glib-HAL=https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMCStepper@<1.0.0
 
 #

commit 8ae6f1e556b306148102d4f749b0c12cecf4b355
Author: Karl Andersson <karl@iaccess.se>
Date:   Fri Jan 11 02:01:31 2019 +0100

    Fix errors and some compiler warnings with HAL_STM32 PlatformIO build (#12869)

diff --git a/platformio.ini b/platformio.ini
index 8947e3f640..f1340effd0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -284,13 +284,13 @@ monitor_speed = 250000
 # ARMED
 #
 [env:ARMED]
-platform      = ststm32
-framework     = arduino
-board         = ARMED
-build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
-lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, c1921b4
-src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F4>
+platform    = ststm32
+framework   = arduino
+board       = armed_v1
+build_flags = ${common.build_flags} -DUSBCON -DUSBD_VID=0x0483 '-DUSB_MANUFACTURER="Unknown"' '-DUSB_PRODUCT="ARMED_V1"' -DHAL_PCD_MODULE_ENABLED -DUSBD_USE_CDC -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
+lib_deps    = ${common.lib_deps}
+lib_ignore  = Adafruit NeoPixel, c1921b4
+src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32>
 monitor_speed = 250000
 
 #

commit 7557f8d68c098f64b2ba17c9587f72a61129f0e9
Author: Reece Kibble <reece.kibble@gmail.com>
Date:   Tue Jan 1 06:36:49 2019 +0800

    Rename all Stm32f1 to STM32F1 (#12639)

diff --git a/platformio.ini b/platformio.ini
index 9301da0b7f..8947e3f640 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -252,7 +252,7 @@ monitor_speed = 250000
 platform      = ststm32@<4.4.0
 framework     = arduino
 board         = genericSTM32F103RE
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 lib_ignore    = U8glib-HAL
@@ -301,7 +301,7 @@ platform      = ststm32
 framework     = arduino
 board         = genericSTM32F103ZE
 extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
-build_flags   = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py
   ${common.build_flags}
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 lib_deps      = ${common.lib_deps}
@@ -330,7 +330,7 @@ monitor_speed = 250000
 platform    = ststm32
 framework   = arduino
 board       = malyanM200
-build_flags = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
+build_flags = !python Marlin/src/HAL/HAL_STM32F1/STM32F1_flag_script.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 #-<frameworks>
 lib_ignore  =

commit 33abb86b7e3ee24bfb0cd0219f777e69a78987de
Author: jmz52 <jmz52@users.noreply.github.com>
Date:   Fri Dec 21 02:23:27 2018 +0300

    Add support for MKS Robin board (#12650)
    
    Implement initial support for MKS Robin (STM32F103ZET6) board.
    Custom build script is used to generate encrypted firmware compatible with original MSK Robin bootloader (i.e. safe firmware update from SD card and possibility to go back to original close-source firmware).

diff --git a/platformio.ini b/platformio.ini
index 611899fbc4..9301da0b7f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -293,6 +293,26 @@ lib_ignore    = Adafruit NeoPixel, c1921b4
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F4>
 monitor_speed = 250000
 
+#
+# MKS Robin (STM32F103ZET6)
+#
+[env:mks_robin]
+platform      = ststm32
+framework     = arduino
+board         = genericSTM32F103ZE
+extra_scripts = buildroot/share/PlatformIO/scripts/mks_robin.py
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
+  ${common.build_flags}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
+lib_deps      = ${common.lib_deps}
+lib_ignore    = c1921b4
+  libf3c
+  lib066
+  Adafruit NeoPixel_ID28
+  Adafruit NeoPixel
+  libf3e
+  TMC26XStepper
+
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #

commit 50b2fbd03140d21076b8dd3015219ffed0f761c9
Author: teemuatlut <teemu.mantykallio@live.fi>
Date:   Fri Dec 7 23:34:21 2018 +0200

    Trinamic: Split stealthChop, improve driver monitoring, etc. (#12582)

diff --git a/platformio.ini b/platformio.ini
index 18393caaf7..611899fbc4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -31,7 +31,7 @@ build_flags = -fmax-errors=5
 lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal@1.3.4
-  https://github.com/teemuatlut/TMCStepper.git
+  TMCStepper@<1.0.0
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
   https://github.com/ameyer/Arduino-L6470/archive/master.zip
@@ -162,7 +162,7 @@ monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
-  https://github.com/teemuatlut/TMCStepper.git
+  TMCStepper@<1.0.0
 
 [env:LPC1769]
 platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/master.zip
@@ -180,7 +180,7 @@ monitor_speed     = 250000
 lib_deps          = Servo
   LiquidCrystal
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
-  https://github.com/teemuatlut/TMCStepper.git
+  TMCStepper@<1.0.0
 
 #
 # Melzi and clones (ATmega1284p)

commit 0947b92734446ce1f46eea6f753662a584f08ccc
Author: Dave Johnson <davejohnson3000@gmail.com>
Date:   Wed Dec 5 15:21:40 2018 -0800

    Build and CI fixes and optimizations (#12584)
    
    -Disable LDF "deep+" mode on AT90USB platforms. Appears not needed any longer (likely due to fix https://github.com/platformio/platformio-core/commit/7322df26ad8d43029b992a9bd3f3369840bc40da). Results in identical binary output and cuts compile time in half
    -Disable Cartesio config from CircleCI (compile failure)
    -Disable Geetech I3 Pro X GT2560 from CircleCI (compile failure)
    -Enable EEPROM on Micromake example config (fix compile failure)
    -Move FolgerTech/i3-2020 to AVR platform in CircleCI (fix CirculeCI build failure)
    -Disable various examples failing to build in CircleCI
    -Enable various examples no longer failing to build in CircleCI

diff --git a/platformio.ini b/platformio.ini
index cb2b10a37e..18393caaf7 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -86,7 +86,6 @@ framework     = arduino
 board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-lib_ldf_mode  = deep+
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_CDC.py
 monitor_speed = 250000
@@ -103,7 +102,6 @@ framework     = arduino
 board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-lib_ldf_mode  = deep+
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_DFU.py
 monitor_speed = 250000

commit 1980931153c7d5f2b75f797ac9bd681b5e43f65d
Author: skaaj4 <michel.zn@web.de>
Date:   Mon Nov 26 01:16:25 2018 +0100

    Add support for FYSETC F6 V1.3 board (#12527)

diff --git a/platformio.ini b/platformio.ini
index f5b053e15d..cb2b10a37e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -344,3 +344,16 @@ lib_ignore  =
   TMC26XStepper
   c1921b4
 src_filter  = ${common.default_src_filter} +<src/HAL/HAL_ESP32>
+
+#
+# FYSETC F6 V1.3
+#
+[env:fysetc_f6_13]
+platform          = atmelavr
+framework         = arduino
+board             = fysetc_f6_13
+build_flags       = ${common.build_flags}
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+monitor_speed     = 250000

commit 8ea4eeb78531ce3919153a2711805b05649854c0
Author: Dave Johnson <davejohnson3000@gmail.com>
Date:   Mon Nov 19 22:05:01 2018 -0800

    Revert #12311 PIO LDF work-around (#12484)

diff --git a/platformio.ini b/platformio.ini
index cafc9cd002..f5b053e15d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -86,7 +86,6 @@ framework     = arduino
 board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Teensy_ADC
 lib_ldf_mode  = deep+
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_CDC.py
@@ -104,7 +103,6 @@ framework     = arduino
 board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Teensy_ADC
 lib_ldf_mode  = deep+
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_DFU.py

commit 32880ff42aa119fa41a1ef4ce1160de621428aa9
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Mon Nov 5 00:32:32 2018 +0000

    Turn PlatformIO LDF off for LPC176x builds (#12334)

diff --git a/platformio.ini b/platformio.ini
index 752673d6e1..cafc9cd002 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -158,13 +158,14 @@ build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC176
 # debug options for backtrace
 #  -funwind-tables
 #  -mpoke-function-name
-lib_ignore        = Adafruit NeoPixel
-lib_ldf_mode      = chain+
+lib_ldf_mode      = off
 lib_compat_mode   = strict
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000
-lib_deps          = https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
+lib_deps          = Servo
+  LiquidCrystal
+  https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   https://github.com/teemuatlut/TMCStepper.git
 
 [env:LPC1769]
@@ -175,13 +176,14 @@ build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC176
 # debug options for backtrace
 #  -funwind-tables
 #  -mpoke-function-name
-lib_ignore        = Adafruit NeoPixel
-lib_ldf_mode      = chain+
+lib_ldf_mode      = off
 lib_compat_mode   = strict
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000
-lib_deps          = https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
+lib_deps          = Servo
+  LiquidCrystal
+  https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   https://github.com/teemuatlut/TMCStepper.git
 
 #

commit 8d630362b75ddb120e1680b367f004fadf655752
Author: Dave Johnson <davejohnson3000@gmail.com>
Date:   Fri Nov 2 23:17:51 2018 -0700

    Ignore ARM-based Teensy library on ATUSB90-based Teensy (#12311)
    
    Works around PIO src_filter behavior (see https://github.com/platformio/platformio-core/issues/1905)

diff --git a/platformio.ini b/platformio.ini
index 6b2a208a76..752673d6e1 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -86,6 +86,7 @@ framework     = arduino
 board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
+lib_ignore    = Teensy_ADC
 lib_ldf_mode  = deep+
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_CDC.py
@@ -103,6 +104,7 @@ framework     = arduino
 board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
+lib_ignore    = Teensy_ADC
 lib_ldf_mode  = deep+
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_DFU.py

commit 4eb798dbdc52da98a9491b8ca8831dc54281af66
Author: Karl Andersson <karl@iaccess.se>
Date:   Fri Oct 19 21:50:52 2018 +0200

    Add support for Arm'ed (STM32F4) board (#12147)

diff --git a/platformio.ini b/platformio.ini
index b7c3cd498b..6b2a208a76 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -280,6 +280,19 @@ lib_ignore    = Adafruit NeoPixel, c1921b4, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F4>
 monitor_speed = 250000
 
+#
+# ARMED
+#
+[env:ARMED]
+platform      = ststm32
+framework     = arduino
+board         = ARMED
+build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing -std=gnu11 -std=gnu++11
+lib_deps      = ${common.lib_deps}
+lib_ignore    = Adafruit NeoPixel, c1921b4
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F4>
+monitor_speed = 250000
+
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #

commit 61fbd0aa59a1576d2bc16eaccac55641750a6475
Author: Christopher Pepper <p3p@p3psoft.co.uk>
Date:   Fri Oct 12 19:18:11 2018 +0100

    update lpc builds to use platformios ldf limited to strict mode
    
    need to identify why incompatible libraries are still included without specifically disallowing them

diff --git a/platformio.ini b/platformio.ini
index 31047a8a06..b7c3cd498b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -156,7 +156,9 @@ build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC176
 # debug options for backtrace
 #  -funwind-tables
 #  -mpoke-function-name
-lib_ldf_mode      = off
+lib_ignore        = Adafruit NeoPixel
+lib_ldf_mode      = chain+
+lib_compat_mode   = strict
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000
@@ -171,7 +173,9 @@ build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC176
 # debug options for backtrace
 #  -funwind-tables
 #  -mpoke-function-name
-lib_ldf_mode      = off
+lib_ignore        = Adafruit NeoPixel
+lib_ldf_mode      = chain+
+lib_compat_mode   = strict
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000

commit 870bfd08f5813da47adec09cbb43e626b38984de
Author: Andy Shaw <andy-git@gloomy-place.com>
Date:   Wed Sep 19 18:33:20 2018 +0100

    usb and sdcard sharing improvements
    
    * Add traceback after watchdog timeout
    
    Add the cpability to perform a traceback following a watchdog timeout.
    
    * Enhanced hardware SPI
    
    Allow use of either SSP0 or SSP1.
    Ensure that no data is left in I/O buffers after calls to enable sharing of SSP hardware.
    
    * Make flash emulation of eeprom the default
    
    Make use of flash for eeprom storage the default. This means that usage of eeprom will not cause USB drive mount/unmount operations.
    
    * Allow sharing of SD card
    
    SD card I/O operations from the USB stack take place in idle loop, rather than at interrupt time. Allowing sharing of the SPI bus.
    
    New configuration options to allow usage of the SD card to be specified.
    
    * Fix problem with hardware SPI pins

diff --git a/platformio.ini b/platformio.ini
index 743bed6439..31047a8a06 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -153,6 +153,9 @@ platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/ma
 framework         = arduino
 board             = nxp_lpc1768
 build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
+# debug options for backtrace
+#  -funwind-tables
+#  -mpoke-function-name
 lib_ldf_mode      = off
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
@@ -165,6 +168,9 @@ platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/ma
 framework         = arduino
 board             = nxp_lpc1769
 build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
+# debug options for backtrace
+#  -funwind-tables
+#  -mpoke-function-name
 lib_ldf_mode      = off
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>

commit 5ddf52d58ebfd3326a967c4804b382f6b119b797
Author: Christopher Pepper <p3p@p3psoft.co.uk>
Date:   Thu Aug 23 01:08:39 2018 +0100

    [HAL][LPC176x] Pull out framework into separate repository
    
    Framework and build platform now located at https://github.com/p3p/pio-framework-arduino-lpc176x and https://github.com/p3p/pio-nxplpc-arduino-lpc176x respectively
    
    fix mkssbase leds
    
    move hardware serial
    
    remove hardware/software serial
    
    Hardware Serial extraction
    
    HardwareSerial ISRs
    
    fix disabled serial2 causing Serial object to link
    
    move usb devices out to framework
    
    separate out adc/pwm peripheral function from hal.cpp
    
    fix includes
    
    remove unused pwm init
    
    move adc
    
    HAL header update
    
    templated filtered adc
    
    LPC1769 platform

diff --git a/platformio.ini b/platformio.ini
index cf438d4f53..743bed6439 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -146,34 +146,31 @@ src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
 
 #
-# NXP LPC1768 ARM Cortex-M3
+# NXP LPC176x ARM Cortex-M3
 #
 [env:LPC1768]
-platform          = nxplpc@<3.4.0
-board             = lpc1768
-board_build.f_cpu = 100000000L
-# Override default maximum RAM. LPC1768/9 do have 64k, but in 3 blocks (32K, 16K, 16K).
-# The first 32k block is used by default, while the others must be specifically targeted.
-board_upload.maximum_ram_size = 32768
-build_flags       = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py ${common.build_flags}
-build_unflags     = -Wall
+platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/master.zip
+framework         = arduino
+board             = nxp_lpc1768
+build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
 lib_ldf_mode      = off
-lib_extra_dirs    = frameworks
-lib_deps          = CMSIS-LPC1768
-  https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
+extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
+monitor_speed     = 250000
+lib_deps          = https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   https://github.com/teemuatlut/TMCStepper.git
-extra_scripts     = Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
+
+[env:LPC1769]
+platform          = https://github.com/p3p/pio-nxplpc-arduino-lpc176x/archive/master.zip
+framework         = arduino
+board             = nxp_lpc1769
+build_flags       = -DTARGET_LPC1768 -DU8G_HAL_LINKS -IMarlin/src/HAL/HAL_LPC1768/include -IMarlin/src/HAL/HAL_LPC1768/u8g ${common.build_flags}
+lib_ldf_mode      = off
+extra_scripts     = Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000
-debug_tool        = custom
-debug_server      =
-  C:\Program Files (x86)\SEGGER\JLink_V618d\JLinkGDBServerCL.exe
-  -select USB
-  -port 2331
-  -device LPC1768
-  -if JTAG
-  -speed auto
-  -noir
+lib_deps          = https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
+  https://github.com/teemuatlut/TMCStepper.git
 
 #
 # Melzi and clones (ATmega1284p)

commit c3229e1b3461b6da8373e7a24a7eeb131912a15b
Author: teemuatlut <teemu.mantykallio@live.fi>
Date:   Wed Oct 3 10:48:49 2018 +0300

    Migrate to a new TMC library (#11943)

diff --git a/platformio.ini b/platformio.ini
index 77756c6640..cf438d4f53 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -31,8 +31,7 @@ build_flags = -fmax-errors=5
 lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal@1.3.4
-  TMC2130Stepper
-  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.2.5.zip
+  https://github.com/teemuatlut/TMCStepper.git
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
   https://github.com/ameyer/Arduino-L6470/archive/master.zip
@@ -162,7 +161,7 @@ lib_ldf_mode      = off
 lib_extra_dirs    = frameworks
 lib_deps          = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
-  TMC2130Stepper@>=2.2.1
+  https://github.com/teemuatlut/TMCStepper.git
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000
@@ -270,7 +269,7 @@ framework     = arduino
 board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
 lib_deps      = ${common.lib_deps}
-lib_ignore    = Adafruit NeoPixel, c1921b4, TMC2130Stepper
+lib_ignore    = Adafruit NeoPixel, c1921b4, TMCStepper
 src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F4>
 monitor_speed = 250000
 
@@ -301,11 +300,10 @@ lib_ignore  =
   NewliquidCrystal
   LiquidTWI2
   Adafruit NeoPixel
-  TMC2130Stepper
+  TMCStepper
   Servo(STM32F1)
   TMC26XStepper
   U8glib-HAL
-  TMC2208Stepper
   c1921b4
 
 #

commit 0f7d82bab100cfe2da47d7123896145ca04089dc
Author: Dave Johnson <davejohnson3000@gmail.com>
Date:   Sun Sep 9 02:15:23 2018 -0700

    [2.0.x] include AVR HAL in PIO src_filter for at90usb_dfu (#11778)
    
    I missed this one

diff --git a/platformio.ini b/platformio.ini
index 3d6dbeadc7..77756c6640 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -105,7 +105,7 @@ board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 lib_ldf_mode  = deep+
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_DFU.py
 monitor_speed = 250000
 

commit eafd62308e90e98f16d3bf1725ba62eb1e0b2f2c
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sat Sep 8 20:41:21 2018 -0500

    Use TMC2208Stepper v0.2.5 (#11714)

diff --git a/platformio.ini b/platformio.ini
index 85d43abb91..3d6dbeadc7 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -32,7 +32,7 @@ lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal@1.3.4
   TMC2130Stepper
-  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.2.3.zip
+  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.2.5.zip
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
   https://github.com/ameyer/Arduino-L6470/archive/master.zip
@@ -163,7 +163,6 @@ lib_extra_dirs    = frameworks
 lib_deps          = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMC2130Stepper@>=2.2.1
-  TMC2208Stepper@=0.2.1
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000

commit d0c96ee83ea934600133a28ea21ff6b36182b195
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Sep 1 17:51:14 2018 -0500

    Use TMC2208Stepper 0.2.1 for LPC1768

diff --git a/platformio.ini b/platformio.ini
index 93dc527d12..85d43abb91 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -163,7 +163,7 @@ lib_extra_dirs    = frameworks
 lib_deps          = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMC2130Stepper@>=2.2.1
-  TMC2208Stepper@>=0.2.1
+  TMC2208Stepper@=0.2.1
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000

commit 49e107cea9544bc531b8d01f47613747cecc1621
Author: teemuatlut <teemu.mantykallio@live.fi>
Date:   Sat Sep 1 23:24:44 2018 +0300

    Restrict SW serial to AVR (#11696)

diff --git a/platformio.ini b/platformio.ini
index cf16b70a21..93dc527d12 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -32,7 +32,7 @@ lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal@1.3.4
   TMC2130Stepper
-  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.1.1.zip
+  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.2.3.zip
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
   https://github.com/ameyer/Arduino-L6470/archive/master.zip

commit e3debc796d9988394c83025f0a591a9ee367bacc
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Aug 31 17:48:28 2018 -0500

    Revert "Use TMC2208Stepper version 0.2.2"
    
    This reverts commit 77efcad1dfcc2eafeee9887b1261f26246536826.

diff --git a/platformio.ini b/platformio.ini
index f61f12f19e..cf16b70a21 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -32,7 +32,7 @@ lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal@1.3.4
   TMC2130Stepper
-  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.2.2.zip
+  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.1.1.zip
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
   https://github.com/ameyer/Arduino-L6470/archive/master.zip

commit 77efcad1dfcc2eafeee9887b1261f26246536826
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Aug 31 16:12:57 2018 -0500

    Use TMC2208Stepper version 0.2.2

diff --git a/platformio.ini b/platformio.ini
index cf16b70a21..f61f12f19e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -32,7 +32,7 @@ lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal@1.3.4
   TMC2130Stepper
-  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.1.1.zip
+  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.2.2.zip
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
   https://github.com/ameyer/Arduino-L6470/archive/master.zip

commit 0456caf0ad12482b05033e9423f42fd2df2aee8a
Author: Dave Johnson <davejohnson3000@gmail.com>
Date:   Mon Aug 20 19:11:12 2018 -0700

    Consolidate shared HALs and isolate HAL compile (#11552)

diff --git a/platformio.ini b/platformio.ini
index c93fbfdda6..cf16b70a21 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -24,7 +24,7 @@ boards_dir  = buildroot/share/PlatformIO/boards
 env_default = megaatmega2560
 
 [common]
-default_src_filter = +<src/*> -<src/config>
+default_src_filter = +<src/*> -<src/config> -<src/HAL> +<src/HAL/shared>
 build_flags = -fmax-errors=5
   -g
   -ggdb

commit c64199941e058abb18a06be90002f5f03009347b
Author: Dave Johnson <davejohnson3000@gmail.com>
Date:   Tue Aug 14 01:28:52 2018 -0700

    Compile only selected PIO environment (#11519)

diff --git a/platformio.ini b/platformio.ini
index 49731ef91a..c93fbfdda6 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -58,7 +58,7 @@ board             = megaatmega2560
 build_flags       = ${common.build_flags}
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
-src_filter        = ${common.default_src_filter}
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed     = 250000
 
 #
@@ -71,7 +71,7 @@ board             = megaatmega1280
 build_flags       = ${common.build_flags}
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
-src_filter        = ${common.default_src_filter}
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed     = 250000
 
 #
@@ -88,7 +88,7 @@ board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 lib_ldf_mode  = deep+
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_CDC.py
 monitor_speed = 250000
 
@@ -122,7 +122,7 @@ board         = due
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 lib_ignore    = c1921b4
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
 [env:DUE_USB]
 platform      = atmelsam
@@ -131,7 +131,7 @@ board         = dueUSB
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 lib_ignore    = c1921b4
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
 [env:DUE_debug]
 # Used when WATCHDOG_RESET_MANUAL is enabled
@@ -143,7 +143,7 @@ build_flags   = ${common.build_flags}
   -mpoke-function-name
 lib_deps      = ${common.lib_deps}
 lib_ignore    = c1921b4
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 monitor_speed = 250000
 
 #
@@ -165,7 +165,7 @@ lib_deps          = CMSIS-LPC1768
   TMC2130Stepper@>=2.2.1
   TMC2208Stepper@>=0.2.1
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
-src_filter        = ${common.default_src_filter}
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
 monitor_speed     = 250000
 debug_tool        = custom
 debug_server      =
@@ -187,7 +187,7 @@ board         = sanguino_atmega1284p
 build_flags   = ${common.build_flags}
 upload_speed  = 57600
 lib_deps      = ${common.lib_deps}
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 
 #
@@ -200,7 +200,7 @@ board         = sanguino_atmega1284p
 build_flags   = ${common.build_flags}
 upload_speed  = 115200
 lib_deps      = ${common.lib_deps}
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 
 #
@@ -213,7 +213,7 @@ board             = reprap_rambo
 build_flags       = ${common.build_flags}
 board_build.f_cpu = 16000000L
 lib_deps          = ${common.lib_deps}
-src_filter        = ${common.default_src_filter}
+src_filter        = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed     = 250000
 
 #
@@ -225,7 +225,7 @@ framework     = arduino
 board         = sanguino_atmega644p
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 
 #
@@ -237,7 +237,7 @@ framework     = arduino
 board         = sanguino_atmega1284p
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 monitor_speed = 250000
 
 #
@@ -259,7 +259,7 @@ lib_ignore    = U8glib-HAL
   libf3e
   TMC26XStepper
 lib_ldf_mode  = 1
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 monitor_speed = 250000
 
 #
@@ -272,7 +272,7 @@ board         = disco_f407vg
 build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
 lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, c1921b4, TMC2130Stepper
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_STM32F4>
 monitor_speed = 250000
 
 #
@@ -285,7 +285,7 @@ board         = teensy35
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel
-src_filter    = ${common.default_src_filter}
+src_filter    = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
 monitor_speed = 250000
 
 [env:malyanm200]
@@ -293,7 +293,7 @@ platform    = ststm32
 framework   = arduino
 board       = malyanM200
 build_flags = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
-src_filter  = ${common.default_src_filter}
+src_filter  = ${common.default_src_filter} +<src/HAL/HAL_STM32F1>
 #-<frameworks>
 lib_ignore  =
   U8glib
@@ -313,9 +313,9 @@ lib_ignore  =
 # Espressif ESP32
 #
 [env:esp32]
-platform = https://github.com/platformio/platform-espressif32.git#feature/stage
-board = esp32dev
-framework = arduino
+platform    = https://github.com/platformio/platform-espressif32.git#feature/stage
+board       = esp32dev
+framework   = arduino
 upload_port = COM3
 lib_ignore  =
   LiquidCrystal_I2C
@@ -324,3 +324,4 @@ lib_ignore  =
   LiquidTWI2
   TMC26XStepper
   c1921b4
+src_filter  = ${common.default_src_filter} +<src/HAL/HAL_ESP32>

commit b7e15a65e3e3b1cc900f498f59149a96c053ab41
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Fri Aug 10 04:41:10 2018 +0100

    Target specific nxplpc and ststm32 pio platform versions to fix build (#11506)

diff --git a/platformio.ini b/platformio.ini
index 979e5499e0..49731ef91a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -150,7 +150,7 @@ monitor_speed = 250000
 # NXP LPC1768 ARM Cortex-M3
 #
 [env:LPC1768]
-platform          = nxplpc
+platform          = nxplpc@<3.4.0
 board             = lpc1768
 board_build.f_cpu = 100000000L
 # Override default maximum RAM. LPC1768/9 do have 64k, but in 3 blocks (32K, 16K, 16K).
@@ -244,7 +244,7 @@ monitor_speed = 250000
 # STM32F103RE
 #
 [env:STM32F1]
-platform      = ststm32
+platform      = ststm32@<4.4.0
 framework     = arduino
 board         = genericSTM32F103RE
 build_flags   = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py

commit 2cc950d67e8a5d39a35b588249ee1660bc0cffe5
Author: forkoz <lactduup@grr.la>
Date:   Mon Jul 30 22:48:58 2018 -0500

    [2.0.x] MKS SBASE Trinamic examples/support (#11402)

diff --git a/platformio.ini b/platformio.ini
index ba543e4f60..979e5499e0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -163,6 +163,7 @@ lib_extra_dirs    = frameworks
 lib_deps          = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMC2130Stepper@>=2.2.1
+  TMC2208Stepper@>=0.2.1
 extra_scripts     = Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter}
 monitor_speed     = 250000

commit 8a24ff94d1e66211b0941e9110001d37a94fa460
Author: Dave Johnson <davejohnson3000@gmail.com>
Date:   Thu Jul 26 03:58:28 2018 -0700

    AT90USB1286 PIO cleanup and optimization (#11230)
    
    -normalize `env` and `board` to lowercase naming convention.
    -make board `name` follow descriptive convention.
    -implement `-fsingle-precision-constant` compile optimization per https://github.com/MarlinFirmware/Marlin/pull/11178#issuecomment-401673901
    -fix typo in 5DPRINT entry.

diff --git a/platformio.ini b/platformio.ini
index 837600c3cf..ba543e4f60 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -81,10 +81,10 @@ monitor_speed     = 250000
 # - SAV_MKI
 # - TEENSYLU
 #
-[env:at90USB1286_CDC]
+[env:at90usb1286_cdc]
 platform      = teensy
 framework     = arduino
-board         = at90USB1286
+board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 lib_ldf_mode  = deep+
@@ -98,10 +98,10 @@ monitor_speed = 250000
 # - PrintrBoard Rev.F
 # - ? 5DPRINT ?
 #
-[env:at90USB1286_DFU]
+[env:at90usb1286_dfu]
 platform      = teensy
 framework     = arduino
-board         = at90USB1286
+board         = at90usb1286
 build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 lib_ldf_mode  = deep+

commit 902167fa78a4893560d82dab8905c94ed265ed2c
Author: Roxy-3D <Roxy-3D@users.noreply.github.com>
Date:   Tue Jul 17 00:23:47 2018 -0500

    Revert "[2.0.x] Switch to PIO managed L6470 library (#11288)" (#11290)
    
    This reverts commit a26fdf6b68db5db89571e262d9653b7d21d1f88a.

diff --git a/platformio.ini b/platformio.ini
index 359d138632..837600c3cf 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -35,7 +35,7 @@ lib_deps =
   https://github.com/teemuatlut/TMC2208Stepper/archive/v0.1.1.zip
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
-  Arduino-L6470
+  https://github.com/ameyer/Arduino-L6470/archive/master.zip
   https://github.com/trinamic/TMC26XStepper/archive/c1921b4.zip
 
 #################################

commit a26fdf6b68db5db89571e262d9653b7d21d1f88a
Author: Shen Yiming <soimy@163.com>
Date:   Tue Jul 17 13:10:07 2018 +0800

    [2.0.x] Switch to PIO managed L6470 library (#11288)
    
    On a leap of faith...  I'm merging...

diff --git a/platformio.ini b/platformio.ini
index 837600c3cf..359d138632 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -35,7 +35,7 @@ lib_deps =
   https://github.com/teemuatlut/TMC2208Stepper/archive/v0.1.1.zip
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
-  https://github.com/ameyer/Arduino-L6470/archive/master.zip
+  Arduino-L6470
   https://github.com/trinamic/TMC26XStepper/archive/c1921b4.zip
 
 #################################

commit 921685d12f99fb0dbf13b5bbb37b6919f29384f5
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Jun 28 04:51:36 2018 -0500

    Teensy++ 2.0 can truly go away

diff --git a/platformio.ini b/platformio.ini
index 28cf36db33..837600c3cf 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -274,20 +274,6 @@ lib_ignore    = Adafruit NeoPixel, c1921b4, TMC2130Stepper
 src_filter    = ${common.default_src_filter}
 monitor_speed = 250000
 
-#
-# Teensy++ 2.0
-#
-[env:teensy20]
-platform          = teensy
-framework         = arduino
-board             = teensy20pp
-build_flags       = ${common.build_flags}
-#board_build.f_cpu = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
-lib_deps          = ${common.lib_deps}
-lib_ldf_mode      = deep+
-src_filter        = ${common.default_src_filter}
-monitor_speed     = 250000
-
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #

commit 3fa9aeb5c7bf0489ab294f1782048500d336a542
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Jun 22 00:13:11 2018 -0400

    Restore env:teensy20, for now
    
    See https://github.com/MarlinFirmware/Marlin/pull/11079#issuecomment-399309709

diff --git a/platformio.ini b/platformio.ini
index 837600c3cf..28cf36db33 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -274,6 +274,20 @@ lib_ignore    = Adafruit NeoPixel, c1921b4, TMC2130Stepper
 src_filter    = ${common.default_src_filter}
 monitor_speed = 250000
 
+#
+# Teensy++ 2.0
+#
+[env:teensy20]
+platform          = teensy
+framework         = arduino
+board             = teensy20pp
+build_flags       = ${common.build_flags}
+#board_build.f_cpu = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
+lib_deps          = ${common.lib_deps}
+lib_ldf_mode      = deep+
+src_filter        = ${common.default_src_filter}
+monitor_speed     = 250000
+
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #

commit 3b7c5a31a31c0e527f9648f342fac78633f52d85
Author: Dave Johnson <davejohnson3000@gmail.com>
Date:   Thu Jun 21 19:09:23 2018 -0700

    Enable local board repository for PIO (#11079)
    
    -Enable boards_dir option in PIO INI
    -Remove defunct custom board file operations for PIO auto-build environment
    -Remove now-defunct Teensy++ 2.0 PIO entry, replaced by `at90USB1286_DFU` and `at90USB1286_DFU` (using this entry always put AT90USB board boot loaders in jeopardy of being overwritten due to the very small size of the official Teensy++ 2.0 bootloader)
    -whitespace

diff --git a/platformio.ini b/platformio.ini
index 9bd1108ed8..837600c3cf 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -20,6 +20,7 @@ src_dir     = Marlin
 build_dir   = .pioenvs
 lib_dir     = .piolib
 libdeps_dir = .piolibdeps
+boards_dir  = buildroot/share/PlatformIO/boards
 env_default = megaatmega2560
 
 [common]
@@ -89,6 +90,7 @@ lib_deps      = ${common.lib_deps}
 lib_ldf_mode  = deep+
 src_filter    = ${common.default_src_filter}
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_CDC.py
+monitor_speed = 250000
 
 #
 # AT90USB1286 boards using DFU bootloader
@@ -105,6 +107,7 @@ lib_deps      = ${common.lib_deps}
 lib_ldf_mode  = deep+
 src_filter    = ${common.default_src_filter}
 extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_DFU.py
+monitor_speed = 250000
 
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
@@ -271,20 +274,6 @@ lib_ignore    = Adafruit NeoPixel, c1921b4, TMC2130Stepper
 src_filter    = ${common.default_src_filter}
 monitor_speed = 250000
 
-#
-# Teensy++ 2.0
-#
-[env:teensy20]
-platform          = teensy
-framework         = arduino
-board             = teensy20pp
-build_flags       = ${common.build_flags}
-#board_build.f_cpu = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
-lib_deps          = ${common.lib_deps}
-lib_ldf_mode      = deep+
-src_filter        = ${common.default_src_filter}
-monitor_speed     = 250000
-
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #

commit f88adcbfd550fc62fb64e552b94397486e2f9ad4
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Fri Jun 15 21:32:51 2018 +0100

    [2.0.x][LPC176x] Fix binary linking broken by pio update (#11026)

diff --git a/platformio.ini b/platformio.ini
index ea4dda2b31..9bd1108ed8 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -150,10 +150,10 @@ monitor_speed = 250000
 platform          = nxplpc
 board             = lpc1768
 board_build.f_cpu = 100000000L
-build_flags       = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
-  ${common.build_flags}
-  -DU8G_HAL_LINKS
-src_build_flags   = -Wall
+# Override default maximum RAM. LPC1768/9 do have 64k, but in 3 blocks (32K, 16K, 16K).
+# The first 32k block is used by default, while the others must be specifically targeted.
+board_upload.maximum_ram_size = 32768
+build_flags       = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py ${common.build_flags}
 build_unflags     = -Wall
 lib_ldf_mode      = off
 lib_extra_dirs    = frameworks

commit e2aeda61edd123997c77c81483b81d0e99bd18f3
Author: Simon Jouet <simon.jouet@gmail.com>
Date:   Sun Oct 8 17:38:10 2017 +0100

    HAL for Espressif ESP32 Wifi

diff --git a/platformio.ini b/platformio.ini
index 1a5f1eeac5..ea4dda2b31 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -318,3 +318,19 @@ lib_ignore  =
   U8glib-HAL
   TMC2208Stepper
   c1921b4
+
+#
+# Espressif ESP32
+#
+[env:esp32]
+platform = https://github.com/platformio/platform-espressif32.git#feature/stage
+board = esp32dev
+framework = arduino
+upload_port = COM3
+lib_ignore  =
+  LiquidCrystal_I2C
+  LiquidCrystal
+  NewliquidCrystal
+  LiquidTWI2
+  TMC26XStepper
+  c1921b4

commit e0276d2f329e15f8f77b1684fcb1724d29db8609
Author: Karl Andersson <karl@iaccess.se>
Date:   Wed Jun 13 01:38:00 2018 +0200

    Official STMicroelectronics Arduino Core STM32F4 HAL compatibility (#11006)

diff --git a/platformio.ini b/platformio.ini
index 2e8182491f..1a5f1eeac5 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -265,7 +265,7 @@ monitor_speed = 250000
 platform      = ststm32
 framework     = arduino
 board         = disco_f407vg
-build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
+build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DSTM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
 lib_deps      = ${common.lib_deps}
 lib_ignore    = Adafruit NeoPixel, c1921b4, TMC2130Stepper
 src_filter    = ${common.default_src_filter}

commit 928e50e724400f4c2a332b710cce272188e73dfd
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Jun 12 00:40:18 2018 -0500

    Try LiquidCrystal@1.3.4

diff --git a/platformio.ini b/platformio.ini
index e677d19528..2e8182491f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -29,7 +29,7 @@ build_flags = -fmax-errors=5
   -ggdb
 lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
-  LiquidCrystal_I2C@1.1.2
+  LiquidCrystal@1.3.4
   TMC2130Stepper
   https://github.com/teemuatlut/TMC2208Stepper/archive/v0.1.1.zip
   Adafruit NeoPixel@1.1.3

commit f89f7c4a82870d86dc8f31692fa5cc5cb652be1d
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Tue May 29 01:38:22 2018 +0100

    [2.0.x][LPC176x][Build] Force single precision constants, disable freestanding (#10892)

diff --git a/platformio.ini b/platformio.ini
index 0f4a6662c4..e677d19528 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -160,29 +160,9 @@ lib_extra_dirs    = frameworks
 lib_deps          = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMC2130Stepper@>=2.2.1
-extra_scripts     = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
+extra_scripts     = Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter        = ${common.default_src_filter}
 monitor_speed     = 250000
-
-#
-# LPC1768 (for debugging and development)
-#
-[env:LPC1768_debug_and_upload]
-# Segger JLink
-platform          = nxplpc
-#framework        = mbed
-board             = lpc1768
-board_build.f_cpu = 100000000L
-build_flags       = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
-  ${common.build_flags}
-  -DU8G_HAL_LINKS
-lib_ldf_mode      = off
-lib_extra_dirs    = frameworks
-lib_deps          = CMSIS-LPC1768
-  https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
-src_filter        = ${common.default_src_filter}
-extra_scripts     =  Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
-monitor_speed     = 250000
 debug_tool        = custom
 debug_server      =
   C:\Program Files (x86)\SEGGER\JLink_V618d\JLinkGDBServerCL.exe

commit 22771dd2dd804b08ccd37d8d6f85888dfbbba111
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat May 26 22:36:12 2018 -0500

    Update 'board_f_cpu' to 'board_build.f_cpu'

diff --git a/platformio.ini b/platformio.ini
index 25768e8d52..0f4a6662c4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -16,9 +16,9 @@
 #
 
 [platformio]
-src_dir = Marlin
-build_dir = .pioenvs
-lib_dir = .piolib
+src_dir     = Marlin
+build_dir   = .pioenvs
+lib_dir     = .piolib
 libdeps_dir = .piolibdeps
 env_default = megaatmega2560
 
@@ -51,27 +51,27 @@ lib_deps =
 # ATmega2560
 #
 [env:megaatmega2560]
-platform      = atmelavr
-framework     = arduino
-board         = megaatmega2560
-build_flags   = ${common.build_flags}
-board_f_cpu   = 16000000L
-lib_deps      = ${common.lib_deps}
-src_filter    = ${common.default_src_filter}
-monitor_speed = 250000
+platform          = atmelavr
+framework         = arduino
+board             = megaatmega2560
+build_flags       = ${common.build_flags}
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+src_filter        = ${common.default_src_filter}
+monitor_speed     = 250000
 
 #
 # ATmega1280
 #
 [env:megaatmega1280]
-platform      = atmelavr
-framework     = arduino
-board         = megaatmega1280
-build_flags   = ${common.build_flags}
-board_f_cpu   = 16000000L
-lib_deps      = ${common.lib_deps}
-src_filter    = ${common.default_src_filter}
-monitor_speed = 250000
+platform          = atmelavr
+framework         = arduino
+board             = megaatmega1280
+build_flags       = ${common.build_flags}
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+src_filter        = ${common.default_src_filter}
+monitor_speed     = 250000
 
 #
 # AT90USB1286 boards using CDC bootloader
@@ -147,44 +147,44 @@ monitor_speed = 250000
 # NXP LPC1768 ARM Cortex-M3
 #
 [env:LPC1768]
-platform        = nxplpc
-board           = lpc1768
-board_f_cpu     = 100000000L
-build_flags     = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+platform          = nxplpc
+board             = lpc1768
+board_build.f_cpu = 100000000L
+build_flags       = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
   ${common.build_flags}
   -DU8G_HAL_LINKS
-src_build_flags = -Wall
-build_unflags   = -Wall
-lib_ldf_mode    = off
-lib_extra_dirs  = frameworks
-lib_deps        = CMSIS-LPC1768
+src_build_flags   = -Wall
+build_unflags     = -Wall
+lib_ldf_mode      = off
+lib_extra_dirs    = frameworks
+lib_deps          = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMC2130Stepper@>=2.2.1
-extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
-src_filter      = ${common.default_src_filter}
-monitor_speed   = 250000
+extra_scripts     = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
+src_filter        = ${common.default_src_filter}
+monitor_speed     = 250000
 
 #
 # LPC1768 (for debugging and development)
 #
 [env:LPC1768_debug_and_upload]
 # Segger JLink
-platform       = nxplpc
-#framework     = mbed
-board          = lpc1768
-board_f_cpu    = 100000000L
-build_flags    = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+platform          = nxplpc
+#framework        = mbed
+board             = lpc1768
+board_build.f_cpu = 100000000L
+build_flags       = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
   ${common.build_flags}
   -DU8G_HAL_LINKS
-lib_ldf_mode   = off
-lib_extra_dirs = frameworks
-lib_deps       = CMSIS-LPC1768
+lib_ldf_mode      = off
+lib_extra_dirs    = frameworks
+lib_deps          = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
-src_filter     = ${common.default_src_filter}
-extra_scripts  =  Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
-monitor_speed  = 250000
-debug_tool     = custom
-debug_server   =
+src_filter        = ${common.default_src_filter}
+extra_scripts     =  Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+monitor_speed     = 250000
+debug_tool        = custom
+debug_server      =
   C:\Program Files (x86)\SEGGER\JLink_V618d\JLinkGDBServerCL.exe
   -select USB
   -port 2331
@@ -223,14 +223,14 @@ monitor_speed = 250000
 # RAMBo
 #
 [env:rambo]
-platform      = atmelavr
-framework     = arduino
-board         = reprap_rambo
-build_flags   = ${common.build_flags}
-board_f_cpu   = 16000000L
-lib_deps      = ${common.lib_deps}
-src_filter    = ${common.default_src_filter}
-monitor_speed = 250000
+platform          = atmelavr
+framework         = arduino
+board             = reprap_rambo
+build_flags       = ${common.build_flags}
+board_build.f_cpu = 16000000L
+lib_deps          = ${common.lib_deps}
+src_filter        = ${common.default_src_filter}
+monitor_speed     = 250000
 
 #
 # Sanguinololu (ATmega644p)
@@ -295,15 +295,15 @@ monitor_speed = 250000
 # Teensy++ 2.0
 #
 [env:teensy20]
-platform      = teensy
-framework     = arduino
-board         = teensy20pp
-build_flags   = ${common.build_flags}
-#board_f_cpu  = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
-lib_deps      = ${common.lib_deps}
-lib_ldf_mode  = deep+
-src_filter    = ${common.default_src_filter}
-monitor_speed = 250000
+platform          = teensy
+framework         = arduino
+board             = teensy20pp
+build_flags       = ${common.build_flags}
+#board_build.f_cpu = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
+lib_deps          = ${common.lib_deps}
+lib_ldf_mode      = deep+
+src_filter        = ${common.default_src_filter}
+monitor_speed     = 250000
 
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
@@ -321,11 +321,11 @@ monitor_speed = 250000
 [env:malyanm200]
 platform    = ststm32
 framework   = arduino
-board = malyanM200
+board       = malyanM200
 build_flags = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
-src_filter = ${common.default_src_filter}
+src_filter  = ${common.default_src_filter}
 #-<frameworks>
-lib_ignore =
+lib_ignore  =
   U8glib
   LiquidCrystal_I2C
   LiquidCrystal

commit 62e2987488ea85d67c4effc9038ce9ddd9912c22
Author: Bob Kuhn <bob.kuhn@att.net>
Date:   Sat May 19 17:39:26 2018 -0500

    add AT90USB support & add items to popup menu (#10779)

diff --git a/platformio.ini b/platformio.ini
index 9d8b51161c..25768e8d52 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -73,6 +73,39 @@ lib_deps      = ${common.lib_deps}
 src_filter    = ${common.default_src_filter}
 monitor_speed = 250000
 
+#
+# AT90USB1286 boards using CDC bootloader
+# - BRAINWAVE
+# - BRAINWAVE_PRO
+# - SAV_MKI
+# - TEENSYLU
+#
+[env:at90USB1286_CDC]
+platform      = teensy
+framework     = arduino
+board         = at90USB1286
+build_flags   = ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+lib_ldf_mode  = deep+
+src_filter    = ${common.default_src_filter}
+extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_CDC.py
+
+#
+# AT90USB1286 boards using DFU bootloader
+# - PrintrBoard
+# - PrintrBoard Rev.F
+# - ? 5DPRINT ?
+#
+[env:at90USB1286_DFU]
+platform      = teensy
+framework     = arduino
+board         = at90USB1286
+build_flags   = ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+lib_ldf_mode  = deep+
+src_filter    = ${common.default_src_filter}
+extra_scripts = pre:buildroot/share/atom/create_custom_upload_command_DFU.py
+
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
 #
@@ -223,6 +256,9 @@ lib_deps      = ${common.lib_deps}
 src_filter    = ${common.default_src_filter}
 monitor_speed = 250000
 
+#
+# STM32F103RE
+#
 [env:STM32F1]
 platform      = ststm32
 framework     = arduino
@@ -242,6 +278,9 @@ lib_ldf_mode  = 1
 src_filter    = ${common.default_src_filter}
 monitor_speed = 250000
 
+#
+# STM32F4
+#
 [env:STM32F4]
 platform      = ststm32
 framework     = arduino
@@ -255,10 +294,6 @@ monitor_speed = 250000
 #
 # Teensy++ 2.0
 #
-# - PrintrBoard
-# - PrintrBoard Rev.F
-# - Brainwave Pro
-#
 [env:teensy20]
 platform      = teensy
 framework     = arduino

commit 8f18854d4da1fed85b493f12f7faded7d02cb8b4
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat May 19 16:59:23 2018 -0500

    monitor_baud => monitor_speed

diff --git a/platformio.ini b/platformio.ini
index f468653c8b..9d8b51161c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -51,27 +51,27 @@ lib_deps =
 # ATmega2560
 #
 [env:megaatmega2560]
-platform     = atmelavr
-framework    = arduino
-board        = megaatmega2560
-build_flags  = ${common.build_flags}
-board_f_cpu  = 16000000L
-lib_deps     = ${common.lib_deps}
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+platform      = atmelavr
+framework     = arduino
+board         = megaatmega2560
+build_flags   = ${common.build_flags}
+board_f_cpu   = 16000000L
+lib_deps      = ${common.lib_deps}
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 
 #
 # ATmega1280
 #
 [env:megaatmega1280]
-platform     = atmelavr
-framework    = arduino
-board        = megaatmega1280
-build_flags  = ${common.build_flags}
-board_f_cpu  = 16000000L
-lib_deps     = ${common.lib_deps}
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+platform      = atmelavr
+framework     = arduino
+board         = megaatmega1280
+build_flags   = ${common.build_flags}
+board_f_cpu   = 16000000L
+lib_deps      = ${common.lib_deps}
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
@@ -80,35 +80,35 @@ monitor_baud = 250000
 #  - RADDS
 #
 [env:DUE]
-platform     = atmelsam
-framework    = arduino
-board        = due
-build_flags  = ${common.build_flags}
-lib_deps     = ${common.lib_deps}
-lib_ignore   = c1921b4
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+platform      = atmelsam
+framework     = arduino
+board         = due
+build_flags   = ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+lib_ignore    = c1921b4
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 [env:DUE_USB]
-platform     = atmelsam
-framework    = arduino
-board        = dueUSB
-build_flags  = ${common.build_flags}
-lib_deps     = ${common.lib_deps}
-lib_ignore   = c1921b4
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+platform      = atmelsam
+framework     = arduino
+board         = dueUSB
+build_flags   = ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+lib_ignore    = c1921b4
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 [env:DUE_debug]
 # Used when WATCHDOG_RESET_MANUAL is enabled
-platform     = atmelsam
-framework    = arduino
-board        = due
-build_flags  = ${common.build_flags}
+platform      = atmelsam
+framework     = arduino
+board         = due
+build_flags   = ${common.build_flags}
   -funwind-tables
   -mpoke-function-name
-lib_deps     = ${common.lib_deps}
-lib_ignore   = c1921b4
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+lib_deps      = ${common.lib_deps}
+lib_ignore    = c1921b4
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 
 #
 # NXP LPC1768 ARM Cortex-M3
@@ -129,7 +129,7 @@ lib_deps        = CMSIS-LPC1768
   TMC2130Stepper@>=2.2.1
 extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter      = ${common.default_src_filter}
-monitor_baud    = 250000
+monitor_speed   = 250000
 
 #
 # LPC1768 (for debugging and development)
@@ -149,7 +149,7 @@ lib_deps       = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
 src_filter     = ${common.default_src_filter}
 extra_scripts  =  Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
-monitor_baud   = 250000
+monitor_speed  = 250000
 debug_tool     = custom
 debug_server   =
   C:\Program Files (x86)\SEGGER\JLink_V618d\JLinkGDBServerCL.exe
@@ -164,73 +164,73 @@ debug_server   =
 # Melzi and clones (ATmega1284p)
 #
 [env:melzi]
-platform     = atmelavr
-framework    = arduino
-board        = sanguino_atmega1284p
-build_flags  = ${common.build_flags}
-upload_speed = 57600
-lib_deps     = ${common.lib_deps}
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+platform      = atmelavr
+framework     = arduino
+board         = sanguino_atmega1284p
+build_flags   = ${common.build_flags}
+upload_speed  = 57600
+lib_deps      = ${common.lib_deps}
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 
 #
 # Melzi and clones (Optiboot bootloader)
 #
 [env:melzi_optiboot]
-platform     = atmelavr
-framework    = arduino
-board        = sanguino_atmega1284p
-build_flags  = ${common.build_flags}
-upload_speed = 115200
-lib_deps     = ${common.lib_deps}
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+platform      = atmelavr
+framework     = arduino
+board         = sanguino_atmega1284p
+build_flags   = ${common.build_flags}
+upload_speed  = 115200
+lib_deps      = ${common.lib_deps}
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 
 #
 # RAMBo
 #
 [env:rambo]
-platform     = atmelavr
-framework    = arduino
-board        = reprap_rambo
-build_flags  = ${common.build_flags}
-board_f_cpu  = 16000000L
-lib_deps     = ${common.lib_deps}
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+platform      = atmelavr
+framework     = arduino
+board         = reprap_rambo
+build_flags   = ${common.build_flags}
+board_f_cpu   = 16000000L
+lib_deps      = ${common.lib_deps}
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 
 #
 # Sanguinololu (ATmega644p)
 #
 [env:sanguino_atmega644p]
-platform     = atmelavr
-framework    = arduino
-board        = sanguino_atmega644p
-build_flags  = ${common.build_flags}
-lib_deps     = ${common.lib_deps}
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+platform      = atmelavr
+framework     = arduino
+board         = sanguino_atmega644p
+build_flags   = ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 
 #
 # Sanguinololu (ATmega1284p)
 #
 [env:sanguino_atmega1284p]
-platform     = atmelavr
-framework    = arduino
-board        = sanguino_atmega1284p
-build_flags  = ${common.build_flags}
-lib_deps     = ${common.lib_deps}
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+platform      = atmelavr
+framework     = arduino
+board         = sanguino_atmega1284p
+build_flags   = ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 
 [env:STM32F1]
-platform     = ststm32
-framework    = arduino
-board        = genericSTM32F103RE
-build_flags  = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
+platform      = ststm32
+framework     = arduino
+board         = genericSTM32F103RE
+build_flags   = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
   ${common.build_flags}
-lib_deps     = ${common.lib_deps}
-lib_ignore   = U8glib-HAL
+lib_deps      = ${common.lib_deps}
+lib_ignore    = U8glib-HAL
   c1921b4
   libf3c
   lib066
@@ -238,19 +238,19 @@ lib_ignore   = U8glib-HAL
   Adafruit NeoPixel
   libf3e
   TMC26XStepper
-lib_ldf_mode = 1
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+lib_ldf_mode  = 1
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 
 [env:STM32F4]
-platform    = ststm32
-framework   = arduino
-board       = disco_f407vg
-build_flags = ${common.build_flags} -DUSE_STM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
-lib_deps    = ${common.lib_deps}
-lib_ignore  = Adafruit NeoPixel, c1921b4, TMC2130Stepper
-src_filter  = ${common.default_src_filter}
-monitor_baud = 250000
+platform      = ststm32
+framework     = arduino
+board         = disco_f407vg
+build_flags   = ${common.build_flags} -DUSE_STM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
+lib_deps      = ${common.lib_deps}
+lib_ignore    = Adafruit NeoPixel, c1921b4, TMC2130Stepper
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 
 #
 # Teensy++ 2.0
@@ -268,20 +268,20 @@ build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 lib_ldf_mode  = deep+
 src_filter    = ${common.default_src_filter}
-monitor_baud  = 250000
+monitor_speed = 250000
 
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #
 [env:teensy35]
-platform     = teensy
-framework    = arduino
-board        = teensy35
-build_flags  = ${common.build_flags}
-lib_deps     = ${common.lib_deps}
-lib_ignore   = Adafruit NeoPixel
-src_filter   = ${common.default_src_filter}
-monitor_baud = 250000
+platform      = teensy
+framework     = arduino
+board         = teensy35
+build_flags   = ${common.build_flags}
+lib_deps      = ${common.lib_deps}
+lib_ignore    = Adafruit NeoPixel
+src_filter    = ${common.default_src_filter}
+monitor_speed = 250000
 
 [env:malyanm200]
 platform    = ststm32

commit 7d78f3476b3a8f6e6640d2e279f7e1d5ef5e1a23
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri May 11 02:20:55 2018 -0500

    Use the latest L6470 library

diff --git a/platformio.ini b/platformio.ini
index a97710edf9..f468653c8b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -34,7 +34,7 @@ lib_deps =
   https://github.com/teemuatlut/TMC2208Stepper/archive/v0.1.1.zip
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
-  https://github.com/ameyer/Arduino-L6470/archive/0c5e5de.zip
+  https://github.com/ameyer/Arduino-L6470/archive/master.zip
   https://github.com/trinamic/TMC26XStepper/archive/c1921b4.zip
 
 #################################

commit 73022d31198ff2a43a8f61af397a05c4a03bdefc
Author: xC0000005 <32139633+xC0000005@users.noreply.github.com>
Date:   Thu Mar 29 19:54:37 2018 -0700

    Add a PlatformIO environment for Malyan M200

diff --git a/platformio.ini b/platformio.ini
index 09c55d27eb..a97710edf9 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -282,3 +282,24 @@ lib_deps     = ${common.lib_deps}
 lib_ignore   = Adafruit NeoPixel
 src_filter   = ${common.default_src_filter}
 monitor_baud = 250000
+
+[env:malyanm200]
+platform    = ststm32
+framework   = arduino
+board = malyanM200
+build_flags = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py -DMCU_STM32F103CB -D __STM32F1__=1 -std=c++1y -D MOTHERBOARD="BOARD_MALYAN_M200" -DSERIAL_USB -ffunction-sections -fdata-sections -Wl,--gc-sections
+src_filter = ${common.default_src_filter}
+#-<frameworks>
+lib_ignore =
+  U8glib
+  LiquidCrystal_I2C
+  LiquidCrystal
+  NewliquidCrystal
+  LiquidTWI2
+  Adafruit NeoPixel
+  TMC2130Stepper
+  Servo(STM32F1)
+  TMC26XStepper
+  U8glib-HAL
+  TMC2208Stepper
+  c1921b4

commit 428c54f2ad6836097e851164021a671c4187e683
Author: Karl Andersson <karl@iaccess.se>
Date:   Wed Apr 18 00:33:29 2018 +0200

    [2.0.x] HAL for STM32F4 (#10434)

diff --git a/platformio.ini b/platformio.ini
index db7f4e7593..09c55d27eb 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -242,6 +242,16 @@ lib_ldf_mode = 1
 src_filter   = ${common.default_src_filter}
 monitor_baud = 250000
 
+[env:STM32F4]
+platform    = ststm32
+framework   = arduino
+board       = disco_f407vg
+build_flags = ${common.build_flags} -DUSE_STM32GENERIC -DMENU_USB_SERIAL -DMENU_SERIAL=SerialUSB
+lib_deps    = ${common.lib_deps}
+lib_ignore  = Adafruit NeoPixel, c1921b4, TMC2130Stepper
+src_filter  = ${common.default_src_filter}
+monitor_baud = 250000
+
 #
 # Teensy++ 2.0
 #

commit 74f4eb831295a274f8a6d58d7a30d517cc39de87
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Apr 15 14:48:47 2018 -0500

    Drop utf8 tweaks in build files

diff --git a/platformio.ini b/platformio.ini
index a92194e74d..db7f4e7593 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -27,7 +27,6 @@ default_src_filter = +<src/*> -<src/config>
 build_flags = -fmax-errors=5
   -g
   -ggdb
-  -I${platformio.libdeps_dir}/U8glib-HAL_ID1932/src/lib/
 lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal_I2C@1.1.2

commit c96412a78fbf7be0f1f4bca17edab49d8f1040bf
Author: Yunhui Fu <yhfudev@gmail.com>
Date:   Thu Apr 12 21:14:01 2018 -0400

    [2.0.x] UTF-8 language translation support (#10213)

diff --git a/platformio.ini b/platformio.ini
index db7f4e7593..a92194e74d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -27,6 +27,7 @@ default_src_filter = +<src/*> -<src/config>
 build_flags = -fmax-errors=5
   -g
   -ggdb
+  -I${platformio.libdeps_dir}/U8glib-HAL_ID1932/src/lib/
 lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal_I2C@1.1.2

commit 85014cd132a76ad3f910309e8763d894d9391873
Author: Bob-the-Kuhn <bob.kuhn@att.net>
Date:   Wed Apr 11 14:41:16 2018 -0500

    [2.0.x] LPC1768 - automatic selection of upload disk (#10374)

diff --git a/platformio.ini b/platformio.ini
index 2ef554daa2..db7f4e7593 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -103,7 +103,7 @@ platform     = atmelsam
 framework    = arduino
 board        = due
 build_flags  = ${common.build_flags}
-  -funwind-tables 
+  -funwind-tables
   -mpoke-function-name
 lib_deps     = ${common.lib_deps}
 lib_ignore   = c1921b4
@@ -127,7 +127,7 @@ lib_extra_dirs  = frameworks
 lib_deps        = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMC2130Stepper@>=2.2.1
-extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py, Marlin/src/HAL/HAL_LPC1768/upload_extra_script.py
 src_filter      = ${common.default_src_filter}
 monitor_baud    = 250000
 

commit e6042a7c52bbe06e28ad3485cada530a32249f57
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Mon Apr 2 22:26:11 2018 -0500

    Tweak platformio debug_server options

diff --git a/platformio.ini b/platformio.ini
index 227b1ef1be..2ef554daa2 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -153,16 +153,11 @@ monitor_baud   = 250000
 debug_tool     = custom
 debug_server   =
   C:\Program Files (x86)\SEGGER\JLink_V618d\JLinkGDBServerCL.exe
-  -select
-  USB
-  -port
-  2331
-  -device
-  LPC1768
-  -if
-  JTAG
-  -speed
-  auto
+  -select USB
+  -port 2331
+  -device LPC1768
+  -if JTAG
+  -speed auto
   -noir
 
 #

commit cbdc78ec0f1e55e10afb18b07ec02729b6043948
Author: Alexey Shvetsov <alexxy@gentoo.org>
Date:   Thu Mar 29 01:35:20 2018 +0300

    Fix STM32 compilation with PlatformIO (#10245)

diff --git a/platformio.ini b/platformio.ini
index aba312694b..227b1ef1be 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -235,6 +235,15 @@ board        = genericSTM32F103RE
 build_flags  = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
   ${common.build_flags}
 lib_deps     = ${common.lib_deps}
+lib_ignore   = U8glib-HAL
+  c1921b4
+  libf3c
+  lib066
+  Adafruit NeoPixel_ID28
+  Adafruit NeoPixel
+  libf3e
+  TMC26XStepper
+lib_ldf_mode = 1
 src_filter   = ${common.default_src_filter}
 monitor_baud = 250000
 

commit a891af2f7a8a548d451c4801771bc622e3da824c
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Mar 24 15:26:11 2018 -0400

    Enforce minimum TMC2130 / TMC2208 libs

diff --git a/platformio.ini b/platformio.ini
index e809b009c9..aba312694b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -31,7 +31,7 @@ lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal_I2C@1.1.2
   TMC2130Stepper
-  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.0.4.zip
+  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.1.1.zip
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
   https://github.com/ameyer/Arduino-L6470/archive/0c5e5de.zip
@@ -126,7 +126,7 @@ lib_ldf_mode    = off
 lib_extra_dirs  = frameworks
 lib_deps        = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
-  TMC2130Stepper@>=2.2.0
+  TMC2130Stepper@>=2.2.1
 extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 src_filter      = ${common.default_src_filter}
 monitor_baud    = 250000

commit c3b23974bdc7472760714af96df790300ef5cc9e
Author: etagle <ejtagle@hotmail.com>
Date:   Fri Mar 23 05:22:45 2018 -0300

    Added detection of case when no unwind tables are available

diff --git a/platformio.ini b/platformio.ini
index 1f50153953..e809b009c9 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -97,6 +97,18 @@ lib_deps     = ${common.lib_deps}
 lib_ignore   = c1921b4
 src_filter   = ${common.default_src_filter}
 monitor_baud = 250000
+[env:DUE_debug]
+# Used when WATCHDOG_RESET_MANUAL is enabled
+platform     = atmelsam
+framework    = arduino
+board        = due
+build_flags  = ${common.build_flags}
+  -funwind-tables 
+  -mpoke-function-name
+lib_deps     = ${common.lib_deps}
+lib_ignore   = c1921b4
+src_filter   = ${common.default_src_filter}
+monitor_baud = 250000
 
 #
 # NXP LPC1768 ARM Cortex-M3

commit 883524056b0c60e147a3eb9f67093c1f20c1d8bb
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Mar 17 19:47:55 2018 -0500

    Set default baudrate for the pio serial monitor

diff --git a/platformio.ini b/platformio.ini
index 3de2655173..1f50153953 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -51,25 +51,27 @@ lib_deps =
 # ATmega2560
 #
 [env:megaatmega2560]
-platform    = atmelavr
-framework   = arduino
-board       = megaatmega2560
-build_flags = ${common.build_flags}
-board_f_cpu = 16000000L
-lib_deps    = ${common.lib_deps}
-src_filter  = ${common.default_src_filter}
+platform     = atmelavr
+framework    = arduino
+board        = megaatmega2560
+build_flags  = ${common.build_flags}
+board_f_cpu  = 16000000L
+lib_deps     = ${common.lib_deps}
+src_filter   = ${common.default_src_filter}
+monitor_baud = 250000
 
 #
 # ATmega1280
 #
 [env:megaatmega1280]
-platform    = atmelavr
-framework   = arduino
-board       = megaatmega1280
-build_flags = ${common.build_flags}
-board_f_cpu = 16000000L
-lib_deps    = ${common.lib_deps}
-src_filter  = ${common.default_src_filter}
+platform     = atmelavr
+framework    = arduino
+board        = megaatmega1280
+build_flags  = ${common.build_flags}
+board_f_cpu  = 16000000L
+lib_deps     = ${common.lib_deps}
+src_filter   = ${common.default_src_filter}
+monitor_baud = 250000
 
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
@@ -78,21 +80,23 @@ src_filter  = ${common.default_src_filter}
 #  - RADDS
 #
 [env:DUE]
-platform    = atmelsam
-framework   = arduino
-board       = due
-build_flags = ${common.build_flags}
-lib_deps    = ${common.lib_deps}
-lib_ignore  = c1921b4
-src_filter  = ${common.default_src_filter}
+platform     = atmelsam
+framework    = arduino
+board        = due
+build_flags  = ${common.build_flags}
+lib_deps     = ${common.lib_deps}
+lib_ignore   = c1921b4
+src_filter   = ${common.default_src_filter}
+monitor_baud = 250000
 [env:DUE_USB]
-platform    = atmelsam
-framework   = arduino
-board       = dueUSB
-build_flags = ${common.build_flags}
-lib_deps    = ${common.lib_deps}
-lib_ignore  = c1921b4
-src_filter  = ${common.default_src_filter}
+platform     = atmelsam
+framework    = arduino
+board        = dueUSB
+build_flags  = ${common.build_flags}
+lib_deps     = ${common.lib_deps}
+lib_ignore   = c1921b4
+src_filter   = ${common.default_src_filter}
+monitor_baud = 250000
 
 #
 # NXP LPC1768 ARM Cortex-M3
@@ -113,6 +117,7 @@ lib_deps        = CMSIS-LPC1768
   TMC2130Stepper@>=2.2.0
 extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 src_filter      = ${common.default_src_filter}
+monitor_baud    = 250000
 
 #
 # LPC1768 (for debugging and development)
@@ -132,6 +137,7 @@ lib_deps       = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
 src_filter     = ${common.default_src_filter}
 extra_scripts  =  Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+monitor_baud   = 250000
 debug_tool     = custom
 debug_server   =
   C:\Program Files (x86)\SEGGER\JLink_V618d\JLinkGDBServerCL.exe
@@ -158,6 +164,7 @@ build_flags  = ${common.build_flags}
 upload_speed = 57600
 lib_deps     = ${common.lib_deps}
 src_filter   = ${common.default_src_filter}
+monitor_baud = 250000
 
 #
 # Melzi and clones (Optiboot bootloader)
@@ -170,49 +177,54 @@ build_flags  = ${common.build_flags}
 upload_speed = 115200
 lib_deps     = ${common.lib_deps}
 src_filter   = ${common.default_src_filter}
+monitor_baud = 250000
 
 #
 # RAMBo
 #
 [env:rambo]
-platform    = atmelavr
-framework   = arduino
-board       = reprap_rambo
-build_flags = ${common.build_flags}
-board_f_cpu = 16000000L
-lib_deps    = ${common.lib_deps}
-src_filter  = ${common.default_src_filter}
+platform     = atmelavr
+framework    = arduino
+board        = reprap_rambo
+build_flags  = ${common.build_flags}
+board_f_cpu  = 16000000L
+lib_deps     = ${common.lib_deps}
+src_filter   = ${common.default_src_filter}
+monitor_baud = 250000
 
 #
 # Sanguinololu (ATmega644p)
 #
 [env:sanguino_atmega644p]
-platform    = atmelavr
-framework   = arduino
-board       = sanguino_atmega644p
-build_flags = ${common.build_flags}
-lib_deps    = ${common.lib_deps}
-src_filter  = ${common.default_src_filter}
+platform     = atmelavr
+framework    = arduino
+board        = sanguino_atmega644p
+build_flags  = ${common.build_flags}
+lib_deps     = ${common.lib_deps}
+src_filter   = ${common.default_src_filter}
+monitor_baud = 250000
 
 #
 # Sanguinololu (ATmega1284p)
 #
 [env:sanguino_atmega1284p]
-platform    = atmelavr
-framework   = arduino
-board       = sanguino_atmega1284p
-build_flags = ${common.build_flags}
-lib_deps    = ${common.lib_deps}
-src_filter  = ${common.default_src_filter}
+platform     = atmelavr
+framework    = arduino
+board        = sanguino_atmega1284p
+build_flags  = ${common.build_flags}
+lib_deps     = ${common.lib_deps}
+src_filter   = ${common.default_src_filter}
+monitor_baud = 250000
 
 [env:STM32F1]
-platform    = ststm32
-framework   = arduino
-board       = genericSTM32F103RE
-build_flags = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
+platform     = ststm32
+framework    = arduino
+board        = genericSTM32F103RE
+build_flags  = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
   ${common.build_flags}
-lib_deps    = ${common.lib_deps}
-src_filter  = ${common.default_src_filter}
+lib_deps     = ${common.lib_deps}
+src_filter   = ${common.default_src_filter}
+monitor_baud = 250000
 
 #
 # Teensy++ 2.0
@@ -230,15 +242,17 @@ build_flags   = ${common.build_flags}
 lib_deps      = ${common.lib_deps}
 lib_ldf_mode  = deep+
 src_filter    = ${common.default_src_filter}
+monitor_baud  = 250000
 
 #
 # Teensy 3.5 / 3.6 (ARM Cortex-M4)
 #
 [env:teensy35]
-platform    = teensy
-framework   = arduino
-board       = teensy35
-build_flags = ${common.build_flags}
-lib_deps    = ${common.lib_deps}
-lib_ignore  = Adafruit NeoPixel
-src_filter  = ${common.default_src_filter}
+platform     = teensy
+framework    = arduino
+board        = teensy35
+build_flags  = ${common.build_flags}
+lib_deps     = ${common.lib_deps}
+lib_ignore   = Adafruit NeoPixel
+src_filter   = ${common.default_src_filter}
+monitor_baud = 250000

commit 73616d721a6d097f4e56c5706441082a54d0e9fe
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Mar 17 19:28:19 2018 -0500

    Use the latest L6470 library (v0.6)

diff --git a/platformio.ini b/platformio.ini
index 6a4f0a3710..3de2655173 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -34,7 +34,7 @@ lib_deps =
   https://github.com/teemuatlut/TMC2208Stepper/archive/v0.0.4.zip
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
-  https://github.com/ameyer/Arduino-L6470/archive/3cd0993.zip
+  https://github.com/ameyer/Arduino-L6470/archive/0c5e5de.zip
   https://github.com/trinamic/TMC26XStepper/archive/c1921b4.zip
 
 #################################

commit 1e946d681da353a70cc1e74055dbbfe78f5e64c1
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Mar 15 21:03:12 2018 -0500

    Update Marlin for newest TMC libraries
    
    - TMC2130Stepper v2.2.0
    - TMC2208Stepper v0.0.4

diff --git a/platformio.ini b/platformio.ini
index 15eaeba5ae..6a4f0a3710 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -31,7 +31,7 @@ lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal_I2C@1.1.2
   TMC2130Stepper
-  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.0.3.zip
+  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.0.4.zip
   Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
   https://github.com/ameyer/Arduino-L6470/archive/3cd0993.zip
@@ -110,7 +110,7 @@ lib_ldf_mode    = off
 lib_extra_dirs  = frameworks
 lib_deps        = CMSIS-LPC1768
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
-  TMC2130Stepper@>=2.1.1
+  TMC2130Stepper@>=2.2.0
 extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 src_filter      = ${common.default_src_filter}
 

commit 4c3d7083c019032706e5534762e38cdb3a2bb6d0
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Mar 13 23:15:04 2018 -0500

    Fix DUE build in Travis CI
    
    Followup to #10096

diff --git a/platformio.ini b/platformio.ini
index 9bd2785c8c..15eaeba5ae 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -77,18 +77,18 @@ src_filter  = ${common.default_src_filter}
 #  - RAMPS4DUE
 #  - RADDS
 #
-[env:DUE native port]
+[env:DUE]
 platform    = atmelsam
 framework   = arduino
-board       = dueUSB
+board       = due
 build_flags = ${common.build_flags}
 lib_deps    = ${common.lib_deps}
 lib_ignore  = c1921b4
 src_filter  = ${common.default_src_filter}
-[env:DUE programming port]
+[env:DUE_USB]
 platform    = atmelsam
 framework   = arduino
-board       = due
+board       = dueUSB
 build_flags = ${common.build_flags}
 lib_deps    = ${common.lib_deps}
 lib_ignore  = c1921b4

commit d194be8e8b049467a46cfb48ddd7f1ba2e537c48
Author: Bob-the-Kuhn <bob.kuhn@att.net>
Date:   Tue Mar 13 15:31:17 2018 -0500

    platformio.ini DUE native port support

diff --git a/platformio.ini b/platformio.ini
index 9d33086aba..9bd2785c8c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -77,7 +77,15 @@ src_filter  = ${common.default_src_filter}
 #  - RAMPS4DUE
 #  - RADDS
 #
-[env:DUE]
+[env:DUE native port]
+platform    = atmelsam
+framework   = arduino
+board       = dueUSB
+build_flags = ${common.build_flags}
+lib_deps    = ${common.lib_deps}
+lib_ignore  = c1921b4
+src_filter  = ${common.default_src_filter}
+[env:DUE programming port]
 platform    = atmelsam
 framework   = arduino
 board       = due

commit c1f4112bdcded0941416077e3e484821470fdc1b
Author: Bob-the-Kuhn <bob.kuhn@att.net>
Date:   Thu Mar 1 03:07:39 2018 -0600

    [2.0.x] Add 1284 support & misc. bug fixes (#9864)

diff --git a/platformio.ini b/platformio.ini
index 3203b5040d..9d33086aba 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -186,6 +186,17 @@ build_flags = ${common.build_flags}
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
 
+#
+# Sanguinololu (ATmega1284p)
+#
+[env:sanguino_atmega1284p]
+platform    = atmelavr
+framework   = arduino
+board       = sanguino_atmega1284p
+build_flags = ${common.build_flags}
+lib_deps    = ${common.lib_deps}
+src_filter  = ${common.default_src_filter}
+
 [env:STM32F1]
 platform    = ststm32
 framework   = arduino

commit f15d7bdbf2d5dc27f6872ee4318cedd162683e41
Author: Bob-the-Kuhn <bob.kuhn@att.net>
Date:   Sat Feb 24 12:20:46 2018 -0600

    [2.0.x] ELF improvement, fix lib_ignore (#9793)
    
    - Compiler flags so ELF will include the original source.
    - Use commit-id archives for a working `lib_ignore`.

diff --git a/platformio.ini b/platformio.ini
index 0f352ee7b2..3203b5040d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -23,19 +23,19 @@ libdeps_dir = .piolibdeps
 env_default = megaatmega2560
 
 [common]
+default_src_filter = +<src/*> -<src/config>
+build_flags = -fmax-errors=5
+  -g
+  -ggdb
 lib_deps =
   https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal_I2C@1.1.2
   TMC2130Stepper
   https://github.com/teemuatlut/TMC2208Stepper/archive/v0.0.3.zip
   Adafruit NeoPixel@1.1.3
-  https://github.com/lincomatic/LiquidTWI2/archive/master.zip
-  https://github.com/trinamic/TMC26XStepper/archive/master.zip
-  https://github.com/ameyer/Arduino-L6470/archive/master.zip
-
-default_src_filter = +<src/*> -<src/config>
-
-build_flags = -fmax-errors=5
+  https://github.com/lincomatic/LiquidTWI2/archive/30aa480.zip
+  https://github.com/ameyer/Arduino-L6470/archive/3cd0993.zip
+  https://github.com/trinamic/TMC26XStepper/archive/c1921b4.zip
 
 #################################
 #                               #
@@ -71,30 +71,6 @@ board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
 
-#
-# Melzi and clones (ATmega1284p)
-#
-[env:melzi]
-platform     = atmelavr
-framework    = arduino
-board        = sanguino_atmega1284p
-build_flags  = ${common.build_flags}
-upload_speed = 57600
-lib_deps     = ${common.lib_deps}
-src_filter   = ${common.default_src_filter}
-
-#
-# Melzi and clones (Optiboot bootloader)
-#
-[env:melzi_optiboot]
-platform     = atmelavr
-framework    = arduino
-board        = sanguino_atmega1284p
-build_flags  = ${common.build_flags}
-upload_speed = 115200
-lib_deps     = ${common.lib_deps}
-src_filter   = ${common.default_src_filter}
-
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
 #
@@ -107,7 +83,7 @@ framework   = arduino
 board       = due
 build_flags = ${common.build_flags}
 lib_deps    = ${common.lib_deps}
-lib_ignore  = TMC26XStepper
+lib_ignore  = c1921b4
 src_filter  = ${common.default_src_filter}
 
 #
@@ -163,6 +139,30 @@ debug_server   =
   auto
   -noir
 
+#
+# Melzi and clones (ATmega1284p)
+#
+[env:melzi]
+platform     = atmelavr
+framework    = arduino
+board        = sanguino_atmega1284p
+build_flags  = ${common.build_flags}
+upload_speed = 57600
+lib_deps     = ${common.lib_deps}
+src_filter   = ${common.default_src_filter}
+
+#
+# Melzi and clones (Optiboot bootloader)
+#
+[env:melzi_optiboot]
+platform     = atmelavr
+framework    = arduino
+board        = sanguino_atmega1284p
+build_flags  = ${common.build_flags}
+upload_speed = 115200
+lib_deps     = ${common.lib_deps}
+src_filter   = ${common.default_src_filter}
+
 #
 # RAMBo
 #

commit 90fa423737448feb75ee59a2afc88a8c891b19ea
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Feb 23 00:52:52 2018 -0600

    Preliminary cleanup of #include structure (#9763)

diff --git a/platformio.ini b/platformio.ini
index b493907b49..0f352ee7b2 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -24,14 +24,14 @@ env_default = megaatmega2560
 
 [common]
 lib_deps =
-  U8glib-HAL
+  https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   LiquidCrystal_I2C@1.1.2
   TMC2130Stepper
-  https://github.com/teemuatlut/TMC2208Stepper.git
+  https://github.com/teemuatlut/TMC2208Stepper/archive/v0.0.3.zip
   Adafruit NeoPixel@1.1.3
-  https://github.com/lincomatic/LiquidTWI2.git
-  https://github.com/trinamic/TMC26XStepper.git
-  https://github.com/ameyer/Arduino-L6470.git
+  https://github.com/lincomatic/LiquidTWI2/archive/master.zip
+  https://github.com/trinamic/TMC26XStepper/archive/master.zip
+  https://github.com/ameyer/Arduino-L6470/archive/master.zip
 
 default_src_filter = +<src/*> -<src/config>
 
@@ -125,7 +125,7 @@ build_unflags   = -Wall
 lib_ldf_mode    = off
 lib_extra_dirs  = frameworks
 lib_deps        = CMSIS-LPC1768
-  U8glib-HAL
+  https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
   TMC2130Stepper@>=2.1.1
 extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 src_filter      = ${common.default_src_filter}
@@ -145,7 +145,7 @@ build_flags    = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 lib_ldf_mode   = off
 lib_extra_dirs = frameworks
 lib_deps       = CMSIS-LPC1768
-  U8glib-HAL
+  https://github.com/MarlinFirmware/U8glib-HAL/archive/dev.zip
 src_filter     = ${common.default_src_filter}
 extra_scripts  =  Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 debug_tool     = custom

commit f0debfd2fceaf59ae35e5f0e1d85927a50b03290
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Feb 14 04:26:10 2018 -0600

    See if this passes Travis CI

diff --git a/platformio.ini b/platformio.ini
index d2252fae08..b493907b49 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -115,6 +115,7 @@ src_filter  = ${common.default_src_filter}
 #
 [env:LPC1768]
 platform        = nxplpc
+board           = lpc1768
 board_f_cpu     = 100000000L
 build_flags     = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
   ${common.build_flags}

commit 4fef36966b4b841aa644a0a386e2dfcbcc230476
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Feb 10 14:46:17 2018 -0600

    Rename environment anet10 to melzi

diff --git a/platformio.ini b/platformio.ini
index 756b43dafe..d2252fae08 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -72,9 +72,9 @@ lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
 
 #
-# Anet 1.0 - Melzi clone (ATmega1284p)
+# Melzi and clones (ATmega1284p)
 #
-[env:anet10]
+[env:melzi]
 platform     = atmelavr
 framework    = arduino
 board        = sanguino_atmega1284p
@@ -84,9 +84,9 @@ lib_deps     = ${common.lib_deps}
 src_filter   = ${common.default_src_filter}
 
 #
-# Anet 1.0 (Optiboot bootloader)
+# Melzi and clones (Optiboot bootloader)
 #
-[env:anet10_optiboot]
+[env:melzi_optiboot]
 platform     = atmelavr
 framework    = arduino
 board        = sanguino_atmega1284p

commit 852468ead741de84c358fcb7ece035e2d4034030
Author: Johnny Eshak <info@johnnytheone.com>
Date:   Thu Feb 8 10:02:16 2018 +0100

    [2.0.x] Fix compile Error Anet (#9509)

diff --git a/platformio.ini b/platformio.ini
index caea5e4548..756b43dafe 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -83,6 +83,18 @@ upload_speed = 57600
 lib_deps     = ${common.lib_deps}
 src_filter   = ${common.default_src_filter}
 
+#
+# Anet 1.0 (Optiboot bootloader)
+#
+[env:anet10_optiboot]
+platform     = atmelavr
+framework    = arduino
+board        = sanguino_atmega1284p
+build_flags  = ${common.build_flags}
+upload_speed = 115200
+lib_deps     = ${common.lib_deps}
+src_filter   = ${common.default_src_filter}
+
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
 #

commit 5c69d45f5bc96d6cc122813baa3e2a76b5a87580
Author: teemuatlut <teemu.mantykallio@live.fi>
Date:   Fri Feb 2 05:49:40 2018 +0200

    [2.0.x] TMC2130 support for LPC platform (#9114)

diff --git a/platformio.ini b/platformio.ini
index 79f751d9ac..caea5e4548 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -113,6 +113,7 @@ lib_ldf_mode    = off
 lib_extra_dirs  = frameworks
 lib_deps        = CMSIS-LPC1768
   U8glib-HAL
+  TMC2130Stepper@>=2.1.1
 extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 src_filter      = ${common.default_src_filter}
 

commit 6e3519abae8e5d3ffa1e1071b556421956756139
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Jan 31 23:52:54 2018 -0600

    Try to use an Neopixel library for Travis CI

diff --git a/platformio.ini b/platformio.ini
index d0ff134cff..79f751d9ac 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -28,7 +28,7 @@ lib_deps =
   LiquidCrystal_I2C@1.1.2
   TMC2130Stepper
   https://github.com/teemuatlut/TMC2208Stepper.git
-  Adafruit NeoPixel
+  Adafruit NeoPixel@1.1.3
   https://github.com/lincomatic/LiquidTWI2.git
   https://github.com/trinamic/TMC26XStepper.git
   https://github.com/ameyer/Arduino-L6470.git

commit a994eec5136e2c8df8ae2f2102176d9997b376e8
Author: Ivan Kravets <me@ikravets.com>
Date:   Wed Jan 10 02:25:16 2018 +0200

    Cleanup unused options (#9115)

diff --git a/platformio.ini b/platformio.ini
index 86e3e5a805..d0ff134cff 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -17,7 +17,7 @@
 
 [platformio]
 src_dir = Marlin
-envs_dir = .pioenvs
+build_dir = .pioenvs
 lib_dir = .piolib
 libdeps_dir = .piolibdeps
 env_default = megaatmega2560
@@ -54,7 +54,7 @@ build_flags = -fmax-errors=5
 platform    = atmelavr
 framework   = arduino
 board       = megaatmega2560
-build_flags = ${common.build_flags} -I $BUILDSRC_DIR
+build_flags = ${common.build_flags}
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
@@ -66,7 +66,7 @@ src_filter  = ${common.default_src_filter}
 platform    = atmelavr
 framework   = arduino
 board       = megaatmega1280
-build_flags = ${common.build_flags} -I $BUILDSRC_DIR
+build_flags = ${common.build_flags}
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
@@ -93,7 +93,7 @@ src_filter   = ${common.default_src_filter}
 platform    = atmelsam
 framework   = arduino
 board       = due
-build_flags = ${common.build_flags} -I $BUILDSRC_DIR
+build_flags = ${common.build_flags}
 lib_deps    = ${common.lib_deps}
 lib_ignore  = TMC26XStepper
 src_filter  = ${common.default_src_filter}
@@ -156,7 +156,7 @@ debug_server   =
 platform    = atmelavr
 framework   = arduino
 board       = reprap_rambo
-build_flags = ${common.build_flags} -I $BUILDSRC_DIR
+build_flags = ${common.build_flags}
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
@@ -192,7 +192,7 @@ src_filter  = ${common.default_src_filter}
 platform      = teensy
 framework     = arduino
 board         = teensy20pp
-build_flags   = ${common.build_flags} -I $BUILDSRC_DIR
+build_flags   = ${common.build_flags}
 #board_f_cpu  = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
 lib_deps      = ${common.lib_deps}
 lib_ldf_mode  = deep+
@@ -205,7 +205,7 @@ src_filter    = ${common.default_src_filter}
 platform    = teensy
 framework   = arduino
 board       = teensy35
-build_flags = ${common.build_flags} -I $BUILDSRC_DIR
+build_flags = ${common.build_flags}
 lib_deps    = ${common.lib_deps}
 lib_ignore  = Adafruit NeoPixel
 src_filter  = ${common.default_src_filter}

commit 760dbbb73487289d5d129e0f30545b113f8e8402
Author: Bob-the-Kuhn <bob.kuhn@att.net>
Date:   Sat Jan 6 04:38:32 2018 -0600

    works
    
    root cause identified

diff --git a/platformio.ini b/platformio.ini
index decdd959d5..86e3e5a805 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -195,6 +195,7 @@ board         = teensy20pp
 build_flags   = ${common.build_flags} -I $BUILDSRC_DIR
 #board_f_cpu  = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
 lib_deps      = ${common.lib_deps}
+lib_ldf_mode  = deep+
 src_filter    = ${common.default_src_filter}
 
 #

commit a142fab155b60c382cbf25b6f01d791a6fe1388a
Author: Bob-the-Kuhn <bob.kuhn@att.net>
Date:   Thu Dec 21 12:05:25 2017 -0600

    Enable RRDFGSC on Due

diff --git a/platformio.ini b/platformio.ini
index 01f3bdb11d..decdd959d5 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -95,6 +95,7 @@ framework   = arduino
 board       = due
 build_flags = ${common.build_flags} -I $BUILDSRC_DIR
 lib_deps    = ${common.lib_deps}
+lib_ignore  = TMC26XStepper
 src_filter  = ${common.default_src_filter}
 
 #

commit 45e73b72a5a3223e5120ea2c58b98a62d2466813
Author: Thomas Moore <tcm0116@gmail.com>
Date:   Thu Dec 21 22:44:56 2017 -0600

    Stop compiling after first five errors

diff --git a/platformio.ini b/platformio.ini
index ccc2d17e94..01f3bdb11d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -10,6 +10,11 @@
 # Automatic targets - enable auto-uploading
 # targets = upload
 
+#
+# By default platformio build will abort after 5 errors.
+# Remove '-fmax-errors=5' from build_flags below to see all.
+#
+
 [platformio]
 src_dir = Marlin
 envs_dir = .pioenvs
@@ -30,6 +35,8 @@ lib_deps =
 
 default_src_filter = +<src/*> -<src/config>
 
+build_flags = -fmax-errors=5
+
 #################################
 #                               #
 #   Unique Core Architectures   #
@@ -47,7 +54,7 @@ default_src_filter = +<src/*> -<src/config>
 platform    = atmelavr
 framework   = arduino
 board       = megaatmega2560
-build_flags = -I $BUILDSRC_DIR
+build_flags = ${common.build_flags} -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
@@ -59,7 +66,7 @@ src_filter  = ${common.default_src_filter}
 platform    = atmelavr
 framework   = arduino
 board       = megaatmega1280
-build_flags = -I $BUILDSRC_DIR
+build_flags = ${common.build_flags} -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
@@ -71,6 +78,7 @@ src_filter  = ${common.default_src_filter}
 platform     = atmelavr
 framework    = arduino
 board        = sanguino_atmega1284p
+build_flags  = ${common.build_flags}
 upload_speed = 57600
 lib_deps     = ${common.lib_deps}
 src_filter   = ${common.default_src_filter}
@@ -85,7 +93,7 @@ src_filter   = ${common.default_src_filter}
 platform    = atmelsam
 framework   = arduino
 board       = due
-build_flags = -I $BUILDSRC_DIR
+build_flags = ${common.build_flags} -I $BUILDSRC_DIR
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
 
@@ -96,6 +104,7 @@ src_filter  = ${common.default_src_filter}
 platform        = nxplpc
 board_f_cpu     = 100000000L
 build_flags     = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+  ${common.build_flags}
   -DU8G_HAL_LINKS
 src_build_flags = -Wall
 build_unflags   = -Wall
@@ -116,6 +125,7 @@ platform       = nxplpc
 board          = lpc1768
 board_f_cpu    = 100000000L
 build_flags    = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+  ${common.build_flags}
   -DU8G_HAL_LINKS
 lib_ldf_mode   = off
 lib_extra_dirs = frameworks
@@ -145,7 +155,7 @@ debug_server   =
 platform    = atmelavr
 framework   = arduino
 board       = reprap_rambo
-build_flags = -I $BUILDSRC_DIR
+build_flags = ${common.build_flags} -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
@@ -154,17 +164,19 @@ src_filter  = ${common.default_src_filter}
 # Sanguinololu (ATmega644p)
 #
 [env:sanguino_atmega644p]
-platform   = atmelavr
-framework  = arduino
-board      = sanguino_atmega644p
-lib_deps   = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
+platform    = atmelavr
+framework   = arduino
+board       = sanguino_atmega644p
+build_flags = ${common.build_flags}
+lib_deps    = ${common.lib_deps}
+src_filter  = ${common.default_src_filter}
 
 [env:STM32F1]
 platform    = ststm32
 framework   = arduino
 board       = genericSTM32F103RE
 build_flags = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
+  ${common.build_flags}
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
 
@@ -179,7 +191,7 @@ src_filter  = ${common.default_src_filter}
 platform      = teensy
 framework     = arduino
 board         = teensy20pp
-build_flags   = -I $BUILDSRC_DIR
+build_flags   = ${common.build_flags} -I $BUILDSRC_DIR
 #board_f_cpu  = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
 lib_deps      = ${common.lib_deps}
 src_filter    = ${common.default_src_filter}
@@ -191,7 +203,7 @@ src_filter    = ${common.default_src_filter}
 platform    = teensy
 framework   = arduino
 board       = teensy35
-build_flags = -I $BUILDSRC_DIR
+build_flags = ${common.build_flags} -I $BUILDSRC_DIR
 lib_deps    = ${common.lib_deps}
 lib_ignore  = Adafruit NeoPixel
 src_filter  = ${common.default_src_filter}

commit 0cd1e91056213d6a0bd422848ccff7cd1191d001
Author: teemuatlut <teemu.mantykallio@live.fi>
Date:   Fri Dec 15 23:03:14 2017 +0200

    [2.0.x] TMC driver update (#8769)

diff --git a/platformio.ini b/platformio.ini
index a7caae310b..ccc2d17e94 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -22,6 +22,7 @@ lib_deps =
   U8glib-HAL
   LiquidCrystal_I2C@1.1.2
   TMC2130Stepper
+  https://github.com/teemuatlut/TMC2208Stepper.git
   Adafruit NeoPixel
   https://github.com/lincomatic/LiquidTWI2.git
   https://github.com/trinamic/TMC26XStepper.git

commit 50a5bb77d2435640d461bc1a9d4e60b58fd6769c
Author: Thomas Moore <tcm0116@gmail.com>
Date:   Thu Nov 16 23:23:07 2017 -0600

    Update PlatformIO lib_deps

diff --git a/platformio.ini b/platformio.ini
index 352d9cef7c..a7caae310b 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -21,14 +21,12 @@ env_default = megaatmega2560
 lib_deps =
   U8glib-HAL
   LiquidCrystal_I2C@1.1.2
+  TMC2130Stepper
+  Adafruit NeoPixel
   https://github.com/lincomatic/LiquidTWI2.git
-  https://github.com/teemuatlut/TMC2130Stepper.git
   https://github.com/trinamic/TMC26XStepper.git
-  https://github.com/adafruit/Adafruit_NeoPixel.git
   https://github.com/ameyer/Arduino-L6470.git
 
-
-
 default_src_filter = +<src/*> -<src/config>
 
 #################################
@@ -102,7 +100,6 @@ src_build_flags = -Wall
 build_unflags   = -Wall
 lib_ldf_mode    = off
 lib_extra_dirs  = frameworks
-#lib_deps        = U8glib-ARM, CMSIS-LPC1768
 lib_deps        = CMSIS-LPC1768
   U8glib-HAL
 extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py

commit 81b91b3f9dbec4cb0460c81085d5ddfe84dc40cc
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Nov 10 02:28:53 2017 -0600

    Clean up some trailing white-space

diff --git a/platformio.ini b/platformio.ini
index 9d2890dd5c..352d9cef7c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -26,7 +26,7 @@ lib_deps =
   https://github.com/trinamic/TMC26XStepper.git
   https://github.com/adafruit/Adafruit_NeoPixel.git
   https://github.com/ameyer/Arduino-L6470.git
-  
+
 
 
 default_src_filter = +<src/*> -<src/config>

commit d47fbf791b5369510344b09c0486b6d8b4ad9712
Author: Bob-the-Kuhn <bob.kuhn@att.net>
Date:   Wed Nov 8 15:48:35 2017 -0600

    Arduini IDE compatibility changes
    
    changed includes to make Arduino IDE happy

diff --git a/platformio.ini b/platformio.ini
index 337c6474b4..9d2890dd5c 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -19,7 +19,7 @@ env_default = megaatmega2560
 
 [common]
 lib_deps =
-
+  U8glib-HAL
   LiquidCrystal_I2C@1.1.2
   https://github.com/lincomatic/LiquidTWI2.git
   https://github.com/teemuatlut/TMC2130Stepper.git
@@ -51,7 +51,6 @@ board       = megaatmega2560
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
-  U8glib-HAL
 src_filter  = ${common.default_src_filter}
 
 #
@@ -64,7 +63,6 @@ board       = megaatmega1280
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
-  U8glib-HAL
 src_filter  = ${common.default_src_filter}
 
 #
@@ -76,7 +74,6 @@ framework    = arduino
 board        = sanguino_atmega1284p
 upload_speed = 57600
 lib_deps     = ${common.lib_deps}
-  U8glib-HAL
 src_filter   = ${common.default_src_filter}
 
 #
@@ -91,7 +88,6 @@ framework   = arduino
 board       = due
 build_flags = -I $BUILDSRC_DIR
 lib_deps    = ${common.lib_deps}
-  U8glib-HAL
 src_filter  = ${common.default_src_filter}
 
 #
@@ -154,7 +150,6 @@ board       = reprap_rambo
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
-  U8glib-HAL
 src_filter  = ${common.default_src_filter}
 
 #
@@ -165,7 +160,6 @@ platform   = atmelavr
 framework  = arduino
 board      = sanguino_atmega644p
 lib_deps   = ${common.lib_deps}
-  U8glib-HAL
 src_filter = ${common.default_src_filter}
 
 [env:STM32F1]
@@ -174,7 +168,6 @@ framework   = arduino
 board       = genericSTM32F103RE
 build_flags = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
 lib_deps    = ${common.lib_deps}
-  U8glib-HAL
 src_filter  = ${common.default_src_filter}
 
 #
@@ -191,7 +184,6 @@ board         = teensy20pp
 build_flags   = -I $BUILDSRC_DIR
 #board_f_cpu  = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
 lib_deps      = ${common.lib_deps}
-  U8glib-HAL
 src_filter    = ${common.default_src_filter}
 
 #
@@ -203,6 +195,5 @@ framework   = arduino
 board       = teensy35
 build_flags = -I $BUILDSRC_DIR
 lib_deps    = ${common.lib_deps}
-  U8glib-HAL
 lib_ignore  = Adafruit NeoPixel
 src_filter  = ${common.default_src_filter}

commit c388dce2b5aba9393ffc01d0aeeeacb53c0605d2
Author: Bob-the-Kuhn <bob.kuhn@att.net>
Date:   Wed Nov 8 14:08:09 2017 -0600

    move U8glib-HAL

diff --git a/platformio.ini b/platformio.ini
index 66b3dd134a..337c6474b4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -26,7 +26,7 @@ lib_deps =
   https://github.com/trinamic/TMC26XStepper.git
   https://github.com/adafruit/Adafruit_NeoPixel.git
   https://github.com/ameyer/Arduino-L6470.git
-  U8glib-HAL
+  
 
 
 default_src_filter = +<src/*> -<src/config>
@@ -49,9 +49,9 @@ platform    = atmelavr
 framework   = arduino
 board       = megaatmega2560
 build_flags = -I $BUILDSRC_DIR
-  -fmax-errors=5
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
+  U8glib-HAL
 src_filter  = ${common.default_src_filter}
 
 #
@@ -64,34 +64,7 @@ board       = megaatmega1280
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
-src_filter  = ${common.default_src_filter}
-
-#
-# Teensy++ 2.0
-#
-# - PrintrBoard
-# - PrintrBoard Rev.F
-# - Brainwave Pro
-#
-[env:teensy20]
-platform      = teensy
-framework     = arduino
-board         = teensy20pp
-build_flags   = -I $BUILDSRC_DIR
-#board_f_cpu  = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
-lib_deps      = ${common.lib_deps}
-src_filter    = ${common.default_src_filter}
-
-#
-# RAMBo
-#
-[env:rambo]
-platform    = atmelavr
-framework   = arduino
-board       = reprap_rambo
-build_flags = -I $BUILDSRC_DIR
-board_f_cpu = 16000000L
-lib_deps    = ${common.lib_deps}
+  U8glib-HAL
 src_filter  = ${common.default_src_filter}
 
 #
@@ -103,18 +76,9 @@ framework    = arduino
 board        = sanguino_atmega1284p
 upload_speed = 57600
 lib_deps     = ${common.lib_deps}
+  U8glib-HAL
 src_filter   = ${common.default_src_filter}
 
-#
-# Sanguinololu (ATmega644p)
-#
-[env:sanguino_atmega644p]
-platform   = atmelavr
-framework  = arduino
-board      = sanguino_atmega644p
-lib_deps   = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
-
 #
 # Due (Atmel SAM3X8E ARM Cortex-M3)
 #
@@ -127,18 +91,7 @@ framework   = arduino
 board       = due
 build_flags = -I $BUILDSRC_DIR
 lib_deps    = ${common.lib_deps}
-src_filter  = ${common.default_src_filter}
-
-#
-# Teensy 3.5 / 3.6 (ARM Cortex-M4)
-#
-[env:teensy35]
-platform    = teensy
-framework   = arduino
-board       = teensy35
-build_flags = -I $BUILDSRC_DIR
-lib_deps    = ${common.lib_deps}
-lib_ignore  = Adafruit NeoPixel
+  U8glib-HAL
 src_filter  = ${common.default_src_filter}
 
 #
@@ -191,10 +144,65 @@ debug_server   =
   auto
   -noir
 
+#
+# RAMBo
+#
+[env:rambo]
+platform    = atmelavr
+framework   = arduino
+board       = reprap_rambo
+build_flags = -I $BUILDSRC_DIR
+board_f_cpu = 16000000L
+lib_deps    = ${common.lib_deps}
+  U8glib-HAL
+src_filter  = ${common.default_src_filter}
+
+#
+# Sanguinololu (ATmega644p)
+#
+[env:sanguino_atmega644p]
+platform   = atmelavr
+framework  = arduino
+board      = sanguino_atmega644p
+lib_deps   = ${common.lib_deps}
+  U8glib-HAL
+src_filter = ${common.default_src_filter}
+
 [env:STM32F1]
 platform    = ststm32
 framework   = arduino
 board       = genericSTM32F103RE
 build_flags = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
 lib_deps    = ${common.lib_deps}
+  U8glib-HAL
+src_filter  = ${common.default_src_filter}
+
+#
+# Teensy++ 2.0
+#
+# - PrintrBoard
+# - PrintrBoard Rev.F
+# - Brainwave Pro
+#
+[env:teensy20]
+platform      = teensy
+framework     = arduino
+board         = teensy20pp
+build_flags   = -I $BUILDSRC_DIR
+#board_f_cpu  = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
+lib_deps      = ${common.lib_deps}
+  U8glib-HAL
+src_filter    = ${common.default_src_filter}
+
+#
+# Teensy 3.5 / 3.6 (ARM Cortex-M4)
+#
+[env:teensy35]
+platform    = teensy
+framework   = arduino
+board       = teensy35
+build_flags = -I $BUILDSRC_DIR
+lib_deps    = ${common.lib_deps}
+  U8glib-HAL
+lib_ignore  = Adafruit NeoPixel
 src_filter  = ${common.default_src_filter}

commit 0483a7df913f949ab6c61261356a5cfbe5f0e276
Author: Bob-the-Kuhn <bob.kuhn@att.net>
Date:   Thu Nov 2 20:57:08 2017 -0500

    AVR RRD works
    
    LPC1768 VIKI2 & RRDFG are working
    
    looks like all SPIs are working
    
    library change
    
    sh1106 locks up
    
    fixed lockup, started I2C SW com
    
    pretty
    
    re-org
    
    restore a few files
    
    make library happy
    
    switched HAL version of rrd
    
    fix travis error
    
    travis error fixes
    
    another travis fix
    
    cleanup
    
    minor update
    
    one more
    
    correct spacing in platformio.ini

diff --git a/platformio.ini b/platformio.ini
index a918a94be4..66b3dd134a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -19,13 +19,15 @@ env_default = megaatmega2560
 
 [common]
 lib_deps =
-  U8glib@1.19.1
+
   LiquidCrystal_I2C@1.1.2
   https://github.com/lincomatic/LiquidTWI2.git
   https://github.com/teemuatlut/TMC2130Stepper.git
   https://github.com/trinamic/TMC26XStepper.git
   https://github.com/adafruit/Adafruit_NeoPixel.git
   https://github.com/ameyer/Arduino-L6470.git
+  U8glib-HAL
+
 
 default_src_filter = +<src/*> -<src/config>
 
@@ -47,6 +49,7 @@ platform    = atmelavr
 framework   = arduino
 board       = megaatmega2560
 build_flags = -I $BUILDSRC_DIR
+  -fmax-errors=5
 board_f_cpu = 16000000L
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
@@ -145,11 +148,14 @@ src_filter  = ${common.default_src_filter}
 platform        = nxplpc
 board_f_cpu     = 100000000L
 build_flags     = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+  -DU8G_HAL_LINKS
 src_build_flags = -Wall
 build_unflags   = -Wall
 lib_ldf_mode    = off
 lib_extra_dirs  = frameworks
-lib_deps        = U8glib-ARM, CMSIS-LPC1768
+#lib_deps        = U8glib-ARM, CMSIS-LPC1768
+lib_deps        = CMSIS-LPC1768
+  U8glib-HAL
 extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 src_filter      = ${common.default_src_filter}
 
@@ -163,9 +169,11 @@ platform       = nxplpc
 board          = lpc1768
 board_f_cpu    = 100000000L
 build_flags    = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+  -DU8G_HAL_LINKS
 lib_ldf_mode   = off
 lib_extra_dirs = frameworks
-lib_deps       = U8glib-ARM, CMSIS-LPC1768
+lib_deps       = CMSIS-LPC1768
+  U8glib-HAL
 src_filter     = ${common.default_src_filter}
 extra_scripts  =  Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 debug_tool     = custom
@@ -190,4 +198,3 @@ board       = genericSTM32F103RE
 build_flags = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
 lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
-

commit 83555933aaf4b48c97b91e04e406b9268dc60e2d
Author: Alexey Shvetsov <alexxy@gentoo.org>
Date:   Tue Nov 7 08:03:59 2017 +0300

    Add platformio support for stm32 (#8246)
    
    [2.0] Add platformio support for stm32

diff --git a/platformio.ini b/platformio.ini
index 94f893edfa..a918a94be4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -182,3 +182,12 @@ debug_server   =
   -speed
   auto
   -noir
+
+[env:STM32F1]
+platform    = ststm32
+framework   = arduino
+board       = genericSTM32F103RE
+build_flags = !python Marlin/src/HAL/HAL_STM32F1/stm32f1_flag_script.py
+lib_deps    = ${common.lib_deps}
+src_filter  = ${common.default_src_filter}
+

commit 9e699811d25918fe64793824b2a2fdbccdf3b7bd
Author: Thomas Moore <tcm0116@users.noreply.github.com>
Date:   Thu Oct 26 13:37:26 2017 -0500

    Make LPC1768 pinmapping not specific to Re-ARM (#8063)
    
    * Merging early because of build failures.  See #8105
    
    * Make LPC1768 pinmapping not specific to Re-ARM
    
    * Add HAL_PIN_TYPE and LPC1768 pin features
    
    * M43 Updates
    
    * Move pin map into pinsDebug_LPC1768.h
    
    * Incorporate comments and M226
    
    * Fix persistent store compilation issues
    
    * Update pin features
    
    * Update MKS SBASE pins
    
    * Use native LPC1768 pin numbers in M42, M43, and M226

diff --git a/platformio.ini b/platformio.ini
index 06e783433f..94f893edfa 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -139,9 +139,9 @@ lib_ignore  = Adafruit NeoPixel
 src_filter  = ${common.default_src_filter}
 
 #
-# Re-ARM (NXP LPC1768 ARM Cortex-M3)
+# NXP LPC1768 ARM Cortex-M3
 #
-[env:Re-ARM]
+[env:LPC1768]
 platform        = nxplpc
 board_f_cpu     = 100000000L
 build_flags     = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
@@ -154,9 +154,9 @@ extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 src_filter      = ${common.default_src_filter}
 
 #
-# Re-ARM (for debugging and development)
+# LPC1768 (for debugging and development)
 #
-[env:Re-ARM_debug_and_upload]
+[env:LPC1768_debug_and_upload]
 # Segger JLink
 platform       = nxplpc
 #framework     = mbed

commit 46b2773e13ef6a5474f2be57bf57f1d782339df0
Author: Chris Pepper <p3p@p3psoft.co.uk>
Date:   Wed Oct 4 21:40:54 2017 +0100

    General fixes for LPC1768 (#7834)
    
    * fixed some include paths
    
    * LPC1768: Fix Serial API
    
    Add missing serial methods used if TX_BUFFER_SIZE is set
    Change return value of HalSerial:read to match Arduino API
    
    * LPC1768: add filters to ADC
    
    This is to try and compensate for hardware issue and oversensitivity to noise
    
    * LPC1768: remove the polling section of delayMicroseconds
    
    * LPC1768: lock usb mass storage device while device accesses it.
    
    Currently only applicable to persistent store,
    The device always has priority and will unmount the sd card from the host, Windows then tries to automount again so it can look like the explorer window freezes. Linux Mint, by default, just closes the Nemo window.
    
    * Add timeout to make sure if Serial never connects that Marlin still boots
    
    * Remove unneeded ifdef CPU_32_BIT
    
    In general the need for ifdef CPU_32_BIT blocks means that something is missing from the HAL API or a Platform, in this case HAL_TICKS_PER_US was missing from the AVR Platform
    
    * LPC1768: relocate RE-ARM debug_extra_script.py

diff --git a/platformio.ini b/platformio.ini
index c544ea0789..06e783433f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -158,17 +158,18 @@ src_filter      = ${common.default_src_filter}
 #
 [env:Re-ARM_debug_and_upload]
 # Segger JLink
-platform      = nxplpc
-#framework    = mbed
-board         = lpc1768
-board_f_cpu   = 100000000L
-build_flags   = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
-lib_ldf_mode  = off
-lib_deps      = U8glib-ARM
-src_filter    = ${common.default_src_filter}
-extra_scripts = debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
-debug_tool    = custom
-debug_server  =
+platform       = nxplpc
+#framework     = mbed
+board          = lpc1768
+board_f_cpu    = 100000000L
+build_flags    = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+lib_ldf_mode   = off
+lib_extra_dirs = frameworks
+lib_deps       = U8glib-ARM, CMSIS-LPC1768
+src_filter     = ${common.default_src_filter}
+extra_scripts  =  Marlin/src/HAL/HAL_LPC1768/debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+debug_tool     = custom
+debug_server   =
   C:\Program Files (x86)\SEGGER\JLink_V618d\JLinkGDBServerCL.exe
   -select
   USB

commit 200f971ef7fb25807d9ef6f7be9722dd19fbac58
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon Oct 2 22:53:36 2017 -0500

    Reduce Teensy++ 2.0 to a single entry
    
    Followup to #7750, #7826

diff --git a/platformio.ini b/platformio.ini
index 8374d2f71a..c544ea0789 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -64,39 +64,21 @@ lib_deps    = ${common.lib_deps}
 src_filter  = ${common.default_src_filter}
 
 #
-# PrintrBoard (Teensy++ 2.0)
+# Teensy++ 2.0
 #
-[env:printrboard]
+# - PrintrBoard
+# - PrintrBoard Rev.F
+# - Brainwave Pro
+#
+[env:teensy20]
 platform      = teensy
 framework     = arduino
 board         = teensy20pp
-build_flags   = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
+build_flags   = -I $BUILDSRC_DIR
 #board_f_cpu  = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
 lib_deps      = ${common.lib_deps}
 src_filter    = ${common.default_src_filter}
 
-#
-# PrintrBoard Rev.F (Teensy++ 2.0)
-#
-[env:printrboard_revf]
-platform    = teensy
-framework   = arduino
-board       = teensy20pp
-build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD_REVF
-lib_deps    = ${common.lib_deps}
-src_filter  = ${common.default_src_filter}
-
-#
-# Brainwave Pro (Teensy++ 2.0)
-#
-[env:brainwavepro]
-platform    = teensy
-framework   = arduino
-board       = teensy20pp
-build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_BRAINWAVE_PRO
-lib_deps    = ${common.lib_deps}
-src_filter  = ${common.default_src_filter}
-
 #
 # RAMBo
 #

commit 1ae208395cde62ea932351f0976856136639b72a
Author: Ralph Schmidt <ralphsch@t-online.de>
Date:   Tue Sep 26 03:05:22 2017 +0200

    Remove MOTHERBOARD from "due" entry
    
    Also reformat and document

diff --git a/platformio.ini b/platformio.ini
index b2a2030f9d..8374d2f71a 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -1,13 +1,12 @@
 #
-# Project Configuration File
+# Marlin Firmware
+# PlatformIO Configuration File
+#
+# For detailed documentation with EXAMPLES:
 #
-# A detailed documentation with the EXAMPLES is located here:
 # http://docs.platformio.org/en/latest/projectconf.html
 #
 
-# A sign `#` at the beginning of the line indicates a comment
-# Comment lines are ignored.
-
 # Automatic targets - enable auto-uploading
 # targets = upload
 
@@ -27,115 +26,167 @@ lib_deps =
   https://github.com/trinamic/TMC26XStepper.git
   https://github.com/adafruit/Adafruit_NeoPixel.git
   https://github.com/ameyer/Arduino-L6470.git
-default_src_filter = +<*> -<src/config/examples>
 
+default_src_filter = +<src/*> -<src/config>
+
+#################################
+#                               #
+#   Unique Core Architectures   #
+#                               #
+#  Add a new "env" below if no  #
+# entry has values suitable to  #
+#   build for a given board.    #
+#                               #
+#################################
+
+#
+# ATmega2560
+#
 [env:megaatmega2560]
-platform = atmelavr
-framework = arduino
-board = megaatmega2560
+platform    = atmelavr
+framework   = arduino
+board       = megaatmega2560
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
+lib_deps    = ${common.lib_deps}
+src_filter  = ${common.default_src_filter}
 
+#
+# ATmega1280
+#
 [env:megaatmega1280]
-platform = atmelavr
-framework = arduino
-board = megaatmega1280
+platform    = atmelavr
+framework   = arduino
+board       = megaatmega1280
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
+lib_deps    = ${common.lib_deps}
+src_filter  = ${common.default_src_filter}
 
+#
+# PrintrBoard (Teensy++ 2.0)
+#
 [env:printrboard]
-platform = teensy
-framework = arduino
-board = teensy20pp
-build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
-# Bug in arduino framework does not allow boards running at 20Mhz
-#board_f_cpu = 20000000L
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
+platform      = teensy
+framework     = arduino
+board         = teensy20pp
+build_flags   = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
+#board_f_cpu  = 20000000L     ; Bug in Arduino framework disallows boards running at 20Mhz
+lib_deps      = ${common.lib_deps}
+src_filter    = ${common.default_src_filter}
 
+#
+# PrintrBoard Rev.F (Teensy++ 2.0)
+#
 [env:printrboard_revf]
-platform = teensy
-framework = arduino
-board = teensy20pp
+platform    = teensy
+framework   = arduino
+board       = teensy20pp
 build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD_REVF
-lib_deps = ${common.lib_deps}
+lib_deps    = ${common.lib_deps}
+src_filter  = ${common.default_src_filter}
 
+#
+# Brainwave Pro (Teensy++ 2.0)
+#
 [env:brainwavepro]
-platform = teensy
-framework = arduino
-board = teensy20pp
+platform    = teensy
+framework   = arduino
+board       = teensy20pp
 build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_BRAINWAVE_PRO
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
+lib_deps    = ${common.lib_deps}
+src_filter  = ${common.default_src_filter}
 
+#
+# RAMBo
+#
 [env:rambo]
-platform = atmelavr
-framework = arduino
-board = reprap_rambo
+platform    = atmelavr
+framework   = arduino
+board       = reprap_rambo
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
+lib_deps    = ${common.lib_deps}
+src_filter  = ${common.default_src_filter}
 
+#
+# Anet 1.0 - Melzi clone (ATmega1284p)
+#
 [env:anet10]
-platform = atmelavr
-framework = arduino
-board = sanguino_atmega1284p
+platform     = atmelavr
+framework    = arduino
+board        = sanguino_atmega1284p
 upload_speed = 57600
-lib_deps = ${common.lib_deps}
+lib_deps     = ${common.lib_deps}
+src_filter   = ${common.default_src_filter}
 
+#
+# Sanguinololu (ATmega644p)
+#
 [env:sanguino_atmega644p]
-platform = atmelavr
-framework = arduino
-board = sanguino_atmega644p
-lib_deps = ${common.lib_deps}
+platform   = atmelavr
+framework  = arduino
+board      = sanguino_atmega644p
+lib_deps   = ${common.lib_deps}
+src_filter = ${common.default_src_filter}
 
+#
+# Due (Atmel SAM3X8E ARM Cortex-M3)
+#
+#  - RAMPS4DUE
+#  - RADDS
+#
 [env:DUE]
-platform = atmelsam
-framework = arduino
-board = due
-build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_RAMPS4DUE_EFB
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
+platform    = atmelsam
+framework   = arduino
+board       = due
+build_flags = -I $BUILDSRC_DIR
+lib_deps    = ${common.lib_deps}
+src_filter  = ${common.default_src_filter}
 
+#
+# Teensy 3.5 / 3.6 (ARM Cortex-M4)
+#
 [env:teensy35]
-platform = teensy
-framework = arduino
-board = teensy35
+platform    = teensy
+framework   = arduino
+board       = teensy35
 build_flags = -I $BUILDSRC_DIR
-lib_deps = ${common.lib_deps}
-lib_ignore = Adafruit NeoPixel
-src_filter = ${common.default_src_filter}
+lib_deps    = ${common.lib_deps}
+lib_ignore  = Adafruit NeoPixel
+src_filter  = ${common.default_src_filter}
 
+#
+# Re-ARM (NXP LPC1768 ARM Cortex-M3)
+#
 [env:Re-ARM]
-platform = nxplpc
-board_f_cpu = 100000000L
-build_flags = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+platform        = nxplpc
+board_f_cpu     = 100000000L
+build_flags     = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 src_build_flags = -Wall
-build_unflags = -Wall
-lib_ldf_mode = off
-lib_extra_dirs = frameworks
-lib_deps = U8glib-ARM, CMSIS-LPC1768
-extra_scripts = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
-
+build_unflags   = -Wall
+lib_ldf_mode    = off
+lib_extra_dirs  = frameworks
+lib_deps        = U8glib-ARM, CMSIS-LPC1768
+extra_scripts   = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+src_filter      = ${common.default_src_filter}
 
+#
+# Re-ARM (for debugging and development)
+#
 [env:Re-ARM_debug_and_upload]
 # Segger JLink
-platform = nxplpc
-#framework = mbed
-board = lpc1768
-board_f_cpu = 100000000L
-build_flags = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
-lib_ldf_mode = off
-lib_deps = U8glib-ARM
-src_filter =
-extra_scripts = debug_extra_script.py,  Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
-debug_tool = custom
-debug_server =
+platform      = nxplpc
+#framework    = mbed
+board         = lpc1768
+board_f_cpu   = 100000000L
+build_flags   = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+lib_ldf_mode  = off
+lib_deps      = U8glib-ARM
+src_filter    = ${common.default_src_filter}
+extra_scripts = debug_extra_script.py, Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+debug_tool    = custom
+debug_server  =
   C:\Program Files (x86)\SEGGER\JLink_V618d\JLinkGDBServerCL.exe
   -select
   USB

commit 2d41c593203c8c53ec85b4988b38425579272bee
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Oct 1 18:35:39 2017 -0500

    Tweak some spacing

diff --git a/platformio.ini b/platformio.ini
index 5d5dc25a2f..b2a2030f9d 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -148,4 +148,3 @@ debug_server =
   -speed
   auto
   -noir
-  
\ No newline at end of file

commit bea3ec2724e365693589d9e09616863f4974b218
Author: Christopher Pepper <p3p@p3psoft.co.uk>
Date:   Sun Jun 18 00:36:10 2017 +0100

    M355 S0, S1 fixes & faster LCD, SD card
    
    fix Travis error

diff --git a/platformio.ini b/platformio.ini
index 7d871f4f37..5d5dc25a2f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -121,3 +121,31 @@ lib_ldf_mode = off
 lib_extra_dirs = frameworks
 lib_deps = U8glib-ARM, CMSIS-LPC1768
 extra_scripts = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+
+
+[env:Re-ARM_debug_and_upload]
+# Segger JLink
+platform = nxplpc
+#framework = mbed
+board = lpc1768
+board_f_cpu = 100000000L
+build_flags = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+lib_ldf_mode = off
+lib_deps = U8glib-ARM
+src_filter =
+extra_scripts = debug_extra_script.py,  Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+debug_tool = custom
+debug_server =
+  C:\Program Files (x86)\SEGGER\JLink_V618d\JLinkGDBServerCL.exe
+  -select
+  USB
+  -port
+  2331
+  -device
+  LPC1768
+  -if
+  JTAG
+  -speed
+  auto
+  -noir
+  
\ No newline at end of file

commit ddbd4b73e081e1c47383cffdd8a9425369d9a1c8
Author: Thomas Moore <tcm0116@gmail.com>
Date:   Tue Sep 19 19:25:59 2017 -0500

    Move LPC1768 framework out of Marlin source folder

diff --git a/platformio.ini b/platformio.ini
index 672e0098c0..7d871f4f37 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -27,7 +27,7 @@ lib_deps =
   https://github.com/trinamic/TMC26XStepper.git
   https://github.com/adafruit/Adafruit_NeoPixel.git
   https://github.com/ameyer/Arduino-L6470.git
-default_src_filter = +<*> -<src/config/examples> -<frameworks>
+default_src_filter = +<*> -<src/config/examples>
 
 [env:megaatmega2560]
 platform = atmelavr
@@ -115,7 +115,9 @@ src_filter = ${common.default_src_filter}
 platform = nxplpc
 board_f_cpu = 100000000L
 build_flags = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+src_build_flags = -Wall
+build_unflags = -Wall
 lib_ldf_mode = off
-lib_deps = U8glib-ARM
-src_filter = ${common.default_src_filter} +<frameworks/CMSIS/LPC1768>
+lib_extra_dirs = frameworks
+lib_deps = U8glib-ARM, CMSIS-LPC1768
 extra_scripts = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py

commit 038f82cc38613aca79cd2ece2ded535f0d9b1c1c
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Sep 7 03:36:39 2017 -0500

    Fix L6470 init and options

diff --git a/platformio.ini b/platformio.ini
index aa183344e9..672e0098c0 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -26,6 +26,7 @@ lib_deps =
   https://github.com/teemuatlut/TMC2130Stepper.git
   https://github.com/trinamic/TMC26XStepper.git
   https://github.com/adafruit/Adafruit_NeoPixel.git
+  https://github.com/ameyer/Arduino-L6470.git
 default_src_filter = +<*> -<src/config/examples> -<frameworks>
 
 [env:megaatmega2560]

commit 42e2dd925119ade7d663129e9886bb2acdecaad4
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Sep 6 06:28:33 2017 -0500

    Build file updates

diff --git a/platformio.ini b/platformio.ini
index 835e463192..aa183344e9 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -24,8 +24,9 @@ lib_deps =
   LiquidCrystal_I2C@1.1.2
   https://github.com/lincomatic/LiquidTWI2.git
   https://github.com/teemuatlut/TMC2130Stepper.git
+  https://github.com/trinamic/TMC26XStepper.git
   https://github.com/adafruit/Adafruit_NeoPixel.git
-default_src_filter = +<*> -<example_configurations> -<frameworks>
+default_src_filter = +<*> -<src/config/examples> -<frameworks>
 
 [env:megaatmega2560]
 platform = atmelavr

commit 7e42c7563c90d1ad4951973d18f35aa0410d39f8
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Sep 6 06:28:31 2017 -0500

    Move build files into place

diff --git a/platformio.ini b/platformio.ini
new file mode 100644
index 0000000000..835e463192
--- /dev/null
+++ b/platformio.ini
@@ -0,0 +1,119 @@
+#
+# Project Configuration File
+#
+# A detailed documentation with the EXAMPLES is located here:
+# http://docs.platformio.org/en/latest/projectconf.html
+#
+
+# A sign `#` at the beginning of the line indicates a comment
+# Comment lines are ignored.
+
+# Automatic targets - enable auto-uploading
+# targets = upload
+
+[platformio]
+src_dir = Marlin
+envs_dir = .pioenvs
+lib_dir = .piolib
+libdeps_dir = .piolibdeps
+env_default = megaatmega2560
+
+[common]
+lib_deps =
+  U8glib@1.19.1
+  LiquidCrystal_I2C@1.1.2
+  https://github.com/lincomatic/LiquidTWI2.git
+  https://github.com/teemuatlut/TMC2130Stepper.git
+  https://github.com/adafruit/Adafruit_NeoPixel.git
+default_src_filter = +<*> -<example_configurations> -<frameworks>
+
+[env:megaatmega2560]
+platform = atmelavr
+framework = arduino
+board = megaatmega2560
+build_flags = -I $BUILDSRC_DIR
+board_f_cpu = 16000000L
+lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter}
+
+[env:megaatmega1280]
+platform = atmelavr
+framework = arduino
+board = megaatmega1280
+build_flags = -I $BUILDSRC_DIR
+board_f_cpu = 16000000L
+lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter}
+
+[env:printrboard]
+platform = teensy
+framework = arduino
+board = teensy20pp
+build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
+# Bug in arduino framework does not allow boards running at 20Mhz
+#board_f_cpu = 20000000L
+lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter}
+
+[env:printrboard_revf]
+platform = teensy
+framework = arduino
+board = teensy20pp
+build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD_REVF
+lib_deps = ${common.lib_deps}
+
+[env:brainwavepro]
+platform = teensy
+framework = arduino
+board = teensy20pp
+build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_BRAINWAVE_PRO
+lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter}
+
+[env:rambo]
+platform = atmelavr
+framework = arduino
+board = reprap_rambo
+build_flags = -I $BUILDSRC_DIR
+board_f_cpu = 16000000L
+lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter}
+
+[env:anet10]
+platform = atmelavr
+framework = arduino
+board = sanguino_atmega1284p
+upload_speed = 57600
+lib_deps = ${common.lib_deps}
+
+[env:sanguino_atmega644p]
+platform = atmelavr
+framework = arduino
+board = sanguino_atmega644p
+lib_deps = ${common.lib_deps}
+
+[env:DUE]
+platform = atmelsam
+framework = arduino
+board = due
+build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_RAMPS4DUE_EFB
+lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter}
+
+[env:teensy35]
+platform = teensy
+framework = arduino
+board = teensy35
+build_flags = -I $BUILDSRC_DIR
+lib_deps = ${common.lib_deps}
+lib_ignore = Adafruit NeoPixel
+src_filter = ${common.default_src_filter}
+
+[env:Re-ARM]
+platform = nxplpc
+board_f_cpu = 100000000L
+build_flags = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+lib_ldf_mode = off
+lib_deps = U8glib-ARM
+src_filter = ${common.default_src_filter} +<frameworks/CMSIS/LPC1768>
+extra_scripts = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py

commit 48351fd6d5163acfbe52953700f7cdbdb3dcecab
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Sep 6 06:28:29 2017 -0500

    Move root sources

diff --git a/platformio.ini b/platformio.ini
deleted file mode 100644
index 835e463192..0000000000
--- a/platformio.ini
+++ /dev/null
@@ -1,119 +0,0 @@
-#
-# Project Configuration File
-#
-# A detailed documentation with the EXAMPLES is located here:
-# http://docs.platformio.org/en/latest/projectconf.html
-#
-
-# A sign `#` at the beginning of the line indicates a comment
-# Comment lines are ignored.
-
-# Automatic targets - enable auto-uploading
-# targets = upload
-
-[platformio]
-src_dir = Marlin
-envs_dir = .pioenvs
-lib_dir = .piolib
-libdeps_dir = .piolibdeps
-env_default = megaatmega2560
-
-[common]
-lib_deps =
-  U8glib@1.19.1
-  LiquidCrystal_I2C@1.1.2
-  https://github.com/lincomatic/LiquidTWI2.git
-  https://github.com/teemuatlut/TMC2130Stepper.git
-  https://github.com/adafruit/Adafruit_NeoPixel.git
-default_src_filter = +<*> -<example_configurations> -<frameworks>
-
-[env:megaatmega2560]
-platform = atmelavr
-framework = arduino
-board = megaatmega2560
-build_flags = -I $BUILDSRC_DIR
-board_f_cpu = 16000000L
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
-
-[env:megaatmega1280]
-platform = atmelavr
-framework = arduino
-board = megaatmega1280
-build_flags = -I $BUILDSRC_DIR
-board_f_cpu = 16000000L
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
-
-[env:printrboard]
-platform = teensy
-framework = arduino
-board = teensy20pp
-build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
-# Bug in arduino framework does not allow boards running at 20Mhz
-#board_f_cpu = 20000000L
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
-
-[env:printrboard_revf]
-platform = teensy
-framework = arduino
-board = teensy20pp
-build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD_REVF
-lib_deps = ${common.lib_deps}
-
-[env:brainwavepro]
-platform = teensy
-framework = arduino
-board = teensy20pp
-build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_BRAINWAVE_PRO
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
-
-[env:rambo]
-platform = atmelavr
-framework = arduino
-board = reprap_rambo
-build_flags = -I $BUILDSRC_DIR
-board_f_cpu = 16000000L
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
-
-[env:anet10]
-platform = atmelavr
-framework = arduino
-board = sanguino_atmega1284p
-upload_speed = 57600
-lib_deps = ${common.lib_deps}
-
-[env:sanguino_atmega644p]
-platform = atmelavr
-framework = arduino
-board = sanguino_atmega644p
-lib_deps = ${common.lib_deps}
-
-[env:DUE]
-platform = atmelsam
-framework = arduino
-board = due
-build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_RAMPS4DUE_EFB
-lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter}
-
-[env:teensy35]
-platform = teensy
-framework = arduino
-board = teensy35
-build_flags = -I $BUILDSRC_DIR
-lib_deps = ${common.lib_deps}
-lib_ignore = Adafruit NeoPixel
-src_filter = ${common.default_src_filter}
-
-[env:Re-ARM]
-platform = nxplpc
-board_f_cpu = 100000000L
-build_flags = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
-lib_ldf_mode = off
-lib_deps = U8glib-ARM
-src_filter = ${common.default_src_filter} +<frameworks/CMSIS/LPC1768>
-extra_scripts = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py

commit b908e38d084377e445428f1053ce24a2a0e6f6ff
Author: Christopher Pepper <p3p@p3psoft.co.uk>
Date:   Sat Aug 26 21:25:25 2017 +0100

    Add needed platform defined gaurds to compile with Arduino IDE
    
    Also removed explicit platform HAL directory inclusion from platformio.ini to make sure these errors are caught by Travis in the future

diff --git a/platformio.ini b/platformio.ini
index 33ce164e37..835e463192 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -25,7 +25,7 @@ lib_deps =
   https://github.com/lincomatic/LiquidTWI2.git
   https://github.com/teemuatlut/TMC2130Stepper.git
   https://github.com/adafruit/Adafruit_NeoPixel.git
-default_src_filter = +<*> -<example_configurations> -<src/HAL/HAL_*> -<frameworks>
+default_src_filter = +<*> -<example_configurations> -<frameworks>
 
 [env:megaatmega2560]
 platform = atmelavr
@@ -34,7 +34,7 @@ board = megaatmega2560
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter = ${common.default_src_filter}
 
 [env:megaatmega1280]
 platform = atmelavr
@@ -43,7 +43,7 @@ board = megaatmega1280
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter = ${common.default_src_filter}
 
 [env:printrboard]
 platform = teensy
@@ -53,7 +53,7 @@ build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
 # Bug in arduino framework does not allow boards running at 20Mhz
 #board_f_cpu = 20000000L
 lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter = ${common.default_src_filter}
 
 [env:printrboard_revf]
 platform = teensy
@@ -68,7 +68,7 @@ framework = arduino
 board = teensy20pp
 build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_BRAINWAVE_PRO
 lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter = ${common.default_src_filter}
 
 [env:rambo]
 platform = atmelavr
@@ -77,7 +77,7 @@ board = reprap_rambo
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_AVR>
+src_filter = ${common.default_src_filter}
 
 [env:anet10]
 platform = atmelavr
@@ -98,7 +98,7 @@ framework = arduino
 board = due
 build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_RAMPS4DUE_EFB
 lib_deps = ${common.lib_deps}
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_DUE>
+src_filter = ${common.default_src_filter}
 
 [env:teensy35]
 platform = teensy
@@ -107,7 +107,7 @@ board = teensy35
 build_flags = -I $BUILDSRC_DIR
 lib_deps = ${common.lib_deps}
 lib_ignore = Adafruit NeoPixel
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
+src_filter = ${common.default_src_filter}
 
 [env:Re-ARM]
 platform = nxplpc
@@ -115,5 +115,5 @@ board_f_cpu = 100000000L
 build_flags = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 lib_ldf_mode = off
 lib_deps = U8glib-ARM
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_LPC1768> +<frameworks/CMSIS/LPC1768>
+src_filter = ${common.default_src_filter} +<frameworks/CMSIS/LPC1768>
 extra_scripts = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py

commit 4183a249b6b3102add751f661a852543852569a1
Author: Christopher Pepper <p3p@p3psoft.co.uk>
Date:   Tue Aug 1 17:19:23 2017 +0100

    Moved CMSIS and other LPC1768 dependencies
    
    Fixes Arduino IDE builds for 8-bit AVR,
    misc: Adafruit NeoPixel currently incompatible with Teensy 3.5-6, blacklisted

diff --git a/platformio.ini b/platformio.ini
index eca843a5c4..33ce164e37 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -25,7 +25,7 @@ lib_deps =
   https://github.com/lincomatic/LiquidTWI2.git
   https://github.com/teemuatlut/TMC2130Stepper.git
   https://github.com/adafruit/Adafruit_NeoPixel.git
-default_src_filter = +<*> -<example_configurations> -<src/HAL/HAL_*>
+default_src_filter = +<*> -<example_configurations> -<src/HAL/HAL_*> -<frameworks>
 
 [env:megaatmega2560]
 platform = atmelavr
@@ -106,6 +106,7 @@ framework = arduino
 board = teensy35
 build_flags = -I $BUILDSRC_DIR
 lib_deps = ${common.lib_deps}
+lib_ignore = Adafruit NeoPixel
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
 
 [env:Re-ARM]
@@ -114,5 +115,5 @@ board_f_cpu = 100000000L
 build_flags = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
 lib_ldf_mode = off
 lib_deps = U8glib-ARM
-src_filter = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_LPC1768> +<frameworks/CMSIS/LPC1768>
 extra_scripts = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py

commit d2fb3215da98cd799670b22d7ab133392a1f2408
Author: Christopher Pepper <p3p@p3psoft.co.uk>
Date:   Wed Jul 19 21:34:30 2017 +0100

    PlatformIO Travis test
    
    spi.h renamed to avoid conflicts with base libraries

diff --git a/platformio.ini b/platformio.ini
index 1301483172..eca843a5c4 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -24,6 +24,7 @@ lib_deps =
   LiquidCrystal_I2C@1.1.2
   https://github.com/lincomatic/LiquidTWI2.git
   https://github.com/teemuatlut/TMC2130Stepper.git
+  https://github.com/adafruit/Adafruit_NeoPixel.git
 default_src_filter = +<*> -<example_configurations> -<src/HAL/HAL_*>
 
 [env:megaatmega2560]
@@ -95,7 +96,7 @@ lib_deps = ${common.lib_deps}
 platform = atmelsam
 framework = arduino
 board = due
-build_flags = -I $BUILDSRC_DIR
+build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_RAMPS4DUE_EFB
 lib_deps = ${common.lib_deps}
 src_filter = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 

commit 44b0c186a6fa0d7d21414160877082c2350e544e
Author: Christopher Pepper <p3p@p3psoft.co.uk>
Date:   Sat Jun 17 22:19:42 2017 +0100

    HAL for Re:ARM (LPC1768) architecture

diff --git a/platformio.ini b/platformio.ini
index 56db52aefb..1301483172 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -19,7 +19,12 @@ libdeps_dir = .piolibdeps
 env_default = megaatmega2560
 
 [common]
-lib_deps = U8glib@1.19.1
+lib_deps =
+  U8glib@1.19.1
+  LiquidCrystal_I2C@1.1.2
+  https://github.com/lincomatic/LiquidTWI2.git
+  https://github.com/teemuatlut/TMC2130Stepper.git
+default_src_filter = +<*> -<example_configurations> -<src/HAL/HAL_*>
 
 [env:megaatmega2560]
 platform = atmelavr
@@ -28,6 +33,7 @@ board = megaatmega2560
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 
 [env:megaatmega1280]
 platform = atmelavr
@@ -36,6 +42,7 @@ board = megaatmega1280
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 
 [env:printrboard]
 platform = teensy
@@ -45,6 +52,7 @@ build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
 # Bug in arduino framework does not allow boards running at 20Mhz
 #board_f_cpu = 20000000L
 lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 
 [env:printrboard_revf]
 platform = teensy
@@ -59,6 +67,7 @@ framework = arduino
 board = teensy20pp
 build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_BRAINWAVE_PRO
 lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 
 [env:rambo]
 platform = atmelavr
@@ -67,6 +76,7 @@ board = reprap_rambo
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_AVR>
 
 [env:anet10]
 platform = atmelavr
@@ -87,6 +97,7 @@ framework = arduino
 board = due
 build_flags = -I $BUILDSRC_DIR
 lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_DUE>
 
 [env:teensy35]
 platform = teensy
@@ -94,3 +105,13 @@ framework = arduino
 board = teensy35
 build_flags = -I $BUILDSRC_DIR
 lib_deps = ${common.lib_deps}
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_TEENSY35_36>
+
+[env:Re-ARM]
+platform = nxplpc
+board_f_cpu = 100000000L
+build_flags = !python Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py
+lib_ldf_mode = off
+lib_deps = U8glib-ARM
+src_filter = ${common.default_src_filter} +<src/HAL/HAL_LPC1768>
+extra_scripts = Marlin/src/HAL/HAL_LPC1768/lpc1768_flag_script.py

commit f3e562e46e4a407f3a05b9adcf1f84eaa376ed96
Author: teemuatlut <teemu.mantykallio@live.fi>
Date:   Tue Jul 11 21:59:27 2017 +0100

    HAL for 32-bit Teensy (3.5, 3.6) architecture

diff --git a/platformio.ini b/platformio.ini
index beb71cdb87..56db52aefb 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -87,3 +87,10 @@ framework = arduino
 board = due
 build_flags = -I $BUILDSRC_DIR
 lib_deps = ${common.lib_deps}
+
+[env:teensy35]
+platform = teensy
+framework = arduino
+board = teensy35
+build_flags = -I $BUILDSRC_DIR
+lib_deps = ${common.lib_deps}

commit cfef9255593892e403a8618f277962c9a9afe5da
Author: Christopher Pepper <p3p@p3psoft.co.uk>
Date:   Wed Jul 19 00:29:06 2017 +0100

    HAL for DUE architecture

diff --git a/platformio.ini b/platformio.ini
index 3d7cff483e..beb71cdb87 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -80,3 +80,10 @@ platform = atmelavr
 framework = arduino
 board = sanguino_atmega644p
 lib_deps = ${common.lib_deps}
+
+[env:DUE]
+platform = atmelsam
+framework = arduino
+board = due
+build_flags = -I $BUILDSRC_DIR
+lib_deps = ${common.lib_deps}

commit d29bf49b667b2209b0e526a867badc5fb572b0e6
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Aug 19 20:04:41 2017 -0500

    Add Sanguino 644p to ENV for PlatformIO

diff --git a/platformio.ini b/platformio.ini
index 3b05bc5661..3d7cff483e 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -74,3 +74,9 @@ framework = arduino
 board = sanguino_atmega1284p
 upload_speed = 57600
 lib_deps = ${common.lib_deps}
+
+[env:sanguino_atmega644p]
+platform = atmelavr
+framework = arduino
+board = sanguino_atmega644p
+lib_deps = ${common.lib_deps}

commit 5fa61c0ad32b086bc52f9847e5c85d07d16e963f
Author: MTrab <morten@trab.dk>
Date:   Sun Aug 13 12:55:11 2017 +0200

    Add Anet 1.0 to Platformio.ini
    
    Added env:anet10 to platformio.ini for easy compile and upload to this board

diff --git a/platformio.ini b/platformio.ini
index 50137628e7..3b05bc5661 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -67,3 +67,10 @@ board = reprap_rambo
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps = ${common.lib_deps}
+
+[env:anet10]
+platform = atmelavr
+framework = arduino
+board = sanguino_atmega1284p
+upload_speed = 57600
+lib_deps = ${common.lib_deps}

commit 42aa10d2637ee9cdbd1766e8abbf32593f4e8030
Author: Unknown <davejohnson3000@gmail.com>
Date:   Tue Jul 25 19:09:08 2017 -0700

    Add PIO entry for PRINTRBOARD_REVF
    
    
    fix from PIO corruption

diff --git a/platformio.ini b/platformio.ini
index c5ef19140f..50137628e7 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -46,6 +46,13 @@ build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
 #board_f_cpu = 20000000L
 lib_deps = ${common.lib_deps}
 
+[env:printrboard_revf]
+platform = teensy
+framework = arduino
+board = teensy20pp
+build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD_REVF
+lib_deps = ${common.lib_deps}
+
 [env:brainwavepro]
 platform = teensy
 framework = arduino

commit b378deaf8971952217f32dd74ca201645ba5f156
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Jun 8 18:05:14 2017 -0500

    Unify AVR90USB: fastio changes

diff --git a/platformio.ini b/platformio.ini
index c82fe48696..c5ef19140f 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -50,7 +50,7 @@ lib_deps = ${common.lib_deps}
 platform = teensy
 framework = arduino
 board = teensy20pp
-build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_BRAINWAVE_PRO -D AT90USBxx_TEENSYPP_ASSIGNMENTS
+build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_BRAINWAVE_PRO
 lib_deps = ${common.lib_deps}
 
 [env:rambo]

commit f1cccd65c29558c1fcf2ef8758b6a68860fd23c0
Author: Brian <bgort@users.noreply.github.com>
Date:   Wed May 10 07:11:13 2017 -0400

    platformio.ini env_default=xxxxx has to match one of the labels in the env:xxxxx, otherwise nothing happens when you `pio run`

diff --git a/platformio.ini b/platformio.ini
index 4182e53fcd..c82fe48696 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -16,7 +16,7 @@ src_dir = Marlin
 envs_dir = .pioenvs
 lib_dir = .piolib
 libdeps_dir = .piolibdeps
-env_default = mega2560
+env_default = megaatmega2560
 
 [common]
 lib_deps = U8glib@1.19.1

commit fe1fce5f56dd222491e561355625cfece15772c6
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue May 9 11:28:39 2017 -0500

    DevIoT patch 2

diff --git a/platformio.ini b/platformio.ini
index ec62931eb4..4182e53fcd 100644
--- a/platformio.ini
+++ b/platformio.ini
@@ -21,18 +21,18 @@ env_default = mega2560
 [common]
 lib_deps = U8glib@1.19.1
 
-[env:mega2560]
+[env:megaatmega2560]
 platform = atmelavr
 framework = arduino
-board = mega2560
+board = megaatmega2560
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps = ${common.lib_deps}
 
-[env:mega1280]
+[env:megaatmega1280]
 platform = atmelavr
 framework = arduino
-board = mega1280
+board = megaatmega1280
 build_flags = -I $BUILDSRC_DIR
 board_f_cpu = 16000000L
 lib_deps = ${common.lib_deps}
@@ -41,7 +41,7 @@ lib_deps = ${common.lib_deps}
 platform = teensy
 framework = arduino
 board = teensy20pp
-build_flags =  -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
+build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
 # Bug in arduino framework does not allow boards running at 20Mhz
 #board_f_cpu = 20000000L
 lib_deps = ${common.lib_deps}

commit 47cae2929f55e284c8a029a4459ecd57b720323c
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon May 8 20:05:57 2017 -0500

    Patch platformio.ini to fix build error in DevIoT
    
    For compatibility with DevIoT, until that can be solved.

diff --git a/platformio.ini b/platformio.ini
new file mode 100644
index 0000000000..ec62931eb4
--- /dev/null
+++ b/platformio.ini
@@ -0,0 +1,62 @@
+#
+# Project Configuration File
+#
+# A detailed documentation with the EXAMPLES is located here:
+# http://docs.platformio.org/en/latest/projectconf.html
+#
+
+# A sign `#` at the beginning of the line indicates a comment
+# Comment lines are ignored.
+
+# Automatic targets - enable auto-uploading
+# targets = upload
+
+[platformio]
+src_dir = Marlin
+envs_dir = .pioenvs
+lib_dir = .piolib
+libdeps_dir = .piolibdeps
+env_default = mega2560
+
+[common]
+lib_deps = U8glib@1.19.1
+
+[env:mega2560]
+platform = atmelavr
+framework = arduino
+board = mega2560
+build_flags = -I $BUILDSRC_DIR
+board_f_cpu = 16000000L
+lib_deps = ${common.lib_deps}
+
+[env:mega1280]
+platform = atmelavr
+framework = arduino
+board = mega1280
+build_flags = -I $BUILDSRC_DIR
+board_f_cpu = 16000000L
+lib_deps = ${common.lib_deps}
+
+[env:printrboard]
+platform = teensy
+framework = arduino
+board = teensy20pp
+build_flags =  -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
+# Bug in arduino framework does not allow boards running at 20Mhz
+#board_f_cpu = 20000000L
+lib_deps = ${common.lib_deps}
+
+[env:brainwavepro]
+platform = teensy
+framework = arduino
+board = teensy20pp
+build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_BRAINWAVE_PRO -D AT90USBxx_TEENSYPP_ASSIGNMENTS
+lib_deps = ${common.lib_deps}
+
+[env:rambo]
+platform = atmelavr
+framework = arduino
+board = reprap_rambo
+build_flags = -I $BUILDSRC_DIR
+board_f_cpu = 16000000L
+lib_deps = ${common.lib_deps}

commit dca48f0e63d9b5ce7ee40799517cc43a1f94e269
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Mon May 8 14:14:11 2017 -0500

    Move platformio.ini back to Marlin folder - it works there

diff --git a/platformio.ini b/platformio.ini
deleted file mode 100644
index 2cc47133b6..0000000000
--- a/platformio.ini
+++ /dev/null
@@ -1,62 +0,0 @@
-#
-# Project Configuration File
-#
-# A detailed documentation with the EXAMPLES is located here:
-# http://docs.platformio.org/en/latest/projectconf.html
-#
-
-# A sign `#` at the beginning of the line indicates a comment
-# Comment lines are ignored.
-
-# Automatic targets - enable auto-uploading
-# targets = upload
-
-[platformio]
-src_dir = Marlin
-envs_dir = .pioenvs
-lib_dir = .piolib
-libdeps_dir = .piolibdeps
-env_default = mega2560
-
-[common]
-lib_deps = U8glib@1.19.1
-
-[env:mega2560]
-platform = atmelavr
-framework = arduino
-board = megaatmega2560
-build_flags = -I $BUILDSRC_DIR
-board_f_cpu = 16000000L
-lib_deps = ${common.lib_deps}
-
-[env:mega1280]
-platform = atmelavr
-framework = arduino
-board = megaatmega1280
-build_flags = -I $BUILDSRC_DIR
-board_f_cpu = 16000000L
-lib_deps = ${common.lib_deps}
-
-[env:printrboard]
-platform = teensy
-framework = arduino
-board = teensy20pp
-build_flags =  -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
-# Bug in arduino framework does not allow boards running at 20Mhz
-#board_f_cpu = 20000000L
-lib_deps = ${common.lib_deps}
-
-[env:brainwavepro]
-platform = teensy
-framework = arduino
-board = teensy20pp
-build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_BRAINWAVE_PRO -D AT90USBxx_TEENSYPP_ASSIGNMENTS
-lib_deps = ${common.lib_deps}
-
-[env:rambo]
-platform = atmelavr
-framework = arduino
-board = reprap_rambo
-build_flags = -I $BUILDSRC_DIR
-board_f_cpu = 16000000L
-lib_deps = ${common.lib_deps}

commit 0446dd3ad8d95eae7e2042dae8ee43f29150869e
Author: Brian <bgort@users.noreply.github.com>
Date:   Sat May 6 06:17:07 2017 -0400

    PlatformIO-related changes
    - move platformio.ini out of source directory to be more consistent with 'normal' PlatformIO usage
      - facilitates IDE integration
    - add related .gitignores

diff --git a/platformio.ini b/platformio.ini
new file mode 100644
index 0000000000..2cc47133b6
--- /dev/null
+++ b/platformio.ini
@@ -0,0 +1,62 @@
+#
+# Project Configuration File
+#
+# A detailed documentation with the EXAMPLES is located here:
+# http://docs.platformio.org/en/latest/projectconf.html
+#
+
+# A sign `#` at the beginning of the line indicates a comment
+# Comment lines are ignored.
+
+# Automatic targets - enable auto-uploading
+# targets = upload
+
+[platformio]
+src_dir = Marlin
+envs_dir = .pioenvs
+lib_dir = .piolib
+libdeps_dir = .piolibdeps
+env_default = mega2560
+
+[common]
+lib_deps = U8glib@1.19.1
+
+[env:mega2560]
+platform = atmelavr
+framework = arduino
+board = megaatmega2560
+build_flags = -I $BUILDSRC_DIR
+board_f_cpu = 16000000L
+lib_deps = ${common.lib_deps}
+
+[env:mega1280]
+platform = atmelavr
+framework = arduino
+board = megaatmega1280
+build_flags = -I $BUILDSRC_DIR
+board_f_cpu = 16000000L
+lib_deps = ${common.lib_deps}
+
+[env:printrboard]
+platform = teensy
+framework = arduino
+board = teensy20pp
+build_flags =  -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_PRINTRBOARD
+# Bug in arduino framework does not allow boards running at 20Mhz
+#board_f_cpu = 20000000L
+lib_deps = ${common.lib_deps}
+
+[env:brainwavepro]
+platform = teensy
+framework = arduino
+board = teensy20pp
+build_flags = -I $BUILDSRC_DIR -D MOTHERBOARD=BOARD_BRAINWAVE_PRO -D AT90USBxx_TEENSYPP_ASSIGNMENTS
+lib_deps = ${common.lib_deps}
+
+[env:rambo]
+platform = atmelavr
+framework = arduino
+board = reprap_rambo
+build_flags = -I $BUILDSRC_DIR
+board_f_cpu = 16000000L
+lib_deps = ${common.lib_deps}
