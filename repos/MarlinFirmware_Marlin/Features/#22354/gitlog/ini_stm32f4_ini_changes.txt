commit 30a70c480c8d3fddb8cedc83a06370edefbd8820
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Mon Jul 15 05:57:17 2024 +1200

    ‚ú® XTLW boards (#27260)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 9c6f751746..263dd65207 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -882,10 +882,27 @@ board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 build_flags                 = ${stm32_variant.build_flags}
                               -DHAVE_HWSERIAL1 -DHAVE_HWSERIAL3
                               -DPIN_SERIAL1_RX=PA_10 -DPIN_SERIAL1_TX=PA_9
                               -DPIN_SERIAL3_RX=PD_9 -DPIN_SERIAL3_TX=PD_8
                               -DHAL_SD_MODULE_ENABLED
                               -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS
                               -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                               -DHSE_VALUE=8000000U
 upload_protocol             = stlink
+
+#
+# XTLW3D Climber-8th-F4 (STM32F407VGT6 ARM Cortex-M4)
+#
+[env:XTLW_CLIMBER_8TH]
+platform                    = ${common_stm32.platform}
+extends                     = stm32_variant
+platform_packages           = ${stm_flash_drive.platform_packages}
+board                       = marlin_STM32F407VGT6_CCM
+board_build.variant         = MARLIN_F4x7Vx
+board_build.offset          = 0x8000
+board_upload.offset_address = 0x08008000
+build_flags                 = ${stm_flash_drive.build_flags}
+                              -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS
+                              -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
+                              -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
+                              -DPIN_SERIAL3_RX=PD_9 -DPIN_SERIAL3_TX=PD_8

commit 3b4adac579f42683fbbd9099b89f33801c190145
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sat Mar 16 13:55:35 2024 -0500

    üé® Trailing ws

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index fb8e9109cf..9c6f751746 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -813,21 +813,21 @@ upload_command              = dfu-util -a 0 -s 0x08000000:leave -D "$SOURCE"
 
 #
 # TRONXY_CXY_446_V10 (STM32F446ZET6 ARM Cortex-M4)
 #
 [env:TRONXY_CXY_446_V10]
 extends              = stm32_variant
 board                = marlin_STM32F446ZET_tronxy
 board_build.ldscript = buildroot/share/PlatformIO/variants/MARLIN_F446Zx_TRONXY/ldscript.ld
 board_build.offset   = 0x10000
 board_build.rename   = fmw_tronxy.bin
-build_flags          = ${stm32_variant.build_flags} 
+build_flags          = ${stm32_variant.build_flags}
                        -DSTM32F4xx -DUSE_USB_HS
                        -DUSE_USB_HS_IN_FS
 build_unflags        = ${stm32_variant.build_unflags} -fno-rtti
                        -fno-threadsafe-statics -fno-exceptions
                        -DUSBD_USE_CDC -DUSBCON
 extra_scripts        = ${stm32_variant.extra_scripts}
                        buildroot/share/PlatformIO/scripts/tronxy_cxy_446_v10.py
 
 #
 # TRONXY_CXY_446_V10 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support

commit 9364cbb4b53a5ef77cf2b843ba228afffb4c1725
Author: Smokey Pell <brentpell81@gmail.com>
Date:   Sun Feb 4 09:37:32 2024 -0600

    üö∏ Tronxy V10 w/ TFT_TRONXY_X5SA + MKS_ROBIN_TFT43 (#26747)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 2ba5742f4f..fb8e9109cf 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -805,31 +805,43 @@ board_build.rename          = mks_skipr.bin
 
 [env:mks_skipr_v1_nobootloader]
 extends                     = env:mks_skipr_v1
 board_build.rename          = firmware.bin
 board_build.offset          = 0x0000
 board_upload.offset_address = 0x08000000
 upload_protocol             = dfu
 upload_command              = dfu-util -a 0 -s 0x08000000:leave -D "$SOURCE"
 
 #
-# STM32F446ZET6 ARM Cortex-M4
-#
-[env:STM32F446_tronxy]
-extends                     = stm32_variant
-board                       = marlin_STM32F446ZET_tronxy
-board_build.offset          = 0x10000
-board_build.rename          = fmw_tronxy.bin
-build_flags                 = ${stm32_variant.build_flags}
-                              -DSTM32F4xx
-build_unflags               = ${stm32_variant.build_unflags} -fno-rtti
-                              -DUSBCON -DUSBD_USE_CDC
+# TRONXY_CXY_446_V10 (STM32F446ZET6 ARM Cortex-M4)
+#
+[env:TRONXY_CXY_446_V10]
+extends              = stm32_variant
+board                = marlin_STM32F446ZET_tronxy
+board_build.ldscript = buildroot/share/PlatformIO/variants/MARLIN_F446Zx_TRONXY/ldscript.ld
+board_build.offset   = 0x10000
+board_build.rename   = fmw_tronxy.bin
+build_flags          = ${stm32_variant.build_flags} 
+                       -DSTM32F4xx -DUSE_USB_HS
+                       -DUSE_USB_HS_IN_FS
+build_unflags        = ${stm32_variant.build_unflags} -fno-rtti
+                       -fno-threadsafe-statics -fno-exceptions
+                       -DUSBD_USE_CDC -DUSBCON
+extra_scripts        = ${stm32_variant.extra_scripts}
+                       buildroot/share/PlatformIO/scripts/tronxy_cxy_446_v10.py
+
+#
+# TRONXY_CXY_446_V10 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
+#
+[env:TRONXY_CXY_446_V10_usb_flash_drive]
+extends           = env:TRONXY_CXY_446_V10
+platform_packages = ${stm_flash_drive.platform_packages}
 
 #
 # Blackpill
 #
 [env:STM32F401CD_blackpill_stlink]
 platform        = ${common_stm32.platform}
 extends         = common_stm32
 board           = blackpill_f401cc
 upload_protocol = stlink
 monitor_speed   = 115200

commit e668d5afd75039fbbbc9a3a8c8357c74c399ccb7
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Thu Jan 25 07:50:48 2024 +1300

    üîß STM32 UID followup (#26727)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index de0a5c7d37..2ba5742f4f 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -104,32 +104,32 @@ build_flags       = ${stm32_variant.build_flags}
                     -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 
 #
 # STM32F407VET6 Opulo Lumen REV3
 #
 [env:Opulo_Lumen_REV3]
 extends           = stm32_variant
 board             = marlin_opulo_lumen_rev3
 build_flags       = ${stm32_variant.build_flags}
   -DARDUINO_BLACK_F407VE
-  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS -DHAS_STM32_UID
 extra_scripts     = ${stm32_variant.extra_scripts}
 
 #
 # STM32F407VET6 Opulo Lumen REV4
 #
 [env:Opulo_Lumen_REV4]
 extends           = stm32_variant
 board             = marlin_opulo_lumen_rev4
 build_flags       = ${stm32_variant.build_flags}
   -DARDUINO_BLACK_F407VE
-  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS -DHAS_STM32_UID
 extra_scripts     = ${stm32_variant.extra_scripts}
 
 #
 # Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
 #
 [Anet_ET4]
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 build_flags                 = ${stm32_variant.build_flags}

commit 18b0dbb5018dafbb298d043e15b0623c3f0f72b3
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Mon Dec 25 07:07:00 2023 +1300

    üêõ Creality Free Runs fixups (#26562)
    
    Followup to #25636, #26533
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 3f33471943..de0a5c7d37 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -735,31 +735,28 @@ upload_protocol = jlink
 [env:STM32F401RE_creality_stlink]
 extends         = env:STM32F401RE_creality
 debug_tool      = stlink
 upload_protocol = stlink
 
 #
 # STM32F401RE_freeruns  Creality E3 Free-runs Silent Motherboard
 #
 [env:STM32F401RE_freeruns]
 extends                     = stm32_variant
-board                       = genericSTM32F401RE
-board_build.variant         = marlin_STM32F401RE_freeruns
+board                       = marlin_STM32F401RE_freeruns
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
 board_build.rename          = firmware-{date}-{time}.bin
-build_flags                 = ${stm32_variant.build_flags} -DMCU_STM32F401RE -DSTM32F4
+build_flags                 = ${stm32_variant.build_flags} -DSTM32F401xE
                               -DSS_TIMER=4 -DTIMER_SERVO=TIM5
                               -DTRANSFER_CLOCK_DIV=8
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
-extra_scripts               = ${stm32_variant.extra_scripts}
-                              pre:buildroot/share/PlatformIO/scripts/random-bin.py
 monitor_speed               = 115200
 
 [env:STM32F401RE_freeruns_jlink]
 extends                     = env:STM32F401RE_freeruns
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 [env:STM32F401RE_freeruns_stlink]
 extends                     = env:STM32F401RE_freeruns
 debug_tool                  = stlink

commit 4a89ef6273c6b0fafd3132900863e5a1f332b579
Author: geijt <3473304+geijt@users.noreply.github.com>
Date:   Sun Dec 17 23:33:46 2023 +0100

    Fix Creality E3 "Free-runs" (#26533)
    
    Followup to #25636

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 84d26553e0..3f33471943 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -739,23 +739,24 @@ upload_protocol = stlink
 
 #
 # STM32F401RE_freeruns  Creality E3 Free-runs Silent Motherboard
 #
 [env:STM32F401RE_freeruns]
 extends                     = stm32_variant
 board                       = genericSTM32F401RE
 board_build.variant         = marlin_STM32F401RE_freeruns
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
+board_build.rename          = firmware-{date}-{time}.bin
 build_flags                 = ${stm32_variant.build_flags} -DMCU_STM32F401RE -DSTM32F4
                               -DSS_TIMER=4 -DTIMER_SERVO=TIM5
-                              -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
+                              -DTRANSFER_CLOCK_DIV=8
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
 extra_scripts               = ${stm32_variant.extra_scripts}
                               pre:buildroot/share/PlatformIO/scripts/random-bin.py
 monitor_speed               = 115200
 
 [env:STM32F401RE_freeruns_jlink]
 extends                     = env:STM32F401RE_freeruns
 debug_tool                  = jlink
 upload_protocol             = jlink
 

commit 7ab63cde62e35aa80f1c6fd65f35cb0bdc200b1d
Author: Bob Kuhn <bob.kuhn@att.net>
Date:   Thu Dec 14 17:37:40 2023 -0600

    ‚ú® Creality E3 Free-runs Silent Motherboard (#25636)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 60ccee94d8..84d26553e0 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -730,20 +730,47 @@ monitor_speed               = 115200
 [env:STM32F401RE_creality_jlink]
 extends         = env:STM32F401RE_creality
 debug_tool      = jlink
 upload_protocol = jlink
 
 [env:STM32F401RE_creality_stlink]
 extends         = env:STM32F401RE_creality
 debug_tool      = stlink
 upload_protocol = stlink
 
+#
+# STM32F401RE_freeruns  Creality E3 Free-runs Silent Motherboard
+#
+[env:STM32F401RE_freeruns]
+extends                     = stm32_variant
+board                       = genericSTM32F401RE
+board_build.variant         = marlin_STM32F401RE_freeruns
+board_build.offset          = 0x10000
+board_upload.offset_address = 0x08010000
+build_flags                 = ${stm32_variant.build_flags} -DMCU_STM32F401RE -DSTM32F4
+                              -DSS_TIMER=4 -DTIMER_SERVO=TIM5
+                              -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
+build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
+extra_scripts               = ${stm32_variant.extra_scripts}
+                              pre:buildroot/share/PlatformIO/scripts/random-bin.py
+monitor_speed               = 115200
+
+[env:STM32F401RE_freeruns_jlink]
+extends                     = env:STM32F401RE_freeruns
+debug_tool                  = jlink
+upload_protocol             = jlink
+
+[env:STM32F401RE_freeruns_stlink]
+extends                     = env:STM32F401RE_freeruns
+debug_tool                  = stlink
+upload_protocol             = stlink
+
 #
 # BigTree SKR mini E3 V3.0.1 (STM32F401RCT6 ARM Cortex-M4)
 #
 [env:STM32F401RC_btt]
 extends                     = stm32_variant
 platform                    = ststm32@~14.1.0
 platform_packages           = framework-arduinoststm32@~4.20600.231001
                               toolchain-gccarmnoneeabi@1.100301.220327
 board                       = marlin_STM32F401RC
 board_build.offset          = 0x4000

commit fe7203ee5533ecb0436a301aea46bedeff311624
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Thu Dec 7 20:35:34 2023 -0800

    üî® Use PIO versioning (including HC32) (#26512)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 0ba6b66c3f..60ccee94d8 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -736,21 +736,21 @@ upload_protocol = jlink
 extends         = env:STM32F401RE_creality
 debug_tool      = stlink
 upload_protocol = stlink
 
 #
 # BigTree SKR mini E3 V3.0.1 (STM32F401RCT6 ARM Cortex-M4)
 #
 [env:STM32F401RC_btt]
 extends                     = stm32_variant
 platform                    = ststm32@~14.1.0
-platform_packages           = framework-arduinoststm32@https://github.com/stm32duino/Arduino_Core_STM32/archive/2.6.0.zip
+platform_packages           = framework-arduinoststm32@~4.20600.231001
                               toolchain-gccarmnoneeabi@1.100301.220327
 board                       = marlin_STM32F401RC
 board_build.offset          = 0x4000
 board_upload.offset_address = 0x08004000
 build_flags                 = ${stm32_variant.build_flags}
                               -DPIN_SERIAL6_RX=PC_7 -DPIN_SERIAL6_TX=PC_6
                               -DSERIAL_RX_BUFFER_SIZE=1024 -DSERIAL_TX_BUFFER_SIZE=1024
                               -DTIMER_SERVO=TIM3 -DTIMER_TONE=TIM4
                               -DSTEP_TIMER_IRQ_PRIO=0
 upload_protocol             = stlink

commit 7a96a082b70deeed8648f7c1bebe21a3a0aaab56
Author: I3DBeeTech <129617321+I3DBeeTech@users.noreply.github.com>
Date:   Tue Nov 28 12:13:17 2023 +0530

    ‚ú® BlackBeezMini 3D by I3DBEE (#26406)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>
    Co-authored-by: thisiskeithb <13375512+thisiskeithb@users.noreply.github.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index f094b96c9b..0ba6b66c3f 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -813,20 +813,34 @@ monitor_speed   = 115200
 # I3Dbeez9 (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:I3DBEEZ9_V1]
 extends            = stm32_variant
 board              = marlin_I3DBEEZ9
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags} -DSTM32F407_5ZX
 debug_tool         = stlink
 upload_protocol    = stlink
 
+#
+# BlackBeezMini (blackpill_f401cc)
+#
+[env:BLACKBEEZMINI_V1]
+platform           = ststm32
+extends            = common_stm32
+board              = blackpill_f401cc
+board_build.offset = 0x0000
+build_flags        = ${common_stm32.build_flags}
+                     -Os -DHAL_PCD_MODULE_ENABLED
+                     -DHAL_UART_MODULE_ENABLED
+monitor_speed      = 250000
+upload_protocol    = dfu
+
 #
 # Mellow Fly E3 V2 (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:FLY_E3_V2]
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 build_flags                 = ${stm32_variant.build_flags}

commit 3d3be15665d8140574a1dbd665fd0807e7b234c0
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon Nov 20 02:18:53 2023 -0600

    üî® Fix Ender-5 S1 env

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 5582a6349a..f094b96c9b 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -726,21 +726,21 @@ board_build.rename          = firmware-{date}-{time}.bin
 build_flags                 = ${stm32_variant.build_flags} -DSTM32F401xE -DSTM32F4 -DSTM32F4_UPDATE_FOLDER
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
 monitor_speed               = 115200
 
 [env:STM32F401RE_creality_jlink]
 extends         = env:STM32F401RE_creality
 debug_tool      = jlink
 upload_protocol = jlink
 
 [env:STM32F401RE_creality_stlink]
-extends         = env:STM32F401RC_creality
+extends         = env:STM32F401RE_creality
 debug_tool      = stlink
 upload_protocol = stlink
 
 #
 # BigTree SKR mini E3 V3.0.1 (STM32F401RCT6 ARM Cortex-M4)
 #
 [env:STM32F401RC_btt]
 extends                     = stm32_variant
 platform                    = ststm32@~14.1.0
 platform_packages           = framework-arduinoststm32@https://github.com/stm32duino/Arduino_Core_STM32/archive/2.6.0.zip

commit 19869d3a7db80b875e8d3706d3bbf1c62d3d1cb1
Author: EvilGremlin <22657714+EvilGremlin@users.noreply.github.com>
Date:   Fri Nov 17 04:57:00 2023 +0300

    üî® Creality STM32F401RC w/out bootloader (#26373)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 99b2685787..5582a6349a 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -674,33 +674,43 @@ build_flags   = ${common_stm32.build_flags}
                 -DSTM32F401xC -DTARGET_STM32F4 -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32
                 -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
                 -DUSB_PRODUCT=\"Artillery_3D_Printer\"
                 -DFLASH_DATA_SECTOR=1U -DFLASH_BASE_ADDRESS=0x08004000
 extra_scripts = ${common_stm32.extra_scripts}
                 pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
 # Ender-3 S1 STM32F401RC_creality
 #
-[env:STM32F401RC_creality]
+[STM32F401RC_creality_base]
 extends                     = stm32_variant
 board                       = genericSTM32F401RC
 board_build.variant         = MARLIN_CREALITY_STM32F401RC
-board_build.offset          = 0x10000
-board_upload.offset_address = 0x08010000
-board_build.rename          = firmware-{date}-{time}.bin
 build_flags                 = ${stm32_variant.build_flags} -DMCU_STM32F401RC -DSTM32F4
                               -DSS_TIMER=4 -DTIMER_SERVO=TIM5
                               -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
 monitor_speed               = 115200
 
+[env:STM32F401RC_creality]
+extends                     = STM32F401RC_creality_base
+board_build.offset          = 0x10000
+board_upload.offset_address = 0x08010000
+board_build.rename          = firmware-{date}-{time}.bin
+
+[env:STM32F401RC_creality_nobootloader]
+extends                     = STM32F401RC_creality_base
+board_build.offset          = 0x0000
+board_upload.offset_address = 0x08000000
+debug_tool                  = stlink
+upload_protocol             = stlink
+
 [env:STM32F401RC_creality_jlink]
 extends         = env:STM32F401RC_creality
 debug_tool      = jlink
 upload_protocol = jlink
 
 [env:STM32F401RC_creality_stlink]
 extends         = env:STM32F401RC_creality
 debug_tool      = stlink
 upload_protocol = stlink
 

commit d159ec5c903413e1909b4ce260f9add2ade28e6a
Author: Vladimir Sitnikov <sitnikov.vladimir@gmail.com>
Date:   Sun Nov 12 05:13:23 2023 +0300

    üî® Specific package versions (#26265)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index b8e989642c..99b2685787 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -726,21 +726,21 @@ upload_protocol = jlink
 extends         = env:STM32F401RC_creality
 debug_tool      = stlink
 upload_protocol = stlink
 
 #
 # BigTree SKR mini E3 V3.0.1 (STM32F401RCT6 ARM Cortex-M4)
 #
 [env:STM32F401RC_btt]
 extends                     = stm32_variant
 platform                    = ststm32@~14.1.0
-platform_packages           = framework-arduinoststm32@https://github.com/stm32duino/Arduino_Core_STM32/archive/main.zip
+platform_packages           = framework-arduinoststm32@https://github.com/stm32duino/Arduino_Core_STM32/archive/2.6.0.zip
                               toolchain-gccarmnoneeabi@1.100301.220327
 board                       = marlin_STM32F401RC
 board_build.offset          = 0x4000
 board_upload.offset_address = 0x08004000
 build_flags                 = ${stm32_variant.build_flags}
                               -DPIN_SERIAL6_RX=PC_7 -DPIN_SERIAL6_TX=PC_6
                               -DSERIAL_RX_BUFFER_SIZE=1024 -DSERIAL_TX_BUFFER_SIZE=1024
                               -DTIMER_SERVO=TIM3 -DTIMER_TONE=TIM4
                               -DSTEP_TIMER_IRQ_PRIO=0
 upload_protocol             = stlink

commit c345087b415e73e2a405c0088bd1f1e02ea6dd6a
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Sun Oct 22 13:46:34 2023 -0700

    üî® Add MKS Eagle FD Envs (#26346)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 20009c8943..b8e989642c 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -473,59 +473,55 @@ board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000
 board_build.rename          = Robin_nano_v3.bin
 build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1.build_flags}
                               -DHAL_PCD_MODULE_ENABLED
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support
-# Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive]
 extends           = env:mks_robin_nano_v3
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
                     -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSE_USB_HS_IN_FS
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
-# Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive_msc]
 extends           = env:mks_robin_nano_v3_usb_flash_drive
 build_flags       = ${env:mks_robin_nano_v3_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
 # MKS Robin Nano V3_1
 #
 [env:mks_robin_nano_v3_1]
 extends           = env:mks_robin_nano_v3
 board             = marlin_STM32F407VET6_CCM
 
 #
 # MKS Robin Nano V3.1 with USB Flash Drive Support
-# Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_robin_nano_v3_1_usb_flash_drive]
 extends           = env:mks_robin_nano_v3_usb_flash_drive
 board             = marlin_STM32F407VET6_CCM
 
 #
 # MKS Robin Nano V3.1 with USB Flash Drive Support and Shared Media
-# Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_robin_nano_v3_1_usb_flash_drive_msc]
 extends           = env:mks_robin_nano_v3_usb_flash_drive_msc
 board             = marlin_STM32F407VET6_CCM
 
 #
 # MKS Eagle
 # 5 TMC2209 uart mode on board
 #
 [env:mks_eagle]
@@ -536,34 +532,32 @@ board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000
 board_build.rename          = mks_eagle.bin
 build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1.build_flags}
                               -DHAL_PCD_MODULE_ENABLED
                               -DSTM32_FLASH_SIZE=512
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # MKS Eagle with USB Flash Drive Support
-# Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_eagle_usb_flash_drive]
 extends           = env:mks_eagle
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
                     -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSE_USB_HS_IN_FS
 
 #
 # MKS Eagle with USB Flash Drive Support and Shared Media
-# Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_eagle_usb_flash_drive_msc]
 extends           = env:mks_eagle_usb_flash_drive
 build_flags       = ${env:mks_eagle_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
 # This I2C1(PB8:I2C1_SCL PB9:I2C1_SDA) is used by MKS Monster8
 #
@@ -581,34 +575,32 @@ board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000
 board_build.rename          = mks_monster8.bin
 build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1_CAN.build_flags}
                               -DHAL_PCD_MODULE_ENABLED -DTIMER_SERIAL=TIM4
                               -DSTM32_FLASH_SIZE=512
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # MKS Monster8 V1 / V2 (STM32F407VET6 ARM Cortex-M4) with USB Flash Drive Support
-# Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_monster8_usb_flash_drive]
 extends           = env:mks_monster8
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1_CAN.build_flags}
                     -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSE_USB_HS_IN_FS
 
 #
 # MKS Monster8 V1 / V2 (STM32F407VET6 ARM Cortex-M4) with USB Flash Drive Support and Shared Media
-# Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_monster8_usb_flash_drive_msc]
 extends           = env:mks_monster8_usb_flash_drive
 build_flags       = ${env:mks_monster8_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
 # TH3D EZBoard v2.0 (STM32F405RGT6 ARM Cortex-M4)
 #

commit e97d82f77beadf7001e569dc7e683ba287afa56e
Author: Marcella Cavalcanti <marcellabcavalcanti@gmail.com>
Date:   Mon Oct 9 22:52:59 2023 +0100

    ‚ú® FYSETC Cheetah v3.0 (#26314)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 454337295d..20009c8943 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -31,20 +31,31 @@ build_flags   = ${common_stm32.build_flags}
 #
 # STM32F401RC
 #
 [env:FYSETC_CHEETAH_V20]
 extends            = stm32_variant
 board              = marlin_FYSETC_CHEETAH_V20
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags} -DSTM32F401xC
 upload_command     = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 
+#
+# STM32F446RC nobootloader
+#
+[env:FYSETC_CHEETAH_V30]
+extends            = stm32_variant
+board              = marlin_FYSETC_CHEETAH_V30
+build_flags        = ${stm32_variant.build_flags} -DHAL_PCD_MODULE_ENABLED
+debug_tool         = stlink
+upload_protocol    = dfu
+upload_command     = dfu-util -a 0 -s 0x08000000:leave -D "$SOURCE"
+
 #
 # FLYF407ZG
 #
 [env:FLYF407ZG]
 extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_FLY_F407ZG
 board_build.offset  = 0x8000
 upload_protocol     = dfu
 

commit 209fadd2e6039e050e33eaed9c59465ffa5c30f0
Author: jaysuk <github@jayuk.org>
Date:   Sat Aug 26 00:43:57 2023 +0100

    ‚ú® Mellow Fly E3 V2 (STM32F407VG) (#26081)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index bb594b97f9..454337295d 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -799,10 +799,29 @@ monitor_speed   = 115200
 #
 # I3Dbeez9 (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:I3DBEEZ9_V1]
 extends            = stm32_variant
 board              = marlin_I3DBEEZ9
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags} -DSTM32F407_5ZX
 debug_tool         = stlink
 upload_protocol    = stlink
+
+#
+# Mellow Fly E3 V2 (STM32F407VGT6 ARM Cortex-M4)
+#
+[env:FLY_E3_V2]
+extends                     = stm32_variant
+board                       = marlin_STM32F407VGT6_CCM
+board_build.variant         = MARLIN_F4x7Vx
+board_build.offset          = 0x8000
+board_upload.offset_address = 0x08008000
+build_flags                 = ${stm32_variant.build_flags}
+                              -DHAVE_HWSERIAL1 -DHAVE_HWSERIAL3
+                              -DPIN_SERIAL1_RX=PA_10 -DPIN_SERIAL1_TX=PA_9
+                              -DPIN_SERIAL3_RX=PD_9 -DPIN_SERIAL3_TX=PD_8
+                              -DHAL_SD_MODULE_ENABLED
+                              -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS
+                              -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
+                              -DHSE_VALUE=8000000U
+upload_protocol             = stlink

commit ca0209b868be80d1438e1d695e2f103ab1025f92
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Mon Aug 7 14:00:50 2023 -0700

    üî® Fix USB FD env names (#26131)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 8708a6dbca..bb594b97f9 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -276,21 +276,21 @@ board                       = marlin_BigTree_Octopus_v1
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 debug_tool                  = stlink
 upload_protocol             = stlink
 build_flags                 = ${stm32_variant.build_flags}
                               -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus V1.0/1.1 / Octopus Pro V1.0 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
-[env:STM32F446ZE_btt_USB]
+[env:STM32F446ZE_btt_usb_flash_drive]
 extends           = env:STM32F446ZE_btt
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
                     -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
@@ -302,21 +302,21 @@ board                       = marlin_BigTree_Octopus_Pro_v1_F429
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 debug_tool                  = stlink
 upload_protocol             = stlink
 build_flags                 = ${stm32_variant.build_flags}
                               -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus V1.1 / Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
-[env:STM32F429ZG_btt_USB]
+[env:STM32F429ZG_btt_usb_flash_drive]
 extends           = env:STM32F429ZG_btt
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DUSE_USB_HS_IN_FS -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
 # BigTreeTech Octopus / Octopus Pro (STM32F407ZET6 ARM Cortex-M4)
@@ -324,21 +324,21 @@ build_flags       = ${stm_flash_drive.build_flags}
 [env:STM32F407ZE_btt]
 extends            = stm32_variant
 board              = marlin_STM32F407ZE
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags}
                      -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus / Octopus Pro (STM32F407ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
-[env:STM32F407ZE_btt_USB]
+[env:STM32F407ZE_btt_usb_flash_drive]
 extends           = env:STM32F407ZE_btt
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DUSE_USB_HS_IN_FS -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
 # Lerdge base

commit bea1a914bee6caf6ff63a4c0ab65a2b7ddea9de8
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Sun Jun 11 14:49:37 2023 -0700

    üî® SKR Mini E3 v3.0.1 XFER (#25955)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 7efb31107b..8708a6dbca 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -736,20 +736,34 @@ board                       = marlin_STM32F401RC
 board_build.offset          = 0x4000
 board_upload.offset_address = 0x08004000
 build_flags                 = ${stm32_variant.build_flags}
                               -DPIN_SERIAL6_RX=PC_7 -DPIN_SERIAL6_TX=PC_6
                               -DSERIAL_RX_BUFFER_SIZE=1024 -DSERIAL_TX_BUFFER_SIZE=1024
                               -DTIMER_SERVO=TIM3 -DTIMER_TONE=TIM4
                               -DSTEP_TIMER_IRQ_PRIO=0
 upload_protocol             = stlink
 debug_tool                  = stlink
 
+#
+# BigTreeTech SKR Mini E3 V3.0.1 (STM32F401RCT6 ARM Cortex-M0+)
+# Custom upload to SD via Marlin with Binary Protocol
+# Requires Marlin with BINARY_FILE_TRANSFER already installed on the target board.
+# If CUSTOM_FIRMWARE_UPLOAD is also installed, Marlin will reboot the board to install the firmware.
+# Currently CUSTOM_FIRMWARE_UPLOAD must also be enabled to use 'xfer' build envs.
+#
+[env:STM32F401RC_btt_xfer]
+extends         = env:STM32F401RC_btt
+build_flags     = ${env:STM32F401RC_btt.build_flags} -DXFER_BUILD
+extra_scripts   = ${env:STM32F401RC_btt.extra_scripts}
+                  pre:buildroot/share/scripts/upload.py
+upload_protocol = custom
+
 #
 # MKS SKIPR v1.0 all-in-one board (STM32F407VE)
 #
 [env:mks_skipr_v1]
 extends                     = stm32_variant
 board                       = marlin_MKS_SKIPR_V1
 board_build.rename          = mks_skipr.bin
 
 [env:mks_skipr_v1_nobootloader]
 extends                     = env:mks_skipr_v1

commit 00ab015de7b728082196c203626dd215dc8427d3
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Sat Jun 10 17:20:50 2023 -0700

    üî® Firmware rename followup (#25966)
    
    Followup to #25957

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 67c2c6033c..7efb31107b 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -677,21 +677,21 @@ extra_scripts = ${common_stm32.extra_scripts}
 
 #
 # Ender-3 S1 STM32F401RC_creality
 #
 [env:STM32F401RC_creality]
 extends                     = stm32_variant
 board                       = genericSTM32F401RC
 board_build.variant         = MARLIN_CREALITY_STM32F401RC
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
-board_build.rename          = firmware-{date}-{time}
+board_build.rename          = firmware-{date}-{time}.bin
 build_flags                 = ${stm32_variant.build_flags} -DMCU_STM32F401RC -DSTM32F4
                               -DSS_TIMER=4 -DTIMER_SERVO=TIM5
                               -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
 monitor_speed               = 115200
 
 [env:STM32F401RC_creality_jlink]
 extends         = env:STM32F401RC_creality
 debug_tool      = jlink
 upload_protocol = jlink
@@ -702,21 +702,21 @@ debug_tool      = stlink
 upload_protocol = stlink
 
 #
 # Ender-5 S1 STM32F401RE_creality (CR4NS200141C13 with STM32F401RET6)
 #
 [env:STM32F401RE_creality]
 extends                     = stm32_variant
 board                       = marlin_CREALITY_STM32F401RE
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
-board_build.rename          = firmware-{date}-{time}
+board_build.rename          = firmware-{date}-{time}.bin
 build_flags                 = ${stm32_variant.build_flags} -DSTM32F401xE -DSTM32F4 -DSTM32F4_UPDATE_FOLDER
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
 monitor_speed               = 115200
 
 [env:STM32F401RE_creality_jlink]
 extends         = env:STM32F401RE_creality
 debug_tool      = jlink
 upload_protocol = jlink
 
 [env:STM32F401RE_creality_stlink]

commit 0ed46406d1d4b4280f8458d56b45b7bdab33e113
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Jun 9 02:56:25 2023 -0500

    üî® Simpler distinct firmware rename (#25957)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 34a5c4d607..67c2c6033c 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -677,50 +677,48 @@ extra_scripts = ${common_stm32.extra_scripts}
 
 #
 # Ender-3 S1 STM32F401RC_creality
 #
 [env:STM32F401RC_creality]
 extends                     = stm32_variant
 board                       = genericSTM32F401RC
 board_build.variant         = MARLIN_CREALITY_STM32F401RC
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
+board_build.rename          = firmware-{date}-{time}
 build_flags                 = ${stm32_variant.build_flags} -DMCU_STM32F401RC -DSTM32F4
                               -DSS_TIMER=4 -DTIMER_SERVO=TIM5
                               -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
-extra_scripts               = ${stm32_variant.extra_scripts}
-                              pre:buildroot/share/PlatformIO/scripts/random-bin.py
 monitor_speed               = 115200
 
 [env:STM32F401RC_creality_jlink]
 extends         = env:STM32F401RC_creality
 debug_tool      = jlink
 upload_protocol = jlink
 
 [env:STM32F401RC_creality_stlink]
 extends         = env:STM32F401RC_creality
 debug_tool      = stlink
 upload_protocol = stlink
 
 #
 # Ender-5 S1 STM32F401RE_creality (CR4NS200141C13 with STM32F401RET6)
 #
 [env:STM32F401RE_creality]
 extends                     = stm32_variant
 board                       = marlin_CREALITY_STM32F401RE
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
+board_build.rename          = firmware-{date}-{time}
 build_flags                 = ${stm32_variant.build_flags} -DSTM32F401xE -DSTM32F4 -DSTM32F4_UPDATE_FOLDER
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
-extra_scripts               = ${stm32_variant.extra_scripts}
-                              pre:buildroot/share/PlatformIO/scripts/random-bin.py
 monitor_speed               = 115200
 
 [env:STM32F401RE_creality_jlink]
 extends         = env:STM32F401RE_creality
 debug_tool      = jlink
 upload_protocol = jlink
 
 [env:STM32F401RE_creality_stlink]
 extends         = env:STM32F401RC_creality
 debug_tool      = stlink

commit 317450af3226cc4a1647404cbe31a6ab82cc318e
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Wed May 24 02:53:12 2023 -0500

    üßë‚Äçüíª Updated toolchain for ststm32@~14.1.0 (#25846)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 2889a88863..34a5c4d607 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -726,20 +726,21 @@ extends         = env:STM32F401RC_creality
 debug_tool      = stlink
 upload_protocol = stlink
 
 #
 # BigTree SKR mini E3 V3.0.1 (STM32F401RCT6 ARM Cortex-M4)
 #
 [env:STM32F401RC_btt]
 extends                     = stm32_variant
 platform                    = ststm32@~14.1.0
 platform_packages           = framework-arduinoststm32@https://github.com/stm32duino/Arduino_Core_STM32/archive/main.zip
+                              toolchain-gccarmnoneeabi@1.100301.220327
 board                       = marlin_STM32F401RC
 board_build.offset          = 0x4000
 board_upload.offset_address = 0x08004000
 build_flags                 = ${stm32_variant.build_flags}
                               -DPIN_SERIAL6_RX=PC_7 -DPIN_SERIAL6_TX=PC_6
                               -DSERIAL_RX_BUFFER_SIZE=1024 -DSERIAL_TX_BUFFER_SIZE=1024
                               -DTIMER_SERVO=TIM3 -DTIMER_TONE=TIM4
                               -DSTEP_TIMER_IRQ_PRIO=0
 upload_protocol             = stlink
 debug_tool                  = stlink

commit a886906f01d44e56d249de1f37a11342697b465c
Author: I3DBeeTech <129617321+I3DBeeTech@users.noreply.github.com>
Date:   Thu May 18 13:53:29 2023 +0530

    ‚ú® I3DBEEZ9 board (#25614)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 7dfffe4764..2889a88863 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -775,10 +775,21 @@ build_unflags               = ${stm32_variant.build_unflags} -fno-rtti
 
 #
 # Blackpill
 #
 [env:STM32F401CD_blackpill_stlink]
 platform        = ${common_stm32.platform}
 extends         = common_stm32
 board           = blackpill_f401cc
 upload_protocol = stlink
 monitor_speed   = 115200
+
+#
+# I3Dbeez9 (STM32F407ZGT6 ARM Cortex-M4)
+#
+[env:I3DBEEZ9_V1]
+extends            = stm32_variant
+board              = marlin_I3DBEEZ9
+board_build.offset = 0x8000
+build_flags        = ${stm32_variant.build_flags} -DSTM32F407_5ZX
+debug_tool         = stlink
+upload_protocol    = stlink

commit 8fb9b5804e1ff91c4f5d94493db8924a063b0659
Author: Muhammad Arslan <55940958+arslan437@users.noreply.github.com>
Date:   Thu May 11 18:18:24 2023 +0500

    ‚ú® Blackpill-based custom board (#25152)
    
    Co-authored-by: striker <striker@gmail.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 29c3f5b959..7dfffe4764 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -765,10 +765,20 @@ upload_command              = dfu-util -a 0 -s 0x08000000:leave -D "$SOURCE"
 #
 [env:STM32F446_tronxy]
 extends                     = stm32_variant
 board                       = marlin_STM32F446ZET_tronxy
 board_build.offset          = 0x10000
 board_build.rename          = fmw_tronxy.bin
 build_flags                 = ${stm32_variant.build_flags}
                               -DSTM32F4xx
 build_unflags               = ${stm32_variant.build_unflags} -fno-rtti
                               -DUSBCON -DUSBD_USE_CDC
+
+#
+# Blackpill
+#
+[env:STM32F401CD_blackpill_stlink]
+platform        = ${common_stm32.platform}
+extends         = common_stm32
+board           = blackpill_f401cc
+upload_protocol = stlink
+monitor_speed   = 115200

commit f80e706fad85d6c371bdc7cafafeeed787a790d0
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Mon May 8 23:54:46 2023 +1200

    üî® MKS Robin2 PIO Env (#25792)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index f30b5e539d..29c3f5b959 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -412,21 +412,34 @@ board_build.variant = MARLIN_F446VE
 board_build.offset  = 0x0000
 build_flags         = ${stm32_variant.build_flags}
                       -Os -DHAL_PCD_MODULE_ENABLED
                       -DDISABLE_GENERIC_SERIALUSB
                       -DHAL_UART_MODULE_ENABLED
                       -DTIMER_SERIAL=TIM9
 monitor_speed       = 500000
 upload_protocol     = dfu
 
 #
-# MKS Robin Pro V2
+# STM32F407ZET6 ARM Cortex-M4
+#
+[env:mks_robin2]
+extends                     = stm32_variant
+board                       = marlin_MKS_ROBIN2
+board_build.offset          = 0xC000
+board_upload.offset_address = 0x0800C000
+board_build.encrypt_mks     = Robin2.bin
+build_flags                 = ${stm32_variant.build_flags}
+                              -DTARGET_STM32F4 -DSTM32F407_5ZX
+                              -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483 -DUSBD_PID=0x3748 -DUSB_PRODUCT=\"MKS_Robin2\"
+
+#
+# MKS Robin Pro V2 (No bootloader!)
 #
 [env:mks_robin_pro2]
 extends                     = stm32_variant
 platform_packages           = ${stm_flash_drive.platform_packages}
 board                       = genericSTM32F407VET6
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x0000
 board_upload.offset_address = 0x08000000
 build_flags                 = ${stm_flash_drive.build_flags}
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC

commit e1f6435d4410478930ef5fb7d99a311332f3cee8
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue May 2 17:59:27 2023 -0500

    ‚ú® Creality STM32F401RE board (e.g., Ender-5 S1) (#25773)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 7060f95db7..f30b5e539d 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -673,28 +673,52 @@ board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
 build_flags                 = ${stm32_variant.build_flags} -DMCU_STM32F401RC -DSTM32F4
                               -DSS_TIMER=4 -DTIMER_SERVO=TIM5
                               -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
 extra_scripts               = ${stm32_variant.extra_scripts}
                               pre:buildroot/share/PlatformIO/scripts/random-bin.py
 monitor_speed               = 115200
 
 [env:STM32F401RC_creality_jlink]
-extends                     = env:STM32F401RC_creality
-debug_tool                  = jlink
-upload_protocol             = jlink
+extends         = env:STM32F401RC_creality
+debug_tool      = jlink
+upload_protocol = jlink
 
 [env:STM32F401RC_creality_stlink]
-extends                     = env:STM32F401RC_creality
-debug_tool                  = stlink
-upload_protocol             = stlink
+extends         = env:STM32F401RC_creality
+debug_tool      = stlink
+upload_protocol = stlink
+
+#
+# Ender-5 S1 STM32F401RE_creality (CR4NS200141C13 with STM32F401RET6)
+#
+[env:STM32F401RE_creality]
+extends                     = stm32_variant
+board                       = marlin_CREALITY_STM32F401RE
+board_build.offset          = 0x10000
+board_upload.offset_address = 0x08010000
+build_flags                 = ${stm32_variant.build_flags} -DSTM32F401xE -DSTM32F4 -DSTM32F4_UPDATE_FOLDER
+build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
+extra_scripts               = ${stm32_variant.extra_scripts}
+                              pre:buildroot/share/PlatformIO/scripts/random-bin.py
+monitor_speed               = 115200
+
+[env:STM32F401RE_creality_jlink]
+extends         = env:STM32F401RE_creality
+debug_tool      = jlink
+upload_protocol = jlink
+
+[env:STM32F401RE_creality_stlink]
+extends         = env:STM32F401RC_creality
+debug_tool      = stlink
+upload_protocol = stlink
 
 #
 # BigTree SKR mini E3 V3.0.1 (STM32F401RCT6 ARM Cortex-M4)
 #
 [env:STM32F401RC_btt]
 extends                     = stm32_variant
 platform                    = ststm32@~14.1.0
 platform_packages           = framework-arduinoststm32@https://github.com/stm32duino/Arduino_Core_STM32/archive/main.zip
 board                       = marlin_STM32F401RC
 board_build.offset          = 0x4000

commit 883bde07c650068f10995b7c58cd72a432d4b78e
Author: Andrew <18502096+classicrocker883@users.noreply.github.com>
Date:   Sat Apr 15 21:51:51 2023 -0400

    üîß Animated bootscreen U8glib-only (#25684)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index e9b9a956de..7060f95db7 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -40,20 +40,21 @@ upload_command     = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 
 #
 # FLYF407ZG
 #
 [env:FLYF407ZG]
 extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_FLY_F407ZG
 board_build.offset  = 0x8000
 upload_protocol     = dfu
+
 #
 # FYSETC S6 (STM32F446RET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
 extends                     = stm32_variant
 board                       = marlin_fysetc_s6
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
 build_flags                 = ${stm32_variant.build_flags} -DHAL_PCD_MODULE_ENABLED
 debug_tool                  = stlink

commit 8b6155deeebd5aa12d0a335dd9087fd7db280d5b
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Mar 24 03:01:09 2023 -0500

    üî® INI Updates
    
    Co-Authored-By: Martin Turski <turningtides@outlook.de>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index aa3b1dfc7c..e9b9a956de 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -719,20 +719,18 @@ extends                     = env:mks_skipr_v1
 board_build.rename          = firmware.bin
 board_build.offset          = 0x0000
 board_upload.offset_address = 0x08000000
 upload_protocol             = dfu
 upload_command              = dfu-util -a 0 -s 0x08000000:leave -D "$SOURCE"
 
 #
 # STM32F446ZET6 ARM Cortex-M4
 #
 [env:STM32F446_tronxy]
-platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 board                       = marlin_STM32F446ZET_tronxy
 board_build.offset          = 0x10000
 board_build.rename          = fmw_tronxy.bin
-build_src_filter            = ${common_stm32.build_src_filter}
 build_flags                 = ${stm32_variant.build_flags}
                               -DSTM32F4xx
 build_unflags               = ${stm32_variant.build_unflags} -fno-rtti
                               -DUSBCON -DUSBD_USE_CDC

commit 28b101cceff79eaf1401b583a05e0251b1e6e55c
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Fri Mar 10 15:56:33 2023 -0800

    ‚ú® BTT Octopus Max EZ 1.0, SKR 3.0 / 3.0 EZ (#25387)
    
    BTT Octopus Max EZ V1.0 (STM32H723VE/ZE), SKR V3.0 / V3.0 EZ (STM32H723VG)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 05a549bec7..aa3b1dfc7c 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -262,83 +262,83 @@ build_flags       = ${env:BIGTREE_SKR_2_F429.build_flags} -DUSBD_USE_CDC_MSC
 build_unflags     = ${env:BIGTREE_SKR_2_F429.build_unflags} -DUSBD_USE_CDC
 
 [env:BIGTREE_SKR_2_F429_USB_debug]
 extends           = env:BIGTREE_SKR_2_F429_USB
 build_flags       = ${env:BIGTREE_SKR_2_F429_USB.build_flags} -O0
 build_unflags     = ${env:BIGTREE_SKR_2_F429_USB.build_unflags} -Os -NDEBUG
 
 #
 # BigTreeTech Octopus V1.0/1.1 / Octopus Pro V1.0 (STM32F446ZET6 ARM Cortex-M4)
 #
-[env:BIGTREE_OCTOPUS_V1]
+[env:STM32F446ZE_btt]
 extends                     = stm32_variant
 board                       = marlin_BigTree_Octopus_v1
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 debug_tool                  = stlink
 upload_protocol             = stlink
 build_flags                 = ${stm32_variant.build_flags}
                               -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus V1.0/1.1 / Octopus Pro V1.0 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
-[env:BIGTREE_OCTOPUS_V1_USB]
-extends           = env:BIGTREE_OCTOPUS_V1
+[env:STM32F446ZE_btt_USB]
+extends           = env:STM32F446ZE_btt
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
                     -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
-# BigTreeTech Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4)
+# BigTreeTech Octopus V1.1 / Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4)
 #
-[env:BIGTREE_OCTOPUS_PRO_V1_F429]
+[env:STM32F429ZG_btt]
 extends                     = stm32_variant
 board                       = marlin_BigTree_Octopus_Pro_v1_F429
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 debug_tool                  = stlink
 upload_protocol             = stlink
 build_flags                 = ${stm32_variant.build_flags}
                               -DUSE_USB_HS_IN_FS
 
 #
-# BigTreeTech Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4) with USB Flash Drive Support
+# BigTreeTech Octopus V1.1 / Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
-[env:BIGTREE_OCTOPUS_PRO_V1_F429_USB]
-extends           = env:BIGTREE_OCTOPUS_PRO_V1_F429
+[env:STM32F429ZG_btt_USB]
+extends           = env:STM32F429ZG_btt
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DUSE_USB_HS_IN_FS -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
 # BigTreeTech Octopus / Octopus Pro (STM32F407ZET6 ARM Cortex-M4)
 #
-[env:BIGTREE_OCTOPUS_V1_F407]
+[env:STM32F407ZE_btt]
 extends            = stm32_variant
 board              = marlin_STM32F407ZE
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags}
                      -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus / Octopus Pro (STM32F407ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
-[env:BIGTREE_OCTOPUS_V1_F407_USB]
-extends           = env:BIGTREE_OCTOPUS_V1_F407
+[env:STM32F407ZE_btt_USB]
+extends           = env:STM32F407ZE_btt
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DUSE_USB_HS_IN_FS -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
 # Lerdge base
 #

commit 78de7c85457f9ae0c5a51459d0cace80612a95f3
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Sat Dec 17 10:01:14 2022 +1300

    ‚ú® BTT Octopus with STM32-F407 (#25031)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 7618cd0936..05a549bec7 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -310,20 +310,42 @@ build_flags                 = ${stm32_variant.build_flags}
 #
 [env:BIGTREE_OCTOPUS_PRO_V1_F429_USB]
 extends           = env:BIGTREE_OCTOPUS_PRO_V1_F429
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DUSE_USB_HS_IN_FS -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
+#
+# BigTreeTech Octopus / Octopus Pro (STM32F407ZET6 ARM Cortex-M4)
+#
+[env:BIGTREE_OCTOPUS_V1_F407]
+extends            = stm32_variant
+board              = marlin_STM32F407ZE
+board_build.offset = 0x8000
+build_flags        = ${stm32_variant.build_flags}
+                     -DUSE_USB_HS_IN_FS
+
+#
+# BigTreeTech Octopus / Octopus Pro (STM32F407ZET6 ARM Cortex-M4) with USB Flash Drive Support
+#
+[env:BIGTREE_OCTOPUS_V1_F407_USB]
+extends           = env:BIGTREE_OCTOPUS_V1_F407
+platform_packages = ${stm_flash_drive.platform_packages}
+build_unflags     = -DUSBD_USE_CDC
+build_flags       = ${stm_flash_drive.build_flags}
+                    -DUSE_USB_HS_IN_FS -DUSE_USBHOST_HS
+                    -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
+                    -DUSBD_USE_CDC_MSC
+
 #
 # Lerdge base
 #
 [lerdge_common]
 extends                  = stm32_variant
 board                    = marlin_STM32F407ZGT6
 board_build.variant      = MARLIN_LERDGE
 board_build.crypt_lerdge = firmware.bin
 board_build.offset       = 0x10000
 build_flags              = ${stm32_variant.build_flags}

commit 1aa0ece8a42e3acbc4133a83a0f34d36ac743039
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Tue Oct 18 16:41:41 2022 +1300

    ‚ú® Tronxy v10 (#24787)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 471e9e7fb4..7618cd0936 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -692,10 +692,25 @@ extends                     = stm32_variant
 board                       = marlin_MKS_SKIPR_V1
 board_build.rename          = mks_skipr.bin
 
 [env:mks_skipr_v1_nobootloader]
 extends                     = env:mks_skipr_v1
 board_build.rename          = firmware.bin
 board_build.offset          = 0x0000
 board_upload.offset_address = 0x08000000
 upload_protocol             = dfu
 upload_command              = dfu-util -a 0 -s 0x08000000:leave -D "$SOURCE"
+
+#
+# STM32F446ZET6 ARM Cortex-M4
+#
+[env:STM32F446_tronxy]
+platform                    = ${common_stm32.platform}
+extends                     = stm32_variant
+board                       = marlin_STM32F446ZET_tronxy
+board_build.offset          = 0x10000
+board_build.rename          = fmw_tronxy.bin
+build_src_filter            = ${common_stm32.build_src_filter}
+build_flags                 = ${stm32_variant.build_flags}
+                              -DSTM32F4xx
+build_unflags               = ${stm32_variant.build_unflags} -fno-rtti
+                              -DUSBCON -DUSBD_USE_CDC

commit 26d01c5f2cc11df04e12ed35b1209de1bc487595
Author: EvilGremlin <22657714+EvilGremlin@users.noreply.github.com>
Date:   Wed Oct 12 02:31:37 2022 +0300

    ‚ú® MKS SKIPR board (#24791)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index b0d2a5600c..471e9e7fb4 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -40,21 +40,20 @@ upload_command     = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 
 #
 # FLYF407ZG
 #
 [env:FLYF407ZG]
 extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_FLY_F407ZG
 board_build.offset  = 0x8000
 upload_protocol     = dfu
-
 #
 # FYSETC S6 (STM32F446RET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
 extends                     = stm32_variant
 board                       = marlin_fysetc_s6
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
 build_flags                 = ${stm32_variant.build_flags} -DHAL_PCD_MODULE_ENABLED
 debug_tool                  = stlink
@@ -677,10 +676,26 @@ platform_packages           = framework-arduinoststm32@https://github.com/stm32d
 board                       = marlin_STM32F401RC
 board_build.offset          = 0x4000
 board_upload.offset_address = 0x08004000
 build_flags                 = ${stm32_variant.build_flags}
                               -DPIN_SERIAL6_RX=PC_7 -DPIN_SERIAL6_TX=PC_6
                               -DSERIAL_RX_BUFFER_SIZE=1024 -DSERIAL_TX_BUFFER_SIZE=1024
                               -DTIMER_SERVO=TIM3 -DTIMER_TONE=TIM4
                               -DSTEP_TIMER_IRQ_PRIO=0
 upload_protocol             = stlink
 debug_tool                  = stlink
+
+#
+# MKS SKIPR v1.0 all-in-one board (STM32F407VE)
+#
+[env:mks_skipr_v1]
+extends                     = stm32_variant
+board                       = marlin_MKS_SKIPR_V1
+board_build.rename          = mks_skipr.bin
+
+[env:mks_skipr_v1_nobootloader]
+extends                     = env:mks_skipr_v1
+board_build.rename          = firmware.bin
+board_build.offset          = 0x0000
+board_upload.offset_address = 0x08000000
+upload_protocol             = dfu
+upload_command              = dfu-util -a 0 -s 0x08000000:leave -D "$SOURCE"

commit 50f79823d25841247d7420da4048b53109cb4488
Author: George Fu <nailao_5918@163.com>
Date:   Wed Sep 14 01:28:38 2022 +0800

    ‚ú® FYSETC SPIDER KING407 (#24696)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 39ceb8079d..b0d2a5600c 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -64,20 +64,30 @@ upload_command              = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
 #
 # FYSETC S6 new bootloader
 #
 [env:FYSETC_S6_8000]
 extends                     = env:FYSETC_S6
 board                       = marlin_fysetc_s6
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 upload_command              = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 
+#
+#  FYSETC SPIDER KING407 (STM32F407ZGT6 ARM Cortex-M4)
+#
+[env:FYSETC_SPIDER_KING407]
+extends             = stm32_variant
+board               = marlin_STM32F407ZGT6
+board_build.variant = MARLIN_FYSETC_SPIDER_KING407
+board_build.offset  = 0x8000
+upload_protocol     = dfu
+
 #
 # STM32F407VET6 with RAMPS-like shield
 # 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
 extends           = stm32_variant
 board             = marlin_blackSTM32F407VET6
 build_flags       = ${stm32_variant.build_flags}
                     -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS

commit 3c449b220fb4a2bb6a5b877f2fe13a1fc6e84f74
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Wed Sep 14 05:27:16 2022 +1200

    ‚ú® BTT SKR Mini E3 V3.0.1 (#24722)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 2c5aedbfe0..39ceb8079d 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -649,10 +649,28 @@ monitor_speed               = 115200
 
 [env:STM32F401RC_creality_jlink]
 extends                     = env:STM32F401RC_creality
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 [env:STM32F401RC_creality_stlink]
 extends                     = env:STM32F401RC_creality
 debug_tool                  = stlink
 upload_protocol             = stlink
+
+#
+# BigTree SKR mini E3 V3.0.1 (STM32F401RCT6 ARM Cortex-M4)
+#
+[env:STM32F401RC_btt]
+extends                     = stm32_variant
+platform                    = ststm32@~14.1.0
+platform_packages           = framework-arduinoststm32@https://github.com/stm32duino/Arduino_Core_STM32/archive/main.zip
+board                       = marlin_STM32F401RC
+board_build.offset          = 0x4000
+board_upload.offset_address = 0x08004000
+build_flags                 = ${stm32_variant.build_flags}
+                              -DPIN_SERIAL6_RX=PC_7 -DPIN_SERIAL6_TX=PC_6
+                              -DSERIAL_RX_BUFFER_SIZE=1024 -DSERIAL_TX_BUFFER_SIZE=1024
+                              -DTIMER_SERVO=TIM3 -DTIMER_TONE=TIM4
+                              -DSTEP_TIMER_IRQ_PRIO=0
+upload_protocol             = stlink
+debug_tool                  = stlink

commit 35d4791518d3800127979d4bc2f24e17ec461271
Author: Stephen Hawes <sphawes@gmail.com>
Date:   Sat Sep 3 21:55:37 2022 -0400

    ‚ú® Opulo LumenPnP REV04 (#24718)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 0857dec398..2c5aedbfe0 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -86,20 +86,31 @@ build_flags       = ${stm32_variant.build_flags}
 # STM32F407VET6 Opulo Lumen REV3
 #
 [env:Opulo_Lumen_REV3]
 extends           = stm32_variant
 board             = marlin_opulo_lumen_rev3
 build_flags       = ${stm32_variant.build_flags}
   -DARDUINO_BLACK_F407VE
   -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 extra_scripts     = ${stm32_variant.extra_scripts}
 
+#
+# STM32F407VET6 Opulo Lumen REV4
+#
+[env:Opulo_Lumen_REV4]
+extends           = stm32_variant
+board             = marlin_opulo_lumen_rev4
+build_flags       = ${stm32_variant.build_flags}
+  -DARDUINO_BLACK_F407VE
+  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+extra_scripts     = ${stm32_variant.extra_scripts}
+
 #
 # Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
 #
 [Anet_ET4]
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 build_flags                 = ${stm32_variant.build_flags}
                               -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
 build_unflags               = ${stm32_variant.build_unflags}

commit 2a1c2e26ed38e55c52d569807884585a9523389c
Author: EvilGremlin <22657714+EvilGremlin@users.noreply.github.com>
Date:   Mon Aug 22 18:31:02 2022 +0300

    ‚ú® Robin Nano v1 CDC (USB mod) (#24619)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 5e0d4a13ec..0857dec398 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -563,56 +563,68 @@ upload_protocol             = stlink
 # TH3D EZBoard v2.0 with OpenBLT from https://github.com/rhapsodyv/OpenBLT-STM32
 #
 [env:TH3D_EZBoard_V2_OpenBLT]
 extends                     = TH3D_EZBoard_V2
 board_build.encode          = firmware.bin
 board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000
 extra_scripts               = ${stm32_variant.extra_scripts}
                               buildroot/share/PlatformIO/scripts/openblt.py
 
-#
-# BOARD_MKS_ROBIN_NANO_V1_3_F4
-#  - MKS Robin Nano   V1.3 (STM32F407VET6) 5 Pololu Plug
-#  - MKS Robin Nano-S V1.3 (STM32F407VET6) 4 TMC2225 + 1 Pololu Plug
-#
-[env:mks_robin_nano_v1_3_f4]
+[mks_robin_nano_v1_3_f4_common]
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 board_build.rename          = Robin_nano35.bin
-build_flags                 = ${stm32_variant.build_flags}
-                              -DMCU_STM32F407VE -DSS_TIMER=4 -DENABLE_HWSERIAL3
-                              -DSTM32_FLASH_SIZE=512
-                              -DTIMER_TONE=TIM3 -DTIMER_SERVO=TIM2
-                              -DHAL_SD_MODULE_ENABLED
-                              -DHAL_SRAM_MODULE_ENABLED
-build_unflags               = ${stm32_variant.build_unflags}
-                              -DUSBCON -DUSBD_USE_CDC
 debug_tool                  = jlink
 upload_protocol             = jlink
 
+#
+# BOARD_MKS_ROBIN_NANO_V1_3_F4
+#  - MKS Robin Nano   V1.3 (STM32F407VET6, 5 Pololu Plug)
+#  - MKS Robin Nano-S V1.3 (STM32F407VET6, 4 TMC2225, 1 Pololu Plug)
+#  - ZNP Robin Nano   V1.3 (STM32F407VET6, 2 TMC2208, 2 A4988, 1x Polulu plug)
+#
+[env:mks_robin_nano_v1_3_f4]
+extends       = mks_robin_nano_v1_3_f4_common
+build_flags   = ${stm32_variant.build_flags}
+                -DMCU_STM32F407VE -DENABLE_HWSERIAL3 -DSTM32_FLASH_SIZE=512
+                -DTIMER_SERVO=TIM2 -DTIMER_TONE=TIM3 -DSS_TIMER=4
+                -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
+build_unflags = ${stm32_variant.build_unflags}
+                -DUSBCON -DUSBD_USE_CDC
+
+#
+#  MKS/ZNP Robin Nano V1.3 with native USB mod
+#
+[env:mks_robin_nano_v1_3_f4_usbmod]
+extends       = mks_robin_nano_v1_3_f4_common
+build_flags   = ${stm32_variant.build_flags}
+                -DMCU_STM32F407VE -DSTM32_FLASH_SIZE=512
+                -DTIMER_SERVO=TIM2 -DTIMER_TONE=TIM3 -DSS_TIMER=4
+                -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
+
 #
 # Artillery Ruby
 #
 [env:Artillery_Ruby]
-extends           = common_stm32
-board             = marlin_Artillery_Ruby
-build_flags       = ${common_stm32.build_flags}
-                    -DSTM32F401xC -DTARGET_STM32F4 -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32
-                    -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-                    -DUSB_PRODUCT=\"Artillery_3D_Printer\"
-                    -DFLASH_DATA_SECTOR=1U -DFLASH_BASE_ADDRESS=0x08004000
-extra_scripts     = ${common_stm32.extra_scripts}
-                    pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extends       = common_stm32
+board         = marlin_Artillery_Ruby
+build_flags   = ${common_stm32.build_flags}
+                -DSTM32F401xC -DTARGET_STM32F4 -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32
+                -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+                -DUSB_PRODUCT=\"Artillery_3D_Printer\"
+                -DFLASH_DATA_SECTOR=1U -DFLASH_BASE_ADDRESS=0x08004000
+extra_scripts = ${common_stm32.extra_scripts}
+                pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
 # Ender-3 S1 STM32F401RC_creality
 #
 [env:STM32F401RC_creality]
 extends                     = stm32_variant
 board                       = genericSTM32F401RC
 board_build.variant         = MARLIN_CREALITY_STM32F401RC
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000

commit 3f4e4a4d891e3c4b73ab80aedec46e69c1b59f0d
Author: Bob Kuhn <bob.kuhn@att.net>
Date:   Wed Jul 13 22:16:22 2022 -0500

    üî• Drop STM L64** drivers, STEVAL_3DP001V1 (#24427)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index a663d31483..5e0d4a13ec 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -21,31 +21,20 @@
 
 #
 # ARMED (STM32)
 #
 [env:ARMED]
 extends       = common_stm32
 board         = armed_v1
 build_flags   = ${common_stm32.build_flags}
                 -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
 
-#
-# STM32F401VE
-# 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
-#
-[env:STM32F401VE_STEVAL]
-extends           = stm32_variant
-board             = marlin_STEVAL_STM32F401VE
-build_flags       = ${stm32_variant.build_flags}
-                    -DSTM32F401xE -DDISABLE_GENERIC_SERIALUSB
-                    -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-
 #
 # STM32F401RC
 #
 [env:FYSETC_CHEETAH_V20]
 extends            = stm32_variant
 board              = marlin_FYSETC_CHEETAH_V20
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags} -DSTM32F401xC
 upload_command     = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 

commit 1bab0243fd598c030ddba1d87109db1498cdec41
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Mon Jul 11 11:33:42 2022 -0700

    ‚ú® MKS Monster8 V2 (#24483)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index ddb944e80f..a663d31483 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -508,50 +508,50 @@ build_flags       = ${env:mks_eagle_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
 # This I2C1(PB8:I2C1_SCL PB9:I2C1_SDA) is used by MKS Monster8
 #
 [stm32f4_I2C1_CAN]
 build_flags = -DPIN_WIRE_SCL=PB8 -DPIN_WIRE_SDA=PB9
 
 #
-# MKS Monster8
+# MKS Monster8 V1 / V2 (STM32F407VET6 ARM Cortex-M4)
 #
 [env:mks_monster8]
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000
 board_build.rename          = mks_monster8.bin
 build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1_CAN.build_flags}
                               -DHAL_PCD_MODULE_ENABLED -DTIMER_SERIAL=TIM4
                               -DSTM32_FLASH_SIZE=512
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
-# MKS Monster8 with USB Flash Drive Support
+# MKS Monster8 V1 / V2 (STM32F407VET6 ARM Cortex-M4) with USB Flash Drive Support
 # Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_monster8_usb_flash_drive]
 extends           = env:mks_monster8
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1_CAN.build_flags}
                     -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSE_USB_HS_IN_FS
 
 #
-# MKS Monster8 with USB Flash Drive Support and Shared Media
+# MKS Monster8 V1 / V2 (STM32F407VET6 ARM Cortex-M4) with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_monster8_usb_flash_drive_msc]
 extends           = env:mks_monster8_usb_flash_drive
 build_flags       = ${env:mks_monster8_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
 # TH3D EZBoard v2.0 (STM32F405RGT6 ARM Cortex-M4)

commit e94fa7d5dc41f26b82891b664b9a9812372747ba
Author: EvilGremlin <22657714+EvilGremlin@users.noreply.github.com>
Date:   Mon Jul 4 04:49:23 2022 +0300

    üî® Fix OpenBLT encode; no-bootloader envs (#24446)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 8da73f0f40..ddb944e80f 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -99,38 +99,48 @@ build_flags       = ${stm32_variant.build_flags}
 [env:Opulo_Lumen_REV3]
 extends           = stm32_variant
 board             = marlin_opulo_lumen_rev3
 build_flags       = ${stm32_variant.build_flags}
   -DARDUINO_BLACK_F407VE
   -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 extra_scripts     = ${stm32_variant.extra_scripts}
 
 #
 # Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
-# For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
-# Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
 #
-[env:Anet_ET4_OpenBLT]
+[Anet_ET4]
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
-board_build.encrypt_mks     = firmware.srec
-board_build.offset          = 0x10000
-board_upload.offset_address = 0x08010000
 build_flags                 = ${stm32_variant.build_flags}
                               -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
 build_unflags               = ${stm32_variant.build_unflags}
                               -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
+
+#
+# Anet ET4 directly flashed via ST-Link
+#
+[env:Anet_ET4_no_bootloader]
+extends                     = Anet_ET4
+debug_tool                  = stlink
+upload_protocol             = stlink
+
+#
+# Anet ET4 with OpenBLT from https://github.com/davidtgbe/openblt/releases
+#
+[env:Anet_ET4_OpenBLT]
+extends                     = Anet_ET4
+board_build.encode          = firmware.srec
+board_build.offset          = 0x10000
+board_upload.offset_address = 0x08010000
 extra_scripts               = ${stm32_variant.extra_scripts}
                               buildroot/share/PlatformIO/scripts/openblt.py
-debug_tool                  = jlink
-upload_protocol             = jlink
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
 extends            = stm32_variant
 board              = marlin_BigTree_SKR_Pro
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags} -DSTM32F407_5ZX
 debug_tool         = stlink
@@ -539,30 +549,42 @@ build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1_CAN.build_flag
 #
 [env:mks_monster8_usb_flash_drive_msc]
 extends           = env:mks_monster8_usb_flash_drive
 build_flags       = ${env:mks_monster8_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
 # TH3D EZBoard v2.0 (STM32F405RGT6 ARM Cortex-M4)
 #
-[env:TH3D_EZBoard_V2]
+[TH3D_EZBoard_V2]
 extends                     = stm32_variant
 board                       = genericSTM32F405RG
 board_build.variant         = MARLIN_TH3D_EZBOARD_V2
-board_build.encrypt_mks     = firmware.bin
-board_build.offset          = 0xC000
-board_upload.offset_address = 0x0800C000
 build_flags                 = ${stm32_variant.build_flags} -DHSE_VALUE=12000000U -O0
+
+#
+# TH3D EZBoard v2.0 directly flashed via ST-Link
+#
+[env:TH3D_EZBoard_V2_no_bootloader]
+extends                     = TH3D_EZBoard_V2
 debug_tool                  = stlink
 upload_protocol             = stlink
+
+#
+# TH3D EZBoard v2.0 with OpenBLT from https://github.com/rhapsodyv/OpenBLT-STM32
+#
+[env:TH3D_EZBoard_V2_OpenBLT]
+extends                     = TH3D_EZBoard_V2
+board_build.encode          = firmware.bin
+board_build.offset          = 0xC000
+board_upload.offset_address = 0x0800C000
 extra_scripts               = ${stm32_variant.extra_scripts}
                               buildroot/share/PlatformIO/scripts/openblt.py
 
 #
 # BOARD_MKS_ROBIN_NANO_V1_3_F4
 #  - MKS Robin Nano   V1.3 (STM32F407VET6) 5 Pololu Plug
 #  - MKS Robin Nano-S V1.3 (STM32F407VET6) 4 TMC2225 + 1 Pololu Plug
 #
 [env:mks_robin_nano_v1_3_f4]
 extends                     = stm32_variant

commit f5488f96cc6dddb0f3c6034982de75849cc5461d
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Wed Jun 29 20:16:16 2022 -0500

    üìù Index Mobo Rev03 => Opulo Lumen Rev3

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 8bcbb88d94..8da73f0f40 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -87,25 +87,25 @@ upload_command              = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 # 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
 extends           = stm32_variant
 board             = marlin_blackSTM32F407VET6
 build_flags       = ${stm32_variant.build_flags}
                     -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 
 #
-# STM32F407VET6 Index Mobo Rev 03
+# STM32F407VET6 Opulo Lumen REV3
 #
-[env:Index_Mobo_Rev03]
+[env:Opulo_Lumen_REV3]
 extends           = stm32_variant
-board             = marlin_index_mobo_rev03
+board             = marlin_opulo_lumen_rev3
 build_flags       = ${stm32_variant.build_flags}
   -DARDUINO_BLACK_F407VE
   -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 extra_scripts     = ${stm32_variant.extra_scripts}
 
 #
 # Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
 # For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
 # Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
 #

commit 12a869e2ad3b36d6b965be2738308956963e2da4
Author: Bob Kuhn <bob.kuhn@att.net>
Date:   Thu Jun 23 23:58:26 2022 -0500

    üêõ Fix Lerdge build / encrypt (#24391)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 688cc10547..8bcbb88d94 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -106,21 +106,21 @@ extra_scripts     = ${stm32_variant.extra_scripts}
 
 #
 # Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
 # For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
 # Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
 #
 [env:Anet_ET4_OpenBLT]
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
-board_build.encrypt         = firmware.srec
+board_build.encrypt_mks     = firmware.srec
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
 build_flags                 = ${stm32_variant.build_flags}
                               -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
 build_unflags               = ${stm32_variant.build_unflags}
                               -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 extra_scripts               = ${stm32_variant.extra_scripts}
                               buildroot/share/PlatformIO/scripts/openblt.py
 debug_tool                  = jlink
 upload_protocol             = jlink
@@ -295,93 +295,93 @@ platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DUSE_USB_HS_IN_FS -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
 # Lerdge base
 #
 [lerdge_common]
-extends             = stm32_variant
-board               = marlin_STM32F407ZGT6
-board_build.variant = MARLIN_LERDGE
-board_build.offset  = 0x10000
-build_flags         = ${stm32_variant.build_flags}
-                      -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
-                      -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DLERDGE_TFT35
-build_unflags       = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
-extra_scripts       = ${common_stm32.extra_scripts}
-                      pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-                      buildroot/share/PlatformIO/scripts/lerdge.py
+extends                  = stm32_variant
+board                    = marlin_STM32F407ZGT6
+board_build.variant      = MARLIN_LERDGE
+board_build.crypt_lerdge = firmware.bin
+board_build.offset       = 0x10000
+build_flags              = ${stm32_variant.build_flags}
+                           -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
+                           -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DLERDGE_TFT35
+build_unflags            = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
+extra_scripts            = ${stm32_variant.extra_scripts}
+                           buildroot/share/PlatformIO/scripts/lerdge.py
 
 #
 # Lerdge X (STM32F407VE)
 #
 [env:LERDGEX]
-extends             = lerdge_common
-board_build.encrypt = Lerdge_X_firmware_force.bin
+extends                  = lerdge_common
+board_build.crypt_lerdge = Lerdge_X_firmware_force.bin
 
 #
 # Lerdge X with USB Flash Drive Support
 #
 [env:LERDGEX_usb_flash_drive]
 extends           = env:LERDGEX
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # Lerdge S (STM32F407ZG)
 #
 [env:LERDGES]
-extends             = lerdge_common
-board_build.encrypt = Lerdge_firmware_force.bin
+extends                  = lerdge_common
+board_build.crypt_lerdge = Lerdge_firmware_force.bin
 
 #
 # Lerdge S with USB Flash Drive Support
 #
 [env:LERDGES_usb_flash_drive]
 extends           = env:LERDGES
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # Lerdge K (STM32F407ZG)
 #
 [env:LERDGEK]
-extends             = lerdge_common
-board_build.encrypt = Lerdge_K_firmware_force.bin
-build_flags         = ${lerdge_common.build_flags} -DLERDGEK
+extends                  = lerdge_common
+board_build.crypt_lerdge = Lerdge_K_firmware_force.bin
+build_flags              = ${lerdge_common.build_flags} -DLERDGEK
 
 #
 # Lerdge K with USB Flash Drive Support
 #
 [env:LERDGEK_usb_flash_drive]
 extends           = env:LERDGEK
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # RUMBA32
 #
 [env:rumba32]
-extends              = stm32_variant
-board                = rumba32_f446ve
-board_build.variant  = MARLIN_F446VE
-board_build.offset   = 0x0000
-build_flags          = ${stm32_variant.build_flags}
-                       -Os -DHAL_PCD_MODULE_ENABLED
-                       -DDISABLE_GENERIC_SERIALUSB
-                       -DHAL_UART_MODULE_ENABLED
-                       -DTIMER_SERIAL=TIM9
-monitor_speed        = 500000
-upload_protocol      = dfu
+extends             = stm32_variant
+board               = rumba32_f446ve
+board_build.variant = MARLIN_F446VE
+board_build.offset  = 0x0000
+build_flags         = ${stm32_variant.build_flags}
+                      -Os -DHAL_PCD_MODULE_ENABLED
+                      -DDISABLE_GENERIC_SERIALUSB
+                      -DHAL_UART_MODULE_ENABLED
+                      -DTIMER_SERIAL=TIM9
+monitor_speed       = 500000
+upload_protocol     = dfu
 
 #
 # MKS Robin Pro V2
 #
 [env:mks_robin_pro2]
 extends                     = stm32_variant
 platform_packages           = ${stm_flash_drive.platform_packages}
 board                       = genericSTM32F407VET6
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x0000
@@ -540,31 +540,31 @@ build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1_CAN.build_flag
 [env:mks_monster8_usb_flash_drive_msc]
 extends           = env:mks_monster8_usb_flash_drive
 build_flags       = ${env:mks_monster8_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
 # TH3D EZBoard v2.0 (STM32F405RGT6 ARM Cortex-M4)
 #
 [env:TH3D_EZBoard_V2]
-extends             = stm32_variant
-board               = genericSTM32F405RG
-board_build.variant = MARLIN_TH3D_EZBOARD_V2
-board_build.encrypt = firmware.bin
-board_build.offset  = 0xC000
+extends                     = stm32_variant
+board                       = genericSTM32F405RG
+board_build.variant         = MARLIN_TH3D_EZBOARD_V2
+board_build.encrypt_mks     = firmware.bin
+board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000
-build_flags         = ${stm32_variant.build_flags} -DHSE_VALUE=12000000U -O0
-debug_tool          = stlink
-upload_protocol     = stlink
-extra_scripts       = ${stm32_variant.extra_scripts}
-                      buildroot/share/PlatformIO/scripts/openblt.py
+build_flags                 = ${stm32_variant.build_flags} -DHSE_VALUE=12000000U -O0
+debug_tool                  = stlink
+upload_protocol             = stlink
+extra_scripts               = ${stm32_variant.extra_scripts}
+                              buildroot/share/PlatformIO/scripts/openblt.py
 
 #
 # BOARD_MKS_ROBIN_NANO_V1_3_F4
 #  - MKS Robin Nano   V1.3 (STM32F407VET6) 5 Pololu Plug
 #  - MKS Robin Nano-S V1.3 (STM32F407VET6) 4 TMC2225 + 1 Pololu Plug
 #
 [env:mks_robin_nano_v1_3_f4]
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx

commit a7ade2d63e1fb7fe0740f5a07958611ffc796ae8
Author: Roxy-3D <Roxy-3D@users.noreply.github.com>
Date:   Fri May 13 17:29:50 2022 -0500

    üî® BTT Octopus ST-Link programming/debugging

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 260593f8a2..688cc10547 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -244,48 +244,54 @@ build_unflags     = ${env:BIGTREE_SKR_2_F429.build_unflags} -DUSBD_USE_CDC
 
 [env:BIGTREE_SKR_2_F429_USB_debug]
 extends           = env:BIGTREE_SKR_2_F429_USB
 build_flags       = ${env:BIGTREE_SKR_2_F429_USB.build_flags} -O0
 build_unflags     = ${env:BIGTREE_SKR_2_F429_USB.build_unflags} -Os -NDEBUG
 
 #
 # BigTreeTech Octopus V1.0/1.1 / Octopus Pro V1.0 (STM32F446ZET6 ARM Cortex-M4)
 #
 [env:BIGTREE_OCTOPUS_V1]
-extends            = stm32_variant
-board              = marlin_BigTree_Octopus_v1
-board_build.offset = 0x8000
-build_flags        = ${stm32_variant.build_flags}
-                     -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
+extends                     = stm32_variant
+board                       = marlin_BigTree_Octopus_v1
+board_build.offset          = 0x8000
+board_upload.offset_address = 0x08008000
+debug_tool                  = stlink
+upload_protocol             = stlink
+build_flags                 = ${stm32_variant.build_flags}
+                              -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus V1.0/1.1 / Octopus Pro V1.0 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_OCTOPUS_V1_USB]
 extends           = env:BIGTREE_OCTOPUS_V1
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
                     -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
 # BigTreeTech Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_OCTOPUS_PRO_V1_F429]
-extends            = stm32_variant
-board              = marlin_BigTree_Octopus_Pro_v1_F429
-board_build.offset = 0x8000
-build_flags        = ${stm32_variant.build_flags}
-                     -DUSE_USB_HS_IN_FS
+extends                     = stm32_variant
+board                       = marlin_BigTree_Octopus_Pro_v1_F429
+board_build.offset          = 0x8000
+board_upload.offset_address = 0x08008000
+debug_tool                  = stlink
+upload_protocol             = stlink
+build_flags                 = ${stm32_variant.build_flags}
+                              -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_OCTOPUS_PRO_V1_F429_USB]
 extends           = env:BIGTREE_OCTOPUS_PRO_V1_F429
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DUSE_USB_HS_IN_FS -DUSE_USBHOST_HS

commit 38f4d8abfcc89d188674ec3b809102995efc9436
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu May 12 20:09:25 2022 -0500

    ‚ú® Add BOARD_CREALITY_V24S1_301F4
    
    Co-Authored-By: Miguel Risco-Castillo <mriscoc@users.noreply.github.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 437dbdcd9b..260593f8a2 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -581,11 +581,38 @@ upload_protocol             = jlink
 #
 [env:Artillery_Ruby]
 extends           = common_stm32
 board             = marlin_Artillery_Ruby
 build_flags       = ${common_stm32.build_flags}
                     -DSTM32F401xC -DTARGET_STM32F4 -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32
                     -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
                     -DUSB_PRODUCT=\"Artillery_3D_Printer\"
                     -DFLASH_DATA_SECTOR=1U -DFLASH_BASE_ADDRESS=0x08004000
 extra_scripts     = ${common_stm32.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+                    pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+
+#
+# Ender-3 S1 STM32F401RC_creality
+#
+[env:STM32F401RC_creality]
+extends                     = stm32_variant
+board                       = genericSTM32F401RC
+board_build.variant         = MARLIN_CREALITY_STM32F401RC
+board_build.offset          = 0x10000
+board_upload.offset_address = 0x08010000
+build_flags                 = ${stm32_variant.build_flags} -DMCU_STM32F401RC -DSTM32F4
+                              -DSS_TIMER=4 -DTIMER_SERVO=TIM5
+                              -DENABLE_HWSERIAL3 -DTRANSFER_CLOCK_DIV=8
+build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
+extra_scripts               = ${stm32_variant.extra_scripts}
+                              pre:buildroot/share/PlatformIO/scripts/random-bin.py
+monitor_speed               = 115200
+
+[env:STM32F401RC_creality_jlink]
+extends                     = env:STM32F401RC_creality
+debug_tool                  = jlink
+upload_protocol             = jlink
+
+[env:STM32F401RC_creality_stlink]
+extends                     = env:STM32F401RC_creality
+debug_tool                  = stlink
+upload_protocol             = stlink

commit b0e974e208316d86e5b8030e4e92c7af5c5d72f1
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Apr 15 02:05:02 2022 -0500

    üßë‚Äçüíª Simplify BIGTREE_SKR_2_F429 env

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index d7c160d639..437dbdcd9b 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -224,32 +224,22 @@ build_unflags     = ${env:BIGTREE_SKR_2.build_unflags} -DUSBD_USE_CDC
 
 [env:BIGTREE_SKR_2_USB_debug]
 extends           = env:BIGTREE_SKR_2_USB
 build_flags       = ${env:BIGTREE_SKR_2_USB.build_flags} -O0
 build_unflags     = ${env:BIGTREE_SKR_2_USB.build_unflags} -Os -NDEBUG
 
 #
 # Bigtreetech SKR V2.0 F429 (STM32F429VGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_2_F429]
-extends                     = stm32_variant
-platform_packages           = ${stm_flash_drive.platform_packages}
+extends                     = env:BIGTREE_SKR_2
 board                       = marlin_STM32F429VGT6
-board_build.variant         = MARLIN_F4x7Vx
-board_build.offset          = 0x8000
-board_upload.offset_address = 0x08008000
-build_flags                 = ${stm_flash_drive.build_flags}
-                              -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS
-                              -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
-                              -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
-                              -DPIN_SERIAL3_RX=PD_9 -DPIN_SERIAL3_TX=PD_8
-upload_protocol             = stlink
 
 #
 # BigTreeTech SKR V2.0 F429 (STM32F429VGT6 ARM Cortex-M4) with USB Media Share Support
 #
 [env:BIGTREE_SKR_2_F429_USB]
 extends           = env:BIGTREE_SKR_2_F429
 build_flags       = ${env:BIGTREE_SKR_2_F429.build_flags} -DUSBD_USE_CDC_MSC
 build_unflags     = ${env:BIGTREE_SKR_2_F429.build_unflags} -DUSBD_USE_CDC
 
 [env:BIGTREE_SKR_2_F429_USB_debug]

commit 2f6a6f3b55a1a6d8febcda648fa5353cc25467c1
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Sat Mar 12 16:23:29 2022 -0800

    üî® Drop extraneous build flag (#23862)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 9e6e213427..d7c160d639 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -291,23 +291,22 @@ build_flags        = ${stm32_variant.build_flags}
                      -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_OCTOPUS_PRO_V1_F429_USB]
 extends           = env:BIGTREE_OCTOPUS_PRO_V1_F429
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
-                    -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
-                    -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5
-                    -DUSBD_IRQ_SUBPRIO=6
+                    -DUSE_USB_HS_IN_FS -DUSE_USBHOST_HS
+                    -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
 # Lerdge base
 #
 [lerdge_common]
 extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_LERDGE
 board_build.offset  = 0x10000

commit f7f29c6b5eb0d1b9a5cde7b4318dca506e3a5be5
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Sun Feb 27 11:45:33 2022 +1300

    ‚ú® MKS Robin Nano 3.1 (#23795)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index c7d70dd01d..9e6e213427 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -433,20 +433,43 @@ build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
 #
 # MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive_msc]
 extends           = env:mks_robin_nano_v3_usb_flash_drive
 build_flags       = ${env:mks_robin_nano_v3_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
+#
+# MKS Robin Nano V3_1
+#
+[env:mks_robin_nano_v3_1]
+extends           = env:mks_robin_nano_v3
+board             = marlin_STM32F407VET6_CCM
+
+#
+# MKS Robin Nano V3.1 with USB Flash Drive Support
+# Currently, using a STM32duino fork, until USB Host get merged
+#
+[env:mks_robin_nano_v3_1_usb_flash_drive]
+extends           = env:mks_robin_nano_v3_usb_flash_drive
+board             = marlin_STM32F407VET6_CCM
+
+#
+# MKS Robin Nano V3.1 with USB Flash Drive Support and Shared Media
+# Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
+#
+[env:mks_robin_nano_v3_1_usb_flash_drive_msc]
+extends           = env:mks_robin_nano_v3_usb_flash_drive_msc
+board             = marlin_STM32F407VET6_CCM
+
 #
 # MKS Eagle
 # 5 TMC2209 uart mode on board
 #
 [env:mks_eagle]
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000

commit 59dbf27385febae978093bbdc37f4b97c586d4d6
Author: Timothy Hoogland <timothy@hoogland.email>
Date:   Mon Jan 31 14:02:07 2022 -0600

    üêõ Fix EZBoard V2 Environment for OpenBLT (#23659)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 93f42123fa..c7d70dd01d 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -525,25 +525,28 @@ build_flags       = ${env:mks_monster8_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
 # TH3D EZBoard v2.0 (STM32F405RGT6 ARM Cortex-M4)
 #
 [env:TH3D_EZBoard_V2]
 extends             = stm32_variant
 board               = genericSTM32F405RG
 board_build.variant = MARLIN_TH3D_EZBOARD_V2
+board_build.encrypt = firmware.bin
 board_build.offset  = 0xC000
 board_upload.offset_address = 0x0800C000
 build_flags         = ${stm32_variant.build_flags} -DHSE_VALUE=12000000U -O0
 debug_tool          = stlink
 upload_protocol     = stlink
+extra_scripts       = ${stm32_variant.extra_scripts}
+                      buildroot/share/PlatformIO/scripts/openblt.py
 
 #
 # BOARD_MKS_ROBIN_NANO_V1_3_F4
 #  - MKS Robin Nano   V1.3 (STM32F407VET6) 5 Pololu Plug
 #  - MKS Robin Nano-S V1.3 (STM32F407VET6) 4 TMC2225 + 1 Pololu Plug
 #
 [env:mks_robin_nano_v1_3_f4]
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx

commit d225445ab1ff1d600063b71cafeb78f8fd435985
Author: George Fu <nailao_5918@163.com>
Date:   Fri Jan 14 18:10:35 2022 +0800

    üî® Set upload_command for CHEETAH v20 (#23515)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index f721f3075d..93f42123fa 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -40,20 +40,21 @@ build_flags       = ${stm32_variant.build_flags}
                     -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 
 #
 # STM32F401RC
 #
 [env:FYSETC_CHEETAH_V20]
 extends            = stm32_variant
 board              = marlin_FYSETC_CHEETAH_V20
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags} -DSTM32F401xC
+upload_command     = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 
 #
 # FLYF407ZG
 #
 [env:FLYF407ZG]
 extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_FLY_F407ZG
 board_build.offset  = 0x8000
 upload_protocol     = dfu

commit 8e490e84be80ef9eb4e1f9de08939e1126c1c23d
Author: Kyle Hu <kyle.hu.gz@gmail.com>
Date:   Thu Jan 6 15:54:04 2022 +0800

    üêõ Fix Artillery Ruby (startup code, build flags) (#23446)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 1c3d9a8892..f721f3075d 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -563,12 +563,13 @@ upload_protocol             = jlink
 #
 # Artillery Ruby
 #
 [env:Artillery_Ruby]
 extends           = common_stm32
 board             = marlin_Artillery_Ruby
 build_flags       = ${common_stm32.build_flags}
                     -DSTM32F401xC -DTARGET_STM32F4 -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32
                     -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
                     -DUSB_PRODUCT=\"Artillery_3D_Printer\"
+                    -DFLASH_DATA_SECTOR=1U -DFLASH_BASE_ADDRESS=0x08004000
 extra_scripts     = ${common_stm32.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py

commit 554a2fc84a5cd67cc9b0be8b01551a9eca3925bf
Author: Jason Smith <jason.inet@gmail.com>
Date:   Sun Jan 2 21:27:22 2022 -0800

    ‚¨ÜÔ∏è Assert newer GCC in PIO via atmelavr@~3.4 (#23432)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index d7c80cf0e9..1c3d9a8892 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -16,416 +16,381 @@
 #   G : 1024KB Flash-memory  (B:128KB, C:256KB, D:384KB, E:512KB)
 #   T : LQFP package
 #   6 : -40...85¬∞C   (7: ...105¬∞C)
 #
 #################################
 
 #
 # ARMED (STM32)
 #
 [env:ARMED]
-platform      = ${common_stm32.platform}
 extends       = common_stm32
 board         = armed_v1
 build_flags   = ${common_stm32.build_flags}
                 -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
 
 #
 # STM32F401VE
 # 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
 #
 [env:STM32F401VE_STEVAL]
-platform          = ${common_stm32.platform}
 extends           = stm32_variant
 board             = marlin_STEVAL_STM32F401VE
 build_flags       = ${stm32_variant.build_flags}
                     -DSTM32F401xE -DDISABLE_GENERIC_SERIALUSB
                     -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 
 #
 # STM32F401RC
 #
 [env:FYSETC_CHEETAH_V20]
-platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_FYSETC_CHEETAH_V20
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags} -DSTM32F401xC
 
 #
 # FLYF407ZG
 #
 [env:FLYF407ZG]
-platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_FLY_F407ZG
 board_build.offset  = 0x8000
 upload_protocol     = dfu
 
 #
 # FYSETC S6 (STM32F446RET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
-platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 board                       = marlin_fysetc_s6
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
 build_flags                 = ${stm32_variant.build_flags} -DHAL_PCD_MODULE_ENABLED
 debug_tool                  = stlink
 upload_protocol             = dfu
 upload_command              = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
 
 #
 # FYSETC S6 new bootloader
 #
 [env:FYSETC_S6_8000]
-platform                    = ${common_stm32.platform}
 extends                     = env:FYSETC_S6
 board                       = marlin_fysetc_s6
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 upload_command              = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 
 #
 # STM32F407VET6 with RAMPS-like shield
 # 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
-platform          = ${common_stm32.platform}
 extends           = stm32_variant
 board             = marlin_blackSTM32F407VET6
 build_flags       = ${stm32_variant.build_flags}
                     -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 
 #
 # STM32F407VET6 Index Mobo Rev 03
 #
 [env:Index_Mobo_Rev03]
-platform          = ${common_stm32.platform}
 extends           = stm32_variant
 board             = marlin_index_mobo_rev03
 build_flags       = ${stm32_variant.build_flags}
   -DARDUINO_BLACK_F407VE
   -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 extra_scripts     = ${stm32_variant.extra_scripts}
 
 #
 # Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
 # For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
 # Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
 #
 [env:Anet_ET4_OpenBLT]
-platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.encrypt         = firmware.srec
 board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
 build_flags                 = ${stm32_variant.build_flags}
                               -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
 build_unflags               = ${stm32_variant.build_unflags}
                               -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 extra_scripts               = ${stm32_variant.extra_scripts}
                               buildroot/share/PlatformIO/scripts/openblt.py
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
-platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_BigTree_SKR_Pro
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags} -DSTM32F407_5ZX
 debug_tool         = stlink
 upload_protocol    = stlink
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_PRO_usb_flash_drive]
-platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_PRO
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} -DSTM32F407_5ZX
 build_unflags     = ${env:BIGTREE_SKR_PRO.build_unflags} -DUSBCON -DUSBD_USE_CDC
 
 #
 # BigTreeTech E3 RRF (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_E3_RRF]
-platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = marlin_STM32F407VGT6_CCM
 board_build.variant = MARLIN_BIGTREE_E3_RRF
 board_build.offset  = 0x8000
 build_flags         = ${stm32_variant.build_flags}
                       -DSTM32F407_5VX
                       -DMF_RX_BUFFER_SIZE=255
                       -DMF_TX_BUFFER_SIZE=255
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_GTR_V1_0]
-platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_BigTree_GTR_v1
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags} -DSTM32F407IX
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_GTR_V1_0_usb_flash_drive]
-platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_GTR_V1_0
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} -DSTM32F407IX
 build_unflags     = ${env:BIGTREE_GTR_V1_0.build_unflags} -DUSBCON -DUSBD_USE_CDC
 
 #
 # BigTreeTech BTT002 V1.0 (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
-platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_BigTree_BTT002
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags}
                      -DSTM32F407_5VX
                      -DHAVE_HWSERIAL2
                      -DHAVE_HWSERIAL3
                      -DPIN_SERIAL2_RX=PD_6
                      -DPIN_SERIAL2_TX=PD_5
 
 #
 # BigTreeTech BTT002 V1.x with 512k of flash (STM32F407VET6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002_VET6]
-platform          = ${env:BIGTREE_BTT002.platform}
 extends           = env:BIGTREE_BTT002
 board             = marlin_BigTree_BTT002_VET6
 
 #
 # BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_2]
-platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 platform_packages           = ${stm_flash_drive.platform_packages}
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 build_flags                 = ${stm_flash_drive.build_flags}
                               -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS
                               -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                               -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
                               -DPIN_SERIAL3_RX=PD_9 -DPIN_SERIAL3_TX=PD_8
 upload_protocol             = stlink
 
 #
 # BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Media Share Support
 #
 [env:BIGTREE_SKR_2_USB]
-platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_2
 build_flags       = ${env:BIGTREE_SKR_2.build_flags} -DUSBD_USE_CDC_MSC
 build_unflags     = ${env:BIGTREE_SKR_2.build_unflags} -DUSBD_USE_CDC
 
 [env:BIGTREE_SKR_2_USB_debug]
-platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_2_USB
 build_flags       = ${env:BIGTREE_SKR_2_USB.build_flags} -O0
 build_unflags     = ${env:BIGTREE_SKR_2_USB.build_unflags} -Os -NDEBUG
 
 #
 # Bigtreetech SKR V2.0 F429 (STM32F429VGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_2_F429]
-platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 platform_packages           = ${stm_flash_drive.platform_packages}
 board                       = marlin_STM32F429VGT6
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 build_flags                 = ${stm_flash_drive.build_flags}
                               -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS
                               -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                               -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
                               -DPIN_SERIAL3_RX=PD_9 -DPIN_SERIAL3_TX=PD_8
 upload_protocol             = stlink
 
 #
 # BigTreeTech SKR V2.0 F429 (STM32F429VGT6 ARM Cortex-M4) with USB Media Share Support
 #
 [env:BIGTREE_SKR_2_F429_USB]
-platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_2_F429
 build_flags       = ${env:BIGTREE_SKR_2_F429.build_flags} -DUSBD_USE_CDC_MSC
 build_unflags     = ${env:BIGTREE_SKR_2_F429.build_unflags} -DUSBD_USE_CDC
 
 [env:BIGTREE_SKR_2_F429_USB_debug]
-platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_2_F429_USB
 build_flags       = ${env:BIGTREE_SKR_2_F429_USB.build_flags} -O0
 build_unflags     = ${env:BIGTREE_SKR_2_F429_USB.build_unflags} -Os -NDEBUG
 
 #
 # BigTreeTech Octopus V1.0/1.1 / Octopus Pro V1.0 (STM32F446ZET6 ARM Cortex-M4)
 #
 [env:BIGTREE_OCTOPUS_V1]
-platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_BigTree_Octopus_v1
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags}
                      -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus V1.0/1.1 / Octopus Pro V1.0 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_OCTOPUS_V1_USB]
-platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_OCTOPUS_V1
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
                     -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
 # BigTreeTech Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_OCTOPUS_PRO_V1_F429]
-platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_BigTree_Octopus_Pro_v1_F429
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags}
                      -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_OCTOPUS_PRO_V1_F429_USB]
-platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_OCTOPUS_PRO_V1_F429
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
                     -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
 # Lerdge base
 #
 [lerdge_common]
-platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_LERDGE
 board_build.offset  = 0x10000
 build_flags         = ${stm32_variant.build_flags}
                       -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
                       -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DLERDGE_TFT35
 build_unflags       = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 extra_scripts       = ${common_stm32.extra_scripts}
                       pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
                       buildroot/share/PlatformIO/scripts/lerdge.py
 
 #
 # Lerdge X (STM32F407VE)
 #
 [env:LERDGEX]
-platform            = ${lerdge_common.platform}
 extends             = lerdge_common
 board_build.encrypt = Lerdge_X_firmware_force.bin
 
 #
 # Lerdge X with USB Flash Drive Support
 #
 [env:LERDGEX_usb_flash_drive]
-platform          = ${env:LERDGEX.platform}
 extends           = env:LERDGEX
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # Lerdge S (STM32F407ZG)
 #
 [env:LERDGES]
-platform            = ${lerdge_common.platform}
 extends             = lerdge_common
 board_build.encrypt = Lerdge_firmware_force.bin
 
 #
 # Lerdge S with USB Flash Drive Support
 #
 [env:LERDGES_usb_flash_drive]
-platform          = ${env:LERDGES.platform}
 extends           = env:LERDGES
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # Lerdge K (STM32F407ZG)
 #
 [env:LERDGEK]
-platform            = ${lerdge_common.platform}
 extends             = lerdge_common
 board_build.encrypt = Lerdge_K_firmware_force.bin
 build_flags         = ${lerdge_common.build_flags} -DLERDGEK
 
 #
 # Lerdge K with USB Flash Drive Support
 #
 [env:LERDGEK_usb_flash_drive]
-platform          = ${env:LERDGEK.platform}
 extends           = env:LERDGEK
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # RUMBA32
 #
 [env:rumba32]
-platform             = ${common_stm32.platform}
 extends              = stm32_variant
 board                = rumba32_f446ve
 board_build.variant  = MARLIN_F446VE
 board_build.offset   = 0x0000
 build_flags          = ${stm32_variant.build_flags}
                        -Os -DHAL_PCD_MODULE_ENABLED
                        -DDISABLE_GENERIC_SERIALUSB
                        -DHAL_UART_MODULE_ENABLED
                        -DTIMER_SERIAL=TIM9
 monitor_speed        = 500000
 upload_protocol      = dfu
 
 #
 # MKS Robin Pro V2
 #
 [env:mks_robin_pro2]
-platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 platform_packages           = ${stm_flash_drive.platform_packages}
 board                       = genericSTM32F407VET6
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x0000
 board_upload.offset_address = 0x08000000
 build_flags                 = ${stm_flash_drive.build_flags}
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
 debug_tool                  = jlink
 upload_protocol             = jlink
@@ -433,169 +398,158 @@ upload_protocol             = jlink
 #
 # This I2C1(PB6:I2C1_SCL PB7:I2C1_SDA) is used by Robin Nano V3
 #
 [stm32f4_I2C1]
 build_flags = -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
 
 #
 # MKS Robin Nano V3
 #
 [env:mks_robin_nano_v3]
-platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000
 board_build.rename          = Robin_nano_v3.bin
 build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1.build_flags}
                               -DHAL_PCD_MODULE_ENABLED
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support
 # Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive]
-platform          = ${common_stm32.platform}
 extends           = env:mks_robin_nano_v3
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
                     -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSE_USB_HS_IN_FS
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive_msc]
-platform          = ${common_stm32.platform}
 extends           = env:mks_robin_nano_v3_usb_flash_drive
 build_flags       = ${env:mks_robin_nano_v3_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
 # MKS Eagle
 # 5 TMC2209 uart mode on board
 #
 [env:mks_eagle]
-platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000
 board_build.rename          = mks_eagle.bin
 build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1.build_flags}
                               -DHAL_PCD_MODULE_ENABLED
                               -DSTM32_FLASH_SIZE=512
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # MKS Eagle with USB Flash Drive Support
 # Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_eagle_usb_flash_drive]
-platform          = ${common_stm32.platform}
 extends           = env:mks_eagle
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
                     -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSE_USB_HS_IN_FS
 
 #
 # MKS Eagle with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_eagle_usb_flash_drive_msc]
-platform          = ${common_stm32.platform}
 extends           = env:mks_eagle_usb_flash_drive
 build_flags       = ${env:mks_eagle_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
 # This I2C1(PB8:I2C1_SCL PB9:I2C1_SDA) is used by MKS Monster8
 #
 [stm32f4_I2C1_CAN]
 build_flags = -DPIN_WIRE_SCL=PB8 -DPIN_WIRE_SDA=PB9
 
 #
 # MKS Monster8
 #
 [env:mks_monster8]
-platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000
 board_build.rename          = mks_monster8.bin
 build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1_CAN.build_flags}
                               -DHAL_PCD_MODULE_ENABLED -DTIMER_SERIAL=TIM4
                               -DSTM32_FLASH_SIZE=512
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # MKS Monster8 with USB Flash Drive Support
 # Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_monster8_usb_flash_drive]
-platform          = ${common_stm32.platform}
 extends           = env:mks_monster8
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1_CAN.build_flags}
                     -DUSE_USBHOST_HS
                     -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSE_USB_HS_IN_FS
 
 #
 # MKS Monster8 with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_monster8_usb_flash_drive_msc]
-platform          = ${common_stm32.platform}
 extends           = env:mks_monster8_usb_flash_drive
 build_flags       = ${env:mks_monster8_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
 # TH3D EZBoard v2.0 (STM32F405RGT6 ARM Cortex-M4)
 #
 [env:TH3D_EZBoard_V2]
-platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = genericSTM32F405RG
 board_build.variant = MARLIN_TH3D_EZBOARD_V2
 board_build.offset  = 0xC000
 board_upload.offset_address = 0x0800C000
 build_flags         = ${stm32_variant.build_flags} -DHSE_VALUE=12000000U -O0
 debug_tool          = stlink
 upload_protocol     = stlink
 
 #
 # BOARD_MKS_ROBIN_NANO_V1_3_F4
 #  - MKS Robin Nano   V1.3 (STM32F407VET6) 5 Pololu Plug
 #  - MKS Robin Nano-S V1.3 (STM32F407VET6) 4 TMC2225 + 1 Pololu Plug
 #
 [env:mks_robin_nano_v1_3_f4]
-platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 board_build.rename          = Robin_nano35.bin
 build_flags                 = ${stm32_variant.build_flags}
                               -DMCU_STM32F407VE -DSS_TIMER=4 -DENABLE_HWSERIAL3
                               -DSTM32_FLASH_SIZE=512
                               -DTIMER_TONE=TIM3 -DTIMER_SERVO=TIM2
@@ -603,19 +557,18 @@ build_flags                 = ${stm32_variant.build_flags}
                               -DHAL_SRAM_MODULE_ENABLED
 build_unflags               = ${stm32_variant.build_unflags}
                               -DUSBCON -DUSBD_USE_CDC
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # Artillery Ruby
 #
 [env:Artillery_Ruby]
-platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = marlin_Artillery_Ruby
 build_flags       = ${common_stm32.build_flags}
                     -DSTM32F401xC -DTARGET_STM32F4 -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32
                     -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
                     -DUSB_PRODUCT=\"Artillery_3D_Printer\"
 extra_scripts     = ${common_stm32.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py

commit bfead67544106ec2b3f2ba228a44319ad8510a52
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Sun Dec 5 11:10:29 2021 +1300

    ‚ú® BigTree SKR 2 with F429 (#23177)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 6fec1d46fc..d7c80cf0e9 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -238,20 +238,53 @@ platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_2
 build_flags       = ${env:BIGTREE_SKR_2.build_flags} -DUSBD_USE_CDC_MSC
 build_unflags     = ${env:BIGTREE_SKR_2.build_unflags} -DUSBD_USE_CDC
 
 [env:BIGTREE_SKR_2_USB_debug]
 platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_2_USB
 build_flags       = ${env:BIGTREE_SKR_2_USB.build_flags} -O0
 build_unflags     = ${env:BIGTREE_SKR_2_USB.build_unflags} -Os -NDEBUG
 
+#
+# Bigtreetech SKR V2.0 F429 (STM32F429VGT6 ARM Cortex-M4) with USB Flash Drive Support
+#
+[env:BIGTREE_SKR_2_F429]
+platform                    = ${common_stm32.platform}
+extends                     = stm32_variant
+platform_packages           = ${stm_flash_drive.platform_packages}
+board                       = marlin_STM32F429VGT6
+board_build.variant         = MARLIN_F4x7Vx
+board_build.offset          = 0x8000
+board_upload.offset_address = 0x08008000
+build_flags                 = ${stm_flash_drive.build_flags}
+                              -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS
+                              -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
+                              -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
+                              -DPIN_SERIAL3_RX=PD_9 -DPIN_SERIAL3_TX=PD_8
+upload_protocol             = stlink
+
+#
+# BigTreeTech SKR V2.0 F429 (STM32F429VGT6 ARM Cortex-M4) with USB Media Share Support
+#
+[env:BIGTREE_SKR_2_F429_USB]
+platform          = ${common_stm32.platform}
+extends           = env:BIGTREE_SKR_2_F429
+build_flags       = ${env:BIGTREE_SKR_2_F429.build_flags} -DUSBD_USE_CDC_MSC
+build_unflags     = ${env:BIGTREE_SKR_2_F429.build_unflags} -DUSBD_USE_CDC
+
+[env:BIGTREE_SKR_2_F429_USB_debug]
+platform          = ${common_stm32.platform}
+extends           = env:BIGTREE_SKR_2_F429_USB
+build_flags       = ${env:BIGTREE_SKR_2_F429_USB.build_flags} -O0
+build_unflags     = ${env:BIGTREE_SKR_2_F429_USB.build_unflags} -Os -NDEBUG
+
 #
 # BigTreeTech Octopus V1.0/1.1 / Octopus Pro V1.0 (STM32F446ZET6 ARM Cortex-M4)
 #
 [env:BIGTREE_OCTOPUS_V1]
 platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_BigTree_Octopus_v1
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags}
                      -DSTM32F446_5VX -DUSE_USB_HS_IN_FS

commit cee50552ab4dc3463717920b792a8825a783cd83
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Tue Nov 9 08:30:02 2021 -0800

    ‚ö°Ô∏è BTT002 (STM32F407VET6) variant, MK3_FAN_PINS flag (#23093)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 0e9b507c8b..6fec1d46fc 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -197,20 +197,28 @@ platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_BigTree_BTT002
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags}
                      -DSTM32F407_5VX
                      -DHAVE_HWSERIAL2
                      -DHAVE_HWSERIAL3
                      -DPIN_SERIAL2_RX=PD_6
                      -DPIN_SERIAL2_TX=PD_5
 
+#
+# BigTreeTech BTT002 V1.x with 512k of flash (STM32F407VET6 ARM Cortex-M4)
+#
+[env:BIGTREE_BTT002_VET6]
+platform          = ${env:BIGTREE_BTT002.platform}
+extends           = env:BIGTREE_BTT002
+board             = marlin_BigTree_BTT002_VET6
+
 #
 # BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_2]
 platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 platform_packages           = ${stm_flash_drive.platform_packages}
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x8000

commit 7942f71d26b58630a841f2de2d4f2abaa4120395
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Mon Nov 1 20:23:24 2021 -0700

    ‚ú® Artillery Ruby (STM32F401RCT6) (#23029)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 850807585f..0e9b507c8b 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -557,10 +557,24 @@ board_build.rename          = Robin_nano35.bin
 build_flags                 = ${stm32_variant.build_flags}
                               -DMCU_STM32F407VE -DSS_TIMER=4 -DENABLE_HWSERIAL3
                               -DSTM32_FLASH_SIZE=512
                               -DTIMER_TONE=TIM3 -DTIMER_SERVO=TIM2
                               -DHAL_SD_MODULE_ENABLED
                               -DHAL_SRAM_MODULE_ENABLED
 build_unflags               = ${stm32_variant.build_unflags}
                               -DUSBCON -DUSBD_USE_CDC
 debug_tool                  = jlink
 upload_protocol             = jlink
+
+#
+# Artillery Ruby
+#
+[env:Artillery_Ruby]
+platform          = ${common_stm32.platform}
+extends           = common_stm32
+board             = marlin_Artillery_Ruby
+build_flags       = ${common_stm32.build_flags}
+                    -DSTM32F401xC -DTARGET_STM32F4 -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32
+                    -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+                    -DUSB_PRODUCT=\"Artillery_3D_Printer\"
+extra_scripts     = ${common_stm32.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py

commit efe2e79ac8e6d35e80a7d29bfd266685a82dc546
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Oct 30 23:43:19 2021 -0500

    üî® Help for GDB remote debugging

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 3d7f4d2d02..850807585f 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -213,30 +213,37 @@ extends                     = stm32_variant
 platform_packages           = ${stm_flash_drive.platform_packages}
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 build_flags                 = ${stm_flash_drive.build_flags}
                               -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS
                               -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                               -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
                               -DPIN_SERIAL3_RX=PD_9 -DPIN_SERIAL3_TX=PD_8
+upload_protocol             = stlink
 
 #
 # BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Media Share Support
 #
 [env:BIGTREE_SKR_2_USB]
 platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_2
 build_flags       = ${env:BIGTREE_SKR_2.build_flags} -DUSBD_USE_CDC_MSC
 build_unflags     = ${env:BIGTREE_SKR_2.build_unflags} -DUSBD_USE_CDC
 
+[env:BIGTREE_SKR_2_USB_debug]
+platform          = ${common_stm32.platform}
+extends           = env:BIGTREE_SKR_2_USB
+build_flags       = ${env:BIGTREE_SKR_2_USB.build_flags} -O0
+build_unflags     = ${env:BIGTREE_SKR_2_USB.build_unflags} -Os -NDEBUG
+
 #
 # BigTreeTech Octopus V1.0/1.1 / Octopus Pro V1.0 (STM32F446ZET6 ARM Cortex-M4)
 #
 [env:BIGTREE_OCTOPUS_V1]
 platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_BigTree_Octopus_v1
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags}
                      -DSTM32F446_5VX -DUSE_USB_HS_IN_FS

commit 5d04c7496cec3b8a564ac302da116e3783c4b1d3
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Oct 28 19:22:35 2021 -0500

    üêõ Fix EZBoard V2 board name

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 3e0c400a6b..3d7f4d2d02 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -514,27 +514,27 @@ build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1_CAN.build_flag
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_monster8_usb_flash_drive_msc]
 platform          = ${common_stm32.platform}
 extends           = env:mks_monster8_usb_flash_drive
 build_flags       = ${env:mks_monster8_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
 #
-# TH3D EZBoard Lite v2.0 (STM32F405RGT6 ARM Cortex-M4)
+# TH3D EZBoard v2.0 (STM32F405RGT6 ARM Cortex-M4)
 #
-[env:TH3D_EZBoard_Lite_V2]
+[env:TH3D_EZBoard_V2]
 platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = genericSTM32F405RG
-board_build.variant = MARLIN_TH3D_EZBOARD_LITE_V2
+board_build.variant = MARLIN_TH3D_EZBOARD_V2
 board_build.offset  = 0xC000
 board_upload.offset_address = 0x0800C000
 build_flags         = ${stm32_variant.build_flags} -DHSE_VALUE=12000000U -O0
 debug_tool          = stlink
 upload_protocol     = stlink
 
 #
 # BOARD_MKS_ROBIN_NANO_V1_3_F4
 #  - MKS Robin Nano   V1.3 (STM32F407VET6) 5 Pololu Plug
 #  - MKS Robin Nano-S V1.3 (STM32F407VET6) 4 TMC2225 + 1 Pololu Plug

commit 90716eb7ce6ffd315b923e85a19d3bca65b78ff0
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Sun Oct 24 23:14:02 2021 -0700

    ‚ú® Octopus Pro V1.0 with STM32F429ZGT6 (#23008)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index a6bc125d21..3e0c400a6b 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -248,20 +248,45 @@ build_flags        = ${stm32_variant.build_flags}
 platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_OCTOPUS_V1
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
                     -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
+#
+# BigTreeTech Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4)
+#
+[env:BIGTREE_OCTOPUS_PRO_V1_F429]
+platform           = ${common_stm32.platform}
+extends            = stm32_variant
+board              = marlin_BigTree_Octopus_Pro_v1_F429
+board_build.offset = 0x8000
+build_flags        = ${stm32_variant.build_flags}
+                     -DUSE_USB_HS_IN_FS
+
+#
+# BigTreeTech Octopus Pro V1.0 (STM32F429ZGT6 ARM Cortex-M4) with USB Flash Drive Support
+#
+[env:BIGTREE_OCTOPUS_PRO_V1_F429_USB]
+platform          = ${common_stm32.platform}
+extends           = env:BIGTREE_OCTOPUS_PRO_V1_F429
+platform_packages = ${stm_flash_drive.platform_packages}
+build_unflags     = -DUSBD_USE_CDC
+build_flags       = ${stm_flash_drive.build_flags}
+                    -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
+                    -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5
+                    -DUSBD_IRQ_SUBPRIO=6
+                    -DUSBD_USE_CDC_MSC
+
 #
 # Lerdge base
 #
 [lerdge_common]
 platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_LERDGE
 board_build.offset  = 0x10000
 build_flags         = ${stm32_variant.build_flags}

commit 6cf6c4cd852bd09c509407057e81e37e36bad52e
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Oct 19 02:56:44 2021 -0500

    üî® Delete after encrypt. Lerdge encrypt only once

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index f4968a55e4..a6bc125d21 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -256,27 +256,27 @@ build_flags       = ${stm_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 
 #
 # Lerdge base
 #
 [lerdge_common]
 platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_LERDGE
-board_build.encrypt = firmware.bin
 board_build.offset  = 0x10000
 build_flags         = ${stm32_variant.build_flags}
                       -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
                       -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DLERDGE_TFT35
 build_unflags       = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
-extra_scripts       = ${stm32_variant.extra_scripts}
+extra_scripts       = ${common_stm32.extra_scripts}
+                      pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
                       buildroot/share/PlatformIO/scripts/lerdge.py
 
 #
 # Lerdge X (STM32F407VE)
 #
 [env:LERDGEX]
 platform            = ${lerdge_common.platform}
 extends             = lerdge_common
 board_build.encrypt = Lerdge_X_firmware_force.bin
 

commit d3a84bc584875dc3e022f2d9fd8065207caef204
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Mon Oct 18 00:51:01 2021 -0700

    ‚ú®  BTT Octopus Pro V1.0 (STM32F446ZET6) (#22971)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 4544bf56a0..f4968a55e4 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -224,32 +224,32 @@ build_flags                 = ${stm_flash_drive.build_flags}
 #
 # BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Media Share Support
 #
 [env:BIGTREE_SKR_2_USB]
 platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_2
 build_flags       = ${env:BIGTREE_SKR_2.build_flags} -DUSBD_USE_CDC_MSC
 build_unflags     = ${env:BIGTREE_SKR_2.build_unflags} -DUSBD_USE_CDC
 
 #
-# BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4)
+# BigTreeTech Octopus V1.0/1.1 / Octopus Pro V1.0 (STM32F446ZET6 ARM Cortex-M4)
 #
 [env:BIGTREE_OCTOPUS_V1]
 platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_BigTree_Octopus_v1
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags}
                      -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
 
 #
-# BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
+# BigTreeTech Octopus V1.0/1.1 / Octopus Pro V1.0 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_OCTOPUS_V1_USB]
 platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_OCTOPUS_V1
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
                     -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6

commit 0d41667bc2c3895ea8e3ed28435f42ffa106f44f
Author: George Fu <nailao_5918@163.com>
Date:   Wed Oct 13 09:32:54 2021 +0800

    üêõ Fix FYSETC Cheetah v2.0 build (#22926)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 95e6ff6a35..4544bf56a0 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -41,21 +41,21 @@ build_flags       = ${stm32_variant.build_flags}
                     -DSTM32F401xE -DDISABLE_GENERIC_SERIALUSB
                     -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 
 #
 # STM32F401RC
 #
 [env:FYSETC_CHEETAH_V20]
 platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_FYSETC_CHEETAH_V20
-board_build.offset = 0xC000
+board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags} -DSTM32F401xC
 
 #
 # FLYF407ZG
 #
 [env:FLYF407ZG]
 platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_FLY_F407ZG

commit a7519ecca92cbaa3e3c4cc28dcb19911bf5115b0
Author: mks-viva <1224833100@qq.com>
Date:   Tue Oct 12 20:01:18 2021 -0500

    ‚ú® MKS Eagle (STM32F407VET6) board (#22897)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 7ff0443df6..95e6ff6a35 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -397,39 +397,83 @@ build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
 # MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive_msc]
 platform          = ${common_stm32.platform}
 extends           = env:mks_robin_nano_v3_usb_flash_drive
 build_flags       = ${env:mks_robin_nano_v3_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
 
+#
+# MKS Eagle
+# 5 TMC2209 uart mode on board
+#
+[env:mks_eagle]
+platform                    = ${common_stm32.platform}
+extends                     = stm32_variant
+board                       = marlin_STM32F407VGT6_CCM
+board_build.variant         = MARLIN_F4x7Vx
+board_build.offset          = 0xC000
+board_upload.offset_address = 0x0800C000
+board_build.rename          = mks_eagle.bin
+build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1.build_flags}
+                              -DHAL_PCD_MODULE_ENABLED
+                              -DSTM32_FLASH_SIZE=512
+debug_tool                  = jlink
+upload_protocol             = jlink
+
+#
+# MKS Eagle with USB Flash Drive Support
+# Currently, using a STM32duino fork, until USB Host get merged
+#
+[env:mks_eagle_usb_flash_drive]
+platform          = ${common_stm32.platform}
+extends           = env:mks_eagle
+platform_packages = ${stm_flash_drive.platform_packages}
+build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
+                    -DUSE_USBHOST_HS
+                    -DUSBD_IRQ_PRIO=5
+                    -DUSBD_IRQ_SUBPRIO=6
+                    -DUSE_USB_HS_IN_FS
+
+#
+# MKS Eagle with USB Flash Drive Support and Shared Media
+# Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
+#
+[env:mks_eagle_usb_flash_drive_msc]
+platform          = ${common_stm32.platform}
+extends           = env:mks_eagle_usb_flash_drive
+build_flags       = ${env:mks_eagle_usb_flash_drive.build_flags}
+                    -DUSBD_USE_CDC_MSC
+build_unflags     = -DUSBD_USE_CDC
+
 #
 # This I2C1(PB8:I2C1_SCL PB9:I2C1_SDA) is used by MKS Monster8
 #
 [stm32f4_I2C1_CAN]
 build_flags = -DPIN_WIRE_SCL=PB8 -DPIN_WIRE_SDA=PB9
 
 #
 # MKS Monster8
 #
 [env:mks_monster8]
 platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000
 board_build.rename          = mks_monster8.bin
 build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1_CAN.build_flags}
                               -DHAL_PCD_MODULE_ENABLED -DTIMER_SERIAL=TIM4
+                              -DSTM32_FLASH_SIZE=512
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # MKS Monster8 with USB Flash Drive Support
 # Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_monster8_usb_flash_drive]
 platform          = ${common_stm32.platform}
 extends           = env:mks_monster8

commit a1e1555ea1e4a5bb0dabc027b56ffb9fc05739e3
Author: mks-viva <1224833100@qq.com>
Date:   Wed Sep 15 14:47:23 2021 -0500

    üêõ Fix MKS Monster8 EEPROM issue (serial timer) (#22777)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index c8f8676b68..7ff0443df6 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -415,21 +415,21 @@ build_flags = -DPIN_WIRE_SCL=PB8 -DPIN_WIRE_SDA=PB9
 #
 [env:mks_monster8]
 platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0xC000
 board_upload.offset_address = 0x0800C000
 board_build.rename          = mks_monster8.bin
 build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1_CAN.build_flags}
-                              -DHAL_PCD_MODULE_ENABLED
+                              -DHAL_PCD_MODULE_ENABLED -DTIMER_SERIAL=TIM4
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # MKS Monster8 with USB Flash Drive Support
 # Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_monster8_usb_flash_drive]
 platform          = ${common_stm32.platform}
 extends           = env:mks_monster8

commit 24460052d245bc9b56813aab67d52a96a858e034
Author: mks-viva <1224833100@qq.com>
Date:   Sun Sep 12 21:30:09 2021 -0500

    ‚ú® MKS Robin Nano V1.3 (STM32F407VET6) (#22749)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 84256d3be9..c8f8676b68 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -457,10 +457,34 @@ build_unflags     = -DUSBD_USE_CDC
 [env:TH3D_EZBoard_Lite_V2]
 platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = genericSTM32F405RG
 board_build.variant = MARLIN_TH3D_EZBOARD_LITE_V2
 board_build.offset  = 0xC000
 board_upload.offset_address = 0x0800C000
 build_flags         = ${stm32_variant.build_flags} -DHSE_VALUE=12000000U -O0
 debug_tool          = stlink
 upload_protocol     = stlink
+
+#
+# BOARD_MKS_ROBIN_NANO_V1_3_F4
+#  - MKS Robin Nano   V1.3 (STM32F407VET6) 5 Pololu Plug
+#  - MKS Robin Nano-S V1.3 (STM32F407VET6) 4 TMC2225 + 1 Pololu Plug
+#
+[env:mks_robin_nano_v1_3_f4]
+platform                    = ${common_stm32.platform}
+extends                     = stm32_variant
+board                       = marlin_STM32F407VGT6_CCM
+board_build.variant         = MARLIN_F4x7Vx
+board_build.offset          = 0x8000
+board_upload.offset_address = 0x08008000
+board_build.rename          = Robin_nano35.bin
+build_flags                 = ${stm32_variant.build_flags}
+                              -DMCU_STM32F407VE -DSS_TIMER=4 -DENABLE_HWSERIAL3
+                              -DSTM32_FLASH_SIZE=512
+                              -DTIMER_TONE=TIM3 -DTIMER_SERVO=TIM2
+                              -DHAL_SD_MODULE_ENABLED
+                              -DHAL_SRAM_MODULE_ENABLED
+build_unflags               = ${stm32_variant.build_unflags}
+                              -DUSBCON -DUSBD_USE_CDC
+debug_tool                  = jlink
+upload_protocol             = jlink

commit 76fb131f14dfc4108c4f6491d84827b8813d3973
Author: Justin Nesselrotte <admin@jnesselr.org>
Date:   Sun Sep 5 14:21:45 2021 -0600

    ‚ú® Index Pick-and-Place board Rev.3 (#22647)
    
    Co-authored-by: Gon√ßalo Pereira <goncalo_pereira@outlook.pt>
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 6870345121..84256d3be9 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -92,20 +92,32 @@ upload_command              = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 # 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
 platform          = ${common_stm32.platform}
 extends           = stm32_variant
 board             = marlin_blackSTM32F407VET6
 build_flags       = ${stm32_variant.build_flags}
                     -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 
+#
+# STM32F407VET6 Index Mobo Rev 03
+#
+[env:Index_Mobo_Rev03]
+platform          = ${common_stm32.platform}
+extends           = stm32_variant
+board             = marlin_index_mobo_rev03
+build_flags       = ${stm32_variant.build_flags}
+  -DARDUINO_BLACK_F407VE
+  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+extra_scripts     = ${stm32_variant.extra_scripts}
+
 #
 # Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
 # For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
 # Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
 #
 [env:Anet_ET4_OpenBLT]
 platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx

commit 71a2a958858f47545bb9f02764af26fb68991b36
Author: Tanguy Pruvot <tpruvot@users.noreply.github.com>
Date:   Thu Sep 2 01:55:36 2021 +0200

    üî® Enhance Lerdge pins, TFTs, and variants (#22658)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 29dd933078..6870345121 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -248,62 +248,61 @@ build_flags       = ${stm_flash_drive.build_flags}
 #
 [lerdge_common]
 platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_LERDGE
 board_build.encrypt = firmware.bin
 board_build.offset  = 0x10000
 build_flags         = ${stm32_variant.build_flags}
                       -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
-                      -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
-                      -DHAL_SRAM_MODULE_ENABLED
+                      -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DLERDGE_TFT35
 build_unflags       = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 extra_scripts       = ${stm32_variant.extra_scripts}
                       buildroot/share/PlatformIO/scripts/lerdge.py
 
 #
-# Lerdge X
+# Lerdge X (STM32F407VE)
 #
 [env:LERDGEX]
 platform            = ${lerdge_common.platform}
 extends             = lerdge_common
 board_build.encrypt = Lerdge_X_firmware_force.bin
 
 #
 # Lerdge X with USB Flash Drive Support
 #
 [env:LERDGEX_usb_flash_drive]
 platform          = ${env:LERDGEX.platform}
 extends           = env:LERDGEX
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
-# Lerdge S
+# Lerdge S (STM32F407ZG)
 #
 [env:LERDGES]
 platform            = ${lerdge_common.platform}
 extends             = lerdge_common
 board_build.encrypt = Lerdge_firmware_force.bin
 
 #
 # Lerdge S with USB Flash Drive Support
 #
 [env:LERDGES_usb_flash_drive]
 platform          = ${env:LERDGES.platform}
 extends           = env:LERDGES
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
-# Lerdge K
+# Lerdge K (STM32F407ZG)
 #
 [env:LERDGEK]
 platform            = ${lerdge_common.platform}
 extends             = lerdge_common
 board_build.encrypt = Lerdge_K_firmware_force.bin
 build_flags         = ${lerdge_common.build_flags} -DLERDGEK
 
 #
 # Lerdge K with USB Flash Drive Support
 #

commit 8cf7dc960fbc78b7c9339d30372289d8c1bb0303
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue Aug 24 14:55:12 2021 -0500

    ‚ú® New board TH3D_EZBOARD_LITE_V2 (#22621)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index e2e93eaa43..29dd933078 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -432,10 +432,24 @@ build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1_CAN.build_flag
 #
 # MKS Monster8 with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_monster8_usb_flash_drive_msc]
 platform          = ${common_stm32.platform}
 extends           = env:mks_monster8_usb_flash_drive
 build_flags       = ${env:mks_monster8_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
 build_unflags     = -DUSBD_USE_CDC
+
+#
+# TH3D EZBoard Lite v2.0 (STM32F405RGT6 ARM Cortex-M4)
+#
+[env:TH3D_EZBoard_Lite_V2]
+platform            = ${common_stm32.platform}
+extends             = stm32_variant
+board               = genericSTM32F405RG
+board_build.variant = MARLIN_TH3D_EZBOARD_LITE_V2
+board_build.offset  = 0xC000
+board_upload.offset_address = 0x0800C000
+build_flags         = ${stm32_variant.build_flags} -DHSE_VALUE=12000000U -O0
+debug_tool          = stlink
+upload_protocol     = stlink

commit feb6d2887eee1b31713ef0ad665b166c8fe6e70b
Author: BigTreeTech <38851044+bigtreetech@users.noreply.github.com>
Date:   Fri Aug 13 12:26:26 2021 +0800

    üêõ Fix some BTT SKR2 pins (#22558)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 62ac89d9fa..e2e93eaa43 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -200,20 +200,21 @@ platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 platform_packages           = ${stm_flash_drive.platform_packages}
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 build_flags                 = ${stm_flash_drive.build_flags}
                               -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS
                               -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
                               -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
+                              -DPIN_SERIAL3_RX=PD_9 -DPIN_SERIAL3_TX=PD_8
 
 #
 # BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Media Share Support
 #
 [env:BIGTREE_SKR_2_USB]
 platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_2
 build_flags       = ${env:BIGTREE_SKR_2.build_flags} -DUSBD_USE_CDC_MSC
 build_unflags     = ${env:BIGTREE_SKR_2.build_unflags} -DUSBD_USE_CDC
 

commit 76c10b3e02aa5a699ee68a36663337de60fea4e8
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Aug 8 21:31:10 2021 -0500

    üèóÔ∏è Define HAL_STM32 for HAL/STM32 (#22537)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index b32efb83a9..62ac89d9fa 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -3,21 +3,21 @@
 # PlatformIO Configuration File
 #
 
 #################################
 #
 # STM32F4 Architecture
 #
 # Naming Example: STM32F401RGT6
 #
 #   F : Foundation (sometimes High Performance F2/F4)
-#   4 : Cortex M4 core
+#   4 : Cortex M4 core (0:M0, 1-2:M3, 3-4:M4, 7:M7)
 #  01 : Line/Features
 #   R : 64 or 66 pins  (T:36, C:48 or 49, M:81, V:100, Z:144, I:176)
 #   G : 1024KB Flash-memory  (B:128KB, C:256KB, D:384KB, E:512KB)
 #   T : LQFP package
 #   6 : -40...85¬∞C   (7: ...105¬∞C)
 #
 #################################
 
 #
 # ARMED (STM32)

commit e7c33840dca804c5c41ca6ce8888bfa16f8c1a47
Author: ellensp <530024+ellensp@users.noreply.github.com>
Date:   Sat Aug 7 08:54:02 2021 +1200

    üêõ Fix MKS 'USB Flash MSC' environments (#22515)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index d2332630a1..b32efb83a9 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -381,22 +381,23 @@ build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSE_USB_HS_IN_FS
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive_msc]
 platform          = ${common_stm32.platform}
 extends           = env:mks_robin_nano_v3_usb_flash_drive
-build_flags       = ${env:mks_robin_nano_v3_usb_flash_drive}
+build_flags       = ${env:mks_robin_nano_v3_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
+build_unflags     = -DUSBD_USE_CDC
 
 #
 # This I2C1(PB8:I2C1_SCL PB9:I2C1_SDA) is used by MKS Monster8
 #
 [stm32f4_I2C1_CAN]
 build_flags = -DPIN_WIRE_SCL=PB8 -DPIN_WIRE_SDA=PB9
 
 #
 # MKS Monster8
 #
@@ -427,12 +428,13 @@ build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1_CAN.build_flag
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSE_USB_HS_IN_FS
 
 #
 # MKS Monster8 with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_monster8_usb_flash_drive_msc]
 platform          = ${common_stm32.platform}
 extends           = env:mks_monster8_usb_flash_drive
-build_flags       = ${env:mks_monster8_usb_flash_drive}
+build_flags       = ${env:mks_monster8_usb_flash_drive.build_flags}
                     -DUSBD_USE_CDC_MSC
+build_unflags     = -DUSBD_USE_CDC

commit 381a23773b5be40cf221c42b3139e7ee5f07687b
Author: ldursw <37294448+ldursw@users.noreply.github.com>
Date:   Sun Aug 1 00:42:26 2021 -0300

    üî® Fix (RRF E3) RX/TX buffer size override (#22475)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 2d3b5a0f32..d2332630a1 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -145,25 +145,24 @@ build_unflags     = ${env:BIGTREE_SKR_PRO.build_unflags} -DUSBCON -DUSBD_USE_CDC
 
 #
 # BigTreeTech E3 RRF (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_E3_RRF]
 platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = marlin_STM32F407VGT6_CCM
 board_build.variant = MARLIN_BIGTREE_E3_RRF
 board_build.offset  = 0x8000
-extra_scripts       = ${common.extra_scripts}
 build_flags         = ${stm32_variant.build_flags}
                       -DSTM32F407_5VX
-                      -DSERIAL_RX_BUFFER_SIZE=255
-                      -DSERIAL_TX_BUFFER_SIZE=255
+                      -DMF_RX_BUFFER_SIZE=255
+                      -DMF_TX_BUFFER_SIZE=255
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_GTR_V1_0]
 platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_BigTree_GTR_v1
 board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags} -DSTM32F407IX

commit 332dde935d58906e31a2e5f6d03e280f7c9c0919
Author: mks-viva <1224833100@qq.com>
Date:   Sat Jul 31 00:47:30 2021 -0500

    ‚ú® MKS Monster8 board (#22455)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 2b77bf2e3c..2d3b5a0f32 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -340,36 +340,36 @@ platform_packages           = ${stm_flash_drive.platform_packages}
 board                       = genericSTM32F407VET6
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0x0000
 board_upload.offset_address = 0x08000000
 build_flags                 = ${stm_flash_drive.build_flags}
 build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
-# This SPI is used by Robin Nano V3
+# This I2C1(PB6:I2C1_SCL PB7:I2C1_SDA) is used by Robin Nano V3
 #
 [stm32f4_I2C1]
 build_flags = -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
 
 #
 # MKS Robin Nano V3
 #
 [env:mks_robin_nano_v3]
 platform                    = ${common_stm32.platform}
 extends                     = stm32_variant
 board                       = marlin_STM32F407VGT6_CCM
 board_build.variant         = MARLIN_F4x7Vx
 board_build.offset          = 0xC000
-board_build.rename          = Robin_nano_v3.bin
 board_upload.offset_address = 0x0800C000
+board_build.rename          = Robin_nano_v3.bin
 build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1.build_flags}
                               -DHAL_PCD_MODULE_ENABLED
 debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support
 # Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive]
@@ -384,10 +384,56 @@ build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive_msc]
 platform          = ${common_stm32.platform}
 extends           = env:mks_robin_nano_v3_usb_flash_drive
 build_flags       = ${env:mks_robin_nano_v3_usb_flash_drive}
                     -DUSBD_USE_CDC_MSC
+
+#
+# This I2C1(PB8:I2C1_SCL PB9:I2C1_SDA) is used by MKS Monster8
+#
+[stm32f4_I2C1_CAN]
+build_flags = -DPIN_WIRE_SCL=PB8 -DPIN_WIRE_SDA=PB9
+
+#
+# MKS Monster8
+#
+[env:mks_monster8]
+platform                    = ${common_stm32.platform}
+extends                     = stm32_variant
+board                       = marlin_STM32F407VGT6_CCM
+board_build.variant         = MARLIN_F4x7Vx
+board_build.offset          = 0xC000
+board_upload.offset_address = 0x0800C000
+board_build.rename          = mks_monster8.bin
+build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1_CAN.build_flags}
+                              -DHAL_PCD_MODULE_ENABLED
+debug_tool                  = jlink
+upload_protocol             = jlink
+
+#
+# MKS Monster8 with USB Flash Drive Support
+# Currently, using a STM32duino fork, until USB Host get merged
+#
+[env:mks_monster8_usb_flash_drive]
+platform          = ${common_stm32.platform}
+extends           = env:mks_monster8
+platform_packages = ${stm_flash_drive.platform_packages}
+build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1_CAN.build_flags}
+                    -DUSE_USBHOST_HS
+                    -DUSBD_IRQ_PRIO=5
+                    -DUSBD_IRQ_SUBPRIO=6
+                    -DUSE_USB_HS_IN_FS
+
+#
+# MKS Monster8 with USB Flash Drive Support and Shared Media
+# Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
+#
+[env:mks_monster8_usb_flash_drive_msc]
+platform          = ${common_stm32.platform}
+extends           = env:mks_monster8_usb_flash_drive
+build_flags       = ${env:mks_monster8_usb_flash_drive}
+                    -DUSBD_USE_CDC_MSC

commit 1fed25c44020224c9499eac73422657b53783e74
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Fri Jul 30 19:39:38 2021 -0500

    üî® Fix: BIGTREE_E3_RRF doesn't use user RX/TX sizes
    
    Fixes #22466. Regression from #22377.

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 04fd03bf72..2b77bf2e3c 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -145,20 +145,21 @@ build_unflags     = ${env:BIGTREE_SKR_PRO.build_unflags} -DUSBCON -DUSBD_USE_CDC
 
 #
 # BigTreeTech E3 RRF (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_E3_RRF]
 platform            = ${common_stm32.platform}
 extends             = stm32_variant
 board               = marlin_STM32F407VGT6_CCM
 board_build.variant = MARLIN_BIGTREE_E3_RRF
 board_build.offset  = 0x8000
+extra_scripts       = ${common.extra_scripts}
 build_flags         = ${stm32_variant.build_flags}
                       -DSTM32F407_5VX
                       -DSERIAL_RX_BUFFER_SIZE=255
                       -DSERIAL_TX_BUFFER_SIZE=255
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_GTR_V1_0]
 platform           = ${common_stm32.platform}

commit 91db6038930528b06913a40884355d85c7550d70
Author: George Fu <nailao_5918@163.com>
Date:   Sun Jul 25 16:40:43 2021 +0800

    üî® Fix FYSETC S6 envs (#22421)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 901f145113..04fd03bf72 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -75,21 +75,21 @@ build_flags                 = ${stm32_variant.build_flags} -DHAL_PCD_MODULE_ENAB
 debug_tool                  = stlink
 upload_protocol             = dfu
 upload_command              = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
 
 #
 # FYSETC S6 new bootloader
 #
 [env:FYSETC_S6_8000]
 platform                    = ${common_stm32.platform}
 extends                     = env:FYSETC_S6
-board                       = marlin_fysetc_s6_8000
+board                       = marlin_fysetc_s6
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 upload_command              = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 
 #
 # STM32F407VET6 with RAMPS-like shield
 # 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]

commit eb2f086522c0befd3628693250ba56fe56a1a7a1
Author: Luke Harrison <looxonline@gmail.com>
Date:   Wed Jul 21 07:43:33 2021 +0200

    üîß Octopus SPI display pins, fix USB build env (#22412)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index f9c16cf455..901f145113 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -122,21 +122,21 @@ debug_tool                  = jlink
 upload_protocol             = jlink
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
 platform           = ${common_stm32.platform}
 extends            = stm32_variant
 board              = marlin_BigTree_SKR_Pro
 board_build.offset = 0x8000
-build_flags        = ${stm32_variant.build_flags} -DSTM32F407_5ZX 
+build_flags        = ${stm32_variant.build_flags} -DSTM32F407_5ZX
 debug_tool         = stlink
 upload_protocol    = stlink
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_PRO_usb_flash_drive]
 platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_PRO
 platform_packages = ${stm_flash_drive.platform_packages}
@@ -228,20 +228,21 @@ board_build.offset = 0x8000
 build_flags        = ${stm32_variant.build_flags}
                      -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_OCTOPUS_V1_USB]
 platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_OCTOPUS_V1
 platform_packages = ${stm_flash_drive.platform_packages}
+build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
                     -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
                     -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5
                     -DUSBD_IRQ_SUBPRIO=6
                     -DUSBD_USE_CDC_MSC
 
 #
 # Lerdge base
 #
 [lerdge_common]

commit da0450605a31626f423808c4842256671152c489
Author: Katelyn Schiesser <katelyn.schiesser@gmail.com>
Date:   Tue Jul 20 12:20:28 2021 -0700

    ‚ôªÔ∏è Refactor STM32 ini files (#22377)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index ada6605e07..f9c16cf455 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -5,289 +5,266 @@
 
 #################################
 #
 # STM32F4 Architecture
 #
 # Naming Example: STM32F401RGT6
 #
 #   F : Foundation (sometimes High Performance F2/F4)
 #   4 : Cortex M4 core
 #  01 : Line/Features
-#   R : 64 or 66 pins  (V:100, Z:144, I:176)
-#   G : 1024KB Flash-memory  (C:256KB, D:384KB, E:512KB)
+#   R : 64 or 66 pins  (T:36, C:48 or 49, M:81, V:100, Z:144, I:176)
+#   G : 1024KB Flash-memory  (B:128KB, C:256KB, D:384KB, E:512KB)
 #   T : LQFP package
 #   6 : -40...85¬∞C   (7: ...105¬∞C)
 #
 #################################
 
 #
 # ARMED (STM32)
 #
 [env:ARMED]
 platform      = ${common_stm32.platform}
 extends       = common_stm32
 board         = armed_v1
 build_flags   = ${common_stm32.build_flags}
-  -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
-
-[stm32f4_variant]
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/offset_and_rename.py
+                -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
 
 #
 # STM32F401VE
 # 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
 #
 [env:STM32F401VE_STEVAL]
 platform          = ${common_stm32.platform}
-extends           = common_stm32
+extends           = stm32_variant
 board             = marlin_STEVAL_STM32F401VE
-build_flags       = ${common_stm32.build_flags}
-  -DARDUINO_STEVAL -DSTM32F401xE
-  -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-extra_scripts     = ${stm32f4_variant.extra_scripts}
+build_flags       = ${stm32_variant.build_flags}
+                    -DSTM32F401xE -DDISABLE_GENERIC_SERIALUSB
+                    -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 
 #
 # STM32F401RC
 #
 [env:FYSETC_CHEETAH_V20]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = marlin_FYSETC_CHEETAH_V20
-build_flags       = ${common_stm32.build_flags} -DSTM32F401xC -DVECT_TAB_OFFSET=0xC000
-extra_scripts     = ${stm32f4_variant.extra_scripts}
+platform           = ${common_stm32.platform}
+extends            = stm32_variant
+board              = marlin_FYSETC_CHEETAH_V20
+board_build.offset = 0xC000
+build_flags        = ${stm32_variant.build_flags} -DSTM32F401xC
 
 #
 # FLYF407ZG
 #
 [env:FLYF407ZG]
 platform            = ${common_stm32.platform}
-extends             = common_stm32
+extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_FLY_F407ZG
+board_build.offset  = 0x8000
 upload_protocol     = dfu
-build_flags         = ${common_stm32.build_flags}
-  -DVECT_TAB_OFFSET=0x8000
-extra_scripts       = ${stm32f4_variant.extra_scripts}
 
 #
 # FYSETC S6 (STM32F446RET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-platform_packages = tool-stm32duino
-board             = marlin_fysetc_s6
-build_flags       = ${common_stm32.build_flags} -DVECT_TAB_OFFSET=0x10000 -DHAL_PCD_MODULE_ENABLED
-extra_scripts     = ${stm32f4_variant.extra_scripts}
-debug_tool        = stlink
-upload_protocol   = dfu
-upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
+platform                    = ${common_stm32.platform}
+extends                     = stm32_variant
+board                       = marlin_fysetc_s6
+board_build.offset          = 0x10000
+board_upload.offset_address = 0x08010000
+build_flags                 = ${stm32_variant.build_flags} -DHAL_PCD_MODULE_ENABLED
+debug_tool                  = stlink
+upload_protocol             = dfu
+upload_command              = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
 
 #
 # FYSETC S6 new bootloader
 #
 [env:FYSETC_S6_8000]
 platform                    = ${common_stm32.platform}
 extends                     = env:FYSETC_S6
 board                       = marlin_fysetc_s6_8000
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
-build_flags                 = ${common_stm32.build_flags} -DHAL_PCD_MODULE_ENABLED
-extra_scripts               = ${stm32f4_variant.extra_scripts}
 upload_command              = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 
 #
 # STM32F407VET6 with RAMPS-like shield
 # 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
 platform          = ${common_stm32.platform}
-extends           = common_stm32
+extends           = stm32_variant
 board             = marlin_blackSTM32F407VET6
-build_flags       = ${common_stm32.build_flags}
-  -DARDUINO_BLACK_F407VE
-  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-extra_scripts     = ${stm32f4_variant.extra_scripts}
+build_flags       = ${stm32_variant.build_flags}
+                    -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 
 #
 # Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
 # For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
 # Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
 #
 [env:Anet_ET4_OpenBLT]
-platform             = ${common_stm32.platform}
-extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
-board                = marlin_STM32F407VGT6_CCM
-board_build.core     = stm32
-board_build.variant  = MARLIN_F4x7Vx
-board_build.encrypt  = firmware.srec
-board_build.offset   = 0x10000
+platform                    = ${common_stm32.platform}
+extends                     = stm32_variant
+board                       = marlin_STM32F407VGT6_CCM
+board_build.variant         = MARLIN_F4x7Vx
+board_build.encrypt         = firmware.srec
+board_build.offset          = 0x10000
 board_upload.offset_address = 0x08010000
-build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
-debug_tool           = jlink
-upload_protocol      = jlink
-extra_scripts        = ${stm32f4_variant.extra_scripts}
-  buildroot/share/PlatformIO/scripts/openblt.py
+build_flags                 = ${stm32_variant.build_flags}
+                              -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
+build_unflags               = ${stm32_variant.build_unflags}
+                              -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
+extra_scripts               = ${stm32_variant.extra_scripts}
+                              buildroot/share/PlatformIO/scripts/openblt.py
+debug_tool                  = jlink
+upload_protocol             = jlink
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = marlin_BigTree_SKR_Pro
-build_flags       = ${common_stm32.build_flags}
-  -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
-extra_scripts     = ${stm32f4_variant.extra_scripts}
-#upload_protocol   = stlink
-#upload_command    = "$PROJECT_PACKAGES_DIR/tool-stm32duino/stlink/ST-LINK_CLI.exe" -c SWD -P "$BUILD_DIR/firmware.bin" 0x8008000 -Rst -Run
-debug_tool        = stlink
-debug_init_break  =
-
-#
-# USB Flash Drive mix-ins for STM32
-#
-[stm_flash_drive]
-platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc-3.zip
-build_flags       = ${common_stm32.build_flags}
-  -DHAL_PCD_MODULE_ENABLED -DHAL_HCD_MODULE_ENABLED
-  -DUSBHOST -DUSBH_IRQ_PRIO=3 -DUSBH_IRQ_SUBPRIO=4
+platform           = ${common_stm32.platform}
+extends            = stm32_variant
+board              = marlin_BigTree_SKR_Pro
+board_build.offset = 0x8000
+build_flags        = ${stm32_variant.build_flags} -DSTM32F407_5ZX 
+debug_tool         = stlink
+upload_protocol    = stlink
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_PRO_usb_flash_drive]
+platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_PRO
 platform_packages = ${stm_flash_drive.platform_packages}
-build_unflags     = -DUSBCON -DUSBD_USE_CDC
-build_flags       = ${stm_flash_drive.build_flags}
-  -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
+build_flags       = ${stm_flash_drive.build_flags} -DSTM32F407_5ZX
+build_unflags     = ${env:BIGTREE_SKR_PRO.build_unflags} -DUSBCON -DUSBD_USE_CDC
 
 #
 # BigTreeTech E3 RRF (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_E3_RRF]
 platform            = ${common_stm32.platform}
-extends             = common_stm32
+extends             = stm32_variant
 board               = marlin_STM32F407VGT6_CCM
 board_build.variant = MARLIN_BIGTREE_E3_RRF
-build_flags         = ${common_stm32.build_flags}
-  -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
-  -DSERIAL_RX_BUFFER_SIZE=255 -DSERIAL_TX_BUFFER_SIZE=255
-extra_scripts       = ${stm32f4_variant.extra_scripts}
+board_build.offset  = 0x8000
+build_flags         = ${stm32_variant.build_flags}
+                      -DSTM32F407_5VX
+                      -DSERIAL_RX_BUFFER_SIZE=255
+                      -DSERIAL_TX_BUFFER_SIZE=255
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_GTR_V1_0]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = marlin_BigTree_GTR_v1
-extra_scripts     = ${stm32f4_variant.extra_scripts}
-build_flags       = ${common_stm32.build_flags}
-  -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
+platform           = ${common_stm32.platform}
+extends            = stm32_variant
+board              = marlin_BigTree_GTR_v1
+board_build.offset = 0x8000
+build_flags        = ${stm32_variant.build_flags} -DSTM32F407IX
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_GTR_V1_0_usb_flash_drive]
+platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_GTR_V1_0
 platform_packages = ${stm_flash_drive.platform_packages}
-build_unflags     = -DUSBCON -DUSBD_USE_CDC
-build_flags       = ${stm_flash_drive.build_flags}
-  -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
+build_flags       = ${stm_flash_drive.build_flags} -DSTM32F407IX
+build_unflags     = ${env:BIGTREE_GTR_V1_0.build_unflags} -DUSBCON -DUSBD_USE_CDC
 
 #
 # BigTreeTech BTT002 V1.0 (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = marlin_BigTree_BTT002
-build_flags       = ${common_stm32.build_flags}
-  -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
-  -DHAVE_HWSERIAL2
-  -DHAVE_HWSERIAL3
-  -DPIN_SERIAL2_RX=PD_6
-  -DPIN_SERIAL2_TX=PD_5
-extra_scripts     = ${stm32f4_variant.extra_scripts}
+platform           = ${common_stm32.platform}
+extends            = stm32_variant
+board              = marlin_BigTree_BTT002
+board_build.offset = 0x8000
+build_flags        = ${stm32_variant.build_flags}
+                     -DSTM32F407_5VX
+                     -DHAVE_HWSERIAL2
+                     -DHAVE_HWSERIAL3
+                     -DPIN_SERIAL2_RX=PD_6
+                     -DPIN_SERIAL2_TX=PD_5
 
 #
 # BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_2]
-platform             = ${common_stm32.platform}
-platform_packages    = ${stm_flash_drive.platform_packages}
-extends              = common_stm32
-board                = marlin_STM32F407VGT6_CCM
-board_build.core     = stm32
-board_build.variant  = MARLIN_F4x7Vx
-board_build.offset   = 0x8000
+platform                    = ${common_stm32.platform}
+extends                     = stm32_variant
+platform_packages           = ${stm_flash_drive.platform_packages}
+board                       = marlin_STM32F407VGT6_CCM
+board_build.variant         = MARLIN_F4x7Vx
+board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
-extra_scripts        = ${stm32f4_variant.extra_scripts}
-build_flags          = ${stm_flash_drive.build_flags}
-  -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
-  -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
+build_flags                 = ${stm_flash_drive.build_flags}
+                              -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS
+                              -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
+                              -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
 
 #
 # BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Media Share Support
 #
 [env:BIGTREE_SKR_2_USB]
 platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_2
-platform_packages = ${stm_flash_drive.platform_packages}
-build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${env:BIGTREE_SKR_2.build_flags} -DUSBD_USE_CDC_MSC
+build_unflags     = ${env:BIGTREE_SKR_2.build_unflags} -DUSBD_USE_CDC
 
 #
 # BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4)
 #
 [env:BIGTREE_OCTOPUS_V1]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = marlin_BigTree_Octopus_v1
-extra_scripts     = ${stm32f4_variant.extra_scripts}
-build_flags       = ${common_stm32.build_flags}
-  -DSTM32F446_5VX -DVECT_TAB_OFFSET=0x8000 -DUSE_USB_HS_IN_FS
+platform           = ${common_stm32.platform}
+extends            = stm32_variant
+board              = marlin_BigTree_Octopus_v1
+board_build.offset = 0x8000
+build_flags        = ${stm32_variant.build_flags}
+                     -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_OCTOPUS_V1_USB]
+platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_OCTOPUS_V1
 platform_packages = ${stm_flash_drive.platform_packages}
-#build_unflags     = -DUSBCON -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
-  -DSTM32F446_5VX -DVECT_TAB_OFFSET=0x8000
-  -DUSBCON -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6 -DUSE_USB_HS_IN_FS -DUSBD_USE_CDC_MSC
+                    -DSTM32F446_5VX -DUSE_USB_HS_IN_FS
+                    -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5
+                    -DUSBD_IRQ_SUBPRIO=6
+                    -DUSBD_USE_CDC_MSC
 
 #
 # Lerdge base
 #
 [lerdge_common]
 platform            = ${common_stm32.platform}
-extends             = common_stm32
+extends             = stm32_variant
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_LERDGE
-board_build.offset  = 0x10000
 board_build.encrypt = firmware.bin
-extra_scripts       = ${stm32f4_variant.extra_scripts}
+board_build.offset  = 0x10000
+build_flags         = ${stm32_variant.build_flags}
+                      -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
+                      -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
+                      -DHAL_SRAM_MODULE_ENABLED
+build_unflags       = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
+extra_scripts       = ${stm32_variant.extra_scripts}
                       buildroot/share/PlatformIO/scripts/lerdge.py
-build_flags         = ${common_stm32.build_flags}
-  -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
-  -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
-  -DHAL_SRAM_MODULE_ENABLED
-build_unflags       = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 
 #
 # Lerdge X
 #
 [env:LERDGEX]
 platform            = ${lerdge_common.platform}
 extends             = lerdge_common
 board_build.encrypt = Lerdge_X_firmware_force.bin
 
 #
@@ -332,98 +309,83 @@ build_flags         = ${lerdge_common.build_flags} -DLERDGEK
 platform          = ${env:LERDGEK.platform}
 extends           = env:LERDGEK
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # RUMBA32
 #
 [env:rumba32]
 platform             = ${common_stm32.platform}
-extends              = common_stm32
-build_flags          = ${common_stm32.build_flags}
-  -Os
-  -DHAL_PCD_MODULE_ENABLED
-  -DDISABLE_GENERIC_SERIALUSB
-  -DHAL_UART_MODULE_ENABLED
-  -DTIMER_SERIAL=TIM9
+extends              = stm32_variant
 board                = rumba32_f446ve
-upload_protocol      = dfu
-monitor_speed        = 500000
-board_build.core     = stm32
 board_build.variant  = MARLIN_F446VE
 board_build.offset   = 0x0000
-extra_scripts        = ${stm32f4_variant.extra_scripts}
+build_flags          = ${stm32_variant.build_flags}
+                       -Os -DHAL_PCD_MODULE_ENABLED
+                       -DDISABLE_GENERIC_SERIALUSB
+                       -DHAL_UART_MODULE_ENABLED
+                       -DTIMER_SERIAL=TIM9
+monitor_speed        = 500000
+upload_protocol      = dfu
 
 #
 # MKS Robin Pro V2
 #
 [env:mks_robin_pro2]
-platform             = ${common_stm32.platform}
-platform_packages    = ${stm_flash_drive.platform_packages}
-extends              = common_stm32
-build_flags          = ${stm_flash_drive.build_flags}
-board                = genericSTM32F407VET6
-board_build.core     = stm32
-board_build.variant  = MARLIN_F4x7Vx
-board_build.offset   = 0x0000
+platform                    = ${common_stm32.platform}
+extends                     = stm32_variant
+platform_packages           = ${stm_flash_drive.platform_packages}
+board                       = genericSTM32F407VET6
+board_build.variant         = MARLIN_F4x7Vx
+board_build.offset          = 0x0000
 board_upload.offset_address = 0x08000000
-build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
-debug_tool           = jlink
-upload_protocol      = jlink
-extra_scripts        = ${stm32f4_variant.extra_scripts}
+build_flags                 = ${stm_flash_drive.build_flags}
+build_unflags               = ${stm32_variant.build_unflags} -DUSBCON -DUSBD_USE_CDC
+debug_tool                  = jlink
+upload_protocol             = jlink
 
 #
 # This SPI is used by Robin Nano V3
 #
 [stm32f4_I2C1]
 build_flags = -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
 
 #
 # MKS Robin Nano V3
 #
 [env:mks_robin_nano_v3]
-platform             = ${common_stm32.platform}
-extends              = common_stm32
-build_flags          = ${common_stm32.build_flags} ${stm32f4_I2C1.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC
-board                = marlin_STM32F407VGT6_CCM
-board_build.core     = stm32
-board_build.variant  = MARLIN_F4x7Vx
-board_build.rename   = Robin_nano_v3.bin
-board_build.offset   = 0xC000
+platform                    = ${common_stm32.platform}
+extends                     = stm32_variant
+board                       = marlin_STM32F407VGT6_CCM
+board_build.variant         = MARLIN_F4x7Vx
+board_build.offset          = 0xC000
+board_build.rename          = Robin_nano_v3.bin
 board_upload.offset_address = 0x0800C000
-build_unflags        = ${common_stm32.build_unflags}
-debug_tool           = jlink
-upload_protocol      = jlink
-extra_scripts        = ${stm32f4_variant.extra_scripts}
+build_flags                 = ${stm32_variant.build_flags} ${stm32f4_I2C1.build_flags}
+                              -DHAL_PCD_MODULE_ENABLED
+debug_tool                  = jlink
+upload_protocol             = jlink
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support
 # Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive]
+platform          = ${common_stm32.platform}
 extends           = env:mks_robin_nano_v3
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
-  -DUSBCON
-  -DUSE_USBHOST_HS
-  -DUSBD_IRQ_PRIO=5
-  -DUSBD_IRQ_SUBPRIO=6
-  -DUSE_USB_HS_IN_FS
-  -DUSBD_USE_CDC
+                    -DUSE_USBHOST_HS
+                    -DUSBD_IRQ_PRIO=5
+                    -DUSBD_IRQ_SUBPRIO=6
+                    -DUSE_USB_HS_IN_FS
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive_msc]
 platform          = ${common_stm32.platform}
-extends           = env:mks_robin_nano_v3
-platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc-3.zip
-build_unflags     = ${common_stm32.build_unflags} -DUSBD_USE_CDC
-build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
-  -DUSBCON
-  -DUSE_USBHOST_HS
-  -DUSBD_IRQ_PRIO=5
-  -DUSBD_IRQ_SUBPRIO=6
-  -DUSE_USB_HS_IN_FS
-  -DUSBD_USE_CDC_MSC
+extends           = env:mks_robin_nano_v3_usb_flash_drive
+build_flags       = ${env:mks_robin_nano_v3_usb_flash_drive}
+                    -DUSBD_USE_CDC_MSC

commit 5ca9ebfa6b0ff814c3a122c3e613574533027803
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Wed Jul 14 19:44:51 2021 -0500

    üî® Consolidate STM32 extra_scripts (#22365)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index ced410624f..ada6605e07 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -22,139 +22,133 @@
 #
 # ARMED (STM32)
 #
 [env:ARMED]
 platform      = ${common_stm32.platform}
 extends       = common_stm32
 board         = armed_v1
 build_flags   = ${common_stm32.build_flags}
   -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
 
+[stm32f4_variant]
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/offset_and_rename.py
+
 #
 # STM32F401VE
 # 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
 #
 [env:STM32F401VE_STEVAL]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = marlin_STEVAL_STM32F401VE
 build_flags       = ${common_stm32.build_flags}
   -DARDUINO_STEVAL -DSTM32F401xE
   -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${stm32f4_variant.extra_scripts}
 
 #
 # STM32F401RC
 #
 [env:FYSETC_CHEETAH_V20]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = marlin_FYSETC_CHEETAH_V20
 build_flags       = ${common_stm32.build_flags} -DSTM32F401xC -DVECT_TAB_OFFSET=0xC000
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${stm32f4_variant.extra_scripts}
 
 #
 # FLYF407ZG
 #
 [env:FLYF407ZG]
 platform            = ${common_stm32.platform}
 extends             = common_stm32
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_FLY_F407ZG
 upload_protocol     = dfu
 build_flags         = ${common_stm32.build_flags}
   -DVECT_TAB_OFFSET=0x8000
-extra_scripts       = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts       = ${stm32f4_variant.extra_scripts}
 
 #
 # FYSETC S6 (STM32F446RET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 platform_packages = tool-stm32duino
 board             = marlin_fysetc_s6
 build_flags       = ${common_stm32.build_flags} -DVECT_TAB_OFFSET=0x10000 -DHAL_PCD_MODULE_ENABLED
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${stm32f4_variant.extra_scripts}
 debug_tool        = stlink
 upload_protocol   = dfu
 upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
 
 #
 # FYSETC S6 new bootloader
 #
 [env:FYSETC_S6_8000]
 platform                    = ${common_stm32.platform}
 extends                     = env:FYSETC_S6
 board                       = marlin_fysetc_s6_8000
 board_build.offset          = 0x8000
 board_upload.offset_address = 0x08008000
 build_flags                 = ${common_stm32.build_flags} -DHAL_PCD_MODULE_ENABLED
-extra_scripts               = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+extra_scripts               = ${stm32f4_variant.extra_scripts}
 upload_command              = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
 
 #
 # STM32F407VET6 with RAMPS-like shield
 # 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = marlin_blackSTM32F407VET6
 build_flags       = ${common_stm32.build_flags}
   -DARDUINO_BLACK_F407VE
   -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${stm32f4_variant.extra_scripts}
 
 #
 # Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
 # For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
 # Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
 #
 [env:Anet_ET4_OpenBLT]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
 build_flags          = ${common_stm32.build_flags} -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
 board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.encrypt  = firmware.srec
-# Just openblt.py (not stm32_bootloader.py) generates the file
 board_build.offset   = 0x10000
 board_upload.offset_address = 0x08010000
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 debug_tool           = jlink
 upload_protocol      = jlink
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+extra_scripts        = ${stm32f4_variant.extra_scripts}
   buildroot/share/PlatformIO/scripts/openblt.py
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = marlin_BigTree_SKR_Pro
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${stm32f4_variant.extra_scripts}
 #upload_protocol   = stlink
 #upload_command    = "$PROJECT_PACKAGES_DIR/tool-stm32duino/stlink/ST-LINK_CLI.exe" -c SWD -P "$BUILD_DIR/firmware.bin" 0x8008000 -Rst -Run
 debug_tool        = stlink
 debug_init_break  =
 
 #
 # USB Flash Drive mix-ins for STM32
 #
 [stm_flash_drive]
 platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc-3.zip
@@ -176,32 +170,30 @@ build_flags       = ${stm_flash_drive.build_flags}
 # BigTreeTech E3 RRF (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_E3_RRF]
 platform            = ${common_stm32.platform}
 extends             = common_stm32
 board               = marlin_STM32F407VGT6_CCM
 board_build.variant = MARLIN_BIGTREE_E3_RRF
 build_flags         = ${common_stm32.build_flags}
   -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DSERIAL_RX_BUFFER_SIZE=255 -DSERIAL_TX_BUFFER_SIZE=255
-extra_scripts       = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts       = ${stm32f4_variant.extra_scripts}
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_GTR_V1_0]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = marlin_BigTree_GTR_v1
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${stm32f4_variant.extra_scripts}
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_GTR_V1_0_usb_flash_drive]
 extends           = env:BIGTREE_GTR_V1_0
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBCON -DUSBD_USE_CDC
@@ -214,61 +206,57 @@ build_flags       = ${stm_flash_drive.build_flags}
 [env:BIGTREE_BTT002]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = marlin_BigTree_BTT002
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DHAVE_HWSERIAL2
   -DHAVE_HWSERIAL3
   -DPIN_SERIAL2_RX=PD_6
   -DPIN_SERIAL2_TX=PD_5
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${stm32f4_variant.extra_scripts}
 
 #
 # BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_2]
 platform             = ${common_stm32.platform}
 platform_packages    = ${stm_flash_drive.platform_packages}
 extends              = common_stm32
 board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.offset   = 0x8000
 board_upload.offset_address = 0x08008000
-extra_scripts     = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
-build_flags       = ${stm_flash_drive.build_flags}
+extra_scripts        = ${stm32f4_variant.extra_scripts}
+build_flags          = ${stm_flash_drive.build_flags}
   -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
   -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
 
 #
 # BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Media Share Support
 #
 [env:BIGTREE_SKR_2_USB]
 platform          = ${common_stm32.platform}
 extends           = env:BIGTREE_SKR_2
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBD_USE_CDC
 build_flags       = ${env:BIGTREE_SKR_2.build_flags} -DUSBD_USE_CDC_MSC
 
 #
 # BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4)
 #
 [env:BIGTREE_OCTOPUS_V1]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = marlin_BigTree_Octopus_v1
-extra_scripts     = ${common.extra_scripts}
-    pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+extra_scripts     = ${stm32f4_variant.extra_scripts}
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F446_5VX -DVECT_TAB_OFFSET=0x8000 -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_OCTOPUS_V1_USB]
 extends           = env:BIGTREE_OCTOPUS_V1
 platform_packages = ${stm_flash_drive.platform_packages}
 #build_unflags     = -DUSBCON -DUSBD_USE_CDC
@@ -279,23 +267,21 @@ build_flags       = ${stm_flash_drive.build_flags}
 #
 # Lerdge base
 #
 [lerdge_common]
 platform            = ${common_stm32.platform}
 extends             = common_stm32
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_LERDGE
 board_build.offset  = 0x10000
 board_build.encrypt = firmware.bin
-extra_scripts       = ${common.extra_scripts}
-                      pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-                      buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+extra_scripts       = ${stm32f4_variant.extra_scripts}
                       buildroot/share/PlatformIO/scripts/lerdge.py
 build_flags         = ${common_stm32.build_flags}
   -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
   -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
   -DHAL_SRAM_MODULE_ENABLED
 build_unflags       = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 
 #
 # Lerdge X
 #
@@ -359,43 +345,39 @@ build_flags          = ${common_stm32.build_flags}
   -DHAL_PCD_MODULE_ENABLED
   -DDISABLE_GENERIC_SERIALUSB
   -DHAL_UART_MODULE_ENABLED
   -DTIMER_SERIAL=TIM9
 board                = rumba32_f446ve
 upload_protocol      = dfu
 monitor_speed        = 500000
 board_build.core     = stm32
 board_build.variant  = MARLIN_F446VE
 board_build.offset   = 0x0000
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+extra_scripts        = ${stm32f4_variant.extra_scripts}
 
 #
 # MKS Robin Pro V2
 #
 [env:mks_robin_pro2]
 platform             = ${common_stm32.platform}
 platform_packages    = ${stm_flash_drive.platform_packages}
 extends              = common_stm32
 build_flags          = ${stm_flash_drive.build_flags}
 board                = genericSTM32F407VET6
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.offset   = 0x0000
 board_upload.offset_address = 0x08000000
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
 debug_tool           = jlink
 upload_protocol      = jlink
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+extra_scripts        = ${stm32f4_variant.extra_scripts}
 
 #
 # This SPI is used by Robin Nano V3
 #
 [stm32f4_I2C1]
 build_flags = -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
 
 #
 # MKS Robin Nano V3
 #
@@ -405,23 +387,21 @@ extends              = common_stm32
 build_flags          = ${common_stm32.build_flags} ${stm32f4_I2C1.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC
 board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.rename   = Robin_nano_v3.bin
 board_build.offset   = 0xC000
 board_upload.offset_address = 0x0800C000
 build_unflags        = ${common_stm32.build_unflags}
 debug_tool           = jlink
 upload_protocol      = jlink
-extra_scripts        = ${common.extra_scripts}
-  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+extra_scripts        = ${stm32f4_variant.extra_scripts}
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support
 # Currently, using a STM32duino fork, until USB Host get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive]
 extends           = env:mks_robin_nano_v3
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
   -DUSBCON

commit 65cfbc074104c6b1ae4ef58251e516e3c4bad659
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Wed Jul 14 02:34:18 2021 -0300

    ‚ú® MSC Support for STM32 + SDIO boards -> SKR 2 (#22354)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 6067bbc3b8..ced410624f 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -236,20 +236,30 @@ board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.offset   = 0x8000
 board_upload.offset_address = 0x08008000
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 build_flags       = ${stm_flash_drive.build_flags}
   -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
   -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
 
+#
+# BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Media Share Support
+#
+[env:BIGTREE_SKR_2_USB]
+platform          = ${common_stm32.platform}
+extends           = env:BIGTREE_SKR_2
+platform_packages = ${stm_flash_drive.platform_packages}
+build_unflags     = -DUSBD_USE_CDC
+build_flags       = ${env:BIGTREE_SKR_2.build_flags} -DUSBD_USE_CDC_MSC
+
 #
 # BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4)
 #
 [env:BIGTREE_OCTOPUS_V1]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = marlin_BigTree_Octopus_v1
 extra_scripts     = ${common.extra_scripts}
     pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags       = ${common_stm32.build_flags}

commit 1093224ba2309d09ca55c4289394d6328a63f043
Author: George Fu <nailao_5918@163.com>
Date:   Wed Jul 7 08:40:11 2021 +0800

    üî® FYSETC S6 small bootloader target (#22207)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index e7695dcc7a..6067bbc3b8 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -69,29 +69,42 @@ extra_scripts       = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
 # FYSETC S6 (STM32F446RET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 platform_packages = tool-stm32duino
 board             = marlin_fysetc_s6
-build_flags       = ${common_stm32.build_flags}
-  -DVECT_TAB_OFFSET=0x10000
-  -DHAL_PCD_MODULE_ENABLED
+build_flags       = ${common_stm32.build_flags} -DVECT_TAB_OFFSET=0x10000 -DHAL_PCD_MODULE_ENABLED
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 debug_tool        = stlink
 upload_protocol   = dfu
 upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
 
+#
+# FYSETC S6 new bootloader
+#
+[env:FYSETC_S6_8000]
+platform                    = ${common_stm32.platform}
+extends                     = env:FYSETC_S6
+board                       = marlin_fysetc_s6_8000
+board_build.offset          = 0x8000
+board_upload.offset_address = 0x08008000
+build_flags                 = ${common_stm32.build_flags} -DHAL_PCD_MODULE_ENABLED
+extra_scripts               = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+upload_command              = dfu-util -a 0 -s 0x08008000:leave -D "$SOURCE"
+
 #
 # STM32F407VET6 with RAMPS-like shield
 # 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = marlin_blackSTM32F407VET6
 build_flags       = ${common_stm32.build_flags}

commit b90de621971656df4c0030cd04a3b4c782e4511d
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue Jun 29 16:25:37 2021 -0500

    üî® Clean up build scripts (#22264)
    
    * Add 10K to marlin_blackSTM32F407VET6 (typo?)
    * Document custom build scripts.
    * Add a Robin common build script.
    * Extraneous .ldscript specifiers

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index ee88135eca..e7695dcc7a 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -105,21 +105,20 @@ extra_scripts     = ${common.extra_scripts}
 # For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
 # Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
 #
 [env:Anet_ET4_OpenBLT]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
 build_flags          = ${common_stm32.build_flags} -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
 board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
-board_build.ldscript = ldscript.ld
 board_build.encrypt  = firmware.srec
 # Just openblt.py (not stm32_bootloader.py) generates the file
 board_build.offset   = 0x10000
 board_upload.offset_address = 0x08010000
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 debug_tool           = jlink
 upload_protocol      = jlink
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
@@ -215,21 +214,20 @@ extra_scripts     = ${common.extra_scripts}
 #
 # BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_2]
 platform             = ${common_stm32.platform}
 platform_packages    = ${stm_flash_drive.platform_packages}
 extends              = common_stm32
 board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
-board_build.ldscript = ldscript.ld
 board_build.offset   = 0x8000
 board_upload.offset_address = 0x08008000
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 build_flags       = ${stm_flash_drive.build_flags}
   -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
   -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
 
 #
@@ -337,38 +335,36 @@ build_flags          = ${common_stm32.build_flags}
   -Os
   -DHAL_PCD_MODULE_ENABLED
   -DDISABLE_GENERIC_SERIALUSB
   -DHAL_UART_MODULE_ENABLED
   -DTIMER_SERIAL=TIM9
 board                = rumba32_f446ve
 upload_protocol      = dfu
 monitor_speed        = 500000
 board_build.core     = stm32
 board_build.variant  = MARLIN_F446VE
-board_build.ldscript = ldscript.ld
 board_build.offset   = 0x0000
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 
 #
 # MKS Robin Pro V2
 #
 [env:mks_robin_pro2]
 platform             = ${common_stm32.platform}
 platform_packages    = ${stm_flash_drive.platform_packages}
 extends              = common_stm32
 build_flags          = ${stm_flash_drive.build_flags}
 board                = genericSTM32F407VET6
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
-board_build.ldscript = ldscript.ld
 board_build.offset   = 0x0000
 board_upload.offset_address = 0x08000000
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
 debug_tool           = jlink
 upload_protocol      = jlink
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 
 #
@@ -380,21 +376,20 @@ build_flags = -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
 #
 # MKS Robin Nano V3
 #
 [env:mks_robin_nano_v3]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
 build_flags          = ${common_stm32.build_flags} ${stm32f4_I2C1.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC
 board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
-board_build.ldscript = ldscript.ld
 board_build.rename   = Robin_nano_v3.bin
 board_build.offset   = 0xC000
 board_upload.offset_address = 0x0800C000
 build_unflags        = ${common_stm32.build_unflags}
 debug_tool           = jlink
 upload_protocol      = jlink
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 

commit ba26e902b20b19c269c11c2bf535a170c28907bc
Author: bwspath <bwspath@gmail.com>
Date:   Thu Jun 24 22:27:54 2021 +0200

    üêõ Fix Octopus build on case-sensitive FS (#22206)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index dec7fea568..ee88135eca 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -231,21 +231,21 @@ extra_scripts     = ${common.extra_scripts}
 build_flags       = ${stm_flash_drive.build_flags}
   -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
   -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
 
 #
 # BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4)
 #
 [env:BIGTREE_OCTOPUS_V1]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
-board             = marlin_BigTree_octopus_v1
+board             = marlin_BigTree_Octopus_v1
 extra_scripts     = ${common.extra_scripts}
     pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F446_5VX -DVECT_TAB_OFFSET=0x8000 -DUSE_USB_HS_IN_FS
 
 #
 # BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_OCTOPUS_V1_USB]
 extends           = env:BIGTREE_OCTOPUS_V1

commit 0669053b78a81e871909fb6a7dafa16cebcb1f95
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Sun Jun 13 21:01:53 2021 -0300

    üî® Fix Serial+MSC for _USB envs (#22116)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 4fa5fa24ab..dec7fea568 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -138,21 +138,21 @@ extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 #upload_protocol   = stlink
 #upload_command    = "$PROJECT_PACKAGES_DIR/tool-stm32duino/stlink/ST-LINK_CLI.exe" -c SWD -P "$BUILD_DIR/firmware.bin" 0x8008000 -Rst -Run
 debug_tool        = stlink
 debug_init_break  =
 
 #
 # USB Flash Drive mix-ins for STM32
 #
 [stm_flash_drive]
-platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc-2.zip
+platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc-3.zip
 build_flags       = ${common_stm32.build_flags}
   -DHAL_PCD_MODULE_ENABLED -DHAL_HCD_MODULE_ENABLED
   -DUSBHOST -DUSBH_IRQ_PRIO=3 -DUSBH_IRQ_SUBPRIO=4
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_PRO_usb_flash_drive]
 extends           = env:BIGTREE_SKR_PRO
 platform_packages = ${stm_flash_drive.platform_packages}
@@ -413,19 +413,19 @@ build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
   -DUSE_USB_HS_IN_FS
   -DUSBD_USE_CDC
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive_msc]
 platform          = ${common_stm32.platform}
 extends           = env:mks_robin_nano_v3
-platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc-2.zip
+platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc-3.zip
 build_unflags     = ${common_stm32.build_unflags} -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
   -DUSBCON
   -DUSE_USBHOST_HS
   -DUSBD_IRQ_PRIO=5
   -DUSBD_IRQ_SUBPRIO=6
   -DUSE_USB_HS_IN_FS
   -DUSBD_USE_CDC_MSC

commit 90dc41139fb0bd55bdd3cab16b978842ed525e7b
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Jun 13 15:43:33 2021 -0500

    üèóÔ∏è Refactor build encrypt / rename (#22124)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 021574ad26..4fa5fa24ab 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -106,23 +106,22 @@ extra_scripts     = ${common.extra_scripts}
 # Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
 #
 [env:Anet_ET4_OpenBLT]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
 build_flags          = ${common_stm32.build_flags} -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
 board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.ldscript = ldscript.ld
-board_build.firmware = firmware.srec
+board_build.encrypt  = firmware.srec
 # Just openblt.py (not stm32_bootloader.py) generates the file
-board_build.encrypt  = Yes
 board_build.offset   = 0x10000
 board_upload.offset_address = 0x08010000
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 debug_tool           = jlink
 upload_protocol      = jlink
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
   buildroot/share/PlatformIO/scripts/openblt.py
 
@@ -258,73 +257,73 @@ build_flags       = ${stm_flash_drive.build_flags}
 
 #
 # Lerdge base
 #
 [lerdge_common]
 platform            = ${common_stm32.platform}
 extends             = common_stm32
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_LERDGE
 board_build.offset  = 0x10000
-board_build.encrypt = Yes
+board_build.encrypt = firmware.bin
 extra_scripts       = ${common.extra_scripts}
                       pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
                       buildroot/share/PlatformIO/scripts/stm32_bootloader.py
                       buildroot/share/PlatformIO/scripts/lerdge.py
 build_flags         = ${common_stm32.build_flags}
   -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
   -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
   -DHAL_SRAM_MODULE_ENABLED
 build_unflags       = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 
 #
 # Lerdge X
 #
 [env:LERDGEX]
-platform             = ${lerdge_common.platform}
-extends              = lerdge_common
-board_build.firmware = Lerdge_X_firmware_force.bin
+platform            = ${lerdge_common.platform}
+extends             = lerdge_common
+board_build.encrypt = Lerdge_X_firmware_force.bin
 
 #
 # Lerdge X with USB Flash Drive Support
 #
 [env:LERDGEX_usb_flash_drive]
 platform          = ${env:LERDGEX.platform}
 extends           = env:LERDGEX
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # Lerdge S
 #
 [env:LERDGES]
-platform             = ${lerdge_common.platform}
-extends              = lerdge_common
-board_build.firmware = Lerdge_firmware_force.bin
+platform            = ${lerdge_common.platform}
+extends             = lerdge_common
+board_build.encrypt = Lerdge_firmware_force.bin
 
 #
 # Lerdge S with USB Flash Drive Support
 #
 [env:LERDGES_usb_flash_drive]
 platform          = ${env:LERDGES.platform}
 extends           = env:LERDGES
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # Lerdge K
 #
 [env:LERDGEK]
-platform             = ${lerdge_common.platform}
-extends              = lerdge_common
-board_build.firmware = Lerdge_K_firmware_force.bin
-build_flags          = ${lerdge_common.build_flags} -DLERDGEK
+platform            = ${lerdge_common.platform}
+extends             = lerdge_common
+board_build.encrypt = Lerdge_K_firmware_force.bin
+build_flags         = ${lerdge_common.build_flags} -DLERDGEK
 
 #
 # Lerdge K with USB Flash Drive Support
 #
 [env:LERDGEK_usb_flash_drive]
 platform          = ${env:LERDGEK.platform}
 extends           = env:LERDGEK
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
@@ -340,39 +339,36 @@ build_flags          = ${common_stm32.build_flags}
   -DDISABLE_GENERIC_SERIALUSB
   -DHAL_UART_MODULE_ENABLED
   -DTIMER_SERIAL=TIM9
 board                = rumba32_f446ve
 upload_protocol      = dfu
 monitor_speed        = 500000
 board_build.core     = stm32
 board_build.variant  = MARLIN_F446VE
 board_build.ldscript = ldscript.ld
 board_build.offset   = 0x0000
-board_build.encrypt  = No
-board_build.firmware = firmware.bin
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 
 #
 # MKS Robin Pro V2
 #
 [env:mks_robin_pro2]
 platform             = ${common_stm32.platform}
 platform_packages    = ${stm_flash_drive.platform_packages}
 extends              = common_stm32
 build_flags          = ${stm_flash_drive.build_flags}
 board                = genericSTM32F407VET6
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.ldscript = ldscript.ld
-board_build.firmware = firmware.bin
 board_build.offset   = 0x0000
 board_upload.offset_address = 0x08000000
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
 debug_tool           = jlink
 upload_protocol      = jlink
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 
 #
@@ -385,21 +381,21 @@ build_flags = -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
 # MKS Robin Nano V3
 #
 [env:mks_robin_nano_v3]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
 build_flags          = ${common_stm32.build_flags} ${stm32f4_I2C1.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC
 board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.ldscript = ldscript.ld
-board_build.firmware = Robin_nano_v3.bin
+board_build.rename   = Robin_nano_v3.bin
 board_build.offset   = 0xC000
 board_upload.offset_address = 0x0800C000
 build_unflags        = ${common_stm32.build_unflags}
 debug_tool           = jlink
 upload_protocol      = jlink
 extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 
 #

commit d18c8340291b2dfa2c685ffa01bd07f76de1bc18
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Fri Jun 4 21:56:18 2021 -0700

    ‚ú® BigTreeTech Octopus V1.1 (#22042)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index d730387cb9..021574ad26 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -227,36 +227,36 @@ board_build.ldscript = ldscript.ld
 board_build.offset   = 0x8000
 board_upload.offset_address = 0x08008000
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 build_flags       = ${stm_flash_drive.build_flags}
   -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
   -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
 
 #
-# BigTreeTech Octopus V1.0 (STM32F446ZET6 ARM Cortex-M4)
+# BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4)
 #
-[env:BIGTREE_OCTOPUS_V1_0]
+[env:BIGTREE_OCTOPUS_V1]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = marlin_BigTree_octopus_v1
 extra_scripts     = ${common.extra_scripts}
     pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F446_5VX -DVECT_TAB_OFFSET=0x8000 -DUSE_USB_HS_IN_FS
 
 #
-# BigTreeTech Octopus V1.0 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
+# BigTreeTech Octopus V1.0/1.1 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
 #
-[env:BIGTREE_OCTOPUS_V1_0_USB]
-extends           = env:BIGTREE_OCTOPUS_V1_0
+[env:BIGTREE_OCTOPUS_V1_USB]
+extends           = env:BIGTREE_OCTOPUS_V1
 platform_packages = ${stm_flash_drive.platform_packages}
 #build_unflags     = -DUSBCON -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
   -DSTM32F446_5VX -DVECT_TAB_OFFSET=0x8000
   -DUSBCON -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6 -DUSE_USB_HS_IN_FS -DUSBD_USE_CDC_MSC
 
 #
 # Lerdge base
 #
 [lerdge_common]

commit 0398a0b780afe73115374900814f4c87b43a3889
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Thu Jun 3 18:52:25 2021 -0300

    üëΩÔ∏è Fix usb-host-msc-cdc-msc issue (#22025)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 087a446ede..d730387cb9 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -139,21 +139,21 @@ extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 #upload_protocol   = stlink
 #upload_command    = "$PROJECT_PACKAGES_DIR/tool-stm32duino/stlink/ST-LINK_CLI.exe" -c SWD -P "$BUILD_DIR/firmware.bin" 0x8008000 -Rst -Run
 debug_tool        = stlink
 debug_init_break  =
 
 #
 # USB Flash Drive mix-ins for STM32
 #
 [stm_flash_drive]
-platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc.zip
+platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc-2.zip
 build_flags       = ${common_stm32.build_flags}
   -DHAL_PCD_MODULE_ENABLED -DHAL_HCD_MODULE_ENABLED
   -DUSBHOST -DUSBH_IRQ_PRIO=3 -DUSBH_IRQ_SUBPRIO=4
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_PRO_usb_flash_drive]
 extends           = env:BIGTREE_SKR_PRO
 platform_packages = ${stm_flash_drive.platform_packages}
@@ -417,19 +417,19 @@ build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
   -DUSE_USB_HS_IN_FS
   -DUSBD_USE_CDC
 
 #
 # MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
 # Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
 #
 [env:mks_robin_nano_v3_usb_flash_drive_msc]
 platform          = ${common_stm32.platform}
 extends           = env:mks_robin_nano_v3
-platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc.zip
+platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc-2.zip
 build_unflags     = ${common_stm32.build_unflags} -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
   -DUSBCON
   -DUSE_USBHOST_HS
   -DUSBD_IRQ_PRIO=5
   -DUSBD_IRQ_SUBPRIO=6
   -DUSE_USB_HS_IN_FS
   -DUSBD_USE_CDC_MSC

commit c207111cc6aababfb1e617b7790d10af48233a25
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Jun 1 23:24:20 2021 -0500

    üî® Move FLY_MINI env to stm32f1.ini

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 5d6d291182..087a446ede 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -61,34 +61,20 @@ extra_scripts     = ${common.extra_scripts}
 platform            = ${common_stm32.platform}
 extends             = common_stm32
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_FLY_F407ZG
 upload_protocol     = dfu
 build_flags         = ${common_stm32.build_flags}
   -DVECT_TAB_OFFSET=0x8000
 extra_scripts       = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
-#
-# FLY MINI (STM32F103RCT6)
-#
-[env:FLY_MINI]
-platform          = ${common_stm32f1.platform}
-extends           = common_stm32f1
-board             = genericSTM32F103RC
-board_build.address  = 0x08005000
-board_build.ldscript = fly_mini.ld
-extra_scripts     = ${common_stm32f1.extra_scripts}
-  buildroot/share/PlatformIO/scripts/custom_board.py
-build_flags       = ${common_stm32f1.build_flags}
-  -DDEBUG_LEVEL=0 -DSS_TIMER=4
-
 #
 # FYSETC S6 (STM32F446RET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 platform_packages = tool-stm32duino
 board             = marlin_fysetc_s6
 build_flags       = ${common_stm32.build_flags}
   -DVECT_TAB_OFFSET=0x10000

commit 3734e8e02f2ad0f2f717798a264dd879eba0fc81
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Wed May 12 01:26:19 2021 -0700

    ‚ú® BigTreeTech Octopus board (STM32F446ZET6) (#21826)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 62038332b3..5d6d291182 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -221,39 +221,62 @@ board             = marlin_BigTree_BTT002
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DHAVE_HWSERIAL2
   -DHAVE_HWSERIAL3
   -DPIN_SERIAL2_RX=PD_6
   -DPIN_SERIAL2_TX=PD_5
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
-# Bigtreetech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Flash Drive Support
+# BigTreeTech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_2]
 platform             = ${common_stm32.platform}
 platform_packages    = ${stm_flash_drive.platform_packages}
 extends              = common_stm32
 board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.ldscript = ldscript.ld
 board_build.offset   = 0x8000
 board_upload.offset_address = 0x08008000
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 build_flags       = ${stm_flash_drive.build_flags}
   -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
   -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
 
+#
+# BigTreeTech Octopus V1.0 (STM32F446ZET6 ARM Cortex-M4)
+#
+[env:BIGTREE_OCTOPUS_V1_0]
+platform          = ${common_stm32.platform}
+extends           = common_stm32
+board             = marlin_BigTree_octopus_v1
+extra_scripts     = ${common.extra_scripts}
+    pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+build_flags       = ${common_stm32.build_flags}
+  -DSTM32F446_5VX -DVECT_TAB_OFFSET=0x8000 -DUSE_USB_HS_IN_FS
+
+#
+# BigTreeTech Octopus V1.0 (STM32F446ZET6 ARM Cortex-M4) with USB Flash Drive Support
+#
+[env:BIGTREE_OCTOPUS_V1_0_USB]
+extends           = env:BIGTREE_OCTOPUS_V1_0
+platform_packages = ${stm_flash_drive.platform_packages}
+#build_unflags     = -DUSBCON -DUSBD_USE_CDC
+build_flags       = ${stm_flash_drive.build_flags}
+  -DSTM32F446_5VX -DVECT_TAB_OFFSET=0x8000
+  -DUSBCON -DUSE_USBHOST_HS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6 -DUSE_USB_HS_IN_FS -DUSBD_USE_CDC_MSC
+
 #
 # Lerdge base
 #
 [lerdge_common]
 platform            = ${common_stm32.platform}
 extends             = common_stm32
 board               = marlin_STM32F407ZGT6
 board_build.variant = MARLIN_LERDGE
 board_build.offset  = 0x10000
 board_build.encrypt = Yes

commit 4335f4e41f694a92bf79e1fe0e9bfc3491fa1bd9
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Sat May 8 23:05:47 2021 -0300

    üêõ Fix Lerdge USB Flash Drive envs (#21847)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 325dc4b502..62038332b3 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -275,56 +275,56 @@ platform             = ${lerdge_common.platform}
 extends              = lerdge_common
 board_build.firmware = Lerdge_X_firmware_force.bin
 
 #
 # Lerdge X with USB Flash Drive Support
 #
 [env:LERDGEX_usb_flash_drive]
 platform          = ${env:LERDGEX.platform}
 extends           = env:LERDGEX
 platform_packages = ${stm_flash_drive.platform_packages}
-build_flags       = ${stm_flash_drive.build_flags}
+build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # Lerdge S
 #
 [env:LERDGES]
 platform             = ${lerdge_common.platform}
 extends              = lerdge_common
 board_build.firmware = Lerdge_firmware_force.bin
 
 #
 # Lerdge S with USB Flash Drive Support
 #
 [env:LERDGES_usb_flash_drive]
 platform          = ${env:LERDGES.platform}
 extends           = env:LERDGES
 platform_packages = ${stm_flash_drive.platform_packages}
-build_flags       = ${stm_flash_drive.build_flags}
+build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # Lerdge K
 #
 [env:LERDGEK]
 platform             = ${lerdge_common.platform}
 extends              = lerdge_common
 board_build.firmware = Lerdge_K_firmware_force.bin
 build_flags          = ${lerdge_common.build_flags} -DLERDGEK
 
 #
 # Lerdge K with USB Flash Drive Support
 #
 [env:LERDGEK_usb_flash_drive]
 platform          = ${env:LERDGEK.platform}
 extends           = env:LERDGEK
 platform_packages = ${stm_flash_drive.platform_packages}
-build_flags       = ${stm_flash_drive.build_flags}
+build_flags       = ${stm_flash_drive.build_flags} ${lerdge_common.build_flags}
 
 #
 # RUMBA32
 #
 [env:rumba32]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
 build_flags          = ${common_stm32.build_flags}
   -Os
   -DHAL_PCD_MODULE_ENABLED

commit f95f18c8e51ab5ff2782a3fbd873d2f48207cb10
Author: sanek88lbl <42996016+sanek88lbl@users.noreply.github.com>
Date:   Sun May 9 01:06:21 2021 +0300

    Lerdge K EEPROM and TFT (#21812)
    
    Co-authored-by: Scott Lahteine <github@thinkyhead.com>

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index ff99296877..325dc4b502 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -301,22 +301,21 @@ extends           = env:LERDGES
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags}
 
 #
 # Lerdge K
 #
 [env:LERDGEK]
 platform             = ${lerdge_common.platform}
 extends              = lerdge_common
 board_build.firmware = Lerdge_K_firmware_force.bin
-build_flags          = ${lerdge_common.build_flags}
-  -DLERDGEK
+build_flags          = ${lerdge_common.build_flags} -DLERDGEK
 
 #
 # Lerdge K with USB Flash Drive Support
 #
 [env:LERDGEK_usb_flash_drive]
 platform          = ${env:LERDGEK.platform}
 extends           = env:LERDGEK
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags}
 

commit f58b923fd4df7c59a14e91fcd5977feb50774b5b
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Fri Apr 30 01:07:18 2021 -0700

    Fix BTT E3 RRF and SKR V2 (Generic PIO) (#21741)
    
    Follow-up to #21655

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index d6418f439e..ff99296877 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -174,21 +174,21 @@ platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBCON -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
   -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
 
 #
 # BigTreeTech E3 RRF (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_E3_RRF]
 platform            = ${common_stm32.platform}
 extends             = common_stm32
-board               = genericSTM32F407VGT6
+board               = marlin_STM32F407VGT6_CCM
 board_build.variant = MARLIN_BIGTREE_E3_RRF
 build_flags         = ${common_stm32.build_flags}
   -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DSERIAL_RX_BUFFER_SIZE=255 -DSERIAL_TX_BUFFER_SIZE=255
 extra_scripts       = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
 #
@@ -227,21 +227,21 @@ build_flags       = ${common_stm32.build_flags}
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
 # Bigtreetech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_2]
 platform             = ${common_stm32.platform}
 platform_packages    = ${stm_flash_drive.platform_packages}
 extends              = common_stm32
-board                = genericSTM32F407VGT6
+board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.ldscript = ldscript.ld
 board_build.offset   = 0x8000
 board_upload.offset_address = 0x08008000
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 build_flags       = ${stm_flash_drive.build_flags}
   -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6

commit ee016e605cda97f3934b78994b390ce99ea35f04
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue Apr 27 04:49:21 2021 -0500

    Rename, clean up boards/variants (#21655)
    
    * Consolidate variant scripts
    * Rename Marlin-local boards
    * Simplify variants where possible
    * Rename variants
    * CHITU_F103 and MEEB_3DP: Maple platform `platformio-build-stm32f1.py` uses the 'board' name, not 'board_build.variant' so folder names match 'board' and not `board_build.variant`.

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 1678b26d89..d6418f439e 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -29,66 +29,68 @@ board         = armed_v1
 build_flags   = ${common_stm32.build_flags}
   -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
 
 #
 # STM32F401VE
 # 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
 #
 [env:STM32F401VE_STEVAL]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
-board             = STEVAL_STM32F401VE
+board             = marlin_STEVAL_STM32F401VE
 build_flags       = ${common_stm32.build_flags}
   -DARDUINO_STEVAL -DSTM32F401xE
   -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/STM32F401VE_STEVAL.py
 
 #
 # STM32F401RC
 #
 [env:FYSETC_CHEETAH_V20]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
-board             = FYSETC_CHEETAH_V20
+board             = marlin_FYSETC_CHEETAH_V20
 build_flags       = ${common_stm32.build_flags} -DSTM32F401xC -DVECT_TAB_OFFSET=0xC000
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
-  buildroot/share/PlatformIO/scripts/FYSETC_CHEETAH_V20.py
 
 #
 # FLYF407ZG
 #
 [env:FLYF407ZG]
-platform          = ${common_stm32.platform}
-extends           = common_stm32
-board             = FLYF407ZG
-build_flags       = ${common_stm32.build_flags}
+platform            = ${common_stm32.platform}
+extends             = common_stm32
+board               = marlin_STM32F407ZGT6
+board_build.variant = MARLIN_FLY_F407ZG
+upload_protocol     = dfu
+build_flags         = ${common_stm32.build_flags}
   -DVECT_TAB_OFFSET=0x8000
-extra_scripts     = ${common.extra_scripts}
+extra_scripts       = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
-# FLY MINI(stm32f103rct6)
+# FLY MINI (STM32F103RCT6)
 #
 [env:FLY_MINI]
 platform          = ${common_stm32f1.platform}
 extends           = common_stm32f1
 board             = genericSTM32F103RC
+board_build.address  = 0x08005000
+board_build.ldscript = fly_mini.ld
 extra_scripts     = ${common_stm32f1.extra_scripts}
- buildroot/share/PlatformIO/scripts/fly_mini.py
+  buildroot/share/PlatformIO/scripts/custom_board.py
 build_flags       = ${common_stm32f1.build_flags}
- -DDEBUG_LEVEL=0 -DSS_TIMER=4
+  -DDEBUG_LEVEL=0 -DSS_TIMER=4
 
 #
-# FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
+# FYSETC S6 (STM32F446RET6 ARM Cortex-M4)
 #
 [env:FYSETC_S6]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 platform_packages = tool-stm32duino
 board             = marlin_fysetc_s6
 build_flags       = ${common_stm32.build_flags}
   -DVECT_TAB_OFFSET=0x10000
   -DHAL_PCD_MODULE_ENABLED
 extra_scripts     = ${common.extra_scripts}
@@ -98,37 +100,37 @@ upload_protocol   = dfu
 upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
 
 #
 # STM32F407VET6 with RAMPS-like shield
 # 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
 # Shield - https://github.com/jmz52/Hardware
 #
 [env:STM32F407VE_black]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
-board             = blackSTM32F407VET6
+board             = marlin_blackSTM32F407VET6
 build_flags       = ${common_stm32.build_flags}
   -DARDUINO_BLACK_F407VE
   -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
 # Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
 # For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
 # Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
 #
 [env:Anet_ET4_OpenBLT]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
 build_flags          = ${common_stm32.build_flags} -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
-board                = genericSTM32F407VGT6
+board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.ldscript = ldscript.ld
 board_build.firmware = firmware.srec
 # Just openblt.py (not stm32_bootloader.py) generates the file
 board_build.encrypt  = Yes
 board_build.offset   = 0x10000
 board_upload.offset_address = 0x08010000
 build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 debug_tool           = jlink
@@ -137,21 +139,21 @@ extra_scripts        = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
   buildroot/share/PlatformIO/scripts/stm32_bootloader.py
   buildroot/share/PlatformIO/scripts/openblt.py
 
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_SKR_PRO]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
-board             = BigTree_SKR_Pro
+board             = marlin_BigTree_SKR_Pro
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 #upload_protocol   = stlink
 #upload_command    = "$PROJECT_PACKAGES_DIR/tool-stm32duino/stlink/ST-LINK_CLI.exe" -c SWD -P "$BUILD_DIR/firmware.bin" 0x8008000 -Rst -Run
 debug_tool        = stlink
 debug_init_break  =
 
 #
@@ -173,34 +175,34 @@ build_unflags     = -DUSBCON -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
   -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
 
 #
 # BigTreeTech E3 RRF (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_E3_RRF]
 platform            = ${common_stm32.platform}
 extends             = common_stm32
 board               = genericSTM32F407VGT6
-board_build.variant = BIGTREE_E3_RRF
+board_build.variant = MARLIN_BIGTREE_E3_RRF
 build_flags         = ${common_stm32.build_flags}
   -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DSERIAL_RX_BUFFER_SIZE=255 -DSERIAL_TX_BUFFER_SIZE=255
 extra_scripts       = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_GTR_V1_0]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
-board             = BigTree_GTR_v1
+board             = marlin_BigTree_GTR_v1
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
 
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_GTR_V1_0_usb_flash_drive]
 extends           = env:BIGTREE_GTR_V1_0
@@ -208,21 +210,21 @@ platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBCON -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
   -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
 
 #
 # BigTreeTech BTT002 V1.0 (STM32F407VGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_BTT002]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
-board             = BigTree_Btt002
+board             = marlin_BigTree_BTT002
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DHAVE_HWSERIAL2
   -DHAVE_HWSERIAL3
   -DPIN_SERIAL2_RX=PD_6
   -DPIN_SERIAL2_TX=PD_5
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
 #
@@ -244,25 +246,26 @@ extra_scripts     = ${common.extra_scripts}
 build_flags       = ${stm_flash_drive.build_flags}
   -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
   -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
 
 #
 # Lerdge base
 #
 [lerdge_common]
 platform            = ${common_stm32.platform}
 extends             = common_stm32
-board               = LERDGE
+board               = marlin_STM32F407ZGT6
+board_build.variant = MARLIN_LERDGE
 board_build.offset  = 0x10000
 board_build.encrypt = Yes
 extra_scripts       = ${common.extra_scripts}
-                      pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
+                      pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
                       buildroot/share/PlatformIO/scripts/stm32_bootloader.py
                       buildroot/share/PlatformIO/scripts/lerdge.py
 build_flags         = ${common_stm32.build_flags}
   -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
   -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
   -DHAL_SRAM_MODULE_ENABLED
 build_unflags       = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
 
 #
 # Lerdge X
@@ -370,21 +373,21 @@ extra_scripts        = ${common.extra_scripts}
 [stm32f4_I2C1]
 build_flags = -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
 
 #
 # MKS Robin Nano V3
 #
 [env:mks_robin_nano_v3]
 platform             = ${common_stm32.platform}
 extends              = common_stm32
 build_flags          = ${common_stm32.build_flags} ${stm32f4_I2C1.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC
-board                = genericSTM32F407VGT6
+board                = marlin_STM32F407VGT6_CCM
 board_build.core     = stm32
 board_build.variant  = MARLIN_F4x7Vx
 board_build.ldscript = ldscript.ld
 board_build.firmware = Robin_nano_v3.bin
 board_build.offset   = 0xC000
 board_upload.offset_address = 0x0800C000
 build_unflags        = ${common_stm32.build_unflags}
 debug_tool           = jlink
 upload_protocol      = jlink
 extra_scripts        = ${common.extra_scripts}

commit 69d85cce2da20b88784db68324c228db212af071
Author: Keith Bennett <13375512+thisiskeithb@users.noreply.github.com>
Date:   Tue Apr 27 00:22:09 2021 -0700

    BTT SKR V2.0 / Stepper Driver Anti-Reverse Protection (#21503)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 881dd17b01..1678b26d89 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -218,20 +218,40 @@ extends           = common_stm32
 board             = BigTree_Btt002
 build_flags       = ${common_stm32.build_flags}
   -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
   -DHAVE_HWSERIAL2
   -DHAVE_HWSERIAL3
   -DPIN_SERIAL2_RX=PD_6
   -DPIN_SERIAL2_TX=PD_5
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 
+#
+# Bigtreetech SKR V2.0 (STM32F407VGT6 ARM Cortex-M4) with USB Flash Drive Support
+#
+[env:BIGTREE_SKR_2]
+platform             = ${common_stm32.platform}
+platform_packages    = ${stm_flash_drive.platform_packages}
+extends              = common_stm32
+board                = genericSTM32F407VGT6
+board_build.core     = stm32
+board_build.variant  = MARLIN_F4x7Vx
+board_build.ldscript = ldscript.ld
+board_build.offset   = 0x8000
+board_upload.offset_address = 0x08008000
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+build_flags       = ${stm_flash_drive.build_flags}
+  -DUSE_USBHOST_HS -DUSE_USB_HS_IN_FS -DUSBD_IRQ_PRIO=5 -DUSBD_IRQ_SUBPRIO=6
+  -DHSE_VALUE=8000000U -DHAL_SD_MODULE_ENABLED
+
 #
 # Lerdge base
 #
 [lerdge_common]
 platform            = ${common_stm32.platform}
 extends             = common_stm32
 board               = LERDGE
 board_build.offset  = 0x10000
 board_build.encrypt = Yes
 extra_scripts       = ${common.extra_scripts}

commit 86397df32d78087c148c0a3c0a002a17b75b4dde
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Apr 18 14:17:37 2021 -0500

    BTT E3 RRF Support

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 0e8a8c6b05..881dd17b01 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -166,20 +166,34 @@ build_flags       = ${common_stm32.build_flags}
 #
 # BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4) with USB Flash Drive Support
 #
 [env:BIGTREE_SKR_PRO_usb_flash_drive]
 extends           = env:BIGTREE_SKR_PRO
 platform_packages = ${stm_flash_drive.platform_packages}
 build_unflags     = -DUSBCON -DUSBD_USE_CDC
 build_flags       = ${stm_flash_drive.build_flags}
   -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
 
+#
+# BigTreeTech E3 RRF (STM32F407VGT6 ARM Cortex-M4)
+#
+[env:BIGTREE_E3_RRF]
+platform            = ${common_stm32.platform}
+extends             = common_stm32
+board               = genericSTM32F407VGT6
+board_build.variant = BIGTREE_E3_RRF
+build_flags         = ${common_stm32.build_flags}
+  -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
+  -DSERIAL_RX_BUFFER_SIZE=255 -DSERIAL_TX_BUFFER_SIZE=255
+extra_scripts       = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+
 #
 # Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
 #
 [env:BIGTREE_GTR_V1_0]
 platform          = ${common_stm32.platform}
 extends           = common_stm32
 board             = BigTree_GTR_v1
 extra_scripts     = ${common.extra_scripts}
   pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
 build_flags       = ${common_stm32.build_flags}

commit c508c2213ee5b0ed130238c058b7cc91beaea654
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Apr 18 14:07:30 2021 -0500

    Misc. pio cleanup

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index 5e700f0e9f..0e8a8c6b05 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -1,19 +1,29 @@
 #
 # Marlin Firmware
 # PlatformIO Configuration File
 #
 
 #################################
-#                               #
-#     STM32F4 Architecture      #
-#                               #
+#
+# STM32F4 Architecture
+#
+# Naming Example: STM32F401RGT6
+#
+#   F : Foundation (sometimes High Performance F2/F4)
+#   4 : Cortex M4 core
+#  01 : Line/Features
+#   R : 64 or 66 pins  (V:100, Z:144, I:176)
+#   G : 1024KB Flash-memory  (C:256KB, D:384KB, E:512KB)
+#   T : LQFP package
+#   6 : -40...85¬∞C   (7: ...105¬∞C)
+#
 #################################
 
 #
 # ARMED (STM32)
 #
 [env:ARMED]
 platform      = ${common_stm32.platform}
 extends       = common_stm32
 board         = armed_v1
 build_flags   = ${common_stm32.build_flags}

commit 121b606f9c264995c2c2aa9c215f15d3b3ddb218
Author: Victor Oliveira <rhapsodyv@gmail.com>
Date:   Mon Apr 5 22:46:21 2021 -0300

    Fix Rumba32 variant for Marlin (#21497)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
index a15dc8b056..5e700f0e9f 100644
--- a/ini/stm32f4.ini
+++ b/ini/stm32f4.ini
@@ -270,31 +270,40 @@ build_flags          = ${lerdge_common.build_flags}
 [env:LERDGEK_usb_flash_drive]
 platform          = ${env:LERDGEK.platform}
 extends           = env:LERDGEK
 platform_packages = ${stm_flash_drive.platform_packages}
 build_flags       = ${stm_flash_drive.build_flags}
 
 #
 # RUMBA32
 #
 [env:rumba32]
-platform        = ${common_stm32.platform}
-extends         = common_stm32
-build_flags     = ${common_stm32.build_flags}
+platform             = ${common_stm32.platform}
+extends              = common_stm32
+build_flags          = ${common_stm32.build_flags}
   -Os
   -DHAL_PCD_MODULE_ENABLED
   -DDISABLE_GENERIC_SERIALUSB
   -DHAL_UART_MODULE_ENABLED
   -DTIMER_SERIAL=TIM9
-board           = rumba32_f446ve
-upload_protocol = dfu
-monitor_speed   = 500000
+board                = rumba32_f446ve
+upload_protocol      = dfu
+monitor_speed        = 500000
+board_build.core     = stm32
+board_build.variant  = MARLIN_F446VE
+board_build.ldscript = ldscript.ld
+board_build.offset   = 0x0000
+board_build.encrypt  = No
+board_build.firmware = firmware.bin
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
 
 #
 # MKS Robin Pro V2
 #
 [env:mks_robin_pro2]
 platform             = ${common_stm32.platform}
 platform_packages    = ${stm_flash_drive.platform_packages}
 extends              = common_stm32
 build_flags          = ${stm_flash_drive.build_flags}
 board                = genericSTM32F407VET6

commit 3229100025dc428d5038eca753c70f3c831d6336
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Thu Apr 1 21:53:19 2021 -0500

    Split up platformio.ini (#21507)

diff --git a/ini/stm32f4.ini b/ini/stm32f4.ini
new file mode 100644
index 0000000000..a15dc8b056
--- /dev/null
+++ b/ini/stm32f4.ini
@@ -0,0 +1,371 @@
+#
+# Marlin Firmware
+# PlatformIO Configuration File
+#
+
+#################################
+#                               #
+#     STM32F4 Architecture      #
+#                               #
+#################################
+
+#
+# ARMED (STM32)
+#
+[env:ARMED]
+platform      = ${common_stm32.platform}
+extends       = common_stm32
+board         = armed_v1
+build_flags   = ${common_stm32.build_flags}
+  -O2 -ffreestanding -fsigned-char -fno-move-loop-invariants -fno-strict-aliasing
+
+#
+# STM32F401VE
+# 'STEVAL-3DP001V1' STM32F401VE board - https://www.st.com/en/evaluation-tools/steval-3dp001v1.html
+#
+[env:STM32F401VE_STEVAL]
+platform          = ${common_stm32.platform}
+extends           = common_stm32
+board             = STEVAL_STM32F401VE
+build_flags       = ${common_stm32.build_flags}
+  -DARDUINO_STEVAL -DSTM32F401xE
+  -DDISABLE_GENERIC_SERIALUSB -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/STM32F401VE_STEVAL.py
+
+#
+# STM32F401RC
+#
+[env:FYSETC_CHEETAH_V20]
+platform          = ${common_stm32.platform}
+extends           = common_stm32
+board             = FYSETC_CHEETAH_V20
+build_flags       = ${common_stm32.build_flags} -DSTM32F401xC -DVECT_TAB_OFFSET=0xC000
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/FYSETC_CHEETAH_V20.py
+
+#
+# FLYF407ZG
+#
+[env:FLYF407ZG]
+platform          = ${common_stm32.platform}
+extends           = common_stm32
+board             = FLYF407ZG
+build_flags       = ${common_stm32.build_flags}
+  -DVECT_TAB_OFFSET=0x8000
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+
+#
+# FLY MINI(stm32f103rct6)
+#
+[env:FLY_MINI]
+platform          = ${common_stm32f1.platform}
+extends           = common_stm32f1
+board             = genericSTM32F103RC
+extra_scripts     = ${common_stm32f1.extra_scripts}
+ buildroot/share/PlatformIO/scripts/fly_mini.py
+build_flags       = ${common_stm32f1.build_flags}
+ -DDEBUG_LEVEL=0 -DSS_TIMER=4
+
+#
+# FYSETC S6 (STM32F446VET6 ARM Cortex-M4)
+#
+[env:FYSETC_S6]
+platform          = ${common_stm32.platform}
+extends           = common_stm32
+platform_packages = tool-stm32duino
+board             = marlin_fysetc_s6
+build_flags       = ${common_stm32.build_flags}
+  -DVECT_TAB_OFFSET=0x10000
+  -DHAL_PCD_MODULE_ENABLED
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+debug_tool        = stlink
+upload_protocol   = dfu
+upload_command    = dfu-util -a 0 -s 0x08010000:leave -D "$SOURCE"
+
+#
+# STM32F407VET6 with RAMPS-like shield
+# 'Black' STM32F407VET6 board - https://wiki.stm32duino.com/index.php?title=STM32F407
+# Shield - https://github.com/jmz52/Hardware
+#
+[env:STM32F407VE_black]
+platform          = ${common_stm32.platform}
+extends           = common_stm32
+board             = blackSTM32F407VET6
+build_flags       = ${common_stm32.build_flags}
+  -DARDUINO_BLACK_F407VE
+  -DUSBD_USE_CDC_COMPOSITE -DUSE_USB_FS
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+
+#
+# Anet ET4-MB_V1.x/ET4P-MB_V1.x (STM32F407VGT6 ARM Cortex-M4)
+# For use with with davidtgbe's OpenBLT bootloader https://github.com/davidtgbe/openblt/releases
+# Comment out board_build.offset = 0x10000 if you don't plan to use OpenBLT/flashing directly to 0x08000000.
+#
+[env:Anet_ET4_OpenBLT]
+platform             = ${common_stm32.platform}
+extends              = common_stm32
+build_flags          = ${common_stm32.build_flags} -DHAL_SD_MODULE_ENABLED -DHAL_SRAM_MODULE_ENABLED
+board                = genericSTM32F407VGT6
+board_build.core     = stm32
+board_build.variant  = MARLIN_F4x7Vx
+board_build.ldscript = ldscript.ld
+board_build.firmware = firmware.srec
+# Just openblt.py (not stm32_bootloader.py) generates the file
+board_build.encrypt  = Yes
+board_build.offset   = 0x10000
+board_upload.offset_address = 0x08010000
+build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
+debug_tool           = jlink
+upload_protocol      = jlink
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+  buildroot/share/PlatformIO/scripts/openblt.py
+
+#
+# BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4)
+#
+[env:BIGTREE_SKR_PRO]
+platform          = ${common_stm32.platform}
+extends           = common_stm32
+board             = BigTree_SKR_Pro
+build_flags       = ${common_stm32.build_flags}
+  -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+#upload_protocol   = stlink
+#upload_command    = "$PROJECT_PACKAGES_DIR/tool-stm32duino/stlink/ST-LINK_CLI.exe" -c SWD -P "$BUILD_DIR/firmware.bin" 0x8008000 -Rst -Run
+debug_tool        = stlink
+debug_init_break  =
+
+#
+# USB Flash Drive mix-ins for STM32
+#
+[stm_flash_drive]
+platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc.zip
+build_flags       = ${common_stm32.build_flags}
+  -DHAL_PCD_MODULE_ENABLED -DHAL_HCD_MODULE_ENABLED
+  -DUSBHOST -DUSBH_IRQ_PRIO=3 -DUSBH_IRQ_SUBPRIO=4
+
+#
+# BigTreeTech SKR Pro (STM32F407ZGT6 ARM Cortex-M4) with USB Flash Drive Support
+#
+[env:BIGTREE_SKR_PRO_usb_flash_drive]
+extends           = env:BIGTREE_SKR_PRO
+platform_packages = ${stm_flash_drive.platform_packages}
+build_unflags     = -DUSBCON -DUSBD_USE_CDC
+build_flags       = ${stm_flash_drive.build_flags}
+  -DSTM32F407_5ZX -DVECT_TAB_OFFSET=0x8000
+
+#
+# Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4)
+#
+[env:BIGTREE_GTR_V1_0]
+platform          = ${common_stm32.platform}
+extends           = common_stm32
+board             = BigTree_GTR_v1
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+build_flags       = ${common_stm32.build_flags}
+  -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
+
+#
+# Bigtreetech GTR V1.0 (STM32F407IGT6 ARM Cortex-M4) with USB Flash Drive Support
+#
+[env:BIGTREE_GTR_V1_0_usb_flash_drive]
+extends           = env:BIGTREE_GTR_V1_0
+platform_packages = ${stm_flash_drive.platform_packages}
+build_unflags     = -DUSBCON -DUSBD_USE_CDC
+build_flags       = ${stm_flash_drive.build_flags}
+  -DSTM32F407IX -DVECT_TAB_OFFSET=0x8000
+
+#
+# BigTreeTech BTT002 V1.0 (STM32F407VGT6 ARM Cortex-M4)
+#
+[env:BIGTREE_BTT002]
+platform          = ${common_stm32.platform}
+extends           = common_stm32
+board             = BigTree_Btt002
+build_flags       = ${common_stm32.build_flags}
+  -DSTM32F407_5VX -DVECT_TAB_OFFSET=0x8000
+  -DHAVE_HWSERIAL2
+  -DHAVE_HWSERIAL3
+  -DPIN_SERIAL2_RX=PD_6
+  -DPIN_SERIAL2_TX=PD_5
+extra_scripts     = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+
+#
+# Lerdge base
+#
+[lerdge_common]
+platform            = ${common_stm32.platform}
+extends             = common_stm32
+board               = LERDGE
+board_build.offset  = 0x10000
+board_build.encrypt = Yes
+extra_scripts       = ${common.extra_scripts}
+                      pre:buildroot/share/PlatformIO/scripts/copy_marlin_variant_to_framework.py
+                      buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+                      buildroot/share/PlatformIO/scripts/lerdge.py
+build_flags         = ${common_stm32.build_flags}
+  -DSTM32F4 -DSTM32F4xx -DTARGET_STM32F4
+  -DDISABLE_GENERIC_SERIALUSB -DARDUINO_ARCH_STM32 -DARDUINO_LERDGE
+  -DHAL_SRAM_MODULE_ENABLED
+build_unflags       = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC -DUSBD_VID=0x0483
+
+#
+# Lerdge X
+#
+[env:LERDGEX]
+platform             = ${lerdge_common.platform}
+extends              = lerdge_common
+board_build.firmware = Lerdge_X_firmware_force.bin
+
+#
+# Lerdge X with USB Flash Drive Support
+#
+[env:LERDGEX_usb_flash_drive]
+platform          = ${env:LERDGEX.platform}
+extends           = env:LERDGEX
+platform_packages = ${stm_flash_drive.platform_packages}
+build_flags       = ${stm_flash_drive.build_flags}
+
+#
+# Lerdge S
+#
+[env:LERDGES]
+platform             = ${lerdge_common.platform}
+extends              = lerdge_common
+board_build.firmware = Lerdge_firmware_force.bin
+
+#
+# Lerdge S with USB Flash Drive Support
+#
+[env:LERDGES_usb_flash_drive]
+platform          = ${env:LERDGES.platform}
+extends           = env:LERDGES
+platform_packages = ${stm_flash_drive.platform_packages}
+build_flags       = ${stm_flash_drive.build_flags}
+
+#
+# Lerdge K
+#
+[env:LERDGEK]
+platform             = ${lerdge_common.platform}
+extends              = lerdge_common
+board_build.firmware = Lerdge_K_firmware_force.bin
+build_flags          = ${lerdge_common.build_flags}
+  -DLERDGEK
+
+#
+# Lerdge K with USB Flash Drive Support
+#
+[env:LERDGEK_usb_flash_drive]
+platform          = ${env:LERDGEK.platform}
+extends           = env:LERDGEK
+platform_packages = ${stm_flash_drive.platform_packages}
+build_flags       = ${stm_flash_drive.build_flags}
+
+#
+# RUMBA32
+#
+[env:rumba32]
+platform        = ${common_stm32.platform}
+extends         = common_stm32
+build_flags     = ${common_stm32.build_flags}
+  -Os
+  -DHAL_PCD_MODULE_ENABLED
+  -DDISABLE_GENERIC_SERIALUSB
+  -DHAL_UART_MODULE_ENABLED
+  -DTIMER_SERIAL=TIM9
+board           = rumba32_f446ve
+upload_protocol = dfu
+monitor_speed   = 500000
+
+#
+# MKS Robin Pro V2
+#
+[env:mks_robin_pro2]
+platform             = ${common_stm32.platform}
+platform_packages    = ${stm_flash_drive.platform_packages}
+extends              = common_stm32
+build_flags          = ${stm_flash_drive.build_flags}
+board                = genericSTM32F407VET6
+board_build.core     = stm32
+board_build.variant  = MARLIN_F4x7Vx
+board_build.ldscript = ldscript.ld
+board_build.firmware = firmware.bin
+board_build.offset   = 0x0000
+board_upload.offset_address = 0x08000000
+build_unflags        = ${common_stm32.build_unflags} -DUSBCON -DUSBD_USE_CDC
+debug_tool           = jlink
+upload_protocol      = jlink
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+
+#
+# This SPI is used by Robin Nano V3
+#
+[stm32f4_I2C1]
+build_flags = -DPIN_WIRE_SCL=PB6 -DPIN_WIRE_SDA=PB7
+
+#
+# MKS Robin Nano V3
+#
+[env:mks_robin_nano_v3]
+platform             = ${common_stm32.platform}
+extends              = common_stm32
+build_flags          = ${common_stm32.build_flags} ${stm32f4_I2C1.build_flags} -DHAL_PCD_MODULE_ENABLED -DUSBCON -DUSBD_USE_CDC
+board                = genericSTM32F407VGT6
+board_build.core     = stm32
+board_build.variant  = MARLIN_F4x7Vx
+board_build.ldscript = ldscript.ld
+board_build.firmware = Robin_nano_v3.bin
+board_build.offset   = 0xC000
+board_upload.offset_address = 0x0800C000
+build_unflags        = ${common_stm32.build_unflags}
+debug_tool           = jlink
+upload_protocol      = jlink
+extra_scripts        = ${common.extra_scripts}
+  pre:buildroot/share/PlatformIO/scripts/generic_create_variant.py
+  buildroot/share/PlatformIO/scripts/stm32_bootloader.py
+
+#
+# MKS Robin Nano V3 with USB Flash Drive Support
+# Currently, using a STM32duino fork, until USB Host get merged
+#
+[env:mks_robin_nano_v3_usb_flash_drive]
+extends           = env:mks_robin_nano_v3
+platform_packages = ${stm_flash_drive.platform_packages}
+build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
+  -DUSBCON
+  -DUSE_USBHOST_HS
+  -DUSBD_IRQ_PRIO=5
+  -DUSBD_IRQ_SUBPRIO=6
+  -DUSE_USB_HS_IN_FS
+  -DUSBD_USE_CDC
+
+#
+# MKS Robin Nano V3 with USB Flash Drive Support and Shared Media
+# Currently, using a STM32duino fork, until USB Host and USB Device MSC get merged
+#
+[env:mks_robin_nano_v3_usb_flash_drive_msc]
+platform          = ${common_stm32.platform}
+extends           = env:mks_robin_nano_v3
+platform_packages = framework-arduinoststm32@https://github.com/rhapsodyv/Arduino_Core_STM32/archive/usb-host-msc-cdc-msc.zip
+build_unflags     = ${common_stm32.build_unflags} -DUSBD_USE_CDC
+build_flags       = ${stm_flash_drive.build_flags} ${stm32f4_I2C1.build_flags}
+  -DUSBCON
+  -DUSE_USBHOST_HS
+  -DUSBD_IRQ_PRIO=5
+  -DUSBD_IRQ_SUBPRIO=6
+  -DUSE_USB_HS_IN_FS
+  -DUSBD_USE_CDC_MSC
