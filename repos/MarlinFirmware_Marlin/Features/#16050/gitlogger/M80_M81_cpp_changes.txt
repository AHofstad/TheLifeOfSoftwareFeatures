commit daeffbc944e906554bafb99d39be871830137055
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sat Jun 8 17:13:20 2024 -0500

    üö∏ Prefer friendly Power Off over Auto-unalive

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 2d3e407446..3f0264994e 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -112,9 +112,9 @@ void GcodeSuite::M81() {
     return;
   }
 
-  #if HAS_SUICIDE
-    suicide();
-  #elif ENABLED(PSU_CONTROL)
+  #if ENABLED(PSU_CONTROL)
     powerManager.power_off_soon();
+  #elif HAS_SUICIDE
+    suicide();
   #endif
 }

commit 2ef71c6ebaa1f1b496eb369879fe22c69cf9adb4
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon Jun 12 16:38:14 2023 -0500

    ‚ôªÔ∏è Simplify SERIAL_ECHO (#25928)
    
    Since this increases AVR code size, try to optimize further.

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 94dd5e3dd9..2d3e407446 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -48,7 +48,7 @@
 
     // S: Report the current power supply state and exit
     if (parser.seen('S')) {
-      SERIAL_ECHOF(powerManager.psu_on ? F("PS:1\n") : F("PS:0\n"));
+      SERIAL_ECHO(powerManager.psu_on ? F("PS:1\n") : F("PS:0\n"));
       return;
     }
 

commit 2691167afe02fbbe74b0fdca2c28a49fac635741
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Jun 2 14:26:02 2023 -0500

    üßë‚Äçüíª Dump BOTH and EITHER macros (#25908)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 90b25e7ed3..94dd5e3dd9 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -79,7 +79,7 @@ void GcodeSuite::M81() {
 
   print_job_timer.stop();
 
-  #if BOTH(HAS_FAN, PROBING_FANS_OFF)
+  #if ALL(HAS_FAN, PROBING_FANS_OFF)
     thermalManager.fans_paused = false;
     ZERO(thermalManager.saved_fan_speed);
   #endif

commit ab46b7e2f298826a5512569d6e79bb59a7a6b8ea
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Jan 25 15:33:03 2022 -0600

    üßë‚Äçüíª HAS_MARLINUI_MENU, HAS_MANUAL_MOVE_MENU

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 6a3788c4a9..90b25e7ed3 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -63,7 +63,7 @@
       OUT_WRITE(SUICIDE_PIN, !SUICIDE_PIN_STATE);
     #endif
 
-    TERN_(HAS_LCD_MENU, ui.reset_status());
+    TERN_(HAS_MARLINUI_MENU, ui.reset_status());
   }
 
 #endif // PSU_CONTROL

commit 0aea3ae058b0aa453268768114664b0ff9272604
Author: John Lagonikas <39417467+zeleps@users.noreply.github.com>
Date:   Wed Jan 19 10:13:47 2022 +0200

    üêõ Fix conditional M81 suicide (#23549)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index cbb3c85f40..6a3788c4a9 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -107,7 +107,10 @@ void GcodeSuite::M81() {
     }
   #endif
 
-  if (delayed_power_off) return;
+  if (delayed_power_off) {
+    SERIAL_ECHOLNPGM(STR_DELAYED_POWEROFF);
+    return;
+  }
 
   #if HAS_SUICIDE
     suicide();

commit 1fe07bf3652c67c2266b2d70c4562c1b94244f02
Author: John Lagonikas <39417467+zeleps@users.noreply.github.com>
Date:   Wed Jan 5 13:57:32 2022 +0200

    ü©π Fix M80, 1s delay (#23455)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index dc9b09c4e1..cbb3c85f40 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -84,14 +84,19 @@ void GcodeSuite::M81() {
     ZERO(thermalManager.saved_fan_speed);
   #endif
 
+  safe_delay(1000); // Wait 1 second before switching off
+
   LCD_MESSAGE_F(MACHINE_NAME " " STR_OFF ".");
 
   bool delayed_power_off = false;
 
   #if ENABLED(POWER_OFF_TIMER)
     if (parser.seenval('D')) {
-      delayed_power_off = true;
-      powerManager.setPowerOffTimer(SEC_TO_MS(parser.value_ushort()));
+      uint16_t delay = parser.value_ushort();
+      if (delay > 1) { // skip already observed 1s delay
+        delayed_power_off = true;
+        powerManager.setPowerOffTimer(SEC_TO_MS(delay - 1));
+      }
     }
   #endif
 
@@ -104,8 +109,6 @@ void GcodeSuite::M81() {
 
   if (delayed_power_off) return;
 
-  safe_delay(1000); // Wait 1 second before switching off
-
   #if HAS_SUICIDE
     suicide();
   #elif ENABLED(PSU_CONTROL)

commit 9a194826e3e424e404e95443976f1bdfb1d2b245
Author: John Lagonikas <39417467+zeleps@users.noreply.github.com>
Date:   Mon Jan 3 18:11:39 2022 +0200

    ‚ú® M81 D / S - Power-off Delay (#23396)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index b8be9daa40..dc9b09c4e1 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -79,13 +79,31 @@ void GcodeSuite::M81() {
 
   print_job_timer.stop();
 
-  #if HAS_FAN
-    #if ENABLED(PROBING_FANS_OFF)
-      thermalManager.fans_paused = false;
-      ZERO(thermalManager.saved_fan_speed);
-    #endif
+  #if BOTH(HAS_FAN, PROBING_FANS_OFF)
+    thermalManager.fans_paused = false;
+    ZERO(thermalManager.saved_fan_speed);
+  #endif
+
+  LCD_MESSAGE_F(MACHINE_NAME " " STR_OFF ".");
+
+  bool delayed_power_off = false;
+
+  #if ENABLED(POWER_OFF_TIMER)
+    if (parser.seenval('D')) {
+      delayed_power_off = true;
+      powerManager.setPowerOffTimer(SEC_TO_MS(parser.value_ushort()));
+    }
   #endif
 
+  #if ENABLED(POWER_OFF_WAIT_FOR_COOLDOWN)
+    if (parser.boolval('S')) {
+      delayed_power_off = true;
+      powerManager.setPowerOffOnCooldown(true);
+    }
+  #endif
+
+  if (delayed_power_off) return;
+
   safe_delay(1000); // Wait 1 second before switching off
 
   #if HAS_SUICIDE
@@ -93,6 +111,4 @@ void GcodeSuite::M81() {
   #elif ENABLED(PSU_CONTROL)
     powerManager.power_off_soon();
   #endif
-
-  LCD_MESSAGE_F(MACHINE_NAME " " STR_OFF ".");
 }

commit 70e31bff45165dd07375cd6140fc0a72468e0894
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Oct 27 21:36:06 2021 -0500

    üé® Standard 'cooldown' method

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 2a1b3b34b9..b8be9daa40 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -74,13 +74,12 @@
  *      This code should ALWAYS be available for FULL SHUTDOWN!
  */
 void GcodeSuite::M81() {
-  thermalManager.disable_all_heaters();
   planner.finish_and_disable();
+  thermalManager.cooldown();
 
   print_job_timer.stop();
 
   #if HAS_FAN
-    thermalManager.zero_fan_speeds();
     #if ENABLED(PROBING_FANS_OFF)
       thermalManager.fans_paused = false;
       ZERO(thermalManager.saved_fan_speed);

commit 7f1286a11f87065c4e666985e679cf9c77d668bf
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Sep 25 17:05:11 2021 -0500

    üé® Apply F() to status message

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index c11acb4380..2a1b3b34b9 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -25,7 +25,7 @@
 #include "../../module/temperature.h"
 #include "../../module/planner.h"       // for planner.finish_and_disable
 #include "../../module/printcounter.h"  // for print_job_timer.stop
-#include "../../lcd/marlinui.h"         // for LCD_MESSAGEPGM_P
+#include "../../lcd/marlinui.h"         // for LCD_MESSAGE_F
 
 #include "../../inc/MarlinConfig.h"
 
@@ -95,5 +95,5 @@ void GcodeSuite::M81() {
     powerManager.power_off_soon();
   #endif
 
-  LCD_MESSAGEPGM_P(PSTR(MACHINE_NAME " " STR_OFF "."));
+  LCD_MESSAGE_F(MACHINE_NAME " " STR_OFF ".");
 }

commit 520b97083e52efdd47ab434b97823e48d85ade62
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon Sep 27 11:03:07 2021 -0500

    üé® Apply F() to serial macros

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 149613ee15..c11acb4380 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -48,7 +48,7 @@
 
     // S: Report the current power supply state and exit
     if (parser.seen('S')) {
-      SERIAL_ECHOPGM_P(powerManager.psu_on ? PSTR("PS:1\n") : PSTR("PS:0\n"));
+      SERIAL_ECHOF(powerManager.psu_on ? F("PS:1\n") : F("PS:0\n"));
       return;
     }
 

commit c161a46112debd280dc1ed6945d50f971ff505e6
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Aug 13 16:32:25 2021 -0500

    üé® Update MKSPWC, some other pins (#22557)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 9640c72006..149613ee15 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -60,7 +60,7 @@
      * a print without suicide...
      */
     #if HAS_SUICIDE
-      OUT_WRITE(SUICIDE_PIN, !SUICIDE_PIN_INVERTING);
+      OUT_WRITE(SUICIDE_PIN, !SUICIDE_PIN_STATE);
     #endif
 
     TERN_(HAS_LCD_MENU, ui.reset_status());

commit c8ee056cc63c5cb996b70c3336aae9be52f8cc85
Author: Katelyn Schiesser <katelyn.schiesser@gmail.com>
Date:   Sun Jul 11 22:13:58 2021 -0700

    ‚ôªÔ∏è Consolidate PSU_CONTROL (#22304)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 1b5ea2f7ef..9640c72006 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -29,25 +29,17 @@
 
 #include "../../inc/MarlinConfig.h"
 
+#if ENABLED(PSU_CONTROL)
+  #include "../queue.h"
+  #include "../../feature/power.h"
+#endif
+
 #if HAS_SUICIDE
   #include "../../MarlinCore.h"
 #endif
 
 #if ENABLED(PSU_CONTROL)
 
-  #if ENABLED(AUTO_POWER_CONTROL)
-    #include "../../feature/power.h"
-  #else
-    void restore_stepper_drivers();
-  #endif
-
-  // Could be moved to a feature, but this is all the data
-  bool powersupply_on;
-
-  #if HAS_TRINAMIC_CONFIG
-    #include "../../feature/tmc_util.h"
-  #endif
-
   /**
    * M80   : Turn on the Power Supply
    * M80 S : Report the current state and exit
@@ -56,11 +48,11 @@
 
     // S: Report the current power supply state and exit
     if (parser.seen('S')) {
-      SERIAL_ECHOPGM_P(powersupply_on ? PSTR("PS:1\n") : PSTR("PS:0\n"));
+      SERIAL_ECHOPGM_P(powerManager.psu_on ? PSTR("PS:1\n") : PSTR("PS:0\n"));
       return;
     }
 
-    PSU_ON();
+    powerManager.power_on();
 
     /**
      * If you have a switch on suicide pin, this is useful
@@ -71,12 +63,6 @@
       OUT_WRITE(SUICIDE_PIN, !SUICIDE_PIN_INVERTING);
     #endif
 
-    #if DISABLED(AUTO_POWER_CONTROL)
-      safe_delay(PSU_POWERUP_DELAY);
-      restore_stepper_drivers();
-      TERN_(HAS_TRINAMIC_CONFIG, safe_delay(PSU_POWERUP_DELAY));
-    #endif
-
     TERN_(HAS_LCD_MENU, ui.reset_status());
   }
 
@@ -106,7 +92,7 @@ void GcodeSuite::M81() {
   #if HAS_SUICIDE
     suicide();
   #elif ENABLED(PSU_CONTROL)
-    PSU_OFF_SOON();
+    powerManager.power_off_soon();
   #endif
 
   LCD_MESSAGEPGM_P(PSTR(MACHINE_NAME " " STR_OFF "."));

commit f399706911ac26bee8af5535f6714be100af73a0
Author: Cytown <cytown@gmail.com>
Date:   Sat Jun 26 03:50:09 2021 +0800

    üé® Power-off tone followup (#22222)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 00a0a31026..1b5ea2f7ef 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -101,10 +101,6 @@ void GcodeSuite::M81() {
     #endif
   #endif
 
-  #if ENABLED(PS_OFF_SOUND)
-    BUZZ(1000, 659);
-  #endif
-
   safe_delay(1000); // Wait 1 second before switching off
 
   #if HAS_SUICIDE

commit 0bd113b944d041192146692de50e33fe4d6c0fd8
Author: Cytown <cytown@gmail.com>
Date:   Thu Jun 24 00:40:32 2021 +0800

    ‚ú® Power-off confirm / beep options (#22191)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 1b5ea2f7ef..00a0a31026 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -101,6 +101,10 @@ void GcodeSuite::M81() {
     #endif
   #endif
 
+  #if ENABLED(PS_OFF_SOUND)
+    BUZZ(1000, 659);
+  #endif
+
   safe_delay(1000); // Wait 1 second before switching off
 
   #if HAS_SUICIDE

commit dd42831cba7334c5d106ba435bdb41b6135971bb
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Feb 28 19:43:46 2021 -0600

    Serial macros cleanup

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 394b06d8ac..1b5ea2f7ef 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -56,7 +56,7 @@
 
     // S: Report the current power supply state and exit
     if (parser.seen('S')) {
-      serialprintPGM(powersupply_on ? PSTR("PS:1\n") : PSTR("PS:0\n"));
+      SERIAL_ECHOPGM_P(powersupply_on ? PSTR("PS:1\n") : PSTR("PS:0\n"));
       return;
     }
 

commit b8186b50817d33999a414400d82d876da7b40ee9
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Mon Jan 25 08:32:58 2021 -0600

    Apply SEC_TO_MS and other fixes

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index ea0f9c2b13..394b06d8ac 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -89,9 +89,10 @@
  */
 void GcodeSuite::M81() {
   thermalManager.disable_all_heaters();
-  print_job_timer.stop();
   planner.finish_and_disable();
 
+  print_job_timer.stop();
+
   #if HAS_FAN
     thermalManager.zero_fan_speeds();
     #if ENABLED(PROBING_FANS_OFF)

commit 4ace02f4c2b6eda750412feaa661c856fe7a8674
Author: Hebezo <Kannix2005@users.noreply.github.com>
Date:   Mon Nov 9 01:37:41 2020 +0100

    Add POWER_OFF_DELAY option (#19987)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index a8f7f7c10b..ea0f9c2b13 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -105,7 +105,7 @@ void GcodeSuite::M81() {
   #if HAS_SUICIDE
     suicide();
   #elif ENABLED(PSU_CONTROL)
-    PSU_OFF();
+    PSU_OFF_SOON();
   #endif
 
   LCD_MESSAGEPGM_P(PSTR(MACHINE_NAME " " STR_OFF "."));

commit eaf6777a6643a6fab23ceaaa4699cb2466ea6b83
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Oct 16 19:36:25 2020 -0500

    Rename ultralcd => marlinui

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 6302bb5c67..a8f7f7c10b 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -25,7 +25,7 @@
 #include "../../module/temperature.h"
 #include "../../module/planner.h"       // for planner.finish_and_disable
 #include "../../module/printcounter.h"  // for print_job_timer.stop
-#include "../../lcd/ultralcd.h"         // for LCD_MESSAGEPGM_P
+#include "../../lcd/marlinui.h"         // for LCD_MESSAGEPGM_P
 
 #include "../../inc/MarlinConfig.h"
 

commit b11c3ddbedf9c84352b58f6620a9d0b801f66004
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Fri Aug 14 00:32:59 2020 -0500

    M80 followup

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 3498bfbc39..6302bb5c67 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -21,8 +21,10 @@
  */
 
 #include "../gcode.h"
+
 #include "../../module/temperature.h"
-#include "../../module/printcounter.h"  // for print_job_timer
+#include "../../module/planner.h"       // for planner.finish_and_disable
+#include "../../module/printcounter.h"  // for print_job_timer.stop
 #include "../../lcd/ultralcd.h"         // for LCD_MESSAGEPGM_P
 
 #include "../../inc/MarlinConfig.h"

commit aaba9b7880886d10f15d8aeb8eb6104193d1da9b
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Thu Aug 13 21:30:12 2020 -0500

    Clean up M80/M81, DWIN

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 0dede7ea64..3498bfbc39 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -22,15 +22,11 @@
 
 #include "../gcode.h"
 #include "../../module/temperature.h"
-#include "../../module/stepper.h"
-#include "../../module/printcounter.h" // for print_job_timer
+#include "../../module/printcounter.h"  // for print_job_timer
+#include "../../lcd/ultralcd.h"         // for LCD_MESSAGEPGM_P
 
 #include "../../inc/MarlinConfig.h"
 
-#if HAS_LCD_MENU
-  #include "../../lcd/ultralcd.h"
-#endif
-
 #if HAS_SUICIDE
   #include "../../MarlinCore.h"
 #endif
@@ -39,6 +35,8 @@
 
   #if ENABLED(AUTO_POWER_CONTROL)
     #include "../../feature/power.h"
+  #else
+    void restore_stepper_drivers();
   #endif
 
   // Could be moved to a feature, but this is all the data
@@ -108,7 +106,5 @@ void GcodeSuite::M81() {
     PSU_OFF();
   #endif
 
-  #if HAS_LCD_MENU
-    LCD_MESSAGEPGM_P(PSTR(MACHINE_NAME " " STR_OFF "."));
-  #endif
+  LCD_MESSAGEPGM_P(PSTR(MACHINE_NAME " " STR_OFF "."));
 }

commit 42fbd527f3bcc317ae6851aca5a45bdbf979de55
Author: Diego von Deschwanden <68632259+Diegovd@users.noreply.github.com>
Date:   Thu Jul 23 05:20:14 2020 +0200

    Fix links to secure sites (#18745)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 98efcce04d..0dede7ea64 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -16,7 +16,7 @@
  * GNU General Public License for more details.
  *
  * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  */
 

commit f4aba996244604afd27cfcf6d5f2654aab597f56
Author: Markus Towara <mtowara@gmail.com>
Date:   Fri Jul 17 19:33:45 2020 +0200

    Use safe_delay for PSU_POWERUP_DELAY (#18680)
    
    Co-authored-by: Scott Lahteine <thinkyhead@users.noreply.github.com>

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 6ba0949027..98efcce04d 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -72,9 +72,9 @@
     #endif
 
     #if DISABLED(AUTO_POWER_CONTROL)
-      delay(PSU_POWERUP_DELAY);
+      safe_delay(PSU_POWERUP_DELAY);
       restore_stepper_drivers();
-      TERN_(HAS_TRINAMIC_CONFIG, delay(PSU_POWERUP_DELAY));
+      TERN_(HAS_TRINAMIC_CONFIG, safe_delay(PSU_POWERUP_DELAY));
     #endif
 
     TERN_(HAS_LCD_MENU, ui.reset_status());

commit 8b3c7dda755ebce5bd57a7ce52891a137ea12b35
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Mon Apr 27 04:41:18 2020 -0500

    Add HAS_FAN and others

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index a5ff7d05d9..6ba0949027 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -92,7 +92,7 @@ void GcodeSuite::M81() {
   print_job_timer.stop();
   planner.finish_and_disable();
 
-  #if FAN_COUNT > 0
+  #if HAS_FAN
     thermalManager.zero_fan_speeds();
     #if ENABLED(PROBING_FANS_OFF)
       thermalManager.fans_paused = false;

commit 5d0deba938eaaa47c2fc27fdb296499698006f87
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Apr 19 23:37:05 2020 -0500

    Longer default power-up delay
    
    See MarlinFirmware/Configurations#78

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index e8d9aa2fdf..a5ff7d05d9 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -72,16 +72,15 @@
     #endif
 
     #if DISABLED(AUTO_POWER_CONTROL)
-      delay(PSU_POWERUP_DELAY); // Wait for power to settle
+      delay(PSU_POWERUP_DELAY);
       restore_stepper_drivers();
+      TERN_(HAS_TRINAMIC_CONFIG, delay(PSU_POWERUP_DELAY));
     #endif
 
-    #if HAS_LCD_MENU
-      ui.reset_status();
-    #endif
+    TERN_(HAS_LCD_MENU, ui.reset_status());
   }
 
-#endif // ENABLED(PSU_CONTROL)
+#endif // PSU_CONTROL
 
 /**
  * M81: Turn off Power, including Power Supply, if there is one.

commit b1a50d54e2a6f8e415a72e0e2d275304029d8ada
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Mon Mar 2 12:03:43 2020 -0600

    HAS_TRINAMIC => HAS_TRINAMIC_CONFIG

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index f9c40a20a9..e8d9aa2fdf 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -44,7 +44,7 @@
   // Could be moved to a feature, but this is all the data
   bool powersupply_on;
 
-  #if HAS_TRINAMIC
+  #if HAS_TRINAMIC_CONFIG
     #include "../../feature/tmc_util.h"
   #endif
 

commit e78f607ef33044eecde744e77beea87532817c47
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Feb 26 03:02:03 2020 -0600

    Use a STR_ prefix for non-translated strings

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 76808e9c9d..f9c40a20a9 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -110,6 +110,6 @@ void GcodeSuite::M81() {
   #endif
 
   #if HAS_LCD_MENU
-    LCD_MESSAGEPGM_P(PSTR(MACHINE_NAME " " MSG_OFF "."));
+    LCD_MESSAGEPGM_P(PSTR(MACHINE_NAME " " STR_OFF "."));
   #endif
 }

commit bfad23d3e2e590b257ebe4317d7b14cc2dd3435c
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Mon Feb 3 08:00:57 2020 -0600

    (c) 2020

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index d2b395e8d8..76808e9c9d 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -1,6 +1,6 @@
 /**
  * Marlin 3D Printer Firmware
- * Copyright (c) 2019 MarlinFirmware [https://github.com/MarlinFirmware/Marlin]
+ * Copyright (c) 2020 MarlinFirmware [https://github.com/MarlinFirmware/Marlin]
  *
  * Based on Sprinter and grbl.
  * Copyright (c) 2011 Camiel Gubbels / Erik van der Zalm

commit d0e1166cce60381fbdad1105d13765806a525d99
Author: Dirk O. Kaar <19971886+dok-net@users.noreply.github.com>
Date:   Fri Jan 3 02:01:38 2020 +0100

    Fix Visual Micro "Arduino IDE for Visual Studio" support (#16418)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 56533d45b8..d2b395e8d8 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -32,7 +32,7 @@
 #endif
 
 #if HAS_SUICIDE
-  #include "../../Marlin.h"
+  #include "../../MarlinCore.h"
 #endif
 
 #if ENABLED(PSU_CONTROL)

commit 690ed531b6e404bbc3fe85bdc4653484e5a4f3d0
Author: Felicia Hummel <felicia@drachenkatze.org>
Date:   Sat Nov 30 14:17:24 2019 +0100

    Configurable PSU power-on delay (#16050)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 28d335e816..56533d45b8 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -72,7 +72,7 @@
     #endif
 
     #if DISABLED(AUTO_POWER_CONTROL)
-      delay(100); // Wait for power to settle
+      delay(PSU_POWERUP_DELAY); // Wait for power to settle
       restore_stepper_drivers();
     #endif
 

commit 82fb0460132a6b42491fb578045e573ef68b6a56
Author: InsanityAutomation <38436470+InsanityAutomation@users.noreply.github.com>
Date:   Thu Oct 24 15:07:28 2019 -0400

    Allow suicide pin inverting (#15586)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 9b27b5e4e2..28d335e816 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -68,7 +68,7 @@
      * a print without suicide...
      */
     #if HAS_SUICIDE
-      OUT_WRITE(SUICIDE_PIN, HIGH);
+      OUT_WRITE(SUICIDE_PIN, !SUICIDE_PIN_INVERTING);
     #endif
 
     #if DISABLED(AUTO_POWER_CONTROL)

commit af214ff121dd977b002c9a9065f84b7ae1a66247
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Oct 22 15:43:37 2019 -0500

    Fix up PSU_CONTROL checks

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index d7880358c4..9b27b5e4e2 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -35,7 +35,7 @@
   #include "../../Marlin.h"
 #endif
 
-#if HAS_POWER_SWITCH
+#if ENABLED(PSU_CONTROL)
 
   #if ENABLED(AUTO_POWER_CONTROL)
     #include "../../feature/power.h"
@@ -81,7 +81,7 @@
     #endif
   }
 
-#endif // HAS_POWER_SWITCH
+#endif // ENABLED(PSU_CONTROL)
 
 /**
  * M81: Turn off Power, including Power Supply, if there is one.
@@ -105,7 +105,7 @@ void GcodeSuite::M81() {
 
   #if HAS_SUICIDE
     suicide();
-  #elif HAS_POWER_SWITCH
+  #elif ENABLED(PSU_CONTROL)
     PSU_OFF();
   #endif
 

commit 6a865a614620d71521bd3dc032adffe0bf82378c
Author: Marcio Teixeira <marcio@alephobjects.com>
Date:   Wed Oct 9 18:46:10 2019 -0600

    Multi-language support (#15453)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 03f73fe877..d7880358c4 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -110,6 +110,6 @@ void GcodeSuite::M81() {
   #endif
 
   #if HAS_LCD_MENU
-    LCD_MESSAGEPGM(MACHINE_NAME " " MSG_OFF ".");
+    LCD_MESSAGEPGM_P(PSTR(MACHINE_NAME " " MSG_OFF "."));
   #endif
 }

commit b7796bcce6a1d375b57d72db5fd4dd03d66fcceb
Author: InsanityAutomation <38436470+InsanityAutomation@users.noreply.github.com>
Date:   Wed Aug 28 01:51:01 2019 -0400

    Disable steppers on M112 (#15065)
    
    And change verbiage to not refer to "Emergency Stop."

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index efb7495017..03f73fe877 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -86,7 +86,7 @@
 /**
  * M81: Turn off Power, including Power Supply, if there is one.
  *
- *      This code should ALWAYS be available for EMERGENCY SHUTDOWN!
+ *      This code should ALWAYS be available for FULL SHUTDOWN!
  */
 void GcodeSuite::M81() {
   thermalManager.disable_all_heaters();

commit 93cd66ac1146603e8a9911fceb3c63f4351f4d8e
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu Jun 27 23:57:50 2019 -0500

    Tweaky change from (C) to (c)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index c2c705f65d..efb7495017 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -1,9 +1,9 @@
 /**
  * Marlin 3D Printer Firmware
- * Copyright (C) 2019 MarlinFirmware [https://github.com/MarlinFirmware/Marlin]
+ * Copyright (c) 2019 MarlinFirmware [https://github.com/MarlinFirmware/Marlin]
  *
  * Based on Sprinter and grbl.
- * Copyright (C) 2011 Camiel Gubbels / Erik van der Zalm
+ * Copyright (c) 2011 Camiel Gubbels / Erik van der Zalm
  *
  * This program is free software: you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by

commit a50436613834b183e5fccbf8f653af269d5d87dc
Author: Ludy <Ludy87@users.noreply.github.com>
Date:   Tue May 7 21:14:12 2019 +0200

    Fix probe fan compiling error (#13930)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index d2d90b6518..c2c705f65d 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -97,7 +97,7 @@ void GcodeSuite::M81() {
     thermalManager.zero_fan_speeds();
     #if ENABLED(PROBING_FANS_OFF)
       thermalManager.fans_paused = false;
-      ZERO(thermalManager.paused_fan_speed);
+      ZERO(thermalManager.saved_fan_speed);
     #endif
   #endif
 

commit 89bbc30a09b854c1fa20f63113a92c33df65e19a
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Wed Feb 20 05:28:40 2019 -0600

    Fix init of power supply pin
    
    Fix #13184

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 91a0e048af..d2d90b6518 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -42,13 +42,7 @@
   #endif
 
   // Could be moved to a feature, but this is all the data
-  bool powersupply_on = (
-    #if ENABLED(PS_DEFAULT_OFF)
-      false
-    #else
-      true
-    #endif
-  );
+  bool powersupply_on;
 
   #if HAS_TRINAMIC
     #include "../../feature/tmc_util.h"

commit 0feeef26048883640b37ebe3994730f31ef6e922
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Tue Feb 12 15:06:53 2019 -0600

    Update copyright in headers

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index b4a7b81d8d..91a0e048af 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -1,6 +1,6 @@
 /**
  * Marlin 3D Printer Firmware
- * Copyright (C) 2016 MarlinFirmware [https://github.com/MarlinFirmware/Marlin]
+ * Copyright (C) 2019 MarlinFirmware [https://github.com/MarlinFirmware/Marlin]
  *
  * Based on Sprinter and grbl.
  * Copyright (C) 2011 Camiel Gubbels / Erik van der Zalm

commit 082f6a27dece8d1883751d3f2af1c2b0f0b6802c
Author: InsanityAutomation <38436470+InsanityAutomation@users.noreply.github.com>
Date:   Sat Jan 12 01:41:48 2019 -0500

    ADAPTIVE_FAN_SLOWING extension to hotend thermal protection (#12853)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 3dbf15a794..b4a7b81d8d 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -100,10 +100,10 @@ void GcodeSuite::M81() {
   planner.finish_and_disable();
 
   #if FAN_COUNT > 0
-    zero_fan_speeds();
+    thermalManager.zero_fan_speeds();
     #if ENABLED(PROBING_FANS_OFF)
-      fans_paused = false;
-      ZERO(paused_fan_speed);
+      thermalManager.fans_paused = false;
+      ZERO(thermalManager.paused_fan_speed);
     #endif
   #endif
 

commit a0c795b097a30eff006c8dff178abf5f1f1907fa
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Nov 11 12:16:24 2018 -0600

    Encapsulate common display code in a singleton (#12395)
    
    * Encapsulate common LCD code in a singleton
    * Depend more UBL code on UBL_DEVEL_DEBUGGING
      - Since most users don't need the debugging on at all times, this helps reduce the default build size for UBL by over 2K, a little closer to fitting on 128K boards.

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 573a44bfa3..3dbf15a794 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -83,7 +83,7 @@
     #endif
 
     #if HAS_LCD_MENU
-      lcd_reset_status();
+      ui.reset_status();
     #endif
   }
 

commit 3583e2b4490e8fd6778d18003641c2fdd333e8a5
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue Oct 30 16:34:45 2018 -0500

    Followup to Menu Refactor (#12275)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 155fb59c21..573a44bfa3 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -27,7 +27,7 @@
 
 #include "../../inc/MarlinConfig.h"
 
-#if ENABLED(ULTIPANEL)
+#if HAS_LCD_MENU
   #include "../../lcd/ultralcd.h"
 #endif
 
@@ -82,7 +82,7 @@
       restore_stepper_drivers();
     #endif
 
-    #if ENABLED(ULTIPANEL)
+    #if HAS_LCD_MENU
       lcd_reset_status();
     #endif
   }
@@ -115,7 +115,7 @@ void GcodeSuite::M81() {
     PSU_OFF();
   #endif
 
-  #if ENABLED(ULTIPANEL)
+  #if HAS_LCD_MENU
     LCD_MESSAGEPGM(MACHINE_NAME " " MSG_OFF ".");
   #endif
 }

commit 71e19baf691a5252841cca5871a29d7a65b62e5f
Author: Marcio Teixeira <marcio@alephobjects.com>
Date:   Thu Oct 18 20:20:56 2018 -0600

    Fix kill => disable_all_heaters => print_job_timer.stop (#12146)
    
    - Remove `print_job_timer.stop()` from `disable_all_heaters`
    - Call `print_job_timer.stop()` for relevant `disable_all_heaters()`.
    - Split up `kill()` for watchdog interrupt safety

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index eeda53bfdd..155fb59c21 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -23,6 +23,7 @@
 #include "../gcode.h"
 #include "../../module/temperature.h"
 #include "../../module/stepper.h"
+#include "../../module/printcounter.h" // for print_job_timer
 
 #include "../../inc/MarlinConfig.h"
 
@@ -95,10 +96,11 @@
  */
 void GcodeSuite::M81() {
   thermalManager.disable_all_heaters();
+  print_job_timer.stop();
   planner.finish_and_disable();
 
   #if FAN_COUNT > 0
-    for (uint8_t i = 0; i < FAN_COUNT; i++) fan_speed[i] = 0;
+    zero_fan_speeds();
     #if ENABLED(PROBING_FANS_OFF)
       fans_paused = false;
       ZERO(paused_fan_speed);

commit d6b0fbd7715da67a2aaeeeafb0d4dc7c1563ef98
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sun Oct 7 15:34:41 2018 -0500

    Use uint8_t for all fan speeds (#12032)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 4047049f54..eeda53bfdd 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -98,10 +98,10 @@ void GcodeSuite::M81() {
   planner.finish_and_disable();
 
   #if FAN_COUNT > 0
-    for (uint8_t i = 0; i < FAN_COUNT; i++) fanSpeeds[i] = 0;
+    for (uint8_t i = 0; i < FAN_COUNT; i++) fan_speed[i] = 0;
     #if ENABLED(PROBING_FANS_OFF)
       fans_paused = false;
-      ZERO(paused_fanSpeeds);
+      ZERO(paused_fan_speed);
     #endif
   #endif
 

commit a11eb50a3eab6d58d595a67e526fb51190018db3
Author: etagle <ejtagle@hotmail.com>
Date:   Wed May 9 02:17:53 2018 -0300

    Refactor and optimize Stepper/Planner
    
    Better encapsulation and considerably reduce stepper jitter

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 97991cca5b..4047049f54 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -95,7 +95,7 @@
  */
 void GcodeSuite::M81() {
   thermalManager.disable_all_heaters();
-  stepper.finish_and_disable();
+  planner.finish_and_disable();
 
   #if FAN_COUNT > 0
     for (uint8_t i = 0; i < FAN_COUNT; i++) fanSpeeds[i] = 0;

commit 35258dd50ba09fe6c3d1c8d476c61201bc743254
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun May 13 17:18:19 2018 -0500

    Consistent heating status and status reset
    
    Fix #10699

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index eae35d1c4e..97991cca5b 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -82,7 +82,7 @@
     #endif
 
     #if ENABLED(ULTIPANEL)
-      LCD_MESSAGEPGM(WELCOME_MSG);
+      lcd_reset_status();
     #endif
   }
 

commit bfe223e1209af4e50917e752124c7215a4c38953
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Thu May 3 20:51:10 2018 -0500

    Adjust usage of stepper.synchronize

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index eb300b01db..eae35d1c4e 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -108,7 +108,6 @@ void GcodeSuite::M81() {
   safe_delay(1000); // Wait 1 second before switching off
 
   #if HAS_SUICIDE
-    stepper.synchronize();
     suicide();
   #elif HAS_POWER_SWITCH
     PSU_OFF();

commit a90cbc633993dc236fdb5d2aa174b52c321533c4
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Sat Apr 21 15:43:21 2018 -0500

    [2.0.x] Wait for bed heaters between probing (#10472)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 59ae933221..eb300b01db 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -41,13 +41,13 @@
   #endif
 
   // Could be moved to a feature, but this is all the data
-  bool powersupply_on =
+  bool powersupply_on = (
     #if ENABLED(PS_DEFAULT_OFF)
       false
     #else
       true
     #endif
-  ;
+  );
 
   #if HAS_TRINAMIC
     #include "../../feature/tmc_util.h"

commit 48d7036874e55131847360e5693d9807ee0e5184
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sun Mar 18 19:01:42 2018 -0500

    Consolidate smart stepper driver initialization

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index eee197dbbd..59ae933221 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -76,14 +76,9 @@
       OUT_WRITE(SUICIDE_PIN, HIGH);
     #endif
 
-    #if ENABLED(HAVE_TMC2130)
-      delay(100);
-      tmc2130_init(); // Settings only stick when the driver has power
-    #endif
-
-    #if ENABLED(HAVE_TMC2208)
-      delay(100);
-      tmc2208_init();
+    #if DISABLED(AUTO_POWER_CONTROL)
+      delay(100); // Wait for power to settle
+      restore_stepper_drivers();
     #endif
 
     #if ENABLED(ULTIPANEL)

commit 3c2bfa5e533b9f1d659baec30770f6e274cb539e
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Thu Mar 8 18:56:47 2018 -0600

    Update powersupply_on in power_on/off (#10015)
    
    Fix #10004

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 10846fc097..eee197dbbd 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -86,8 +86,6 @@
       tmc2208_init();
     #endif
 
-    powersupply_on = true;
-
     #if ENABLED(ULTIPANEL)
       LCD_MESSAGEPGM(WELCOME_MSG);
     #endif
@@ -119,7 +117,6 @@ void GcodeSuite::M81() {
     suicide();
   #elif HAS_POWER_SWITCH
     PSU_OFF();
-    powersupply_on = false;
   #endif
 
   #if ENABLED(ULTIPANEL)

commit b5e92f4f908461ca2c78a86eefe069b85af0a2dc
Author: Scott Lahteine <thinkyhead@users.noreply.github.com>
Date:   Tue Feb 6 00:22:30 2018 -0600

    [2.0.x] Enable / disable PSU automatically (#9503)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index f8ad85da1d..10846fc097 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -36,6 +36,10 @@
 
 #if HAS_POWER_SWITCH
 
+  #if ENABLED(AUTO_POWER_CONTROL)
+    #include "../../feature/power.h"
+  #endif
+
   // Could be moved to a feature, but this is all the data
   bool powersupply_on =
     #if ENABLED(PS_DEFAULT_OFF)
@@ -61,7 +65,7 @@
       return;
     }
 
-    OUT_WRITE(PS_ON_PIN, PS_ON_AWAKE); // GND
+    PSU_ON();
 
     /**
      * If you have a switch on suicide pin, this is useful
@@ -114,7 +118,7 @@ void GcodeSuite::M81() {
     stepper.synchronize();
     suicide();
   #elif HAS_POWER_SWITCH
-    OUT_WRITE(PS_ON_PIN, PS_ON_ASLEEP);
+    PSU_OFF();
     powersupply_on = false;
   #endif
 

commit 0cd1e91056213d6a0bd422848ccff7cd1191d001
Author: teemuatlut <teemu.mantykallio@live.fi>
Date:   Fri Dec 15 23:03:14 2017 +0200

    [2.0.x] TMC driver update (#8769)

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index 682676448f..f8ad85da1d 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -45,8 +45,8 @@
     #endif
   ;
 
-  #if ENABLED(HAVE_TMC2130)
-    #include "../../feature/tmc2130.h"
+  #if HAS_TRINAMIC
+    #include "../../feature/tmc_util.h"
   #endif
 
   /**
@@ -77,6 +77,11 @@
       tmc2130_init(); // Settings only stick when the driver has power
     #endif
 
+    #if ENABLED(HAVE_TMC2208)
+      delay(100);
+      tmc2208_init();
+    #endif
+
     powersupply_on = true;
 
     #if ENABLED(ULTIPANEL)

commit 10c1b442caa1653a925b357ebaf92d1e1c0c4066
Author: Phr3d13 <phr3d13@gmail.com>
Date:   Wed Sep 27 05:40:48 2017 -0400

    Fixes for Anet10 and gt2560
    
    Fixes for 2 "... not declared in this scope" compiler errors.

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
index a5164a1a7a..682676448f 100644
--- a/Marlin/src/gcode/control/M80_M81.cpp
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -30,6 +30,10 @@
   #include "../../lcd/ultralcd.h"
 #endif
 
+#if HAS_SUICIDE
+  #include "../../Marlin.h"
+#endif
+
 #if HAS_POWER_SWITCH
 
   // Could be moved to a feature, but this is all the data

commit 4b9d1b9f260589e5e758bcc90968535cab7bdfa4
Author: Scott Lahteine <github@thinkyhead.com>
Date:   Sat Sep 16 23:25:01 2017 -0500

    Move M80-M81 to cpp

diff --git a/Marlin/src/gcode/control/M80_M81.cpp b/Marlin/src/gcode/control/M80_M81.cpp
new file mode 100644
index 0000000000..a5164a1a7a
--- /dev/null
+++ b/Marlin/src/gcode/control/M80_M81.cpp
@@ -0,0 +1,115 @@
+/**
+ * Marlin 3D Printer Firmware
+ * Copyright (C) 2016 MarlinFirmware [https://github.com/MarlinFirmware/Marlin]
+ *
+ * Based on Sprinter and grbl.
+ * Copyright (C) 2011 Camiel Gubbels / Erik van der Zalm
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation, either version 3 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ *
+ */
+
+#include "../gcode.h"
+#include "../../module/temperature.h"
+#include "../../module/stepper.h"
+
+#include "../../inc/MarlinConfig.h"
+
+#if ENABLED(ULTIPANEL)
+  #include "../../lcd/ultralcd.h"
+#endif
+
+#if HAS_POWER_SWITCH
+
+  // Could be moved to a feature, but this is all the data
+  bool powersupply_on =
+    #if ENABLED(PS_DEFAULT_OFF)
+      false
+    #else
+      true
+    #endif
+  ;
+
+  #if ENABLED(HAVE_TMC2130)
+    #include "../../feature/tmc2130.h"
+  #endif
+
+  /**
+   * M80   : Turn on the Power Supply
+   * M80 S : Report the current state and exit
+   */
+  void GcodeSuite::M80() {
+
+    // S: Report the current power supply state and exit
+    if (parser.seen('S')) {
+      serialprintPGM(powersupply_on ? PSTR("PS:1\n") : PSTR("PS:0\n"));
+      return;
+    }
+
+    OUT_WRITE(PS_ON_PIN, PS_ON_AWAKE); // GND
+
+    /**
+     * If you have a switch on suicide pin, this is useful
+     * if you want to start another print with suicide feature after
+     * a print without suicide...
+     */
+    #if HAS_SUICIDE
+      OUT_WRITE(SUICIDE_PIN, HIGH);
+    #endif
+
+    #if ENABLED(HAVE_TMC2130)
+      delay(100);
+      tmc2130_init(); // Settings only stick when the driver has power
+    #endif
+
+    powersupply_on = true;
+
+    #if ENABLED(ULTIPANEL)
+      LCD_MESSAGEPGM(WELCOME_MSG);
+    #endif
+  }
+
+#endif // HAS_POWER_SWITCH
+
+/**
+ * M81: Turn off Power, including Power Supply, if there is one.
+ *
+ *      This code should ALWAYS be available for EMERGENCY SHUTDOWN!
+ */
+void GcodeSuite::M81() {
+  thermalManager.disable_all_heaters();
+  stepper.finish_and_disable();
+
+  #if FAN_COUNT > 0
+    for (uint8_t i = 0; i < FAN_COUNT; i++) fanSpeeds[i] = 0;
+    #if ENABLED(PROBING_FANS_OFF)
+      fans_paused = false;
+      ZERO(paused_fanSpeeds);
+    #endif
+  #endif
+
+  safe_delay(1000); // Wait 1 second before switching off
+
+  #if HAS_SUICIDE
+    stepper.synchronize();
+    suicide();
+  #elif HAS_POWER_SWITCH
+    OUT_WRITE(PS_ON_PIN, PS_ON_ASLEEP);
+    powersupply_on = false;
+  #endif
+
+  #if ENABLED(ULTIPANEL)
+    LCD_MESSAGEPGM(MACHINE_NAME " " MSG_OFF ".");
+  #endif
+}
